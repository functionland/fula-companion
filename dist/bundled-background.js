/*! For license information please see bundled-background.js.LICENSE.txt */
(()=>{var e={310:e=>{"use strict";function t(e,t){for(const n in t)Object.defineProperty(e,n,{value:t[n],enumerable:!0,configurable:!0});return e}e.exports=function(e,n,r){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");r||(r={}),"object"==typeof n&&(r=n,n=""),n&&(r.code=n);try{return t(e,r)}catch(n){r.message=e.message,r.stack=e.stack;const s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(e)),t(new s,r)}}},544:(e,t,n)=>{"use strict";const r=n(939);t.PP=r.EventIterator,r.EventIterator},939:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const e=this.pullQueue.shift();e&&e.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),void 0!==this.highWaterMark&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch((()=>{})),this.pushQueue.push(t)}}remove(){Promise.resolve().then((()=>{this.removeCallback&&this.removeCallback()}))}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(void 0!==this.lowWaterMark&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise(((e,t)=>{this.pullQueue.push({resolve:e,reject:t})}))},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class r{constructor(e,{highWaterMark:t=100,lowWaterMark:r=1}={}){const s=new n;s.highWaterMark=t,s.lowWaterMark=r,s.removeCallback=e({push:e=>s.push(e),stop:()=>s.stop(),fail:e=>s.fail(e),on:(e,t)=>{s.eventHandlers[e]=t}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}}t.EventIterator=r,t.default=r},228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,r,i,o){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new s(r,i||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,i=r.length,o=new Array(i);s<i;s++)o[s]=r[s].fn;return o},a.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,s,i,o){var a=n?n+e:e;if(!this._events[a])return!1;var c,l,u=this._events[a],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,i),!0;case 6:return u.fn.call(u.context,t,r,s,i,o),!0}for(l=1,c=new Array(h-1);l<h;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var d,f=u.length;for(l=0;l<f;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),h){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,r);break;case 4:u[l].fn.call(u[l].context,t,r,s);break;default:if(!c)for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];u[l].fn.apply(u[l].context,c)}}return!0},a.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,r,s){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return o(this,i),this;var a=this._events[i];if(a.fn)a.fn!==t||s&&!a.once||r&&a.context!==r||o(this,i);else{for(var c=0,l=[],u=a.length;c<u;c++)(a[c].fn!==t||s&&!a[c].once||r&&a[c].context!==r)&&l.push(a[c]);l.length?this._events[i]=1===l.length?l[0]:l:o(this,i)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a},194:e=>{e.exports=function(e){if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,n=Object.create(null),r=Object.create(null);function s(s,i){n[s]=i,++t>=e&&(t=0,r=n,n=Object.create(null))}return{has:function(e){return void 0!==n[e]||void 0!==r[e]},remove:function(e){void 0!==n[e]&&(n[e]=void 0),void 0!==r[e]&&(r[e]=void 0)},get:function(e){var t=n[e];return void 0!==t?t:void 0!==(t=r[e])?(s(e,t),t):void 0},set:function(e,t){void 0!==n[e]?n[e]=t:s(e,t)},clear:function(){n=Object.create(null),r=Object.create(null)}}}},866:e=>{e.exports=function(){return"undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type||!("undefined"==typeof process||"object"!=typeof process.versions||!process.versions.electron)||"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0}},368:e=>{"use strict";e.exports=e=>{if("[object Object]"!==Object.prototype.toString.call(e))return!1;const t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}},864:function(e,t,n){"use strict";const r=n(368),{hasOwnProperty:s}=Object.prototype,{propertyIsEnumerable:i}=Object,o=(e,t,n)=>Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0}),a=this,c={concatArrays:!1,ignoreUndefined:!1},l=e=>{const t=[];for(const n in e)s.call(e,n)&&t.push(n);if(Object.getOwnPropertySymbols){const n=Object.getOwnPropertySymbols(e);for(const r of n)i.call(e,r)&&t.push(r)}return t};function u(e){return Array.isArray(e)?function(e){const t=e.slice(0,0);return l(e).forEach((n=>{o(t,n,u(e[n]))})),t}(e):r(e)?function(e){const t=null===Object.getPrototypeOf(e)?Object.create(null):{};return l(e).forEach((n=>{o(t,n,u(e[n]))})),t}(e):e}const h=(e,t,n,r)=>(n.forEach((n=>{void 0===t[n]&&r.ignoreUndefined||(n in e&&e[n]!==Object.getPrototypeOf(e)?o(e,n,f(e[n],t[n],r)):o(e,n,u(t[n])))})),e),d=(e,t,n)=>{let r=e.slice(0,0),i=0;return[e,t].forEach((t=>{const a=[];for(let n=0;n<t.length;n++)s.call(t,n)&&(a.push(String(n)),o(r,i++,t===e?t[n]:u(t[n])));r=h(r,t,l(t).filter((e=>!a.includes(e))),n)})),r};function f(e,t,n){return n.concatArrays&&Array.isArray(e)&&Array.isArray(t)?d(e,t,n):r(t)&&r(e)?h(e,t,l(t),n):u(t)}e.exports=function(...e){const t=f(u(c),this!==a&&this||{},c);let n={_:{}};for(const s of e)if(void 0!==s){if(!r(s))throw new TypeError("`"+s+"` is not an Option Object");n=f(n,{_:s},t)}return n._}},437:(e,t,n)=>{e.exports=n(327)},327:function(e,t){!function(n,r){"use strict";var s={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(e){if(!Array.isArray(e)&&!ArrayBuffer.isView(e))return!1;for(var t=0;t<e.length;t++)if(!Number.isInteger(e[t])||e[t]<0||e[t]>255)return!1;return!0}function o(e,t){return(65535&e)*t+(((e>>>16)*t&65535)<<16)}function a(e,t){return e<<t|e>>>32-t}function c(e){return e=o(e^=e>>>16,2246822507),(e=o(e^=e>>>13,3266489909))^e>>>16}function l(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var n=[0,0,0,0];return n[3]+=e[3]+t[3],n[2]+=n[3]>>>16,n[3]&=65535,n[2]+=e[2]+t[2],n[1]+=n[2]>>>16,n[2]&=65535,n[1]+=e[1]+t[1],n[0]+=n[1]>>>16,n[1]&=65535,n[0]+=e[0]+t[0],n[0]&=65535,[n[0]<<16|n[1],n[2]<<16|n[3]]}function u(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var n=[0,0,0,0];return n[3]+=e[3]*t[3],n[2]+=n[3]>>>16,n[3]&=65535,n[2]+=e[2]*t[3],n[1]+=n[2]>>>16,n[2]&=65535,n[2]+=e[3]*t[2],n[1]+=n[2]>>>16,n[2]&=65535,n[1]+=e[1]*t[3],n[0]+=n[1]>>>16,n[1]&=65535,n[1]+=e[2]*t[2],n[0]+=n[1]>>>16,n[1]&=65535,n[1]+=e[3]*t[1],n[0]+=n[1]>>>16,n[1]&=65535,n[0]+=e[0]*t[3]+e[1]*t[2]+e[2]*t[1]+e[3]*t[0],n[0]&=65535,[n[0]<<16|n[1],n[2]<<16|n[3]]}function h(e,t){return 32==(t%=64)?[e[1],e[0]]:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t|e[0]>>>32-t]:(t-=32,[e[1]<<t|e[0]>>>32-t,e[0]<<t|e[1]>>>32-t])}function d(e,t){return 0==(t%=64)?e:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t]:[e[1]<<t-32,0]}function f(e,t){return[e[0]^t[0],e[1]^t[1]]}function p(e){return e=f(e,[0,e[0]>>>1]),e=f(e=u(e,[4283543511,3981806797]),[0,e[0]>>>1]),f(e=u(e,[3301882366,444984403]),[0,e[0]>>>1])}s.x86.hash32=function(e,t){if(s.inputValidation&&!i(e))return r;t=t||0;for(var n=e.length%4,l=e.length-n,u=t,h=0,d=3432918353,f=461845907,p=0;p<l;p+=4)h=o(h=e[p]|e[p+1]<<8|e[p+2]<<16|e[p+3]<<24,d),h=o(h=a(h,15),f),u=o(u=a(u^=h,13),5)+3864292196;switch(h=0,n){case 3:h^=e[p+2]<<16;case 2:h^=e[p+1]<<8;case 1:h=o(h^=e[p],d),u^=h=o(h=a(h,15),f)}return(u=c(u^=e.length))>>>0},s.x86.hash128=function(e,t){if(s.inputValidation&&!i(e))return r;t=t||0;for(var n=e.length%16,l=e.length-n,u=t,h=t,d=t,f=t,p=0,g=0,y=0,m=0,w=597399067,b=2869860233,E=951274213,v=2716044179,S=0;S<l;S+=16)p=e[S]|e[S+1]<<8|e[S+2]<<16|e[S+3]<<24,g=e[S+4]|e[S+5]<<8|e[S+6]<<16|e[S+7]<<24,y=e[S+8]|e[S+9]<<8|e[S+10]<<16|e[S+11]<<24,m=e[S+12]|e[S+13]<<8|e[S+14]<<16|e[S+15]<<24,p=a(p=o(p,w),15),u=a(u^=p=o(p,b),19),u=o(u+=h,5)+1444728091,g=a(g=o(g,b),16),h=a(h^=g=o(g,E),17),h=o(h+=d,5)+197830471,y=a(y=o(y,E),17),d=a(d^=y=o(y,v),15),d=o(d+=f,5)+2530024501,m=a(m=o(m,v),18),f=a(f^=m=o(m,w),13),f=o(f+=u,5)+850148119;switch(p=0,g=0,y=0,m=0,n){case 15:m^=e[S+14]<<16;case 14:m^=e[S+13]<<8;case 13:m=o(m^=e[S+12],v),f^=m=o(m=a(m,18),w);case 12:y^=e[S+11]<<24;case 11:y^=e[S+10]<<16;case 10:y^=e[S+9]<<8;case 9:y=o(y^=e[S+8],E),d^=y=o(y=a(y,17),v);case 8:g^=e[S+7]<<24;case 7:g^=e[S+6]<<16;case 6:g^=e[S+5]<<8;case 5:g=o(g^=e[S+4],b),h^=g=o(g=a(g,16),E);case 4:p^=e[S+3]<<24;case 3:p^=e[S+2]<<16;case 2:p^=e[S+1]<<8;case 1:p=o(p^=e[S],w),u^=p=o(p=a(p,15),b)}return u^=e.length,u+=h^=e.length,u+=d^=e.length,h+=u+=f^=e.length,d+=u,f+=u,u=c(u),u+=h=c(h),u+=d=c(d),h+=u+=f=c(f),d+=u,f+=u,("00000000"+(u>>>0).toString(16)).slice(-8)+("00000000"+(h>>>0).toString(16)).slice(-8)+("00000000"+(d>>>0).toString(16)).slice(-8)+("00000000"+(f>>>0).toString(16)).slice(-8)},s.x64.hash128=function(e,t){if(s.inputValidation&&!i(e))return r;t=t||0;for(var n=e.length%16,o=e.length-n,a=[0,t],c=[0,t],g=[0,0],y=[0,0],m=[2277735313,289559509],w=[1291169091,658871167],b=0;b<o;b+=16)g=[e[b+4]|e[b+5]<<8|e[b+6]<<16|e[b+7]<<24,e[b]|e[b+1]<<8|e[b+2]<<16|e[b+3]<<24],y=[e[b+12]|e[b+13]<<8|e[b+14]<<16|e[b+15]<<24,e[b+8]|e[b+9]<<8|e[b+10]<<16|e[b+11]<<24],g=h(g=u(g,m),31),a=l(a=h(a=f(a,g=u(g,w)),27),c),a=l(u(a,[0,5]),[0,1390208809]),y=h(y=u(y,w),33),c=l(c=h(c=f(c,y=u(y,m)),31),a),c=l(u(c,[0,5]),[0,944331445]);switch(g=[0,0],y=[0,0],n){case 15:y=f(y,d([0,e[b+14]],48));case 14:y=f(y,d([0,e[b+13]],40));case 13:y=f(y,d([0,e[b+12]],32));case 12:y=f(y,d([0,e[b+11]],24));case 11:y=f(y,d([0,e[b+10]],16));case 10:y=f(y,d([0,e[b+9]],8));case 9:y=u(y=f(y,[0,e[b+8]]),w),c=f(c,y=u(y=h(y,33),m));case 8:g=f(g,d([0,e[b+7]],56));case 7:g=f(g,d([0,e[b+6]],48));case 6:g=f(g,d([0,e[b+5]],40));case 5:g=f(g,d([0,e[b+4]],32));case 4:g=f(g,d([0,e[b+3]],24));case 3:g=f(g,d([0,e[b+2]],16));case 2:g=f(g,d([0,e[b+1]],8));case 1:g=u(g=f(g,[0,e[b]]),m),a=f(a,g=u(g=h(g,31),w))}return a=l(a=f(a,[0,e.length]),c=f(c,[0,e.length])),c=l(c,a),a=l(a=p(a),c=p(c)),c=l(c,a),("00000000"+(a[0]>>>0).toString(16)).slice(-8)+("00000000"+(a[1]>>>0).toString(16)).slice(-8)+("00000000"+(c[0]>>>0).toString(16)).slice(-8)+("00000000"+(c[1]>>>0).toString(16)).slice(-8)},e.exports&&(t=e.exports=s),t.murmurHash3=s}()},507:function(e,t){(function(){var e,n,r,s,i,o,a,c;c=function(e){return[(e&255<<24)>>>24,(e&255<<16)>>>16,(65280&e)>>>8,255&e].join(".")},a=function(e){var t,r,s,i,o,a;for(t=[],s=i=0;i<=3&&0!==e.length;s=++i){if(s>0){if("."!==e[0])throw new Error("Invalid IP");e=e.substring(1)}o=(a=n(e))[0],r=a[1],e=e.substring(r),t.push(o)}if(0!==e.length)throw new Error("Invalid IP");switch(t.length){case 1:if(t[0]>4294967295)throw new Error("Invalid IP");return t[0]>>>0;case 2:if(t[0]>255||t[1]>16777215)throw new Error("Invalid IP");return(t[0]<<24|t[1])>>>0;case 3:if(t[0]>255||t[1]>255||t[2]>65535)throw new Error("Invalid IP");return(t[0]<<24|t[1]<<16|t[2])>>>0;case 4:if(t[0]>255||t[1]>255||t[2]>255||t[3]>255)throw new Error("Invalid IP");return(t[0]<<24|t[1]<<16|t[2]<<8|t[3])>>>0;default:throw new Error("Invalid IP")}},s=(r=function(e){return e.charCodeAt(0)})("0"),o=r("a"),i=r("A"),n=function(e){var t,n,a,c,l;for(c=0,t=10,n="9",a=0,e.length>1&&"0"===e[a]&&("x"===e[a+1]||"X"===e[a+1]?(a+=2,t=16):"0"<=e[a+1]&&e[a+1]<="9"&&(a++,t=8,n="7")),l=a;a<e.length;){if("0"<=e[a]&&e[a]<=n)c=c*t+(r(e[a])-s)>>>0;else{if(16!==t)break;if("a"<=e[a]&&e[a]<="f")c=c*t+(10+r(e[a])-o)>>>0;else{if(!("A"<=e[a]&&e[a]<="F"))break;c=c*t+(10+r(e[a])-i)>>>0}}if(c>4294967295)throw new Error("too large");a++}if(a===l)throw new Error("empty octet");return[c,a]},e=function(){function e(e,t){var n,r,s;if("string"!=typeof e)throw new Error("Missing `net' parameter");if(t||(s=e.split("/",2),e=s[0],t=s[1]),t||(t=32),"string"==typeof t&&t.indexOf(".")>-1){try{this.maskLong=a(t)}catch(e){throw new Error("Invalid mask: "+t)}for(n=r=32;r>=0;n=--r)if(this.maskLong===4294967295<<32-n>>>0){this.bitmask=n;break}}else{if(!t&&0!==t)throw new Error("Invalid mask: empty");this.bitmask=parseInt(t,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0)}try{this.netLong=(a(e)&this.maskLong)>>>0}catch(t){throw new Error("Invalid net address: "+e)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+t);this.size=Math.pow(2,32-this.bitmask),this.base=c(this.netLong),this.mask=c(this.maskLong),this.hostmask=c(~this.maskLong),this.first=this.bitmask<=30?c(this.netLong+1):this.base,this.last=this.bitmask<=30?c(this.netLong+this.size-2):c(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?c(this.netLong+this.size-1):void 0}return e.prototype.contains=function(t){return"string"==typeof t&&(t.indexOf("/")>0||4!==t.split(".").length)&&(t=new e(t)),t instanceof e?this.contains(t.base)&&this.contains(t.broadcast||t.last):(a(t)&this.maskLong)>>>0==(this.netLong&this.maskLong)>>>0},e.prototype.next=function(t){return null==t&&(t=1),new e(c(this.netLong+this.size*t),this.mask)},e.prototype.forEach=function(e){var t,n,r;for(r=a(this.first),n=a(this.last),t=0;r<=n;)e(c(r),r,t),t++,r++},e.prototype.toString=function(){return this.base+"/"+this.bitmask},e}(),t.ip2long=a,t.long2ip=c,t.Netmask=e}).call(this)},152:(e,t)=>{"use strict";class n{static isArrayBuffer(e){return"[object ArrayBuffer]"===Object.prototype.toString.call(e)}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const r=n.toUint8Array(e),s=n.toUint8Array(t);if(r.length!==s.byteLength)return!1;for(let e=0;e<r.length;e++)if(r[e]!==s[e])return!1;return!0}static concat(...e){let t;t=!Array.isArray(e[0])||e[1]instanceof Function?Array.isArray(e[0])&&e[1]instanceof Function?e[0]:e[e.length-1]instanceof Function?e.slice(0,e.length-1):e:e[0];let n=0;for(const e of t)n+=e.byteLength;const r=new Uint8Array(n);let s=0;for(const e of t){const t=this.toUint8Array(e);r.set(t,s),s+=t.length}return e[e.length-1]instanceof Function?this.toView(r,e[e.length-1]):r.buffer}}const r="string",s=/^[0-9a-f]+$/i,i=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,o=/^[a-zA-Z0-9-_]+$/;class a{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}static toString(e){const t=n.toUint8Array(e);let r="";for(let e=0;e<t.length;e++)r+=String.fromCharCode(t[e]);return decodeURIComponent(escape(r))}}class c{static toString(e,t=!1){const r=n.toArrayBuffer(e),s=new DataView(r);let i="";for(let e=0;e<r.byteLength;e+=2){const n=s.getUint16(e,t);i+=String.fromCharCode(n)}return i}static fromString(e,t=!1){const n=new ArrayBuffer(2*e.length),r=new DataView(n);for(let n=0;n<e.length;n++)r.setUint16(2*n,e.charCodeAt(n),t);return n}}class l{static isHex(e){return typeof e===r&&s.test(e)}static isBase64(e){return typeof e===r&&i.test(e)}static isBase64Url(e){return typeof e===r&&o.test(e)}static ToString(e,t="utf8"){const r=n.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return c.toString(r,!0);case"utf16":case"utf16be":return c.toString(r);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return c.fromString(e,!0);case"utf16":case"utf16be":return c.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=n.toUint8Array(e);if("undefined"!=typeof btoa){const e=this.ToString(t,"binary");return btoa(e)}return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!l.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return"undefined"!=typeof atob?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!l.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=l.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return a.fromString(e);case"utf16":case"utf16be":return c.fromString(e);case"utf16le":case"usc2":return c.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=l.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return a.toString(e);case"utf16":case"utf16be":return c.toString(e);case"utf16le":case"usc2":return c.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let r=0;r<t;r++)n[r]=e.charCodeAt(r);return n.buffer}static ToBinary(e){const t=n.toUint8Array(e);let r="";for(let e=0;e<t.length;e++)r+=String.fromCharCode(t[e]);return r}static ToHex(e){const t=n.toUint8Array(e);let r="";const s=t.length;for(let e=0;e<s;e++){const n=t[e];n<16&&(r+="0"),r+=n.toString(16)}return r}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!l.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2){const r=t.slice(e,e+2);n[e/2]=parseInt(r,16)}return n.buffer}static ToUtf16String(e,t=!1){return c.toString(e,t)}static FromUtf16String(e,t=!1){return c.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return(null==e?void 0:e.replace(/[\n\r\t ]/g,""))||""}}l.DEFAULT_UTF8_ENCODING="utf8",t._H=n,t.U$=l},424:(e,t,n)=>{"use strict";var r=n(743),s=/[\/\?<>\\:\*\|"]/g,i=/[\x00-\x1f\x80-\x9f]/g,o=/^\.+$/,a=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,c=/[\. ]+$/;function l(e,t){if("string"!=typeof e)throw new Error("Input must be string");var n=e.replace(s,t).replace(i,t).replace(o,t).replace(a,t).replace(c,t);return r(n,255)}e.exports=function(e,t){var n=t&&t.replacement||"",r=l(e,n);return""===n?r:l(r,"")}},669:e=>{"use strict";function t(e,t){return e+n(t)}function n(e){let t=e;return t-=t>>1&1431655765,t=(858993459&t)+(t>>2&858993459),16843009*(t+(t>>4)&252645135)>>24}function r(e,t){return e[0]-t[0]}function s(e){return e[1]}e.exports=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(void 0===t)-1!==n&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let r=!1;-1===n?(n=this._data.length,this._setBit(e),this._changedData=!0):r=!0,this._setInternalPos(n,e,t,r),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(-1!==t)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,r=t;for(;n<this.length;)r=e(r,this.get(n),n),n++;return r}find(e){let t,n,r=0;for(;r<this.length&&!t;)n=this.get(r),t=e(n),r++;return t?n:void 0}_internalPositionFor(e,r){const s=this._bytePosFor(e,r);if(s>=this._bitArrays.length)return-1;const i=this._bitArrays[s],o=e-7*s;return(i&1<<o)>0?this._bitArrays.slice(0,s).reduce(t,0)+n(i&~(4294967295<<o+1))-1:-1}_bytePosFor(e,t){const n=Math.floor(e/7),r=n+1;for(;!t&&this._bitArrays.length<r;)this._bitArrays.push(0);return n}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-7*t}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-7*t)}_setInternalPos(e,t,n,r){const s=this._data,i=[t,n];if(r)this._sortData(),s[e]=i;else{if(s.length)if(s[s.length-1][0]>=t)s.push(i);else if(s[0][0]<=t)s.unshift(i);else{const e=Math.round(s.length/2);this._data=s.slice(0,e).concat(i).concat(s.slice(e))}else this._data.push(i);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(r),this._changedData=!1}bitField(){const e=[];let t,n=8,r=0,s=0;const i=this._bitArrays.slice();for(;i.length||r;){0===r&&(t=i.shift(),r=7);const o=Math.min(r,n);s|=(t&~(255<<o))<<8-n,t>>>=o,r-=o,n-=o,n&&(r||i.length)||(e.push(s),s=0,n=8)}for(var o=e.length-1;o>0&&0===e[o];o--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(s)}}},743:(e,t,n)=>{"use strict";var r=n(45),s=n(446);e.exports=r.bind(null,s)},45:e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e,r,s){if("string"!=typeof r)throw new Error("Input must be string");for(var i,o,a=r.length,c=0,l=0;l<a;l+=1){if(i=r.charCodeAt(l),o=r[l],t(i)&&n(r.charCodeAt(l+1))&&(o+=r[l+=1]),(c+=e(o))===s)return r.slice(0,l+1);if(c>s)return r.slice(0,l-o.length+1)}return r}},446:e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e){if("string"!=typeof e)throw new Error("Input must be string");for(var r=e.length,s=0,i=null,o=null,a=0;a<r;a++)n(i=e.charCodeAt(a))?null!=o&&t(o)?s+=1:s+=3:i<=127?s+=1:i>=128&&i<=2047?s+=2:i>=2048&&i<=65535&&(s+=3),o=i;return s}},454:e=>{!function(){e.exports=y;var t=86400,n=3200,r=146097*n/400,s=t*r,i=1e3*s,o=864e13,a=4294967296,c=1e6,l="000000000",u=Math.trunc||function(e){var t=e-e%1;return 0==t&&(e<0||0===e&&1/e!=1/0)?-0:t},h=y.prototype,d=(y.fromDate=function(e){return new y(+e)},y.fromInt64BE=v(0,1,2,3,0,4),y.fromInt64LE=v(3,2,1,0,4,0),y.fromString=function(e){var t,n=new y;if(e=(e+="").replace(/^\s*[+\-]?\d+/,(function(e){var t=1970+((e=+e)-1970)%400;return n.year=e-t,t})).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,(function(e,n,r){return n<0&&(r*=-1),t=6e4*(60*+n+ +r),""})).replace(/\.\d+$/,(function(e){return n.nano=+(e+l).substr(1,9),""})).split(/\D+/),1<e.length?e[1]--:e[1]=0,n.time=t=Date.UTC.apply(Date,e)-(t||0),isNaN(t))throw new TypeError("Invalid Date");return m(n)},y.fromTimeT=function(e){return b(e,0)},h.year=0,h.time=0,h.nano=0,h.addNano=function(e){return this.nano+=+e||0,this},h.getNano=function(){var e=m(this);return(e.time%1e3*c+ +e.nano+1e9)%1e9},h.getTimeT=function(){var e=m(this),s=Math.floor(e.time/1e3);return(e=e.year)&&(s+=e*r*t/n),s},h.getYear=function(){return this.toDate().getUTCFullYear()+this.year},h.toDate=function(){return w(m(this).time)},h.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},h.toString=function(e){var t=this,n=t.toDate(),r={H:function(){return _(n.getUTCHours())},L:function(){return R(n.getUTCMilliseconds(),3)},M:function(){return _(n.getUTCMinutes())},N:function(){return R(t.getNano(),9)},S:function(){return _(n.getUTCSeconds())},Y:function(){var e=t.getYear();return 999999<e?"+"+e:9999<e?"+"+R(e,6):0<=e?R(e,4):-999999<=e?"-"+R(-e,6):e},a:function(){return p[n.getUTCDay()]},b:function(){return f[n.getUTCMonth()]},d:function(){return _(n.getUTCDate())},e:function(){return function(e){return(9<e?"":" ")+(0|e)}(n.getUTCDate())},m:function(){return _(n.getUTCMonth()+1)}};return function e(t){return t.replace(/%./g,(function(t){var n=t[1],s=g[n];return n=r[n],s?e(s):n?n():t}))}(e||d)},h.writeInt64BE=E(0,1,2,3,0,4),h.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:"\n",R:"%H:%M",T:"%H:%M:%S",t:"\t",X:"%T",Z:"GMT",z:"+0000"};return y;function y(e,t,n){var r=this;if(!(r instanceof y))return new y(e,t,n);r.time=+e||0,r.nano=+t||0,r.year=+n||0,m(r)}function m(e){var t,r,s,a=e.year,l=e.time,h=e.nano,d=((h<0||c<=h)&&(h-=(r=Math.floor(h/c))*c,l+=r,r=1),a%n);return(l<-o||o<l||d)&&((t=u(l/i))&&(a+=t*n,l-=t*i),(s=w(l)).setUTCFullYear(d+s.getUTCFullYear()),s=(l=+s)+(t=u((a-=d)/n))*i,t&&-o<=s&&s<=o&&(a-=t*n,l=s),r=1),r&&(e.year=a,e.time=l,e.nano=h),e}function w(e){var t=new Date(0);return t.setTime(e),t}function b(e,t){e=+e||0;var r=u((t=(0|t)*a)/s)+u(e/s);return(e=u((t=t%s+e%s)/s))&&(r+=e,t-=e*s),new y(1e3*t,0,r*n)}function E(e,s,i,o,c,l){return function(e,s){var i=m(this);S(e=e||new Array(8),s|=0);var o=Math.floor(i.time/1e3),d=(i=i.year*(r*t/n),u(i/a)+u(o/a));return i=i%a+o%a,(o=Math.floor(i/a))&&(d+=o,i-=o*a),h(e,s+c,d),h(e,s+l,i),e};function h(t,n,r){t[n+e]=r>>24&255,t[n+s]=r>>16&255,t[n+i]=r>>8&255,t[n+o]=255&r}}function v(e,t,n,r,s,i){return function(e,t){S(e,t|=0);var n=o(e,t+s);return b(o(e,t+i),n)};function o(s,i){return 16777216*s[i+e]+(s[i+t]<<16|s[i+n]<<8|s[i+r])}}function S(e,t){if(null==(e=e&&e.length))throw new TypeError("Invalid Buffer");if(e<t+8)throw new RangeError("Out of range")}function _(e){return(9<e?"":"0")+(0|e)}function R(e,t){return(l+(0|e)).substr(-t)}}()}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e={};n.r(e),n.d(e,{base10:()=>lt});var t={};n.r(t),n.d(t,{base16:()=>ut,base16upper:()=>ht});var r={};n.r(r),n.d(r,{base2:()=>dt});var s={};n.r(s),n.d(s,{base256emoji:()=>yt});var i={};n.r(i),n.d(i,{base32:()=>mt,base32hex:()=>vt,base32hexpad:()=>_t,base32hexpadupper:()=>Rt,base32hexupper:()=>St,base32pad:()=>bt,base32padupper:()=>Et,base32upper:()=>wt,base32z:()=>kt});var o={};n.r(o),n.d(o,{base36:()=>At,base36upper:()=>It});var a={};n.r(a),n.d(a,{base58btc:()=>Tt,base58flickr:()=>xt});var c={};n.r(c),n.d(c,{base64:()=>Dt,base64pad:()=>Ct,base64url:()=>Nt,base64urlpad:()=>Pt});var l={};n.r(l),n.d(l,{base8:()=>Lt});var u={};n.r(u),n.d(u,{identity:()=>Bt});var h={};n.r(h),n.d(h,{code:()=>Ft,decode:()=>Vt,encode:()=>$t,name:()=>Ut});var d={};n.r(d),n.d(d,{code:()=>Ht,decode:()=>qt,encode:()=>Kt,name:()=>zt});var f={};n.r(f),n.d(f,{identity:()=>gn});var p={};n.r(p),n.d(p,{sha256:()=>bn,sha512:()=>En});var g={};n.r(g),n.d(g,{abortedError:()=>Uo,closeFailedError:()=>No,deleteFailedError:()=>Bo,getFailedError:()=>Lo,hasFailedError:()=>Oo,notFoundError:()=>Mo,openFailedError:()=>Co,putFailedError:()=>Po});var y={};n.r(y),n.d(y,{code:()=>iu,createLink:()=>ru,createNode:()=>nu,decode:()=>au,encode:()=>ou,name:()=>su,prepare:()=>eu,validate:()=>tu});var m={};n.r(m),n.d(m,{aK:()=>Rh,e8:()=>ch,DO:()=>ah,dJ:()=>kh,OG:()=>Ah,My:()=>uh,Ph:()=>yh,lX:()=>mh,Id:()=>vh,fg:()=>xh,qj:()=>Eh,aT:()=>gh,r4:()=>_h,aY:()=>oh,x:()=>Nh,lq:()=>wh,z:()=>bh,zW:()=>hh,Q5:()=>Ch});var w={};n.r(w),n.d(w,{Ed25519PrivateKey:()=>Od,Ed25519PublicKey:()=>Bd,generateKeyPair:()=>Fd,generateKeyPairFromSeed:()=>$d,unmarshalEd25519PrivateKey:()=>Md,unmarshalEd25519PublicKey:()=>Ud});var b={};n.r(b),n.d(b,{MAX_RSA_KEY_SIZE:()=>ig,RsaPrivateKey:()=>ag,RsaPublicKey:()=>og,fromJwk:()=>ug,generateKeyPair:()=>hg,unmarshalRsaPrivateKey:()=>cg,unmarshalRsaPublicKey:()=>lg});var E={};function v(e){const t=new globalThis.AbortController;function n(){t.abort();for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",n)}for(const t of e){if(!0===t?.aborted){n();break}null!=t?.addEventListener&&t.addEventListener("abort",n)}const r=t.signal;return r.clear=function(){for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",n)},r}n.r(E),n.d(E,{Secp256k1PrivateKey:()=>Dg,Secp256k1PublicKey:()=>xg,generateKeyPair:()=>Pg,unmarshalSecp256k1PrivateKey:()=>Cg,unmarshalSecp256k1PublicKey:()=>Ng});class S extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return null==t?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let r=this.#e.get(e);null==r&&(r=[],this.#e.set(e,r)),r.push({callback:t,once:(!0!==n&&!1!==n&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let r=this.#e.get(e);null!=r&&(r=r.filter((({callback:e})=>e!==t)),this.#e.set(e,r))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return null==n||(n=n.filter((({once:e})=>!e)),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new _(e,t))}}const _=globalThis.CustomEvent;class R extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.name="AbortError",this.code=R.code,this.type=R.type}static code="ABORT_ERR";static type="aborted"}class k extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}}class A extends AggregateError{code;props;constructor(e,t,n,r){super(e,t),this.code=n,this.name=r?.name??"AggregateCodeError",this.props=r??{}}}Error,Error,Error;const I="ERR_TIMEOUT",T="ERR_INVALID_MESSAGE";function x(){const e={};return e.promise=new Promise(((t,n)=>{e.resolve=t,e.reject=n})),e}class D{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class C{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new D(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new D(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}class N extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}}function P(e={}){return function(e,t){let n,r,s,i=(t=t??{}).onEnd,o=new C,a=x();const c=e=>null!=r?r(e):(o.push(e),n),l=e=>{if(s)return n;if(!0!==t?.objectMode&&null==e?.byteLength)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return c({done:!1,value:e})},u=e=>s?n:(s=!0,null!=e?(e=>(o=new C,null!=r?r({error:e}):(o.push({error:e}),n)))(e):c({done:!0}));if(n={[Symbol.asyncIterator](){return this},next:async()=>{try{return o.isEmpty()?s?{done:!0}:await new Promise(((t,s)=>{r=i=>{r=null,o.push(i);try{t(e(o))}catch(e){s(e)}return n}})):e(o)}finally{o.isEmpty()&&queueMicrotask((()=>{a.resolve(),a=x()}))}},return:()=>(o=new C,u(),{done:!0}),throw:e=>(u(e),{done:!0}),push:l,end:u,get readableLength(){return o.size},onEmpty:async e=>{const t=e?.signal;if(t?.throwIfAborted(),o.isEmpty())return;let n,r;null!=t&&(n=new Promise(((e,n)=>{r=()=>{n(new N)},t.addEventListener("abort",r)})));try{await Promise.race([a.promise,n])}finally{null!=r&&null!=t&&t?.removeEventListener("abort",r)}}},null==i)return n;const h=n;return n={[Symbol.asyncIterator](){return this},next:()=>h.next(),throw:e=>(h.throw(e),null!=i&&(i(e),i=void 0),{done:!0}),return:()=>(h.return(),null!=i&&(i(),i=void 0),{done:!0}),push:l,end:e=>(h.end(e),null!=i&&(i(e),i=void 0),n),get readableLength(){return h.readableLength},onEmpty:e=>h.onEmpty(e)},n}((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),e)}class L extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}}async function B(e,t,n,r){const s=new L(r?.errorMessage,r?.errorCode);return!0===n?.aborted?Promise.reject(s):new Promise(((i,o)=>{function a(){n?.removeEventListener("abort",u),e.removeEventListener(t,c),null!=r?.errorEvent&&e.removeEventListener(r.errorEvent,l)}const c=e=>{try{if(!1===r?.filter?.(e))return}catch(e){return a(),void o(e)}a(),i(e)},l=e=>{a(),o(e.detail)},u=()=>{a(),o(s)};n?.addEventListener("abort",u),e.addEventListener(t,c),null!=r?.errorEvent&&e.addEventListener(r.errorEvent,l)}))}class O extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}}async function M(e,t,n){if(null==t)return e;if(t.aborted)return Promise.reject(new O(n?.errorMessage,n?.errorCode,n?.errorName));let r;const s=new O(n?.errorMessage,n?.errorCode,n?.errorName);try{return await Promise.race([e,new Promise(((e,n)=>{r=()=>{n(s)},t.addEventListener("abort",r)}))])}finally{null!=r&&t.removeEventListener("abort",r)}}class U{deferred;signal;constructor(e){this.signal=e,this.deferred=x(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new R)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}class F{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce(((e,t)=>e&&!0===t.signal?.aborted),!0)&&(this.controller.abort(new R),this.cleanup())}async join(e={}){const t=new U(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await M(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach((t=>{t.deferred.resolve(e)})),this.status="complete"}catch(e){this.recipients.forEach((t=>{t.deferred.reject(e)})),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach((e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)}))}}class $ extends S{concurrency;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.pending=0,null!=e.metricName&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(0===this.size)return queueMicrotask((()=>{this.safeDispatchEvent("empty")})),0===this.running&&queueMicrotask((()=>{this.safeDispatchEvent("idle")})),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally((()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")})),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}async add(e,t){t?.signal?.throwIfAborted();const n=new F(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then((e=>(this.safeDispatchEvent("completed",{detail:e}),this.safeDispatchEvent("success",{detail:{job:n,result:e}}),e))).catch((e=>{if("queued"===n.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===n){this.queue.splice(e,1);break}throw this.safeDispatchEvent("error",{detail:e}),this.safeDispatchEvent("failure",{detail:{job:n,error:e}}),e}))}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach((e=>{e.abort(new R)})),this.clear()}async onEmpty(e){0!==this.size&&await B(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await B(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await B(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=P({objectMode:!0}),n=e=>{null!=e?this.abort():this.clear(),t.end(e)},r=e=>{null!=e.detail&&t.push(e.detail)},s=e=>{n(e.detail)},i=()=>{n()},o=()=>{n(new k("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",r),this.addEventListener("error",s),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("completed",r),this.removeEventListener("error",s),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",o),n()}}}class V extends ${has(e){return null!=this.find(e)}find(e){return this.queue.find((t=>e.equals(t.options.peerId)))}}const z=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e);})();for(const t of e);};function H(e=0){return new Uint8Array(e)}function K(e=0){return new Uint8Array(e)}const q=Math.pow(2,7),W=Math.pow(2,14),j=Math.pow(2,21),G=Math.pow(2,28),Y=Math.pow(2,35),Q=Math.pow(2,42),J=Math.pow(2,49),X=128,Z=127;function ee(e){if(e<q)return 1;if(e<W)return 2;if(e<j)return 3;if(e<G)return 4;if(e<Y)return 5;if(e<Q)return 6;if(e<J)return 7;if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function te(e,t,n=0){switch(ee(e)){case 8:t[n++]=255&e|X,e/=128;case 7:t[n++]=255&e|X,e/=128;case 6:t[n++]=255&e|X,e/=128;case 5:t[n++]=255&e|X,e/=128;case 4:t[n++]=255&e|X,e>>>=7;case 3:t[n++]=255&e|X,e>>>=7;case 2:t[n++]=255&e|X,e>>>=7;case 1:t[n++]=255&e,e>>>=7;break;default:throw new Error("unreachable")}return t}function ne(e,t){let n=e[t],r=0;if(r+=n&Z,n<X)return r;if(n=e[t+1],r+=(n&Z)<<7,n<X)return r;if(n=e[t+2],r+=(n&Z)<<14,n<X)return r;if(n=e[t+3],r+=(n&Z)<<21,n<X)return r;if(n=e[t+4],r+=(n&Z)*G,n<X)return r;if(n=e[t+5],r+=(n&Z)*Y,n<X)return r;if(n=e[t+6],r+=(n&Z)*Q,n<X)return r;if(n=e[t+7],r+=(n&Z)*J,n<X)return r;throw new RangeError("Could not decode varint")}function re(e,t,n=0){return null==t&&(t=K(ee(e))),t instanceof Uint8Array?te(e,t,n):function(e,t,n=0){switch(ee(e)){case 8:t.set(n++,255&e|X),e/=128;case 7:t.set(n++,255&e|X),e/=128;case 6:t.set(n++,255&e|X),e/=128;case 5:t.set(n++,255&e|X),e/=128;case 4:t.set(n++,255&e|X),e>>>=7;case 3:t.set(n++,255&e|X),e>>>=7;case 2:t.set(n++,255&e|X),e>>>=7;case 1:t.set(n++,255&e),e>>>=7;break;default:throw new Error("unreachable")}return t}(e,t,n)}function se(e,t=0){return e instanceof Uint8Array?ne(e,t):function(e,t){let n=e.get(t),r=0;if(r+=n&Z,n<X)return r;if(n=e.get(t+1),r+=(n&Z)<<7,n<X)return r;if(n=e.get(t+2),r+=(n&Z)<<14,n<X)return r;if(n=e.get(t+3),r+=(n&Z)<<21,n<X)return r;if(n=e.get(t+4),r+=(n&Z)*G,n<X)return r;if(n=e.get(t+5),r+=(n&Z)*Y,n<X)return r;if(n=e.get(t+6),r+=(n&Z)*Q,n<X)return r;if(n=e.get(t+7),r+=(n&Z)*J,n<X)return r;throw new RangeError("Could not decode varint")}(e,t)}function ie(e,t){null==t&&(t=e.reduce(((e,t)=>e+t.length),0));const n=K(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}function oe(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}const ae=Symbol.for("@achingbrain/uint8arraylist");function ce(e,t){if(null==t||t<0)throw new RangeError("index is out of bounds");let n=0;for(const r of e){const e=n+r.byteLength;if(t<e)return{buf:r,index:t-n};n=e}throw new RangeError("index is out of bounds")}function le(e){return Boolean(e?.[ae])}class ue{bufs;length;[ae]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else{if(!le(n))throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");t+=n.byteLength,this.bufs.push(...n.bufs)}this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else{if(!le(n))throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");t+=n.byteLength,this.bufs.unshift(...n.bufs)}this.length+=t}get(e){const t=ce(this.bufs,e);return t.buf[t.index]}set(e,t){const n=ce(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else{if(!le(e))throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList");for(let n=0;n<e.length;n++)this.set(t+n,e.get(n))}}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength)return this.bufs=[],void(this.length=0);for(;this.bufs.length>0;){if(!(e>=this.bufs[0].byteLength)){this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift()}}}slice(e,t){const{bufs:n,length:r}=this._subList(e,t);return ie(n,r)}subarray(e,t){const{bufs:n,length:r}=this._subList(e,t);return 1===n.length?n[0]:ie(n,r)}sublist(e,t){const{bufs:n,length:r}=this._subList(e,t),s=new ue;return s.length=r,s.bufs=[...n],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(0===e&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let r=0;for(let s=0;s<this.bufs.length;s++){const i=this.bufs[s],o=r,a=o+i.byteLength;if(r=a,e>=a)continue;const c=e>=o&&e<a,l=t>o&&t<=a;if(c&&l){if(e===o&&t===a){n.push(i);break}const r=e-o;n.push(i.subarray(r,r+(t-e)));break}if(c){if(0===e){n.push(i);continue}n.push(i.subarray(e-o))}else{if(l){if(t===a){n.push(i);break}n.push(i.subarray(0,t-o));break}n.push(i)}}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!(le(e)||e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const r=n.byteLength;if(0===r)throw new TypeError("search must be at least 1 byte long");const s=new Int32Array(256);for(let e=0;e<256;e++)s[e]=-1;for(let e=0;e<r;e++)s[n[e]]=e;const i=s,o=this.byteLength-n.byteLength,a=n.byteLength-1;let c;for(let e=t;e<=o;e+=c){c=0;for(let t=a;t>=0;t--){const r=this.get(e+t);if(n[t]!==r){c=Math.max(1,t-i[r]);break}}if(0===c)return e}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=K(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const r=H(2);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt16(0,t,n),this.write(r,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const r=H(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt32(0,t,n),this.write(r,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const r=H(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setBigInt64(0,t,n),this.write(r,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=K(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const r=H(2);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint16(0,t,n),this.write(r,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const r=H(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint32(0,t,n),this.write(r,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const r=H(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setBigUint64(0,t,n),this.write(r,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const r=H(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setFloat32(0,t,n),this.write(r,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const r=H(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setFloat64(0,t,n),this.write(r,e)}equals(e){if(null==e)return!1;if(!(e instanceof ue))return!1;if(e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!oe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new ue;return n.bufs=e,null==t&&(t=e.reduce(((e,t)=>e+t.byteLength),0)),n.length=t,n}}function he(e){return null!=e[Symbol.asyncIterator]}const de=e=>{const t=ee(e),n=K(t);return re(e,n),de.bytes=t,n};function fe(e,t){const n=(t=t??{}).lengthEncoder??de;function*r(e){const t=n(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return he(e)?async function*(){for await(const t of e)yield*r(t)}():function*(){for(const t of e)yield*r(t)}()}de.bytes=0,fe.single=(e,t)=>{const n=(t=t??{}).lengthEncoder??de;return new ue(n(e.byteLength),e)};class pe extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class ge extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class ye extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}class me extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}var we;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(we||(we={}));const be=e=>{const t=se(e);return be.bytes=ee(t),t};function Ee(e,t){const n=new ue;let r=we.LENGTH,s=-1;const i=t?.lengthDecoder??be,o=t?.maxLengthLength??8,a=t?.maxDataLength??4194304;function*c(){for(;n.byteLength>0;){if(r===we.LENGTH)try{if(s=i(n),s<0)throw new pe("Invalid message length");if(s>a)throw new ge("Message length too long");const e=i.bytes;n.consume(e),null!=t?.onLength&&t.onLength(s),r=we.DATA}catch(e){if(e instanceof RangeError){if(n.byteLength>o)throw new ye("Message length length too long");break}throw e}if(r===we.DATA){if(n.byteLength<s)break;const e=n.sublist(0,s);n.consume(s),null!=t?.onData&&t.onData(e),yield e,r=we.LENGTH}}}return he(e)?async function*(){for await(const t of e)n.append(t),yield*c();if(n.byteLength>0)throw new me("Unexpected end of input")}():function*(){for(const t of e)n.append(t),yield*c();if(n.byteLength>0)throw new me("Unexpected end of input")}()}be.bytes=0,Ee.fromReader=(e,t)=>{let n=1;return Ee(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{n=1}}(),{...t??{},onLength:e=>{n=e}})};const ve=function(e){const[t,n]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>t.next(),push:e=>{r.push(e)},next:()=>r.length>0?{done:!1,value:r.shift()}:t.next(),[n](){return this}}},Se=function(e,t){let n=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e)yield t(r,n++)}();const r=ve(e),{value:s,done:i}=r.next();if(!0===i)return function*(){}();const o=t(s,n++);if("function"==typeof o.then)return async function*(){yield await o;for await(const e of r)yield t(e,n++)}();const a=t;return function*(){yield o;for(const e of r)yield a(e,n++)}()},_e=function(...e){const t=[];for(const n of e)null==n[Symbol.asyncIterator]&&t.push(n);return t.length===e.length?function*(){for(const e of t)yield*e}():async function*(){const t=P({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(e.map((async e=>{for await(const n of e)t.push(n)}))),t.end()}catch(e){t.end(e)}})),yield*t}()};function Re(e,...t){if(null==e)throw new Error("Empty pipeline");if(Te(e)){const t=e;e=()=>t.source}else if(Ie(e)||Ae(e)){const t=e;e=()=>t}const n=[e,...t];if(n.length>1&&Te(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let e=1;e<n.length-1;e++)Te(n[e])&&(n[e]=xe(n[e]));return ke(...n)}const ke=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},Ae=e=>null!=e?.[Symbol.asyncIterator],Ie=e=>null!=e?.[Symbol.iterator],Te=e=>null!=e&&null!=e.sink&&null!=e.source,xe=e=>t=>{const n=e.sink(t);if(null!=n?.then){const t=P({objectMode:!0});let r;n.then((()=>{t.end()}),(e=>{t.end(e)}));const s=e.source;if(Ae(s))r=async function*(){yield*s,t.end()};else{if(!Ie(s))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*s,t.end()}}return _e(t,r())}return e.source},De=function(e,t){return null!=e[Symbol.asyncIterator]?async function*(){let n=0;if(!(t<1))for await(const r of e)if(yield r,n++,n===t)return}():function*(){let n=0;if(!(t<1))for(const r of e)if(yield r,n++,n===t)return}()};class Ce extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}const Ne="/ipfs/bitswap/1.2.0",Pe=4194304,Le=Pe,Be=new Float32Array([-0]),Oe=new Uint8Array(Be.buffer);function Me(e,t,n){Be[0]=e,t[n]=Oe[0],t[n+1]=Oe[1],t[n+2]=Oe[2],t[n+3]=Oe[3]}const Ue=new Float64Array([-0]),Fe=new Uint8Array(Ue.buffer);function $e(e,t,n){Ue[0]=e,t[n]=Fe[0],t[n+1]=Fe[1],t[n+2]=Fe[2],t[n+3]=Fe[3],t[n+4]=Fe[4],t[n+5]=Fe[5],t[n+6]=Fe[6],t[n+7]=Fe[7]}const Ve=BigInt(Number.MAX_SAFE_INTEGER),ze=BigInt(Number.MIN_SAFE_INTEGER);class He{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}toNumber(e=!1){if(!e&&this.hi>>>31>0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(e+4294967296*t)}return this.lo+4294967296*this.hi}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31!=0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(BigInt(e)+(BigInt(t)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(0n===e)return Ke;if(e<Ve&&e>ze)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,r=e-(n<<32n);return t&&(n=0n|~n,r=0n|~r,++r>qe&&(r=0n,++n>qe&&(n=0n))),new He(Number(r),Number(n))}static fromNumber(e){if(0===e)return Ke;const t=e<0;t&&(e=-e);let n=e>>>0,r=(e-n)/4294967296>>>0;return t&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new He(n,r)}static from(e){return"number"==typeof e?He.fromNumber(e):"bigint"==typeof e?He.fromBigInt(e):"string"==typeof e?He.fromBigInt(BigInt(e)):null!=e.low||null!=e.high?new He(e.low>>>0,e.high>>>0):Ke}}const Ke=new He(0,0);Ke.toBigInt=function(){return 0n},Ke.zzEncode=Ke.zzDecode=function(){return this},Ke.length=function(){return 1};const qe=4294967296n;function We(e,t,n){const r=n;let s,i;for(let r=0;r<e.length;++r)s=e.charCodeAt(r),s<128?t[n++]=s:s<2048?(t[n++]=s>>6|192,t[n++]=63&s|128):55296==(64512&s)&&56320==(64512&(i=e.charCodeAt(r+1)))?(s=65536+((1023&s)<<10)+(1023&i),++r,t[n++]=s>>18|240,t[n++]=s>>12&63|128,t[n++]=s>>6&63|128,t[n++]=63&s|128):(t[n++]=s>>12|224,t[n++]=s>>6&63|128,t[n++]=63&s|128);return n-r}function je(e,t){return RangeError(`index out of range: ${e.pos} + ${t??1} > ${e.len}`)}function Ge(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}class Ye{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return e;if((this.pos+=5)>this.len)throw this.pos=this.len,je(this,10);return e}int32(){return 0|this.uint32()}sint32(){const e=this.uint32();return e>>>1^-(1&e)}bool(){return 0!==this.uint32()}fixed32(){if(this.pos+4>this.len)throw je(this,4);return Ge(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw je(this,4);return 0|Ge(this.buf,this.pos+=4)}float(){if(this.pos+4>this.len)throw je(this,4);const e=function(e,t){return Oe[0]=e[t],Oe[1]=e[t+1],Oe[2]=e[t+2],Oe[3]=e[t+3],Be[0]}(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw je(this,4);const e=function(e,t){return Fe[0]=e[t],Fe[1]=e[t+1],Fe[2]=e[t+2],Fe[3]=e[t+3],Fe[4]=e[t+4],Fe[5]=e[t+5],Fe[6]=e[t+6],Fe[7]=e[t+7],Ue[0]}(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw je(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return function(e,t,n){if(n-t<1)return"";let r;const s=[];let i,o=0;for(;t<n;)i=e[t++],i<128?s[o++]=i:i>191&&i<224?s[o++]=(31&i)<<6|63&e[t++]:i>239&&i<365?(i=((7&i)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,s[o++]=55296+(i>>10),s[o++]=56320+(1023&i)):s[o++]=(15&i)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((r??(r=[])).push(String.fromCharCode.apply(String,s)),o=0);return null!=r?(o>0&&r.push(String.fromCharCode.apply(String,s.slice(0,o))),r.join("")):String.fromCharCode.apply(String,s.slice(0,o))}(e,0,e.length)}skip(e){if("number"==typeof e){if(this.pos+e>this.len)throw je(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw je(this)}while(128&this.buf[this.pos++]);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new He(0,0);let t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw je(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw je(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw je(this,8);const e=Ge(this.buf,this.pos+=4),t=Ge(this.buf,this.pos+=4);return new He(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=ne(this.buf,this.pos);return this.pos+=ee(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function Qe(e,t,n){const r=function(e){return new Ye(e instanceof Uint8Array?e:e.subarray())}(e);return t.decode(r,void 0,n)}const Je=new Uint8Array(0);function Xe(e){const t=e.match(/../g);return null!=t?new Uint8Array(t.map((e=>parseInt(e,16)))):Je}function Ze(e){if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")}const et=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var s=0;s<e.length;s++){var i=e.charAt(s),o=i.charCodeAt(0);if(255!==n[o])throw new TypeError(i+" is ambiguous");n[o]=s}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,s=0;e[t]===c;)r++,t++;for(var i=(e.length-t)*l+1>>>0,o=new Uint8Array(i);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=i-1;(0!==u||h<s)&&-1!==d;d--,h++)u+=a*o[d]>>>0,o[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");s=h,t++}if(" "!==e[t]){for(var f=i-s;f!==i&&0===o[f];)f++;for(var p=new Uint8Array(r+(i-f)),g=r;f!==i;)p[g++]=o[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,s=0,i=t.length;s!==i&&0===t[s];)s++,n++;for(var o=(i-s)*u+1>>>0,l=new Uint8Array(o);s!==i;){for(var h=t[s],d=0,f=o-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,s++}for(var p=o-r;p!==o&&0===l[p];)p++;for(var g=c.repeat(n);p<o;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error(`Non-${t} character`)}}};class tt{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class nt{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return st(this,e)}}class rt{decoders;constructor(e){this.decoders=e}or(e){return st(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(null!=n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function st(e,t){return new rt({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}class it{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new tt(e,t,n),this.decoder=new nt(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function ot({name:e,prefix:t,encode:n,decode:r}){return new it(e,t,n,r)}function at({name:e,prefix:t,alphabet:n}){const{encode:r,decode:s}=et(n,e);return ot({prefix:t,name:e,encode:r,decode:e=>Ze(s(e))})}function ct({name:e,prefix:t,bitsPerChar:n,alphabet:r}){return ot({prefix:t,name:e,encode:e=>function(e,t,n){const r="="===t[t.length-1],s=(1<<n)-1;let i="",o=0,a=0;for(let r=0;r<e.length;++r)for(a=a<<8|e[r],o+=8;o>n;)o-=n,i+=t[s&a>>o];if(0!==o&&(i+=t[s&a<<n-o]),r)for(;i.length*n&7;)i+="=";return i}(e,r,n),decode:t=>function(e,t,n,r){const s={};for(let e=0;e<t.length;++e)s[t[e]]=e;let i=e.length;for(;"="===e[i-1];)--i;const o=new Uint8Array(i*n/8|0);let a=0,c=0,l=0;for(let t=0;t<i;++t){const i=s[e[t]];if(void 0===i)throw new SyntaxError(`Non-${r} character`);c=c<<n|i,a+=n,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}(t,r,n,e)})}const lt=at({prefix:"9",name:"base10",alphabet:"0123456789"}),ut=ct({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ht=ct({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),dt=ct({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),ft=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),pt=ft.reduce(((e,t,n)=>(e[n]=t,e)),[]),gt=ft.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]),yt=ot({prefix:"🚀",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+pt[t]),"")},decode:function(e){const t=[];for(const n of e){const e=gt[n.codePointAt(0)];if(void 0===e)throw new Error(`Non-base256emoji character: ${n}`);t.push(e)}return new Uint8Array(t)}}),mt=ct({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),wt=ct({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),bt=ct({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Et=ct({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),vt=ct({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),St=ct({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),_t=ct({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Rt=ct({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),kt=ct({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),At=at({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),It=at({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Tt=at({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),xt=at({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Dt=ct({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ct=ct({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Nt=ct({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Pt=ct({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Lt=ct({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Bt=ot({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>function(e){return(new TextEncoder).encode(e)}(e)}),Ot=new TextEncoder,Mt=new TextDecoder,Ut="json",Ft=512;function $t(e){return Ot.encode(JSON.stringify(e))}function Vt(e){return JSON.parse(Mt.decode(e))}const zt="raw",Ht=85;function Kt(e){return Ze(e)}function qt(e){return Ze(e)}var Wt=128,jt=-128,Gt=Math.pow(2,31),Yt=128,Qt=127,Jt=Math.pow(2,7),Xt=Math.pow(2,14),Zt=Math.pow(2,21),en=Math.pow(2,28),tn=Math.pow(2,35),nn=Math.pow(2,42),rn=Math.pow(2,49),sn=Math.pow(2,56),on=Math.pow(2,63);const an={encode:function e(t,n,r){n=n||[];for(var s=r=r||0;t>=Gt;)n[r++]=255&t|Wt,t/=128;for(;t&jt;)n[r++]=255&t|Wt,t>>>=7;return n[r]=0|t,e.bytes=r-s+1,n},decode:function e(t,n){var r,s=0,i=0,o=n=n||0,a=t.length;do{if(o>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[o++],s+=i<28?(r&Qt)<<i:(r&Qt)*Math.pow(2,i),i+=7}while(r>=Yt);return e.bytes=o-n,s},encodingLength:function(e){return e<Jt?1:e<Xt?2:e<Zt?3:e<en?4:e<tn?5:e<nn?6:e<rn?7:e<sn?8:e<on?9:10}};function cn(e,t=0){return[an.decode(e,t),an.decode.bytes]}function ln(e,t,n=0){return an.encode(e,t,n),t}function un(e){return an.encodingLength(e)}function hn(e,t){const n=t.byteLength,r=un(e),s=r+un(n),i=new Uint8Array(s+n);return ln(e,i,0),ln(n,i,r),i.set(t,s),new fn(e,n,t,i)}function dn(e){const t=Ze(e),[n,r]=cn(t),[s,i]=cn(t.subarray(r)),o=t.subarray(r+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new fn(n,s,o,t)}class fn{code;size;digest;bytes;constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const pn=Ze,gn={code:0,name:"identity",encode:pn,digest:function(e){return hn(0,pn(e))}};function yn({name:e,code:t,encode:n}){return new mn(e,t,n)}class mn{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?hn(this.code,t):t.then((e=>hn(this.code,e)))}throw Error("Unknown type, must be binary type")}}function wn(e){return async t=>new Uint8Array(await crypto.subtle.digest(e,t))}const bn=yn({name:"sha2-256",code:18,encode:wn("SHA-256")}),En=yn({name:"sha2-512",code:19,encode:wn("SHA-512")});function vn(e,t){const{bytes:n,version:r}=e;return 0===r?function(e,t,n){const{prefix:r}=n;if(r!==Tt.prefix)throw Error(`Cannot string encode V0 in ${n.name} encoding`);const s=t.get(r);if(null==s){const s=n.encode(e).slice(1);return t.set(r,s),s}return s}(n,_n(e),t??Tt.encoder):function(e,t,n){const{prefix:r}=n,s=t.get(r);if(null==s){const s=n.encode(e);return t.set(r,s),s}return s}(n,_n(e),t??mt.encoder)}const Sn=new WeakMap;function _n(e){const t=Sn.get(e);if(null==t){const t=new Map;return Sn.set(e,t),t}return t}class Rn{code;version;multihash;bytes;"/";constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==kn)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==An)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Rn.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=hn(e,t);return Rn.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Rn.equals(this,e)}static equals(e,t){const n=t;return null!=n&&e.code===n.code&&e.version===n.version&&function(e,t){if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}(e.bytes,n.bytes)}}(e.multihash,n.multihash)}toString(e){return vn(this,e)}toJSON(){return{"/":vn(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(null==e)return null;const t=e;if(t instanceof Rn)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:s}=t;return new Rn(e,n,r,s??In(e,n,r.bytes))}if(!0===t[Tn]){const{version:e,multihash:n,code:r}=t,s=dn(n);return Rn.create(e,r,s)}return null}static create(e,t,n){if("number"!=typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==kn)throw new Error(`Version 0 CID must use dag-pb (code: ${kn}) block encoding`);return new Rn(e,t,n,n.bytes);case 1:{const r=In(e,t,n.bytes);return new Rn(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return Rn.create(0,kn,e)}static createV1(e,t){return Rn.create(1,e,t)}static decode(e){const[t,n]=Rn.decodeFirst(e);if(0!==n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Rn.inspectBytes(e),n=t.size-t.multihashSize,r=Ze(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=r.subarray(t.multihashSize-t.digestSize),i=new fn(t.multihashCode,t.digestSize,s,r);return[0===t.version?Rn.createV0(i):Rn.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=cn(e.subarray(t));return t+=r,n};let r=n(),s=kn;if(18===r?(r=0,t=0):s=n(),0!==r&&1!==r)throw new RangeError(`Invalid CID version ${r}`);const i=t,o=n(),a=n(),c=t+a;return{version:r,codec:s,multihashCode:o,digestSize:a,multihashSize:c-i,size:c}}static parse(e,t){const[n,r]=function(e,t){switch(e[0]){case"Q":{const n=t??Tt;return[Tt.prefix,n.decode(`${Tt.prefix}${e}`)]}case Tt.prefix:{const n=t??Tt;return[Tt.prefix,n.decode(e)]}case mt.prefix:{const n=t??mt;return[mt.prefix,n.decode(e)]}case At.prefix:{const n=t??At;return[At.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}(e,t),s=Rn.decode(r);if(0===s.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return _n(s).set(n,e),s}}const kn=112,An=18;function In(e,t,n){const r=un(e),s=r+un(t),i=new Uint8Array(s+n.byteLength);return ln(e,i,0),ln(t,i,r),i.set(n,s),i}const Tn=Symbol.for("@ipld/js-cid/CID"),xn={...u,...r,...l,...e,...t,...i,...o,...a,...c,...s};function Dn(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}const Cn=Dn("utf8","u",(e=>"u"+new TextDecoder("utf8").decode(e)),(e=>(new TextEncoder).encode(e.substring(1)))),Nn=Dn("ascii","a",(e=>{let t="a";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}),(e=>{const t=K((e=e.substring(1)).length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t})),Pn={utf8:Cn,"utf-8":Cn,hex:xn.base16,latin1:Nn,ascii:Nn,binary:Nn,...xn};function Ln(e,t="utf8"){const n=Pn[t];if(null==n)throw new Error(`Unsupported encoding "${t}"`);return n.decoder.decode(`${n.prefix}${e}`)}class Bn{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function On(){}class Mn{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const Un=function(){const e=8192;let t,n=e;return function(r){if(r<1||r>4096)return K(r);n+r>e&&(t=K(e),n=0);const s=t.subarray(n,n+=r);return 7&n&&(n=1+(7|n)),s}}();class Fn{len;head;tail;states;constructor(){this.len=0,this.head=new Bn(On,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Bn(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new zn((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Hn,10,He.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=He.fromBigInt(e);return this._push(Hn,t.length(),t)}uint64Number(e){return this._push(te,ee(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=He.fromBigInt(e).zzEncode();return this._push(Hn,t.length(),t)}sint64Number(e){const t=He.fromNumber(e).zzEncode();return this._push(Hn,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push($n,1,e?1:0)}fixed32(e){return this._push(Kn,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=He.fromBigInt(e);return this._push(Kn,4,t.lo)._push(Kn,4,t.hi)}fixed64Number(e){const t=He.fromNumber(e);return this._push(Kn,4,t.lo)._push(Kn,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(Me,4,e)}double(e){return this._push($e,8,e)}bytes(e){const t=e.length>>>0;return 0===t?this._push($n,1,0):this.uint32(t)._push(qn,t,e)}string(e){const t=function(e){let t=0,n=0;for(let r=0;r<e.length;++r)n=e.charCodeAt(r),n<128?t+=1:n<2048?t+=2:55296==(64512&n)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t}(e);return 0!==t?this.uint32(t)._push(We,t,e):this._push($n,1,0)}fork(){return this.states=new Mn(this),this.head=this.tail=new Bn(On,0,0),this.len=0,this}reset(){return null!=this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Bn(On,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),0!==n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=(n=this.len,null!=globalThis.Buffer?K(n):Un(n));var n;let r=0;for(;null!=e;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t}}function $n(e,t,n){t[n]=255&e}function Vn(e,t,n){for(;e>127;)t[n++]=127&e|128,e>>>=7;t[n]=e}class zn extends Bn{next;constructor(e,t){super(Vn,e,t),this.next=void 0}}function Hn(e,t,n){for(;0!==e.hi;)t[n++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[n++]=127&e.lo|128,e.lo=e.lo>>>7;t[n++]=e.lo}function Kn(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}function qn(e,t,n){t.set(e,n)}function Wn(e,t,n){t.set(e,n)}function jn(e,t,n){e.length<40?We(e,t,n):null!=t.utf8Write?t.utf8Write(e,n):t.set(Ln(e),n)}function Gn(e,t){const n=new Fn;return t.encode(e,n,{lengthDelimited:!1}),n.finish()}var Yn,Qn,Jn,Xn,Zn,er,tr,nr,rr,sr;function ir(e,t,n,r){return{name:e,type:t,encode:n,decode:r}}function or(e){function t(t){if(null==e[t.toString()])throw new Error("Invalid enum value");return e[t]}return ir("enum",Yn.VARINT,(function(e,n){const r=t(e);n.int32(r)}),(function(e){return t(e.int32())}))}function ar(e,t){return ir("message",Yn.LENGTH_DELIMITED,e,t)}null!=globalThis.Buffer&&(Fn.prototype.bytes=function(e){const t=e.length>>>0;return this.uint32(t),t>0&&this._push(Wn,t,e),this},Fn.prototype.string=function(e){const t=globalThis.Buffer.byteLength(e);return this.uint32(t),t>0&&this._push(jn,t,e),this}),function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(Yn||(Yn={}));class cr extends Error{code;constructor(e,t){super(e),this.code=t}}!function(e){e.WantBlock="WantBlock",e.WantHave="WantHave"}(Qn||(Qn={})),function(e){e[e.WantBlock=0]="WantBlock",e[e.WantHave=1]="WantHave"}(Jn||(Jn={})),function(e){e.codec=()=>or(Jn)}(Qn||(Qn={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.cid&&e.cid.byteLength>0&&(t.uint32(10),t.bytes(e.cid)),null!=e.priority&&0!==e.priority&&(t.uint32(16),t.int32(e.priority)),null!=e.cancel&&(t.uint32(24),t.bool(e.cancel)),null!=e.wantType&&(t.uint32(32),Qn.codec().encode(e.wantType,t)),null!=e.sendDontHave&&(t.uint32(40),t.bool(e.sendDontHave)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={cid:H(0),priority:0},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.cid=e.bytes();break;case 2:r.priority=e.int32();break;case 3:r.cancel=e.bool();break;case 4:r.wantType=Qn.codec().decode(e);break;case 5:r.sendDontHave=e.bool();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(Xn||(Xn={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.entries)for(const n of e.entries)t.uint32(10),Xn.codec().encode(n,t);null!=e.full&&(t.uint32(16),t.bool(e.full)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={entries:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:if(null!=n.limits?.entries&&r.entries.length===n.limits.entries)throw new cr('decode error - map field "entries" had too many elements',"ERR_MAX_LENGTH");r.entries.push(Xn.codec().decode(e,e.uint32(),{limits:n.limits?.entries$}));break;case 2:r.full=e.bool();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(Zn||(Zn={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.prefix&&e.prefix.byteLength>0&&(t.uint32(10),t.bytes(e.prefix)),null!=e.data&&e.data.byteLength>0&&(t.uint32(18),t.bytes(e.data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={prefix:H(0),data:H(0)},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.prefix=e.bytes();break;case 2:r.data=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(er||(er={})),function(e){e.HaveBlock="HaveBlock",e.DontHaveBlock="DontHaveBlock"}(tr||(tr={})),function(e){e[e.HaveBlock=0]="HaveBlock",e[e.DontHaveBlock=1]="DontHaveBlock"}(nr||(nr={})),function(e){e.codec=()=>or(nr)}(tr||(tr={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.cid&&e.cid.byteLength>0&&(t.uint32(10),t.bytes(e.cid)),null!=e.type&&0!==nr[e.type]&&(t.uint32(16),tr.codec().encode(e.type,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={cid:H(0),type:tr.HaveBlock},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.cid=e.bytes();break;case 2:r.type=tr.codec().decode(e);break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(rr||(rr={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.wantlist&&(t.uint32(10),Zn.codec().encode(e.wantlist,t)),null!=e.blocks)for(const n of e.blocks)t.uint32(26),er.codec().encode(n,t);if(null!=e.blockPresences)for(const n of e.blockPresences)t.uint32(34),rr.codec().encode(n,t);null!=e.pendingBytes&&0!==e.pendingBytes&&(t.uint32(40),t.int32(e.pendingBytes)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={blocks:[],blockPresences:[],pendingBytes:0},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.wantlist=Zn.codec().decode(e,e.uint32(),{limits:n.limits?.wantlist});break;case 3:if(null!=n.limits?.blocks&&r.blocks.length===n.limits.blocks)throw new cr('decode error - map field "blocks" had too many elements',"ERR_MAX_LENGTH");r.blocks.push(er.codec().decode(e,e.uint32(),{limits:n.limits?.blocks$}));break;case 4:if(null!=n.limits?.blockPresences&&r.blockPresences.length===n.limits.blockPresences)throw new cr('decode error - map field "blockPresences" had too many elements',"ERR_MAX_LENGTH");r.blockPresences.push(rr.codec().decode(e,e.uint32(),{limits:n.limits?.blockPresences$}));break;case 5:r.pendingBytes=e.int32();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(sr||(sr={}));function lr(e,t,n,r,s,i){let o=0,a=!1;for(let c=n;c<e.length;c++){const n=e[c],l=i(n);if(l>4193664)throw new k("Cannot send block as after encoding it is over the max message size","ERR_BLOCK_TOO_LARGE");const u=s+l;if(u>r){a=!0;break}t.push(n),o++,s=u}return{hasMore:a,added:o,newSize:s}}function ur(e){return fr(3,er.encode(e))}function hr(e){return fr(4,rr.encode(e))}function dr(e){return fr(1,Xn.encode(e))}function fr(e,t){return ee(e)+ee(t.byteLength)+t.byteLength}class pr extends S{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnTransientConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[Ne],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnTransientConnections=t.runOnTransientConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??Pe,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??Le,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new V({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",(e=>{this.log.error("error sending wantlist to peer",e.detail)}))}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnections});const e={onConnect:e=>{this.safeDispatchEvent("peer:connected",{detail:e})},onDisconnect:e=>{this.safeDispatchEvent("peer:disconnected",{detail:e})}};this.registrarIds=[];for(const t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach((e=>{this.safeDispatchEvent("peer:connected",{detail:e.remotePeer})}))}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),null!=this.registrarIds){for(const e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;const{stream:t,connection:n}=e;Promise.resolve().then((async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,n.remotePeer);const e=()=>{"open"===t.status?t.abort(new k(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`,"ERR_TIMEOUT")):this.log("stream aborted with status %s",t.status)};let r=AbortSignal.timeout(this.messageReceiveTimeout);r.addEventListener("abort",e),await t.closeWrite(),await Re(t,(e=>Ee(e,{maxDataLength:this.maxIncomingMessageSize})),(async s=>{for await(const i of s)try{const s=sr.decode(i);this.log("incoming new bitswap %s message from %p on stream",t.protocol,n.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:n.remotePeer,message:s}}),r.removeEventListener("abort",e),r=AbortSignal.timeout(this.messageReceiveTimeout),r.addEventListener("abort",e)}catch(e){this.log.error("error reading incoming bitswap message from %p on stream",n.remotePeer,t.id,e),t.abort(e);break}}))})).catch((e=>{this.log.error("error handling incoming stream from %p",n.remotePeer,e),t.abort(e)}))}async*findProviders(e,t){t?.onProgress?.(new Ce("bitswap:network:find-providers",e));for await(const n of this.routing.findProviders(e,t))await this.libp2p.isDialable(n.multiaddrs,{runOnTransientConnection:this.runOnTransientConnections})&&(yield n)}async findAndConnect(e,t){await z(Se(De(this.findProviders(e,t),t?.maxProviders??3),(async e=>this.connectTo(e.id,t)))).catch((e=>{this.log.error(e)}))}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");const r=this.sendQueue.queue.find((t=>e.equals(t.options.peerId)&&"queued"===t.status));if(null!=r)return r.options.message=function(e,t){for(const[n,r]of t.wantlist.entries()){const t=e.wantlist.get(n);null!=t&&(t.priority>r.priority&&(r.priority=t.priority),r.cancel=r.cancel??t.cancel,r.wantType=r.wantType??t.wantType,r.sendDontHave=r.sendDontHave??t.sendDontHave),e.wantlist.set(n,r)}for(const[n,r]of t.blockPresences.entries())e.blockPresences.set(n,r);for(const[n,r]of t.blocks.entries())e.blocks.set(n,r);return t.full&&!e.full&&(e.full=!0),e}(r.options.message,t),void await r.join({signal:n?.signal});await this.sendQueue.add((async t=>{const n=t?.message;if(null==n)throw new k("No message to send","ERR_NO_MESSAGE");this.log("sendMessage to %p",e),t?.onProgress?.(new Ce("bitswap:network:send-wantlist",e));const r=await this.libp2p.dialProtocol(e,Ne,t);await r.closeRead();try{await Re(function*(e,t){const n=[...e.wantlist.values()],r=[...e.blockPresences.values()],s=[...e.blocks.values()];let i=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:e.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let u=sr.encode(l).byteLength,{added:h,hasMore:d,newSize:f}=lr(s,l.blocks,a,t,u,ur);a+=h,u=f;const p=d;({added:h,hasMore:d,newSize:f}=lr(r,l.blockPresences,o,t,u,hr)),o+=h,u=f;const g=d;if(({added:h,hasMore:d,newSize:f}=lr(n,l.wantlist.entries,i,t,u,dr)),i+=h,u=f,c=!p&&!g&&!d,c||(l.wantlist.full=!1),yield sr.encode(l),c)break}}(n,this.maxOutgoingMessageSize),(e=>fe(e)),r),await r.close(t)}catch(n){t?.onProgress?.(new Ce("bitswap:network:send-wantlist:error",{peer:e,error:n})),this.log.error("error sending message to %p",e,n),r.abort(n)}this._updateSentStats(n.blocks)}),{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new k("Network isn't running","ERR_NOT_STARTED");t?.onProgress?.(new Ce("bitswap:network:dial",e));const[n]=await Promise.all([this.libp2p.dial(e,t),B(this.libp2p,"peer:identify",t?.signal,{filter:t=>{if(!t.detail.peerId.equals(e))return!1;if(t.detail.protocols.includes(Ne))return!0;throw new k(`${e} did not support ${Ne}`,"ERR_BITSWAP_UNSUPPORTED_BY_PEER")}})]);return n}_updateSentStats(e){let t=0;for(const n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}}const gr=Symbol.for("@libp2p/peer-id");function yr(e){return null!=e&&Boolean(e[gr])}function mr(e,t="utf8"){const n=Pn[t];if(null==n)throw new Error(`Unsupported encoding "${t}"`);return n.encoder.encode(e).substring(1)}const wr=Symbol.for("nodejs.util.inspect.custom"),br=Object.values(xn).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),xn.identity.decoder),Er=114,vr=36,Sr=37;class _r{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[gr]=!0;toString(){return null==this.string&&(this.string=Tt.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Rn.createV1(Er,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return oe(this.multihash.bytes,e);if("string"==typeof e)return xr(e).equals(this);if(null!=e?.multihash?.bytes)return oe(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[wr](){return`PeerId(${this.toString()})`}}class Rr extends _r{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class kr extends _r{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}}class Ar extends _r{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}}const Ir=2336;class Tr{type="url";multihash;privateKey;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=gn.digest(Ln(this.url))}[wr](){return`PeerId(${this.url})`}[gr]=!0;toString(){return this.toCID().toString()}toCID(){return Rn.createV1(Ir,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=mr(e)),e.toString()===this.toString())}}function xr(e,t){if(t=t??br,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=dn(Tt.decode(`z${e}`));return e.startsWith("12D")?new kr({multihash:t}):e.startsWith("16U")?new Ar({multihash:t}):new Rr({multihash:t})}return Dr(br.decode(e))}function Dr(e){try{const t=dn(e);if(t.code===gn.code){if(t.digest.length===vr)return new kr({multihash:t});if(t.digest.length===Sr)return new Ar({multihash:t})}if(t.code===bn.code)return new Rr({multihash:t})}catch{return function(e){if(null==e?.multihash||null==e.version||1===e.version&&e.code!==Er&&e.code!==Ir)throw new Error("Supplied PeerID CID is invalid");if(e.code===Ir){const t=mr(e.multihash.digest);return new Tr(new URL(t))}const t=e.multihash;if(t.code===bn.code)return new Rr({multihash:e.multihash});if(t.code===gn.code){if(t.digest.length===vr)return new kr({multihash:e.multihash});if(t.digest.length===Sr)return new Ar({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(Rn.decode(e))}throw new Error("Supplied PeerID CID is invalid")}async function Cr(e,t){return e.length===vr?new kr({multihash:hn(gn.code,e),privateKey:t}):e.length===Sr?new Ar({multihash:hn(gn.code,e),privateKey:t}):new Rr({multihash:await bn.digest(e),publicKey:e,privateKey:t})}function Nr(e,t){const n={[Symbol.iterator]:()=>n,next:()=>{const n=e.next(),r=n.value;return!0===n.done||null==r?{done:!0,value:void 0}:{done:!1,value:t(r)}}};return n}class Pr{map;constructor(e){if(this.map=new Map,null!=e)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Nr(this.map.entries(),(e=>[xr(e[0]),e[1]]))}forEach(e){this.map.forEach(((t,n)=>{e(t,xr(n),this)}))}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return Nr(this.map.keys(),(e=>xr(e)))}values(){return this.map.values()}get size(){return this.map.size}}class Lr extends Pr{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Br(e){const{name:t,metrics:n}=e;let r;return r=null!=n?new Lr({name:t,metrics:n}):new Pr,r}class Or{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const n=Dt.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){const n=Dt.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){const n=Dt.encode(e.multihash.bytes);this.blocks.set(n,t)}}function Mr(e){return function(e){let t=new Uint8Array(e.reduce(((e,t)=>e+ee(t)),0)),n=0;for(const r of e)t=re(r,t,n),n+=ee(r);return t}([e.version,e.code,e.multihash.code,e.multihash.digest.byteLength])}class Ur{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new Or,n=new Set;for(const[r,s]of this.wants.entries())try{const i=await this.blockstore.get(s.cid,e);s.wantType===Qn.WantHave?i.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",s.cid),n.add(r),t.addBlock(s.cid,{data:i,prefix:Mr(s.cid)})):(this.log("sending have for %c",s.cid),t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:tr.HaveBlock})):(this.log("sending block for %c",s.cid),n.add(r),t.addBlock(s.cid,{data:i,prefix:Mr(s.cid)}))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e;if(this.log("do not have block for %c",s.cid),!s.sendDontHave)continue;if(!0===s.sentDontHave)continue;s.sentDontHave=!0,t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:tr.DontHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce(((e,t)=>e+t.data.byteLength),0));for(const e of n)this.wants.delete(e)}}}class Fr{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Br({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",(e=>{this.receiveMessage(e.detail.peer,e.detail.message).catch((t=>{this.log.error("error receiving bitswap message from %p",e.detail.peer,t)}))})),this.network.addEventListener("peer:disconnected",(e=>{this.peerDisconnected(e.detail)}))}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(null!=t)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(null!=t)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map((e=>e.peerId))}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(null==n&&(n=new Ur({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce(((e,t)=>e+t.data.byteLength),0)??0),null!=t.wantlist){!0===t.wantlist.full&&n.wants.clear();for(const r of t.wantlist.entries){const t=Rn.decode(r.cid),s=mr(t.multihash.bytes,"base64");!0===r.cancel?(this.log("peer %p cancelled want of block for %c",e,t),n.wants.delete(s)):(r.wantType===Qn.WantHave?this.log("peer %p wanted block presence for %c",e,t):this.log("peer %p wanted block for %c",e,t),n.wants.set(s,{cid:t,priority:r.priority,wantType:r.wantType??Qn.WantBlock,sendDontHave:r.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){const n=mr(e.multihash.bytes,"base64"),r=[];for(const e of this.ledgerMap.values())e.wants.has(n)&&r.push(e);await Promise.all(r.map((async e=>e.sendBlocksToPeer(t))))}peerDisconnected(e){this.ledgerMap.delete(e)}}const $r="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0;function Vr(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function zr(e,...t){if(!((n=e)instanceof Uint8Array||null!=n&&"object"==typeof n&&"Uint8Array"===n.constructor.name))throw new Error("Uint8Array expected");var n;if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function Hr(e){if("function"!=typeof e||"function"!=typeof e.create)throw new Error("Hash should be wrapped by utils.wrapConstructor");Vr(e.outputLen),Vr(e.blockLen)}function Kr(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}const qr=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),Wr=(e,t)=>e<<32-t|e>>>t,jr=(e,t)=>e<<t|e>>>32-t>>>0;new Uint8Array(new Uint32Array([287454020]).buffer)[0];const Gr=async()=>{};async function Yr(e,t,n){let r=Date.now();for(let s=0;s<e;s++){n(s);const e=Date.now()-r;e>=0&&e<t||(await Gr(),r+=e)}}function Qr(e){return"string"==typeof e&&(e=function(e){if("string"!=typeof e)throw new Error("utf8ToBytes expected string, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e)),zr(e),e}class Jr{clone(){return this._cloneInto()}}const Xr={}.toString;function Zr(e){const t=t=>e().update(Qr(t)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function es(e=32){if($r&&"function"==typeof $r.getRandomValues)return $r.getRandomValues(new Uint8Array(e));if($r&&"function"==typeof $r.randomBytes)return $r.randomBytes(e);throw new Error("crypto.getRandomValues must be defined")}function ts(e){if(isNaN(e)||e<=0)throw new k("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return es(e)}var ns=n(437);const rs=Math.LN2*Math.LN2;class ss{static create(e,t=.005){const n=function(e,t=.005){const n=Math.round(-1*e*Math.log(t)/rs);return{bits:n,hashes:Math.round(n/e*Math.LN2)}}(e,t);return new ss(n)}seeds;bits;buffer;constructor(e={}){null!=e.seeds?this.seeds=e.seeds:this.seeds=function(e){let t,n;const r=[];for(let s=0;s<e;s++)for(t=new ue(ts(4)),r[s]=t.getUint32(0,!0),n=0;n<s;n++)if(r[s]===r[n]){s--;break}return r}(e.hashes??8),this.bits=e.bits??1024,this.buffer=H(Math.ceil(this.bits/8))}add(e){"string"==typeof e&&(e=Ln(e));for(let t=0;t<this.seeds.length;t++){const n=ns.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(n)}}has(e){"string"==typeof e&&(e=Ln(e));for(let t=0;t<this.seeds.length;t++){const n=ns.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(n))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;let r=this.buffer[t];r|=1<<n,this.buffer[t]=r}getbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;return!!(this.buffer[t]&1<<n)}}class is extends S{intialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=ss.create(this.maxProviders)}async retrieve(e,t={}){const n=Dt.encode(e.multihash.bytes),r=this.requests.get(n);if(null!=r)return this.log("join existing request for %c",e),r;const s=x();if(this.requests.set(n,s.promise),0===this.providers.length){let n=!1;null==this.intialPeerSearchComplete&&(n=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.intialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.intialPeerSearchComplete,n&&this.log("found initial session peers for %c",e)}let i=!1;const o=new $({concurrency:this.maxProviders});o.addEventListener("error",(()=>{})),o.addEventListener("failure",(e=>{this.log.error("error querying provider %o, evicting from session",e.detail.job.options.provider,e.detail.error),this.evict(e.detail.job.options.provider)})),o.addEventListener("success",(e=>{i=!0,s.resolve(e.detail.result)})),o.addEventListener("idle",(()=>{i||!0===t.signal?.aborted||Promise.resolve().then((async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let e=0;e<this.minProviders&&0!==this.providers.length;e++){const e=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(e)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),s.resolve(await this.retrieve(e,t))})).catch((t=>{this.log.error("could not find new providers for %c",e,t),s.reject(t)}))}));const a=n=>{o.add((async()=>this.queryProvider(e,n.detail,t)),{provider:n.detail}).catch((n=>{!0!==t.signal?.aborted&&this.log.error("error retrieving session block for %c",e,n)}))};this.addEventListener("provider",a),Promise.all([...this.providers].map((async n=>o.add((async()=>this.queryProvider(e,n,t)),{provider:n})))).catch((n=>{!0!==t.signal?.aborted&&this.log.error("error retrieving session block for %c",e,n)}));try{return await s.promise}finally{this.removeEventListener("provider",a),o.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));const t=this.providers.findIndex((t=>this.equals(t,e)));-1!==t&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return null!=this.providers.find((t=>this.equals(t,e)))||!!this.isEvicted(e)}async findProviders(e,t,n){const r=x();let s=0;return Promise.resolve().then((async()=>{this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e);for await(const i of this.findNewProviders(e,n)){if(s===this.maxProviders||!0===n.signal?.aborted)break;if(!this.hasProvider(i)&&(this.log("found %d/%d new providers",s,this.maxProviders),this.providers.push(i),this.safeDispatchEvent("provider",{detail:i}),s++,s===t&&(this.log("session is ready"),r.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",s);break}}if(this.log("found %d/%d new session peers",s,this.maxProviders),s<t)throw new k(`Found ${s} of ${t} ${this.name} providers for ${e}`,"ERR_INSUFFICIENT_PROVIDERS_FOUND")})).catch((t=>{this.log.error("error searching routing for potential session peers for %c",e,t.errors??t),r.reject(t)})),r.promise}}class os extends is{wantList;network;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);const r=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,r.has?"has":"does not have",e),r.has&&null!=r.block)return r.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(const n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toBytes()}equals(e,t){return e.equals(t)}}class as{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}}class cs extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function ls(e){const{name:t,metrics:n}=e;let r;return r=null!=n?new cs({name:t,metrics:n}):new Map,r}const us=function(e){if(!(e instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const t=[];for(;e.length>0;){const n=se(e);t.push(n),e=e.slice(ee(n))}return t};class hs extends S{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Br({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=ls({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",(e=>{this.receiveMessage(e.detail.peer,e.detail.message).catch((t=>{this.log.error("error receiving bitswap message from %p",e.detail.peer,t)}))})),this.network.addEventListener("peer:connected",(e=>{this.peerConnected(e.detail).catch((t=>{this.log.error("error processing newly connected bitswap peer %p",e.detail,t)}))})),this.network.addEventListener("peer:disconnected",(e=>{this.peerDisconnected(e.detail)}))}async addEntry(e,t){const n=mr(e.multihash.bytes,"base64");let r=this.wants.get(n);null==r&&(r={cid:e,priority:t.priority??1,wantType:t.wantType??Qn.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,r)),r.wantType===Qn.WantHave&&t.wantType===Qn.WantBlock&&(r.wantType=Qn.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===Qn.WantBlock?(await B(this,"block",t?.signal,{filter:t=>oe(e.multihash.digest,t.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await B(this,"presence",t?.signal,{filter:t=>oe(e.multihash.digest,t.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{!0===t.signal?.aborted&&(this.log("want for %c was aborted, cancelling want",e),r.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await(this.sendingMessages?.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout((()=>{this.sendMessages().catch((e=>{this.log("error sending messages to peers",e)}))}),this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=x(),await Promise.all([...this.peers.entries()].map((async([e,t])=>{const n=new Set,r=new Or;for(const[e,s]of this.wants.entries())t.has(e)||s.cancel||(n.add(e),r.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:s.priority,wantType:s.wantType,cancel:s.cancel,sendDontHave:s.sendDontHave}));if(0!==r.wantlist.size)try{await this.network.sendMessage(e,r);for(const e of n)t.add(e)}catch(e){this.log.error("error sending full wantlist to new peer",e)}}))).catch((e=>{this.log.error("error sending messages",e)}));for(const[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(const t of this.peers.values())t.delete(e)}this.sendingMessages.resolve()}has(e){const t=mr(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){const r=new Or;return r.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Qn.WantHave,priority:1}),await this.network.sendMessage(t,r),(await B(this,"presence",n.signal,{filter:n=>t.equals(n.detail.sender)&&oe(e.multihash.digest,n.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:Qn.WantBlock})}async wantSessionBlock(e,t,n={}){const r=new Or;return r.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Qn.WantBlock,priority:1}),await this.network.sendMessage(t,r),(await B(this,"presence",n.signal,{filter:n=>t.equals(n.detail.sender)&&oe(e.multihash.digest,n.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){const n=mr(e.multihash.bytes,"base64"),r=this.wants.get(n);null!=r&&(r.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(const r of t.blocks){if(null==r.prefix||null==r.data)continue;const t=us(r.prefix),s=t[0],i=t[1],o=t[2],a=o===bn.code?bn:await(this.hashLoader?.getHasher(o));if(null==a){this.log.error("unknown hash algorithm",o);continue}let c=a.digest(r.data);null!=c.then&&(c=await c);const l=Rn.create(0===s?0:1,i,c);this.log("received block from %p for %c",e,l),this.safeDispatchEvent("block",{detail:{sender:e,cid:l,block:r.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:l,has:!0,block:r.data}});const u=mr(l.multihash.bytes,"base64"),h=this.wants.get(u);null!=h&&(h.cancel=!0,n=!0)}for(const{cid:n,type:r}of t.blockPresences){const t=Rn.decode(n);this.log("received %s from %p for %c",r,e,t),this.safeDispatchEvent("presence",{detail:{sender:e,cid:t,has:r===tr.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){const t=new Set,n=new Or(!0);for(const[e,r]of this.wants.entries())r.cancel||(t.add(e),n.addWantlistEntry(r.cid,{cid:r.cid.bytes,priority:1,wantType:Qn.WantBlock,cancel:!1,sendDontHave:!1}));if(0!==n.wantlist.size)try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(t){this.log.error("error sending full wantlist to new peer %p",e,t)}else this.peers.set(e,t)}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class ds{log;logger;stats;network;blockstore;peerWantLists;wantList;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new as(e),this.network=new pr(e,t),this.peerWantLists=new Fr({...e,network:this.network},t),this.wantList=new hs({...e,network:this.network},t)}createSession(e={}){return t={wantList:this.wantList,network:this.network,logger:this.logger},new os(t,e);var t}async want(e,t={}){const n=new AbortController,r=v([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:r}).catch((t=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,t)}));try{return(await this.wantList.wantBlock(e,{...t,signal:r})).block}finally{n.abort(),r.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter((e=>!e.cancel)).map((e=>({cid:e.cid,priority:e.priority,wantType:e.wantType})))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}class fs{bitswap;started;constructor(e,t={}){const{hashers:n}=e;this.bitswap=((e,t={})=>new ds(e,t))(e,{hashLoader:{getHasher:async e=>{let t;if(t="string"==typeof e?Object.values(n).find((t=>t.name===e)):n[e],null!=t)return t;throw new Error(`Could not load hasher for code/name "${e}"`)}},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(e,t,n)=>{await this.bitswap.notify(e,t,n)},retrieve:async(e,n)=>t.retrieve(e,n)}}}function ps(e={}){return t=>new fs(t,e)}const gs=45,ys=15,ms=new class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return void 0===n&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically((()=>{const t=this.readChar();if(t===e)return t}))}readSeparator(e,t,n){return this.readAtomically((()=>{if(!(t>0&&void 0===this.readGivenChar(e)))return n()}))}readNumber(e,t,n,r){return this.readAtomically((()=>{let s=0,i=0;const o=this.peekChar();if(void 0===o)return;const a="0"===o,c=2**(8*r)-1;for(;;){const n=this.readAtomically((()=>{const t=this.readChar();if(void 0===t)return;const n=Number.parseInt(t,e);return Number.isNaN(n)?void 0:n}));if(void 0===n)break;if(s*=e,s+=n,s>c)return;if(i+=1,void 0!==t&&i>t)return}return 0===i||!n&&a&&i>1?void 0:s}))}readIPv4Addr(){return this.readAtomically((()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,(()=>this.readNumber(10,3,!1,1)));if(void 0===n)return;e[t]=n}return e}))}readIPv6Addr(){const e=e=>{for(let t=0;t<e.length/2;t++){const n=2*t;if(t<e.length-3){const r=this.readSeparator(":",t,(()=>this.readIPv4Addr()));if(void 0!==r)return e[n]=r[0],e[n+1]=r[1],e[n+2]=r[2],e[n+3]=r[3],[n+4,!0]}const r=this.readSeparator(":",t,(()=>this.readNumber(16,4,!0,2)));if(void 0===r)return[n,!1];e[n]=r>>8,e[n+1]=255&r}return[e.length,!1]};return this.readAtomically((()=>{const t=new Uint8Array(16),[n,r]=e(t);if(16===n)return t;if(r)return;if(void 0===this.readGivenChar(":"))return;if(void 0===this.readGivenChar(":"))return;const s=new Uint8Array(14),i=16-(n+2),[o]=e(s.subarray(0,i));return t.set(s.subarray(0,o),16-o),t}))}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};function ws(e){return Boolean(function(e){if(!(e.length>ys))return ms.new(e).parseWith((()=>ms.readIPv4Addr()))}(e))}function bs(e){return Boolean(function(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>gs))return ms.new(e).parseWith((()=>ms.readIPv6Addr()))}(e))}function Es(e){return Boolean(function(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>gs))return ms.new(e).parseWith((()=>ms.readIPAddr()))}(e))}var vs=n(507);const Ss=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map((e=>new vs.Netmask(e)));function _s(e){for(const t of Ss)if(t.contains(e))return!0;return!1}function Rs(e){return ws(e)?_s(e):/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(e)?function(e){const t=e.split(":");if(t.length<2)return!1;const n=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0");return _s(`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}`)}(e):/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)?function(e){const t=e.split(":");return _s(t[t.length-1])}(e):bs(e)?function(e){return/^::$/.test(e)||/^::1$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}(e):void 0}parseInt("0xFFFF",16),new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);const ks=ws,As=bs,Is=function(e){let t=0;if(e=e.toString().trim(),ks(e)){const n=new Uint8Array(t+4);return e.split(/\./g).forEach((e=>{n[t++]=255&parseInt(e,10)})),n}if(As(e)){const n=e.split(":",8);let r;for(r=0;r<n.length;r++){let e;ks(n[r])&&(e=Is(n[r]),n[r]=mr(e.slice(0,2),"base16")),null!=e&&++r<8&&n.splice(r,0,mr(e.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(r=0;r<n.length&&""!==n[r];r++);const e=[r,1];for(r=9-n.length;r>0;r--)e.push("0");n.splice.apply(n,e)}const s=new Uint8Array(t+16);for(r=0;r<n.length;r++){const e=parseInt(n[r],16);s[t++]=e>>8&255,s[t++]=255&e}return s}throw new Error("invalid ip address")},Ts=function(e,t=0,n){t=~~t,n=n??e.length-t;const r=new DataView(e.buffer);if(4===n){const r=[];for(let s=0;s<n;s++)r.push(e[t+s]);return r.join(".")}if(16===n){const e=[];for(let s=0;s<n;s+=2)e.push(r.getUint16(t+s).toString(16));return e.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},xs=-1,Ds={},Cs={};function Ns(e){if("number"==typeof e){if(null!=Cs[e])return Cs[e];throw new Error(`no protocol with code: ${e}`)}if("string"==typeof e){if(null!=Ds[e])return Ds[e];throw new Error(`no protocol with name: ${e}`)}throw new Error("invalid protocol id type: "+typeof e)}function Ps(e,t){switch(Ns(e).code){case 4:case 41:return function(e){const t=Ts(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!Es(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return $s(t);case 6:case 273:case 33:case 132:return Us(t).toString();case 421:return function(e){const t=se(e),n=e.slice(ee(t));if(n.length!==t)throw new Error("inconsistent lengths");return mr(n,"base58btc")}(t);case 444:case 445:return function(e){const t=e.slice(0,e.length-2),n=e.slice(e.length-2);return`${mr(t,"base32")}:${Us(n)}`}(t);case 466:return function(e){const t=se(e),n=e.slice(ee(t));if(n.length!==t)throw new Error("inconsistent lengths");return"u"+mr(n,"base64url")}(t);case 481:return globalThis.encodeURIComponent($s(t));default:return mr(t,"base16")}}function Ls(e,t){switch(Ns(e).code){case 4:case 41:return function(e){if(!Es(e))throw new Error("invalid ip address");return Is(e)}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Fs(t);case 6:case 273:case 33:case 132:return Ms(parseInt(t,10));case 421:return function(e){let t;t="Q"===e[0]||"1"===e[0]?dn(Tt.decode(`z${e}`)).bytes:Rn.parse(e).multihash.bytes;const n=Uint8Array.from(re(t.length));return ie([n,t],n.length+t.length)}(t);case 444:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const n=mt.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Ms(r);return ie([n,s],n.length+s.length)}(t);case 445:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const n=mt.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Ms(r);return ie([n,s],n.length+s.length)}(t);case 466:return function(e){const t=Os.decode(e),n=Uint8Array.from(re(t.length));return ie([n,t],n.length+t.length)}(t);case 481:return Fs(globalThis.decodeURIComponent(t));default:return Ln(t,"base16")}}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,xs,"ip6zone"],[43,8,"ipcidr"],[53,xs,"dns",!0],[54,xs,"dns4",!0],[55,xs,"dns6",!0],[56,xs,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,xs,"unix",!1,!0],[421,xs,"ipfs"],[421,xs,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,xs,"garlic64"],[448,0,"tls"],[449,xs,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,xs,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,xs,"http-path"],[777,xs,"memory"]].forEach((e=>{const t=function(e,t,n,r,s){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(s)}}(...e);Cs[t.code]=t,Ds[t.name]=t})),Ns("ip4"),Ns("ip6"),Ns("ipcidr");const Bs=Object.values(xn).map((e=>e.decoder)),Os=function(){let e=Bs[0].or(Bs[1]);return Bs.slice(2).forEach((t=>e=e.or(t))),e}();function Ms(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function Us(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function Fs(e){const t=Ln(e),n=Uint8Array.from(re(t.length));return ie([n,t],n.length+t.length)}function $s(e){const t=se(e);if((e=e.slice(ee(t))).length!==t)throw new Error("inconsistent lengths");return mr(e)}function Vs(e){const t=[],n=[];let r=null,s=0;for(;s<e.length;){const i=se(e,s),o=ee(i),a=Ns(i),c=Ks(a,e.slice(s+o));if(0===c){t.push([i]),n.push([i]),s+=o;continue}const l=e.slice(s+o,s+o+c);if(s+=c+o,s>e.length)throw Ws("Invalid address Uint8Array: "+mr(e,"base16"));t.push([i,l]);const u=Ps(i,l);if(n.push([i,u]),!0===a.path){r=u;break}}return{bytes:Uint8Array.from(e),string:zs(n),tuples:t,stringTuples:n,path:r}}function zs(e){const t=[];return e.map((e=>{const n=Ns(e[0]);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),qs(t.join("/"))}function Hs(e){return ie(e.map((e=>{const t=Ns(e[0]);let n=Uint8Array.from(re(t.code));return e.length>1&&null!=e[1]&&(n=ie([n,e[1]])),n})))}function Ks(e,t){if(e.size>0)return e.size/8;if(0===e.size)return 0;{const e=se(t instanceof Uint8Array?t:Uint8Array.from(t));return e+ee(e)}}function qs(e){return"/"+e.trim().split("/").filter((e=>e)).join("/")}function Ws(e){return new Error("Error parsing address: "+e)}const js=Symbol.for("nodejs.util.inspect.custom"),Gs=Symbol.for("@multiformats/js-multiaddr/multiaddr"),Ys=[Ns("dns").code,Ns("dns4").code,Ns("dns6").code,Ns("dnsaddr").code];class Qs extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}class Js{bytes;#t;#n;#r;#s;[Gs]=!0;constructor(e){let t;if(null==e&&(e=""),e instanceof Uint8Array)t=Vs(e);else if("string"==typeof e){if(e.length>0&&"/"!==e.charAt(0))throw new Error(`multiaddr "${e}" must start with a "/"`);t=function(e){const t=[],n=[];let r=null;const s=(e=qs(e)).split("/").slice(1);if(1===s.length&&""===s[0])return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=Ns(s[i]);if(0===o.size){t.push([o.code]),n.push([o.code]);continue}if(i++,i>=s.length)throw Ws("invalid address: "+e);if(!0===o.path){r=qs(s.slice(i).join("/")),t.push([o.code,Ls(o.code,r)]),n.push([o.code,r]);break}const a=Ls(o.code,s[i]);t.push([o.code,a]),n.push([o.code,Ps(o.code,a)])}return{string:zs(n),bytes:Hs(t),tuples:t,stringTuples:n,path:r}}(e)}else{if(!Zs(e))throw new Error("addr must be a string, Buffer, or another Multiaddr");t=Vs(e.bytes)}this.bytes=t.bytes,this.#t=t.string,this.#n=t.tuples,this.#r=t.stringTuples,this.#s=t.path}toString(){return this.#t}toJSON(){return this.toString()}toOptions(){let e,t,n,r,s="";const i=Ns("tcp"),o=Ns("udp"),a=Ns("ip4"),c=Ns("ip6"),l=Ns("dns6"),u=Ns("ip6zone");for(const[h,d]of this.stringTuples())h===u.code&&(s=`%${d??""}`),Ys.includes(h)&&(t=i.name,r=443,n=`${d??""}${s}`,e=h===l.code?6:4),h!==i.code&&h!==o.code||(t=Ns(h).name,r=parseInt(d??"")),h!==a.code&&h!==c.code||(t=Ns(h).name,n=`${d??""}${s}`,e=h===c.code?6:4);if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}protos(){return this.#n.map((([e])=>Object.assign({},Ns(e))))}protoCodes(){return this.#n.map((([e])=>e))}protoNames(){return this.#n.map((([e])=>Ns(e).name))}tuples(){return this.#n}stringTuples(){return this.#r}encapsulate(e){return e=new Js(e),new Js(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),r=n.lastIndexOf(t);if(r<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Js(n.slice(0,r))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Js(Hs(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach((([t,n])=>{t===Ds.p2p.code&&e.push([t,n]),t===Ds["p2p-circuit"].code&&(e=[])}));const t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?mr(Tt.decode(`z${e}`),"base58btc"):mr(Rn.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){return this.#s}equals(e){return oe(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find((e=>e.resolvable));if(null==t)return[this];const n=Xs.get(t.name);if(null==n)throw new Qs(`no available resolver for ${t.name}`);return(await n(this,e)).map((e=>ei(e)))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(2!==t.length||4!==t[0].code&&41!==t[0].code||6!==t[1].code&&273!==t[1].code)}[js](){return`Multiaddr(${this.#t})`}}const Xs=new Map;function Zs(e){return Boolean(e?.[Gs])}function ei(e){return new Js(e)}const ti=e=>({match:t=>!(t.length<1)&&!!e(t[0])&&t.slice(1),pattern:"fn"}),ni=e=>({match:t=>ti((t=>t===e)).match(t),pattern:e}),ri=()=>({match:e=>ti((e=>"string"==typeof e)).match(e),pattern:"{string}"}),si=()=>({match:e=>ti((e=>!isNaN(parseInt(e)))).match(e),pattern:"{number}"}),ii=()=>({match:e=>{if(e.length<2)return!1;if("p2p"!==e[0]&&"ipfs"!==e[0])return!1;if(!e[1].startsWith("Q")&&!e[1].startsWith("1"))return!1;try{Tt.decode(`z${e[1]}`)}catch(e){return!1}return e.slice(2)},pattern:"/p2p/{peerid}"}),oi=()=>({match:e=>{if(e.length<2)return!1;if("certhash"!==e[0])return!1;try{Nt.decode(e[1])}catch{return!1}return e.slice(2)},pattern:"/certhash/{certhash}"}),ai=e=>({match:t=>{const n=e.match(t);return!1===n?t:n},pattern:`optional(${e.pattern})`}),ci=(...e)=>({match:t=>{let n;for(const r of e){const e=r.match(t);!1!==e&&(null==n||e.length<n.length)&&(n=e)}return null!=n&&n},pattern:`or(${e.map((e=>e.pattern)).join(", ")})`}),li=(...e)=>({match:t=>{for(const n of e){const e=n.match(t);if(!1===e)return!1;t=e}return t},pattern:`and(${e.map((e=>e.pattern)).join(", ")})`});function ui(...e){function t(t){let n=(e=>e.toString().split("/").slice(1))(t);for(const t of e){const e=t.match(n);if(!1===e)return!1;n=e}return n}return{matches:function(e){return!1!==t(e)},exactMatch:function(e){const n=t(e);return!1!==n&&0===n.length}}}const hi=li(ni("dns4"),ri()),di=li(ni("dns6"),ri()),fi=li(ni("dnsaddr"),ri()),pi=li(ni("dns"),ri()),gi=(ui(hi),ui(di),ui(fi),ui(ci(pi,fi,hi,di))),yi=li(ni("ip4"),ti(ws)),mi=li(ni("ip6"),ti(bs)),wi=ci(yi,mi),bi=ci(wi,pi,hi,di,fi),Ei=ui(bi),vi=(ui(yi),ui(mi),ui(wi)),Si=li(bi,ni("tcp"),si()),_i=li(bi,ni("udp"),si()),Ri=(ui(Si),ui(_i),li(_i,ni("quic"))),ki=li(_i,ni("quic-v1")),Ai=ci(Ri,ki),Ii=(ui(Ri),ui(ki),ci(bi,Si,_i,Ri,ki)),Ti=ci(li(Ii,ni("ws"),ai(ii()))),xi=(ui(Ti),ci(li(Ii,ni("wss"),ai(ii())),li(Ii,ni("tls"),ni("ws"),ai(ii())))),Di=(ui(xi),li(_i,ni("webrtc-direct"),ai(oi()),ai(oi()),ai(ii()))),Ci=ui(Di),Ni=li(ki,ni("webtransport"),ai(oi()),ai(oi()),ai(ii())),Pi=ui(Ni),Li=ci(Ti,xi,li(Si,ai(ii())),li(Ai,ai(ii())),li(bi,ai(ii())),Di,Ni,ii()),Bi=(ui(Li),ui(li(Li,ni("p2p-circuit"),ii()))),Oi=ui(ci(li(Li,ni("p2p-circuit"),ni("webrtc"),ai(ii())),li(Li,ni("webrtc"),ai(ii())),ni("webrtc"))),Mi=ui(ci(li(bi,ni("tcp"),si(),ni("http"),ai(ii())),li(bi,ni("http"),ai(ii())))),Ui=ui(ci(li(bi,ni("tcp"),ci(li(ni("443"),ni("http")),li(si(),ni("https"))),ai(ii())),li(bi,ni("tls"),ni("http"),ai(ii())),li(bi,ni("https"),ai(ii())))),Fi=[Ns("tcp").code,Ns("dns").code,Ns("dnsaddr").code,Ns("dns4").code,Ns("dns6").code];function $i(e){let t;try{t=Ns("sni").code}catch(e){return null}for(const[n,r]of e)if(n===t&&void 0!==r)return r;return null}function Vi(e){return e.some((([e,t])=>e===Ns("tls").code))}function zi(e,t,n){const r=Hi[Ns(e).name];if(void 0===r)throw new Error(`Can't interpret protocol ${Ns(e).name}`);const s=r(t,n);return e===Ns("ip6").code?`[${s}]`:s}const Hi={ip4:(e,t)=>e,ip6:(e,t)=>0===t.length?e:`[${e}]`,tcp:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`tcp://${zi(n[0],n[1]??"",t)}:${e}`},udp:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`udp://${zi(n[0],n[1]??"",t)}:${e}`},dnsaddr:(e,t)=>e,dns4:(e,t)=>e,dns6:(e,t)=>e,dns:(e,t)=>e,ipfs:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`${zi(n[0],n[1]??"",t)}/ipfs/${e}`},p2p:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`${zi(n[0],n[1]??"",t)}/p2p/${e}`},http:(e,t)=>{const n=Vi(t),r=$i(t);if(n&&null!==r)return`https://${r}`;const s=n?"https://":"http://",i=t.pop();if(void 0===i)throw new Error("Unexpected end of multiaddr");let o=zi(i[0],i[1]??"",t);return o=o.replace("tcp://",""),`${s}${o}`},"http-path":(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`${zi(n[0],n[1]??"",t)}/${decodeURIComponent(e)}`},tls:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return zi(n[0],n[1]??"",t)},sni:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return zi(n[0],n[1]??"",t)},https:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");let r=zi(n[0],n[1]??"",t);return r=r.replace("tcp://",""),`https://${r}`},ws:(e,t)=>{const n=Vi(t),r=$i(t);if(n&&null!==r)return`wss://${r}`;const s=n?"wss://":"ws://",i=t.pop();if(void 0===i)throw new Error("Unexpected end of multiaddr");let o=zi(i[0],i[1]??"",t);return o=o.replace("tcp://",""),`${s}${o}`},wss:(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");let r=zi(n[0],n[1]??"",t);return r=r.replace("tcp://",""),`wss://${r}`},"p2p-websocket-star":(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`${zi(n[0],n[1]??"",t)}/p2p-websocket-star`},"p2p-webrtc-star":(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`${zi(n[0],n[1]??"",t)}/p2p-webrtc-star`},"p2p-webrtc-direct":(e,t)=>{const n=t.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");return`${zi(n[0],n[1]??"",t)}/p2p-webrtc-direct`}};function Ki(e,t){const n=ei(e).stringTuples(),r=n.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");const s=Ns(r[0]),i=Hi[s.name];if(null==i)throw new Error(`No interpreter found for ${s.name}`);let o=i(r[1]??"",n);return!1!==t?.assumeHttp&&Fi.includes(r[0])&&(o=o.replace(/^.*:\/\//,""),o="443"===r[1]?`https://${o}`:`http://${o}`),(o.startsWith("http://")||o.startsWith("https://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}class qi{url;#i=0;#o=0;#a=0;#c=0;#l=new Map;log;constructor(e,t){this.url=e instanceof URL?e:new URL(e),this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#u(e){const t=e.multihash.bytes;return Dt.encode(t)}async getRawBlock(e,t){const n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",!0===t?.aborted)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const r=this.#u(e),s=new AbortController,i=()=>{s.abort()};t?.addEventListener("abort",i);try{let t=this.#l.get(r);return null==t&&(this.#i++,t=fetch(n.toString(),{signal:s.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"}).then((async t=>{if(this.log("GET %s %d",n,t.status),!t.ok)throw this.#o++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#c++,new Uint8Array(await t.arrayBuffer())})),this.#l.set(r,t)),await t}catch(n){if(!0===t?.aborted)throw new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`);throw this.#o++,new Error(`unable to fetch raw block for CID ${e}`)}finally{t?.removeEventListener("abort",i),this.#l.delete(r)}}reliability(){return 0===this.#i?1:this.#a>0?-1/0:this.#c/(this.#i+3*this.#o)}incrementInvalidBlocks(){this.#a++}getStats(){return{attempts:this.#i,errors:this.#o,invalidBlocks:this.#a,successes:this.#c,pendingResponses:this.#l.size}}}function Wi(e,t,n){return e.filter((e=>{if(Ui.matches(e)||t&&Mi.matches(e))return!!n||!!gi.matches(e)||!1===Rs(e.toOptions().host);if(!t&&n){const{host:t}=e.toOptions();if("127.0.0.1"===t||"localhost"===t||t.endsWith(".localhost"))return!0}return!1}))}async function*ji(e,t,n,r,s,i){for await(const o of t.findProviders(e,i)){const e=Wi(o.multiaddrs,r,s);if(0===e.length)continue;const t=Ki(e[0]);yield new qi(t,n)}}class Gi extends is{routing;allowInsecure;allowLocal;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??Qi,this.allowLocal=t.allowLocal??Ji}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);const r=await t.getRawBlock(e,n.signal);return this.log.trace("got block for %c from %s",e,t.url),await(n.validateFn?.(r)),r}async*findNewProviders(e,t={}){yield*ji(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,t)}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}}class Yi{allowInsecure;allowLocal;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??Qi,this.allowLocal=t.allowLocal??Ji}async retrieve(e,t={}){const n=[];for await(const r of ji(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,t)){this.log("getting block for %c from %s",e,r.url);try{const n=await r.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,r.url);try{await(t.validateFn?.(n))}catch(t){this.log.error("failed to validate block for %c from %s",e,r.url,t);continue}return n}catch(s){if(this.log.error("failed to get block for %c from %s",e,r.url,s),s instanceof Error?n.push(s):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${r.url}`)),!0===t.signal?.aborted){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,r.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return t={logger:this.logger,routing:this.routing},n={...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure},new Gi(t,n);var t,n}}const Qi=!1,Ji=!1;function Xi(e={}){return t=>new Yi(t,e)}class Zi{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function eo(e){return new Zi(e)}const to="[a-fA-F\\d:]",no=e=>e&&e.includeBoundaries?`(?:(?<=\\s|^)(?=${to})|(?<=${to})(?=\\s|$))`:"",ro="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",so="[a-fA-F\\d]{1,4}",io=`\n(?:\n(?:${so}:){7}(?:${so}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:${so}:){6}(?:${ro}|:${so}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:${so}:){5}(?::${ro}|(?::${so}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:${so}:){4}(?:(?::${so}){0,1}:${ro}|(?::${so}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:${so}:){3}(?:(?::${so}){0,2}:${ro}|(?::${so}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:${so}:){2}(?:(?::${so}){0,3}:${ro}|(?::${so}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:${so}:){1}(?:(?::${so}){0,4}:${ro}|(?::${so}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::${so}){0,5}:${ro}|(?::${so}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),oo=new RegExp(`(?:^${ro}$)|(?:^${io}$)`),ao=new RegExp(`^${ro}$`),co=new RegExp(`^${io}$`),lo=e=>e&&e.exact?oo:new RegExp(`(?:${no(e)}${ro}${no(e)})|(?:${no(e)}${io}${no(e)})`,"g");lo.v4=e=>e&&e.exact?ao:new RegExp(`${no(e)}${ro}${no(e)}`,"g"),lo.v6=e=>e&&e.exact?co:new RegExp(`${no(e)}${io}${no(e)}`,"g");const uo=lo,{toString:ho}=Object.prototype,fo={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function po(e,t,{timeout:n}={}){try{return function(e){const t=(...t)=>e(...t);return Object.defineProperty(t,"name",{value:`functionTimeout(${e.name||"<anonymous>"})`,configurable:!0}),t}((()=>function(e,t={}){if(n=e,"[object RegExp]"!==ho.call(n))throw new TypeError("Expected a RegExp instance");var n;const r=Object.keys(fo).map((n=>("boolean"==typeof t[n]?t[n]:e[n])?fo[n]:"")).join(""),s=new RegExp(t.source||e.source,r);return s.lastIndex="number"==typeof t.lastIndex?t.lastIndex:e.lastIndex,s}(e).test(t)))()}catch(e){throw e}}const go=15,yo=45,mo={timeout:400};function wo(e){return!(e.length>yo)&&po(uo.v6({exact:!0}),e,mo)}const bo={http:"80",https:"443",ws:"80",wss:"443"},Eo=["http","https","ws","wss"];function vo(e,t){const n=(t=t??{}).defaultDnsType??"dns4",{scheme:r,hostname:s,port:i}=function(e){const[t]=e.split(":");Eo.includes(t)||(e="http"+e.substring(t.length));let{protocol:n,hostname:r,port:s}=new URL(e);if(null==s||""===s){const e=function(e){if(null!=e&&""!==e&&null!=bo[e])return bo[e]}(t);null!=e&&(s=e),null==e&&"http:"===n&&(s="80")}return{scheme:t,hostname:r,port:s}}(e);return ei("/"+[So(s,n),_o(i,r),Ro(r)].filter((e=>Boolean(e))).reduce(((e,t)=>e.concat(t)),[]).join("/"))}function So(e,t){if(null!=e&&""!==e){if(function(e){return!(e.length>go)&&po(uo.v4({exact:!0}),e,mo)}(e))return["ip4",e];if(wo(e))return["ip6",e];if("["===e[0]){const t=e.substring(1,e.length-1);if(wo(t))return["ip6",t]}return[t,e]}}function _o(e,t){if(null!=e&&""!==e)return"udp"===t?["udp",e]:["tcp",e]}function Ro(e){if(null==e.match(/^tcp$|^udp$/))return[e]}const ko=["https://trustless-gateway.link","https://4everland.io"],Ao=Symbol.for("nodejs.util.inspect.custom");class Io{type="url";multihash;privateKey;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=gn.digest(Ln(this.url))}[Ao](){return`PeerId(${this.url})`}[gr]=!0;toString(){return this.toCID().toString()}toCID(){return Rn.createV1(2336,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=mr(e)),e.toString()===this.toString())}}class To{gateways;constructor(e={}){this.gateways=(e.gateways??ko).map((e=>function(e){return e=e.toString(),{id:new Io(new URL(e)),multiaddrs:[vo(e)]}}(e)))}async*findProviders(e,t){yield*this.gateways.toSorted((()=>Math.random()>.5?1:-1)).map((e=>({...e,protocols:["transport-ipfs-gateway-http"]})))}}function xo(e={}){return new To(e)}var Do=n(310);function Co(e){return e=e??new Error("Open failed"),Do(e,"ERR_OPEN_FAILED")}function No(e){return e=e??new Error("Close failed"),Do(e,"ERR_CLOSE_FAILED")}function Po(e){return e=e??new Error("Put failed"),Do(e,"ERR_PUT_FAILED")}function Lo(e){return e=e??new Error("Get failed"),Do(e,"ERR_GET_FAILED")}function Bo(e){return e=e??new Error("Delete failed"),Do(e,"ERR_DELETE_FAILED")}function Oo(e){return e=e??new Error("Has failed"),Do(e,"ERR_HAS_FAILED")}function Mo(e){return e=e??new Error("Not Found"),Do(e,"ERR_NOT_FOUND")}function Uo(e){return e=e??new Error("Aborted"),Do(e,"ERR_ABORTED")}class Fo{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:n,block:r}of e)await this.put(n,r,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}}class $o extends Fo{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(mt.encode(e.multihash.bytes),t),e}get(e){const t=this.data.get(mt.encode(e.multihash.bytes));if(null==t)throw Mo();return t}has(e){return this.data.has(mt.encode(e.multihash.bytes))}async delete(e){this.data.delete(mt.encode(e.multihash.bytes))}async*getAll(){for(const[e,t]of this.data.entries())yield{cid:Rn.createV1(Ht,dn(mt.decode(e))),block:t}}}const Vo=1e3,zo=60*Vo,Ho=60*zo,Ko=24*Ho,qo=7*Ko,Wo=function(e,t){try{if("string"==typeof e&&e.length>0)return function(e){if((e=String(e)).length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return NaN;const n=parseFloat(t[1]),r=(t[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return n*qo;case"days":case"day":case"d":return n*Ko;case"hours":case"hour":case"hrs":case"hr":case"h":return n*Ho;case"minutes":case"minute":case"mins":case"min":case"m":return n*zo;case"seconds":case"second":case"secs":case"sec":case"s":return n*Vo;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:throw new Error(`The unit ${r} was matched, but no matching case exists.`)}}(e);if("number"==typeof e&&isFinite(e))return t?.long?function(e){const t=Math.abs(e);return t>=Ko?jo(e,t,Ko,"day"):t>=Ho?jo(e,t,Ho,"hour"):t>=zo?jo(e,t,zo,"minute"):t>=Vo?jo(e,t,Vo,"second"):`${e} ms`}(e):function(e){const t=Math.abs(e);return t>=Ko?`${Math.round(e/Ko)}d`:t>=Ho?`${Math.round(e/Ho)}h`:t>=zo?`${Math.round(e/zo)}m`:t>=Vo?`${Math.round(e/Vo)}s`:`${e}ms`}(e);throw new Error("Value is not a string or number.")}catch(t){const n=function(e){return"object"==typeof e&&null!==e&&"message"in e}(t)?`${t.message}. value=${JSON.stringify(e)}`:"An unknown error has occured.";throw new Error(n)}};function jo(e,t,n,r){const s=t>=1.5*n;return`${Math.round(e/n)} ${r}${s?"s":""}`}const Go=function(){try{return localStorage}catch(e){}}(),Yo=console.debug??console.log??(()=>{}),Qo=function(e){function t(e){let r,s,i,o=null;function a(...e){if(!a.enabled)return;const n=a,s=Number(new Date),i=s-(r||s);n.diff=i,n.prev=r,n.curr=s,r=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((r,s)=>{if("%%"===r)return"%";o++;const i=t.formatters[s];if("function"==typeof i){const t=e[o];r=i.call(n,t),e.splice(o,1),o--}return r})),t.formatArgs.call(n,e),(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(s!==t.namespaces&&(s=t.namespaces,i=t.enabled(e)),i),set:e=>{o=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,n){const r=t(this.namespace+(void 0===n?":":n)+e);return r.log=this.log,r}function r(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack??e.message:e},t.disable=function(){const e=[...t.names.map(r),...t.skips.map(r).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(n=0;n<s;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=Wo,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.setupFormatters(t.formatters),t.enable(t.load()),t}({formatArgs:function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+Wo(this.diff),!this.useColors)return;const t="color: "+this.color;e.splice(1,0,t,"color: inherit");let n=0,r=0;e[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(n++,"%c"===e&&(r=n))})),e.splice(r,0,t)},save:function(e){try{e?Go?.setItem("debug",e):Go?.removeItem("debug")}catch(e){}},load:function(){let e;try{e=Go?.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},useColors:function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||null==navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement?.style?.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&null!=navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/))},setupFormatters:function(e){e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},colors:["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],storage:Go,log:Yo}),Jo=Qo;function Xo(){return{forComponent:e=>Zo(e)}}function Zo(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}(`${e}:trace`);return Jo.enabled(`${e}:trace`)&&null!=Jo.names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=Jo(`${e}:trace`)),Object.assign(Jo(e),{error:Jo(`${e}:error`),trace:t})}Jo.formatters.b=e=>null==e?"undefined":Tt.baseEncode(e),Jo.formatters.t=e=>null==e?"undefined":mt.baseEncode(e),Jo.formatters.m=e=>null==e?"undefined":Dt.baseEncode(e),Jo.formatters.p=e=>null==e?"undefined":e.toString(),Jo.formatters.c=e=>null==e?"undefined":e.toString(),Jo.formatters.k=e=>null==e?"undefined":e.toString(),Jo.formatters.a=e=>null==e?"undefined":e.toString();const ea=function(e,t){let n=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e)await t(r,n++)&&(yield r)}();const r=ve(e),{value:s,done:i}=r.next();if(!0===i)return function*(){}();const o=t(s,n++);if("function"==typeof o.then)return async function*(){await o&&(yield s);for await(const e of r)await t(e,n++)&&(yield e)}();const a=t;return function*(){!0===o&&(yield s);for(const e of r)a(e,n++)&&(yield e)}()};Zo("blockstore:core:tiered");const ta={...g};const na="/",ra=(new TextEncoder).encode(na),sa=ra[0];class ia{_buf;constructor(e,t){if("string"==typeof e)this._buf=Ln(e);else{if(!(e instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==sa)throw new Error("Invalid key")}toString(e="utf8"){return mr(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new ia(e.join(na))}static random(){return new ia(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||"string"==typeof e?new ia(e):"function"==typeof e.uint8Array?new ia(e.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=ra),this._buf[0]!==sa){const e=new Uint8Array(this._buf.byteLength+1);e.fill(sa,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===sa;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let e=0;e<t.length;e++){if(n.length<e+1)return!1;const r=t[e],s=n[e];if(r<s)return!0;if(r>s)return!1}return t.length<n.length}reverse(){return ia.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(na).slice(1)}type(){return function(e){const t=e.split(":");return t.length<2?"":t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){const t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(e){return new ia(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(na)||(e+=na),e+=this.type(),new ia(e)}parent(){const e=this.list();return 1===e.length?new ia(na):new ia(e.slice(0,-1).join(na))}child(e){return this.toString()===na?e:e.toString()===na?this:new ia(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(...e){return ia.withNamespaces([...this.namespaces(),...(t=e.map((e=>e.namespaces())),[].concat(...t))]);var t}}const oa=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{const t=[];for await(const n of e)t.push(n);return t})();const t=[];for(const n of e)t.push(n);return t},aa=function(e,t){return null!=e[Symbol.asyncIterator]?async function*(){const n=await oa(e);yield*n.sort(t)}():function*(){const n=oa(e);yield*n.sort(t)}()};class ca{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:r}of e)await this.put(n,r,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(t,n){e.push({key:t,value:n})},delete(e){t.push(e)},commit:async n=>{await z(this.putMany(e,n)),e=[],await z(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(null!=e.prefix){const t=e.prefix;n=ea(n,(e=>e.key.toString().startsWith(t)))}if(Array.isArray(e.filters)&&(n=e.filters.reduce(((e,t)=>ea(e,t)),n)),Array.isArray(e.orders)&&(n=e.orders.reduce(((e,t)=>aa(e,t)),n)),null!=e.offset){let t=0;const r=e.offset;n=ea(n,(()=>t++>=r))}return null!=e.limit&&(n=De(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(null!=e.prefix){const t=e.prefix;n=ea(n,(e=>e.toString().startsWith(t)))}if(Array.isArray(e.filters)&&(n=e.filters.reduce(((e,t)=>ea(e,t)),n)),Array.isArray(e.orders)&&(n=e.orders.reduce(((e,t)=>aa(e,t)),n)),null!=e.offset){const t=e.offset;let r=0;n=ea(n,(()=>r++>=t))}return null!=e.limit&&(n=De(n,e.limit)),n}}class la extends ca{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){const t=this.data.get(e.toString());if(null==t)throw n=n??new Error("Not Found"),Do(n,"ERR_NOT_FOUND");var n;return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,t]of this.data.entries())yield{key:new ia(e),value:t}}*_allKeys(){for(const e of this.data.keys())yield new ia(e)}}new ia("SHARDING"),Zo("datastore:core:tiered");const ua=Symbol.for("@libp2p/content-routing"),ha=Symbol.for("@libp2p/peer-routing");function da(e){return null!=e&&"function"==typeof e.start&&"function"==typeof e.stop}async function fa(...e){const t=[];for(const n of e)da(n)&&t.push(n);await Promise.all(t.map((async e=>{null!=e.beforeStart&&await e.beforeStart()}))),await Promise.all(t.map((async e=>{await e.start()}))),await Promise.all(t.map((async e=>{null!=e.afterStart&&await e.afterStart()})))}async function pa(...e){const t=[];for(const n of e)da(n)&&t.push(n);await Promise.all(t.map((async e=>{null!=e.beforeStop&&await e.beforeStop()}))),await Promise.all(t.map((async e=>{await e.stop()}))),await Promise.all(t.map((async e=>{null!=e.afterStop&&await e.afterStop()})))}var ga=n(228);class ya extends Error{constructor(e){super(e),this.name="TimeoutError"}}class ma extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const wa=e=>void 0===globalThis.DOMException?new ma(e):new DOMException(e),ba=e=>{const t=void 0===e.reason?wa("This operation was aborted."):e.reason;return t instanceof Error?t:wa(t)};function Ea(e,t){const{milliseconds:n,fallback:r,message:s,customTimers:i={setTimeout,clearTimeout}}=t;let o;const a=new Promise(((a,c)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(t.signal){const{signal:e}=t;e.aborted&&c(ba(e)),e.addEventListener("abort",(()=>{c(ba(e))}))}if(n===Number.POSITIVE_INFINITY)return void e.then(a,c);const l=new ya;o=i.setTimeout.call(void 0,(()=>{if(r)try{a(r())}catch(e){c(e)}else"function"==typeof e.cancel&&e.cancel(),!1===s?a():s instanceof Error?c(s):(l.message=s??`Promise timed out after ${n} milliseconds`,c(l))}),n),(async()=>{try{a(await e)}catch(e){c(e)}})()})).finally((()=>{a.clear()}));return a.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},a}class va{#h=[];enqueue(e,t){const n={priority:(t={priority:0,...t}).priority,run:e};if(this.size&&this.#h[this.size-1].priority>=t.priority)return void this.#h.push(n);const r=function(e,t){let n=0,r=e.length;for(;r>0;){const i=Math.trunc(r/2);let o=n+i;s=e[o],t.priority-s.priority<=0?(n=++o,r-=i+1):r=i}var s;return n}(this.#h,n);this.#h.splice(r,0,n)}dequeue(){const e=this.#h.shift();return e?.run}filter(e){return this.#h.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this.#h.length}}class Sa extends ga{#d;#f;#p=0;#g;#y;#m=0;#w;#b;#h;#E;#v=0;#S;#_;#R;timeout;constructor(e){if(super(),!("number"==typeof(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:va,...e}).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#d=e.carryoverConcurrencyCount,this.#f=e.intervalCap===Number.POSITIVE_INFINITY||0===e.interval,this.#g=e.intervalCap,this.#y=e.interval,this.#h=new e.queueClass,this.#E=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#R=!0===e.throwOnTimeout,this.#_=!1===e.autoStart}get#k(){return this.#f||this.#p<this.#g}get#A(){return this.#v<this.#S}#I(){this.#v--,this.#T(),this.emit("next")}#x(){this.#D(),this.#C(),this.#b=void 0}get#N(){const e=Date.now();if(void 0===this.#w){const t=this.#m-e;if(!(t<0))return void 0===this.#b&&(this.#b=setTimeout((()=>{this.#x()}),t)),!0;this.#p=this.#d?this.#v:0}return!1}#T(){if(0===this.#h.size)return this.#w&&clearInterval(this.#w),this.#w=void 0,this.emit("empty"),0===this.#v&&this.emit("idle"),!1;if(!this.#_){const e=!this.#N;if(this.#k&&this.#A){const t=this.#h.dequeue();return!!t&&(this.emit("active"),t(),e&&this.#C(),!0)}}return!1}#C(){this.#f||void 0!==this.#w||(this.#w=setInterval((()=>{this.#D()}),this.#y),this.#m=Date.now()+this.#y)}#D(){0===this.#p&&0===this.#v&&this.#w&&(clearInterval(this.#w),this.#w=void 0),this.#p=this.#d?this.#v:0,this.#P()}#P(){for(;this.#T(););}get concurrency(){return this.#S}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#S=e,this.#P()}async#L(e){return new Promise(((t,n)=>{e.addEventListener("abort",(()=>{n(e.reason)}),{once:!0})}))}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:this.#R,...t},new Promise(((n,r)=>{this.#h.enqueue((async()=>{this.#v++,this.#p++;try{t.signal?.throwIfAborted();let r=e({signal:t.signal});t.timeout&&(r=Ea(Promise.resolve(r),{milliseconds:t.timeout})),t.signal&&(r=Promise.race([r,this.#L(t.signal)]));const s=await r;n(s),this.emit("completed",s)}catch(e){if(e instanceof ya&&!t.throwOnTimeout)return void n();r(e),this.emit("error",e)}finally{this.#I()}}),t),this.emit("add"),this.#T()}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this.#_?(this.#_=!1,this.#P(),this):this}pause(){this.#_=!0}clear(){this.#h=new this.#E}async onEmpty(){0!==this.#h.size&&await this.#B("empty")}async onSizeLessThan(e){this.#h.size<e||await this.#B("next",(()=>this.#h.size<e))}async onIdle(){0===this.#v&&0===this.#h.size||await this.#B("idle")}async#B(e,t){return new Promise((n=>{const r=()=>{t&&!t()||(this.off(e,r),n())};this.on(e,r)}))}get size(){return this.#h.size}sizeBy(e){return this.#h.filter(e).length}get pending(){return this.#v}get isPaused(){return this.#_}}function _a(e){const t=[Ia.A];return null==e?t:Array.isArray(e)?0===e.length?t:e:[e]}const Ra=60;function ka(e){return{Status:e.Status??0,TC:e.TC??e.flag_tc??!1,RD:e.RD??e.flag_rd??!1,RA:e.RA??e.flag_ra??!1,AD:e.AD??e.flag_ad??!1,CD:e.CD??e.flag_cd??!1,Question:(e.Question??e.questions??[]).map((e=>({name:e.name,type:Ia[e.type]}))),Answer:(e.Answer??e.answers??[]).map((e=>({name:e.name,type:Ia[e.type],TTL:e.TTL??e.ttl??Ra,data:e.data instanceof Uint8Array?mr(e.data):e.data})))}}function Aa(e,t={}){const n=new Sa({concurrency:t.queryConcurrency??4});return async(t,r={})=>{const s=new URLSearchParams;s.set("name",t),_a(r.types).forEach((e=>{s.append("type",Ia[e])})),r.onProgress?.(new Ce("dns:query",{detail:t}));const i=await n.add((async()=>{const t=await fetch(`${e}?${s}`,{headers:{accept:"application/dns-json"},signal:r?.signal});if(200!==t.status)throw new Error(`Unexpected HTTP status: ${t.status} - ${t.statusText}`);const n=ka(await t.json());return r.onProgress?.(new Ce("dns:response",{detail:n})),n}),{signal:r.signal});if(null==i)throw new Error("No DNS response received");return i}}var Ia,Ta=n(194);class xa{lru;constructor(e){this.lru=Ta(e)}get(e,t){let n=!0;const r=[];for(const s of t){const t=this.getAnswers(e,s);if(0===t.length){n=!1;break}r.push(...t)}if(n)return ka({answers:r})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,r=this.lru.get(n);if(null!=r){const e=r.filter((e=>e.expires>Date.now())).map((({expires:e,value:t})=>({...t,TTL:Math.round((e-Date.now())/1e3),type:Ia[t.type]})));return 0===e.length&&this.lru.remove(n),e}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,r=this.lru.get(n)??[];r.push({expires:Date.now()+1e3*(t.TTL??Ra),value:t}),this.lru.set(n,r)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}class Da{resolvers;cache;constructor(e){var t;this.resolvers={},this.cache=(t=e.cacheSize??1e3,new xa(t)),Object.entries(e.resolvers??{}).forEach((([e,t])=>{Array.isArray(t)||(t=[t]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=t})),null==this.resolvers["."]&&(this.resolvers["."]=[Aa("https://cloudflare-dns.com/dns-query"),Aa("https://dns.google/resolve")])}async query(e,t={}){const n=_a(t.types),r=!1!==t.cached?this.cache.get(e,n):void 0;if(null!=r)return t.onProgress?.(new Ce("dns:cache",{detail:r})),r;const s=`${e.split(".").pop()}.`,i=(this.resolvers[s]??this.resolvers["."]).sort((()=>Math.random()>.5?-1:1)),o=[];for(const r of i){if(!0===t.signal?.aborted)break;try{const s=await r(e,{...t,types:n});for(const t of s.Answer)this.cache.add(e,t);return s}catch(e){o.push(e),t.onProgress?.(new Ce("dns:error",{detail:e}))}}if(1===o.length)throw o[0];throw new AggregateError(o,`DNS lookup of ${e} ${n} failed`)}}function Ca(e={}){return new Da(e)}!function(e){e[e.A=1]="A",e[e.CNAME=5]="CNAME",e[e.TXT=16]="TXT",e[e.AAAA=28]="AAAA"}(Ia||(Ia={}));const Na=["string","number","bigint","symbol"],Pa=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];class La{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}La.uint=new La(0,"uint",!0),La.negint=new La(1,"negint",!0),La.bytes=new La(2,"bytes",!0),La.string=new La(3,"string",!0),La.array=new La(4,"array",!1),La.map=new La(5,"map",!1),La.tag=new La(6,"tag",!1),La.float=new La(7,"float",!0),La.false=new La(7,"false",!0),La.true=new La(7,"true",!0),La.null=new La(7,"null",!0),La.undefined=new La(7,"undefined",!0),La.break=new La(7,"break",!0);class Ba{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const Oa=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.isBuffer,Ma=new TextDecoder,Ua=new TextEncoder;function Fa(e){return Oa&&globalThis.Buffer.isBuffer(e)}function $a(e){return e instanceof Uint8Array?Fa(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e:Uint8Array.from(e)}const Va=Oa?(e,t,n)=>n-t>64?globalThis.Buffer.from(e.subarray(t,n)).toString("utf8"):Ga(e,t,n):(e,t,n)=>n-t>64?Ma.decode(e.subarray(t,n)):Ga(e,t,n),za=Oa?e=>e.length>64?globalThis.Buffer.from(e):ja(e):e=>e.length>64?Ua.encode(e):ja(e),Ha=e=>Uint8Array.from(e),Ka=Oa?(e,t,n)=>Fa(e)?new Uint8Array(e.subarray(t,n)):e.slice(t,n):(e,t,n)=>e.slice(t,n),qa=Oa?(e,t)=>(e=e.map((e=>e instanceof Uint8Array?e:globalThis.Buffer.from(e))),$a(globalThis.Buffer.concat(e,t))):(e,t)=>{const n=new Uint8Array(t);let r=0;for(let t of e)r+t.length>n.length&&(t=t.subarray(0,n.length-r)),n.set(t,r),r+=t.length;return n},Wa=Oa?e=>globalThis.Buffer.allocUnsafe(e):e=>new Uint8Array(e);function ja(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let s=e.charCodeAt(r);s<128?t[n++]=s:s<2048?(t[n++]=s>>6|192,t[n++]=63&s|128):55296==(64512&s)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(s=65536+((1023&s)<<10)+(1023&e.charCodeAt(++r)),t[n++]=s>>18|240,t[n++]=s>>12&63|128,t[n++]=s>>6&63|128,t[n++]=63&s|128):(t[n++]=s>>12|224,t[n++]=s>>6&63|128,t[n++]=63&s|128)}return t}function Ga(e,t,n){const r=[];for(;t<n;){const s=e[t];let i=null,o=s>239?4:s>223?3:s>191?2:1;if(t+o<=n){let n,r,a,c;switch(o){case 1:s<128&&(i=s);break;case 2:n=e[t+1],128==(192&n)&&(c=(31&s)<<6|63&n,c>127&&(i=c));break;case 3:n=e[t+1],r=e[t+2],128==(192&n)&&128==(192&r)&&(c=(15&s)<<12|(63&n)<<6|63&r,c>2047&&(c<55296||c>57343)&&(i=c));break;case 4:n=e[t+1],r=e[t+2],a=e[t+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&(c=(15&s)<<18|(63&n)<<12|(63&r)<<6|63&a,c>65535&&c<1114112&&(i=c))}}null===i?(i=65533,o=1):i>65535&&(i-=65536,r.push(i>>>10&1023|55296),i=56320|1023&i),r.push(i),t+=o}return Qa(r)}const Ya=4096;function Qa(e){const t=e.length;if(t<=Ya)return String.fromCharCode.apply(String,e);let n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=Ya));return n}class Ja{constructor(e=256){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),null!==this._initReuseChunk&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const n=t.length-(this.maxCursor-this.cursor)-1;t.set(e,n)}else{if(t){const e=t.length-(this.maxCursor-this.cursor)-1;e<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,e),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=Wa(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,null===this._initReuseChunk&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(1===this.chunks.length){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=Ka(n,0,this.cursor)}else t=qa(this.chunks,this.cursor);return e&&this.reset(),t}}const Xa="CBOR decode error:",Za="CBOR encode error:",ec=[];function tc(e,t,n){if(e.length-t<n)throw new Error(`${Xa} not enough data for type`)}ec[23]=1,ec[24]=2,ec[25]=3,ec[26]=5,ec[27]=9;const nc=[24,256,65536,4294967296,BigInt("18446744073709551616")];function rc(e,t,n){tc(e,t,1);const r=e[t];if(!0===n.strict&&r<nc[0])throw new Error(`${Xa} integer encoded in more bytes than necessary (strict decode)`);return r}function sc(e,t,n){tc(e,t,2);const r=e[t]<<8|e[t+1];if(!0===n.strict&&r<nc[1])throw new Error(`${Xa} integer encoded in more bytes than necessary (strict decode)`);return r}function ic(e,t,n){tc(e,t,4);const r=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];if(!0===n.strict&&r<nc[2])throw new Error(`${Xa} integer encoded in more bytes than necessary (strict decode)`);return r}function oc(e,t,n){tc(e,t,8);const r=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3],s=16777216*e[t+4]+(e[t+5]<<16)+(e[t+6]<<8)+e[t+7],i=(BigInt(r)<<BigInt(32))+BigInt(s);if(!0===n.strict&&i<nc[3])throw new Error(`${Xa} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(!0===n.allowBigInt)return i;throw new Error(`${Xa} integers outside of the safe integer range are not supported`)}function ac(e,t){return cc(e,0,t.value)}function cc(e,t,n){if(n<nc[0]){const r=Number(n);e.push([t|r])}else if(n<nc[1]){const r=Number(n);e.push([24|t,r])}else if(n<nc[2]){const r=Number(n);e.push([25|t,r>>>8,255&r])}else if(n<nc[3]){const r=Number(n);e.push([26|t,r>>>24&255,r>>>16&255,r>>>8&255,255&r])}else{const r=BigInt(n);if(!(r<nc[4]))throw new Error(`${Xa} encountered BigInt larger than allowable range`);{const n=[27|t,0,0,0,0,0,0,0];let s=Number(r&BigInt(4294967295)),i=Number(r>>BigInt(32)&BigInt(4294967295));n[8]=255&s,s>>=8,n[7]=255&s,s>>=8,n[6]=255&s,s>>=8,n[5]=255&s,n[4]=255&i,i>>=8,n[3]=255&i,i>>=8,n[2]=255&i,i>>=8,n[1]=255&i,e.push(n)}}}ac.encodedSize=function(e){return cc.encodedSize(e.value)},cc.encodedSize=function(e){return e<nc[0]?1:e<nc[1]?2:e<nc[2]?3:e<nc[3]?5:9},ac.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};const lc=BigInt(-1),uc=BigInt(1);function hc(e,t){const n=t.value,r="bigint"==typeof n?n*lc-uc:-1*n-1;cc(e,t.type.majorEncoded,r)}function dc(e,t,n,r){tc(e,t,n+r);const s=Ka(e,t+n,t+n+r);return new Ba(La.bytes,s,n+r)}function fc(e,t,n,r){return dc(e,t,1,n)}function pc(e){return void 0===e.encodedBytes&&(e.encodedBytes=e.type===La.string?za(e.value):e.value),e.encodedBytes}function gc(e,t){const n=pc(t);cc(e,t.type.majorEncoded,n.length),e.push(n)}function yc(e,t,n,r,s){const i=n+r;tc(e,t,i);const o=new Ba(La.string,Va(e,t+n,t+i),i);return!0===s.retainStringBytes&&(o.byteValue=Ka(e,t+n,t+i)),o}function mc(e,t,n,r){return yc(e,t,1,n,r)}hc.encodedSize=function(e){const t=e.value,n="bigint"==typeof t?t*lc-uc:-1*t-1;return n<nc[0]?1:n<nc[1]?2:n<nc[2]?3:n<nc[3]?5:9},hc.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0},gc.encodedSize=function(e){const t=pc(e);return cc.encodedSize(t.length)+t.length},gc.compareTokens=function(e,t){return n=pc(e),r=pc(t),n.length<r.length?-1:n.length>r.length?1:function(e,t){if(Fa(e)&&Fa(t))return e.compare(t);for(let n=0;n<e.length;n++)if(e[n]!==t[n])return e[n]<t[n]?-1:1;return 0}(n,r);var n,r};const wc=gc;function bc(e,t,n,r){return new Ba(La.array,r,n)}function Ec(e,t,n,r){return bc(0,0,1,n)}function vc(e,t){cc(e,La.array.majorEncoded,t.value)}function Sc(e,t,n,r){return new Ba(La.map,r,n)}function _c(e,t,n,r){return Sc(0,0,1,n)}function Rc(e,t){cc(e,La.map.majorEncoded,t.value)}function kc(e,t,n,r){return new Ba(La.tag,n,1)}function Ac(e,t){cc(e,La.tag.majorEncoded,t.value)}vc.compareTokens=ac.compareTokens,vc.encodedSize=function(e){return cc.encodedSize(e.value)},Rc.compareTokens=ac.compareTokens,Rc.encodedSize=function(e){return cc.encodedSize(e.value)},Ac.compareTokens=ac.compareTokens,Ac.encodedSize=function(e){return cc.encodedSize(e.value)};function Ic(e,t,n){if(n){if(!1===n.allowNaN&&Number.isNaN(e))throw new Error(`${Xa} NaN values are not supported`);if(!1===n.allowInfinity&&(e===1/0||e===-1/0))throw new Error(`${Xa} Infinity values are not supported`)}return new Ba(La.float,e,t)}function Tc(e,t,n){const r=t.value;if(!1===r)e.push([20|La.float.majorEncoded]);else if(!0===r)e.push([21|La.float.majorEncoded]);else if(null===r)e.push([22|La.float.majorEncoded]);else if(void 0===r)e.push([23|La.float.majorEncoded]);else{let t,i=!1;n&&!0===n.float64||(Nc(r),t=Pc(Cc,1),r===t||Number.isNaN(r)?(Cc[0]=249,e.push(Cc.slice(0,3)),i=!0):(Lc(r),t=Bc(Cc,1),r===t&&(Cc[0]=250,e.push(Cc.slice(0,5)),i=!0))),i||(s=r,Dc.setFloat64(0,s,!1),t=Oc(Cc,1),Cc[0]=251,e.push(Cc.slice(0,9)))}var s}Tc.encodedSize=function(e,t){const n=e.value;if(!1===n||!0===n||null==n)return 1;if(!t||!0!==t.float64){Nc(n);let e=Pc(Cc,1);if(n===e||Number.isNaN(n))return 3;if(Lc(n),e=Bc(Cc,1),n===e)return 5}return 9};const xc=new ArrayBuffer(9),Dc=new DataView(xc,1),Cc=new Uint8Array(xc,0);function Nc(e){if(e===1/0)Dc.setUint16(0,31744,!1);else if(e===-1/0)Dc.setUint16(0,64512,!1);else if(Number.isNaN(e))Dc.setUint16(0,32256,!1);else{Dc.setFloat32(0,e);const t=Dc.getUint32(0),n=(2139095040&t)>>23,r=8388607&t;if(255===n)Dc.setUint16(0,31744,!1);else if(0===n)Dc.setUint16(0,(2147483648&e)>>16|r>>13,!1);else{const e=n-127;e<-24?Dc.setUint16(0,0):e<-14?Dc.setUint16(0,(2147483648&t)>>16|1<<24+e,!1):Dc.setUint16(0,(2147483648&t)>>16|e+15<<10|r>>13,!1)}}}function Pc(e,t){if(e.length-t<2)throw new Error(`${Xa} not enough data for float16`);const n=(e[t]<<8)+e[t+1];if(31744===n)return 1/0;if(64512===n)return-1/0;if(32256===n)return NaN;const r=n>>10&31,s=1023&n;let i;return i=0===r?s*2**-24:31!==r?(s+1024)*2**(r-25):0===s?1/0:NaN,32768&n?-i:i}function Lc(e){Dc.setFloat32(0,e,!1)}function Bc(e,t){if(e.length-t<4)throw new Error(`${Xa} not enough data for float32`);const n=(e.byteOffset||0)+t;return new DataView(e.buffer,n,4).getFloat32(0,!1)}function Oc(e,t){if(e.length-t<8)throw new Error(`${Xa} not enough data for float64`);const n=(e.byteOffset||0)+t;return new DataView(e.buffer,n,8).getFloat64(0,!1)}function Mc(e,t,n){throw new Error(`${Xa} encountered invalid minor (${n}) for major ${e[t]>>>5}`)}function Uc(e){return()=>{throw new Error(`${Xa} ${e}`)}}Tc.compareTokens=ac.compareTokens;const Fc=[];for(let e=0;e<=23;e++)Fc[e]=Mc;Fc[24]=function(e,t,n,r){return new Ba(La.uint,rc(e,t+1,r),2)},Fc[25]=function(e,t,n,r){return new Ba(La.uint,sc(e,t+1,r),3)},Fc[26]=function(e,t,n,r){return new Ba(La.uint,ic(e,t+1,r),5)},Fc[27]=function(e,t,n,r){return new Ba(La.uint,oc(e,t+1,r),9)},Fc[28]=Mc,Fc[29]=Mc,Fc[30]=Mc,Fc[31]=Mc;for(let e=32;e<=55;e++)Fc[e]=Mc;Fc[56]=function(e,t,n,r){return new Ba(La.negint,-1-rc(e,t+1,r),2)},Fc[57]=function(e,t,n,r){return new Ba(La.negint,-1-sc(e,t+1,r),3)},Fc[58]=function(e,t,n,r){return new Ba(La.negint,-1-ic(e,t+1,r),5)},Fc[59]=function(e,t,n,r){const s=oc(e,t+1,r);if("bigint"!=typeof s){const e=-1-s;if(e>=Number.MIN_SAFE_INTEGER)return new Ba(La.negint,e,9)}if(!0!==r.allowBigInt)throw new Error(`${Xa} integers outside of the safe integer range are not supported`);return new Ba(La.negint,lc-BigInt(s),9)},Fc[60]=Mc,Fc[61]=Mc,Fc[62]=Mc,Fc[63]=Mc;for(let e=64;e<=87;e++)Fc[e]=fc;Fc[88]=function(e,t,n,r){return dc(e,t,2,rc(e,t+1,r))},Fc[89]=function(e,t,n,r){return dc(e,t,3,sc(e,t+1,r))},Fc[90]=function(e,t,n,r){return dc(e,t,5,ic(e,t+1,r))},Fc[91]=function(e,t,n,r){const s=oc(e,t+1,r);if("bigint"==typeof s)throw new Error(`${Xa} 64-bit integer bytes lengths not supported`);return dc(e,t,9,s)},Fc[92]=Mc,Fc[93]=Mc,Fc[94]=Mc,Fc[95]=Uc("indefinite length bytes/strings are not supported");for(let e=96;e<=119;e++)Fc[e]=mc;Fc[120]=function(e,t,n,r){return yc(e,t,2,rc(e,t+1,r),r)},Fc[121]=function(e,t,n,r){return yc(e,t,3,sc(e,t+1,r),r)},Fc[122]=function(e,t,n,r){return yc(e,t,5,ic(e,t+1,r),r)},Fc[123]=function(e,t,n,r){const s=oc(e,t+1,r);if("bigint"==typeof s)throw new Error(`${Xa} 64-bit integer string lengths not supported`);return yc(e,t,9,s,r)},Fc[124]=Mc,Fc[125]=Mc,Fc[126]=Mc,Fc[127]=Uc("indefinite length bytes/strings are not supported");for(let e=128;e<=151;e++)Fc[e]=Ec;Fc[152]=function(e,t,n,r){return bc(0,0,2,rc(e,t+1,r))},Fc[153]=function(e,t,n,r){return bc(0,0,3,sc(e,t+1,r))},Fc[154]=function(e,t,n,r){return bc(0,0,5,ic(e,t+1,r))},Fc[155]=function(e,t,n,r){const s=oc(e,t+1,r);if("bigint"==typeof s)throw new Error(`${Xa} 64-bit integer array lengths not supported`);return bc(0,0,9,s)},Fc[156]=Mc,Fc[157]=Mc,Fc[158]=Mc,Fc[159]=function(e,t,n,r){if(!1===r.allowIndefinite)throw new Error(`${Xa} indefinite length items not allowed`);return bc(0,0,1,1/0)};for(let e=160;e<=183;e++)Fc[e]=_c;Fc[184]=function(e,t,n,r){return Sc(0,0,2,rc(e,t+1,r))},Fc[185]=function(e,t,n,r){return Sc(0,0,3,sc(e,t+1,r))},Fc[186]=function(e,t,n,r){return Sc(0,0,5,ic(e,t+1,r))},Fc[187]=function(e,t,n,r){const s=oc(e,t+1,r);if("bigint"==typeof s)throw new Error(`${Xa} 64-bit integer map lengths not supported`);return Sc(0,0,9,s)},Fc[188]=Mc,Fc[189]=Mc,Fc[190]=Mc,Fc[191]=function(e,t,n,r){if(!1===r.allowIndefinite)throw new Error(`${Xa} indefinite length items not allowed`);return Sc(0,0,1,1/0)};for(let e=192;e<=215;e++)Fc[e]=kc;Fc[216]=function(e,t,n,r){return new Ba(La.tag,rc(e,t+1,r),2)},Fc[217]=function(e,t,n,r){return new Ba(La.tag,sc(e,t+1,r),3)},Fc[218]=function(e,t,n,r){return new Ba(La.tag,ic(e,t+1,r),5)},Fc[219]=function(e,t,n,r){return new Ba(La.tag,oc(e,t+1,r),9)},Fc[220]=Mc,Fc[221]=Mc,Fc[222]=Mc,Fc[223]=Mc;for(let e=224;e<=243;e++)Fc[e]=Uc("simple values are not supported");Fc[244]=Mc,Fc[245]=Mc,Fc[246]=Mc,Fc[247]=function(e,t,n,r){if(!1===r.allowUndefined)throw new Error(`${Xa} undefined values are not supported`);return!0===r.coerceUndefinedToNull?new Ba(La.null,null,1):new Ba(La.undefined,void 0,1)},Fc[248]=Uc("simple values are not supported"),Fc[249]=function(e,t,n,r){return Ic(Pc(e,t+1),3,r)},Fc[250]=function(e,t,n,r){return Ic(Bc(e,t+1),5,r)},Fc[251]=function(e,t,n,r){return Ic(Oc(e,t+1),9,r)},Fc[252]=Mc,Fc[253]=Mc,Fc[254]=Mc,Fc[255]=function(e,t,n,r){if(!1===r.allowIndefinite)throw new Error(`${Xa} indefinite length items not allowed`);return new Ba(La.break,void 0,1)};const $c=[];for(let e=0;e<24;e++)$c[e]=new Ba(La.uint,e,1);for(let e=-1;e>=-24;e--)$c[31-e]=new Ba(La.negint,e,1);$c[64]=new Ba(La.bytes,new Uint8Array(0),1),$c[96]=new Ba(La.string,"",1),$c[128]=new Ba(La.array,0,1),$c[160]=new Ba(La.map,0,1),$c[244]=new Ba(La.false,!1,1),$c[245]=new Ba(La.true,!0,1),$c[246]=new Ba(La.null,null,1);const Vc={float64:!1,mapSorter:function(e,t){const n=Array.isArray(e[0])?e[0][0]:e[0],r=Array.isArray(t[0])?t[0][0]:t[0];if(n.type!==r.type)return n.type.compare(r.type);const s=n.type.major,i=zc[s].compareTokens(n,r);return 0===i&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i},quickEncodeToken:function(e){switch(e.type){case La.false:return Ha([244]);case La.true:return Ha([245]);case La.null:return Ha([246]);case La.bytes:return e.value.length?void 0:Ha([64]);case La.string:return""===e.value?Ha([96]):void 0;case La.array:return 0===e.value?Ha([128]):void 0;case La.map:return 0===e.value?Ha([160]):void 0;case La.uint:return e.value<24?Ha([Number(e.value)]):void 0;case La.negint:if(e.value>=-24)return Ha([31-Number(e.value)])}}},zc=function(){const e=[];return e[La.uint.major]=ac,e[La.negint.major]=hc,e[La.bytes.major]=gc,e[La.string.major]=wc,e[La.array.major]=vc,e[La.map.major]=Rc,e[La.tag.major]=Ac,e[La.float.major]=Tc,e}(),Hc=new Ja;class Kc{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do{if(t.obj===e)return!0}while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Za} object contains circular references`);return new Kc(t,e)}}const qc={null:new Ba(La.null,null),undefined:new Ba(La.undefined,void 0),true:new Ba(La.true,!0),false:new Ba(La.false,!1),emptyArray:new Ba(La.array,0),emptyMap:new Ba(La.map,0)},Wc={number:(e,t,n,r)=>Number.isInteger(e)&&Number.isSafeInteger(e)?new Ba(e>=0?La.uint:La.negint,e):new Ba(La.float,e),bigint:(e,t,n,r)=>e>=BigInt(0)?new Ba(La.uint,e):new Ba(La.negint,e),Uint8Array:(e,t,n,r)=>new Ba(La.bytes,e),string:(e,t,n,r)=>new Ba(La.string,e),boolean:(e,t,n,r)=>e?qc.true:qc.false,null:(e,t,n,r)=>qc.null,undefined:(e,t,n,r)=>qc.undefined,ArrayBuffer:(e,t,n,r)=>new Ba(La.bytes,new Uint8Array(e)),DataView:(e,t,n,r)=>new Ba(La.bytes,new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),Array(e,t,n,r){if(!e.length)return!0===n.addBreakTokens?[qc.emptyArray,new Ba(La.break)]:qc.emptyArray;r=Kc.createCheck(r,e);const s=[];let i=0;for(const t of e)s[i++]=jc(t,n,r);return n.addBreakTokens?[new Ba(La.array,e.length),s,new Ba(La.break)]:[new Ba(La.array,e.length),s]},Object(e,t,n,r){const s="Object"!==t,i=s?e.keys():Object.keys(e),o=s?e.size:i.length;if(!o)return!0===n.addBreakTokens?[qc.emptyMap,new Ba(La.break)]:qc.emptyMap;r=Kc.createCheck(r,e);const a=[];let c=0;for(const t of i)a[c++]=[jc(t,n,r),jc(s?e.get(t):e[t],n,r)];return function(e,t){t.mapSorter&&e.sort(t.mapSorter)}(a,n),n.addBreakTokens?[new Ba(La.map,o),a,new Ba(La.break)]:[new Ba(La.map,o),a]}};Wc.Map=Wc.Object,Wc.Buffer=Wc.Uint8Array;for(const e of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Wc[`${e}Array`]=Wc.DataView;function jc(e,t={},n){const r=function(e){if(null===e)return"null";if(void 0===e)return"undefined";if(!0===e||!1===e)return"boolean";const t=typeof e;if(Na.includes(t))return t;if("function"===t)return"Function";if(Array.isArray(e))return"Array";if(function(e){return e&&e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer.call(null,e)}(e))return"Buffer";return function(e){const t=Object.prototype.toString.call(e).slice(8,-1);if(Pa.includes(t))return t}(e)||"Object"}(e),s=t&&t.typeEncoders&&t.typeEncoders[r]||Wc[r];if("function"==typeof s){const i=s(e,r,t,n);if(null!=i)return i}const i=Wc[r];if(!i)throw new Error(`${Za} unsupported type: ${r}`);return i(e,r,t,n)}function Gc(e,t,n,r){if(Array.isArray(t))for(const s of t)Gc(e,s,n,r);else n[t.type.major](e,t,r)}function Yc(e,t,n){const r=jc(e,n);if(!Array.isArray(r)&&n.quickEncodeToken){const e=n.quickEncodeToken(r);if(e)return e;const s=t[r.type.major];if(s.encodedSize){const e=s.encodedSize(r,n),t=new Ja(e);if(s(t,r,n),1!==t.chunks.length)throw new Error(`Unexpected error: pre-calculated length for ${r} was wrong`);return $a(t.chunks[0])}}return Hc.reset(),Gc(Hc,r,t,n),Hc.toBytes(!0)}function Qc(e,t){return t=Object.assign({},Vc,t),Yc(e,zc,t)}const Jc={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class Xc{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=$c[e];if(void 0===t){const n=Fc[e];if(!n)throw new Error(`${Xa} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const r=31&e;t=n(this.data,this._pos,r,this.options)}return this._pos+=t.encodedLength,t}}const Zc=Symbol.for("DONE"),el=Symbol.for("BREAK");function tl(e,t){if(e.done())return Zc;const n=e.next();if(n.type===La.break)return el;if(n.type.terminal)return n.value;if(n.type===La.array)return function(e,t,n){const r=[];for(let s=0;s<e.value;s++){const i=tl(t,n);if(i===el){if(e.value===1/0)break;throw new Error(`${Xa} got unexpected break to lengthed array`)}if(i===Zc)throw new Error(`${Xa} found array but not enough entries (got ${s}, expected ${e.value})`);r[s]=i}return r}(n,e,t);if(n.type===La.map)return function(e,t,n){const r=!0===n.useMaps,s=r?void 0:{},i=r?new Map:void 0;for(let o=0;o<e.value;o++){const a=tl(t,n);if(a===el){if(e.value===1/0)break;throw new Error(`${Xa} got unexpected break to lengthed map`)}if(a===Zc)throw new Error(`${Xa} found map but not enough entries (got ${o} [no key], expected ${e.value})`);if(!0!==r&&"string"!=typeof a)throw new Error(`${Xa} non-string keys not supported (got ${typeof a})`);if(!0===n.rejectDuplicateMapKeys&&(r&&i.has(a)||!r&&a in s))throw new Error(`${Xa} found repeat map key "${a}"`);const c=tl(t,n);if(c===Zc)throw new Error(`${Xa} found map but not enough entries (got ${o} [no value], expected ${e.value})`);r?i.set(a,c):s[a]=c}return r?i:s}(n,e,t);if(n.type===La.tag){if(t.tags&&"function"==typeof t.tags[n.value]){const r=tl(e,t);return t.tags[n.value](r)}throw new Error(`${Xa} tag not supported (${n.value})`)}throw new Error("unsupported")}function nl(e,t){const[n,r]=function(e,t){if(!(e instanceof Uint8Array))throw new Error(`${Xa} data to decode must be a Uint8Array`);const n=(t=Object.assign({},Jc,t)).tokenizer||new Xc(e,t),r=tl(n,t);if(r===Zc)throw new Error(`${Xa} did not find any content to decode`);if(r===el)throw new Error(`${Xa} got unexpected break`);return[r,e.subarray(n.pos())]}(e,t);if(r.length>0)throw new Error(`${Xa} too many terminals, data makes no sense`);return n}const rl="/pin/",sl="/pinned-block/",il=At;function ol(e){return 0===e.version&&(e=e.toV1()),new ia(`${rl}${e.toString(il)}`)}class al{datastore;blockstore;dagWalkers;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.dagWalkers=n}async*add(e,t={}){const n=ol(e);if(await this.datastore.has(n))throw new Error("Already pinned");const r=Math.round(t.depth??1/0);if(r<0)throw new Error("Depth must be greater than or equal to 0");const s=new $({concurrency:1});for await(const n of this.#O(e,s,{...t,depth:r}))await this.#M(n,(t=>null==t.pinnedBy.find((t=>oe(t,e.bytes)))&&(t.pinCount++,t.pinnedBy.push(e.bytes),!0)),t),yield n;const i={depth:r,metadata:t.metadata??{}};await this.datastore.put(n,Qc(i),t)}async*#O(e,t,n){if(-1===n.depth)return;const r=this.dagWalkers[e.code];if(null==r)throw new Error(`No dag walker found for cid codec ${e.code}`);const s=await this.blockstore.get(e,n);yield e;for await(const e of r.walk(s))yield*await t.add((async()=>this.#O(e,t,{...n,depth:n.depth-1})))}async#M(e,t,n){const r=new ia(`${sl}${il.encode(e.multihash.bytes)}`);let s={pinCount:0,pinnedBy:[]};try{s=nl(await this.datastore.get(r,n))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}t(s)&&(0===s.pinCount&&await this.datastore.has(r)?await this.datastore.delete(r):(await this.datastore.put(r,Qc(s),n),n.onProgress?.(new Ce("helia:pin:add",e))))}async*rm(e,t={}){const n=ol(e),r=nl(await this.datastore.get(n,t));await this.datastore.delete(n,t);const s=new $({concurrency:1});for await(const n of this.#O(e,s,{...t,depth:r.depth}))await this.#M(n,(t=>(t.pinCount--,t.pinnedBy=t.pinnedBy.filter((t=>oe(t,e.bytes))),!0)),{...t,depth:r.depth}),yield n}async*ls(e={}){for await(const{key:t,value:n}of this.datastore.query({prefix:rl+(null!=e.cid?`${e.cid.toString(At)}`:"")},e)){const e=Rn.parse(t.toString().substring(5),At),r=nl(n);yield{cid:e,...r}}}async isPinned(e,t={}){const n=new ia(`${sl}${il.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}}class cl{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??5}async start(){await fa(...this.routers)}async stop(){await pa(...this.routers)}async*findProviders(e,t={}){if(0===this.routers.length)throw new k("No content routers available","ERR_NO_ROUTERS_AVAILABLE");const n=new V({concurrency:this.providerLookupConcurrency});n.addEventListener("error",(()=>{}));for await(const r of _e(n.toGenerator(),...ll(this.routers,"findProviders").map((n=>n.findProviders(e,t)))))if(null!=r){if(0===r.multiaddrs.length){if(null!=n.find(r.id))continue;n.add((async()=>{try{const e=await this.findPeer(r.id,t);return 0===e.multiaddrs.length?null:e}catch(e){return this.log.error("could not load multiaddrs for peer %p",r.id,e),null}}),{peerId:r.id,signal:t.signal}).catch((e=>{this.log.error("could not load multiaddrs for peer %p",r.id,e)}))}yield r}}async provide(e,t={}){if(0===this.routers.length)throw new k("No content routers available","ERR_NO_ROUTERS_AVAILABLE");await Promise.all(ll(this.routers,"provide").map((async n=>{await n.provide(e,t)})))}async put(e,t,n){await Promise.all(ll(this.routers,"put").map((async r=>{await r.put(e,t,n)})))}async get(e,t){return Promise.any(ll(this.routers,"get").map((async n=>n.get(e,t))))}async findPeer(e,t){if(0===this.routers.length)throw new k("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");const n=this,r=_e(...ll(this.routers,"findPeer").map((r=>async function*(){try{yield await r.findPeer(e,t)}catch(e){n.log.error(e)}}())));for await(const e of r)if(null!=e)return e;throw new k("Could not find peer in routing","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new k("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");for await(const n of _e(...ll(this.routers,"getClosestPeers").map((n=>n.getClosestPeers(e,t)))))null!=n&&(yield n)}}function ll(e,t){return e.filter((e=>null!=e[t]))}const ul={},hl=e=>{e.addEventListener("message",(t=>{hl.dispatchEvent("message",e,t)})),null!=e.port&&e.port.addEventListener("message",(t=>{hl.dispatchEvent("message",e,t)}))};hl.addEventListener=(e,t)=>{null==ul[e]&&(ul[e]=[]),ul[e].push(t)},hl.removeEventListener=(e,t)=>{null!=ul[e]&&(ul[e]=ul[e].filter((e=>e===t)))},hl.dispatchEvent=function(e,t,n){null!=ul[e]&&ul[e].forEach((e=>e(t,n)))};const dl=hl,fl="lock:worker:request-read",pl="lock:worker:release-read",gl="lock:master:grant-read",yl="lock:worker:request-write",ml="lock:worker:release-write",wl="lock:master:grant-write",bl=(e,t,n,r,s)=>(i,o)=>{if(o.data.type!==n)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};e.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>{i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise((e=>{const t=n=>{if(null==n||null==n.data)return;const s=n.data.type,o=(n.data.name,n.data.identifier);s===r&&o===a.identifier&&(i.removeEventListener("message",t),e())};i.addEventListener("message",t)}))}}}))},El=(e,t,n,r)=>async()=>{const s=Math.random().toString().substring(2);return globalThis.postMessage({type:t,identifier:s,name:e}),new Promise((t=>{const i=o=>{if(null==o||null==o.data)return;const a=o.data.type,c=o.data.identifier;a===n&&c===s&&(globalThis.removeEventListener("message",i),t((()=>{globalThis.postMessage({type:r,identifier:s,name:e})})))};globalThis.addEventListener("message",i)}))},vl={singleProcess:!1},Sl={};let _l;async function Rl(e,t){let n;const r=new Promise((e=>{n=e}));return e.add((async()=>Ea((async()=>{await new Promise((e=>{n((()=>{e()}))}))})(),{milliseconds:t.timeout}))),r}const kl={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function Al(e){const t=Object.assign({},kl,e);return null==_l&&(_l=(e=>{if(e=Object.assign({},vl,e),Boolean(globalThis.document)||e.singleProcess){const e=new EventTarget;return dl.addEventListener("message",bl(e,"requestReadLock",fl,pl,gl)),dl.addEventListener("message",bl(e,"requestWriteLock",yl,ml,wl)),e}return{isWorker:!0,readLock:e=>El(e,fl,gl,pl),writeLock:e=>El(e,yl,wl,ml)}})(t),!0!==_l.isWorker&&(_l.addEventListener("requestReadLock",(e=>{null!=Sl[e.data.name]&&Sl[e.data.name].readLock().then((async t=>e.data.handler().finally((()=>{t()}))))})),_l.addEventListener("requestWriteLock",(async e=>{null!=Sl[e.data.name]&&Sl[e.data.name].writeLock().then((async t=>e.data.handler().finally((()=>{t()}))))})))),null==Sl[t.name]&&(Sl[t.name]=((e,t)=>{if(!0===_l.isWorker)return{readLock:_l.readLock(e,t),writeLock:_l.writeLock(e,t)};const n=new Sa({concurrency:1});let r;return{async readLock(){if(null!=r)return Rl(r,t);r=new Sa({concurrency:t.concurrency,autoStart:!1});const e=r,s=Rl(r,t);return n.add((async()=>{e.start(),await e.onIdle().then((()=>{r===e&&(r=null)}))})),s},writeLock:async()=>(r=null,Rl(n,t))}})(t.name,t)),Sl[t.name]}class Il{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=Al({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await fa(this.child),this.started=!0}async stop(){await pa(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{r()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{const n=this;yield*this.child.deleteMany(async function*(){for await(const t of e){if(await n.pins.isPinned(t))throw new Error("CID was pinned");yield t}}(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}}const Tl={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Tl.tags[42]=function(e){if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return Rn.decode(e.subarray(1))},Tl.tags.slice();const xl=113;La.uint.major,La.negint.major,La.bytes.major,La.string.major,La.array.major,La.map.major,La.tag.major,La.float.major;class Dl{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;32===e||9===e||13===e||10===e;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${Xa} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${Xa} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,n=!1;const r=e=>{for(;!this.done();){const t=this.ch();if(!e.includes(t))break;this._pos++}};if(45===this.ch()&&(t=!0,this._pos++),48===this.ch()){if(this._pos++,46!==this.ch())return new Ba(La.uint,0,this._pos-e);this._pos++,n=!0}if(r([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${Xa} unexpected token at position ${this._pos}`);if(!this.done()&&46===this.ch()){if(n)throw new Error(`${Xa} unexpected token at position ${this._pos}`);n=!0,this._pos++,r([48,49,50,51,52,53,54,55,56,57])}this.done()||101!==this.ch()&&69!==this.ch()||(n=!0,this._pos++,this.done()||43!==this.ch()&&45!==this.ch()||this._pos++,r([48,49,50,51,52,53,54,55,56,57]));const s=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),i=parseFloat(s);return n?new Ba(La.float,i,this._pos-e):!0!==this.options.allowBigInt||Number.isSafeInteger(i)?new Ba(i>=0?La.uint:La.negint,i,this._pos-e):new Ba(i>=0?La.uint:La.negint,BigInt(s),this._pos-e)}parseString(){if(34!==this.ch())throw new Error(`${Xa} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let e=this._pos,t=0;e<this.data.length&&t<65536;e++,t++){const n=this.data[e];if(92===n||n<32||n>=128)break;if(34===n){const n=String.fromCharCode.apply(null,this.data.subarray(this._pos,e));return this._pos=e+1,new Ba(La.string,n,t)}}const e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${Xa} unexpected end of unicode escape sequence at position ${this._pos}`);let e=0;for(let t=0;t<4;t++){let t=this.ch();if(t>=48&&t<=57)t-=48;else if(t>=97&&t<=102)t=t-97+10;else{if(!(t>=65&&t<=70))throw new Error(`${Xa} unexpected unicode escape character at position ${this._pos}`);t=t-65+10}e=16*e+t,this._pos++}return e},r=()=>{const e=this.ch();let n,r,s,i,o=null,a=e>239?4:e>223?3:e>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${Xa} unexpected unicode sequence at position ${this._pos}`);switch(a){case 1:e<128&&(o=e);break;case 2:n=this.data[this._pos+1],128==(192&n)&&(i=(31&e)<<6|63&n,i>127&&(o=i));break;case 3:n=this.data[this._pos+1],r=this.data[this._pos+2],128==(192&n)&&128==(192&r)&&(i=(15&e)<<12|(63&n)<<6|63&r,i>2047&&(i<55296||i>57343)&&(o=i));break;case 4:n=this.data[this._pos+1],r=this.data[this._pos+2],s=this.data[this._pos+3],128==(192&n)&&128==(192&r)&&128==(192&s)&&(i=(15&e)<<18|(63&n)<<12|(63&r)<<6|63&s,i>65535&&i<1114112&&(o=i))}null===o?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|1023&o),t.push(o),this._pos+=a};for(;!this.done();){const s=this.ch();let i;switch(s){case 92:if(this._pos++,this.done())throw new Error(`${Xa} unexpected string termination at position ${this._pos}`);switch(i=this.ch(),this._pos++,i){case 34:case 39:case 92:case 47:t.push(i);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${Xa} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new Ba(La.string,Qa(t),this._pos-e);default:if(s<32)throw new Error(`${Xa} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):r()}}throw new Error(`${Xa} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new Ba(La.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new Ba(La.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new Ba(La.null,null,4);case 102:return this.expect([102,97,108,115,101]),new Ba(La.false,!1,5);case 116:return this.expect([116,114,117,101]),new Ba(La.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${Xa} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":if(this.modeStack.pop(),93===this.ch())return this._pos++,this.skipWhitespace(),new Ba(La.break,void 0,1);if(44!==this.ch())throw new Error(`${Xa} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue();case"array-start":return this.modeStack.pop(),93===this.ch()?(this._pos++,this.skipWhitespace(),new Ba(La.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(125===this.ch())return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new Ba(La.break,void 0,1);if(44!==this.ch())throw new Error(`${Xa} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),125===this.ch())return this._pos++,this.skipWhitespace(),new Ba(La.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),58!==this.ch())throw new Error(`${Xa} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${Xa} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function Cl(e,t){return nl(e,t=Object.assign({tokenizer:new Dl(e,t)},t))}class Nl extends Dl{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===La.map){const e=this._next();if(e.type===La.string&&"/"===e.value){const e=this._next();if(e.type===La.string){if(this._next().type!==La.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(e),new Ba(La.tag,42,0)}if(e.type===La.map){const e=this._next();if(e.type===La.string&&"bytes"===e.value){const e=this._next();if(e.type===La.string){for(let e=0;e<2;e++)if(this._next().type!==La.break)throw new Error("Invalid encoded Bytes form");const t=Dt.decode(`m${e.value}`);return new Ba(La.bytes,t,e.value.length)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}return e}}const Pl={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Pl.tags[42]=Rn.parse;const Ll=297,Bl=(new TextDecoder,new TextEncoder,new TextDecoder);function Ol(e,t){let n=0;for(let r=0;;r+=7){if(r>=64)throw new Error("protobuf: varint overflow");if(t>=e.length)throw new Error("protobuf: unexpected end of data");const s=e[t++];if(n+=r<28?(127&s)<<r:(127&s)*2**r,s<128)break}return[n,t]}function Ml(e,t){let n;[n,t]=Ol(e,t);const r=t+n;if(n<0||r<0)throw new Error("protobuf: invalid length");if(r>e.length)throw new Error("protobuf: unexpected end of data");return[e.subarray(t,r),r]}function Ul(e,t){let n;return[n,t]=Ol(e,t),[7&n,n>>3,t]}function Fl(e){const t={},n=e.length;let r=0;for(;r<n;){let n,s;if([n,s,r]=Ul(e,r),1===s){if(t.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Hash`);if(void 0!==t.Name)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[t.Hash,r]=Ml(e,r)}else if(2===s){if(void 0!==t.Name)throw new Error("protobuf: (PBLink) duplicate Name section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Name`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,r]=Ml(e,r),t.Name=Bl.decode(s)}else{if(3!==s)throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${s}`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(0!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Tsize`);[t.Tsize,r]=Ol(e,r)}}if(r>n)throw new Error("protobuf: (PBLink) unexpected end of data");return t}const $l=new TextEncoder,Vl=2**32,zl=2**31;function Hl(e,t){let n=t.length;if("number"==typeof e.Tsize){if(e.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(e.Tsize))throw new Error("Tsize too large for encoding");n=ql(t,n,e.Tsize)-1,t[n]=24}if("string"==typeof e.Name){const r=$l.encode(e.Name);n-=r.length,t.set(r,n),n=ql(t,n,r.length)-1,t[n]=18}return e.Hash&&(n-=e.Hash.length,t.set(e.Hash,n),n=ql(t,n,e.Hash.length)-1,t[n]=10),t.length-n}function Kl(e){let t=0;if(e.Hash){const n=e.Hash.length;t+=1+n+Wl(n)}if("string"==typeof e.Name){const n=$l.encode(e.Name).length;t+=1+n+Wl(n)}return"number"==typeof e.Tsize&&(t+=1+Wl(e.Tsize)),t}function ql(e,t,n){const r=t-=Wl(n);for(;n>=zl;)e[t++]=127&n|128,n/=128;for(;n>=128;)e[t++]=127&n|128,n>>>=7;return e[t]=n,r}function Wl(e){return e%2==0&&e++,Math.floor((function(e){let t=0;return e>=Vl&&(e=Math.floor(e/Vl),t=32),e>=65536&&(e>>>=16,t+=16),e>=256&&(e>>>=8,t+=8),t+jl[e]}(e)+6)/7)}const jl=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],Gl=["Data","Links"],Yl=["Hash","Name","Tsize"],Ql=new TextEncoder;function Jl(e,t){if(e===t)return 0;const n=e.Name?Ql.encode(e.Name):[],r=t.Name?Ql.encode(t.Name):[];let s=n.length,i=r.length;for(let e=0,t=Math.min(s,i);e<t;++e)if(n[e]!==r[e]){s=n[e],i=r[e];break}return s<i?-1:i<s?1:0}function Xl(e,t){return!Object.keys(e).some((e=>!t.includes(e)))}function Zl(e){if("object"==typeof e.asCID){const t=Rn.asCID(e);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if("object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(e.Hash){let n=Rn.asCID(e.Hash);try{n||("string"==typeof e.Hash?n=Rn.parse(e.Hash):e.Hash instanceof Uint8Array&&(n=Rn.decode(e.Hash)))}catch(e){throw new TypeError(`Invalid DAG-PB form: ${e.message}`)}n&&(t.Hash=n)}if(!t.Hash)throw new TypeError("Invalid DAG-PB form");return"string"==typeof e.Name&&(t.Name=e.Name),"number"==typeof e.Tsize&&(t.Tsize=e.Tsize),t}function eu(e){if((e instanceof Uint8Array||"string"==typeof e)&&(e={Data:e}),"object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(void 0!==e.Data)if("string"==typeof e.Data)t.Data=Ql.encode(e.Data);else{if(!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form");t.Data=e.Data}if(void 0!==e.Links){if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form");t.Links=e.Links.map(Zl),t.Links.sort(Jl)}else t.Links=[];return t}function tu(e){if(!e||"object"!=typeof e||Array.isArray(e)||e instanceof Uint8Array||e["/"]&&e["/"]===e.bytes)throw new TypeError("Invalid DAG-PB form");if(!Xl(e,Gl))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(void 0!==e.Data&&!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let t=0;t<e.Links.length;t++){const n=e.Links[t];if(!n||"object"!=typeof n||Array.isArray(n)||n instanceof Uint8Array||n["/"]&&n["/"]===n.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!Xl(n,Yl))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(void 0===n.Hash)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(null==n.Hash||!n.Hash["/"]||n.Hash["/"]!==n.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(void 0!==n.Name&&"string"!=typeof n.Name)throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(void 0!==n.Tsize){if("number"!=typeof n.Tsize||n.Tsize%1!=0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(n.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(t>0&&-1===Jl(n,e.Links[t-1]))throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function nu(e,t=[]){return eu({Data:e,Links:t})}function ru(e,t,n){return Zl({Hash:n,Name:e,Tsize:t})}const su="dag-pb",iu=112;function ou(e){tu(e);const t={};return e.Links&&(t.Links=e.Links.map((e=>{const t={};return e.Hash&&(t.Hash=e.Hash.bytes),void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),e.Data&&(t.Data=e.Data),function(e){const t=function(e){let t=0;if(e.Data){const n=e.Data.length;t+=1+n+Wl(n)}if(e.Links)for(const n of e.Links){const e=Kl(n);t+=1+e+Wl(e)}return t}(e),n=new Uint8Array(t);let r=t;if(e.Data&&(r-=e.Data.length,n.set(e.Data,r),r=ql(n,r,e.Data.length)-1,n[r]=10),e.Links)for(let t=e.Links.length-1;t>=0;t--){const s=Hl(e.Links[t],n.subarray(0,r));r-=s,r=ql(n,r,s)-1,n[r]=18}return n}(t)}function au(e){const t=function(e){const t=e.length;let n,r,s=0,i=!1;for(;s<t;){let t,o;if([t,o,s]=Ul(e,s),2!==t)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${t}`);if(1===o){if(r)throw new Error("protobuf: (PBNode) duplicate Data section");[r,s]=Ml(e,s),n&&(i=!0)}else{if(2!==o)throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${o}`);{if(i)throw new Error("protobuf: (PBNode) duplicate Links section");let t;n||(n=[]),[t,s]=Ml(e,s),n.push(Fl(t))}}}if(s>t)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return r&&(o.Data=r),o.Links=n||[],o}(function(e){return e instanceof ArrayBuffer?new Uint8Array(e,0,e.byteLength):e}(e)),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map((e=>{const t={};try{t.Hash=Rn.decode(e.Hash)}catch(e){}if(!t.Hash)throw new Error("Invalid Hash field found in link, expected CID");return void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),n}const cu={codec:iu,*walk(e){const t=au(e);yield*t.Links.map((e=>e.Hash))}},lu={codec:Ht,*walk(){}},uu={codec:113,*walk(e){const t=[],n=[];n[42]=e=>{if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");const n=Rn.decode(e.subarray(1));return t.push(n),n},nl(e,{tags:n}),yield*t}};class hu extends Dl{tokenBuffer;constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===La.map){const e=this._next();if(e.type===La.string&&"/"===e.value){const e=this._next();if(e.type===La.string){if(this._next().type!==La.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(e),new Ba(La.tag,42,0)}if(e.type===La.map){const e=this._next();if(e.type===La.string&&"bytes"===e.value){const e=this._next();if(e.type===La.string){for(let e=0;e<2;e++)if(this._next().type!==La.break)throw new Error("Invalid encoded Bytes form");const t=Dt.decode(`m${e.value}`);return new Ba(La.bytes,t,e.value.length)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}return e}}const du={codec:297,*walk(e){const t=[],n=[];n[42]=e=>{const n=Rn.parse(e);return t.push(n),n},Cl(e,{tags:n,tokenizer:new hu(e,{tags:n,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*t}},fu={codec:Ft,*walk(){}},pu=new ia("/version");class gu extends Fo{child;constructor(e){super(),this.child=e}put(e,t){return 0===e.multihash.code||null==this.child?e:this.child.put(e,t)}get(e){if(0===e.multihash.code)return e.multihash.digest;if(null==this.child)throw ta.notFoundError();return this.child.get(e)}has(e){return 0===e.multihash.code||null!=this.child&&this.child.has(e)}delete(e){if(0!==e.code)return null!=this.child?this.child.delete(e):void 0}getAll(e){return null!=this.child?this.child.getAll(e):[]}}function yu(e){return null!=e?.then}const mu=function(e,t){let n=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e){const e=t(r,n++);yu(e)&&await e,yield r}}();const r=ve(e),{value:s,done:i}=r.next();if(!0===i)return function*(){}();const o=t(s,n++);if("function"==typeof o?.then)return async function*(){yield s;for await(const e of r){const r=t(e,n++);yu(r)&&await r,yield e}}();const a=t;return function*(){yield s;for(const e of r)a(e,n++),yield e}()};class wu{child;hashers;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new gu(e.blockstore),this.hashers=e.hashers??{}}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new Ce("blocks:put:duplicate",e)),e):(n.onProgress?.(new Ce("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async r=>r.announce?.(e,t,n)))),n.onProgress?.(new Ce("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){const n=ea(e,(async({cid:e})=>{const n=await this.child.has(e,t);return n&&t.onProgress?.(new Ce("blocks:put-many:duplicate",e)),!n})),r=mu(n,(async({cid:e,block:n})=>{t.onProgress?.(new Ce("blocks:put-many:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async r=>r.announce?.(e,n,t))))}));t.onProgress?.(new Ce("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(r,t)}async get(e,t={}){if(!0!==t.offline&&!await this.child.has(e,t)){t.onProgress?.(new Ce("blocks:get:providers:get",e));const n=await _u(e,this.components.blockBrokers,this.hashers[e.multihash.code],{...t,log:this.log});return t.onProgress?.(new Ce("blocks:get:blockstore:put",e)),await this.child.put(e,n,t),t.onProgress?.(new Ce("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async r=>r.announce?.(e,n,t)))),n}return t.onProgress?.(new Ce("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new Ce("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(mu(e,(async e=>{if(!0!==t.offline&&!await this.child.has(e,t)){t.onProgress?.(new Ce("blocks:get-many:providers:get",e));const n=await _u(e,this.components.blockBrokers,this.hashers[e.multihash.code],{...t,log:this.log});t.onProgress?.(new Ce("blocks:get-many:blockstore:put",e)),await this.child.put(e,n,t),t.onProgress?.(new Ce("blocks:get-many:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async r=>r.announce?.(e,n,t))))}})))}async delete(e,t={}){t.onProgress?.(new Ce("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new Ce("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const t of e)yield t}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new Ce("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class bu extends wu{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await fa(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await pa(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){const n=this.components.blockBrokers.map((e=>null==e.createSession?e:e.createSession(t)));return new Eu({blockstore:this.child,blockBrokers:n,hashers:this.hashers,logger:this.logger},{root:e})}}class Eu extends wu{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){const r=v([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:r})}finally{r.clear()}}async*putMany(e,t={}){const n=v([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async get(e,t={}){const n=v([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){const n=v([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){const n=v([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){const n=v([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){const n=v([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){const t=v([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}}function vu(e){return"function"==typeof e.retrieve}const Su=(e,t)=>{if(null==t)throw new k(`No hasher configured for multihash code 0x${e.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async n=>{if(!oe((await t.digest(n)).digest,e.multihash.digest))throw new k("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function _u(e,t,n,r){const s=Su(e,n),i=new AbortController,o=v([i.signal,r.signal]);i.signal;const a=[];for(const e of t)vu(e)&&a.push(e);try{return await Promise.any(a.map((async t=>{try{let n=!1;const i=await t.retrieve(e,{...r,signal:o,validateFn:async e=>{await s(e),n=!0}});return n||await s(i),i}catch(t){throw r.log.error("could not retrieve verified block for %c",e,t),t}})))}finally{i.abort(),o.clear()}}class Ru{blockstore;datastore;pins;logger;routing;dagWalkers;hashers;dns;metrics;log;constructor(e){this.logger=e.logger??Xo(),this.log=this.logger.forComponent("helia"),this.hashers=function(e=[]){const t={};return[bn,En,gn,...e].forEach((e=>{t[e.code]=e})),t}(e.hashers),this.dagWalkers=function(e=[]){const t={};return[cu,lu,uu,du,fu,...e].forEach((e=>{t[e.codec]=e})),t}(e.dagWalkers),this.dns=e.dns??Ca(),this.metrics=e.metrics;const t={blockstore:e.blockstore,datastore:e.datastore,hashers:this.hashers,dagWalkers:this.dagWalkers,logger:this.logger,blockBrokers:[],dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new cl(t,{routers:(e.routers??[]).flatMap((e=>{const t=[e];return null!=e[ua]&&t.push(e[ua]),null!=e[ha]&&t.push(e[ha]),t})),providerLookupConcurrency:e.providerLookupConcurrency});const n=new bu(t);this.pins=new al(e.datastore,n,this.dagWalkers),this.blockstore=new Il(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map((e=>e(t)))}async start(){await async function(e){if(!await e.has(pu))return void await e.put(pu,Ln("1"));const t=mr(await e.get(pu));if(1!==parseInt(t,10))throw new Error("Unknown datastore version, a datastore migration may be required")}(this.datastore),await fa(this.blockstore,this.datastore,this.routing)}async stop(){await pa(this.blockstore,this.datastore,this.routing)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const t=this,n=this.blockstore.unwrap();this.log("gc start"),await z(n.deleteMany(async function*(){for await(const{cid:r}of n.getAll())try{if(await t.pins.isPinned(r,e))continue;yield r,e.onProgress?.(new Ce("helia:gc:deleted",r))}catch(n){t.log.error("Error during gc",n),e.onProgress?.(new Ce("helia:gc:error",n))}}()))}finally{t()}this.log("gc finished")}}class ku extends Ru{libp2p;constructor(e){super({...e,components:{libp2p:e.libp2p}}),this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}class Au extends Jr{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Hr(e);const n=Qr(t);if(this.iHash=e.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,s=new Uint8Array(r);s.set(n.length>r?e.create().update(n).digest():n);for(let e=0;e<s.length;e++)s[e]^=54;this.iHash.update(s),this.oHash=e.create();for(let e=0;e<s.length;e++)s[e]^=106;this.oHash.update(s),s.fill(0)}update(e){return Kr(this),this.iHash.update(e),this}digestInto(e){Kr(this),zr(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:r,destroyed:s,blockLen:i,outputLen:o}=this;return e.finished=r,e.destroyed=s,e.blockLen=i,e.outputLen=o,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Iu=(e,t,n)=>new Au(e,t).update(n).digest();function Tu(e,t,n,r){Hr(e);const s=function(e,t){if(void 0!==t&&"[object Object]"!==Xr.call(t))throw new Error("Options should be object or undefined");return Object.assign({dkLen:32,asyncTick:10},t)}(0,r),{c:i,dkLen:o,asyncTick:a}=s;if(Vr(i),Vr(o),Vr(a),i<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const c=Qr(t),l=Qr(n),u=new Uint8Array(o),h=Iu.create(e,c),d=h._cloneInto().update(l);return{c:i,dkLen:o,asyncTick:a,DK:u,PRF:h,PRFSalt:d}}function xu(e,t,n,r,s){return e.destroy(),t.destroy(),r&&r.destroy(),s.fill(0),n}async function Du(e,t,n,r){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=Tu(e,t,n,r);let u;const h=new Uint8Array(4),d=qr(h),f=new Uint8Array(c.outputLen);for(let e=1,t=0;t<i;e++,t+=c.outputLen){const n=a.subarray(t,t+c.outputLen);d.setInt32(0,e,!1),(u=l._cloneInto(u)).update(h).digestInto(f),n.set(f.subarray(0,n.length)),await Yr(s-1,o,(()=>{c._cloneInto(u).update(f).digestInto(f);for(let e=0;e<n.length;e++)n[e]^=f[e]}))}return xu(c,l,a,u,f)}Iu.create=(e,t)=>new Au(e,t);const Cu=(e,t,n)=>e&t^~e&n,Nu=(e,t,n)=>e&t^e&n^t&n;class Pu extends Jr{constructor(e,t,n,r){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=qr(this.buffer)}update(e){Kr(this);const{view:t,buffer:n,blockLen:r}=this,s=(e=Qr(e)).length;for(let i=0;i<s;){const o=Math.min(r-this.pos,s-i);if(o!==r)n.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===r&&(this.process(t,0),this.pos=0);else{const t=qr(e);for(;r<=s-i;i+=r)this.process(t,i)}}return this.length+=e.length,this.roundClean(),this}digestInto(e){Kr(this),function(e,t){zr(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:r,isLE:s}=this;let{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>r-i&&(this.process(n,0),i=0);for(let e=i;e<r;e++)t[e]=0;!function(e,t,n,r){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,n,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(n>>s&i),a=Number(n&i),c=r?4:0,l=r?0:4;e.setUint32(t+c,o,r),e.setUint32(t+l,a,r)}(n,r-8,BigInt(8*this.length),s),this.process(n,0);const o=qr(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const c=a/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let e=0;e<c;e++)o.setUint32(4*e,l[e],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:r,finished:s,destroyed:i,pos:o}=this;return e.length=r,e.pos=o,e.finished=s,e.destroyed=i,r%t&&e.buffer.set(n),e}}const Lu=new Uint32Array([1732584193,4023233417,2562383102,271733878,3285377520]),Bu=new Uint32Array(80);class Ou extends Pu{constructor(){super(64,20,8,!1),this.A=0|Lu[0],this.B=0|Lu[1],this.C=0|Lu[2],this.D=0|Lu[3],this.E=0|Lu[4]}get(){const{A:e,B:t,C:n,D:r,E:s}=this;return[e,t,n,r,s]}set(e,t,n,r,s){this.A=0|e,this.B=0|t,this.C=0|n,this.D=0|r,this.E=0|s}process(e,t){for(let n=0;n<16;n++,t+=4)Bu[n]=e.getUint32(t,!1);for(let e=16;e<80;e++)Bu[e]=jr(Bu[e-3]^Bu[e-8]^Bu[e-14]^Bu[e-16],1);let{A:n,B:r,C:s,D:i,E:o}=this;for(let e=0;e<80;e++){let t,a;e<20?(t=Cu(r,s,i),a=1518500249):e<40?(t=r^s^i,a=1859775393):e<60?(t=Nu(r,s,i),a=2400959708):(t=r^s^i,a=3395469782);const c=jr(n,5)+t+o+a+Bu[e]|0;o=i,i=s,s=jr(r,30),r=n,n=c}n=n+this.A|0,r=r+this.B|0,s=s+this.C|0,i=i+this.D|0,o=o+this.E|0,this.set(n,r,s,i,o)}roundClean(){Bu.fill(0)}destroy(){this.set(0,0,0,0,0),this.buffer.fill(0)}}const Mu=Zr((()=>new Ou)),Uu=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Fu=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),$u=new Uint32Array(64);class Vu extends Pu{constructor(){super(64,32,8,!1),this.A=0|Fu[0],this.B=0|Fu[1],this.C=0|Fu[2],this.D=0|Fu[3],this.E=0|Fu[4],this.F=0|Fu[5],this.G=0|Fu[6],this.H=0|Fu[7]}get(){const{A:e,B:t,C:n,D:r,E:s,F:i,G:o,H:a}=this;return[e,t,n,r,s,i,o,a]}set(e,t,n,r,s,i,o,a){this.A=0|e,this.B=0|t,this.C=0|n,this.D=0|r,this.E=0|s,this.F=0|i,this.G=0|o,this.H=0|a}process(e,t){for(let n=0;n<16;n++,t+=4)$u[n]=e.getUint32(t,!1);for(let e=16;e<64;e++){const t=$u[e-15],n=$u[e-2],r=Wr(t,7)^Wr(t,18)^t>>>3,s=Wr(n,17)^Wr(n,19)^n>>>10;$u[e]=s+$u[e-7]+r+$u[e-16]|0}let{A:n,B:r,C:s,D:i,E:o,F:a,G:c,H:l}=this;for(let e=0;e<64;e++){const t=l+(Wr(o,6)^Wr(o,11)^Wr(o,25))+Cu(o,a,c)+Uu[e]+$u[e]|0,u=(Wr(n,2)^Wr(n,13)^Wr(n,22))+Nu(n,r,s)|0;l=c,c=a,a=o,o=i+t|0,i=s,s=r,r=n,n=t+u|0}n=n+this.A|0,r=r+this.B|0,s=s+this.C|0,i=i+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(n,r,s,i,o,a,c,l)}roundClean(){$u.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const zu=Zr((()=>new Vu)),Hu=BigInt(2**32-1),Ku=BigInt(32);function qu(e,t=!1){return t?{h:Number(e&Hu),l:Number(e>>Ku&Hu)}:{h:0|Number(e>>Ku&Hu),l:0|Number(e&Hu)}}const Wu={fromBig:qu,split:function(e,t=!1){let n=new Uint32Array(e.length),r=new Uint32Array(e.length);for(let s=0;s<e.length;s++){const{h:i,l:o}=qu(e[s],t);[n[s],r[s]]=[i,o]}return[n,r]},toBig:(e,t)=>BigInt(e>>>0)<<Ku|BigInt(t>>>0),shrSH:(e,t,n)=>e>>>n,shrSL:(e,t,n)=>e<<32-n|t>>>n,rotrSH:(e,t,n)=>e>>>n|t<<32-n,rotrSL:(e,t,n)=>e<<32-n|t>>>n,rotrBH:(e,t,n)=>e<<64-n|t>>>n-32,rotrBL:(e,t,n)=>e>>>n-32|t<<64-n,rotr32H:(e,t)=>t,rotr32L:(e,t)=>e,rotlSH:(e,t,n)=>e<<n|t>>>32-n,rotlSL:(e,t,n)=>t<<n|e>>>32-n,rotlBH:(e,t,n)=>t<<n-32|e>>>64-n,rotlBL:(e,t,n)=>e<<n-32|t>>>64-n,add:function(e,t,n,r){const s=(t>>>0)+(r>>>0);return{h:e+n+(s/2**32|0)|0,l:0|s}},add3L:(e,t,n)=>(e>>>0)+(t>>>0)+(n>>>0),add3H:(e,t,n,r)=>t+n+r+(e/2**32|0)|0,add4L:(e,t,n,r)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0),add4H:(e,t,n,r,s)=>t+n+r+s+(e/2**32|0)|0,add5H:(e,t,n,r,s,i)=>t+n+r+s+i+(e/2**32|0)|0,add5L:(e,t,n,r,s)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0)+(s>>>0)},ju=Wu,[Gu,Yu]=(()=>ju.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map((e=>BigInt(e)))))(),Qu=new Uint32Array(80),Ju=new Uint32Array(80);class Xu extends Pu{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:e,Al:t,Bh:n,Bl:r,Ch:s,Cl:i,Dh:o,Dl:a,Eh:c,El:l,Fh:u,Fl:h,Gh:d,Gl:f,Hh:p,Hl:g}=this;return[e,t,n,r,s,i,o,a,c,l,u,h,d,f,p,g]}set(e,t,n,r,s,i,o,a,c,l,u,h,d,f,p,g){this.Ah=0|e,this.Al=0|t,this.Bh=0|n,this.Bl=0|r,this.Ch=0|s,this.Cl=0|i,this.Dh=0|o,this.Dl=0|a,this.Eh=0|c,this.El=0|l,this.Fh=0|u,this.Fl=0|h,this.Gh=0|d,this.Gl=0|f,this.Hh=0|p,this.Hl=0|g}process(e,t){for(let n=0;n<16;n++,t+=4)Qu[n]=e.getUint32(t),Ju[n]=e.getUint32(t+=4);for(let e=16;e<80;e++){const t=0|Qu[e-15],n=0|Ju[e-15],r=ju.rotrSH(t,n,1)^ju.rotrSH(t,n,8)^ju.shrSH(t,n,7),s=ju.rotrSL(t,n,1)^ju.rotrSL(t,n,8)^ju.shrSL(t,n,7),i=0|Qu[e-2],o=0|Ju[e-2],a=ju.rotrSH(i,o,19)^ju.rotrBH(i,o,61)^ju.shrSH(i,o,6),c=ju.rotrSL(i,o,19)^ju.rotrBL(i,o,61)^ju.shrSL(i,o,6),l=ju.add4L(s,c,Ju[e-7],Ju[e-16]),u=ju.add4H(l,r,a,Qu[e-7],Qu[e-16]);Qu[e]=0|u,Ju[e]=0|l}let{Ah:n,Al:r,Bh:s,Bl:i,Ch:o,Cl:a,Dh:c,Dl:l,Eh:u,El:h,Fh:d,Fl:f,Gh:p,Gl:g,Hh:y,Hl:m}=this;for(let e=0;e<80;e++){const t=ju.rotrSH(u,h,14)^ju.rotrSH(u,h,18)^ju.rotrBH(u,h,41),w=ju.rotrSL(u,h,14)^ju.rotrSL(u,h,18)^ju.rotrBL(u,h,41),b=u&d^~u&p,E=h&f^~h&g,v=ju.add5L(m,w,E,Yu[e],Ju[e]),S=ju.add5H(v,y,t,b,Gu[e],Qu[e]),_=0|v,R=ju.rotrSH(n,r,28)^ju.rotrBH(n,r,34)^ju.rotrBH(n,r,39),k=ju.rotrSL(n,r,28)^ju.rotrBL(n,r,34)^ju.rotrBL(n,r,39),A=n&s^n&o^s&o,I=r&i^r&a^i&a;y=0|p,m=0|g,p=0|d,g=0|f,d=0|u,f=0|h,({h:u,l:h}=ju.add(0|c,0|l,0|S,0|_)),c=0|o,l=0|a,o=0|s,a=0|i,s=0|n,i=0|r;const T=ju.add3L(_,k,I);n=ju.add3H(T,S,R,A),r=0|T}({h:n,l:r}=ju.add(0|this.Ah,0|this.Al,0|n,0|r)),({h:s,l:i}=ju.add(0|this.Bh,0|this.Bl,0|s,0|i)),({h:o,l:a}=ju.add(0|this.Ch,0|this.Cl,0|o,0|a)),({h:c,l}=ju.add(0|this.Dh,0|this.Dl,0|c,0|l)),({h:u,l:h}=ju.add(0|this.Eh,0|this.El,0|u,0|h)),({h:d,l:f}=ju.add(0|this.Fh,0|this.Fl,0|d,0|f)),({h:p,l:g}=ju.add(0|this.Gh,0|this.Gl,0|p,0|g)),({h:y,l:m}=ju.add(0|this.Hh,0|this.Hl,0|y,0|m)),this.set(n,r,s,i,o,a,c,l,u,h,d,f,p,g,y,m)}roundClean(){Qu.fill(0),Ju.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const Zu=Zr((()=>new Xu)),eh={sha1:Mu,"sha2-256":zu,"sha2-512":Zu};function th(e,t,n,r,s){if("sha1"!==s&&"sha2-256"!==s&&"sha2-512"!==s){const e=Object.keys(eh).join(" / ");throw new k(`Hash '${s}' is unknown or not supported. Must be ${e}`,"ERR_UNSUPPORTED_HASH_TYPE")}const i=function(e,t,n,r){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:c}=Tu(e,t,n,r);let l;const u=new Uint8Array(4),h=qr(u),d=new Uint8Array(a.outputLen);for(let e=1,t=0;t<i;e++,t+=a.outputLen){const n=o.subarray(t,t+a.outputLen);h.setInt32(0,e,!1),(l=c._cloneInto(l)).update(u).digestInto(d),n.set(d.subarray(0,n.length));for(let e=1;e<s;e++){a._cloneInto(l).update(d).digestInto(d);for(let e=0;e<n.length;e++)n[e]^=d[e]}}return xu(a,c,o,l,d)}(eh[s],e,t,{c:n,dkLen:r});return Dt.encode(i).substring(1)}function nh(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally}const rh=BigInt(0),sh=BigInt(1),ih=BigInt(2);function oh(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}function ah(e){if(!oh(e))throw new Error("Uint8Array expected")}function ch(e,t){if("boolean"!=typeof t)throw new Error(`${e} must be valid boolean, got "${t}".`)}const lh=Array.from({length:256},((e,t)=>t.toString(16).padStart(2,"0")));function uh(e){ah(e);let t="";for(let n=0;n<e.length;n++)t+=lh[e[n]];return t}function hh(e){const t=e.toString(16);return 1&t.length?`0${t}`:t}function dh(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);return BigInt(""===e?"0":`0x${e}`)}const fh={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function ph(e){return e>=fh._0&&e<=fh._9?e-fh._0:e>=fh._A&&e<=fh._F?e-(fh._A-10):e>=fh._a&&e<=fh._f?e-(fh._a-10):void 0}function gh(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);const t=e.length,n=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(n);for(let t=0,s=0;t<n;t++,s+=2){const n=ph(e.charCodeAt(s)),i=ph(e.charCodeAt(s+1));if(void 0===n||void 0===i){const t=e[s]+e[s+1];throw new Error('hex string expected, got non-hex character "'+t+'" at index '+s)}r[t]=16*n+i}return r}function yh(e){return dh(uh(e))}function mh(e){return ah(e),dh(uh(Uint8Array.from(e).reverse()))}function wh(e,t){return gh(e.toString(16).padStart(2*t,"0"))}function bh(e,t){return wh(e,t).reverse()}function Eh(e,t,n){let r;if("string"==typeof t)try{r=gh(t)}catch(n){throw new Error(`${e} must be valid hex string, got "${t}". Cause: ${n}`)}else{if(!oh(t))throw new Error(`${e} must be hex string or Uint8Array`);r=Uint8Array.from(t)}const s=r.length;if("number"==typeof n&&s!==n)throw new Error(`${e} expected ${n} bytes, got ${s}`);return r}function vh(...e){let t=0;for(let n=0;n<e.length;n++){const r=e[n];ah(r),t+=r.length}const n=new Uint8Array(t);for(let t=0,r=0;t<e.length;t++){const s=e[t];n.set(s,r),r+=s.length}return n}const Sh=e=>"bigint"==typeof e&&rh<=e;function _h(e,t,n){return Sh(e)&&Sh(t)&&Sh(n)&&t<=e&&e<n}function Rh(e,t,n,r){if(!_h(t,n,r))throw new Error(`expected valid ${e}: ${n} <= n < ${r}, got ${typeof t} ${t}`)}function kh(e){let t;for(t=0;e>rh;e>>=sh,t+=1);return t}const Ah=e=>(ih<<BigInt(e-1))-sh,Ih=e=>new Uint8Array(e),Th=e=>Uint8Array.from(e);function xh(e,t,n){if("number"!=typeof e||e<2)throw new Error("hashLen must be a number");if("number"!=typeof t||t<2)throw new Error("qByteLen must be a number");if("function"!=typeof n)throw new Error("hmacFn must be a function");let r=Ih(e),s=Ih(e),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},a=(...e)=>n(s,r,...e),c=(e=Ih())=>{s=a(Th([0]),e),r=a(),0!==e.length&&(s=a(Th([1]),e),r=a())},l=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let e=0;const n=[];for(;e<t;){r=a();const t=r.slice();n.push(t),e+=r.length}return vh(...n)};return(e,t)=>{let n;for(o(),c(e);!(n=t(l()));)c();return o(),n}}const Dh={bigint:e=>"bigint"==typeof e,function:e=>"function"==typeof e,boolean:e=>"boolean"==typeof e,string:e=>"string"==typeof e,stringOrUint8Array:e=>"string"==typeof e||oh(e),isSafeInteger:e=>Number.isSafeInteger(e),array:e=>Array.isArray(e),field:(e,t)=>t.Fp.isValid(e),hash:e=>"function"==typeof e&&Number.isSafeInteger(e.outputLen)};function Ch(e,t,n={}){const r=(t,n,r)=>{const s=Dh[n];if("function"!=typeof s)throw new Error(`Invalid validator "${n}", expected function`);const i=e[t];if(!(r&&void 0===i||s(i,e)))throw new Error(`Invalid param ${String(t)}=${i} (${typeof i}), expected ${n}`)};for(const[e,n]of Object.entries(t))r(e,n,!1);for(const[e,t]of Object.entries(n))r(e,t,!0);return e}function Nh(e){const t=new WeakMap;return(n,...r)=>{const s=t.get(n);if(void 0!==s)return s;const i=e(n,...r);return t.set(n,i),i}}const Ph=BigInt(0),Lh=BigInt(1),Bh=BigInt(2),Oh=BigInt(3),Mh=BigInt(4),Uh=BigInt(5),Fh=BigInt(8);function $h(e,t){const n=e%t;return n>=Ph?n:t+n}function Vh(e,t,n){if(n<=Ph||t<Ph)throw new Error("Expected power/modulo > 0");if(n===Lh)return Ph;let r=Lh;for(;t>Ph;)t&Lh&&(r=r*e%n),e=e*e%n,t>>=Lh;return r}function zh(e,t,n){let r=e;for(;t-- >Ph;)r*=r,r%=n;return r}function Hh(e,t){if(e===Ph||t<=Ph)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let n=$h(e,t),r=t,s=Ph,i=Lh,o=Lh,a=Ph;for(;n!==Ph;){const e=r/n,t=r%n,c=s-o*e,l=i-a*e;r=n,n=t,s=o,i=a,o=c,a=l}if(r!==Lh)throw new Error("invert: does not exist");return $h(s,t)}BigInt(9),BigInt(16);const Kh=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function qh(e,t){const n=void 0!==t?t:e.toString(2).length;return{nBitLength:n,nByteLength:Math.ceil(n/8)}}function Wh(e,t,n=!1,r={}){if(e<=Ph)throw new Error(`Expected Field ORDER > 0, got ${e}`);const{nBitLength:s,nByteLength:i}=qh(e,t);if(i>2048)throw new Error("Field lengths over 2048 bytes are not supported");const o=function(e){if(e%Mh===Oh){const t=(e+Lh)/Mh;return function(e,n){const r=e.pow(n,t);if(!e.eql(e.sqr(r),n))throw new Error("Cannot find square root");return r}}if(e%Fh===Uh){const t=(e-Uh)/Fh;return function(e,n){const r=e.mul(n,Bh),s=e.pow(r,t),i=e.mul(n,s),o=e.mul(e.mul(i,Bh),s),a=e.mul(i,e.sub(o,e.ONE));if(!e.eql(e.sqr(a),n))throw new Error("Cannot find square root");return a}}return function(e){const t=(e-Lh)/Bh;let n,r,s;for(n=e-Lh,r=0;n%Bh===Ph;n/=Bh,r++);for(s=Bh;s<e&&Vh(s,t,e)!==e-Lh;s++);if(1===r){const t=(e+Lh)/Mh;return function(e,n){const r=e.pow(n,t);if(!e.eql(e.sqr(r),n))throw new Error("Cannot find square root");return r}}const i=(n+Lh)/Bh;return function(e,o){if(e.pow(o,t)===e.neg(e.ONE))throw new Error("Cannot find square root");let a=r,c=e.pow(e.mul(e.ONE,s),n),l=e.pow(o,i),u=e.pow(o,n);for(;!e.eql(u,e.ONE);){if(e.eql(u,e.ZERO))return e.ZERO;let t=1;for(let n=e.sqr(u);t<a&&!e.eql(n,e.ONE);t++)n=e.sqr(n);const n=e.pow(c,Lh<<BigInt(a-t-1));c=e.sqr(n),l=e.mul(l,n),u=e.mul(u,c),a=t}return l}}(e)}(e),a=Object.freeze({ORDER:e,BITS:s,BYTES:i,MASK:Ah(s),ZERO:Ph,ONE:Lh,create:t=>$h(t,e),isValid:t=>{if("bigint"!=typeof t)throw new Error("Invalid field element: expected bigint, got "+typeof t);return Ph<=t&&t<e},is0:e=>e===Ph,isOdd:e=>(e&Lh)===Lh,neg:t=>$h(-t,e),eql:(e,t)=>e===t,sqr:t=>$h(t*t,e),add:(t,n)=>$h(t+n,e),sub:(t,n)=>$h(t-n,e),mul:(t,n)=>$h(t*n,e),pow:(e,t)=>function(e,t,n){if(n<Ph)throw new Error("Expected power > 0");if(n===Ph)return e.ONE;if(n===Lh)return t;let r=e.ONE,s=t;for(;n>Ph;)n&Lh&&(r=e.mul(r,s)),s=e.sqr(s),n>>=Lh;return r}(a,e,t),div:(t,n)=>$h(t*Hh(n,e),e),sqrN:e=>e*e,addN:(e,t)=>e+t,subN:(e,t)=>e-t,mulN:(e,t)=>e*t,inv:t=>Hh(t,e),sqrt:r.sqrt||(e=>o(a,e)),invertBatch:e=>function(e,t){const n=new Array(t.length),r=t.reduce(((t,r,s)=>e.is0(r)?t:(n[s]=t,e.mul(t,r))),e.ONE),s=e.inv(r);return t.reduceRight(((t,r,s)=>e.is0(r)?t:(n[s]=e.mul(t,n[s]),e.mul(t,r))),s),n}(a,e),cmov:(e,t,n)=>n?t:e,toBytes:e=>n?bh(e,i):wh(e,i),fromBytes:e=>{if(e.length!==i)throw new Error(`Fp.fromBytes: expected ${i}, got ${e.length}`);return n?mh(e):yh(e)}});return Object.freeze(a)}function jh(e){if("bigint"!=typeof e)throw new Error("field order must be bigint");const t=e.toString(2).length;return Math.ceil(t/8)}function Gh(e){const t=jh(e);return t+Math.ceil(t/2)}const Yh=BigInt(0),Qh=BigInt(1),Jh=new WeakMap,Xh=new WeakMap;function Zh(e,t){const n=(e,t)=>{const n=t.negate();return e?n:t},r=e=>{if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error(`Wrong window size=${e}, should be [1..${t}]`)},s=e=>(r(e),{windows:Math.ceil(t/e)+1,windowSize:2**(e-1)});return{constTimeNegate:n,unsafeLadder(t,n){let r=e.ZERO,s=t;for(;n>Yh;)n&Qh&&(r=r.add(s)),s=s.double(),n>>=Qh;return r},precomputeWindow(e,t){const{windows:n,windowSize:r}=s(t),i=[];let o=e,a=o;for(let e=0;e<n;e++){a=o,i.push(a);for(let e=1;e<r;e++)a=a.add(o),i.push(a);o=a.double()}return i},wNAF(t,r,i){const{windows:o,windowSize:a}=s(t);let c=e.ZERO,l=e.BASE;const u=BigInt(2**t-1),h=2**t,d=BigInt(t);for(let e=0;e<o;e++){const t=e*a;let s=Number(i&u);i>>=d,s>a&&(s-=h,i+=Qh);const o=t,f=t+Math.abs(s)-1,p=e%2!=0,g=s<0;0===s?l=l.add(n(p,r[o])):c=c.add(n(g,r[f]))}return{p:c,f:l}},wNAFCached(e,t,n){const r=Xh.get(e)||1;let s=Jh.get(e);return s||(s=this.precomputeWindow(e,r),1!==r&&Jh.set(e,n(s))),this.wNAF(r,s,t)},setWindowSize(e,t){r(t),Xh.set(e,t),Jh.delete(e)}}}function ed(e,t,n,r){if(!Array.isArray(n)||!Array.isArray(r)||r.length!==n.length)throw new Error("arrays of points and scalars must have equal length");r.forEach(((e,n)=>{if(!t.isValid(e))throw new Error(`wrong scalar at index ${n}`)})),n.forEach(((t,n)=>{if(!(t instanceof e))throw new Error(`wrong point at index ${n}`)}));const s=kh(BigInt(n.length)),i=s>12?s-3:s>4?s-2:s?2:1,o=(1<<i)-1,a=new Array(o+1).fill(e.ZERO),c=Math.floor((t.BITS-1)/i)*i;let l=e.ZERO;for(let t=c;t>=0;t-=i){a.fill(e.ZERO);for(let e=0;e<r.length;e++){const s=r[e],i=Number(s>>BigInt(t)&BigInt(o));a[i]=a[i].add(n[e])}let s=e.ZERO;for(let t=a.length-1,n=e.ZERO;t>0;t--)n=n.add(a[t]),s=s.add(n);if(l=l.add(s),0!==t)for(let e=0;e<i;e++)l=l.double()}return l}function td(e){return Ch(e.Fp,Kh.reduce(((e,t)=>(e[t]="function",e)),{ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"})),Ch(e,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...qh(e.n,e.nBitLength),...e,p:e.Fp.ORDER})}const nd=BigInt(0),rd=BigInt(1),sd=BigInt(2),id=BigInt(8),od={zip215:!0};const ad=BigInt(0),cd=BigInt(1);const ld=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),ud=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),hd=(BigInt(0),BigInt(1)),dd=BigInt(2),fd=BigInt(3),pd=BigInt(5),gd=BigInt(8);function yd(e){const t=BigInt(10),n=BigInt(20),r=BigInt(40),s=BigInt(80),i=ld,o=e*e%i*e%i,a=zh(o,dd,i)*o%i,c=zh(a,hd,i)*e%i,l=zh(c,pd,i)*c%i,u=zh(l,t,i)*l%i,h=zh(u,n,i)*u%i,d=zh(h,r,i)*h%i,f=zh(d,s,i)*d%i,p=zh(f,s,i)*d%i,g=zh(p,t,i)*l%i;return{pow_p_5_8:zh(g,dd,i)*e%i,b2:o}}function md(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}function wd(e,t){const n=ld,r=$h(t*t*t,n),s=$h(r*r*t,n);let i=$h(e*r*yd(e*s).pow_p_5_8,n);const o=$h(t*i*i,n),a=i,c=$h(i*ud,n),l=o===e,u=o===$h(-e,n),h=o===$h(-e*ud,n);return l&&(i=a),(u||h)&&(i=c),($h(i,n)&Lh)===Lh&&(i=$h(-i,n)),{isValid:l||u,value:i}}const bd=(()=>Wh(ld,void 0,!0))(),Ed=(()=>({a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:bd,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:gd,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:Zu,randomBytes:es,adjustScalarBytes:md,uvRatio:wd}))(),vd=(()=>function(e){const t=function(e){const t=td(e);return Ch(e,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...t})}(e),{Fp:n,n:r,prehash:s,hash:i,randomBytes:o,nByteLength:a,h:c}=t,l=sd<<BigInt(8*a)-rd,u=n.create,h=Wh(t.n,t.nBitLength),d=t.uvRatio||((e,t)=>{try{return{isValid:!0,value:n.sqrt(e*n.inv(t))}}catch(e){return{isValid:!1,value:nd}}}),f=t.adjustScalarBytes||(e=>e),p=t.domain||((e,t,n)=>{if(ch("phflag",n),t.length||n)throw new Error("Contexts/pre-hash are not supported");return e});function g(e,t){Rh("coordinate "+e,t,nd,l)}function y(e){if(!(e instanceof b))throw new Error("ExtendedPoint expected")}const m=Nh(((e,t)=>{const{ex:r,ey:s,ez:i}=e,o=e.is0();null==t&&(t=o?id:n.inv(i));const a=u(r*t),c=u(s*t),l=u(i*t);if(o)return{x:nd,y:rd};if(l!==rd)throw new Error("invZ was invalid");return{x:a,y:c}})),w=Nh((e=>{const{a:n,d:r}=t;if(e.is0())throw new Error("bad point: ZERO");const{ex:s,ey:i,ez:o,et:a}=e,c=u(s*s),l=u(i*i),h=u(o*o),d=u(h*h),f=u(c*n);if(u(h*u(f+l))!==u(d+u(r*u(c*l))))throw new Error("bad point: equation left != right (1)");if(u(s*i)!==u(o*a))throw new Error("bad point: equation left != right (2)");return!0}));class b{constructor(e,t,n,r){this.ex=e,this.ey=t,this.ez=n,this.et=r,g("x",e),g("y",t),g("z",n),g("t",r),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(e){if(e instanceof b)throw new Error("extended point not allowed");const{x:t,y:n}=e||{};return g("x",t),g("y",n),new b(t,n,rd,u(t*n))}static normalizeZ(e){const t=n.invertBatch(e.map((e=>e.ez)));return e.map(((e,n)=>e.toAffine(t[n]))).map(b.fromAffine)}static msm(e,t){return ed(b,h,e,t)}_setWindowSize(e){S.setWindowSize(this,e)}assertValidity(){w(this)}equals(e){y(e);const{ex:t,ey:n,ez:r}=this,{ex:s,ey:i,ez:o}=e,a=u(t*o),c=u(s*r),l=u(n*o),h=u(i*r);return a===c&&l===h}is0(){return this.equals(b.ZERO)}negate(){return new b(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){const{a:e}=t,{ex:n,ey:r,ez:s}=this,i=u(n*n),o=u(r*r),a=u(sd*u(s*s)),c=u(e*i),l=n+r,h=u(u(l*l)-i-o),d=c+o,f=d-a,p=c-o,g=u(h*f),y=u(d*p),m=u(h*p),w=u(f*d);return new b(g,y,w,m)}add(e){y(e);const{a:n,d:r}=t,{ex:s,ey:i,ez:o,et:a}=this,{ex:c,ey:l,ez:h,et:d}=e;if(n===BigInt(-1)){const e=u((i-s)*(l+c)),t=u((i+s)*(l-c)),n=u(t-e);if(n===nd)return this.double();const r=u(o*sd*d),f=u(a*sd*h),p=f+r,g=t+e,y=f-r,m=u(p*n),w=u(g*y),E=u(p*y),v=u(n*g);return new b(m,w,v,E)}const f=u(s*c),p=u(i*l),g=u(a*r*d),m=u(o*h),w=u((s+i)*(c+l)-f-p),E=m-g,v=m+g,S=u(p-n*f),_=u(w*E),R=u(v*S),k=u(w*S),A=u(E*v);return new b(_,R,A,k)}subtract(e){return this.add(e.negate())}wNAF(e){return S.wNAFCached(this,e,b.normalizeZ)}multiply(e){const t=e;Rh("scalar",t,rd,r);const{p:n,f:s}=this.wNAF(t);return b.normalizeZ([n,s])[0]}multiplyUnsafe(e){const t=e;return Rh("scalar",t,nd,r),t===nd?v:this.equals(v)||t===rd?this:this.equals(E)?this.wNAF(t).p:S.unsafeLadder(this,t)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return S.unsafeLadder(this,r).is0()}toAffine(e){return m(this,e)}clearCofactor(){const{h:e}=t;return e===rd?this:this.multiplyUnsafe(e)}static fromHex(e,r=!1){const{d:s,a:i}=t,o=n.BYTES;e=Eh("pointHex",e,o),ch("zip215",r);const a=e.slice(),c=e[o-1];a[o-1]=-129&c;const h=mh(a),f=r?l:n.ORDER;Rh("pointHex.y",h,nd,f);const p=u(h*h),g=u(p-rd),y=u(s*p-i);let{isValid:m,value:w}=d(g,y);if(!m)throw new Error("Point.fromHex: invalid y coordinate");const E=(w&rd)===rd,v=!!(128&c);if(!r&&w===nd&&v)throw new Error("Point.fromHex: x=0 and x_0=1");return v!==E&&(w=u(-w)),b.fromAffine({x:w,y:h})}static fromPrivateKey(e){return k(e).point}toRawBytes(){const{x:e,y:t}=this.toAffine(),r=bh(t,n.BYTES);return r[r.length-1]|=e&rd?128:0,r}toHex(){return uh(this.toRawBytes())}}b.BASE=new b(t.Gx,t.Gy,rd,u(t.Gx*t.Gy)),b.ZERO=new b(nd,rd,rd,nd);const{BASE:E,ZERO:v}=b,S=Zh(b,8*a);function _(e){return $h(e,r)}function R(e){return _(mh(e))}function k(e){const t=a;e=Eh("private key",e,t);const n=Eh("hashed private key",i(e),2*t),r=f(n.slice(0,t)),s=n.slice(t,2*t),o=R(r),c=E.multiply(o),l=c.toRawBytes();return{head:r,prefix:s,scalar:o,point:c,pointBytes:l}}function A(e=new Uint8Array,...t){const n=vh(...t);return R(i(p(n,Eh("context",e),!!s)))}const I=od;return E._setWindowSize(8),{CURVE:t,getPublicKey:function(e){return k(e).pointBytes},sign:function(e,t,i={}){e=Eh("message",e),s&&(e=s(e));const{prefix:o,scalar:c,pointBytes:l}=k(t),u=A(i.context,o,e),h=E.multiply(u).toRawBytes(),d=_(u+A(i.context,h,l,e)*c);return Rh("signature.s",d,nd,r),Eh("result",vh(h,bh(d,n.BYTES)),2*a)},verify:function(e,t,r,i=I){const{context:o,zip215:a}=i,c=n.BYTES;e=Eh("signature",e,2*c),t=Eh("message",t),void 0!==a&&ch("zip215",a),s&&(t=s(t));const l=mh(e.slice(c,2*c));let u,h,d;try{u=b.fromHex(r,a),h=b.fromHex(e.slice(0,c),a),d=E.multiplyUnsafe(l)}catch(e){return!1}if(!a&&u.isSmallOrder())return!1;const f=A(o,h.toRawBytes(),u.toRawBytes(),t);return h.add(u.multiplyUnsafe(f)).subtract(d).clearCofactor().equals(b.ZERO)},ExtendedPoint:b,utils:{getExtendedPublicKey:k,randomPrivateKey:()=>o(n.BYTES),precompute:(e=8,t=b.BASE)=>(t._setWindowSize(e),t.multiply(BigInt(3)),t)}}}(Ed))(),Sd=(()=>function(e){const t=(Ch(n=e,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...n}));var n;const{P:r}=t,s=e=>$h(e,r),i=t.montgomeryBits,o=Math.ceil(i/8),a=t.nByteLength,c=t.adjustScalarBytes||(e=>e),l=t.powPminus2||(e=>Vh(e,r-BigInt(2),r));function u(e,t,n){const r=s(e*(t-n));return[t=s(t-r),n=s(n+r)]}const h=(t.a-BigInt(2))/BigInt(4);function d(e){return bh(s(e),o)}function f(e,t){const n=function(e){const t=Eh("u coordinate",e,o);return 32===a&&(t[31]&=127),mh(t)}(t),f=function(e){const t=Eh("scalar",e),n=t.length;if(n!==o&&n!==a)throw new Error(`Expected ${o} or ${a} bytes, got ${n}`);return mh(c(t))}(e),p=function(e,t){Rh("u",e,ad,r),Rh("scalar",t,ad,r);const n=t,o=e;let a,c=cd,d=ad,f=e,p=cd,g=ad;for(let e=BigInt(i-1);e>=ad;e--){const t=n>>e&cd;g^=t,a=u(g,c,f),c=a[0],f=a[1],a=u(g,d,p),d=a[0],p=a[1],g=t;const r=c+d,i=s(r*r),l=c-d,y=s(l*l),m=i-y,w=f+p,b=s((f-p)*r),E=s(w*l),v=b+E,S=b-E;f=s(v*v),p=s(o*s(S*S)),c=s(i*y),d=s(m*(i+s(h*m)))}a=u(g,c,f),c=a[0],f=a[1],a=u(g,d,p),d=a[0],p=a[1];const y=l(d);return s(c*y)}(n,f);if(p===ad)throw new Error("Invalid private or public key received");return d(p)}const p=d(t.Gu);function g(e){return f(e,p)}return{scalarMult:f,scalarMultBase:g,getSharedSecret:(e,t)=>f(e,t),getPublicKey:e=>g(e),utils:{randomPrivateKey:()=>t.randomBytes(t.nByteLength)},GuBytes:p}}({P:ld,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:e=>{const t=ld,{pow_p_5_8:n,b2:r}=yd(e);return $h(zh(n,fd,t)*r,t)},adjustScalarBytes:md,randomBytes:es}))(),_d=32,Rd=64,kd=32;function Ad(e,t){const n=new Uint8Array(Rd);for(let r=0;r<kd;r++)n[r]=e[r],n[kd+r]=t[r];return n}const Id={get(e=globalThis){const t=e.crypto;if(null==t?.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return t}},Td={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function xd(e){const t=e?.algorithm??"AES-GCM";let n=e?.keyLength??16;const r=e?.nonceLength??12,s=e?.digest??"SHA-256",i=e?.saltLength??16,o=e?.iterations??32767,a=Id.get();return n*=8,{encrypt:async function(e,c){const l=a.getRandomValues(new Uint8Array(i)),u=a.getRandomValues(new Uint8Array(r)),h={name:t,iv:u};let d;if("string"==typeof c&&(c=Ln(c)),0===c.length){d=await a.subtle.importKey("jwk",Td,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:l,iterations:o,hash:{name:s}},r=await a.subtle.importKey("raw",c,{name:"PBKDF2"},!1,["deriveKey"]);d=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["encrypt"])}catch{d=await a.subtle.importKey("jwk",Td,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:l,iterations:o,hash:{name:s}},r=await a.subtle.importKey("raw",c,{name:"PBKDF2"},!1,["deriveKey"]);d=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["encrypt"])}const f=await a.subtle.encrypt(h,d,e);return ie([l,h.iv,new Uint8Array(f)])},decrypt:async function(e,c){const l=e.subarray(0,i),u=e.subarray(i,i+r),h=e.subarray(i+r),d={name:t,iv:u};let f;if("string"==typeof c&&(c=Ln(c)),0===c.length)try{const e={name:"PBKDF2",salt:l,iterations:o,hash:{name:s}},r=await a.subtle.importKey("raw",c,{name:"PBKDF2"},!1,["deriveKey"]);f=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["decrypt"])}catch{f=await a.subtle.importKey("jwk",Td,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:l,iterations:o,hash:{name:s}},r=await a.subtle.importKey("raw",c,{name:"PBKDF2"},!1,["deriveKey"]);f=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["decrypt"])}const p=await a.subtle.decrypt(d,f,h);return new Uint8Array(p)}}}async function Dd(e,t){const n=xd(),r=await n.encrypt(e,t);return Dt.encode(r)}var Cd,Nd,Pd,Ld;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(Cd||(Cd={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(Nd||(Nd={})),function(e){e.codec=()=>or(Nd)}(Cd||(Cd={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),Cd.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=Cd.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(Pd||(Pd={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),Cd.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=Cd.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(Ld||(Ld={}));class Bd{_key;constructor(e){this._key=Vd(e,_d)}verify(e,t){return function(e,t,n){return vd.verify(t,n instanceof Uint8Array?n:n.subarray(),e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return Pd.encode({Type:Cd.Ed25519,Data:this.marshal()}).subarray()}equals(e){return oe(this.bytes,e.bytes)}hash(){const e=bn.digest(this.bytes);return nh(e)?e.then((({bytes:e})=>e)):e.bytes}}class Od{_key;_publicKey;constructor(e,t){this._key=Vd(e,Rd),this._publicKey=Vd(t,_d)}sign(e){return function(e,t){const n=e.subarray(0,kd);return vd.sign(t instanceof Uint8Array?t:t.subarray(),n)}(this._key,e)}get public(){return new Bd(this._publicKey)}marshal(){return this._key}get bytes(){return Ld.encode({Type:Cd.Ed25519,Data:this.marshal()}).subarray()}equals(e){return oe(this.bytes,e.bytes)}async hash(){const e=bn.digest(this.bytes);let t;return nh(e)?({bytes:t}=await e):t=e.bytes,t}async id(){const e=gn.digest(this.public.bytes);return Tt.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if("libp2p-key"===t)return Dd(this.bytes,e);throw new k(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Md(e){if(e.length>Rd){const t=(e=Vd(e,Rd+_d)).subarray(0,Rd),n=e.subarray(Rd,e.length);return new Od(t,n)}const t=(e=Vd(e,Rd)).subarray(0,Rd),n=e.subarray(_d);return new Od(t,n)}function Ud(e){return e=Vd(e,_d),new Bd(e)}async function Fd(){const{privateKey:e,publicKey:t}=function(){const e=vd.utils.randomPrivateKey(),t=vd.getPublicKey(e);return{privateKey:Ad(e,t),publicKey:t}}();return new Od(e,t)}async function $d(e){const{privateKey:t,publicKey:n}=function(e){if(e.length!==kd)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=vd.getPublicKey(t);return{privateKey:Ad(t,n),publicKey:n}}(e);return new Od(t,n)}function Vd(e,t){if((e=Uint8Array.from(e??[])).length!==t)throw new k(`Key must be a Uint8Array of length ${t}, got ${e.length}`,"ERR_INVALID_KEY_TYPE");return e}async function zd(e){const t=[await Id.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await Kd(e)],n=await Hd({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function Hd(e){if(null==e.privateKey||null==e.publicKey)throw new k("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Id.get().subtle.exportKey("jwk",e.privateKey),Id.get().subtle.exportKey("jwk",e.publicKey)])}async function Kd(e){return Id.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function qd(e){if("RSA"!==e.kty)throw new k("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new k("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*Ln(e.n,"base64url").length}var Wd=n(152);function jd(e,t){let n=0;if(1===e.length)return e[0];for(let r=e.length-1;r>=0;r--)n+=e[e.length-1-r]*Math.pow(2,t*r);return n}function Gd(e,t,n=-1){const r=n;let s=e,i=0,o=Math.pow(2,t);for(let n=1;n<8;n++){if(e<o){let e;if(r<0)e=new ArrayBuffer(n),i=n;else{if(r<n)return new ArrayBuffer(0);e=new ArrayBuffer(r),i=r}const o=new Uint8Array(e);for(let e=n-1;e>=0;e--){const n=Math.pow(2,e*t);o[i-e-1]=Math.floor(s/n),s-=o[i-e-1]*n}return e}o*=Math.pow(2,t)}return new ArrayBuffer(0)}function Yd(...e){let t=0,n=0;for(const n of e)t+=n.length;const r=new ArrayBuffer(t),s=new Uint8Array(r);for(const t of e)s.set(t,n),n+=t.length;return s}function Qd(){const e=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const t=255===e[0]&&128&e[1],n=0===e[0]&&!(128&e[1]);(t||n)&&this.warnings.push("Needlessly long format")}const t=new ArrayBuffer(this.valueHex.byteLength),n=new Uint8Array(t);for(let e=0;e<this.valueHex.byteLength;e++)n[e]=0;n[0]=128&e[0];const r=jd(n,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let t=0;t<this.valueHex.byteLength;t++)i[t]=e[t];return i[0]&=127,jd(i,8)-r}function Jd(e,t){const n=e.toString(10);if(t<n.length)return"";const r=t-n.length,s=new Array(r);for(let e=0;e<r;e++)s[e]="0";return s.join("").concat(n)}function Xd(){if("undefined"==typeof BigInt)throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Zd(e){let t=0,n=0;for(let n=0;n<e.length;n++)t+=e[n].byteLength;const r=new Uint8Array(t);for(let t=0;t<e.length;t++){const s=e[t];r.set(new Uint8Array(s),n),n+=s.byteLength}return r.buffer}function ef(e,t,n,r){return t instanceof Uint8Array?t.byteLength?n<0?(e.error="Wrong parameter: inputOffset less than zero",!1):r<0?(e.error="Wrong parameter: inputLength less than zero",!1):!(t.byteLength-n-r<0&&(e.error="End of input reached before message was fully decoded (inconsistent offset and length values)",1)):(e.error="Wrong parameter: inputBuffer has zero length",!1):(e.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}Math.log(2);class tf{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return Zd(this.items)}}const nf=[new Uint8Array([1])],rf="0123456789",sf="",of=new ArrayBuffer(0),af=new Uint8Array(0),cf="EndOfContent",lf="OCTET STRING",uf="BIT STRING";function hf(e){var t;return(t=class extends e{constructor(...e){var t;super(...e);const n=e[0]||{};this.isHexOnly=null!==(t=n.isHexOnly)&&void 0!==t&&t,this.valueHexView=n.valueHex?Wd._H.toUint8Array(n.valueHex):af}get valueHex(){return this.valueHexView.slice().buffer}set valueHex(e){this.valueHexView=new Uint8Array(e)}fromBER(e,t,n){const r=e instanceof ArrayBuffer?new Uint8Array(e):e;if(!ef(this,r,t,n))return-1;const s=t+n;return this.valueHexView=r.subarray(t,s),this.valueHexView.length?(this.blockLength=n,s):(this.warnings.push("Zero buffer length"),t)}toBER(e=!1){return this.isHexOnly?e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",of)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Wd.U$.ToHex(this.valueHexView)}}}).NAME="hexBlock",t}class df{constructor({blockLength:e=0,error:t="",warnings:n=[],valueBeforeDecode:r=af}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Wd._H.toUint8Array(r)}static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Wd.U$.ToHex(this.valueBeforeDecodeView)}}}df.NAME="baseBlock";class ff extends df{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}ff.NAME="valueBlock";class pf extends(hf(df)){constructor({idBlock:e={}}={}){var t,n,r,s;super(),e?(this.isHexOnly=null!==(t=e.isHexOnly)&&void 0!==t&&t,this.valueHexView=e.valueHex?Wd._H.toUint8Array(e.valueHex):af,this.tagClass=null!==(n=e.tagClass)&&void 0!==n?n:-1,this.tagNumber=null!==(r=e.tagNumber)&&void 0!==r?r:-1,this.isConstructed=null!==(s=e.isConstructed)&&void 0!==s&&s):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",of}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const n=new Uint8Array(1);if(!e){let e=this.tagNumber;e&=31,t|=e,n[0]=t}return n.buffer}if(!this.isHexOnly){const n=Gd(this.tagNumber,7),r=new Uint8Array(n),s=n.byteLength,i=new Uint8Array(s+1);if(i[0]=31|t,!e){for(let e=0;e<s-1;e++)i[e+1]=128|r[e];i[s]=r[s-1]}return i.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=31|t,!e){const e=this.valueHexView;for(let t=0;t<e.length-1;t++)n[t+1]=128|e[t];n[this.valueHexView.byteLength]=e[e.length-1]}return n.buffer}fromBER(e,t,n){const r=Wd._H.toUint8Array(e);if(!ef(this,r,t,n))return-1;const s=r.subarray(t,t+n);if(0===s.length)return this.error="Zero buffer length",-1;switch(192&s[0]){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=!(32&~s[0]),this.isHexOnly=!1;const i=31&s[0];if(31!==i)this.tagNumber=i,this.blockLength=1;else{let e=1,t=this.valueHexView=new Uint8Array(255),n=255;for(;128&s[e];){if(t[e-1]=127&s[e],e++,e>=s.length)return this.error="End of input reached before message was fully decoded",-1;if(e===n){n+=255;const e=new Uint8Array(n);for(let n=0;n<t.length;n++)e[n]=t[n];t=this.valueHexView=new Uint8Array(n)}}this.blockLength=e+1,t[e-1]=127&s[e];const r=new Uint8Array(e);for(let n=0;n<e;n++)r[n]=t[n];t=this.valueHexView=new Uint8Array(e),t.set(r),this.blockLength<=9?this.tagNumber=jd(t,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(1===this.tagClass&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}pf.NAME="identificationBlock";class gf extends df{constructor({lenBlock:e={}}={}){var t,n,r;super(),this.isIndefiniteForm=null!==(t=e.isIndefiniteForm)&&void 0!==t&&t,this.longFormUsed=null!==(n=e.longFormUsed)&&void 0!==n&&n,this.length=null!==(r=e.length)&&void 0!==r?r:0}fromBER(e,t,n){const r=Wd._H.toUint8Array(e);if(!ef(this,r,t,n))return-1;const s=r.subarray(t,t+n);if(0===s.length)return this.error="Zero buffer length",-1;if(255===s[0])return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=128===s[0],this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(128&s[0]),!1===this.longFormUsed)return this.length=s[0],this.blockLength=1,t+this.blockLength;const i=127&s[0];if(i>8)return this.error="Too big integer",-1;if(i+1>s.length)return this.error="End of input reached before message was fully decoded",-1;const o=t+1,a=r.subarray(o,o+i);return 0===a[i-1]&&this.warnings.push("Needlessly long encoded length"),this.length=jd(a,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=i+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),!1===e&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const r=Gd(this.length,8);if(r.byteLength>127)return this.error="Too big length",of;if(t=new ArrayBuffer(r.byteLength+1),e)return t;const s=new Uint8Array(r);n=new Uint8Array(t),n[0]=128|r.byteLength;for(let e=0;e<r.byteLength;e++)n[e+1]=s[e];return t}return t=new ArrayBuffer(1),!1===e&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}gf.NAME="lengthBlock";const yf={};class mf extends df{constructor({name:e="",optional:t=!1,primitiveSchema:n,...r}={},s){super(r),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new pf(r),this.lenBlock=new gf(r),this.valueBlock=s?new s(r):new ff(r)}fromBER(e,t,n){const r=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return-1===r?(this.error=this.valueBlock.error,r):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),r)}toBER(e,t){const n=t||new tf;t||wf(this);const r=this.idBlock.toBER(e);if(n.write(r),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const t=this.valueBlock.toBER(e);this.lenBlock.length=t.byteLength;const r=this.lenBlock.toBER(e);n.write(r),n.write(t)}return t?of:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return"ascii"===e?this.onAsciiEncoding():Wd.U$.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${Wd.U$.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(e){return this===e||e instanceof this.constructor&&function(e,t){if(e.byteLength!==t.byteLength)return!1;const n=new Uint8Array(e),r=new Uint8Array(t);for(let e=0;e<n.length;e++)if(n[e]!==r[e])return!1;return!0}(this.toBER(),e.toBER())}}function wf(e){if(e instanceof yf.Constructed)for(const t of e.valueBlock.value)wf(t)&&(e.lenBlock.isIndefiniteForm=!0);return!!e.lenBlock.isIndefiniteForm}mf.NAME="BaseBlock";class bf extends mf{constructor({value:e="",...t}={},n){super(t,n),e&&this.fromString(e)}getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}fromBER(e,t,n){const r=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return-1===r?(this.error=this.valueBlock.error,r):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),r)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}bf.NAME="BaseStringBlock";class Ef extends(hf(ff)){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}var vf,Sf,_f,Rf,kf,Af,If,Tf,xf,Df,Cf,Nf,Pf,Lf,Bf,Of,Mf,Uf,Ff,$f,Vf,zf,Hf,Kf,qf,Wf,jf,Gf,Yf,Qf,Jf,Xf,Zf;Ef.NAME="PrimitiveValueBlock";class ep extends mf{constructor(e={}){super(e,Ef),this.idBlock.isConstructed=!1}}function tp(e,t=0,n=e.length){const r=t;let s=new mf({},ff);const i=new df;if(!ef(i,e,t,n))return s.error=i.error,{offset:-1,result:s};if(!e.subarray(t,t+n).length)return s.error="Zero buffer length",{offset:-1,result:s};let o=s.idBlock.fromBER(e,t,n);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),-1===o)return s.error=s.idBlock.error,{offset:-1,result:s};if(t=o,n-=s.idBlock.blockLength,o=s.lenBlock.fromBER(e,t,n),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),-1===o)return s.error=s.lenBlock.error,{offset:-1,result:s};if(t=o,n-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let a=mf;if(1===s.idBlock.tagClass){if(s.idBlock.tagNumber>=37&&!1===s.idBlock.isHexOnly)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};a=yf.EndOfContent;break;case 1:a=yf.Boolean;break;case 2:a=yf.Integer;break;case 3:a=yf.BitString;break;case 4:a=yf.OctetString;break;case 5:a=yf.Null;break;case 6:a=yf.ObjectIdentifier;break;case 10:a=yf.Enumerated;break;case 12:a=yf.Utf8String;break;case 13:a=yf.RelativeObjectIdentifier;break;case 14:a=yf.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:a=yf.Sequence;break;case 17:a=yf.Set;break;case 18:a=yf.NumericString;break;case 19:a=yf.PrintableString;break;case 20:a=yf.TeletexString;break;case 21:a=yf.VideotexString;break;case 22:a=yf.IA5String;break;case 23:a=yf.UTCTime;break;case 24:a=yf.GeneralizedTime;break;case 25:a=yf.GraphicString;break;case 26:a=yf.VisibleString;break;case 27:a=yf.GeneralString;break;case 28:a=yf.UniversalString;break;case 29:a=yf.CharacterString;break;case 30:a=yf.BmpString;break;case 31:a=yf.DATE;break;case 32:a=yf.TimeOfDay;break;case 33:a=yf.DateTime;break;case 34:a=yf.Duration;break;default:{const e=s.idBlock.isConstructed?new yf.Constructed:new yf.Primitive;e.idBlock=s.idBlock,e.lenBlock=s.lenBlock,e.warnings=s.warnings,s=e}}}else a=s.idBlock.isConstructed?yf.Constructed:yf.Primitive;return s=function(e,t){if(e instanceof t)return e;const n=new t;return n.idBlock=e.idBlock,n.lenBlock=e.lenBlock,n.warnings=e.warnings,n.valueBeforeDecodeView=e.valueBeforeDecodeView,n}(s,a),o=s.fromBER(e,t,s.lenBlock.isIndefiniteForm?n:s.lenBlock.length),s.valueBeforeDecodeView=e.subarray(r,r+s.blockLength),{offset:o,result:s}}function np(e){if(!e.byteLength){const e=new mf({},ff);return e.error="Input buffer has zero length",{offset:-1,result:e}}return tp(Wd._H.toUint8Array(e).slice(),0,e.byteLength)}vf=ep,yf.Primitive=vf,ep.NAME="PRIMITIVE";class rp extends ff{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const r=Wd._H.toUint8Array(e);if(!ef(this,r,t,n))return-1;if(this.valueBeforeDecodeView=r.subarray(t,t+n),0===this.valueBeforeDecodeView.length)return this.warnings.push("Zero buffer length"),t;let s=t;for(;(this.isIndefiniteForm?1:n)>0;){const e=tp(r,s,n);if(-1===e.offset)return this.error=e.result.error,this.warnings.concat(e.result.warnings),-1;if(s=e.offset,this.blockLength+=e.result.blockLength,n-=e.result.blockLength,this.value.push(e.result),this.isIndefiniteForm&&e.result.constructor.NAME===cf)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===cf?this.value.pop():this.warnings.push("No EndOfContent block encoded")),s}toBER(e,t){const n=t||new tf;for(let t=0;t<this.value.length;t++)this.value[t].toBER(e,n);return t?of:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}rp.NAME="ConstructedValueBlock";class sp extends mf{constructor(e={}){super(e,rp),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const r=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return-1===r?(this.error=this.valueBlock.error,r):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),r)}onAsciiEncoding(){const e=[];for(const t of this.valueBlock.value)e.push(t.toString("ascii").split("\n").map((e=>`  ${e}`)).join("\n"));const t=3===this.idBlock.tagClass?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :\n${e.join("\n")}`:`${t} :`}}Sf=sp,yf.Constructed=Sf,sp.NAME="CONSTRUCTED";class ip extends ff{fromBER(e,t,n){return t}toBER(e){return of}}ip.override="EndOfContentValueBlock";class op extends mf{constructor(e={}){super(e,ip),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}_f=op,yf.EndOfContent=_f,op.NAME=cf;class ap extends mf{constructor(e={}){super(e,ff),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const e=new Uint8Array(n);e[0]=5,e[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}Rf=ap,yf.Null=Rf,ap.NAME="NULL";class cp extends(hf(ff)){constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Wd._H.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}fromBER(e,t,n){const r=Wd._H.toUint8Array(e);return ef(this,r,t,n)?(this.valueHexView=r.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,Qd.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}cp.NAME="BooleanValueBlock";class lp extends mf{constructor(e={}){super(e,cp),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}}kf=lp,yf.Boolean=kf,lp.NAME="BOOLEAN";class up extends(hf(rp)){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let r=0;if(this.isConstructed){if(this.isHexOnly=!1,r=rp.prototype.fromBER.call(this,e,t,n),-1===r)return r;for(let e=0;e<this.value.length;e++){const t=this.value[e].constructor.NAME;if(t===cf){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(t!==lf)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,r=super.fromBER(e,t,n),this.blockLength=n;return r}toBER(e,t){return this.isConstructed?rp.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}up.NAME="OctetStringValueBlock";class hp extends mf{constructor({idBlock:e={},lenBlock:t={},...n}={}){var r,s;null!==(r=n.isConstructed)&&void 0!==r||(n.isConstructed=!!(null===(s=n.value)||void 0===s?void 0:s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},up),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,0===n)return 0===this.idBlock.error.length&&(this.blockLength+=this.idBlock.blockLength),0===this.lenBlock.error.length&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const r=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(r.byteLength){const e=tp(r,0,r.byteLength);-1!==e.offset&&e.offset===n&&(this.valueBlock.value=[e.result])}}catch(e){}}return super.fromBER(e,t,n)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?sp.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${Wd.U$.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof hp&&e.push(t.valueBlock.valueHexView);return Wd._H.concat(e)}}Af=hp,yf.OctetString=Af,hp.NAME=lf;class dp extends(hf(rp)){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let r=-1;if(this.isConstructed){if(r=rp.prototype.fromBER.call(this,e,t,n),-1===r)return r;for(const e of this.value){const t=e.constructor.NAME;if(t===cf){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(t!==uf)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const n=e.valueBlock;if(this.unusedBits>0&&n.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=n.unusedBits}return r}const s=Wd._H.toUint8Array(e);if(!ef(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(this.unusedBits=i[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const e=i.subarray(1);try{if(e.byteLength){const t=tp(e,0,e.byteLength);-1!==t.offset&&t.offset===n-1&&(this.value=[t.result])}}catch(e){}}return this.valueHexView=i.subarray(1),this.blockLength=i.length,t+n}toBER(e,t){if(this.isConstructed)return rp.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return of;const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}dp.NAME="BitStringValueBlock";class fp extends mf{constructor({idBlock:e={},lenBlock:t={},...n}={}){var r,s;null!==(r=n.isConstructed)&&void 0!==r||(n.isConstructed=!!(null===(s=n.value)||void 0===s?void 0:s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},dp),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return sp.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const n of t)e.push(n.toString(2).padStart(8,"0"));const n=e.join("");return`${this.constructor.NAME} : ${n.substring(0,n.length-this.valueBlock.unusedBits)}`}}}function pp(e,t){const n=new Uint8Array([0]),r=new Uint8Array(e),s=new Uint8Array(t);let i=r.slice(0);const o=i.length-1,a=s.slice(0),c=a.length-1;let l=0,u=0;for(let e=c<o?o:c;e>=0;e--,u++)l=1==u<a.length?i[o-u]+a[c-u]+n[0]:i[o-u]+n[0],n[0]=l/10,1==u>=i.length?i=Yd(new Uint8Array([l%10]),i):i[o-u]=l%10;return n[0]>0&&(i=Yd(n,i)),i}function gp(e){if(e>=nf.length)for(let t=nf.length;t<=e;t++){const e=new Uint8Array([0]);let n=nf[t-1].slice(0);for(let t=n.length-1;t>=0;t--){const r=new Uint8Array([(n[t]<<1)+e[0]]);e[0]=r[0]/10,n[t]=r[0]%10}e[0]>0&&(n=Yd(e,n)),nf.push(n)}return nf[e]}function yp(e,t){let n=0;const r=new Uint8Array(e),s=new Uint8Array(t),i=r.slice(0),o=i.length-1,a=s.slice(0),c=a.length-1;let l,u=0;for(let e=c;e>=0;e--,u++)l=i[o-u]-a[c-u]-n,1==l<0?(n=1,i[o-u]=l+10):(n=0,i[o-u]=l);if(n>0)for(let e=o-c+1;e>=0;e--,u++){if(l=i[o-u]-n,!(l<0)){n=0,i[o-u]=l;break}n=1,i[o-u]=l+10}return i.slice()}If=fp,yf.BitString=If,fp.NAME=uf;class mp extends(hf(ff)){constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),void 0!==e&&(this.valueDec=e)}setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=Qd.call(this)))}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(function(e){const t=e<0?-1*e:e;let n=128;for(let r=1;r<8;r++){if(t<=n){if(e<0){const e=Gd(n-t,8,r);return new Uint8Array(e)[0]|=128,e}let s=Gd(t,8,r),i=new Uint8Array(s);if(128&i[0]){const e=s.slice(0),t=new Uint8Array(e);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let n=0;n<e.byteLength;n++)i[n+1]=t[n];i[0]=0}return s}n*=Math.pow(2,8)}return new ArrayBuffer(0)}(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,r=0){const s=this.fromBER(e,t,n);if(-1===s)return s;const i=this.valueHexView;return 0===i[0]&&128&i[1]?this.valueHexView=i.subarray(1):0!==r&&i.length<r&&(r-i.length>1&&(r=i.length+1),this.valueHexView=i.subarray(r-i.length)),s}toDER(e=!1){const t=this.valueHexView;switch(!0){case!!(128&t[0]):{const e=new Uint8Array(this.valueHexView.length+1);e[0]=0,e.set(t,1),this.valueHexView=e}break;case 0===t[0]&&!(128&t[1]):this.valueHexView=this.valueHexView.subarray(1)}return this.toBER(e)}fromBER(e,t,n){const r=super.fromBER(e,t,n);return-1===r||this.setValueHex(),r}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=8*this.valueHexView.length-1;let t,n=new Uint8Array(8*this.valueHexView.length/3),r=0;const s=this.valueHexView;let i="",o=!1;for(let o=s.byteLength-1;o>=0;o--){t=s[o];for(let s=0;s<8;s++)1&~t||(r===e?(n=yp(gp(r),n),i="-"):n=pp(n,gp(r))),r++,t>>=1}for(let e=0;e<n.length;e++)n[e]&&(o=!0),o&&(i+=rf.charAt(n[e]));return!1===o&&(i+=rf.charAt(0)),i}}Tf=mp,mp.NAME="IntegerValueBlock",Object.defineProperty(Tf.prototype,"valueHex",{set:function(e){this.valueHexView=new Uint8Array(e),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});class wp extends mf{constructor(e={}){super(e,mp),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Xd(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Xd();const t=BigInt(e),n=new tf,r=t.toString(16).replace(/^-/,""),s=new Uint8Array(Wd.U$.FromHex(r));if(t<0){const e=new Uint8Array(s.length+(128&s[0]?1:0));e[0]|=128;const r=BigInt(`0x${Wd.U$.ToHex(e)}`)+t,i=Wd._H.toUint8Array(Wd.U$.FromHex(r.toString(16)));i[0]|=128,n.write(i)}else 128&s[0]&&n.write(new Uint8Array([0])),n.write(s);return new wp({valueHex:n.final()})}convertToDER(){const e=new wp({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new wp({valueHex:0===this.valueBlock.valueHexView[0]?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}xf=wp,yf.Integer=xf,wp.NAME="INTEGER";class bp extends wp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}Df=bp,yf.Enumerated=Df,bp.NAME="ENUMERATED";class Ep extends(hf(ff)){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const r=Wd._H.toUint8Array(e);if(!ef(this,r,t,n))return-1;const s=r.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let e=0;e<n&&(this.valueHexView[e]=127&s[e],this.blockLength++,128&s[e]);e++);const i=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength;e++)i[e]=this.valueHexView[e];return this.valueHexView=i,128&s[this.blockLength-1]?(this.error="End of input reached before message was fully decoded",-1):(0===this.valueHexView[0]&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=jd(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Xd();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let e=0;e<n.length;e++)n[e]=parseInt(t.slice(7*e,7*e+7),2)+(e+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const t=this.valueHexView,n=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength-1;e++)n[e]=128|t[e];return n[this.blockLength-1]=t[this.blockLength-1],n.buffer}const t=Gd(this.valueDec,7);if(0===t.byteLength)return this.error="Error during encoding SID value",of;const n=new Uint8Array(t.byteLength);if(!e){const e=new Uint8Array(t),r=t.byteLength-1;for(let t=0;t<r;t++)n[t]=128|e[t];n[r]=e[r]}return n}toString(){let e="";if(this.isHexOnly)e=Wd.U$.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Ep.NAME="sidBlock";class vp extends ff{constructor({value:e="",...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let r=t;for(;n>0;){const t=new Ep;if(r=t.fromBER(e,r,n),-1===r)return this.blockLength=0,this.error=t.error,r;0===this.value.length&&(t.isFirstSid=!0),this.blockLength+=t.blockLength,n-=t.blockLength,this.value.push(t)}return r}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const r=this.value[n].toBER(e);if(0===r.byteLength)return this.error=this.value[n].error,of;t.push(r)}return Zd(t)}fromString(e){this.value=[];let t=0,n=0,r="",s=!1;do{if(n=e.indexOf(".",t),r=-1===n?e.substring(t):e.substring(t,n),t=n+1,s){const e=this.value[0];let t=0;switch(e.valueDec){case 0:break;case 1:t=40;break;case 2:t=80;break;default:return void(this.value=[])}const n=parseInt(r,10);if(isNaN(n))return;e.valueDec=n+t,s=!1}else{const e=new Ep;if(r>Number.MAX_SAFE_INTEGER){Xd();const t=BigInt(r);e.valueBigInt=t}else if(e.valueDec=parseInt(r,10),isNaN(e.valueDec))return;this.value.length||(e.isFirstSid=!0,s=!0),this.value.push(e)}}while(-1!==n)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let r=this.value[n].toString();0!==n&&(e=`${e}.`),t?(r=`{${r}}`,this.value[n].isFirstSid?e=`2.{${r} - 80}`:e+=r):e+=r}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}vp.NAME="ObjectIdentifierValueBlock";class Sp extends mf{constructor(e={}){super(e,vp),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Cf=Sp,yf.ObjectIdentifier=Cf,Sp.NAME="OBJECT IDENTIFIER";class _p extends(hf(df)){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(0===n)return t;const r=Wd._H.toUint8Array(e);if(!ef(this,r,t,n))return-1;const s=r.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let e=0;e<n&&(this.valueHexView[e]=127&s[e],this.blockLength++,128&s[e]);e++);const i=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength;e++)i[e]=this.valueHexView[e];return this.valueHexView=i,128&s[this.blockLength-1]?(this.error="End of input reached before message was fully decoded",-1):(0===this.valueHexView[0]&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=jd(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const t=this.valueHexView,n=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength-1;e++)n[e]=128|t[e];return n[this.blockLength-1]=t[this.blockLength-1],n.buffer}const t=Gd(this.valueDec,7);if(0===t.byteLength)return this.error="Error during encoding SID value",of;const n=new Uint8Array(t.byteLength);if(!e){const e=new Uint8Array(t),r=t.byteLength-1;for(let t=0;t<r;t++)n[t]=128|e[t];n[r]=e[r]}return n.buffer}toString(){let e="";return e=this.isHexOnly?Wd.U$.ToHex(this.valueHexView):this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}_p.NAME="relativeSidBlock";class Rp extends ff{constructor({value:e="",...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let r=t;for(;n>0;){const t=new _p;if(r=t.fromBER(e,r,n),-1===r)return this.blockLength=0,this.error=t.error,r;this.blockLength+=t.blockLength,n-=t.blockLength,this.value.push(t)}return r}toBER(e,t){const n=[];for(let t=0;t<this.value.length;t++){const r=this.value[t].toBER(e);if(0===r.byteLength)return this.error=this.value[t].error,of;n.push(r)}return Zd(n)}fromString(e){this.value=[];let t=0,n=0,r="";do{n=e.indexOf(".",t),r=-1===n?e.substring(t):e.substring(t,n),t=n+1;const s=new _p;if(s.valueDec=parseInt(r,10),isNaN(s.valueDec))return!0;this.value.push(s)}while(-1!==n);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let r=this.value[n].toString();0!==n&&(e=`${e}.`),t?(r=`{${r}}`,e+=r):e+=r}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Rp.NAME="RelativeObjectIdentifierValueBlock";class kp extends mf{constructor(e={}){super(e,Rp),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Nf=kp,yf.RelativeObjectIdentifier=Nf,kp.NAME="RelativeObjectIdentifier";class Ap extends sp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}Pf=Ap,yf.Sequence=Pf,Ap.NAME="SEQUENCE";class Ip extends sp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}}Lf=Ip,yf.Set=Lf,Ip.NAME="SET";class Tp extends(hf(ff)){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=sf}toJSON(){return{...super.toJSON(),value:this.value}}}Tp.NAME="StringValueBlock";class xp extends Tp{}xp.NAME="SimpleStringValueBlock";class Dp extends bf{constructor({...e}={}){super(e,xp)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Wd._H.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let r=0;r<t;r++)n[r]=e.charCodeAt(r);this.valueBlock.value=e}}Dp.NAME="SIMPLE STRING";class Cp extends Dp{fromBuffer(e){this.valueBlock.valueHexView=Wd._H.toUint8Array(e);try{this.valueBlock.value=Wd.U$.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Wd.U$.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Wd.U$.FromUtf8String(e)),this.valueBlock.value=e}}Cp.NAME="Utf8StringValueBlock";class Np extends Cp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}Bf=Np,yf.Utf8String=Bf,Np.NAME="UTF8String";class Pp extends Dp{fromBuffer(e){this.valueBlock.value=Wd.U$.ToUtf16String(e),this.valueBlock.valueHexView=Wd._H.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Wd.U$.FromUtf16String(e))}}Pp.NAME="BmpStringValueBlock";class Lp extends Pp{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}Of=Lp,yf.BmpString=Of,Lp.NAME="BMPString";class Bp extends Dp{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let e=0;e<n.length;e+=4)n[e]=n[e+3],n[e+1]=n[e+2],n[e+2]=0,n[e+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(4*t);for(let r=0;r<t;r++){const t=Gd(e.charCodeAt(r),8),s=new Uint8Array(t);if(s.length>4)continue;const i=4-s.length;for(let e=s.length-1;e>=0;e--)n[4*r+e+i]=s[e]}this.valueBlock.value=e}}Bp.NAME="UniversalStringValueBlock";class Op extends Bp{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}Mf=Op,yf.UniversalString=Mf,Op.NAME="UniversalString";class Mp extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}Uf=Mp,yf.NumericString=Uf,Mp.NAME="NumericString";class Up extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}Ff=Up,yf.PrintableString=Ff,Up.NAME="PrintableString";class Fp extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}$f=Fp,yf.TeletexString=$f,Fp.NAME="TeletexString";class $p extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}Vf=$p,yf.VideotexString=Vf,$p.NAME="VideotexString";class Vp extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}zf=Vp,yf.IA5String=zf,Vp.NAME="IA5String";class zp extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}Hf=zp,yf.GraphicString=Hf,zp.NAME="GraphicString";class Hp extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}Kf=Hp,yf.VisibleString=Kf,Hp.NAME="VisibleString";class Kp extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}qf=Kp,yf.GeneralString=qf,Kp.NAME="GeneralString";class qp extends Dp{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}Wf=qp,yf.CharacterString=Wf,qp.NAME="CharacterString";class Wp extends Hp{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let t=0;t<e.length;t++)this.valueBlock.valueHexView[t]=e.charCodeAt(t)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Wd._H.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const t=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/gi.exec(e);if(null===t)return void(this.error="Wrong input string for conversion");const n=parseInt(t[1],10);this.year=n>=50?1900+n:2e3+n,this.month=parseInt(t[2],10),this.day=parseInt(t[3],10),this.hour=parseInt(t[4],10),this.minute=parseInt(t[5],10),this.second=parseInt(t[6],10)}toString(e="iso"){if("iso"===e){const e=new Array(7);return e[0]=Jd(this.year<2e3?this.year-1900:this.year-2e3,2),e[1]=Jd(this.month,2),e[2]=Jd(this.day,2),e[3]=Jd(this.hour,2),e[4]=Jd(this.minute,2),e[5]=Jd(this.second,2),e[6]="Z",e.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}jf=Wp,yf.UTCTime=jf,Wp.NAME="UTCTime";class jp extends Wp{constructor(e={}){var t;super(e),null!==(t=this.millisecond)&&void 0!==t||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))}fromString(e){let t,n=!1,r="",s="",i=0,o=0,a=0;if("Z"===e[e.length-1])r=e.substring(0,e.length-1),n=!0;else{const t=new Number(e[e.length-1]);if(isNaN(t.valueOf()))throw new Error("Wrong input string for conversion");r=e}if(n){if(-1!==r.indexOf("+"))throw new Error("Wrong input string for conversion");if(-1!==r.indexOf("-"))throw new Error("Wrong input string for conversion")}else{let e=1,t=r.indexOf("+"),n="";if(-1===t&&(t=r.indexOf("-"),e=-1),-1!==t){if(n=r.substring(t+1),r=r.substring(0,t),2!==n.length&&4!==n.length)throw new Error("Wrong input string for conversion");let s=parseInt(n.substring(0,2),10);if(isNaN(s.valueOf()))throw new Error("Wrong input string for conversion");if(o=e*s,4===n.length){if(s=parseInt(n.substring(2,4),10),isNaN(s.valueOf()))throw new Error("Wrong input string for conversion");a=e*s}}}let c=r.indexOf(".");if(-1===c&&(c=r.indexOf(",")),-1!==c){const e=new Number(`0${r.substring(c)}`);if(isNaN(e.valueOf()))throw new Error("Wrong input string for conversion");i=e.valueOf(),s=r.substring(0,c)}else s=r;switch(!0){case 8===s.length:if(t=/(\d{4})(\d{2})(\d{2})/gi,-1!==c)throw new Error("Wrong input string for conversion");break;case 10===s.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})/gi,-1!==c){let e=60*i;this.minute=Math.floor(e),e=60*(e-this.minute),this.second=Math.floor(e),e=1e3*(e-this.second),this.millisecond=Math.floor(e)}break;case 12===s.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/gi,-1!==c){let e=60*i;this.second=Math.floor(e),e=1e3*(e-this.second),this.millisecond=Math.floor(e)}break;case 14===s.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/gi,-1!==c){const e=1e3*i;this.millisecond=Math.floor(e)}break;default:throw new Error("Wrong input string for conversion")}const l=t.exec(s);if(null===l)throw new Error("Wrong input string for conversion");for(let e=1;e<l.length;e++)switch(e){case 1:this.year=parseInt(l[e],10);break;case 2:this.month=parseInt(l[e],10);break;case 3:this.day=parseInt(l[e],10);break;case 4:this.hour=parseInt(l[e],10)+o;break;case 5:this.minute=parseInt(l[e],10)+a;break;case 6:this.second=parseInt(l[e],10);break;default:throw new Error("Wrong input string for conversion")}if(!1===n){const e=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=e.getUTCFullYear(),this.month=e.getUTCMonth(),this.day=e.getUTCDay(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds(),this.millisecond=e.getUTCMilliseconds()}}toString(e="iso"){if("iso"===e){const e=[];return e.push(Jd(this.year,4)),e.push(Jd(this.month,2)),e.push(Jd(this.day,2)),e.push(Jd(this.hour,2)),e.push(Jd(this.minute,2)),e.push(Jd(this.second,2)),0!==this.millisecond&&(e.push("."),e.push(Jd(this.millisecond,3))),e.push("Z"),e.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}Gf=jp,yf.GeneralizedTime=Gf,jp.NAME="GeneralizedTime";class Gp extends Np{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}Yf=Gp,yf.DATE=Yf,Gp.NAME="DATE";class Yp extends Np{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}Qf=Yp,yf.TimeOfDay=Qf,Yp.NAME="TimeOfDay";class Qp extends Np{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}Jf=Qp,yf.DateTime=Jf,Qp.NAME="DateTime";class Jp extends Np{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}Xf=Jp,yf.Duration=Xf,Jp.NAME="Duration";class Xp extends Np{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}function Zp(e){let t=e.toString(16);t.length%2>0&&(t=`0${t}`);const n=t.length/2,r=new Uint8Array(n);let s=0,i=0;for(;s<n;)r[s]=parseInt(t.slice(i,i+2),16),s+=1,i+=2;return r}function eg(e){const t=[];return e.forEach((function(e){let n=e.toString(16);n.length%2>0&&(n=`0${n}`),t.push(n)})),BigInt("0x"+t.join(""))}Zf=Xp,yf.TIME=Zf,Xp.NAME="TIME";const tg=32,ng=1e4;function rg(e){return sg(e.valueBlock.value[2].getValue())}function sg(e){return new Uint8Array(e,0,e.byteLength)}const ig=8192;class og{_key;constructor(e){this._key=e}verify(e,t){return async function(e,t,n){const r=await Id.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Id.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n instanceof Uint8Array?n:n.subarray())}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new k("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new Ap({value:[new Ap({value:[new Sp({value:"1.2.840.113549.1.1.1"}),new ap]}),new fp({valueHex:new Ap({value:[wp.fromBigInt(eg(Ln(e.n,"base64url"))),wp.fromBigInt(eg(Ln(e.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}(this._key)}get bytes(){return Pd.encode({Type:Cd.RSA,Data:this.marshal()}).subarray()}equals(e){return oe(this.bytes,e.bytes)}hash(){const e=bn.digest(this.bytes);return nh(e)?e.then((({bytes:e})=>e)):e.bytes}}class ag{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return ts(16)}sign(e){return async function(e,t){const n=await Id.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await Id.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new k("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new og(this._publicKey)}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new k("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new Ap({value:[new wp({value:0}),wp.fromBigInt(eg(Ln(e.n,"base64url"))),wp.fromBigInt(eg(Ln(e.e,"base64url"))),wp.fromBigInt(eg(Ln(e.d,"base64url"))),wp.fromBigInt(eg(Ln(e.p,"base64url"))),wp.fromBigInt(eg(Ln(e.q,"base64url"))),wp.fromBigInt(eg(Ln(e.dp,"base64url"))),wp.fromBigInt(eg(Ln(e.dq,"base64url"))),wp.fromBigInt(eg(Ln(e.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}(this._key)}get bytes(){return Ld.encode({Type:Cd.RSA,Data:this.marshal()}).subarray()}equals(e){return oe(this.bytes,e.bytes)}hash(){const e=bn.digest(this.bytes);return nh(e)?e.then((({bytes:e})=>e)):e.bytes}async id(){return mr(await this.public.hash(),"base58btc")}async export(e,t="pkcs-8"){if("pkcs-8"===t)return async function(e,t){const n=Id.get(),r=new Ap({value:[new wp({value:0}),new Ap({value:[new Sp({value:"1.2.840.113549.1.1.1"}),new ap]}),new hp({valueHex:e.marshal()})]}).toBER(),s=new Uint8Array(r,0,r.byteLength),i=ts(16),o=await Du(Zu,t,i,{c:ng,dkLen:tg}),a=ts(16),c=await n.subtle.importKey("raw",o,"AES-CBC",!1,["encrypt"]),l=await n.subtle.encrypt({name:"AES-CBC",iv:a},c,s),u=new Ap({value:[new hp({valueHex:i}),new wp({value:ng}),new wp({value:tg}),new Ap({value:[new Sp({value:"1.2.840.113549.2.11"}),new ap]})]}),h=new Ap({value:[new Sp({value:"1.2.840.113549.1.5.13"}),new Ap({value:[new Ap({value:[new Sp({value:"1.2.840.113549.1.5.12"}),u]}),new Ap({value:[new Sp({value:"2.16.840.1.101.3.4.1.42"}),new hp({valueHex:a})]})]})]}),d=new Ap({value:[h,new hp({valueHex:l})]}).toBER();return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...mr(new Uint8Array(d,0,d.byteLength),"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join("\n")}(this,e);if("libp2p-key"===t)return Dd(this.bytes,e);throw new k(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}async function cg(e){const t=function(e){const{result:t}=np(e),n=t.valueBlock.value;return{n:mr(Zp(n[1].toBigInt()),"base64url"),e:mr(Zp(n[2].toBigInt()),"base64url"),d:mr(Zp(n[3].toBigInt()),"base64url"),p:mr(Zp(n[4].toBigInt()),"base64url"),q:mr(Zp(n[5].toBigInt()),"base64url"),dp:mr(Zp(n[6].toBigInt()),"base64url"),dq:mr(Zp(n[7].toBigInt()),"base64url"),qi:mr(Zp(n[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}(e);if(qd(t)>ig)throw new k("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await zd(t);return new ag(n.privateKey,n.publicKey)}function lg(e){const t=function(e){const{result:t}=np(e),n=t.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:mr(Zp(n[0].toBigInt()),"base64url"),e:mr(Zp(n[1].toBigInt()),"base64url")}}(e);if(qd(t)>ig)throw new k("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new og(t)}async function ug(e){if(qd(e)>ig)throw new k("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await zd(e);return new ag(t.privateKey,t.publicKey)}async function hg(e){if(e>ig)throw new k("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await Id.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await Hd(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new ag(t.privateKey,t.publicKey)}function dg(e){void 0!==e.lowS&&ch("lowS",e.lowS),void 0!==e.prehash&&ch("prehash",e.prehash)}const{Ph:fg,aT:pg}=m,gg={Err:class extends Error{constructor(e=""){super(e)}},_tlv:{encode:(e,t)=>{const{Err:n}=gg;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(1&t.length)throw new n("tlv.encode: unpadded data");const r=t.length/2,s=hh(r);if(s.length/2&128)throw new n("tlv.encode: long form length too big");const i=r>127?hh(s.length/2|128):"";return`${hh(e)}${i}${s}${t}`},decode(e,t){const{Err:n}=gg;let r=0;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length<2||t[r++]!==e)throw new n("tlv.decode: wrong tlv");const s=t[r++];let i=0;if(128&s){const e=127&s;if(!e)throw new n("tlv.decode(long): indefinite length not supported");if(e>4)throw new n("tlv.decode(long): byte length is too big");const o=t.subarray(r,r+e);if(o.length!==e)throw new n("tlv.decode: length bytes not complete");if(0===o[0])throw new n("tlv.decode(long): zero leftmost byte");for(const e of o)i=i<<8|e;if(r+=e,i<128)throw new n("tlv.decode(long): not minimal encoding")}else i=s;const o=t.subarray(r,r+i);if(o.length!==i)throw new n("tlv.decode: wrong value length");return{v:o,l:t.subarray(r+i)}}},_int:{encode(e){const{Err:t}=gg;if(e<yg)throw new t("integer: negative integers are not allowed");let n=hh(e);if(8&Number.parseInt(n[0],16)&&(n="00"+n),1&n.length)throw new t("unexpected assertion");return n},decode(e){const{Err:t}=gg;if(128&e[0])throw new t("Invalid signature integer: negative");if(0===e[0]&&!(128&e[1]))throw new t("Invalid signature integer: unnecessary leading zero");return fg(e)}},toSig(e){const{Err:t,_int:n,_tlv:r}=gg,s="string"==typeof e?pg(e):e;ah(s);const{v:i,l:o}=r.decode(48,s);if(o.length)throw new t("Invalid signature: left bytes after parsing");const{v:a,l:c}=r.decode(2,i),{v:l,l:u}=r.decode(2,c);if(u.length)throw new t("Invalid signature: left bytes after parsing");return{r:n.decode(a),s:n.decode(l)}},hexFromSig(e){const{_tlv:t,_int:n}=gg,r=`${t.encode(2,n.encode(e.r))}${t.encode(2,n.encode(e.s))}`;return t.encode(48,r)}},yg=BigInt(0),mg=BigInt(1),wg=(BigInt(2),BigInt(3));function bg(e){const t=function(e){const t=td(e);return Ch(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}(e),{Fp:n,n:r}=t,s=n.BYTES+1,i=2*n.BYTES+1;function o(e){return $h(e,r)}function a(e){return Hh(e,r)}const{ProjectivePoint:c,normPrivateKeyToScalar:l,weierstrassEquation:u,isWithinCurveOrder:h}=function(e){const t=function(e){const t=td(e);Ch(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=t;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if("object"!=typeof n||"bigint"!=typeof n.beta||"function"!=typeof n.splitScalar)throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}(e),{Fp:n}=t,r=Wh(t.n,t.nBitLength),s=t.toBytes||((e,t,r)=>{const s=t.toAffine();return vh(Uint8Array.from([4]),n.toBytes(s.x),n.toBytes(s.y))}),i=t.fromBytes||(e=>{const t=e.subarray(1);return{x:n.fromBytes(t.subarray(0,n.BYTES)),y:n.fromBytes(t.subarray(n.BYTES,2*n.BYTES))}});function o(e){const{a:r,b:s}=t,i=n.sqr(e),o=n.mul(i,e);return n.add(n.add(o,n.mul(e,r)),s)}if(!n.eql(n.sqr(t.Gy),o(t.Gx)))throw new Error("bad generator point: equation left != right");function a(e){const{allowedPrivateKeyLengths:n,nByteLength:r,wrapPrivateKey:s,n:i}=t;if(n&&"bigint"!=typeof e){if(oh(e)&&(e=uh(e)),"string"!=typeof e||!n.includes(e.length))throw new Error("Invalid key");e=e.padStart(2*r,"0")}let o;try{o="bigint"==typeof e?e:yh(Eh("private key",e,r))}catch(t){throw new Error(`private key must be ${r} bytes, hex or bigint, not ${typeof e}`)}return s&&(o=$h(o,i)),Rh("private key",o,mg,i),o}function c(e){if(!(e instanceof h))throw new Error("ProjectivePoint expected")}const l=Nh(((e,t)=>{const{px:r,py:s,pz:i}=e;if(n.eql(i,n.ONE))return{x:r,y:s};const o=e.is0();null==t&&(t=o?n.ONE:n.inv(i));const a=n.mul(r,t),c=n.mul(s,t),l=n.mul(i,t);if(o)return{x:n.ZERO,y:n.ZERO};if(!n.eql(l,n.ONE))throw new Error("invZ was invalid");return{x:a,y:c}})),u=Nh((e=>{if(e.is0()){if(t.allowInfinityPoint&&!n.is0(e.py))return;throw new Error("bad point: ZERO")}const{x:r,y:s}=e.toAffine();if(!n.isValid(r)||!n.isValid(s))throw new Error("bad point: x or y not FE");const i=n.sqr(s),a=o(r);if(!n.eql(i,a))throw new Error("bad point: equation left != right");if(!e.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0}));class h{constructor(e,t,r){if(this.px=e,this.py=t,this.pz=r,null==e||!n.isValid(e))throw new Error("x required");if(null==t||!n.isValid(t))throw new Error("y required");if(null==r||!n.isValid(r))throw new Error("z required");Object.freeze(this)}static fromAffine(e){const{x:t,y:r}=e||{};if(!e||!n.isValid(t)||!n.isValid(r))throw new Error("invalid affine point");if(e instanceof h)throw new Error("projective point not allowed");const s=e=>n.eql(e,n.ZERO);return s(t)&&s(r)?h.ZERO:new h(t,r,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(e){const t=n.invertBatch(e.map((e=>e.pz)));return e.map(((e,n)=>e.toAffine(t[n]))).map(h.fromAffine)}static fromHex(e){const t=h.fromAffine(i(Eh("pointHex",e)));return t.assertValidity(),t}static fromPrivateKey(e){return h.BASE.multiply(a(e))}static msm(e,t){return ed(h,r,e,t)}_setWindowSize(e){f.setWindowSize(this,e)}assertValidity(){u(this)}hasEvenY(){const{y:e}=this.toAffine();if(n.isOdd)return!n.isOdd(e);throw new Error("Field doesn't support isOdd")}equals(e){c(e);const{px:t,py:r,pz:s}=this,{px:i,py:o,pz:a}=e,l=n.eql(n.mul(t,a),n.mul(i,s)),u=n.eql(n.mul(r,a),n.mul(o,s));return l&&u}negate(){return new h(this.px,n.neg(this.py),this.pz)}double(){const{a:e,b:r}=t,s=n.mul(r,wg),{px:i,py:o,pz:a}=this;let c=n.ZERO,l=n.ZERO,u=n.ZERO,d=n.mul(i,i),f=n.mul(o,o),p=n.mul(a,a),g=n.mul(i,o);return g=n.add(g,g),u=n.mul(i,a),u=n.add(u,u),c=n.mul(e,u),l=n.mul(s,p),l=n.add(c,l),c=n.sub(f,l),l=n.add(f,l),l=n.mul(c,l),c=n.mul(g,c),u=n.mul(s,u),p=n.mul(e,p),g=n.sub(d,p),g=n.mul(e,g),g=n.add(g,u),u=n.add(d,d),d=n.add(u,d),d=n.add(d,p),d=n.mul(d,g),l=n.add(l,d),p=n.mul(o,a),p=n.add(p,p),d=n.mul(p,g),c=n.sub(c,d),u=n.mul(p,f),u=n.add(u,u),u=n.add(u,u),new h(c,l,u)}add(e){c(e);const{px:r,py:s,pz:i}=this,{px:o,py:a,pz:l}=e;let u=n.ZERO,d=n.ZERO,f=n.ZERO;const p=t.a,g=n.mul(t.b,wg);let y=n.mul(r,o),m=n.mul(s,a),w=n.mul(i,l),b=n.add(r,s),E=n.add(o,a);b=n.mul(b,E),E=n.add(y,m),b=n.sub(b,E),E=n.add(r,i);let v=n.add(o,l);return E=n.mul(E,v),v=n.add(y,w),E=n.sub(E,v),v=n.add(s,i),u=n.add(a,l),v=n.mul(v,u),u=n.add(m,w),v=n.sub(v,u),f=n.mul(p,E),u=n.mul(g,w),f=n.add(u,f),u=n.sub(m,f),f=n.add(m,f),d=n.mul(u,f),m=n.add(y,y),m=n.add(m,y),w=n.mul(p,w),E=n.mul(g,E),m=n.add(m,w),w=n.sub(y,w),w=n.mul(p,w),E=n.add(E,w),y=n.mul(m,E),d=n.add(d,y),y=n.mul(v,E),u=n.mul(b,u),u=n.sub(u,y),y=n.mul(b,m),f=n.mul(v,f),f=n.add(f,y),new h(u,d,f)}subtract(e){return this.add(e.negate())}is0(){return this.equals(h.ZERO)}wNAF(e){return f.wNAFCached(this,e,h.normalizeZ)}multiplyUnsafe(e){Rh("scalar",e,yg,t.n);const r=h.ZERO;if(e===yg)return r;if(e===mg)return this;const{endo:s}=t;if(!s)return f.unsafeLadder(this,e);let{k1neg:i,k1:o,k2neg:a,k2:c}=s.splitScalar(e),l=r,u=r,d=this;for(;o>yg||c>yg;)o&mg&&(l=l.add(d)),c&mg&&(u=u.add(d)),d=d.double(),o>>=mg,c>>=mg;return i&&(l=l.negate()),a&&(u=u.negate()),u=new h(n.mul(u.px,s.beta),u.py,u.pz),l.add(u)}multiply(e){const{endo:r,n:s}=t;let i,o;if(Rh("scalar",e,mg,s),r){const{k1neg:t,k1:s,k2neg:a,k2:c}=r.splitScalar(e);let{p:l,f:u}=this.wNAF(s),{p:d,f:p}=this.wNAF(c);l=f.constTimeNegate(t,l),d=f.constTimeNegate(a,d),d=new h(n.mul(d.px,r.beta),d.py,d.pz),i=l.add(d),o=u.add(p)}else{const{p:t,f:n}=this.wNAF(e);i=t,o=n}return h.normalizeZ([i,o])[0]}multiplyAndAddUnsafe(e,t,n){const r=h.BASE,s=(e,t)=>t!==yg&&t!==mg&&e.equals(r)?e.multiply(t):e.multiplyUnsafe(t),i=s(this,t).add(s(e,n));return i.is0()?void 0:i}toAffine(e){return l(this,e)}isTorsionFree(){const{h:e,isTorsionFree:n}=t;if(e===mg)return!0;if(n)return n(h,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:e,clearCofactor:n}=t;return e===mg?this:n?n(h,this):this.multiplyUnsafe(t.h)}toRawBytes(e=!0){return ch("isCompressed",e),this.assertValidity(),s(h,this,e)}toHex(e=!0){return ch("isCompressed",e),uh(this.toRawBytes(e))}}h.BASE=new h(t.Gx,t.Gy,n.ONE),h.ZERO=new h(n.ZERO,n.ONE,n.ZERO);const d=t.nBitLength,f=Zh(h,t.endo?Math.ceil(d/2):d);return{CURVE:t,ProjectivePoint:h,normPrivateKeyToScalar:a,weierstrassEquation:o,isWithinCurveOrder:function(e){return _h(e,mg,t.n)}}}({...t,toBytes(e,t,r){const s=t.toAffine(),i=n.toBytes(s.x),o=vh;return ch("isCompressed",r),r?o(Uint8Array.from([t.hasEvenY()?2:3]),i):o(Uint8Array.from([4]),i,n.toBytes(s.y))},fromBytes(e){const t=e.length,r=e[0],o=e.subarray(1);if(t!==s||2!==r&&3!==r){if(t===i&&4===r)return{x:n.fromBytes(o.subarray(0,n.BYTES)),y:n.fromBytes(o.subarray(n.BYTES,2*n.BYTES))};throw new Error(`Point of length ${t} was invalid. Expected ${s} compressed bytes or ${i} uncompressed bytes`)}{const e=yh(o);if(!_h(e,mg,n.ORDER))throw new Error("Point is not on curve");const t=u(e);let s;try{s=n.sqrt(t)}catch(e){const t=e instanceof Error?": "+e.message:"";throw new Error("Point is not on curve"+t)}return!(1&~r)!=((s&mg)===mg)&&(s=n.neg(s)),{x:e,y:s}}}}),d=e=>uh(wh(e,t.nByteLength));function f(e){return e>r>>mg}const p=(e,t,n)=>yh(e.slice(t,n));class g{constructor(e,t,n){this.r=e,this.s=t,this.recovery=n,this.assertValidity()}static fromCompact(e){const n=t.nByteLength;return e=Eh("compactSignature",e,2*n),new g(p(e,0,n),p(e,n,2*n))}static fromDER(e){const{r:t,s:n}=gg.toSig(Eh("DER",e));return new g(t,n)}assertValidity(){Rh("r",this.r,mg,r),Rh("s",this.s,mg,r)}addRecoveryBit(e){return new g(this.r,this.s,e)}recoverPublicKey(e){const{r,s,recovery:i}=this,l=b(Eh("msgHash",e));if(null==i||![0,1,2,3].includes(i))throw new Error("recovery id invalid");const u=2===i||3===i?r+t.n:r;if(u>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const h=1&i?"03":"02",f=c.fromHex(h+d(u)),p=a(u),g=o(-l*p),y=o(s*p),m=c.BASE.multiplyAndAddUnsafe(f,g,y);if(!m)throw new Error("point at infinify");return m.assertValidity(),m}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new g(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return gh(this.toDERHex())}toDERHex(){return gg.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return gh(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}const y={isValidPrivateKey(e){try{return l(e),!0}catch(e){return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const e=Gh(t.n);return function(e,t,n=!1){const r=e.length,s=jh(t),i=Gh(t);if(r<16||r<i||r>1024)throw new Error(`expected ${i}-1024 bytes of input, got ${r}`);const o=$h(n?yh(e):mh(e),t-Lh)+Lh;return n?bh(o,s):wh(o,s)}(t.randomBytes(e),t.n)},precompute:(e=8,t=c.BASE)=>(t._setWindowSize(e),t.multiply(BigInt(3)),t)};function m(e){const t=oh(e),n="string"==typeof e,r=(t||n)&&e.length;return t?r===s||r===i:n?r===2*s||r===2*i:e instanceof c}const w=t.bits2int||function(e){const n=yh(e),r=8*e.length-t.nBitLength;return r>0?n>>BigInt(r):n},b=t.bits2int_modN||function(e){return o(w(e))},E=Ah(t.nBitLength);function v(e){return Rh(`num < 2^${t.nBitLength}`,e,yg,E),wh(e,t.nByteLength)}const S={lowS:t.lowS,prehash:!1},_={lowS:t.lowS,prehash:!1};return c.BASE._setWindowSize(8),{CURVE:t,getPublicKey:function(e,t=!0){return c.fromPrivateKey(e).toRawBytes(t)},getSharedSecret:function(e,t,n=!0){if(m(e))throw new Error("first arg must be private key");if(!m(t))throw new Error("second arg must be public key");return c.fromHex(t).multiply(l(e)).toRawBytes(n)},sign:function(e,r,s=S){const{seed:i,k2sig:u}=function(e,r,s=S){if(["recovered","canonical"].some((e=>e in s)))throw new Error("sign() legacy options not supported");const{hash:i,randomBytes:u}=t;let{lowS:d,prehash:p,extraEntropy:y}=s;null==d&&(d=!0),e=Eh("msgHash",e),dg(s),p&&(e=Eh("prehashed msgHash",i(e)));const m=b(e),E=l(r),_=[v(E),v(m)];if(null!=y&&!1!==y){const e=!0===y?u(n.BYTES):y;_.push(Eh("extraEntropy",e))}const R=vh(..._),k=m;return{seed:R,k2sig:function(e){const t=w(e);if(!h(t))return;const n=a(t),r=c.BASE.multiply(t).toAffine(),s=o(r.x);if(s===yg)return;const i=o(n*o(k+s*E));if(i===yg)return;let l=(r.x===s?0:2)|Number(r.y&mg),u=i;return d&&f(i)&&(u=function(e){return f(e)?o(-e):e}(i),l^=1),new g(s,u,l)}}}(e,r,s),d=t;return xh(d.hash.outputLen,d.nByteLength,d.hmac)(i,u)},verify:function(e,n,r,s=_){const i=e;if(n=Eh("msgHash",n),r=Eh("publicKey",r),"strict"in s)throw new Error("options.strict was renamed to lowS");dg(s);const{lowS:l,prehash:u}=s;let h,d;try{if("string"==typeof i||oh(i))try{h=g.fromDER(i)}catch(e){if(!(e instanceof gg.Err))throw e;h=g.fromCompact(i)}else{if("object"!=typeof i||"bigint"!=typeof i.r||"bigint"!=typeof i.s)throw new Error("PARSE");{const{r:e,s:t}=i;h=new g(e,t)}}d=c.fromHex(r)}catch(e){if("PARSE"===e.message)throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(l&&h.hasHighS())return!1;u&&(n=t.hash(n));const{r:f,s:p}=h,y=b(n),m=a(p),w=o(y*m),E=o(f*m),v=c.BASE.multiplyAndAddUnsafe(d,w,E)?.toAffine();return!!v&&o(v.x)===f},ProjectivePoint:c,Signature:g,utils:y}}function Eg(e){return{hash:e,hmac:(t,...n)=>Iu(e,t,function(...e){let t=0;for(let n=0;n<e.length;n++){const r=e[n];zr(r),t+=r.length}const n=new Uint8Array(t);for(let t=0,r=0;t<e.length;t++){const s=e[t];n.set(s,r),r+=s.length}return n}(...n)),randomBytes:es}}BigInt(4);const vg=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Sg=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_g=BigInt(1),Rg=BigInt(2),kg=(e,t)=>(e+t/Rg)/t;const Ag=Wh(vg,void 0,void 0,{sqrt:function(e){const t=vg,n=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=e*e*e%t,u=l*l*e%t,h=zh(u,n,t)*u%t,d=zh(h,n,t)*u%t,f=zh(d,Rg,t)*l%t,p=zh(f,s,t)*f%t,g=zh(p,i,t)*p%t,y=zh(g,a,t)*g%t,m=zh(y,c,t)*y%t,w=zh(m,a,t)*g%t,b=zh(w,n,t)*u%t,E=zh(b,o,t)*p%t,v=zh(E,r,t)*l%t,S=zh(v,Rg,t);if(!Ag.eql(Ag.sqr(S),e))throw new Error("Cannot find square root");return S}}),Ig=function(e,t){const n=t=>bg({...e,...Eg(t)});return Object.freeze({...n(t),create:n})}({a:BigInt(0),b:BigInt(7),Fp:Ag,n:Sg,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:e=>{const t=Sg,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_g*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=n,o=BigInt("0x100000000000000000000000000000000"),a=kg(i*e,t),c=kg(-r*e,t);let l=$h(e-a*n-c*s,t),u=$h(-a*r-c*i,t);const h=l>o,d=u>o;if(h&&(l=t-l),d&&(u=t-u),l>o||u>o)throw new Error("splitScalar: Endomorphism failed, k="+e);return{k1neg:h,k1:l,k2neg:d,k2:u}}}},zu);function Tg(e){try{Ig.ProjectivePoint.fromHex(e)}catch(e){throw new k(String(e),"ERR_INVALID_PUBLIC_KEY")}}BigInt(0),Ig.ProjectivePoint;class xg{_key;constructor(e){Tg(e),this._key=e}verify(e,t){return function(e,t,n){const r=bn.digest(n instanceof Uint8Array?n:n.subarray());if(nh(r))return r.then((({digest:n})=>Ig.verify(t,n,e))).catch((e=>{throw new k(String(e),"ERR_INVALID_INPUT")}));try{return Ig.verify(t,r.digest,e)}catch(e){throw new k(String(e),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Ig.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return Pd.encode({Type:Cd.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return oe(this.bytes,e.bytes)}async hash(){const e=bn.digest(this.bytes);let t;return nh(e)?({bytes:t}=await e):t=e.bytes,t}}class Dg{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??function(e){try{return Ig.getPublicKey(e,!0)}catch(e){throw new k(String(e),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Ig.getPublicKey(e,!0)}catch(e){throw new k(String(e),"ERR_INVALID_PRIVATE_KEY")}}(this._key),Tg(this._publicKey)}sign(e){return function(e,t){const n=bn.digest(t instanceof Uint8Array?t:t.subarray());if(nh(n))return n.then((({digest:t})=>Ig.sign(t,e).toDERRawBytes())).catch((e=>{throw new k(String(e),"ERR_INVALID_INPUT")}));try{return Ig.sign(n.digest,e).toDERRawBytes()}catch(e){throw new k(String(e),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new xg(this._publicKey)}marshal(){return this._key}get bytes(){return Ld.encode({Type:Cd.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return oe(this.bytes,e.bytes)}hash(){const e=bn.digest(this.bytes);return nh(e)?e.then((({bytes:e})=>e)):e.bytes}async id(){return mr(await this.public.hash(),"base58btc")}async export(e,t="libp2p-key"){if("libp2p-key"===t)return Dd(this.bytes,e);throw new k(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Cg(e){return new Dg(e)}function Ng(e){return new xg(e)}async function Pg(){const e=Ig.utils.randomPrivateKey();return new Dg(e)}const Lg={rsa:b,ed25519:w,secp256k1:E};function Bg(e){const t=Object.keys(Lg).join(" / ");return new k(`invalid or unsupported key type ${e}. Must be ${t}`,"ERR_UNSUPPORTED_KEY_TYPE")}function Og(e){if("rsa"===(e=e.toLowerCase())||"ed25519"===e||"secp256k1"===e)return Lg[e];throw Bg(e)}async function Mg(e,t){return Og(e).generateKeyPair(t??2048)}function Ug(e){const t=Pd.decode(e),n=t.Data??new Uint8Array;switch(t.Type){case Cd.RSA:return Lg.rsa.unmarshalRsaPublicKey(n);case Cd.Ed25519:return Lg.ed25519.unmarshalEd25519PublicKey(n);case Cd.Secp256k1:return Lg.secp256k1.unmarshalSecp256k1PublicKey(n);default:throw Bg(t.Type??"unknown")}}function Fg(e,t){return Og(t=(t??"rsa").toLowerCase()),e.bytes}async function $g(e){const t=Ld.decode(e),n=t.Data??new Uint8Array;switch(t.Type){case Cd.RSA:return Lg.rsa.unmarshalRsaPrivateKey(n);case Cd.Ed25519:return Lg.ed25519.unmarshalEd25519PrivateKey(n);case Cd.Secp256k1:return Lg.secp256k1.unmarshalSecp256k1PrivateKey(n);default:throw Bg(t.Type??"RSA")}}async function Vg(e,t){try{const n=await async function(e,t){const n=Dt.decode(e);return xd().decrypt(n,t)}(e,t);return await $g(n)}catch(e){}if(!e.includes("BEGIN"))throw new k("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return async function(e,t){const n=Id.get();let r;if(e.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=Ln(e.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:i}=np(s),{iv:o,salt:a,iterations:c,keySize:l,cipherText:u}=function(e){const t=e.valueBlock.value[0];if("OBJECT IDENTIFIER : 1.2.840.113549.1.5.13"!==t.valueBlock.value[0].toString())throw new k("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");const n=t.valueBlock.value[1].valueBlock.value[0];if("OBJECT IDENTIFIER : 1.2.840.113549.1.5.12"!==n.valueBlock.value[0].toString())throw new k("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");const r=n.valueBlock.value[1],s=sg(r.valueBlock.value[0].getValue());let i=ng,o=tg;if(3===r.valueBlock.value.length)i=Number(r.valueBlock.value[1].toBigInt()),o=Number(r.valueBlock.value[2].toBigInt());else if(2===r.valueBlock.value.length)throw new k("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");const a=t.valueBlock.value[1].valueBlock.value[1],c=a.valueBlock.value[0].toString();if("OBJECT IDENTIFIER : 1.2.840.113549.3.7"===c);else if("OBJECT IDENTIFIER : 1.3.14.3.2.7"===c);else if("OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"===c);else if("OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"===c);else if("OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42"!==c)throw new k("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS");const l=sg(a.valueBlock.value[1].getValue());return{cipherText:sg(e.valueBlock.value[1].getValue()),salt:s,iterations:i,keySize:o,iv:l}}(i),h=await Du(Zu,t,a,{c,dkLen:l}),d=await n.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),f=sg(await n.subtle.decrypt({name:"AES-CBC",iv:o},d,u)),{result:p}=np(f);r=rg(p)}else{if(!e.includes("-----BEGIN PRIVATE KEY-----"))throw new k("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");{const t=Ln(e.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:n}=np(t);r=rg(n)}}return cg(r)}(e,t)}const zg=Symbol.for("@libp2p/service-capabilities"),Hg=Symbol.for("@libp2p/service-dependencies"),Kg=n(864);var qg,Wg=n(424);!function(e){e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"}(qg||(qg={}));const jg="/info/",Gg=new WeakMap,Yg={dek:{keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Qg(e){return null!=e&&"string"==typeof e&&e===Wg(e.trim())&&e.length>0}async function Jg(){const e=800*Math.random()+200;await new Promise((t=>setTimeout(t,e)))}function Xg(e){return new ia("/pkcs8/"+e)}function Zg(e){return new ia(jg+e)}class ey{components;init;log;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=Kg(Yg,t),null!=this.init.pass&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(null!=this.init.dek?.keyLength&&this.init.dek.keyLength<14)throw new Error("dek.keyLength must be least 14 bytes");if(null!=this.init.dek?.salt?.length&&this.init.dek.salt.length<16)throw new Error("dek.saltLength must be least 16 bytes");if(null!=this.init.dek?.iterationCount&&this.init.dek.iterationCount<1e3)throw new Error("dek.iterationCount must be least 1000");const n=null!=this.init.pass&&null!=this.init.dek?.salt?th(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Gg.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[zg]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},Yg),t=3*Math.ceil(16/3);return e.dek.salt=mr(ts(t),"base64"),e}static get options(){return Yg}async createKey(e,t,n=2048){if(!Qg(e)||"self"===e)throw await Jg(),new k("Invalid key name",qg.ERR_INVALID_KEY_NAME);if("string"!=typeof t)throw await Jg(),new k("Invalid key type",qg.ERR_INVALID_KEY_TYPE);const r=Xg(e);if(await this.components.datastore.has(r))throw await Jg(),new k("Key name already exists",qg.ERR_KEY_ALREADY_EXISTS);if("rsa"===t.toLowerCase()&&(!Number.isSafeInteger(n)||n<2048))throw await Jg(),new k("Invalid RSA key size",qg.ERR_INVALID_KEY_SIZE);let s;try{const i=await Mg(t,n),o=await i.id(),a=Gg.get(this);if(null==a)throw new k("dek missing",qg.ERR_INVALID_PARAMETERS);const c=a.dek,l=await i.export(c);s={name:e,id:o};const u=this.components.datastore.batch();u.put(r,Ln(l)),u.put(Zg(e),Ln(JSON.stringify(s))),await u.commit()}catch(e){throw await Jg(),e}return s}async listKeys(){const e={prefix:jg},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(mr(n.value)));return t}async findKeyById(e){try{const t=(await this.listKeys()).find((t=>t.id===e));if(null==t)throw new k(`Key with id '${e}' does not exist.`,qg.ERR_KEY_NOT_FOUND);return t}catch(e){throw await Jg(),e}}async findKeyByName(e){if(!Qg(e))throw await Jg(),new k(`Invalid key name '${e}'`,qg.ERR_INVALID_KEY_NAME);const t=Zg(e);try{const e=await this.components.datastore.get(t);return JSON.parse(mr(e))}catch(t){throw await Jg(),this.log.error(t),new k(`Key '${e}' does not exist.`,qg.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!Qg(e)||"self"===e)throw await Jg(),new k(`Invalid key name '${e}'`,qg.ERR_INVALID_KEY_NAME);const t=Xg(e),n=await this.findKeyByName(e),r=this.components.datastore.batch();return r.delete(t),r.delete(Zg(e)),await r.commit(),n}async renameKey(e,t){if(!Qg(e)||"self"===e)throw await Jg(),new k(`Invalid old key name '${e}'`,qg.ERR_OLD_KEY_NAME_INVALID);if(!Qg(t)||"self"===t)throw await Jg(),new k(`Invalid new key name '${t}'`,qg.ERR_NEW_KEY_NAME_INVALID);const n=Xg(e),r=Xg(t),s=Zg(e),i=Zg(t);if(await this.components.datastore.has(r))throw await Jg(),new k(`Key '${t}' already exists`,qg.ERR_KEY_ALREADY_EXISTS);try{const e=await this.components.datastore.get(n),o=await this.components.datastore.get(s),a=JSON.parse(mr(o));a.name=t;const c=this.components.datastore.batch();return c.put(r,e),c.put(i,Ln(JSON.stringify(a))),c.delete(n),c.delete(s),await c.commit(),a}catch(e){throw await Jg(),e}}async exportKey(e,t){if(!Qg(e))throw await Jg(),new k(`Invalid key name '${e}'`,qg.ERR_INVALID_KEY_NAME);if(null==t)throw await Jg(),new k("Password is required",qg.ERR_PASSWORD_REQUIRED);const n=Xg(e);try{const e=mr(await this.components.datastore.get(n)),r=Gg.get(this);if(null==r)throw new k("dek missing",qg.ERR_INVALID_PARAMETERS);const s=r.dek,i=await Vg(e,s);return await i.export(t)}catch(e){throw await Jg(),e}}async exportPeerId(e){const t="temporary-password",n=await this.exportKey(e,t),r=await Vg(n,t);return Cr(r.public.bytes,r.bytes)}async importKey(e,t,n){if(!Qg(e)||"self"===e)throw await Jg(),new k(`Invalid key name '${e}'`,qg.ERR_INVALID_KEY_NAME);if(null==t)throw await Jg(),new k("PEM encoded key is required",qg.ERR_PEM_REQUIRED);const r=Xg(e);if(await this.components.datastore.has(r))throw await Jg(),new k(`Key '${e}' already exists`,qg.ERR_KEY_ALREADY_EXISTS);let s,i;try{s=await Vg(t,n)}catch(e){throw await Jg(),new k("Cannot read the key, most likely the password is wrong",qg.ERR_CANNOT_READ_KEY)}try{i=await s.id();const e=Gg.get(this);if(null==e)throw new k("dek missing",qg.ERR_INVALID_PARAMETERS);const n=e.dek;t=await s.export(n)}catch(e){throw await Jg(),e}const o={name:e,id:i},a=this.components.datastore.batch();return a.put(r,Ln(t)),a.put(Zg(e),Ln(JSON.stringify(o))),await a.commit(),o}async importPeer(e,t){try{if(!Qg(e))throw new k(`Invalid key name '${e}'`,qg.ERR_INVALID_KEY_NAME);if(null==t)throw new k("PeerId is required",qg.ERR_MISSING_PRIVATE_KEY);if(null==t.privateKey)throw new k("PeerId.privKey is required",qg.ERR_MISSING_PRIVATE_KEY);const n=await $g(t.privateKey),r=Xg(e);if(await this.components.datastore.has(r))throw await Jg(),new k(`Key '${e}' already exists`,qg.ERR_KEY_ALREADY_EXISTS);const s=Gg.get(this);if(null==s)throw new k("dek missing",qg.ERR_INVALID_PARAMETERS);const i=s.dek,o=await n.export(i),a={name:e,id:t.toString()},c=this.components.datastore.batch();return c.put(r,Ln(o)),c.put(Zg(e),Ln(JSON.stringify(a))),await c.commit(),a}catch(e){throw await Jg(),e}}async getPrivateKey(e){if(!Qg(e))throw await Jg(),new k(`Invalid key name '${e}'`,qg.ERR_INVALID_KEY_NAME);try{const t=Xg(e);return mr(await this.components.datastore.get(t))}catch(t){throw await Jg(),this.log.error(t),new k(`Key '${e}' does not exist.`,qg.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if("string"!=typeof e)throw await Jg(),new k(`Invalid old pass type '${typeof e}'`,qg.ERR_INVALID_OLD_PASS_TYPE);if("string"!=typeof t)throw await Jg(),new k(`Invalid new pass type '${typeof t}'`,qg.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await Jg(),new k(`Invalid pass length ${t.length}`,qg.ERR_INVALID_PASS_LENGTH);this.log("recreating keychain");const n=Gg.get(this);if(null==n)throw new k("dek missing",qg.ERR_INVALID_PARAMETERS);const r=n.dek;this.init.pass=t;const s=null!=t&&null!=this.init.dek?.salt?th(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Gg.set(this,{dek:s});const i=await this.listKeys();for(const e of i){const t=mr(await this.components.datastore.get(Xg(e.name))),n=await Vg(t,r),i=s.toString(),o=await n.export(i),a=this.components.datastore.batch(),c={name:e.name,id:e.id};a.put(Xg(e.name),Ln(o)),a.put(Zg(e.name),Ln(JSON.stringify(c))),await a.commit()}this.log("keychain reconstructed")}}function ty(e={}){return t=>new ey(t,e)}const ny=Symbol.for("@libp2p/peer-discovery");class ry{set;constructor(e){if(this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Nr(this.set.entries(),(e=>{const t=xr(e[0]);return[t,t]}))}forEach(e){this.set.forEach((t=>{const n=xr(t);e(n,n,this)}))}has(e){return this.set.has(e.toString())}values(){return Nr(this.set.values(),(e=>xr(e)))}intersection(e){const t=new ry;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new ry;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new ry;for(const n of e)t.add(n);for(const e of this)t.add(e);return t}}const sy=async()=>{const e=await Mg("Ed25519"),t=await async function(e){return Cr(Fg(e.public),(t=e,Og(n=(n??"rsa").toLowerCase()),t.bytes));var t,n}(e);if("Ed25519"===t.type)return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)};var iy;!function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.publicKey=e.bytes();break;case 2:n.payloadType=e.bytes();break;case 3:n.payload=e.bytes();break;case 5:n.signature=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(iy||(iy={}));class oy{static createFromProtobuf=async e=>{const t=iy.decode(e),n=await Cr(t.publicKey);return new oy({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t)=>{if(null==t.privateKey)throw new Error("Missing private key");const n=e.domain,r=e.codec,s=e.marshal(),i=ay(n,r,s),o=await $g(t.privateKey),a=await o.sign(i.subarray());return new oy({peerId:t,payloadType:r,payload:s,signature:a})};static openAndCertify=async(e,t)=>{const n=await oy.createFromProtobuf(e);if(!await n.validate(t))throw new k("envelope signature is not valid for the given domain","ERR_SIGNATURE_NOT_VALID");return n};peerId;payloadType;payload;signature;marshaled;constructor(e){const{peerId:t,payloadType:n,payload:r,signature:s}=e;this.peerId=t,this.payloadType=n,this.payload=r,this.signature=s}marshal(){if(null==this.peerId.publicKey)throw new Error("Missing public key");return null==this.marshaled&&(this.marshaled=iy.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return oe(this.marshal(),e.marshal())}async validate(e){const t=ay(e,this.payloadType,this.payload);if(null==this.peerId.publicKey)throw new Error("Missing public key");return Ug(this.peerId.publicKey).verify(t.subarray(),this.signature)}}const ay=(e,t,n)=>{const r=Ln(e),s=re(r.byteLength),i=re(t.length),o=re(n.length);return new ue(s,r,i,t,o,n)},cy=Uint8Array.from([3,1]);var ly;!function(e){let t,n;!function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();t>>>3==1?n.multiaddr=e.bytes():e.skipType(7&t)}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(t=e.AddressInfo||(e.AddressInfo={})),e.codec=()=>(null==n&&(n=ar(((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(n.uint32(16),n.uint64(t.seq)),null!=t.addresses)for(const r of t.addresses)n.uint32(26),e.AddressInfo.codec().encode(r,n);!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={peerId:new Uint8Array(0),seq:0n,addresses:[]},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.peerId=t.bytes();break;case 2:r.seq=t.uint64();break;case 3:r.addresses.push(e.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(7&n)}}return r}))),n),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(ly||(ly={}));class uy{static createFromProtobuf=e=>{const t=ly.decode(e),n=Dr(t.peerId),r=(t.addresses??[]).map((e=>ei(e.multiaddr))),s=t.seq;return new uy({peerId:n,multiaddrs:r,seqNumber:s})};static DOMAIN="libp2p-peer-record";static CODEC=cy;peerId;multiaddrs;seqNumber;domain=uy.DOMAIN;codec=uy.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:r}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=r??BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=ly.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map((e=>({multiaddr:e.bytes})))})),this.marshaled}equals(e){return e instanceof uy&&!!this.peerId.equals(e.peerId)&&this.seqNumber===e.seqNumber&&!!function(e,t){const n=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(n),e.sort(n).every(((e,n)=>t[n].equals(e))))}(this.multiaddrs,e.multiaddrs)}}const hy={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var dy,fy,py;function gy(e,t){const n=dy.decode(t);null!=n.publicKey&&null==e.publicKey&&(e=function(e){if("RSA"===e.type)return new Rr(e);if("Ed25519"===e.type)return new kr(e);if("secp256k1"===e.type)return new Ar(e);throw new k("Not a PeerId","ERR_INVALID_PARAMETERS")}({...e,publicKey:e.publicKey}));const r=new Map,s=BigInt(Date.now());for(const[e,t]of n.tags.entries())null!=t.expiry&&t.expiry<s||r.set(e,t);return{...n,id:e,addresses:n.addresses.map((({multiaddr:e,isCertified:t})=>({multiaddr:ei(e),isCertified:t??!1}))),metadata:n.metadata,peerRecordEnvelope:n.peerRecordEnvelope??void 0,tags:r}}!function(e){let t,n,r;!function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={key:"",value:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(t=e.Peer$metadataEntry||(e.Peer$metadataEntry={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),py.codec().encode(e.value,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={key:""},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=py.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(n=e.Peer$tagsEntry||(e.Peer$tagsEntry={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.addresses)for(const e of t.addresses)n.uint32(10),fy.codec().encode(e,n);if(null!=t.protocols)for(const e of t.protocols)n.uint32(18),n.string(e);if(null!=t.publicKey&&(n.uint32(34),n.bytes(t.publicKey)),null!=t.peerRecordEnvelope&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),null!=t.metadata&&0!==t.metadata.size)for(const[r,s]of t.metadata.entries())n.uint32(50),e.Peer$metadataEntry.codec().encode({key:r,value:s},n);if(null!=t.tags&&0!==t.tags.size)for(const[r,s]of t.tags.entries())n.uint32(58),e.Peer$tagsEntry.codec().encode({key:r,value:s},n);!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={addresses:[],protocols:[],metadata:new Map,tags:new Map},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.addresses.push(fy.codec().decode(t,t.uint32()));break;case 2:r.protocols.push(t.string());break;case 4:r.publicKey=t.bytes();break;case 5:r.peerRecordEnvelope=t.bytes();break;case 6:{const n=e.Peer$metadataEntry.codec().decode(t,t.uint32());r.metadata.set(n.key,n.value);break}case 7:{const n=e.Peer$tagsEntry.codec().decode(t,t.uint32());r.tags.set(n.key,n.value);break}default:t.skipType(7&n)}}return r}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(dy||(dy={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(fy||(fy={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={value:0},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.value=e.uint32();break;case 2:n.expiry=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(py||(py={}));const yy="/peers/";function my(e){if(!yr(e)||null==e.type)throw new k("Invalid PeerId",hy.ERR_INVALID_PARAMETERS);const t=e.toCID().toString();return new ia(`${yy}${t}`)}async function wy(e,t,n){const r=new Map;for(const s of n){if(null==s)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=ei(s.multiaddr)),!Zs(s.multiaddr))throw new k("Multiaddr was invalid",hy.ERR_INVALID_PARAMETERS);if(!await t(e,s.multiaddr))continue;const n=s.isCertified??!1,i=s.multiaddr.toString(),o=r.get(i);null!=o?s.isCertified=o.isCertified||n:r.set(i,{multiaddr:s.multiaddr,isCertified:n})}return[...r.values()].sort(((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString()))).map((({isCertified:e,multiaddr:t})=>({isCertified:e,multiaddr:t.bytes})))}async function by(e,t,n,r){if(null==t)throw new k("Invalid PeerData",hy.ERR_INVALID_PARAMETERS);if(null!=t.publicKey&&null!=e.publicKey&&!oe(t.publicKey,e.publicKey))throw new k("publicKey bytes do not match peer id publicKey bytes",hy.ERR_INVALID_PARAMETERS);const s=r.existingPeer;if(null!=s&&!e.equals(s.id))throw new k("peer id did not match existing peer id",hy.ERR_INVALID_PARAMETERS);let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,l=s?.peerRecordEnvelope;if("patch"===n&&(null==t.multiaddrs&&null==t.addresses||(i=[],null!=t.multiaddrs&&i.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&i.push(...t.addresses)),null!=t.protocols&&(o=new Set(t.protocols)),null!=t.metadata&&(a=Ey(t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata),{validate:vy})),null!=t.tags&&(c=Ey(t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),{validate:Sy,map:_y})),null!=t.peerRecordEnvelope&&(l=t.peerRecordEnvelope)),"merge"===n){if(null!=t.multiaddrs&&i.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&i.push(...t.addresses),null!=t.protocols&&(o=new Set([...o,...t.protocols])),null!=t.metadata){const e=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[t,n]of e)null==n?a.delete(t):a.set(t,n);a=Ey([...a.entries()],{validate:vy})}if(null!=t.tags){const e=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),n=new Map(c);for(const[t,r]of e)null==r?n.delete(t):n.set(t,r);c=Ey([...n.entries()],{validate:Sy,map:_y})}null!=t.peerRecordEnvelope&&(l=t.peerRecordEnvelope)}const u={addresses:await wy(e,r.addressFilter??(async()=>!0),i),protocols:[...o.values()].sort(((e,t)=>e.localeCompare(t))),metadata:a,tags:c,publicKey:s?.id.publicKey??t.publicKey??e.publicKey,peerRecordEnvelope:l};return"RSA"!==e.type&&delete u.publicKey,u}function Ey(e,t){const n=new Map;for(const[n,r]of e)null!=r&&t.validate(n,r);for(const[r,s]of e.sort((([e],[t])=>e.localeCompare(t))))null!=s&&n.set(r,t.map?.(r,s)??s);return n}function vy(e,t){if("string"!=typeof e)throw new k("Metadata key must be a string",hy.ERR_INVALID_PARAMETERS);if(!(t instanceof Uint8Array))throw new k("Metadata value must be a Uint8Array",hy.ERR_INVALID_PARAMETERS)}function Sy(e,t){if("string"!=typeof e)throw new k("Tag name must be a string",hy.ERR_INVALID_PARAMETERS);if(null!=t.value){if(parseInt(`${t.value}`,10)!==t.value)throw new k("Tag value must be an integer",hy.ERR_INVALID_PARAMETERS);if(t.value<0||t.value>100)throw new k("Tag value must be between 0-100",hy.ERR_INVALID_PARAMETERS)}if(null!=t.ttl){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new k("Tag ttl must be an integer",hy.ERR_INVALID_PARAMETERS);if(t.ttl<0)throw new k("Tag ttl must be between greater than 0",hy.ERR_INVALID_PARAMETERS)}}function _y(e,t){let n;return null!=t.expiry&&(n=t.expiry),null!=t.ttl&&(n=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:n}}function Ry(e,t,n){const r=e.toString().split("/")[2],s=Dr(mt.decode(r)),i=n.get(s);if(null!=i)return i;const o=gy(s,t);return n.set(s,o),o}class ky{peerId;datastore;lock;addressFilter;constructor(e,t={}){this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=Al({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(my(e))}async delete(e){if(this.peerId.equals(e))throw new k("Cannot delete self peer",hy.ERR_INVALID_PARAMETERS);await this.datastore.delete(my(e))}async load(e){return gy(e,await this.datastore.get(my(e)))}async save(e,t){const{existingBuf:n,existingPeer:r}=await this.#U(e),s=await by(e,t,"patch",{addressFilter:this.addressFilter});return this.#F(e,s,n,r)}async patch(e,t){const{existingBuf:n,existingPeer:r}=await this.#U(e),s=await by(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:r});return this.#F(e,s,n,r)}async merge(e,t){const{existingBuf:n,existingPeer:r}=await this.#U(e),s=await by(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:r});return this.#F(e,s,n,r)}async*all(e){const t=new Pr;for await(const{key:n,value:r}of this.datastore.query(function(e,t){return null==e?{}:{prefix:yy,filters:(e.filters??[]).map((e=>({key:n,value:r})=>e(Ry(n,r,t)))),orders:(e.orders??[]).map((e=>(n,r)=>e(Ry(n.key,n.value,t),Ry(r.key,r.value,t))))}}(e??{},t))){const e=Ry(n,r,t);e.id.equals(this.peerId)||(yield e)}}async#U(e){try{const t=await this.datastore.get(my(e));return{existingBuf:t,existingPeer:gy(e,t)}}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return{}}async#F(e,t,n,r){const s=dy.encode(t);return null!=n&&oe(s,n)?{peer:gy(e,s),previous:r,updated:!1}:(await this.datastore.put(my(e),s),{peer:gy(e,s),previous:r,updated:!0})}}class Ay{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new ky(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){this.log.trace("forEach await read lock");const n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const n of this.store.all(t))e(n)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await oa(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const n=await this.store.save(e,t);return this.#$(e,n),n.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");const n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const n=await this.store.patch(e,t);return this.#$(e,n),n.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");const n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const n=await this.store.merge(e,t);return this.#$(e,n),n.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){const n=await oy.openAndCertify(e,uy.DOMAIN);if(!1===t?.equals(n.peerId))return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,n.peerId),!1;const r=uy.createFromProtobuf(n.payload);let s;try{s=await this.get(n.peerId)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=s?.peerRecordEnvelope){const e=await oy.createFromProtobuf(s.peerRecordEnvelope),t=uy.createFromProtobuf(e.payload);if(t.seqNumber>=r.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,r.seqNumber),!1}return await this.patch(r.peerId,{peerRecordEnvelope:e,addresses:r.multiaddrs.map((e=>({isCertified:!0,multiaddr:e})))}),!0}#$(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}const Iy=e=>e;function Ty(e,t){const n=e.getPeerId();return null!=n&&xr(n).equals(t)&&(e=e.decapsulate(ei(`/p2p/${t.toString()}`))),e}class xy{log;components;listen;announce;observed;announceFilter;constructor(e,t={}){const{listen:n=[],announce:r=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map((e=>e.toString())),this.announce=new Set(r.map((e=>e.toString()))),this.observed=new Map,this.announceFilter=t.announceFilter??Iy,this._updatePeerStoreAddresses=function(e){let t;return function(){clearTimeout(t),t=setTimeout((function(){t=void 0,e()}),1e3)}}(this._updatePeerStoreAddresses.bind(this)),e.events.addEventListener("transport:listening",(()=>{this._updatePeerStoreAddresses()})),e.events.addEventListener("transport:close",(()=>{this._updatePeerStoreAddresses()}))}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter((([e,t])=>t.confident)).map((([e])=>ei(e)))).map((e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e));this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch((e=>{this.log.error("error updating addresses",e)}))}getListenAddrs(){return Array.from(this.listen).map((e=>ei(e)))}getAnnounceAddrs(){return Array.from(this.announce).map((e=>ei(e)))}getObservedAddrs(){return Array.from(this.observed).map((([e])=>ei(e)))}addObservedAddr(e){const t=(e=Ty(e,this.components.peerId)).toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){const t=(e=Ty(e,this.components.peerId)).toString(),n=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),n||this._updatePeerStoreAddresses()}removeObservedAddr(e){const t=(e=Ty(e,this.components.peerId)).toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map((e=>e.toString()));0===e.length&&(e=this.components.transportManager.getAddrs().map((e=>e.toString()))),e=e.concat(Array.from(this.observed).filter((([e,t])=>t.confident)).map((([e])=>e)));const t=new Set(e);return this.announceFilter(Array.from(t).map((e=>ei(e)))).map((e=>!0===e.protos().pop()?.path||e.getPeerId()===this.components.peerId.toString()?e:e.encapsulate(`/p2p/${this.components.peerId.toString()}`)))}}class Dy{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;null==this.components.logger&&(this.components.logger=Xo())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter((e=>da(e))).map((async t=>{await(t[e]?.())})))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const Cy=["metrics","connectionProtector","dns"],Ny=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Py(e){return Array.isArray(e?.[zg])?e[zg]:[]}function Ly(e){return Array.isArray(e?.[Hg])?e[Hg]:[]}function By(e){return e?.[Symbol.toStringTag]??e?.toString()??"unknown"}function Oy(e={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{const t=e.stringTuples();return(4===t[0][0]||41===t[0][0])&&Boolean(Rs(`${t[0][1]}`))},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...e}}const My=Symbol.for("@libp2p/transport");var Uy;function Fy(e){try{const{address:t}=e.nodeAddress();return Boolean(Rs(t))}catch{return!0}}function $y(e,t){const n=function(e,t){const n=Fy(e.multiaddr),r=Fy(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==n)return n;const r=function(e,t){const n=Bi.exactMatch(e.multiaddr),r=Bi.exactMatch(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==r)return r;const s=function(e,t){return e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}(e,t);return s}!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(Uy||(Uy={}));const{code:Vy}=Ns("dnsaddr");class zy extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const Hy=async function(e,t={}){const n=t.maxRecursiveDepth??32;if(0===n)throw new zy("Max recursive depth reached");const[,r]=e.stringTuples().find((([e])=>e===Vy))??[],s=t?.dns??Ca(),i=await s.query(`_dnsaddr.${r}`,{signal:t?.signal,types:[Ia.TXT]}),o=e.getPeerId(),a=[];for(const e of i.Answer){const r=e.data.replace(/["']/g,"").trim().split("=")[1];if(null==r)continue;if(null!=o&&!r.includes(o))continue;const s=ei(r);if(r.startsWith("/dnsaddr")){const e=await s.resolve({...t,maxRecursiveDepth:n-1});a.push(...e.map((e=>e.toString())))}else a.push(s.toString())}return a};var Ky,qy;!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(Ky||(Ky={})),function(e){e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",e.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"}(qy||(qy={}));const Wy={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{resolvers:{dnsaddr:Hy},addressSorter:$y},transportManager:{faultTolerance:Uy.FATAL_ALL}},jy=()=>{const e=new Error("Delay aborted");return e.name="AbortError",e},Gy=new WeakMap,Yy=function({clearTimeout:e,setTimeout:t}={}){return(n,{value:r,signal:s}={})=>{if(s?.aborted)return Promise.reject(jy());let i,o,a;const c=e??clearTimeout,l=()=>{c(i),a(jy())},u=new Promise(((e,c)=>{o=()=>{s&&s.removeEventListener("abort",l),e(r)},a=c,i=(t??setTimeout)(o,n)}));return s&&s.addEventListener("abort",l,{once:!0}),Gy.set(u,(()=>{c(i),i=null,o()})),u}}();class Qy{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??1e3*this.duration/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new Jy}async consume(e,t=1,n={}){const r=this.getKey(e),s=this._getKeySecDuration(n);let i=this.memoryStorage.incrby(r,t,s);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+t&&(i=this.memoryStorage.set(r,i.consumedPoints,this.blockDuration)),new k("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",i);if(this.execEvenly&&i.msBeforeNext>0&&!i.isFirstInDuration){let e=Math.ceil(i.msBeforeNext/(i.remainingPoints+2));e<this.execEvenlyMinDelayMs&&(e=i.consumedPoints*this.execEvenlyMinDelayMs),await Yy(e)}return i}penalty(e,t=1,n={}){const r=this.getKey(e),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(r,t,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(e,t=1,n={}){const r=this.getKey(e),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(r,-t,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(e,t){const n=1e3*t,r=this.points+1;return this.memoryStorage.set(this.getKey(e),r,t),{remainingPoints:0,msBeforeNext:0===n?-1:n,consumedPoints:r,isFirstInDuration:!1}}set(e,t,n=0){const r=1e3*(n>=0?n:this.duration);return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return null!=t&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return null!=e?.customDuration&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class Jy{storage;constructor(){this.storage=new Map}incrby(e,t,n){const r=this.storage.get(e);if(null!=r){const s=null!=r.expiresAt?r.expiresAt.getTime()-(new Date).getTime():-1;return null==r.expiresAt||s>0?(r.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:r.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const r=1e3*n,s=this.storage.get(e);null!=s&&clearTimeout(s.timeoutId);const i={value:t,expiresAt:r>0?new Date(Date.now()+r):void 0};return this.storage.set(e,i),r>0&&(i.timeoutId=setTimeout((()=>{this.storage.delete(e)}),r),null!=i.timeoutId.unref&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:i.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(null!=t)return{remainingPoints:0,msBeforeNext:null!=t.expiresAt?t.expiresAt.getTime()-(new Date).getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return null!=t&&(null!=t.timeoutId&&clearTimeout(t.timeoutId),this.storage.delete(e),!0)}}function Xy(e){if(yr(e))return{peerId:e,multiaddrs:[]};let t;if(Array.isArray(e)||(e=[e]),e.length>0){const n=e[0].getPeerId();t=null==n?void 0:xr(n),e.forEach((e=>{if(!Zs(e))throw new k("Invalid Multiaddr",qy.ERR_INVALID_MULTIADDR);const n=e.getPeerId();if(null==n){if(null!=t)throw new k("Multiaddrs must all have the same peer id or have no peer id",qy.ERR_INVALID_PARAMETERS)}else{const e=xr(n);if(!0!==t?.equals(e))throw new k("Multiaddrs must all have the same peer id or have no peer id",qy.ERR_INVALID_PARAMETERS)}}))}return{peerId:t,multiaddrs:e}}const Zy=42e4,em="last-dial-failure",tm=5,nm=100,rm=25,sm=0,im=5e3,om=Zy,am=10;class cm{connectionManager;peerStore;queue;minConnections;autoDialPriority;autoDialIntervalMs;autoDialMaxQueueLength;autoDialPeerRetryThresholdMs;autoDialDiscoveredPeersDebounce;autoDialInterval;started;running;log;constructor(e,t){let n;this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??tm,this.autoDialPriority=t.autoDialPriority??sm,this.autoDialIntervalMs=t.autoDialInterval??im,this.autoDialMaxQueueLength=t.maxQueueLength??nm,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??om,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??am,this.log=e.logger.forComponent("libp2p:connection-manager:auto-dial"),this.started=!1,this.running=!1,this.queue=new V({concurrency:t.autoDialConcurrency??rm,metricName:"libp2p_autodial_queue",metrics:e.metrics}),this.queue.addEventListener("error",(e=>{this.log.error("error during auto-dial",e.detail)})),e.events.addEventListener("connection:close",(()=>{this.autoDial().catch((e=>{this.log.error(e)}))})),e.events.addEventListener("peer:discovery",(()=>{clearTimeout(n),n=setTimeout((()=>{this.autoDial().catch((e=>{this.log.error(e)}))}),this.autoDialDiscoveredPeersDebounce)}))}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.autoDial().catch((e=>{this.log.error("error while autodialing",e)}))}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started||this.running)return;const e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections)return void(this.minConnections>0&&this.log.trace("have enough connections %d/%d",t,this.minConnections));if(this.queue.size>this.autoDialMaxQueueLength)return this.log("not enough connections %d/%d but auto dial queue is full",t,this.minConnections),void this.sheduleNextAutodial();this.running=!0,this.log("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);const n=new ry(this.connectionManager.getDialQueue().map((e=>e.peerId)).filter(Boolean)),r=await this.peerStore.all({filters:[t=>0===t.addresses.length?(this.log.trace("not autodialing %p because they have no addresses",t.id),!1):e.has(t.id)?(this.log.trace("not autodialing %p because they are already connected",t.id),!1):n.has(t.id)?(this.log.trace("not autodialing %p because they are already being dialed",t.id),!1):!this.queue.has(t.id)||(this.log.trace("not autodialing %p because they are already being autodialed",t.id),!1)]}),s=r.sort((()=>Math.random()>.5?1:-1)),i=new Pr;for(const e of s)i.has(e.id)||i.set(e.id,[...e.tags.values()].reduce(((e,t)=>e+t.value),0));const o=s.sort(((e,t)=>{const n=i.get(e.id)??0,r=i.get(t.id)??0;return n>r?-1:n<r?1:0})).filter((e=>{const t=e.metadata.get(em);if(null==t)return!0;const n=parseInt(mr(t));return!!isNaN(n)||Date.now()-n>this.autoDialPeerRetryThresholdMs}));this.log("selected %d/%d peers to dial",o.length,r.length);for(const e of o)this.queue.add((async()=>{const t=this.connectionManager.getConnectionsMap().size;if(t>=this.minConnections)return this.log("got enough connections now %d/%d",t,this.minConnections),void this.queue.clear();this.log("connecting to a peerStore stored peer %p",e.id),await this.connectionManager.openConnection(e.id,{priority:this.autoDialPriority})}),{peerId:e.id}).catch((e=>{this.log.error("could not connect to peerStore stored peer",e)}));this.running=!1,this.sheduleNextAutodial()}sheduleNextAutodial(){this.started&&(this.autoDialInterval=setTimeout((()=>{this.autoDial().catch((e=>{this.log.error("error while autodialing",e)}))}),this.autoDialIntervalMs))}}const lm=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"],um={maxConnections:100,allow:[]};class hm{maxConnections;connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??um.maxConnections,this.allow=t.allow??um.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),e.events.addEventListener("connection:open",(()=>{this.maybePruneConnections().catch((e=>{this.log.error(e)}))}))}async maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;const n=new Pr;for(const t of e){const e=t.remotePeer;if(!n.has(e)){n.set(e,0);try{const t=await this.peerStore.get(e);n.set(e,[...t.tags.values()].reduce(((e,t)=>e+t.value),0))}catch(e){"ERR_NOT_FOUND"!==e.code&&this.log.error("error loading peer tags",e)}}}const r=this.sortConnections(e,n),s=Math.max(t-this.maxConnections,0),i=[];for(const e of r)if(this.log("too many connections open - closing a connection to %p",e.remotePeer),this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString())))||i.push(e),i.length===s)break;await Promise.all(i.map((async e=>{await async function(e,t){const n=e?.streams?.map((e=>e.protocol))??[],r=t?.closableProtocols??lm;if(!(n.filter((e=>null!=e&&!r.includes(e))).length>0))try{await(e?.close(t))}catch(t){e?.abort(t)}}(e,{signal:AbortSignal.timeout(1e3)})}))),this.events.safeDispatchEvent("connection:prune",{detail:i})}sortConnections(e,t){return e.sort(((e,t)=>{const n=e.timeline.open,r=t.timeline.open;return n<r?1:n>r?-1:0})).sort(((e,t)=>"outbound"===e.direction&&"inbound"===t.direction?1:"inbound"===e.direction&&"outbound"===t.direction?-1:0)).sort(((e,t)=>e.streams.length>t.streams.length?1:e.streams.length<t.streams.length?-1:0)).sort(((e,n)=>{const r=t.get(e.remotePeer)??0,s=t.get(n.remotePeer)??0;return r>s?1:r<s?-1:0}))}}class dm extends ${constructor(e={}){super({...e,sort:(e,t)=>e.options.priority>t.options.priority?-1:e.options.priority<t.options.priority?1:0})}}const fm={addressSorter:$y,maxParallelDials:50,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:5e3,resolvers:{dnsaddr:Hy}};class pm{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter??fm.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??fm.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??fm.maxDialQueueLength,this.dialTimeout=t.dialTimeout??fm.dialTimeout,this.connections=t.connections??new Pr,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[e,n]of Object.entries(t.resolvers??{}))Xs.set(e,n);this.queue=new dm({concurrency:t.maxParallelDials??fm.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",(e=>{this.log.error("error in dial queue",e.detail)}))}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:r}=Xy(e),s=Array.from(this.connections.values()).flat().find((e=>!0!==t.force&&(!!e.remotePeer.equals(n)||r.find((t=>t.equals(e.remoteAddr))))));if(null!=s)return this.log("already connected to %a",s.remoteAddr),t.onProgress?.(new Ce("dial-queue:already-connected")),s;const i=this.queue.queue.find((e=>{if(!0===n?.equals(e.options.peerId))return!0;const t=e.options.multiaddrs;if(null==t)return!1;for(const e of r)if(t.has(e.toString()))return!0;return!1}));if(null!=i){this.log("joining existing dial target for %p",n);for(const e of r)i.options.multiaddrs.add(e.toString());return t.onProgress?.(new Ce("dial-queue:already-in-dial-queue")),i.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new k("Dial queue is full","ERR_DIAL_QUEUE_FULL");return this.log("creating dial target for %p",n,r.map((e=>e.toString()))),t.onProgress?.(new Ce("dial-queue:add-to-dial-queue")),this.queue.add((async e=>{e?.onProgress?.(new Ce("dial-queue:start-dial"));const t=this.createDialAbortController(e?.signal);let r;try{r=await this.calculateMultiaddrs(n,e?.multiaddrs,{...e,signal:t}),e?.onProgress?.(new Ce("dial-queue:calculated-addresses",r)),r.map((({multiaddr:e})=>e.toString())).forEach((t=>{e?.multiaddrs.add(t)}))}catch(e){throw t.clear(),e}try{let s=0;const i=[];for(const o of r){if(s===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",s,n),new k("Peer had more than maxPeerAddrsToDial",qy.ERR_TOO_MANY_ADDRESSES);s++;try{const n=await this.components.transportManager.dial(o.multiaddr,{...e,signal:t});return this.log("dial to %a succeeded",o.multiaddr),n}catch(e){if(this.log.error("dial failed to %a",o.multiaddr,e),null!=n)try{await this.components.peerStore.patch(n,{metadata:{[em]:Ln(Date.now().toString())}})}catch(e){this.log.error("could not update last dial failure key for %p",n,e)}if(t.aborted)throw new k(e.message,I);i.push(e)}}if(1===i.length)throw i[0];throw new A(i,"All multiaddr dials failed",qy.ERR_TRANSPORT_DIAL_FAILED)}finally{t.clear()}}),{peerId:n,priority:t.priority??gm,multiaddrs:new Set(r.map((e=>e.toString()))),signal:t.signal,onProgress:t.onProgress})}createDialAbortController(e){return v([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e])}async calculateMultiaddrs(e,t=new Set,n={}){const r=[...t].map((e=>({multiaddr:ei(e),isCertified:!1})));if(null!=e){if(this.components.peerId.equals(e))throw new k("Tried to dial self",qy.ERR_DIALED_SELF);if(!0===await(this.components.connectionGater.denyDialPeer?.(e)))throw new k("The dial request is blocked by gater.allowDialPeer",qy.ERR_PEER_DIAL_INTERCEPTED);if(0===r.length){this.log("loading multiaddrs for %p",e);try{const t=await this.components.peerStore.get(e);r.push(...t.addresses),this.log("loaded multiaddrs for %p",e,r.map((({multiaddr:e})=>e.toString())))}catch(e){if(e.code!==qy.ERR_NOT_FOUND)throw e}}if(0===r.length){this.log("looking up multiaddrs for %p in the peer routing",e);try{const t=await this.components.peerRouting.findPeer(e);this.log("found multiaddrs for %p in the peer routing",e,r.map((({multiaddr:e})=>e.toString()))),r.push(...t.multiaddrs.map((e=>({multiaddr:e,isCertified:!1}))))}catch(t){t.code!==qy.ERR_NO_ROUTERS_AVAILABLE&&this.log.error("looking up multiaddrs for %p in the peer routing failed",e,t)}}}let s=(await Promise.all(r.map((async e=>{const t=await async function(e,t){let n=!1;for(const t of Xs.keys())if(n=e.protoNames().includes(t),n)break;if(!n)return[e];const r=await e.resolve(t);return t.log("resolved %s to",e,r.map((e=>e.toString()))),r}(e.multiaddr,{dns:this.components.dns,...n,log:this.log});return 1===t.length&&t[0].equals(e.multiaddr)?e:t.map((e=>({multiaddr:e,isCertified:!1})))})))).flat();if(null!=e){const t=`/p2p/${e.toString()}`;s=s.map((e=>{const n=e.multiaddr.protos().pop();return!0===n?.path?e:null==e.multiaddr.getPeerId()?{multiaddr:e.multiaddr.encapsulate(t),isCertified:e.isCertified}:e}))}const i=s.filter((t=>{if(null==this.components.transportManager.dialTransportForMultiaddr(t.multiaddr))return!1;const n=t.multiaddr.getPeerId();return null==e||null==n||e.equals(n)})),o=new Map;for(const e of i){const t=e.multiaddr.toString(),n=o.get(t);null==n?o.set(t,e):n.isCertified=n.isCertified||e.isCertified||!1}const a=[...o.values()];if(0===a.length)throw new k("The dial request has no valid addresses",qy.ERR_NO_VALID_ADDRESSES);const c=[];for(const e of a)null!=this.components.connectionGater.denyDialMultiaddr&&await this.components.connectionGater.denyDialMultiaddr(e.multiaddr)||c.push(e);const l=c.sort(this.addressSorter);if(0===l.length)throw new k("The connection gater denied all addresses in the dial request",qy.ERR_NO_VALID_ADDRESSES);return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map((({multiaddr:e})=>e.toString()))),this.log.trace("addresses for %p after filtering",e??"unknown peer",l.map((({multiaddr:e})=>e.toString()))),l}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map((e=>e.toString()))),t);return!1!==t.runOnTransientConnection||null!=n.find((e=>!Bi.matches(e.multiaddr)))}catch(e){this.log.trace("error calculating if multiaddr(s) were dialable",e)}return!1}}const gm=50,ym=5,mm=100,wm=5,bm=10,Em=25,vm=0,Sm=100,_m=Zy,Rm=10;class km{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;maxConnections;dialQueue;autoDial;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??mm;const n=t.minConnections??ym;if(this.maxConnections<n)throw new k("Connection Manager maxConnections must be greater than minConnections",qy.ERR_INVALID_PARAMETERS);this.connections=new Pr,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map((e=>ei(e))),this.deny=(t.deny??[]).map((e=>ei(e))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??bm,this.inboundConnectionRateLimiter=new Qy({points:t.inboundConnectionThreshold??wm,duration:1}),this.autoDial=new cm({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{minConnections:n,autoDialConcurrency:t.autoDialConcurrency??Em,autoDialPriority:t.autoDialPriority??vm,autoDialPeerRetryThreshold:t.autoDialPeerRetryThreshold??_m,autoDialDiscoveredPeersDebounce:t.autoDialDiscoveredPeersDebounce??Rm,maxQueueLength:t.autoDialMaxQueueLength??Sm}),this.connectionPruner=new hm({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new pm(e,{addressSorter:t.addressSorter??$y,maxParallelDials:t.maxParallelDials??50,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??5e3,resolvers:t.resolvers??{dnsaddr:Hy},connections:this.connections})}[Symbol.toStringTag]="@libp2p/connection-manager";isStarted(){return this.started}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)"inbound"===n.direction?e.inbound++:e.outbound++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const t of n.streams){const n=`${t.direction} ${t.protocol??"unnegotiated"}`;e[n]=(e[n]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t){const t={};for(const e of n.streams){const n=`${e.direction} ${e.protocol??"unnegotiated"}`;t[n]=(t[n]??0)+1}for(const[n,r]of Object.entries(t))e[n]=e[n]??[],e[n].push(r)}const t={};for(let[n,r]of Object.entries(e)){r=r.sort(((e,t)=>e-t));const e=Math.floor(.9*r.length);t[n]=r[e]}return t}}),this.dialQueue.start(),this.autoDial.start(),this.started=!0,this.log("started")}async afterStart(){Promise.resolve().then((async()=>{const e=await this.peerStore.all({filters:[e=>e.tags.has("keep-alive")]});await Promise.all(e.map((async e=>{await this.openConnection(e.id).catch((e=>{this.log.error(e)}))})))})).catch((e=>{this.log.error(e)})),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(e){this.log.error(e)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}onConnect(e){this._onConnect(e).catch((e=>{this.log.error(e)}))}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();const n=t.remotePeer,r=this.connections.get(n);let s=!1;null!=r?r.push(t):(s=!0,this.connections.set(n,[t])),null!=n.publicKey&&"RSA"===n.type&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer;let r=this.connections.get(n);null!=r&&r.length>1?(r=r.filter((e=>e.id!==t.id)),this.connections.set(n,r)):null!=r&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(null!=e)return this.connections.get(e)??[];let t=[];for(const e of this.connections.values())t=t.concat(e);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.isStarted())throw new k("Not started",qy.ERR_NODE_NOT_STARTED);t.signal?.throwIfAborted();const{peerId:n}=Xy(e);if(null!=n&&!0!==t.force){this.log("dial %p",n);const e=this.getConnections(n).find((e=>!e.transient));if(null!=e)return this.log("had an existing non-transient connection to %p",n),t.onProgress?.(new Ce("dial-queue:already-connected")),e}const r=await this.dialQueue.dial(e,{...t,priority:t.priority??gm});let s=this.connections.get(r.remotePeer);null==s&&(s=[],this.connections.set(r.remotePeer,s));let i=!1;for(const e of s)e.id===r.id&&(i=!0);return i||s.push(r),r}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map((async e=>{try{await e.close(t)}catch(t){e.abort(t)}})))}async acceptIncomingConnection(e){if(this.deny.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,t),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map((t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map((e=>ei(e)))})))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class Am{movingAverage;variance;deviation;forecast;timespan;previousTime;constructor(e){this.timespan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timespan)}push(e,t=Date.now()){if(null!=this.previousTime){const n=this.alpha(t,this.previousTime),r=e-this.movingAverage,s=n*r;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+r*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*r}else this.movingAverage=e;this.previousTime=t}}class Im{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;constructor(e={}){this.success=new Am(e.interval??5e3),this.failure=new Am(e.interval??5e3),this.next=new Am(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??2,this.timeoutMultiplier=e.timeoutMultiplier??1.2,this.minTimeout=e.minTimeout??2e3,null!=e.metricName&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){const t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),n=AbortSignal.timeout(t),r=v([e.signal,n]);return r.start=Date.now(),r.timeout=t,r}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class Tm{readNext;haveNext;ended;nextResult;constructor(){this.ended=!1,this.readNext=x(),this.haveNext=x()}[Symbol.asyncIterator](){return this}async next(){if(null==this.nextResult&&await this.haveNext.promise,null==this.nextResult)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=x(),e}async throw(e){return this.ended=!0,null!=e&&(this.haveNext.promise.catch((()=>{})),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){return await this._push(void 0),{done:!0,value:void 0}}async push(e,t){await this._push(e,t)}async end(e,t){null!=e?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(null!=e&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;null!=this.nextResult;)await this.readNext.promise;null!=e?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=x(),await M(this.readNext.promise,t?.signal,t)}}class xm extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}class Dm extends Error{code;constructor(e,t){super(e),this.code=t}}class Cm extends Dm{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted",this.name="AbortError"}}function Nm(e,t){const n=new Tm;e.sink(n).catch((async e=>{await n.end(e)})),e.sink=async e=>{for await(const t of e)await n.push(t);await n.end()};let r=e.source;null!=e.source[Symbol.iterator]?r=e.source[Symbol.iterator]():null!=e.source[Symbol.asyncIterator]&&(r=e.source[Symbol.asyncIterator]());const s=new ue,i={read:async(e,t)=>{let n;t?.signal?.throwIfAborted();const i=new Promise(((e,r)=>{n=()=>{r(new Cm("Read aborted"))},t?.signal?.addEventListener("abort",n)}));try{if(null==e){const{done:e,value:t}=await Promise.race([r.next(),i]);return!0===e?new ue:t}for(;s.byteLength<e;){const{value:e,done:t}=await Promise.race([r.next(),i]);if(!0===t)throw new xm("unexpected end of input");s.append(e)}const t=s.sublist(0,e);return s.consume(e),t}finally{null!=n&&t?.signal?.removeEventListener("abort",n)}},write:async(e,t)=>{t?.signal?.throwIfAborted(),e instanceof Uint8Array?await n.push(e,t):await n.push(e.subarray(),t)},unwrap:()=>{if(s.byteLength>0){const n=e.source;e.source=async function*(){!1===t?.yieldBytes?yield s:yield*s,yield*n}()}return e}};return i}class Pm{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??1e4,this.timeout=new Im({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[zg]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.heartbeatInterval=setInterval((()=>{this.components.connectionManager.getConnections().forEach((e=>{Promise.resolve().then((async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),r=Nm(await e.newStream(this.protocol,{signal:n,runOnTransientConnection:!0}));t=Date.now(),await Promise.all([r.write(ts(32),{signal:n}),r.read(32,{signal:n})]),e.rtt=Date.now()-t,await r.unwrap().close({signal:n})}catch(n){if("ERR_UNSUPPORTED_PROTOCOL"!==n.code)throw n;e.rtt=(Date.now()-t)/2}})).catch((t=>{this.log.error("error during heartbeat, aborting connection",t),e.abort(t)}))}))}),this.pingIntervalMs)}stop(){this.abortController?.abort(),null!=this.heartbeatInterval&&clearInterval(this.heartbeatInterval)}}class Lm{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(0===this.routers.length)throw new k("No content routers available",qy.ERR_NO_ROUTERS_AVAILABLE);const n=this,r=new ry;for await(const s of _e(...n.routers.map((n=>n.findProviders(e,t)))))null!=s&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),r.has(s.id)||(r.add(s.id),yield s))}async provide(e,t={}){if(0===this.routers.length)throw new k("No content routers available",qy.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map((async n=>{await n.provide(e,t)})))}async put(e,t,n){if(!this.isStarted())throw new k(Ky.NOT_STARTED_YET,qy.ERR_NODE_NOT_STARTED);await Promise.all(this.routers.map((async r=>{await r.put(e,t,n)})))}async get(e,t){if(!this.isStarted())throw new k(Ky.NOT_STARTED_YET,qy.ERR_NODE_NOT_STARTED);return Promise.any(this.routers.map((async n=>n.get(e,t))))}}const Bm=64;class Om{fp;h;seed;constructor(e,t,n,r=2){if(r>Bm)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,n),i=H(r);for(let e=0;e<i.length;e++)i[e]=s[e];0===i.length&&(i[0]=7),this.fp=i,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array&&oe(this.fp,e.fp)}}function Mm(e,t){return Math.floor(Math.random()*(t-e))+e}class Um{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Om))throw new TypeError("Invalid Fingerprint");return this.contents.some((t=>e.equals(t)))}add(e){if(!(e instanceof Om))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(null==this.contents[t])return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Om))throw new TypeError("Invalid Fingerprint");const t=Mm(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof Om))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex((t=>e.equals(t)));return t>-1&&(this.contents[t]=null,!0)}}const Fm={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},$m={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Vm=new globalThis.TextEncoder;const zm={hash:e=>Number(function(e,{size:t=32,utf8Buffer:n}={}){if(!Fm[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if("string"==typeof e){if(n)return function(e,t,n){if(0===n.length)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=Fm[t];let s=$m[t],i=e;for(;i.length>0;){const e=Vm.encodeInto(i,n);i=i.slice(e.read);for(let i=0;i<e.written;i++)s^=BigInt(n[i]),s=BigInt.asUintN(t,s*r)}return s}(e,t,n);e=Vm.encode(e)}return function(e,t){const n=Fm[t];let r=$m[t];for(let s=0;s<e.length;s++)r^=BigInt(e[s]),r=BigInt.asUintN(t,r*n);return r}(e,t)}(e,{size:32})),hashV:(e,t)=>function(e){let t=e.toString(16);return t.length%2==1&&(t=`0${t}`),Ln(t,"base16")}(zm.hash(e,t))};class Hm{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??zm,this.seed=e.seed??Mm(0,Math.pow(2,10))}add(e){"string"==typeof e&&(e=Ln(e));const t=new Om(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,r=(n^t.hash())%this.filterSize;if(null==this.buckets[n]&&(this.buckets[n]=new Um(this.bucketSize)),null==this.buckets[r]&&(this.buckets[r]=new Um(this.bucketSize)),this.buckets[n].add(t)||this.buckets[r].add(t))return this.count++,!0;const s=[n,r];let i=s[Mm(0,s.length-1)];null==this.buckets[i]&&(this.buckets[i]=new Um(this.bucketSize));for(let e=0;e<500;e++){const e=this.buckets[i].swap(t);if(null!=e&&(i=(i^e.hash())%this.filterSize,null==this.buckets[i]&&(this.buckets[i]=new Um(this.bucketSize)),this.buckets[i].add(e)))return this.count++,!0}return!1}has(e){"string"==typeof e&&(e=Ln(e));const t=new Om(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[n]?.has(t)??!1;if(r)return r;const s=(n^t.hash())%this.filterSize;return this.buckets[s]?.has(t)??!1}remove(e){"string"==typeof e&&(e=Ln(e));const t=new Om(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[n]?.remove(t)??!1;if(r)return this.count--,r;const s=(n^t.hash())%this.filterSize,i=this.buckets[s]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}}const Km={1:.5,2:.84,4:.95,8:.98};function qm(e,t=.001){const n=function(e=.001){return e>.002?2:e>1e-5?4:8}(t),r=Km[n];return{filterSize:Math.round(e/r),bucketSize:n,fingerprintSize:Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*n)),Bm)}}class Wm{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??zm,this.seed=e.seed??Mm(0,Math.pow(2,10)),this.filterSeries=[new Hm({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if("string"==typeof e&&(e=Ln(e)),this.has(e))return!0;let t=this.filterSeries.find((e=>e.reliable));if(null==t){const e=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Hm({filterSize:e,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){"string"==typeof e&&(e=Ln(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){"string"==typeof e&&(e=Ln(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce(((e,t)=>e+t.count),0)}}function jm(e,t=.001,n){return new Wm({...qm(e,t),...n??{}})}const Gm=globalThis.CustomEvent??Event;async function*Ym(e,t={}){let n=t.concurrency??1/0;n<1&&(n=1/0);const r=null!=t.ordered&&t.ordered,s=new EventTarget,i=[];let o,a=x(),c=x(),l=!1,u=!1;function h(){return r?i[0]?.done:Boolean(i.find((e=>e.done)))}function*d(){for(;i.length>0&&i[0].done;){const e=i[0];if(i.shift(),!e.ok)throw u=!0,a.resolve(),e.err;yield e.value,a.resolve()}}function*f(){for(;h();)for(let e=0;e<i.length;e++)if(i[e].done){const t=i[e];if(i.splice(e,1),e--,!t.ok)throw u=!0,a.resolve(),t.err;yield t.value,a.resolve()}}for(s.addEventListener("task-complete",(()=>{c.resolve()})),Promise.resolve().then((async()=>{try{for await(const t of e){if(i.length===n&&(a=x(),await a.promise),u)break;const e={done:!1};i.push(e),t().then((t=>{e.done=!0,e.ok=!0,e.value=t,s.dispatchEvent(new Gm("task-complete"))}),(t=>{e.done=!0,e.err=t,s.dispatchEvent(new Gm("task-complete"))}))}l=!0,s.dispatchEvent(new Gm("task-complete"))}catch(e){o=e,s.dispatchEvent(new Gm("task-complete"))}}));;){if(h()||(c=x(),await c.promise),null!=o)throw o;if(r?yield*d():yield*f(),l&&0===i.length)break}}class Qm{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[]}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(0===this.routers.length)throw new k("No peer routers available",qy.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.peerId.toString())throw new k("Should not try to find self",qy.ERR_FIND_SELF);const n=this,r=_e(...this.routers.map((r=>async function*(){try{yield await r.findPeer(e,t)}catch(e){n.log.error(e)}}())));for await(const e of r)if(null!=e)return e.multiaddrs.length>0&&await this.peerStore.merge(e.id,{multiaddrs:e.multiaddrs}),e;throw new k(Ky.NOT_FOUND,qy.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new k("No peer routers available",qy.ERR_NO_ROUTERS_AVAILABLE);const n=this,r=jm(1024);for await(const s of Ym(async function*(){const r=_e(...n.routers.map((n=>n.getClosestPeers(e,t))));for await(let e of r)yield async()=>{if(0===e.multiaddrs.length)try{e=await n.findPeer(e.id,{...t,useCache:!1})}catch(e){return void n.log.error("could not find peer multiaddrs",e)}return e}}()))null!=s&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),r.has(s.id.toBytes())||(r.add(s.id.toBytes()),yield s))}}class Jm extends S{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=v([this.shutdownController.signal,e?.signal]);try{for(;;){this.needNext?.resolve(),this.needNext=x();const e=await B(this,"walk:peer",t,{errorEvent:"walk:error"});yield e.detail}}finally{t.clear(),this.walkers--,0===this.walkers&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=v([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then((async()=>{for(this.log("start walk");this.walkers>0;)try{const t=ts(32);let r=Date.now();for await(const s of this.peerRouting.getClosestPeers(t,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",s.id,Date.now()-r,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:s}),1===this.walkers&&null!=this.needNext&&(this.log("wait for need next"),await M(this.needNext.promise,e)),r=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",t,this.walkers,n)}catch(e){this.log.error("randomwalk errored",e),this.safeDispatchEvent("walk:error",{detail:e})}this.log("no walkers left, ended walk")})).catch((e=>{this.log.error("randomwalk errored",e)})).finally((()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1}))}}class Xm{log;topologies;handlers;components;constructor(e){this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw new k(`No handler registered for protocol ${e}`,qy.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new k(`Handler already registered for protocol ${e}`,qy.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const r=Kg.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},n);this.handlers.set(e,{handler:t,options:r}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach((e=>{this.handlers.delete(e)})),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(null==t)throw new k("invalid topology",qy.ERR_INVALID_PARAMETERS);const n=`${(1e9*Math.random()).toString(36)}${Date.now()}`;let r=this.topologies.get(e);return null==r&&(r=new Map,this.topologies.set(e,r)),r.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),0===n.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then((e=>{for(const n of e.protocols){const e=this.topologies.get(n);if(null!=e)for(const n of e.values())!1!==n.filter?.has(t)&&(n.filter?.remove(t),n.onDisconnect?.(t))}})).catch((e=>{e.code!==qy.ERR_NOT_FOUND&&this.log.error("could not inform topologies of disconnecting peer %p",t,e)}))}_onPeerUpdate(e){const{peer:t,previous:n}=e.detail,r=(n?.protocols??[]).filter((e=>!t.protocols.includes(e)));for(const e of r){const n=this.topologies.get(e);if(null!=n)for(const e of n.values())!1!==e.filter?.has(t.id)&&(e.filter?.remove(t.id),e.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,r=e.detail.peerId;for(const e of t){const t=this.topologies.get(e);if(null!=t)for(const e of t.values())n.transient&&!0!==e.notifyOnTransient||!0!==e.filter?.has(r)&&(e.filter?.add(r),e.onConnect?.(r,n))}}}class Zm{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=ls({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Uy.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(null==t)throw new k("Transport must have a valid tag",qy.ERR_INVALID_KEY);if(this.transports.has(t))throw new k(`There is already a transport with the tag ${t}`,qy.ERR_DUPLICATE_TRANSPORT);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const t=n.pop();null!=t&&e.push(t.close())}await Promise.all(e),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(null==n)throw new k(`No transport available for address ${String(e)}`,qy.ERR_TRANSPORT_UNAVAILABLE);t?.onProgress?.(new Ce("transport-manager:selected-transport",n[Symbol.toStringTag]));try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(e){throw null==e.code&&(e.code=qy.ERR_TRANSPORT_DIAL_FAILED),e}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new k("Not started",qy.ERR_NODE_NOT_STARTED);if(null==e||0===e.length)return void this.log("no addresses were provided for listening, this node is dial only");const t=[];for(const[n,r]of this.transports.entries()){const s=r.listenFilter(e),i=[];for(const e of s){this.log("creating listener for %s on %a",n,e);const t=r.createListener({upgrader:this.components.upgrader});let s=this.listeners.get(n)??[];null==s&&(s=[],this.listeners.set(n,s)),s.push(t),t.addEventListener("listening",(()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:t})})),t.addEventListener("close",(()=>{const e=s.findIndex((e=>e===t));s.splice(e,1),this.components.events.safeDispatchEvent("transport:close",{detail:t})})),i.push(t.listen(e))}if(0!==i.length){if(null==(await Promise.allSettled(i)).find((e=>"fulfilled"===e.status))&&this.faultTolerance!==Uy.NO_FATAL)throw new k(`Transport (${n}) could not listen on any available address`,qy.ERR_NO_VALID_ADDRESSES)}else t.push(n)}if(t.length===this.transports.size){const e=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===Uy.FATAL_ALL)throw new k(e,qy.ERR_NO_VALID_ADDRESSES);this.log(`libp2p in dial mode only: ${e}`)}}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const e=t.pop();null!=e&&n.push(e.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}class ew extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class tw extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class nw extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function rw(e,t={}){const n=Nm(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=ee(t.maxDataLength));const r=t?.lengthDecoder??se,s=t?.lengthEncoder??re,i={read:async e=>{let s=-1;const i=new ue;for(;;){i.append(await n.read(1,e));try{s=r(i)}catch(e){if(e instanceof RangeError)continue;throw e}if(s<0)throw new ew("Invalid message length");if(null!=t?.maxLengthLength&&i.byteLength>t.maxLengthLength)throw new nw("message length length too long");if(s>-1)break}if(null!=t?.maxDataLength&&s>t.maxDataLength)throw new tw("message length too long");return n.read(s,e)},write:async(e,t)=>{await n.write(new ue(s(e.byteLength),e),t)},writeV:async(e,t)=>{const r=new ue(...e.flatMap((e=>[s(e.byteLength),e])));await n.write(r,t)},unwrap:()=>n.unwrap()};return i}const sw="/multistream/1.0.0",iw=1024,ow=Ln("\n");async function aw(e,t,n){await e.write(t,n)}async function cw(e,t){const n=await async function(e,t){const n=await e.read(t);if(0===n.byteLength||n.get(n.byteLength-1)!==ow[0])throw t.log.error("Invalid mss message - missing newline",n),new k("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return n.sublist(0,-1)}(e,t);return mr(n.subarray())}async function lw(e,t,n){t=Array.isArray(t)?t:[t],n.log.trace("handle: available protocols %s",t);const r=rw(e,{...n,maxDataLength:iw,maxLengthLength:2});for(;;){n.log.trace("handle: reading incoming string");const e=await cw(r,n);if(n.log.trace('handle: read "%s"',e),e!==sw){if(t.includes(e))return n.log.trace('handle: respond with "%s" for "%s"',e,e),await aw(r,Ln(`${e}\n`),n),n.log.trace('handle: responded with "%s" for "%s"',e,e),{stream:r.unwrap(),protocol:e};if("ls"!==e)n.log('handle: respond with "na" for "%s"',e),await aw(r,Ln("na\n"),n),n.log('handle: responded with "na" for "%s"',e);else{const s=new ue(...t.map((e=>fe.single(Ln(`${e}\n`)))),Ln("\n"));n.log.trace('handle: respond with "%s" for %s',t,e),await aw(r,s,n),n.log.trace('handle: responded with "%s" for %s',t,e)}}else n.log.trace('handle: respond with "%s" for "%s"',sw,e),await aw(r,Ln(`${sw}\n`),n),n.log.trace('handle: responded with "%s" for "%s"',sw,e)}}async function uw(e,t,n){if(1===(t=Array.isArray(t)?[...t]:[t]).length&&!1===n.negotiateFully)return function(e,t,n){const r=e.sink.bind(e),s=e.source;let i=!1,o=!1;const a=x();let c=!1,l=!1;const u=x();let h=!1,d=!1;const f=x(),p=rw({sink:r,source:s},{...n,maxDataLength:iw});async function g(){if(o)return n.log.trace("optimistic: already negotiating %s stream",t),void await a.promise;o=!0;try{c||(n.log.trace("optimistic: doing send protocol for %s stream",t),await async function(){if(l)await u.promise;else{l=!0;try{n.log.trace('optimistic: write ["%s", "%s", data] in source',sw,t),await p.writeV([Ln(`${sw}\n`),Ln(`${t}\n`)]),n.log.trace('optimistic: wrote ["%s", "%s", data] in source',sw,t)}finally{c=!0,l=!1,u.resolve()}}}()),h||(n.log.trace("optimistic: doing read protocol for %s stream",t),await async function(){if(d)await f.promise;else{d=!0;try{n.log.trace("optimistic: reading multistream select header");let e=await cw(p,n);if(n.log.trace('optimistic: read multistream select header "%s"',e),e===sw&&(e=await cw(p,n)),n.log.trace('optimistic: read protocol "%s", expecting "%s"',e,t),e!==t)throw new k("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{h=!0,d=!1,f.resolve()}}}())}finally{o=!1,i=!0,a.resolve()}}if(e.sink=async e=>{const{sink:r}=p.unwrap();await r(async function*(){let r=!1;for await(const s of e){if(l&&await u.promise,c)yield s;else{l=!0,n.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',sw,t,s.byteLength);const e=`${t}\n`;yield new ue(Uint8Array.from([19]),Ln(`${sw}\n`),re(e.length),Ln(e),s).subarray(),n.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',sw,t,s.byteLength),c=!0,l=!1,u.resolve(),g().catch((e=>{n.log.error("could not finish optimistic protocol negotiation of %s",t,e)}))}r=!0}r||await g()}())},e.source=async function*(){await g(),n.log.trace('optimistic: reading data from "%s" stream',t),yield*p.unwrap().source}(),null!=e.closeRead){const t=e.closeRead.bind(e);e.closeRead=async e=>{i||await g().catch((e=>{n.log.error("could not negotiate protocol before close read",e)})),await t(e)}}if(null!=e.closeWrite){const t=e.closeWrite.bind(e);e.closeWrite=async e=>{i||await g().catch((e=>{n.log.error("could not negotiate protocol before close write",e)})),await t(e)}}if(null!=e.close){const t=e.close.bind(e);e.close=async e=>{const n=[];l&&n.push(u.promise),d&&n.push(f.promise),n.length>0?await M(Promise.all(n),e?.signal):(i=!0,o=!1,a.resolve()),await t(e)}}return{stream:e,protocol:t}}(e,t[0],n);const r=rw(e,{...n,maxDataLength:iw}),s=t.shift();if(null==s)throw new Error("At least one protocol must be specified");n.log.trace('select: write ["%s", "%s"]',sw,s);const i=Ln(`${sw}\n`),o=Ln(`${s}\n`);await async function(e,t,n){await e.writeV(t,n)}(r,[i,o],n),n.log.trace("select: reading multistream-select header");let a=await cw(r,n);if(n.log.trace('select: read "%s"',a),a===sw&&(n.log.trace("select: reading protocol response"),a=await cw(r,n),n.log.trace('select: read "%s"',a)),a===s)return{stream:r.unwrap(),protocol:s};for(const e of t){n.log.trace('select: write "%s"',e),await aw(r,Ln(`${e}\n`),n),n.log.trace("select: reading protocol response");const t=await cw(r,n);if(n.log.trace('select: read "%s" for "%s"',t,e),t===e)return{stream:r.unwrap(),protocol:e}}throw new k("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}const hw=Symbol.for("@libp2p/connection");class dw{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;transient;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:n,newStream:r,close:s,abort:i,getStreams:o}=e;this.id=`${parseInt(String(1e9*Math.random())).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),null==this.remoteAddr.getPeerId()&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=r,this._close=s,this._abort=i,this._getStreams=o,this.tags=[]}[Symbol.toStringTag]="Connection";[hw]=!0;get streams(){return this._getStreams()}async newStream(e,t){if("closing"===this.status)throw new k("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if("closed"===this.status)throw new k("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&!0!==t?.runOnTransientConnection)throw new k("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if("closed"!==this.status&&"closing"!==this.status){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",null==e.signal){const t=AbortSignal.timeout(500);e={...e,signal:t}}try{this.log.trace("closing all streams"),await Promise.all(this.streams.map((async t=>t.close(e)))),this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(e){this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach((t=>{t.abort(e)})),this.log.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}}function fw(e,t,n){let r=0;return n.streams.forEach((n=>{n.direction===t&&n.protocol===e&&r++})),r}class pw{components;connectionEncryption;muxers;inboundUpgradeTimeout;events;constructor(e,t){this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach((e=>{this.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,t.muxers.forEach((e=>{this.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??2e3,this.events=e.events}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,t,n){const r=this.components.connectionGater[n];if(void 0!==r&&await r(e,t))throw new k(`The multiaddr connection is blocked by gater.${n}`,qy.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new k("connection denied",qy.ERR_CONNECTION_DENIED);let n,r,s,i,o;const a=AbortSignal.timeout(this.inboundUpgradeTimeout),c=()=>{e.abort(new k("inbound upgrade timeout",I))};a.addEventListener("abort",c,{once:!0});try{if(!0===await(this.components.connectionGater.denyInboundConnection?.(e)))throw new k("The multiaddr connection is blocked by gater.acceptConnection",qy.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the inbound connection upgrade");let a=e;if(!0!==t?.skipProtection){const t=this.components.connectionProtector;null!=t&&(e.log("protecting the inbound connection"),a=await t.protect(e))}try{if(n=a,!0!==t?.skipEncryption){t?.onProgress?.(new Ce("upgrader:encrypt-inbound-connection")),({conn:n,remotePeer:r,protocol:o}=await this._encryptInbound(a));const e={...a,...n};await this.shouldBlockConnection(r,e,"denyInboundEncryptedConnection")}else{const t=e.remoteAddr.getPeerId();if(null==t)throw new k("inbound connection that skipped encryption must have a peer id",qy.ERR_INVALID_MULTIADDR);const n=xr(t);o="native",r=n}if(s=n,null!=t?.muxerFactory)i=t.muxerFactory;else if(this.muxers.size>0){t?.onProgress?.(new Ce("upgrader:multiplex-inbound-connection"));const e=await this._multiplexInbound({...a,...n},this.muxers);i=e.muxerFactory,s=e.stream}}catch(t){throw e.log.error("failed to upgrade inbound connection",t),t}return await this.shouldBlockConnection(r,e,"denyInboundUpgradedConnection"),e.log("successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:o,direction:"inbound",maConn:e,upgradedConn:s,muxerFactory:i,remotePeer:r,transient:t?.transient})}finally{a.removeEventListener("abort",c),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){const n=e.remoteAddr.getPeerId();let r,s,i,o,a,c;null!=n&&(r=xr(n),await this.shouldBlockConnection(r,e,"denyOutboundConnection")),this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the outbound connection upgrade");let l=e;if(!0!==t?.skipProtection){const t=this.components.connectionProtector;null!=t&&(l=await t.protect(e))}try{if(s=l,!0!==t?.skipEncryption){({conn:s,remotePeer:i,protocol:a}=await this._encryptOutbound(l,r));const e={...l,...s};await this.shouldBlockConnection(i,e,"denyOutboundEncryptedConnection")}else{if(null==r)throw new k("Encryption was skipped but no peer id was passed",qy.ERR_INVALID_PEER);a="native",i=r}if(o=s,null!=t?.muxerFactory)c=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexOutbound({...l,...s},this.muxers);c=e.muxerFactory,o=e.stream}}catch(t){throw e.log.error("failed to upgrade outbound connection",t),await e.close(t),t}return await this.shouldBlockConnection(i,e,"denyOutboundUpgradedConnection"),e.log("successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:a,direction:"outbound",maConn:e,upgradedConn:o,muxerFactory:c,remotePeer:i,transient:t?.transient})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:r,upgradedConn:s,remotePeer:i,muxerFactory:o,transient:a}=e;let c,l,u;null!=o&&(c=o.createStreamMuxer({direction:n,onIncomingStream:e=>{null!=u&&Promise.resolve().then((async()=>{const t=this.components.registrar.getProtocols(),{stream:n,protocol:r}=await lw(e,t,{log:e.log,yieldBytes:!1});if(null==u)return;u.log("incoming stream opened on %s",r);const s=function(e,t){try{const{options:n}=t.getHandler(e);return n.maxInboundStreams}catch(e){if(e.code!==qy.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return 32}(r,this.components.registrar);if(fw(r,"inbound",u)===s){const t=new k(`Too many inbound protocol streams for protocol "${r}" - limit ${s}`,qy.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw e.abort(t),t}e.source=n.source,e.sink=n.sink,e.protocol=r,null!=n.closeWrite&&(e.closeWrite=n.closeWrite),null!=n.closeRead&&(e.closeRead=n.closeRead),null!=n.close&&(e.close=n.close),await this.components.peerStore.merge(i,{protocols:[r]}),this.components.metrics?.trackProtocolStream(e,u),this._onStream({connection:u,stream:e,protocol:r})})).catch((async t=>{u.log.error("error handling incoming stream id %s",e.id,t.message,t.code,t.stack),null==e.timeline.close&&await e.close()}))}}),l=async(e,t={})=>{if(null==c)throw new k("Stream is not multiplexed",qy.ERR_MUXER_UNAVAILABLE);u.log("starting new stream for protocols %s",e);const n=await c.newStream();u.log.trace("started new stream %s for protocols %s",n.id,e);try{if(null==t.signal){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const r=AbortSignal.timeout(3e4);t={...t,signal:r}}n.log.trace("selecting protocol from protocols %s",e);const{stream:r,protocol:s}=await uw(n,e,{...t,log:n.log,yieldBytes:!0});n.log("selected protocol %s",s);const o=function(e,t,n={}){try{const{options:n}=t.getHandler(e);if(null!=n.maxOutboundStreams)return n.maxOutboundStreams}catch(e){if(e.code!==qy.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return n.maxOutboundStreams??64}(s,this.components.registrar,t),a=fw(s,"outbound",u);if(a>=o){const e=new k(`Too many outbound protocol streams for protocol "${s}" - ${a}/${o}`,qy.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw n.abort(e),e}return await this.components.peerStore.merge(i,{protocols:[s]}),n.source=r.source,n.sink=r.sink,n.protocol=s,null!=r.closeWrite&&(n.closeWrite=r.closeWrite),null!=r.closeRead&&(n.closeRead=r.closeRead),null!=r.close&&(n.close=r.close),this.components.metrics?.trackProtocolStream(n,u),n}catch(t){if(u.log.error("could not create new stream for protocols %s",e,t),null==n.timeline.close&&n.abort(t),null!=t.code)throw t;throw new k(String(t),qy.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([c.sink(s.source),s.sink(c.source)]).catch((e=>{u.log.error("error piping data through muxer",e)})));const h=r.timeline;var d;return r.timeline=new Proxy(h,{set:(...e)=>(null!=u&&"close"===e[1]&&null!=e[2]&&null==h.close&&(async()=>{try{"open"===u.status&&await u.close()}catch(e){u.log.error("error closing connection after timeline close",e)}finally{this.events.safeDispatchEvent("connection:close",{detail:u})}})().catch((e=>{u.log.error("error thrown while dispatching connection:close event",e)})),Reflect.set(...e))}),r.timeline.upgraded=Date.now(),d={remoteAddr:r.remoteAddr,remotePeer:i,status:"open",direction:n,timeline:r.timeline,multiplexer:c?.protocol,encryption:t,transient:a,logger:this.components.logger,newStream:l??(()=>{throw new k("connection is not multiplexed",qy.ERR_CONNECTION_NOT_MULTIPLEXED)}),getStreams:()=>null!=c?c.streams:[],close:async e=>{null!=c&&(u.log.trace("close muxer"),await c.close(e)),u.log.trace("close maconn"),await r.close(e),u.log.trace("closed maconn")},abort:e=>{r.abort(e),null!=c&&c.abort(e)}},u=new dw(d),this.events.safeDispatchEvent("connection:open",{detail:u}),u}_onStream(e){const{connection:t,stream:n,protocol:r}=e,{handler:s,options:i}=this.components.registrar.getHandler(r);if(t.transient&&!0!==i.runOnTransientConnection)throw new k("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");s({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());e.log("handling inbound crypto protocol selection",t);try{const{stream:n,protocol:r}=await lw(e,t,{log:e.log}),s=this.connectionEncryption.get(r);if(null==s)throw new Error(`no crypto module found for ${r}`);return e.log("encrypting inbound connection using",r),{...await s.secureInbound(this.components.peerId,n),protocol:r}}catch(t){throw e.log.error("encrypting inbound connection failed",t),new k(t.message,qy.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());e.log("selecting outbound crypto protocol",n);try{e.log.trace("selecting encrypter from %s",n);const{stream:r,protocol:s}=await uw(e,n,{log:e.log,yieldBytes:!0}),i=this.connectionEncryption.get(s);if(null==i)throw new Error(`no crypto module found for ${s}`);return e.log("encrypting outbound connection to %p using %s",t,i),{...await i.secureOutbound(this.components.peerId,r,t),protocol:s}}catch(n){throw e.log.error("encrypting outbound connection to %p failed",t,n),new k(n.message,qy.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());e.log("outbound selecting muxer %s",n);try{e.log.trace("selecting stream muxer from %s",n);const{stream:r,protocol:s}=await uw(e,n,{log:e.log,yieldBytes:!0});return e.log("selected %s as muxer protocol",s),{stream:r,muxerFactory:t.get(s)}}catch(t){throw e.log.error("error multiplexing outbound connection",t),new k(String(t),qy.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());e.log("inbound handling muxers %s",n);try{const{stream:r,protocol:s}=await lw(e,n,{log:e.log});return{stream:r,muxerFactory:t.get(s)}}catch(t){throw e.log.error("error multiplexing inbound connection",t),new k(String(t),qy.ERR_MUXER_UNAVAILABLE)}}}const gw="1.9.4",yw="libp2p";class mw extends S{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new S,n=t.dispatchEvent.bind(t);t.dispatchEvent=e=>{const t=n(e),r=this.dispatchEvent(new _(e.type,{detail:e.detail}));return t||r},this.peerId=e.peerId,this.logger=e.logger??Xo(),this.log=this.logger.forComponent("libp2p"),this.services={};const r=this.components=function(e={}){const t=new Dy(e);return new Proxy(t,{get(e,n,r){if("string"==typeof n&&!Ny.includes(n)){const e=t.components[n];if(null==e&&!Cy.includes(n))throw new k(`${n} not set`,"ERR_SERVICE_MISSING");return e}return Reflect.get(e,n,r)},set:(e,n,r)=>("string"==typeof n?t.components[n]=r:Reflect.set(e,n,r),!0)})}({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:e.nodeInfo??{name:yw,version:gw},logger:this.logger,events:t,datastore:e.datastore??new la,connectionGater:Oy(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",new Ay(r,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),null!=e.metrics&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),r.events.addEventListener("peer:update",(e=>{if(null==e.detail.previous){const t={id:e.detail.peer.id,multiaddrs:e.detail.peer.addresses.map((e=>e.multiaddr))};r.events.safeDispatchEvent("peer:discovery",{detail:t})}})),null!=e.connectionProtector&&this.configureComponent("connectionProtector",e.connectionProtector(r)),this.components.upgrader=new pw(this.components,{connectionEncryption:(e.connectionEncryption??[]).map(((e,t)=>this.configureComponent(`connection-encryption-${t}`,e(this.components)))),muxers:(e.streamMuxers??[]).map(((e,t)=>this.configureComponent(`stream-muxers-${t}`,e(this.components)))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout}),this.configureComponent("transportManager",new Zm(this.components,e.transportManager)),this.configureComponent("connectionManager",new km(this.components,e.connectionManager)),!1!==e.connectionMonitor?.enabled&&this.configureComponent("connectionMonitor",new Pm(this.components,e.connectionMonitor)),this.configureComponent("registrar",new Xm(this.components)),this.configureComponent("addressManager",new xy(this.components,e.addresses));const s=(e.peerRouters??[]).map(((e,t)=>this.configureComponent(`peer-router-${t}`,e(this.components))));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new Qm(this.components,{routers:s}));const i=(e.contentRouters??[]).map(((e,t)=>this.configureComponent(`content-router-${t}`,e(this.components))));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new Lm(this.components,{routers:i})),this.configureComponent("randomWalk",new Jm(this.components)),(e.peerDiscovery??[]).forEach(((e,t)=>{this.configureComponent(`peer-discovery-${t}`,e(this.components)).addEventListener("peer",(e=>{this.#V(e)}))})),e.transports?.forEach(((e,t)=>{this.components.transportManager.add(this.configureComponent(`transport-${t}`,e(this.components)))})),null!=e.services)for(const t of Object.keys(e.services)){const n=(0,e.services[t])(this.components);null!=n?(this.services[t]=n,this.configureComponent(t,n),null!=n[ua]&&(this.log("registering service %s for content routing",t),i.push(n[ua])),null!=n[ha]&&(this.log("registering service %s for peer routing",t),s.push(n[ha])),null!=n[ny]&&(this.log("registering service %s for peer discovery",t),n[ny].addEventListener?.("peer",(e=>{this.#V(e)})))):this.log.error("service factory %s returned null or undefined instance",t)}!function(e){const t={};for(const n of Object.values(e.components))for(const e of Py(n))t[e]=!0;for(const n of Object.values(e.components))for(const e of Ly(n))if(!0!==t[e])throw new k(`Service "${By(n)}" required capability "${e}" but it was not provided by any component, you may need to add additional configuration when creating your node.`,"ERR_UNMET_SERVICE_DEPENDENCIES")}(r)}configureComponent(e,t){return null==t&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if("stopped"===this.status){this.status="starting",this.log("libp2p is starting");try{await(this.components.beforeStart?.()),await this.components.start(),await(this.components.afterStart?.()),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){"started"===this.status&&(this.log("libp2p is stopping"),this.status="stopping",await(this.components.beforeStop?.()),await this.components.stop(),await(this.components.afterStop?.()),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new ry;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(null==t)throw new k("no protocols were provided to open a stream",qy.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(t=Array.isArray(t)?t:[t]).length)throw new k("no protocols were provided to open a stream",qy.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Zs(e)&&(e=xr(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),null!=e.publicKey)return e.publicKey;try{const t=await this.peerStore.get(e);if(null!=t.id.publicKey)return t.id.publicKey}catch(e){if(e.code!==qy.ERR_NOT_FOUND)throw e}const n=ie([Ln("/pk/"),e.multihash.digest]),r=await this.contentRouting.get(n,t);return Ug(r),await this.peerStore.patch(e,{publicKey:r}),r}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.handle(e,t,n)})))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.unhandle(e)})))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#V(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch((e=>{this.log.error(e)})):this.log.error(new Error(qy.ERR_DISCOVERED_SELF))}}function ww(){const e=x();let t=!1;return{sink:async n=>{if(t)throw new Error("already piped");t=!0,e.resolve(n)},source:async function*(){const t=await e.promise;yield*t}()}}const bw=65535,Ew=Boolean(globalThis.process?.env?.DUMP_SESSION_KEYS);function vw(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function Sw(e){if("boolean"!=typeof e)throw new Error(`boolean expected, not ${e}`)}function _w(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}function Rw(e,...t){if(!_w(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function kw(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}const Aw=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4));if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");function Iw(e){if("string"==typeof e)e=function(e){if("string"!=typeof e)throw new Error("string expected, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e);else{if(!_w(e))throw new Error("Uint8Array expected, got "+typeof e);e=Dw(e)}return e}const Tw=(e,t)=>(Object.assign(t,e),t);function xw(e,t,n,r){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,n,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(n>>s&i),a=Number(n&i),c=r?4:0,l=r?0:4;e.setUint32(t+c,o,r),e.setUint32(t+l,a,r)}function Dw(e){return Uint8Array.from(e)}function Cw(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}const Nw=e=>Uint8Array.from(e.split("").map((e=>e.charCodeAt(0)))),Pw=Nw("expand 16-byte k"),Lw=Nw("expand 32-byte k"),Bw=Aw(Pw),Ow=Aw(Lw);function Mw(e,t){return e<<t|e>>>32-t}function Uw(e){return e.byteOffset%4==0}Ow.slice();const Fw=2**32-1,$w=new Uint32Array;function Vw(e,t){const{allowShortKeys:n,extendNonceFn:r,counterLength:s,counterRight:i,rounds:o}=function(e,t){if(null==t||"object"!=typeof t)throw new Error("options must be defined");return Object.assign({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t)}(0,t);if("function"!=typeof e)throw new Error("core must be a function");return vw(s),vw(o),Sw(i),Sw(n),(t,a,c,l,u=0)=>{Rw(t),Rw(a),Rw(c);const h=c.length;if(void 0===l&&(l=new Uint8Array(h)),Rw(l),vw(u),u<0||u>=Fw)throw new Error("arx: counter overflow");if(l.length<h)throw new Error(`arx: output (${l.length}) is shorter than data (${h})`);const d=[];let f,p,g=t.length;if(32===g)d.push(f=Dw(t)),p=Ow;else{if(16!==g||!n)throw new Error(`arx: invalid 32-byte key, got length=${g}`);f=new Uint8Array(32),f.set(t),f.set(t,16),p=Bw,d.push(f)}Uw(a)||d.push(a=Dw(a));const y=Aw(f);if(r){if(24!==a.length)throw new Error("arx: extended nonce must be 24 bytes");r(p,y,Aw(a.subarray(0,16)),y),a=a.subarray(16)}const m=16-s;if(m!==a.length)throw new Error(`arx: nonce must be ${m} or 16 bytes`);if(12!==m){const e=new Uint8Array(12);e.set(a,i?0:12-a.length),a=e,d.push(a)}const w=Aw(a);return function(e,t,n,r,s,i,o,a){const c=s.length,l=new Uint8Array(64),u=Aw(l),h=Uw(s)&&Uw(i),d=h?Aw(s):$w,f=h?Aw(i):$w;for(let p=0;p<c;o++){if(e(t,n,r,u,o,a),o>=Fw)throw new Error("arx: counter overflow");const g=Math.min(64,c-p);if(h&&64===g){const e=p/4;if(p%4!=0)throw new Error("arx: invalid block position");for(let t,n=0;n<16;n++)t=e+n,f[t]=d[t]^u[n];p+=64}else{for(let e,t=0;t<g;t++)e=p+t,i[e]=s[e]^l[t];p+=g}}}(e,p,y,w,c,l,u,o),Cw(...d),l}}const zw=(e,t)=>255&e[t++]|(255&e[t++])<<8;class Hw{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,Rw(e=Iw(e),32);const t=zw(e,0),n=zw(e,2),r=zw(e,4),s=zw(e,6),i=zw(e,8),o=zw(e,10),a=zw(e,12),c=zw(e,14);this.r[0]=8191&t,this.r[1]=8191&(t>>>13|n<<3),this.r[2]=7939&(n>>>10|r<<6),this.r[3]=8191&(r>>>7|s<<9),this.r[4]=255&(s>>>4|i<<12),this.r[5]=i>>>1&8190,this.r[6]=8191&(i>>>14|o<<2),this.r[7]=8065&(o>>>11|a<<5),this.r[8]=8191&(a>>>8|c<<8),this.r[9]=c>>>5&127;for(let t=0;t<8;t++)this.pad[t]=zw(e,16+2*t)}process(e,t,n=!1){const r=n?0:2048,{h:s,r:i}=this,o=i[0],a=i[1],c=i[2],l=i[3],u=i[4],h=i[5],d=i[6],f=i[7],p=i[8],g=i[9],y=zw(e,t+0),m=zw(e,t+2),w=zw(e,t+4),b=zw(e,t+6),E=zw(e,t+8),v=zw(e,t+10),S=zw(e,t+12),_=zw(e,t+14);let R=s[0]+(8191&y),k=s[1]+(8191&(y>>>13|m<<3)),A=s[2]+(8191&(m>>>10|w<<6)),I=s[3]+(8191&(w>>>7|b<<9)),T=s[4]+(8191&(b>>>4|E<<12)),x=s[5]+(E>>>1&8191),D=s[6]+(8191&(E>>>14|v<<2)),C=s[7]+(8191&(v>>>11|S<<5)),N=s[8]+(8191&(S>>>8|_<<8)),P=s[9]+(_>>>5|r),L=0,B=L+R*o+k*(5*g)+A*(5*p)+I*(5*f)+T*(5*d);L=B>>>13,B&=8191,B+=x*(5*h)+D*(5*u)+C*(5*l)+N*(5*c)+P*(5*a),L+=B>>>13,B&=8191;let O=L+R*a+k*o+A*(5*g)+I*(5*p)+T*(5*f);L=O>>>13,O&=8191,O+=x*(5*d)+D*(5*h)+C*(5*u)+N*(5*l)+P*(5*c),L+=O>>>13,O&=8191;let M=L+R*c+k*a+A*o+I*(5*g)+T*(5*p);L=M>>>13,M&=8191,M+=x*(5*f)+D*(5*d)+C*(5*h)+N*(5*u)+P*(5*l),L+=M>>>13,M&=8191;let U=L+R*l+k*c+A*a+I*o+T*(5*g);L=U>>>13,U&=8191,U+=x*(5*p)+D*(5*f)+C*(5*d)+N*(5*h)+P*(5*u),L+=U>>>13,U&=8191;let F=L+R*u+k*l+A*c+I*a+T*o;L=F>>>13,F&=8191,F+=x*(5*g)+D*(5*p)+C*(5*f)+N*(5*d)+P*(5*h),L+=F>>>13,F&=8191;let $=L+R*h+k*u+A*l+I*c+T*a;L=$>>>13,$&=8191,$+=x*o+D*(5*g)+C*(5*p)+N*(5*f)+P*(5*d),L+=$>>>13,$&=8191;let V=L+R*d+k*h+A*u+I*l+T*c;L=V>>>13,V&=8191,V+=x*a+D*o+C*(5*g)+N*(5*p)+P*(5*f),L+=V>>>13,V&=8191;let z=L+R*f+k*d+A*h+I*u+T*l;L=z>>>13,z&=8191,z+=x*c+D*a+C*o+N*(5*g)+P*(5*p),L+=z>>>13,z&=8191;let H=L+R*p+k*f+A*d+I*h+T*u;L=H>>>13,H&=8191,H+=x*l+D*c+C*a+N*o+P*(5*g),L+=H>>>13,H&=8191;let K=L+R*g+k*p+A*f+I*d+T*h;L=K>>>13,K&=8191,K+=x*u+D*l+C*c+N*a+P*o,L+=K>>>13,K&=8191,L=(L<<2)+L|0,L=L+B|0,B=8191&L,L>>>=13,O+=L,s[0]=B,s[1]=O,s[2]=M,s[3]=U,s[4]=F,s[5]=$,s[6]=V,s[7]=z,s[8]=H,s[9]=K}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let r=e[1]>>>13;e[1]&=8191;for(let t=2;t<10;t++)e[t]+=r,r=e[t]>>>13,e[t]&=8191;e[0]+=5*r,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,n[0]=e[0]+5,r=n[0]>>>13,n[0]&=8191;for(let t=1;t<10;t++)n[t]=e[t]+r,r=n[t]>>>13,n[t]&=8191;n[9]-=8192;let s=(1^r)-1;for(let e=0;e<10;e++)n[e]&=s;s=~s;for(let t=0;t<10;t++)e[t]=e[t]&s|n[t];e[0]=65535&(e[0]|e[1]<<13),e[1]=65535&(e[1]>>>3|e[2]<<10),e[2]=65535&(e[2]>>>6|e[3]<<7),e[3]=65535&(e[3]>>>9|e[4]<<4),e[4]=65535&(e[4]>>>12|e[5]<<1|e[6]<<14),e[5]=65535&(e[6]>>>2|e[7]<<11),e[6]=65535&(e[7]>>>5|e[8]<<8),e[7]=65535&(e[8]>>>8|e[9]<<5);let i=e[0]+t[0];e[0]=65535&i;for(let n=1;n<8;n++)i=(e[n]+t[n]|0)+(i>>>16)|0,e[n]=65535&i;Cw(n)}update(e){kw(this);const{buffer:t,blockLen:n}=this,r=(e=Iw(e)).length;for(let s=0;s<r;){const i=Math.min(n-this.pos,r-s);if(i!==n)t.set(e.subarray(s,s+i),this.pos),this.pos+=i,s+=i,this.pos===n&&(this.process(t,0,!1),this.pos=0);else for(;n<=r-s;s+=n)this.process(e,s)}return this}destroy(){Cw(this.h,this.r,this.buffer,this.pad)}digestInto(e){kw(this),function(e,t){Rw(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let t=0;t<8;t++)e[s++]=n[t]>>>0,e[s++]=n[t]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}const Kw=function(e){const t=(t,n)=>e(n).update(Iw(t)).digest(),n=e(new Uint8Array(32));return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=t=>e(t),t}((e=>new Hw(e)));function qw(e,t,n,r,s,i=20){let o=e[0],a=e[1],c=e[2],l=e[3],u=t[0],h=t[1],d=t[2],f=t[3],p=t[4],g=t[5],y=t[6],m=t[7],w=s,b=n[0],E=n[1],v=n[2],S=o,_=a,R=c,k=l,A=u,I=h,T=d,x=f,D=p,C=g,N=y,P=m,L=w,B=b,O=E,M=v;for(let e=0;e<i;e+=2)S=S+A|0,L=Mw(L^S,16),D=D+L|0,A=Mw(A^D,12),S=S+A|0,L=Mw(L^S,8),D=D+L|0,A=Mw(A^D,7),_=_+I|0,B=Mw(B^_,16),C=C+B|0,I=Mw(I^C,12),_=_+I|0,B=Mw(B^_,8),C=C+B|0,I=Mw(I^C,7),R=R+T|0,O=Mw(O^R,16),N=N+O|0,T=Mw(T^N,12),R=R+T|0,O=Mw(O^R,8),N=N+O|0,T=Mw(T^N,7),k=k+x|0,M=Mw(M^k,16),P=P+M|0,x=Mw(x^P,12),k=k+x|0,M=Mw(M^k,8),P=P+M|0,x=Mw(x^P,7),S=S+I|0,M=Mw(M^S,16),N=N+M|0,I=Mw(I^N,12),S=S+I|0,M=Mw(M^S,8),N=N+M|0,I=Mw(I^N,7),_=_+T|0,L=Mw(L^_,16),P=P+L|0,T=Mw(T^P,12),_=_+T|0,L=Mw(L^_,8),P=P+L|0,T=Mw(T^P,7),R=R+x|0,B=Mw(B^R,16),D=D+B|0,x=Mw(x^D,12),R=R+x|0,B=Mw(B^R,8),D=D+B|0,x=Mw(x^D,7),k=k+A|0,O=Mw(O^k,16),C=C+O|0,A=Mw(A^C,12),k=k+A|0,O=Mw(O^k,8),C=C+O|0,A=Mw(A^C,7);let U=0;r[U++]=o+S|0,r[U++]=a+_|0,r[U++]=c+R|0,r[U++]=l+k|0,r[U++]=u+A|0,r[U++]=h+I|0,r[U++]=d+T|0,r[U++]=f+x|0,r[U++]=p+D|0,r[U++]=g+C|0,r[U++]=y+N|0,r[U++]=m+P|0,r[U++]=w+L|0,r[U++]=b+B|0,r[U++]=E+O|0,r[U++]=v+M|0}const Ww=Vw(qw,{counterRight:!1,counterLength:4,allowShortKeys:!1}),jw=Vw(qw,{counterRight:!1,counterLength:8,extendNonceFn:function(e,t,n,r){let s=e[0],i=e[1],o=e[2],a=e[3],c=t[0],l=t[1],u=t[2],h=t[3],d=t[4],f=t[5],p=t[6],g=t[7],y=n[0],m=n[1],w=n[2],b=n[3];for(let e=0;e<20;e+=2)s=s+c|0,y=Mw(y^s,16),d=d+y|0,c=Mw(c^d,12),s=s+c|0,y=Mw(y^s,8),d=d+y|0,c=Mw(c^d,7),i=i+l|0,m=Mw(m^i,16),f=f+m|0,l=Mw(l^f,12),i=i+l|0,m=Mw(m^i,8),f=f+m|0,l=Mw(l^f,7),o=o+u|0,w=Mw(w^o,16),p=p+w|0,u=Mw(u^p,12),o=o+u|0,w=Mw(w^o,8),p=p+w|0,u=Mw(u^p,7),a=a+h|0,b=Mw(b^a,16),g=g+b|0,h=Mw(h^g,12),a=a+h|0,b=Mw(b^a,8),g=g+b|0,h=Mw(h^g,7),s=s+l|0,b=Mw(b^s,16),p=p+b|0,l=Mw(l^p,12),s=s+l|0,b=Mw(b^s,8),p=p+b|0,l=Mw(l^p,7),i=i+u|0,y=Mw(y^i,16),g=g+y|0,u=Mw(u^g,12),i=i+u|0,y=Mw(y^i,8),g=g+y|0,u=Mw(u^g,7),o=o+h|0,m=Mw(m^o,16),d=d+m|0,h=Mw(h^d,12),o=o+h|0,m=Mw(m^o,8),d=d+m|0,h=Mw(h^d,7),a=a+c|0,w=Mw(w^a,16),f=f+w|0,c=Mw(c^f,12),a=a+c|0,w=Mw(w^a,8),f=f+w|0,c=Mw(c^f,7);let E=0;r[E++]=s,r[E++]=i,r[E++]=o,r[E++]=a,r[E++]=y,r[E++]=m,r[E++]=w,r[E++]=b},allowShortKeys:!1}),Gw=new Uint8Array(16),Yw=(e,t)=>{e.update(t);const n=t.length%16;n&&e.update(Gw.subarray(n))},Qw=new Uint8Array(32);function Jw(e,t,n,r,s){const i=e(t,n,Qw),o=Kw.create(i);s&&Yw(o,s),Yw(o,r);const a=new Uint8Array(16),c=(l=a,new DataView(l.buffer,l.byteOffset,l.byteLength));var l;xw(c,0,BigInt(s?s.length:0),!0),xw(c,8,BigInt(r.length),!0),o.update(a);const u=o.digest();return Cw(i,a),u}const Xw=e=>(t,n,r)=>(Rw(t,32),Rw(n),{encrypt(s,i){const o=s.length,a=o+16;i?Rw(i,a):i=new Uint8Array(a),e(t,n,s,i,1);const c=Jw(e,t,n,i.subarray(0,-16),r);return i.set(c,o),Cw(c),i},decrypt(s,i){const o=s.length,a=o-16;if(o<16)throw new Error("encrypted data must be at least 16 bytes");i?Rw(i,a):i=new Uint8Array(a);const c=s.subarray(0,-16),l=s.subarray(-16),u=Jw(e,t,n,c,r);if(!function(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return 0===n}(l,u))throw new Error("invalid tag");return e(t,n,c,i,1),Cw(u),i}}),Zw=Tw({blockSize:64,nonceLength:12,tagLength:16},Xw(Ww));Xw(jw);const eb=new Uint8Array([0]),tb=new Uint8Array;const nb={hashSHA256:e=>zu(e.subarray()),getHKDF(e,t){const n=function(e,t,n){return Hr(e),void 0===n&&(n=new Uint8Array(e.outputLen)),Iu(e,Qr(n),Qr(t))}(zu,t,e),r=function(e,t,n,r=32){if(Hr(e),Vr(r),r>255*e.outputLen)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/e.outputLen);void 0===n&&(n=tb);const i=new Uint8Array(s*e.outputLen),o=Iu.create(e,t),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let t=0;t<s;t++)eb[0]=t+1,a.update(0===t?tb:c).update(n).update(eb).digestInto(c),i.set(c,e.outputLen*t),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),eb.fill(0),i.slice(0,r)}(zu,n,void 0,96);return[r.subarray(0,32),r.subarray(32,64),r.subarray(64,96)]},generateX25519KeyPair(){const e=Sd.utils.randomPrivateKey();return{publicKey:Sd.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Sd.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Sd.getSharedSecret(e.subarray(),t.subarray()),chaCha20Poly1305Encrypt:(e,t,n,r)=>Zw(r,t,n).encrypt(e.subarray()),chaCha20Poly1305Decrypt:(e,t,n,r,s)=>Zw(r,t,n).decrypt(e.subarray(),s)},rb=e=>{const t=K(2);return t[0]=e>>8,t[1]=e,t};rb.bytes=2;const sb=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");if(e instanceof Uint8Array){let t=0;return t+=e[0]<<8,t+=e[1],t}return e.getUint16(0)};function ib(e,t){t.enabled&&Ew&&(e?(t(`LOCAL_STATIC_PUBLIC_KEY ${mr(e.publicKey,"hex")}`),t(`LOCAL_STATIC_PRIVATE_KEY ${mr(e.privateKey,"hex")}`)):t("Missing local static keys."))}function ob(e,t){t.enabled&&Ew&&(e?(t(`LOCAL_PUBLIC_EPHEMERAL_KEY ${mr(e.publicKey,"hex")}`),t(`LOCAL_PRIVATE_EPHEMERAL_KEY ${mr(e.privateKey,"hex")}`)):t("Missing local ephemeral keys."))}function ab(e,t){t.enabled&&Ew&&t(e?`REMOTE_EPHEMERAL_PUBLIC_KEY ${mr(e.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function cb(e,t,n){n.enabled&&Ew&&(n(`CIPHER_STATE_1 ${e.n.getUint64()} ${e.k&&mr(e.k,"hex")}`),n(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&mr(t.k,"hex")}`))}sb.bytes=2;class lb extends Error{code;constructor(e="Unexpected Peer"){super(e),this.code=lb.code}static code="ERR_UNEXPECTED_PEER"}class ub extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=ub.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}class hb{n;bytes;view;constructor(e=0){this.n=e,this.bytes=H(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}const db=H(0);class fb{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new hb(n)}hasKey(){return Boolean(this.k)}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),r}}class pb{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const n=Ln(t,"utf-8");this.h=function(e,t){if(t.length<=32){const e=H(32);return e.set(t),e}return e.hash(t)}(e,n),this.ck=this.h,this.cs=new fb(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new fb(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new ue(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,db);return[new fb(this.crypto,e),new fb(this.crypto,t)]}}class gb{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:n,prologue:r,initiator:s,s:i,e:o,rs:a,re:c}=e;this.crypto=t,this.ss=new pb(t,n),this.ss.mixHash(r),this.initiator=s,this.s=i,this.e=o,this.rs=a,this.re=c}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const r=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(r),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class yb extends gb{writeMessageA(e){return new ue(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new ue(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new ue(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(e){throw new ub(`handshake stage 0 validation fail: ${e.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(e){throw new ub(`handshake stage 1 validation fail: ${e.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(e){throw new ub(`handshake stage 2 validation fail: ${e.message}`)}}}var mb,wb;async function bb(e,t,n){const r=await e.sign(vb(t));return wb.encode({identityKey:e.public.bytes,identitySig:r,extensions:n})}async function Eb(e,t,n){try{const r=wb.decode(e);if(n){const e=n.subarray();if(!oe(e,r.identityKey))throw new Error(`Payload identity key ${mr(r.identityKey,"hex")} does not match expected remote identity key ${mr(e,"hex")}`)}if(!t)throw new Error("Remote static does not exist");const s=vb(t),i=Ug(r.identityKey);if(!await i.verify(s,r.identitySig))throw new Error("Invalid payload signature");return r}catch(e){throw new lb(e.message)}}function vb(e){const t=Ln("noise-libp2p-static-key:");return e instanceof Uint8Array?ie([t,e],t.length+e.length):(e.prepend(t),e)}!function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(const n of e.webtransportCerthashes)t.uint32(10),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={webtransportCerthashes:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();t>>>3==1?n.webtransportCerthashes.push(e.bytes()):e.skipType(7&t)}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(mb||(mb={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.identityKey&&e.identityKey.byteLength>0&&(t.uint32(10),t.bytes(e.identityKey)),null!=e.identitySig&&e.identitySig.byteLength>0&&(t.uint32(18),t.bytes(e.identitySig)),null!=e.extensions&&(t.uint32(34),mb.codec().encode(e.extensions,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={identityKey:H(0),identitySig:H(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=mb.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(wb||(wb={}));class Sb{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:n,extensions:r,crypto:s,prologueBytes:i}=t,{metrics:o}=e;this.components=e;const a=s??nb;this.crypto=function(e){return{generateKeypair:e.generateX25519KeyPair,dh:(t,n)=>e.generateX25519SharedKey(t.privateKey,n).subarray(0,32),encrypt:e.chaCha20Poly1305Encrypt,decrypt:e.chaCha20Poly1305Decrypt,hash:e.hashSHA256,hkdf:e.getHKDF}}(a),this.extensions=r,this.metrics=o?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(o):void 0,this.staticKey=n?a.generateX25519KeyPairFromSeed(n):a.generateX25519KeyPair(),this.prologue=i??H(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[zg]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(...e){const{localPeer:t,connection:n,remotePeer:r,signal:s}=this.parseArgs(e),i=rw(n,{lengthEncoder:rb,lengthDecoder:sb,maxDataLength:bw});if(!t.privateKey)throw new k("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const o=await $g(t.privateKey),a=r?.publicKey,c=await this.performHandshakeInitiator(i,o,a,{signal:s}),l=await this.createSecureConnection(i,c);return n.source=l.source,n.sink=l.sink,{conn:n,remoteExtensions:c.payload.extensions,remotePeer:await Cr(c.payload.identityKey)}}async secureInbound(...e){const{localPeer:t,connection:n,remotePeer:r,signal:s}=this.parseArgs(e),i=rw(n,{lengthEncoder:rb,lengthDecoder:sb,maxDataLength:bw});if(!t.privateKey)throw new k("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const o=await $g(t.privateKey),a=r?.publicKey,c=await this.performHandshakeResponder(i,o,a,{signal:s}),l=await this.createSecureConnection(i,c);return n.source=l.source,n.sink=l.sink,{conn:n,remoteExtensions:c.payload.extensions,remotePeer:await Cr(c.payload.identityKey)}}async performHandshakeInitiator(e,t,n,r){let s;try{s=await async function(e,t){const{log:n,connection:r,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=e,u=await bb(i,a.publicKey,l),h=new yb({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});ib(h.s,n),n.trace("Stage 0 - Initiator starting to send first message."),await r.write(h.writeMessageA(db),t),n.trace("Stage 0 - Initiator finished sending first message."),ob(h.e,n),n.trace("Stage 1 - Initiator waiting to receive first message from responder...");const d=h.readMessageB(await r.read(t));var f,p;n.trace("Stage 1 - Initiator received the message."),ab(h.re,n),f=h.rs,(p=n).enabled&&Ew&&p(f?`REMOTE_STATIC_PUBLIC_KEY ${mr(f.subarray(),"hex")}`:"Missing remote static public key."),n.trace("Initiator going to check remote's signature...");const g=await Eb(d,h.rs,c);n.trace("All good with the signature!"),n.trace("Stage 2 - Initiator sending third handshake message."),await r.write(h.writeMessageC(u),t),n.trace("Stage 2 - Initiator sent message with signed payload.");const[y,m]=h.ss.split();return cb(y,m,n),{payload:g,encrypt:e=>y.encryptWithAd(db,e),decrypt:(e,t)=>m.decryptWithAd(db,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},r),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return s}async performHandshakeResponder(e,t,n,r){let s;try{s=await async function(e,t){const{log:n,connection:r,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=e,u=await bb(i,a.publicKey,l),h=new yb({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});ib(h.s,n),n.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await r.read(t)),n.trace("Stage 0 - Responder received first message."),ab(h.re,n),n.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(h.writeMessageB(u),t),n.trace("Stage 1 - Responder sent the second handshake message with signed payload."),ob(h.e,n),n.trace("Stage 2 - Responder waiting for third handshake message...");const d=h.readMessageC(await r.read(t));n.trace("Stage 2 - Responder received the message, finished handshake.");const f=await Eb(d,h.rs,c),[p,g]=h.ss.split();return cb(p,g,n),{payload:f,encrypt:e=>g.encryptWithAd(db,e),decrypt:(e,t)=>p.decryptWithAd(db,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},r),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return s}async createSecureConnection(e,t){const[n,r]=function(){const e=ww(),t=ww();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}(),s=e.unwrap();return await Re(n,function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=65519){let s,i=n+65519;i>r.length&&(i=r.length),s=r instanceof Uint8Array?e.encrypt(r.subarray(n,i)):e.encrypt(r.sublist(n,i)),t?.encryptedPackets.increment(),yield new ue(rb(s.byteLength),s)}}}(t,this.metrics),s,(e=>Ee(e,{lengthDecoder:sb})),function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=bw){let s=n+bw;if(s>r.length&&(s=r.length),s-16<n)throw new Error("Invalid chunk");const i=r.sublist(n,s),o=r.subarray(n,s-16);try{const n=e.decrypt(i,o);t?.decryptedPackets.increment(),yield n}catch(e){throw t?.decryptErrors.increment(),e}}}}(t,this.metrics),n),r}parseArgs(e){return yr(e[0])?{localPeer:e[0],connection:e[1],remotePeer:e[2]}:{localPeer:this.components.peerId,connection:e[0],remotePeer:e[1]?.remotePeer,signal:e[1]?.signal}}}function _b(e={}){return t=>new Sb(t,e)}function Rb(e){if(null!=e){if("function"==typeof e[Symbol.iterator])return e[Symbol.iterator]();if("function"==typeof e[Symbol.asyncIterator])return e[Symbol.asyncIterator]();if("function"==typeof e.next)return e}throw new Error("argument is not an iterator or iterable")}const kb="ERR_INVALID_FRAME",Ab="ERR_UNREQUESTED_PING",Ib="ERR_NOT_MATCHING_PING",Tb="ERR_STREAM_ALREADY_EXISTS",xb="ERR_DECODE_INVALID_VERSION",Db="ERR_BOTH_CLIENTS",Cb="ERR_RECV_WINDOW_EXCEEDED",Nb=new Set([kb,Ab,Ib,Tb,xb,Db,Cb]),Pb="ERR_INVALID_CONFIG",Lb="ERR_MUXER_LOCAL_CLOSED",Bb="ERR_MUXER_REMOTE_CLOSED",Ob=262144,Mb={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Ob,maxStreamWindowSize:16777216,maxMessageSize:65536};var Ub,Fb,$b;!function(e){e[e.Data=0]="Data",e[e.WindowUpdate=1]="WindowUpdate",e[e.Ping=2]="Ping",e[e.GoAway=3]="GoAway"}(Ub||(Ub={})),function(e){e[e.SYN=1]="SYN",e[e.ACK=2]="ACK",e[e.FIN=4]="FIN",e[e.RST=8]="RST"}(Fb||(Fb={})),Object.values(Fb).filter((e=>"string"!=typeof e)),function(e){e[e.NormalTermination=0]="NormalTermination",e[e.ProtocolError=1]="ProtocolError",e[e.InternalError=2]="InternalError"}($b||($b={}));const Vb=2**24;class zb{source;buffer;frameInProgress;constructor(e){this.source=function(e){if(void 0!==e[Symbol.iterator]){const t=e[Symbol.iterator]();return t.return=void 0,{[Symbol.iterator]:()=>t}}if(void 0!==e[Symbol.asyncIterator]){const t=e[Symbol.asyncIterator]();return t.return=void 0,{[Symbol.asyncIterator]:()=>t}}throw new Error("a source must be either an iterable or an async iterable")}(e),this.buffer=new ue,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const e=this.readHeader();if(void 0===e)break;const{type:t,length:n}=e;t===Ub.Data?(this.frameInProgress=!0,yield{header:e,readData:this.readBytes.bind(this,n)}):yield{header:e}}}readHeader(){if(this.frameInProgress)throw new k("decoding frame already in progress","ERR_DECODE_IN_PROGRESS");if(this.buffer.length<12)return;const e=function(e){if(0!==e[0])throw new k("Invalid frame version",xb);return{type:e[1],flag:(e[2]<<8)+e[3],streamID:e[4]*Vb+(e[5]<<16)+(e[6]<<8)+e[7],length:e[8]*Vb+(e[9]<<16)+(e[10]<<8)+e[11]}}(this.buffer.subarray(0,12));return this.buffer.consume(12),e}async readBytes(e){if(this.buffer.length<e)for await(const t of this.source)if(this.buffer.append(t),this.buffer.length>=e)break;const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}}function Hb(e){const t=new Uint8Array(12);return t[1]=e.type,t[2]=e.flag>>>8,t[3]=e.flag,t[4]=e.streamID>>>24,t[5]=e.streamID>>>16,t[6]=e.streamID>>>8,t[7]=e.streamID,t[8]=e.length>>>24,t[9]=e.length>>>16,t[10]=e.length>>>8,t[11]=e.length,t}function Kb(e,t){const n=Rb(e).return?.();var r;null!=(r=n)&&"function"==typeof r.then&&"function"==typeof r.catch&&"function"==typeof r.finally&&n.catch((e=>{t.error("could not cause iterator to return",e)}))}function qb(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally}class Wb{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=x(),this.closed=x(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??5e3,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=P({onEnd:e=>{null!=e?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(e){if("ready"!==this.writeStatus)throw new k(`writable end state is "${this.writeStatus}" not "ready"`,"ERR_SINK_INVALID_STATE");try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if("outbound"===this.direction){const e=this.sendNewStream(t);qb(e)&&await e}const n=()=>{Kb(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let n of e){n=n instanceof Uint8Array?new ue(n):n;const e=this.sendData(n,t);qb(e)&&(this.sendingData=x(),await e,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),"writing"===this.writeStatus&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){null==this.timeline.closeRead&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseRead?.(),null!=this.timeline.closeWrite?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){null==this.timeline.closeWrite&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseWrite?.(),null!=this.timeline.closeRead?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await M(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if("closing"===this.readStatus||"closed"===this.readStatus)return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing","reset"!==this.status&&"aborted"!==this.status&&null==this.timeline.closeRead&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),"ready"===t&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){"closing"!==this.writeStatus&&"closed"!==this.writeStatus&&(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),"ready"===this.writeStatus&&(this.log.trace("sink was never sunk, sink an empty array"),await M(this.sink([]),e.signal)),"writing"===this.writeStatus&&(null!=this.sendingData&&await M(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await M(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();qb(t)&&t.catch((e=>{this.log.error("error sending reset message",e)})),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;const e=new k("stream reset","ERR_STREAM_RESET");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){"writing"===this.writeStatus&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){"closing"!==this.readStatus&&"closed"!==this.readStatus&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){"closing"!==this.readStatus&&"closed"!==this.readStatus?(this.log.trace("remote close write"),this._closeSource()):this.log("received remote close write but local source is already closed")}remoteCloseRead(){"closing"!==this.writeStatus&&"closed"!==this.writeStatus?(this.log.trace("remote close read"),this._closeSink()):this.log("received remote close read but local sink is already closed")}destroy(){"closed"!==this.status&&"aborted"!==this.status&&"reset"!==this.status?(this.log.trace("stream destroyed"),this._closeSinkAndSource()):this.log("received destroy but we are already closed")}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var jb;!function(e){e[e.Init=0]="Init",e[e.SYNSent=1]="SYNSent",e[e.SYNReceived=2]="SYNReceived",e[e.Established=3]="Established",e[e.Finished=4]="Finished"}(jb||(jb={}));class Gb extends Wb{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=jb.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Ob,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=mu(this.source,(()=>{this.sendWindowUpdate()}))}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();0!==e.byteLength;){if(0===this.sendWindowCapacity&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),"closed"===this.status||"aborted"===this.status||"reset"===this.status))return void this.log?.trace("%s while waiting for send window capacity",this.status);const n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-12,e.length),r=this.getSendFlags();this.sendFrame({type:Ub.Data,flag:r,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:Ub.WindowUpdate,flag:Fb.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Fb.FIN;this.sendFrame({type:Ub.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n;const r=()=>{"open"===this.status||"closing"===this.status?n(new k("stream aborted","ERR_STREAM_ABORT")):t()};e.signal?.addEventListener("abort",r);try{await new Promise(((e,r)=>{this.sendWindowCapacityUpdate=()=>{e()},n=r,t=e}))}finally{e.signal?.removeEventListener("abort",r)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,0===t&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new k("receive window exceeded",Cb,{available:this.recvWindowCapacity,recv:e.length});const n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&Fb.ACK)===Fb.ACK&&this.state===jb.SYNSent&&(this.state=jb.Established),(e&Fb.FIN)===Fb.FIN&&this.remoteCloseWrite(),(e&Fb.RST)===Fb.RST&&this.reset()}getSendFlags(){switch(this.state){case jb.Init:return this.state=jb.SYNSent,Fb.SYN;case jb.SYNReceived:return this.state=jb.Established,Fb.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(0===e&&n>-1&&t-this.epochStart<4*n&&(this.recvWindow=Math.min(2*this.recvWindow,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&0===e)return;const r=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Ub.WindowUpdate,flag:e,streamID:this._id,length:r})}}const Yb="/yamux/1.0.0";class Qb{protocol=Yb;_components;_init;constructor(e,t={}){this._components=e,this._init=t}createStreamMuxer(e){return new Jb(this._components,{...this._init,...e})}}class Jb{protocol=Yb;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client="outbound"===t.direction,this.config={...Mb,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),function(e){if(e.keepAliveInterval<=0)throw new k("keep-alive interval must be positive",Pb);if(e.maxInboundStreams<0)throw new k("max inbound streams must be larger or equal 0",Pb);if(e.maxOutboundStreams<0)throw new k("max outbound streams must be larger or equal 0",Pb);if(e.initialStreamWindowSize<Ob)throw new k("InitialStreamWindowSize must be larger or equal 256 kB",Pb);if(e.maxStreamWindowSize<e.initialStreamWindowSize)throw new k("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Pb);if(e.maxStreamWindowSize>2**32-1)throw new k("MaxStreamWindowSize must be less than equal MAX_UINT32",Pb);if(e.maxMessageSize<1024)throw new k("MaxMessageSize must be greater than a kilobyte",Pb)}(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=P({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach((e=>{e.destroy()}))}}),this.sink=async e=>{const t=()=>{const t=Rb(e);if(null!=t.return){const e=t.return();null!=(n=e)&&"function"==typeof n.then&&e.catch((e=>{this.log?.("could not cause sink source to return",e)}))}var n};let n,r;try{const r=new zb(e);try{this.closeController.signal.addEventListener("abort",t);for await(const e of r.emitFrames())await this.handleFrame(e.header,e.readData)}finally{this.closeController.signal.removeEventListener("abort",t)}n=$b.NormalTermination}catch(e){const t=e.code;Nb.has(t)?(this.log?.error("protocol error in sink",e),n=$b.ProtocolError):(this.log?.error("internal error in sink",e),n=$b.InternalError),r=e}this.log?.trace("muxer sink ended"),null!=r?this.abort(r,n):await this.close({reason:n})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch((e=>this.log?.error("keepalive error: %s",e))),this.ping().catch((e=>this.log?.error("ping error: %s",e)))}get streams(){return Array.from(this._streams.values())}newStream(e){if(void 0!==this.remoteGoAway)throw new k("muxer closed remotely",Bb);if(void 0!==this.localGoAway)throw new k("muxer closed locally",Lb);const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new k("max outbound streams exceeded","ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED");this.log?.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,jb.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(void 0!==this.remoteGoAway)throw new k("muxer closed remotely",Bb);if(void 0!==this.localGoAway)throw new k("muxer closed locally",Lb);if(void 0===this.activePing){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise(((t,n)=>{const r=()=>{n(new k("muxer closed locally",Lb))};this.closeController.signal.addEventListener("abort",r,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",r),t()}})),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??$b.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),null==e.signal){const t=AbortSignal.timeout(500);e={...e,signal:t}}try{await Promise.all([...this._streams.values()].map((async t=>t.close(e)))),this.sendGoAway(t),this._closeMuxer()}catch(e){this.abort(e)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??$b.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const t of this._streams.values())t.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,r){if(null!=this._streams.get(e))throw new k("Stream already exists",Tb,{id:e});const s=new Gb({id:e.toString(),name:t,state:n,direction:r,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(s)},log:this.logger.forComponent(`libp2p:yamux:${r}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return s}closeStream(e){this.client===(e%2==0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){const e=new Promise(((e,t)=>{this.closeController.signal.addEventListener("abort",t,{once:!0})}));for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise((e=>{t=setTimeout(e,this.config.keepAliveInterval)}))]),this.ping().catch((e=>this.log?.error("ping error: %s",e)))}catch(e){return void clearInterval(t)}}}async handleFrame(e,t){const{streamID:n,type:r,length:s}=e;if(this.log?.trace("received frame %o",e),0===n)switch(r){case Ub.Ping:return void this.handlePing(e);case Ub.GoAway:return void this.handleGoAway(s);default:throw new k("Invalid frame type",kb,{header:e})}else switch(e.type){case Ub.Data:case Ub.WindowUpdate:return void await this.handleStreamMessage(e,t);default:throw new k("Invalid frame type",kb,{header:e})}}handlePing(e){if(e.flag===Fb.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Fb.ACK);else{if(e.flag!==Fb.ACK)throw new k("Invalid frame flag",kb,{header:e});this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length)}}handlePingResponse(e){if(void 0===this.activePing)throw new k("ping not requested",Ab);if(this.activePing.id!==e)throw new k("ping doesn't match our id",Ib);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",$b[e]??"unknown"),this.remoteGoAway=e;for(const e of this._streams.values())e.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:n,flag:r,type:s}=e;(r&Fb.SYN)===Fb.SYN&&this.incomingStream(n);const i=this._streams.get(n);if(void 0!==i)switch(s){case Ub.WindowUpdate:return void i.handleWindowUpdate(e);case Ub.Data:if(void 0===t)throw new Error("unreachable");return void await i.handleData(e,t);default:throw new Error("unreachable")}else if(s===Ub.Data){if(this.log?.("discarding data for stream id=%s",n),void 0===t)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n)}incomingStream(e){if(this.client!==(e%2==0))throw new k("both endpoints are clients",Db);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),void 0!==this.localGoAway)return void this.sendFrame({type:Ub.WindowUpdate,flag:Fb.RST,streamID:e,length:0});if(this.numInboundStreams>=this.config.maxInboundStreams)return this.log?.("maxIncomingStreams exceeded, forcing stream reset"),void this.sendFrame({type:Ub.WindowUpdate,flag:Fb.RST,streamID:e,length:0});const t=this._newStream(e,void 0,jb.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===Ub.Data){if(void 0===t)throw new k("invalid frame",kb);this.source.push(new ue(Hb(e),t))}else this.source.push(Hb(e))}sendPing(e,t=Fb.SYN){t===Fb.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:Ub.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=$b.NormalTermination){this.log?.("sending GoAway reason=%s",$b[e]),this.localGoAway=e,this.sendFrame({type:Ub.GoAway,flag:0,streamID:0,length:e})}}function Xb(e={}){return t=>new Qb(t,e)}async function*Zb(e,t={}){const n=e.getReader();try{for(;;){const e=await n.read();if(e.done)return;yield e.value}}finally{!0!==t.preventCancel&&await n.cancel(),n.releaseLock()}}const eE="ERR_UNRECOGNIZED_VALIDITY",tE="ERR_SIGNATURE_VERIFICATION",nE="ERR_UNDEFINED_PARAMETER",rE="ERR_RECORD_TOO_LARGE";var sE;!function(e){let t,n,r;!function(e){e.EOL="EOL"}(t=e.ValidityType||(e.ValidityType={})),function(e){e[e.EOL=0]="EOL"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.ValidityType||(e.ValidityType={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.value&&(n.uint32(10),n.bytes(t.value)),null!=t.signatureV1&&(n.uint32(18),n.bytes(t.signatureV1)),null!=t.validityType&&(n.uint32(24),e.ValidityType.codec().encode(t.validityType,n)),null!=t.validity&&(n.uint32(34),n.bytes(t.validity)),null!=t.sequence&&(n.uint32(40),n.uint64(t.sequence)),null!=t.ttl&&(n.uint32(48),n.uint64(t.ttl)),null!=t.pubKey&&(n.uint32(58),n.bytes(t.pubKey)),null!=t.signatureV2&&(n.uint32(66),n.bytes(t.signatureV2)),null!=t.data&&(n.uint32(74),n.bytes(t.data)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.value=t.bytes();break;case 2:r.signatureV1=t.bytes();break;case 3:r.validityType=e.ValidityType.codec().decode(t);break;case 4:r.validity=t.bytes();break;case 5:r.sequence=t.uint64();break;case 6:r.ttl=t.uint64();break;case 7:r.pubKey=t.bytes();break;case 8:r.signatureV2=t.bytes();break;case 9:r.data=t.bytes();break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(sE||(sE={}));const iE=Zo("ipns:utils"),oE=Ln("/ipns/"),aE=async(e,t)=>{if(null==t||null==e){const e=new Error("one or more of the provided parameters are not defined");throw iE.error(e),Do(e,nE)}let n;if(null!=t.pubKey){try{n=Ug(t.pubKey)}catch(e){throw iE.error(e),e}if(!(await Cr(t.pubKey)).equals(e))throw Do(new Error("Embedded public key did not match PeerID"),"ERR_INVALID_EMBEDDED_KEY")}else null!=e.publicKey&&(n=Ug(e.publicKey));if(null!=n)return n;throw Do(new Error("no public key is available"),nE)},cE=e=>"signatureV1"in e?sE.encode({value:Ln(e.value),signatureV1:e.signatureV1,validityType:e.validityType,validity:Ln(e.validity),sequence:e.sequence,ttl:e.ttl,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data}):sE.encode({pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data});function lE(e){const t=sE.decode(e);if(null!=t.sequence&&(t.sequence=BigInt(t.sequence)),null!=t.ttl&&(t.ttl=BigInt(t.ttl)),null==t.signatureV2||null==t.data)throw Do(new Error("missing data or signatureV2"),tE);const n=hE(t.data),r=dE(n.Value),s=mr(n.Validity);if(null!=t.value&&null!=t.signatureV1)return fE(t),{value:r,validityType:sE.ValidityType.EOL,validity:s,sequence:n.Sequence,ttl:n.TTL,pubKey:t.pubKey,signatureV1:t.signatureV1,signatureV2:t.signatureV2,data:t.data};if(null!=t.signatureV2)return{value:r,validityType:sE.ValidityType.EOL,validity:s,sequence:n.Sequence,ttl:n.TTL,pubKey:t.pubKey,signatureV2:t.signatureV2,data:t.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}const uE=e=>Dr(e.slice(oE.length)),hE=e=>{const t=nl(e);if(0!==t.ValidityType)throw Do(new Error("Unknown validity type"),eE);return t.ValidityType=sE.ValidityType.EOL,Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t},dE=e=>{if(null!=e){if(yr(e))return`/ipns/${e.toCID().toString(At)}`;if(e instanceof Uint8Array){const t=mr(e);t.startsWith("/")&&(e=t)}const t=e.toString().trim();if(t.startsWith("/")&&t.length>1)return t;const n=Rn.asCID(e);if(null!=n)return 114===n.code?`/ipns/${n.toString(At)}`:`/ipfs/${n.toV1().toString()}`;try{return e instanceof Uint8Array?`/ipfs/${Rn.decode(e).toV1().toString()}`:`/ipfs/${Rn.parse(t).toV1().toString()}`}catch{}}throw Do(new Error("Value must be a valid content path starting with /"),"ERR_INVALID_VALUE")},fE=e=>{if(null==e.data)throw Do(new Error("Record data is missing"),"ERR_INVALID_RECORD_DATA");const t=hE(e.data);if(!oe(t.Value,e.value??new Uint8Array(0)))throw Do(new Error('Field "value" did not match between protobuf and CBOR'),tE);if(!oe(t.Validity,e.validity??new Uint8Array(0)))throw Do(new Error('Field "validity" did not match between protobuf and CBOR'),tE);if(t.ValidityType!==e.validityType)throw Do(new Error('Field "validityType" did not match between protobuf and CBOR'),tE);if(t.Sequence!==e.sequence)throw Do(new Error('Field "sequence" did not match between protobuf and CBOR'),tE);if(t.TTL!==e.ttl)throw Do(new Error('Field "ttl" did not match between protobuf and CBOR'),tE)};var pE=n(454);const gE=Zo("ipns:validator"),yE=10240,mE=async(e,t)=>{const n=lE(t);let r;try{const t=(s=n.data,ie([Ln("ipns-signature:"),s]));r=await e.verify(t,n.signatureV2)}catch(e){r=!1}var s;if(!r)throw gE.error("record signature verification failed"),Do(new Error("record signature verification failed"),tE);if(n.validityType===sE.ValidityType.EOL){if(pE.fromString(n.validity).toDate().getTime()<Date.now())throw gE.error("record has expired"),Do(new Error("record has expired"),"ERR_IPNS_EXPIRED_RECORD")}else if(null!=n.validityType)throw gE.error("unrecognized validity type"),Do(new Error("unrecognized validity type"),eE);gE("ipns record for %s is valid",n.value)};async function wE(e,t){if(t.byteLength>yE)throw Do(new Error("record too large"),rE);const n=uE(e),r=lE(t),s=await aE(n,r);await mE(s,t)}async function*bE(e){const t=/\r?\n/,n=new TextDecoder("utf8");let r="";for await(let s of e){"string"==typeof s&&(s=(new TextEncoder).encode(s)),r+=n.decode(s,{stream:!0});const e=r.split(t);r=e.pop()??"";for(let t=0;t<e.length;t++)yield JSON.parse(e[t])}r+=n.decode(),""!==r&&(yield JSON.parse(r))}const EE=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e)return t})();for(const t of e)return t},vE=Ln("/ipns/");function SE(e){return oe(e.subarray(0,vE.byteLength),vE)}const _E=e=>Dr(e.slice(vE.length));class RE{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*Se(this.client.getProviders(e,t),(e=>({id:e.ID,multiaddrs:e.Addrs??[]})))}async provide(){}async put(e,t,n){if(!SE(e))return;const r=_E(e),s=lE(t);await this.client.putIPNS(r,s,n)}async get(e,t){if(!SE(e))throw new k("Not found","ERR_NOT_FOUND");const n=_E(e);try{const e=await this.client.getIPNS(n,t);return cE(e)}catch(e){if("ERR_BAD_RESPONSE"===e.code)throw new k("Not found","ERR_NOT_FOUND");throw e}}}class kE{client;constructor(e){this.client=e}async findPeer(e,t={}){const n=await EE(this.client.getPeers(e,t));if(null!=n)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new k("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){}}const AE=Zo("delegated-routing-v1-http-api-client");class IE{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new Sa({concurrency:t.concurrentRequests??4}),this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??3e4,this.contentRouting=new RE(this),this.peerRouting=new kE(this)}get[ua](){return this.contentRouting}get[ha](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(e,t={}){AE("getProviders starts: %c",e);const n=AbortSignal.timeout(this.timeout),r=v([this.shutDownController.signal,n,t.signal]),s=x(),i=x();this.httpQueue.add((async()=>(s.resolve(),i.promise)));try{await s.promise;const t=`${this.clientUrl}routing/v1/providers/${e.toString()}`,n={headers:{Accept:"application/x-ndjson"},signal:r},i=await fetch(t,n);if(404===i.status)throw new k("No matching records found.","ERR_NOT_FOUND");if(422===i.status)throw new k("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==i.body)throw new k("Routing response had no body","ERR_BAD_RESPONSE");if("application/json"===i.headers.get("Content-Type")){const e=await i.json();for(const t of e.Providers){const e=this.#z(t);null!=e&&(yield e)}}else for await(const e of bE(Zb(i.body))){const t=this.#z(e);null!=t&&(yield t)}}catch(e){AE.error("getProviders errored:",e)}finally{r.clear(),i.resolve(),AE("getProviders finished: %c",e)}}async*getPeers(e,t={}){AE("getPeers starts: %c",e);const n=AbortSignal.timeout(this.timeout),r=v([this.shutDownController.signal,n,t.signal]),s=x(),i=x();this.httpQueue.add((async()=>(s.resolve(),i.promise)));try{await s.promise;const t=`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`,n={headers:{Accept:"application/x-ndjson"},signal:r},i=await fetch(t,n);if(404===i.status)throw new k("No matching records found.","ERR_NOT_FOUND");if(422===i.status)throw new k("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==i.body)throw new k("Routing response had no body","ERR_BAD_RESPONSE");if("application/json"===i.headers.get("Content-Type")){const e=await i.json();for(const t of e.Peers){const e=this.#z(t);null!=e&&(yield e)}}else for await(const e of bE(Zb(i.body))){const t=this.#z(e);null!=t&&(yield t)}}catch(e){AE.error("getPeers errored:",e)}finally{r.clear(),i.resolve(),AE("getPeers finished: %c",e)}}async getIPNS(e,t={}){AE("getIPNS starts: %c",e);const n=AbortSignal.timeout(this.timeout),r=v([this.shutDownController.signal,n,t.signal]),s=x(),i=x();this.httpQueue.add((async()=>(s.resolve(),i.promise)));const o=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await s.promise;const n={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:r},i=await fetch(o,n);if(AE("getIPNS GET %s %d",o,i.status),404===i.status)throw new k("No matching records found.","ERR_NOT_FOUND");if(422===i.status)throw new k("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==i.body)throw new k("GET ipns response had no body","ERR_BAD_RESPONSE");const a=await i.arrayBuffer(),c=new Uint8Array(a,0,a.byteLength);return!1!==t.validate&&await wE((e=>ie([oE,e.toBytes()]))(e),c),lE(c)}catch(e){throw AE.error("getIPNS GET %s error:",o,e),e}finally{r.clear(),i.resolve(),AE("getIPNS finished: %c",e)}}async putIPNS(e,t,n={}){AE("putIPNS starts: %c",e);const r=AbortSignal.timeout(this.timeout),s=v([this.shutDownController.signal,r,n.signal]),i=x(),o=x();this.httpQueue.add((async()=>(i.resolve(),o.promise)));const a=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await i.promise;const e={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:cE(t),signal:s},n=await fetch(a,e);if(AE("putIPNS PUT %s %d",a,n.status),200!==n.status)throw new k("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}catch(e){throw AE.error("putIPNS PUT %s error:",a,e.stack),e}finally{s.clear(),o.resolve(),AE("putIPNS finished: %c",e)}}#z(e){try{const t=[],n=e.Addrs?.map(ei)??[];return null!=e.Protocols&&t.push(...e.Protocols),null!=e.Protocol&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:xr(e.ID),Addrs:n,Protocols:t}}catch(e){AE.error("could not conform record to peer schema",e)}}}var TE;!function(e){let t,n,r,s,i,o,a,c;!function(e){e.DIAL="DIAL",e.DIAL_RESPONSE="DIAL_RESPONSE"}(t=e.MessageType||(e.MessageType={})),function(e){e[e.DIAL=0]="DIAL",e[e.DIAL_RESPONSE=1]="DIAL_RESPONSE"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.MessageType||(e.MessageType={})),function(e){e.OK="OK",e.E_DIAL_ERROR="E_DIAL_ERROR",e.E_DIAL_REFUSED="E_DIAL_REFUSED",e.E_BAD_REQUEST="E_BAD_REQUEST",e.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(r=e.ResponseStatus||(e.ResponseStatus={})),function(e){e[e.OK=0]="OK",e[e.E_DIAL_ERROR=100]="E_DIAL_ERROR",e[e.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",e[e.E_BAD_REQUEST=200]="E_BAD_REQUEST",e[e.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"}(s||(s={})),function(e){e.codec=()=>or(s)}(r=e.ResponseStatus||(e.ResponseStatus={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const n of e.addrs)t.uint32(18),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={addrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(i=e.PeerInfo||(e.PeerInfo={})),function(t){let n;t.codec=()=>(null==n&&(n=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.peer&&(n.uint32(10),e.PeerInfo.codec().encode(t.peer,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();n>>>3==1?r.peer=e.PeerInfo.codec().decode(t,t.uint32()):t.skipType(7&n)}return r}))),n),t.encode=e=>Gn(e,t.codec()),t.decode=e=>Qe(e,t.codec())}(o=e.Dial||(e.Dial={})),function(t){let n;t.codec=()=>(null==n&&(n=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.status&&(n.uint32(8),e.ResponseStatus.codec().encode(t.status,n)),null!=t.statusText&&(n.uint32(18),n.string(t.statusText)),null!=t.addr&&(n.uint32(26),n.bytes(t.addr)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.status=e.ResponseStatus.codec().decode(t);break;case 2:r.statusText=t.string();break;case 3:r.addr=t.bytes();break;default:t.skipType(7&n)}}return r}))),n),t.encode=e=>Gn(e,t.codec()),t.decode=e=>Qe(e,t.codec())}(a=e.DialResponse||(e.DialResponse={})),e.codec=()=>(null==c&&(c=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.MessageType.codec().encode(t.type,n)),null!=t.dial&&(n.uint32(18),e.Dial.codec().encode(t.dial,n)),null!=t.dialResponse&&(n.uint32(26),e.DialResponse.codec().encode(t.dialResponse,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.MessageType.codec().decode(t);break;case 2:r.dial=e.Dial.codec().decode(t,t.uint32());break;case 3:r.dialResponse=e.DialResponse.codec().decode(t,t.uint32());break;default:t.skipType(7&n)}}return r}))),c),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(TE||(TE={}));class xE{components;startupDelay;refreshInterval;protocol;timeout;maxInboundStreams;maxOutboundStreams;verifyAddressTimeout;started;log;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:autonat"),this.started=!1,this.protocol=`/${t.protocolPrefix??"libp2p"}/autonat/1.0.0`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.startupDelay=t.startupDelay??5e3,this.refreshInterval=t.refreshInterval??6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}[Symbol.toStringTag]="@libp2p/autonat";isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,(e=>{this.handleIncomingAutonatStream(e).catch((e=>{this.log.error("error handling incoming autonat stream",e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),n=()=>{e.stream.abort(new k("handleIncomingAutonatStream timeout",I))};t.addEventListener("abort",n,{once:!0});try{const n=this;await Re(e.stream,(e=>Ee(e)),(async function*(r){const s=await EE(r);if(null==s)return n.log("no message received"),void(yield TE.encode({type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}}));let i;try{i=TE.decode(s)}catch(e){return n.log.error("could not decode message",e),void(yield TE.encode({type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}}))}yield TE.encode(await n.handleAutonatMessage(i,e.connection,{signal:t}))}),(e=>fe(e)),e.stream)}catch(e){this.log.error("error handling incoming autonat stream",e)}finally{t.removeEventListener("abort",n)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch((e=>{this.log.error("error verifying external address",e)}))}async handleAutonatMessage(e,t,n){const r=this.components.addressManager.getAddresses().map((e=>e.toOptions().host)),s=e.dial;if(null==s)return this.log.error("dial was missing from message"),{type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let i;const o=s.peer;if(null==o?.id)return this.log.error("PeerId missing from message"),{type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{i=Dr(o.id)}catch(e){return this.log.error("invalid PeerId",e),{type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",i),!t.remotePeer.equals(i))return this.log("target peer %p did not equal sending peer %p",i,t.remotePeer),{type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const a=o.addrs.map((e=>ei(e))).filter((e=>{const n=e.toOptions().host===t.remoteAddr.toOptions().host;return this.log.trace("request to dial %a was sent from %a is same host %s",e,t.remoteAddr,n),n})).filter((e=>{const t=e.toOptions().host,n=!Rs(t);return this.log.trace("host %s was public %s",t,n),n})).filter((e=>{const t=e.toOptions().host,n=!r.includes(t);return this.log.trace("host %s was not our host %s",t,n),n})).filter((e=>{const t=Boolean(this.components.transportManager.dialTransportForMultiaddr(e));return this.log.trace("transport for %a is supported %s",e,t),t})).map((e=>(null==e.getPeerId()&&(e=e.encapsulate(`/p2p/${i.toString()}`)),e)));if(0===a.length)return this.log("no valid multiaddrs for %p in message",i),{type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",a.map((e=>e.toString())).join(", "),i);let c="",l=a[0];for await(const e of a){let t;l=e;try{if(t=await this.components.connectionManager.openConnection(e,n),!t.remoteAddr.equals(e))throw this.log.error("tried to dial %a but dialed %a",e,t.remoteAddr),new Error("Unexpected remote address");return this.log("Success %p",i),{type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.OK,addr:t.remoteAddr.decapsulateCode(Ns("p2p").code).bytes}}}catch(e){this.log("could not dial %p",i,e),c=e.message}finally{null!=t&&await t.close()}}return{type:TE.MessageType.DIAL_RESPONSE,dialResponse:{status:TE.ResponseStatus.E_DIAL_ERROR,statusText:c,addr:l.bytes}}}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;const e=this.components.addressManager,t=e.getObservedAddrs().filter((e=>!Rs(e.toOptions().host)));if(0===t.length)return this.log("no public addresses found, not requesting verification"),void(this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval));const n=AbortSignal.timeout(this.timeout),r=this;try{this.log("verify multiaddrs %s",t.map((e=>e.toString())).join(", "));const s=TE.encode({type:TE.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:t.map((e=>e.bytes))}}}),i={},o=[],a=async e=>{let t=()=>{};try{this.log("asking %p to verify multiaddr",e.id);const i=await r.components.connectionManager.openConnection(e.id,{signal:n}),a=await i.newStream(this.protocol,{signal:n});t=()=>{a.abort(new k("verifyAddress timeout",I))},n.addEventListener("abort",t,{once:!0});const c=await Re([s],(e=>fe(e)),a,(e=>Ee(e)),(async e=>EE(e)));if(null==c)return void this.log("no response received from %p",i.remotePeer);const l=TE.decode(c);if(l.type!==TE.MessageType.DIAL_RESPONSE||null==l.dialResponse)return void this.log("invalid autonat response from %p",i.remotePeer);if(l.dialResponse.status===TE.ResponseStatus.OK){const e=i.remoteAddr.toOptions();let t;if(4===e.family)t=e.host.split(".")[0];else{if(6!==e.family)return void this.log('remote address "%s" was not IP4 or IP6?',e.host);t=e.host.split(":")[0]}if(o.includes(t))return void this.log("already have response from network segment %d - %s",t,e.host);o.push(t)}return l.dialResponse}catch(e){this.log.error("error asking remote to verify multiaddr",e)}finally{n.removeEventListener("abort",t)}};for await(const r of Ym(Se(this.components.randomWalk.walk({signal:n}),(e=>async()=>a(e))),{concurrency:4}))try{if(null==r)continue;const n=null==r.addr?t[0]:ei(r.addr);if(this.log("autonat response for %a is %s",n,r.status),r.status===TE.ResponseStatus.E_BAD_REQUEST)continue;if(r.status===TE.ResponseStatus.E_DIAL_REFUSED)continue;if(null==r.addr&&t.length>1)continue;if(!t.some((e=>e.equals(n)))){this.log("peer reported %a as %s but it was not in our observed address list",n,r.status);continue}const s=n.toString();if(null==i[s]&&(i[s]={success:0,failure:0}),r.status===TE.ResponseStatus.OK?i[s].success++:r.status===TE.ResponseStatus.E_DIAL_ERROR&&i[s].failure++,4===i[s].success)return this.log("%a is externally dialable",n),void e.confirmObservedAddr(n);if(4===i[s].failure)return this.log("%a is not externally dialable",n),void e.removeObservedAddr(n)}catch(e){this.log.error("could not verify external address",e)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}}function DE(e={}){return t=>new xE(t,e)}const CE=cv("dns4"),NE=cv("dns6"),PE=cv("dnsaddr"),LE=av(cv("dns"),PE,CE,NE),BE=av(cv("ip4"),cv("ip6")),OE=av(ov(BE,cv("tcp")),ov(LE,cv("tcp"))),ME=ov(BE,cv("udp")),UE=ov(ME,cv("utp")),FE=ov(ME,cv("quic")),$E=ov(ME,cv("quic-v1")),VE=av(ov(OE,cv("ws")),ov(LE,cv("ws"))),zE=av(ov(VE,cv("p2p")),VE),HE=av(ov(OE,cv("wss")),ov(LE,cv("wss")),ov(OE,cv("tls"),cv("ws")),ov(LE,cv("tls"),cv("ws"))),KE=av(ov(HE,cv("p2p")),HE),qE=av(ov(OE,cv("http")),ov(BE,cv("http")),ov(LE,cv("http"))),WE=av(ov(OE,cv("https")),ov(BE,cv("https")),ov(LE,cv("https"))),jE=ov(ME,cv("webrtc-direct"),cv("certhash")),GE=av(ov(jE,cv("p2p")),jE),YE=ov($E,cv("webtransport"),cv("certhash"),cv("certhash")),QE=av(ov(YE,cv("p2p")),YE),JE=av(ov(zE,cv("p2p-webrtc-star"),cv("p2p")),ov(KE,cv("p2p-webrtc-star"),cv("p2p")),ov(zE,cv("p2p-webrtc-star")),ov(KE,cv("p2p-webrtc-star"))),XE=(av(ov(zE,cv("p2p-websocket-star"),cv("p2p")),ov(KE,cv("p2p-websocket-star"),cv("p2p")),ov(zE,cv("p2p-websocket-star")),ov(KE,cv("p2p-websocket-star"))),av(ov(qE,cv("p2p-webrtc-direct"),cv("p2p")),ov(WE,cv("p2p-webrtc-direct"),cv("p2p")),ov(qE,cv("p2p-webrtc-direct")),ov(WE,cv("p2p-webrtc-direct")))),ZE=av(VE,HE,qE,WE,JE,XE,OE,UE,FE,LE,GE,QE),ev=(av(ov(ZE,cv("p2p-stardust"),cv("p2p")),ov(ZE,cv("p2p-stardust"))),av(ov(ZE,cv("p2p")),JE,XE,GE,QE,cv("p2p"))),tv=av(ov(ev,cv("p2p-circuit"),ev),ov(ev,cv("p2p-circuit")),ov(cv("p2p-circuit"),ev),ov(ZE,cv("p2p-circuit")),ov(cv("p2p-circuit"),ZE),cv("p2p-circuit")),nv=()=>av(ov(tv,nv),tv),rv=nv(),sv=av(ov(rv,ev,rv),ov(ev,rv),ov(rv,ev),rv,ev);function iv(e){return function(t){let n;try{n=ei(t)}catch(e){return!1}const r=e(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function ov(...e){function t(t){if(t.length<e.length)return null;let n=t;return e.some((e=>(n="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(n)&&(t=n),null===n))),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:iv(t),partialMatch:t}}function av(...e){function t(t){let n=null;return e.some((e=>{const r="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:iv(t),partialMatch:t}}function cv(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=ei(e)}catch(e){return!1}const r=n.protoNames();return 1===r.length&&r[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}av(ov(rv,cv("webrtc"),cv("p2p")),ov(rv,cv("webrtc")),ov(ZE,cv("webrtc"),cv("p2p")),ov(ZE,cv("webrtc")),cv("webrtc"));class lv extends S{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(null==t.list||0===t.list.length)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??1e3,this.list=[];for(const e of t.list){if(!sv.matches(e)){this.log.error("Invalid multiaddr");continue}const t=ei(e),n=t.getPeerId();if(null==n){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const r={id:xr(n),multiaddrs:[t]};this.list.push(r)}this._init=t}[ny]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[zg]=["@libp2p/peer-discovery"];isStarted(){return Boolean(this.timer)}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout((()=>{this._discoverBootstrapPeers().catch((e=>{this.log.error(e)}))}),this.timeout))}async _discoverBootstrapPeers(){if(null!=this.timer)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??"bootstrap"]:{value:this._init.tagValue??50,ttl:this._init.tagTTL??12e4}}}),null==this.timer)return;this.safeDispatchEvent("peer",{detail:e})}}stop(){null!=this.timer&&clearTimeout(this.timer),this.timer=void 0}}function uv(e){return t=>new lv(t,e)}class hv{filter;constructor(e,t){this.filter=jm(e,t)}has(e){return this.filter.has(e.toBytes())}add(e){this.filter.add(e.toBytes())}remove(e){this.filter.remove?.(e.toBytes())}}function dv(e,t=.001){return new hv(e,t)}function fv(e){const{stream:t,remoteAddr:n,logger:r}=e,s=r.forComponent("libp2p:stream:converter");let i=!1,o=!1;const a=t.close.bind(t);t.close=async e=>{await a(e),h(!0)};const c=t.abort.bind(t);t.abort=e=>{c(e),h(!0)};const l=t.sink.bind(t);t.sink=async e=>{try{await l(e)}catch(e){"aborted"!==e.type&&s.error("%s error in sink",n,e)}finally{o=!0,h()}};const u={log:s,sink:t.sink,source:async function*(){try{for await(const e of t.source)e instanceof Uint8Array?yield e:yield*e}finally{i=!0,h()}}(),remoteAddr:n,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function h(e){!0===e&&(i=!0,o=!0),i&&o&&null==u.timeline.close&&(u.timeline.close=Date.now())}return u}function pv(e,t){const n=rw(e,t),r={read:async(e,t)=>{const r=await n.read(t);return e.decode(r)},write:async(e,t,r)=>{await n.write(t.encode(e),r)},writeV:async(e,t,r)=>{await n.writeV(e.map((e=>t.encode(e))),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,n)=>r.write(t,e,n),writeV:async(t,n)=>r.writeV(t,e,n),unwrap:()=>r}),unwrap:()=>n.unwrap()};return r}const gv="circuit-relay-relay",yv=(BigInt(1<<17),"/libp2p/circuit/relay/0.2.0/hop"),mv="/libp2p/circuit/relay/0.2.0/stop",wv="ERR_RELAYED_DIAL";var bv,Ev,vv,Sv,_v,Rv,kv,Av;!function(e){let t,n,r;!function(e){e.RESERVE="RESERVE",e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),vv.codec().encode(t.peer,n)),null!=t.reservation&&(n.uint32(26),Sv.codec().encode(t.reservation,n)),null!=t.limit&&(n.uint32(34),_v.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(40),Rv.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n,r={})=>{const s={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:s.type=e.Type.codec().decode(t);break;case 2:s.peer=vv.codec().decode(t,t.uint32(),{limits:r.limits?.peer});break;case 3:s.reservation=Sv.codec().decode(t,t.uint32(),{limits:r.limits?.reservation});break;case 4:s.limit=_v.codec().decode(t,t.uint32(),{limits:r.limits?.limit});break;case 5:s.status=Rv.codec().decode(t);break;default:t.skipType(7&n)}}return s}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(bv||(bv={})),function(e){let t,n,r;!function(e){e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),vv.codec().encode(t.peer,n)),null!=t.limit&&(n.uint32(26),_v.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(32),Rv.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n,r={})=>{const s={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:s.type=e.Type.codec().decode(t);break;case 2:s.peer=vv.codec().decode(t,t.uint32(),{limits:r.limits?.peer});break;case 3:s.limit=_v.codec().decode(t,t.uint32(),{limits:r.limits?.limit});break;case 4:s.status=Rv.codec().decode(t);break;default:t.skipType(7&n)}}return s}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(Ev||(Ev={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const n of e.addrs)t.uint32(18),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={id:H(0),addrs:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.id=e.bytes();break;case 2:if(null!=n.limits?.addrs&&r.addrs.length===n.limits.addrs)throw new cr('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");r.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(vv||(vv={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.expire&&0n!==e.expire&&(t.uint32(8),t.uint64(e.expire)),null!=e.addrs)for(const n of e.addrs)t.uint32(18),t.bytes(n);null!=e.voucher&&(t.uint32(26),t.bytes(e.voucher)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={expire:0n,addrs:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.expire=e.uint64();break;case 2:if(null!=n.limits?.addrs&&r.addrs.length===n.limits.addrs)throw new cr('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");r.addrs.push(e.bytes());break;case 3:r.voucher=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(Sv||(Sv={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.duration&&(t.uint32(8),t.uint32(e.duration)),null!=e.data&&(t.uint32(16),t.uint64(e.data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.duration=e.uint32();break;case 2:r.data=e.uint64();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(_v||(_v={})),function(e){e.UNUSED="UNUSED",e.OK="OK",e.RESERVATION_REFUSED="RESERVATION_REFUSED",e.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONNECTION_FAILED="CONNECTION_FAILED",e.NO_RESERVATION="NO_RESERVATION",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE",e.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"}(Rv||(Rv={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.OK=100]="OK",e[e.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",e[e.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",e[e.PERMISSION_DENIED=202]="PERMISSION_DENIED",e[e.CONNECTION_FAILED=203]="CONNECTION_FAILED",e[e.NO_RESERVATION=204]="NO_RESERVATION",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",e[e.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"}(kv||(kv={})),function(e){e.codec=()=>or(kv)}(Rv||(Rv={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.relay&&e.relay.byteLength>0&&(t.uint32(10),t.bytes(e.relay)),null!=e.peer&&e.peer.byteLength>0&&(t.uint32(18),t.bytes(e.peer)),null!=e.expiration&&0n!==e.expiration&&(t.uint32(24),t.uint64(e.expiration)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={relay:H(0),peer:H(0),expiration:0n},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.relay=e.bytes();break;case 2:r.peer=e.bytes();break;case 3:r.expiration=e.uint64();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(Av||(Av={}));class Iv extends S{peerStore;registrar;connectionManager;randomWalk;started;running;topologyId;log;discoveryController;filter;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(yv,{filter:this.filter,onConnect:e=>{this.log("discovered relay %p",e),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then((async()=>{this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[e=>e.protocols.includes(yv)],orders:[()=>Math.random()<.5?1:-1]});for(const t of e)this.log.trace("found relay peer %p in peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});this.log("found %d relay peers in peer store",e.length);const t=new V({concurrency:5});this.log("start random walk");for await(const e of this.randomWalk.walk({signal:this.discoveryController.signal}))this.log.trace("found random peer %p",e.id),t.has(e.id)?this.log.trace("random peer %p was already in queue",e.id):this.connectionManager.getConnections(e.id)?.length>0?this.log.trace("random peer %p was already connected",e.id):await this.connectionManager.isDialable(e.multiaddrs)?(this.log.trace("wait for space in queue for %p",e.id),await M(t.onSizeLessThan(10),this.discoveryController.signal),this.log("adding random peer %p to dial queue (length: %d)",e.id,t.size),t.add((async()=>{const t=v([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(e.id,{signal:t})}finally{t.clear()}}),{peerId:e.id,signal:this.discoveryController.signal}).catch((t=>{this.log.error("error opening connection to random peer %p",e.id,t)}))):this.log.trace("random peer %p was not dialable",e.id,e.multiaddrs.map((e=>e.toString())));await t.onIdle()})).catch((e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)})))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}}class Tv extends S{connectionManager;relayStore;listeningAddrs;log;constructor(e){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Pr,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}_onRemoveRelayPeer=e=>{this.#H(e.detail)};async listen(e){this.log("listen on %a",e);const t=e.decapsulate("/p2p-circuit"),n=await this.connectionManager.openConnection(t);if(!this.relayStore.hasReservation(n.remotePeer))return this.log("making reservation on peer %p",n.remotePeer),void await this.relayStore.addRelay(n.remotePeer,"configured");const r=this.relayStore.getReservation(n.remotePeer);if(null==r)throw new k("Did not have reservation after making reservation","ERR_NO_RESERVATION");this.listeningAddrs.has(n.remotePeer)?this.log("already listening on relay %p",n.remotePeer):(this.listeningAddrs.set(n.remotePeer,r.addrs.map((e=>ei(e).encapsulate("/p2p-circuit")))),this.safeDispatchEvent("listening",{}))}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}#H(e){const t=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}}const xv=Math.LN2*Math.LN2;class Dv{seeds;bits;buffer;constructor(e={}){null!=e.seeds?this.seeds=e.seeds:this.seeds=function(e){let t,n;const r=[];for(let s=0;s<e;s++)for(t=new ue(ts(4)),r[s]=t.getUint32(0,!0),n=0;n<s;n++)if(r[s]===r[n]){s--;break}return r}(e.hashes??8),this.bits=e.bits??1024,this.buffer=H(Math.ceil(this.bits/8))}add(e){"string"==typeof e&&(e=Ln(e));for(let t=0;t<this.seeds.length;t++){const n=ns.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(n)}}has(e){"string"==typeof e&&(e=Ln(e));for(let t=0;t<this.seeds.length;t++){const n=ns.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(n))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;let r=this.buffer[t];r|=1<<n,this.buffer[t]=r}getbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;return!!(this.buffer[t]&1<<n)}}function Cv(e){const t=e*BigInt(1e3),n=(new Date).getTime();return Number(t-BigInt(n))}class Nv extends S{peerId;connectionManager;transportManager;peerStore;events;reserveQueue;reservations;maxDiscoveredRelays;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Pr,this.maxDiscoveredRelays=t?.discoverRelays??0,this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??1e3,this.started=!1,this.relayFilter=function(e,t=.005){const n=function(e,t=.005){const n=Math.round(-1*e*Math.log(t)/xv);return{bits:n,hashes:Math.round(n/e*Math.LN2)}}(e,t);return new Dv(n)}(100),this.reserveQueue=new V({concurrency:t?.reservationConcurrency??1,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("peer:disconnect",(e=>{this.#K(e.detail)}))}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))}stop(){this.reserveQueue.clear(),this.reservations.forEach((({timeout:e})=>{clearTimeout(e)})),this.reservations.clear(),this.started=!1}async addRelay(e,t){this.peerId.equals(e)?this.log("not trying to use self as relay"):this.reserveQueue.size>this.maxReservationQueueLength?this.log("not adding potential relay peer %p as the queue is full",e):this.reserveQueue.has(e)?this.log("potential relay peer %p is already in the reservation queue",e):this.relayFilter.has(e.toBytes())?this.log("potential relay peer %p has failed previously, not trying again",e):(this.log("try to reserve relay slot with %p",e),await this.reserveQueue.add((async()=>{const n=Date.now();try{const n=this.reservations.get(e);if(null!=n){if(Cv(n.reservation.expire)>6e5)return void this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);clearTimeout(n.timeout),this.reservations.delete(e)}if("discovered"===t&&[...this.reservations.values()].reduce(((e,t)=>("discovered"===t.type&&e++,e)),0)>=this.maxDiscoveredRelays)return void this.log("already have enough discovered relays");const r=AbortSignal.timeout(this.reservationCompletionTimeout),s=await this.connectionManager.openConnection(e,{signal:r});if(s.remoteAddr.protoNames().includes("p2p-circuit"))return void this.log("not creating reservation over relayed connection");const i=await this.#q(s,{signal:r});this.log("created reservation on relay peer %p",e);const o=Cv(i.expire),a=Math.min(Math.max(o-3e5,3e4),Math.pow(2,31)-1),c=setTimeout((()=>{this.addRelay(e,t).catch((t=>{this.log.error("could not refresh reservation to relay %p",e,t)}))}),a);this.reservations.set(e,{timeout:c,reservation:i,type:t}),await this.peerStore.merge(e,{tags:{[gv]:{value:1,ttl:o}}}),await this.transportManager.listen([ei(`/p2p/${e.toString()}/p2p-circuit`)]),this.safeDispatchEvent("relay:created-reservation",{detail:e})}catch(t){this.log.error("could not reserve slot on %p after %dms",e,Date.now()-n,t);const r=this.reservations.get(e);null!=r&&clearTimeout(r.timeout),this.reservations.delete(e),this.relayFilter.add(e.toBytes())}}),{peerId:e}))}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(){return this.reservations.size}async#q(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(yv,t),r=pv(n).pb(bv);let s;await r.write({type:bv.Type.RESERVE},t);try{s=await r.read(t)}catch(e){throw n.abort(e),e}finally{"closed"!==n.status&&await n.close(t)}if(s.status===Rv.OK&&null!=s.reservation){let t=!1;const n=e.remoteAddr.bytes;for(const e of s.reservation.addrs)if(oe(n,e)){t=!0;break}return t||s.reservation.addrs.push(n),s.reservation}const i=`reservation failed with status ${s.status??"undefined"}`;throw this.log.error(i),new Error(i)}#K(e){const t=this.reservations.get(e);null!=t&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}}class Pv{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;stopTimeout;started;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??300,this.maxOutboundStopStreams=t.maxOutboundStopStreams??300,this.stopTimeout=t.stopTimeout??3e4;const n=t.discoverRelays??0;n>0&&(this.discovery=new Iv(e,{filter:t.discoveryFilter??dv(4096,.001)}),this.discovery.addEventListener("relay:discover",(e=>{this.reservationStore.addRelay(e.detail,"discovered").catch((t=>{this.log.error("could not add discovered relay %p",e.detail,t)}))}))),this.reservationStore=new Nv(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",(()=>{this.discovery?.startDiscovery()})),this.reservationStore.addEventListener("relay:created-reservation",(()=>{this.reservationStore.reservationCount()>=n&&this.discovery?.stopDiscovery()})),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[zg]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Hg](){return null!=this.discovery?["@libp2p/identify"]:[]}[My]=!0;isStarted(){return this.started}async start(){await this.registrar.handle(mv,(e=>{this.onStop(e).catch((t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)}))}),{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),await fa(this.discovery,this.reservationStore),this.started=!0}async stop(){await pa(this.discovery,this.reservationStore),await this.registrar.unhandle(mv),this.started=!1}async dial(e,t){if(1!==e.protoCodes().filter((e=>290===e)).length){const t="Invalid circuit relay address";throw this.log.error(t,e),new k(t,wv)}const n=e.toString().split("/p2p-circuit"),r=ei(n[0]),s=ei(n[n.length-1]),i=r.getPeerId(),o=s.getPeerId();if(null==i||null==o){const t=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw this.log.error(t),new k(t,wv)}const a=xr(i),c=xr(o);let l,u=!1,h=this.connectionManager.getConnections(a)[0];null==h?(await this.peerStore.merge(a,{multiaddrs:[r]}),t.onProgress?.(new Ce("circuit-relay:open-connection")),h=await this.connectionManager.openConnection(a,t),u=!0):t.onProgress?.(new Ce("circuit-relay:reuse-connection"));try{return t.onProgress?.(new Ce("circuit-relay:open-hop-stream")),l=await h.newStream(yv),await this.connectV2({stream:l,connection:h,destinationPeer:c,destinationAddr:s,relayAddr:r,ma:e,disconnectOnFailure:u,onProgress:t.onProgress})}catch(e){throw this.log.error("circuit relay dial to destination %p via relay %p failed",c,a,e),null!=l&&l.abort(e),u&&await h.close(),e}}async connectV2({stream:e,connection:t,destinationPeer:n,destinationAddr:r,relayAddr:s,ma:i,disconnectOnFailure:o,onProgress:a}){try{const t=pv(e),o=t.pb(bv);a?.(new Ce("circuit-relay:write-connect-message")),await o.write({type:bv.Type.CONNECT,peer:{id:n.toBytes(),addrs:[ei(r).bytes]}}),a?.(new Ce("circuit-relay:read-connect-response"));const c=await o.read();if(c.status!==Rv.OK)throw new k(`failed to connect via relay with status ${c?.status?.toString()??"undefined"}`,"ERR_HOP_REQUEST_FAILED");const l=fv({stream:t.unwrap(),remoteAddr:i,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger});return this.log("new outbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeOutbound(l,{transient:null!=c.limit,onProgress:a})}catch(e){throw this.log.error(`Circuit relay dial to destination ${n.toString()} via relay ${t.remotePeer.toString()} failed`,e),o&&await t.close(),e}}createListener(e){return function(e){return new Tv(e)}({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}listenFilter(e){return(e=Array.isArray(e)?e:[e]).filter((e=>rv.matches(e)))}dialFilter(e){return this.listenFilter(e)}async onStop({connection:e,stream:t}){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(e){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",e)}const n=AbortSignal.timeout(this.stopTimeout),r=pv(t).pb(Ev),s=await r.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),void 0===s?.type)return this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await r.write({type:Ev.Type.STATUS,status:Rv.MALFORMED_MESSAGE},{signal:n}),void await t.close();if(s.type!==Ev.Type.CONNECT)return this.log.error("invalid stop connect request via peer %p",e.remotePeer),await r.write({type:Ev.Type.STATUS,status:Rv.UNEXPECTED_MESSAGE},{signal:n}),void await t.close();if(!(e=>{if(null==e.peer)return!1;try{e.peer.addrs.forEach(ei)}catch{return!1}return!0})(s))return this.log.error("invalid stop connect request via peer %p",e.remotePeer),await r.write({type:Ev.Type.STATUS,status:Rv.MALFORMED_MESSAGE},{signal:n}),void await t.close();const i=Dr(s.peer.id);if(!0===await(this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,i)))return this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await r.write({type:Ev.Type.STATUS,status:Rv.PERMISSION_DENIED},{signal:n}),void await t.close();this.log.trace("sending success response to %p",e.remotePeer),await r.write({type:Ev.Type.STATUS,status:Rv.OK},{signal:n});const o=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${i.toString()}`),a=this.addressManager.getAddresses()[0],c=fv({stream:r.unwrap().unwrap(),remoteAddr:o,localAddr:a,logger:this.logger});this.log("new inbound relayed connection %a",c.remoteAddr),await this.upgrader.upgradeInbound(c,{transient:null!=s.limit}),this.log("%s connection %a upgraded","inbound",c.remoteAddr)}}function Lv(e={}){return t=>new Pv(t,e)}var Bv;function Ov(e,t){return!Bi.matches(e)&&(null!=t.dialTransportForMultiaddr(e)&&(!!gi.matches(e)||!!vi.matches(e)&&!1===Rs(e.toOptions().host)))}!function(e){let t,n,r;!function(e){e.UNUSED="UNUSED",e.CONNECT="CONNECT",e.SYNC="SYNC"}(t=e.Type||(e.Type={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.CONNECT=100]="CONNECT",e[e.SYNC=300]="SYNC"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.observedAddresses)for(const e of t.observedAddresses)n.uint32(18),n.bytes(e);!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={observedAddresses:[]},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.observedAddresses.push(t.bytes());break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(Bv||(Bv={}));class Mv{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??5e3,this.retries=t.retries??3,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1}[Symbol.toStringTag]="@libp2p/dcutr";[Hg]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(Uv,{notifyOnTransient:!0,onConnect:(e,t)=>{t.transient&&"inbound"===t.direction&&this.upgradeInbound(t).catch((e=>{this.log.error("error during outgoing DCUtR attempt",e)}))}}),await this.registrar.handle(Uv,(e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch((t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(Uv),null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const r={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([Uv],{signal:r.signal,runOnTransientConnection:!0});const n=pv(t,{maxDataLength:4096}).pb(Bv);this.log("B sending connect to %p",e.remotePeer);const s=Date.now();await n.write({type:Bv.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map((e=>e.bytes))},r),this.log("B receiving connect from %p",e.remotePeer);const i=await n.read(r);if(i.type!==Bv.Type.CONNECT)throw this.log("A sent wrong message type"),new k("DCUtR message type was incorrect",T);const o=this.getDialableMultiaddrs(i.observedAddresses);if(0===o.length)throw this.log("A did not have any dialable multiaddrs"),new k("DCUtR connect message had no multiaddrs",T);const a=Date.now()-s;this.log("A sending sync, rtt %dms",a),await n.write({type:Bv.Type.SYNC,observedAddresses:[]},r),this.log("A waiting for half RTT"),await Yy(a/2),this.log("B dialing",o);const c=await this.connectionManager.openConnection(o,{signal:r.signal,priority:100});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,c.remoteAddr),await e.close(r);break}catch(e){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,e),t?.abort(e),n===this.retries)throw e}finally{null!=t&&await t.close(r)}}}async attemptUnilateralConnectionUpgrade(e){const t=(await this.peerStore.get(e.remotePeer)).addresses.map((t=>{const n=t.multiaddr;return null==n.getPeerId()?n.encapsulate(`/p2p/${e.remotePeer}`):n})).filter((e=>Ov(e,this.transportManager)));if(t.length>0){const n=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",t);const r=await this.connectionManager.openConnection(t,{signal:n,force:!0});if(r.transient)throw new Error("Could not open a new, non-transient, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,r.remoteAddr),await e.close({signal:n}),!0}catch(n){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,t,n)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const r=pv(e,{maxDataLength:4096}).pb(Bv);this.log("A receiving connect");const s=await r.read(n);if(s.type!==Bv.Type.CONNECT)throw this.log("B sent wrong message type"),new k("DCUtR message type was incorrect",T);if(0===s.observedAddresses.length)throw this.log("B sent no multiaddrs"),new k("DCUtR connect message had no multiaddrs",T);const i=this.getDialableMultiaddrs(s.observedAddresses);if(0===i.length)throw this.log("B had no dialable multiaddrs"),new k("DCUtR connect message had no dialable multiaddrs",T);if(this.log("A sending connect"),await r.write({type:Bv.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map((e=>e.bytes))}),this.log("A receiving sync"),(await r.read(n)).type!==Bv.Type.SYNC)throw new k("DCUtR message type was incorrect",T);this.log("A dialing",i);const o=await this.connectionManager.openConnection(i,{signal:n.signal,priority:100,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,o.remoteAddr),await t.close(n)}catch(n){this.log.error("incoming DCUtR from %p failed",t.remotePeer,n),e.abort(n)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(null!=n&&0!==n.length)try{const e=ei(n);if(!Ov(e,this.transportManager))continue;t.push(e)}catch{}return t}}const Uv="/libp2p/dcutr";function Fv(e={}){return t=>new Mv(t,e)}var $v;!function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const n of e.listenAddrs)t.uint32(18),t.bytes(n);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const n of e.protocols)t.uint32(26),t.string(n);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={listenAddrs:[],protocols:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 5:n.protocolVersion=e.string();break;case 6:n.agentVersion=e.string();break;case 1:n.publicKey=e.bytes();break;case 2:n.listenAddrs.push(e.bytes());break;case 4:n.observedAddr=e.bytes();break;case 3:n.protocols.push(e.string());break;case 8:n.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}($v||($v={}));var Vv=n(866);const zv="object"==typeof window&&"object"==typeof document&&9===document.nodeType,Hv=Vv(),Kv=zv&&!Hv,qv=Hv&&!zv,Wv=Hv&&zv,jv=void 0!==globalThis.process&&void 0!==globalThis.process.release&&"node"===globalThis.process.release.name&&!Hv,Gv="function"==typeof importScripts&&"undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,Yv=(void 0!==globalThis.process&&void 0!==globalThis.process.env&&globalThis.process.env.NODE_ENV,"undefined"!=typeof navigator&&"ReactNative"===navigator.product),Qv="ipfs",Jv=5e3,Xv=1,Zv=1,eS=10,tS=8192,nS=!0,rS=!0,sS=!0,iS=32;async function oS(e,t,n,r,s){if(n("received identify from %p",r.remotePeer),null==s)throw new k("message was null or undefined","ERR_INVALID_MESSAGE");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map((e=>({isCertified:!1,multiaddr:ei(e)})))),s.protocols.length>0&&(i.protocols=s.protocols),null!=s.publicKey&&(i.publicKey=s.publicKey,!(await Cr(s.publicKey)).equals(r.remotePeer)))throw new k("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let o;if(null!=s.signedPeerRecord){n("received signedPeerRecord from %p",r.remotePeer);let t=s.signedPeerRecord;const a=await oy.openAndCertify(t,uy.DOMAIN);let c,l=uy.createFromProtobuf(a.payload);if(!l.peerId.equals(a.peerId))throw new k("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!r.remotePeer.equals(l.peerId))throw new k("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");try{c=await e.get(l.peerId)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=c&&(i.metadata=c.metadata,null!=c.peerRecordEnvelope)){const e=await oy.createFromProtobuf(c.peerRecordEnvelope),r=uy.createFromProtobuf(e.payload);r.seqNumber>=l.seqNumber&&(n("sequence number was lower or equal to existing sequence number - stored: %d received: %d",r.seqNumber,l.seqNumber),l=r,t=c.peerRecordEnvelope)}i.peerRecordEnvelope=t,i.addresses=l.multiaddrs.map((e=>({isCertified:!0,multiaddr:e}))),o={seq:l.seqNumber,addresses:l.multiaddrs}}else n("%p did not send a signed peer record",r.remotePeer);if(n("patching %p with",r.remotePeer,i),await e.patch(r.remotePeer,i),null!=s.agentVersion||null!=s.protocolVersion){const t={};null!=s.agentVersion&&(t.AgentVersion=Ln(s.agentVersion)),null!=s.protocolVersion&&(t.ProtocolVersion=Ln(s.protocolVersion)),n("merging %p metadata",r.remotePeer,t),await e.merge(r.remotePeer,{metadata:t})}const a={peerId:r.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map((e=>ei(e))),observedAddr:null==s.observedAddr?void 0:ei(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:r};return t.safeDispatchEvent("peer:identify",{detail:a}),a}class aS{host;protocol;started;timeout;peerId;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnTransientConnection;log;constructor(e,t){var n,r;this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Jv,this.maxInboundStreams=t.maxInboundStreams??Xv,this.maxOutboundStreams=t.maxOutboundStreams??Zv,this.maxMessageSize=t.maxMessageSize??tS,this.maxObservedAddresses=t.maxObservedAddresses??eS,this.runOnTransientConnection=t.runOnTransientConnection??sS,this.host={protocolVersion:`${t.protocolPrefix??Qv}/0.1.0`,agentVersion:(n=e.nodeInfo,r=t.agentVersion,null!=r||(r=`${n.name}/${n.version}`,jv||qv?r+=` UserAgent=${globalThis.process.version}`:(Kv||Gv||Wv||Yv)&&(r+=` UserAgent=${globalThis.navigator.userAgent}`)),r)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Ln(this.host.agentVersion),ProtocolVersion:Ln(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,(e=>{this.handleProtocol(e).catch((e=>{this.log.error(e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class cS extends aS{connectionManager;concurrency;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Qv}/id/push/1.0.0`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??iS,(t.runOnSelfUpdate??rS)&&e.events.addEventListener("self:peer:update",(e=>{this.push().catch((e=>{this.log.error(e)}))}))}[zg]=["@libp2p/identify-push"];async push(){if(!this.isStarted())return;const e=this.addressManager.getAddresses().map((e=>e.decapsulateCode(Ns("p2p").code))),t=new uy({peerId:this.peerId,multiaddrs:e}),n=await oy.seal(t,this.peerId),r=this.registrar.getProtocols(),s=await this.peerStore.get(this.peerId),i=mr(s.metadata.get("AgentVersion")??Ln(this.host.agentVersion)),o=mr(s.metadata.get("ProtocolVersion")??Ln(this.host.protocolVersion)),a=this;await z(Ym(async function*(){for(const t of a.connectionManager.getConnections())(await a.peerStore.get(t.remotePeer)).protocols.includes(a.protocol)&&(yield async()=>{let s;const c=AbortSignal.timeout(a.timeout);try{s=await t.newStream(a.protocol,{signal:c,runOnTransientConnection:a.runOnTransientConnection});const l=pv(s,{maxDataLength:a.maxMessageSize}).pb($v);await l.write({listenAddrs:e.map((e=>e.bytes)),signedPeerRecord:n.marshal(),protocols:r,agentVersion:i,protocolVersion:o},{signal:c}),await s.close({signal:c})}catch(e){a.log.error("could not push identify update to peer",e),s?.abort(e)}})}(),{concurrency:this.concurrency}))}async handleProtocol(e){const{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const e={signal:AbortSignal.timeout(this.timeout)},r=pv(n,{maxDataLength:this.maxMessageSize}).pb($v),s=await r.read(e);await n.close(e),await oS(this.peerStore,this.events,this.log,t,s)}catch(e){return this.log.error("received invalid message",e),void n.abort(e)}this.log("handled push from %p",t.remotePeer)}}class lS extends aS{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Qv}/id/1.0.0`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??nS)&&e.events.addEventListener("connection:open",(e=>{const t=e.detail;this.identify(t).catch((e=>{this.log.error("error during identify trigged by connection:open",e)}))}))}[zg]=["@libp2p/identify"];async _identify(e,t={}){let n;if(null==t.signal){const e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{n=await e.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection});const r=pv(n,{maxDataLength:this.maxMessageSize}).pb($v),s=await r.read(t);return await n.close(t),s}catch(e){throw this.log.error("error while reading identify message",e),n?.abort(e),e}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:r,protocols:s,observedAddr:i}=n;if(null==r)throw new k("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");const o=await Cr(r);if(!e.remotePeer.equals(o))throw new k("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(o))throw new k("identified peer is our own peer id?","ERR_INVALID_PEER");const a=function(e){if(null!=e&&e.length>0)try{return ei(e)}catch{}}(i);return this.log("identify completed for peer %p and protocols %o",o,s),this.log("our observed address is %a",a),null!=a&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",a),this.addressManager.addObservedAddr(a)),oS(this.peerStore,this.events,this.log,e,n)}async handleProtocol(e){const{connection:t,stream:n}=e,r=AbortSignal.timeout(this.timeout);try{const e=this.peerId.publicKey??new Uint8Array(0),s=await this.peerStore.get(this.peerId),i=this.addressManager.getAddresses().map((e=>e.decapsulateCode(Ns("p2p").code)));let o=s.peerRecordEnvelope;if(i.length>0&&null==o){const e=new uy({peerId:this.peerId,multiaddrs:i});o=(await oy.seal(e,this.peerId)).marshal().subarray()}let a=t.remoteAddr.bytes;Ei.matches(t.remoteAddr)||(a=void 0);const c=pv(n).pb($v);await c.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:e,listenAddrs:i.map((e=>e.bytes)),signedPeerRecord:o,observedAddr:a,protocols:s.protocols},{signal:r}),await n.close({signal:r})}catch(e){this.log.error("could not respond to identify request",e),n.abort(e)}}}function uS(e={}){return t=>new lS(t,e)}function hS(e={}){return t=>new cS(t,e)}const dS=36e5,fS=36*dS,pS="/dht/provider",gS=dS,yS=20,mS=3;var wS,bS,ES,vS,SS,_S,RS,kS;function AS(e){const t=e.getUTCFullYear(),n=String(e.getUTCMonth()+1).padStart(2,"0"),r=String(e.getUTCDate()).padStart(2,"0"),s=String(e.getUTCHours()).padStart(2,"0"),i=String(e.getUTCMinutes()).padStart(2,"0"),o=String(e.getUTCSeconds()).padStart(2,"0"),a=e.getUTCMilliseconds();return`${t}-${n}-${r}T${s}:${i}:${o}.${String(1e3*a*1e3).padStart(9,"0")}Z`}!function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&e.key.byteLength>0&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),null!=e.timeReceived&&""!==e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t,n={})=>{const r={key:H(0),value:H(0),timeReceived:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.bytes();break;case 2:r.value=e.bytes();break;case 5:r.timeReceived=e.string();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=(t,n)=>Qe(t,e.codec(),n)}(wS||(wS={}));class IS{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return wS.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:AS(this.timeReceived)}}static deserialize(e){const t=wS.decode(e);return new IS(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=function(e){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),n=String(e).trim().match(t);if(null==n)throw new Error("Invalid format");const r=parseInt(n[1],10),s=parseInt(n[2],10)-1,i=parseInt(n[3],10),o=parseInt(n[4],10),a=parseInt(n[5],10),c=parseInt(n[6],10),l=parseInt(n[7].slice(0,-6),10);return new Date(Date.UTC(r,s,i,o,a,c,l))}(e.timeReceived);if(null==e.key)throw new Error("key missing from deserialized object");if(null==e.value)throw new Error("value missing from deserialized object");return new IS(e.key,e.value,t)}}function TS(e,t={}){const n={...e,name:"SEND_QUERY",type:0,messageName:e.type,messageType:e.type};return t.onProgress?.(new _("kad-dht:query:send-query",{detail:n})),n}function xS(e,t={}){const n={...e,name:"PEER_RESPONSE",type:1,messageName:e.messageType,closer:e.closer??[],providers:e.providers??[]};return t.onProgress?.(new _("kad-dht:query:peer-response",{detail:n})),n}function DS(e,t={}){const n={...e,name:"FINAL_PEER",type:2};return t.onProgress?.(new _("kad-dht:query:final-peer",{detail:n})),n}function CS(e,t={}){const n={...e,name:"QUERY_ERROR",type:3};return t.onProgress?.(new _("kad-dht:query:query-error",{detail:n})),n}function NS(e,t={}){const n={...e,name:"PROVIDER",type:4};return t.onProgress?.(new _("kad-dht:query:provider",{detail:n})),n}function PS(e,t={}){const n={...e,name:"VALUE",type:5};return t.onProgress?.(new _("kad-dht:query:value",{detail:n})),n}function LS(e,t={}){const n={...e,name:"DIAL_PEER",type:7};return t.onProgress?.(new _("kad-dht:query:dial-peer",{detail:n})),n}!function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&(t.uint32(18),t.bytes(e.value)),null!=e.author&&(t.uint32(26),t.bytes(e.author)),null!=e.signature&&(t.uint32(34),t.bytes(e.signature)),null!=e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.bytes();break;case 2:n.value=e.bytes();break;case 3:n.author=e.bytes();break;case 4:n.signature=e.bytes();break;case 5:n.timeReceived=e.string();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(bS||(bS={})),function(e){e.PUT_VALUE="PUT_VALUE",e.GET_VALUE="GET_VALUE",e.ADD_PROVIDER="ADD_PROVIDER",e.GET_PROVIDERS="GET_PROVIDERS",e.FIND_NODE="FIND_NODE",e.PING="PING"}(ES||(ES={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(vS||(vS={})),function(e){e.codec=()=>or(vS)}(ES||(ES={})),function(e){e.NOT_CONNECTED="NOT_CONNECTED",e.CONNECTED="CONNECTED",e.CAN_CONNECT="CAN_CONNECT",e.CANNOT_CONNECT="CANNOT_CONNECT"}(SS||(SS={})),function(e){e[e.NOT_CONNECTED=0]="NOT_CONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.CAN_CONNECT=2]="CAN_CONNECT",e[e.CANNOT_CONNECT=3]="CANNOT_CONNECT"}(_S||(_S={})),function(e){e.codec=()=>or(_S)}(SS||(SS={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.multiaddrs)for(const n of e.multiaddrs)t.uint32(18),t.bytes(n);null!=e.connection&&(t.uint32(24),SS.codec().encode(e.connection,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={id:H(0),multiaddrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:n.multiaddrs.push(e.bytes());break;case 3:n.connection=SS.codec().decode(e);break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(RS||(RS={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.type&&0!==vS[e.type]&&(t.uint32(8),ES.codec().encode(e.type,t)),null!=e.clusterLevel&&(t.uint32(80),t.int32(e.clusterLevel)),null!=e.key&&(t.uint32(18),t.bytes(e.key)),null!=e.record&&(t.uint32(26),t.bytes(e.record)),null!=e.closer)for(const n of e.closer)t.uint32(66),RS.codec().encode(n,t);if(null!=e.providers)for(const n of e.providers)t.uint32(74),RS.codec().encode(n,t);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={type:ES.PUT_VALUE,closer:[],providers:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.type=ES.codec().decode(e);break;case 10:n.clusterLevel=e.int32();break;case 2:n.key=e.bytes();break;case 3:n.record=e.bytes();break;case 8:n.closer.push(RS.codec().decode(e,e.uint32()));break;case 9:n.providers.push(RS.codec().decode(e,e.uint32()));break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(kS||(kS={}));const BS={pk:function(e,t){return 0}};async function OS(e,t){const n=t.key,r=mr(n).split("/");if(r.length<3)return;const s=e[r[1].toString()];if(null==s){const e=`No validator available for key type "${r[1]}"`;throw new k(e,"ERR_INVALID_RECORD_KEY_TYPE")}await s(n,t.value)}const MS={pk:async(e,t)=>{if(!(e instanceof Uint8Array))throw new k('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(e.byteLength<5)throw new k("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if("/pk/"!==mr(e.subarray(0,4)))throw new k("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");if(!oe(e.slice(4),(await bn.digest(t)).bytes))throw new k("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")}},US=Ln("/pk/");function FS(e){return{...e,multiaddrs:e.multiaddrs.filter((e=>{const[[t,n]]=e.stringTuples();if(53===t||54===t||55===t)return"localhost"!==n;if(4!==t&&6!==t)return!1;if(null==n)return!1;const r=Rs(n);return null==r||!r}))}}async function $S(e){return(await bn.digest(e)).digest}async function VS(e){return $S(e.toBytes())}function zS(e){return new ia(`/dht/record/${mr(e,"base32")}`,!1)}function HS(e,t){const n=new Date;return new IS(e,t,n).serialize()}class KS{log;components;validators;selectors;peerRouting;queryManager;network;constructor(e,t){const{validators:n,selectors:r,peerRouting:s,queryManager:i,network:o,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-fetching`),this.validators=n,this.selectors=r,this.peerRouting=s,this.queryManager=i,this.network=o}async getLocal(e){this.log("getLocal %b",e);const t=zS(e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const r=IS.deserialize(n);return await OS(this.validators,r),r}async*sendCorrectionRecord(e,t,n,r={}){this.log("sendCorrection for %b",e);const s=HS(e,n);for(const{value:i,from:o}of t){if(oe(i,n)){this.log("record was ok");continue}if(this.components.peerId.equals(o)){try{const t=zS(e);this.log(`Storing corrected record for key ${t.toString()}`),await this.components.datastore.put(t,s.subarray())}catch(e){this.log.error("Failed error correcting self",e)}continue}let t=!1;const a={type:ES.PUT_VALUE,key:e,record:s};for await(const e of this.network.sendRequest(o,a,r))"PEER_RESPONSE"===e.name&&null!=e.record&&oe(e.record.value,IS.deserialize(s).value)&&(t=!0),yield e;t||(yield CS({from:o,error:new k("value not put correctly","ERR_PUT_VALUE_INVALID")},r)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const r=HS(e,t),s=zS(e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,r.subarray()),yield*Re(this.peerRouting.getClosestPeers(e,{signal:n.signal}),(t=>Se(t,(t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const s=[],i={type:ES.PUT_VALUE,key:e,record:r};this.log("send put to %p",t.peer.id);for await(const e of this.network.sendRequest(t.peer.id,i,n))s.push(e),"PEER_RESPONSE"===e.name&&(null!=e.record&&oe(e.record.value,IS.deserialize(r).value)||s.push(CS({from:t.peer.id,error:new k("value not put correctly","ERR_PUT_VALUE_INVALID")},n)));return s}))),(e=>Ym(e,{ordered:!1,concurrency:mS})),(async function*(e){for await(const t of e)yield*t}))}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const r of this.getMany(e,t))"VALUE"===r.name&&n.push(r),yield r;if(0===n.length)return;const r=n.map((e=>e.value));let s=0;try{s=function(e,t,n){if(0===n.length)throw new k("No records given","ERR_NO_RECORDS_RECEIVED");const r=mr(t).split("/");if(r.length<3)throw new k("Record key does not have a selector function","ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY");const s=e[r[1].toString()];if(null==s){const e=`No selector function configured for key type "${r[1]}"`;throw new k(e,"ERR_UNRECOGNIZED_KEY_PREFIX")}return 1===n.length?0:s(t,n)}(this.selectors,e,r)}catch(e){if("ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY"!==e.code)throw e}const i=r[s];if(this.log("GetValue %b %b",e,i),null==i)throw new k("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,i,t),yield n[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const n=await this.getLocal(e);yield PS({value:n.value,from:this.components.peerId},t)}catch(t){this.log("error getting local value for %b",e,t)}const n=this;yield*this.queryManager.run(e,(async function*({peer:r,signal:s}){for await(const i of n.peerRouting.getValueOrPeers(r,e,{signal:s}))yield i,"PEER_RESPONSE"===i.name&&null!=i.record&&(yield PS({from:r,value:i.record.value},t))}),t)}}function qS(e,t){const n={id:e.id.toBytes(),multiaddrs:(e.multiaddrs??[]).map((e=>e.bytes)),connection:t};return n}function WS(e){if(null==e.id)throw new Error("Invalid peer in message");return{id:Dr(e.id),multiaddrs:(e.multiaddrs??[]).map((e=>ei(e)))}}class jS{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:n,peerRouting:r,queryManager:s,routingTable:i,providers:o,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-routing`),this.network=n,this.peerRouting=r,this.queryManager=s,this.routingTable=i,this.providers=o}async*provide(e,t,n={}){this.log("provide %s",e);const r=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);const s={type:ES.ADD_PROVIDER,key:r,providers:[qS({id:this.components.peerId,multiaddrs:t})]};let i=0;const o=t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const r=[];this.log("putProvider %s to %p",e,t.peer.id);try{this.log("sending provider record for %s to %p",e,t.peer.id);for await(const o of this.network.sendMessage(t.peer.id,s,n))"PEER_RESPONSE"===o.name&&(this.log("sent provider record for %s to %p",e,t.peer.id),i++),r.push(o)}catch(e){this.log.error("error sending provide record to peer %p",t.peer.id,e),r.push(CS({from:t.peer.id,error:e},n))}return r};yield*Re(this.peerRouting.getClosestPeers(r,n),(e=>Se(e,(e=>o(e)))),(e=>Ym(e,{ordered:!1,concurrency:mS})),(async function*(e){for await(const t of e)yield*t})),this.log("sent provider records to %d peers",i)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let r=0;const s=e.multihash.bytes,i=this;this.log("findProviders %c",e);const o=await this.providers.getProviders(e);if(o.length>0){const e=[];for(const t of o.slice(0,n))try{const n=await this.components.peerStore.get(t);e.push({id:t,multiaddrs:n.addresses.map((({multiaddr:e})=>e))})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e;this.log("no peer store entry for %p",t)}if(yield xS({from:this.components.peerId,messageType:ES.GET_PROVIDERS,providers:e},t),yield NS({from:this.components.peerId,providers:e},t),r+=e.length,r>=n)return}const a=async function*({peer:e,signal:n}){const r={type:ES.GET_PROVIDERS,key:s};yield*i.network.sendRequest(e,r,{...t,signal:n})},c=new ry(o);for await(const i of this.queryManager.run(s,a,t))if(yield i,"PEER_RESPONSE"===i.name){this.log("Found %d provider entries for %c and %d closer peers",i.providers.length,e,i.closer.length);const s=[];for(const e of i.providers)c.has(e.id)||(c.add(e.id),s.push(e));if(s.length>0&&(yield NS({from:i.from,providers:s},t),r+=s.length,r>=n))return}}}class GS extends S{log;protocol;running;components;timeout;constructor(e,t){super();const{protocol:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=n,this.timeout=new Im({...t.timeout??{},metrics:e.metrics,metricName:`${t.logPrefix.replaceAll(":","_")}_network_message_send_times_milliseconds`})}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(!this.running)return;const r=t.type;if(null==r)throw new cr("Message type was missing","ERR_INVALID_PARAMETERS");let s;this.log("sending %s to %p",t.type,e),yield LS({peer:e},n),yield TS({to:e,type:r},n);const i=this.timeout.getTimeoutSignal(n);n={...n,signal:i};try{const r=await this.components.connectionManager.openConnection(e,n);s=await r.newStream(this.protocol,n);const i=await this._writeReadMessage(s,t,n);s.close(n).catch((t=>{this.log.error("error closing stream to %p",e,t),s?.abort(t)})),yield xS({from:e,messageType:i.type,closer:i.closer.map(WS),providers:i.providers.map(WS),record:null==i.record?void 0:IS.deserialize(i.record)},n)}catch(r){s?.abort(r),this.log.error("could not send %s to %p",t.type,e,r),yield CS({from:e,error:r},n)}finally{this.timeout.cleanUp(i)}}async*sendMessage(e,t,n={}){if(!this.running)return;const r=t.type;if(null==r)throw new cr("Message type was missing","ERR_INVALID_PARAMETERS");let s;this.log("sending %s to %p",t.type,e),yield LS({peer:e},n),yield TS({to:e,type:r},n);const i=this.timeout.getTimeoutSignal(n);n={...n,signal:i};try{const i=await this.components.connectionManager.openConnection(e,n);s=await i.newStream(this.protocol,n),await this._writeMessage(s,t,n),s.close(n).catch((t=>{this.log.error("error closing stream to %p",e,t),s?.abort(t)})),yield xS({from:e,messageType:r},n)}catch(t){s?.abort(t),yield CS({from:e,error:t},n)}finally{this.timeout.cleanUp(i)}}async _writeMessage(e,t,n){const r=pv(e);await r.write(t,kS,n),await r.unwrap().close(n)}async _writeReadMessage(e,t,n){const r=pv(e);await r.write(t,kS,n);const s=await r.read(kS,n);return await r.unwrap().close(n),s.closer.forEach((e=>{this.safeDispatchEvent("peer",{detail:WS(e)})})),s.providers.forEach((e=>{this.safeDispatchEvent("peer",{detail:WS(e)})})),s}}function YS(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");const n=K(e.length);for(let r=0;r<e.length;r++)n[r]=e[r]^t[r];return n}function QS(e,t){if(e.byteLength!==t.byteLength)throw new Error("Inputs should have the same length");for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return e[n]<t[n]?-1:1;return 0}class JS{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map((e=>e.peer))}async add(e){const t=await VS(e.id);this.addWitKadId(e,t)}addWitKadId(e,t){if(null!=this.peerDistances.find((t=>t.peer.id.equals(e.id))))return;const n={peer:e,distance:YS(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort(((e,t)=>QS(e.distance,t.distance))),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){return 0===this.length||-1===QS(YS(await VS(e),this.originDhtKey),this.peerDistances[this.peerDistances.length-1].distance)}async anyCloser(e){return 0!==e.length&&Promise.any(e.map((async e=>this.isCloser(e))))}}class XS{log;routingTable;network;validators;queryManager;peerStore;peerId;constructor(e,t){const{routingTable:n,network:r,validators:s,queryManager:i,logPrefix:o}=t;this.routingTable=n,this.network=r,this.validators=s,this.queryManager=i,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${o}:peer-routing`)}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(null!=n){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(n)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}}if(null==t)try{t=await this.peerStore.get(e)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map((e=>e.multiaddr))}}async*_getValueSingle(e,t,n={}){const r={type:ES.GET_VALUE,key:t};yield*this.network.sendRequest(e,r,n)}async*getPublicKeyFromNode(e,t={}){const n=function(e){return ie([US,e.toBytes()])}(e);for await(const r of this._getValueSingle(e,n,t))if(yield r,"PEER_RESPONSE"===r.name&&null!=r.record){const n=await Cr(Fg({bytes:r.record.value}));if(!n.equals(e))throw new k("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(null==n.publicKey)throw new k("public key missing","ERR_PUBLIC_KEY_MISSING");yield PS({from:e,value:n.publicKey},t)}throw new k(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){if(this.log("findPeer %p",e),!1!==t.useCache){const n=await this.findPeerLocal(e);if(null!=n)return this.log("found local"),void(yield DS({from:this.peerId,peer:n},t))}let n=!1;if(!1!==t.useNetwork){const r=this,s=async function*({peer:n,signal:s}){const i={type:ES.FIND_NODE,key:e.toBytes()};for await(const o of r.network.sendRequest(n,i,{...t,signal:s}))if(yield o,"PEER_RESPONSE"===o.name){const n=o.closer.find((t=>t.id.equals(e)));null!=n&&(yield DS({from:o.from,peer:n},t))}};for await(const r of this.queryManager.run(e.toBytes(),s,t))"FINAL_PEER"===r.name&&(n=!0),yield r}n||(yield CS({from:this.peerId,error:new k("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await $S(e),r=this.routingTable.closestPeers(n),s=this,i=new JS(n,this.routingTable.kBucketSize);await Promise.all(r.map((async e=>{await i.add({id:e,multiaddrs:[]})})));const o=async function*({peer:n,signal:r}){s.log("closerPeersSingle %s from %p",mr(e,"base32"),n);const i={type:ES.FIND_NODE,key:e};yield*s.network.sendRequest(n,i,{...t,signal:r})};for await(const n of this.queryManager.run(e,o,t))"PEER_RESPONSE"===n.name&&await Promise.all(n.closer.map((async e=>{await i.add(e)}))),yield n;this.log("found %d peers close to %b",i.length,e);for(const e of i.peers)yield DS({from:this.peerId,peer:e},t)}async*getValueOrPeers(e,t,n={}){for await(const r of this._getValueSingle(e,t,n)){if("PEER_RESPONSE"===r.name&&null!=r.record)try{await this._verifyRecordOnline(r.record)}catch(e){const t="invalid record received, discarded";this.log(t),yield CS({from:r.from,error:new k(t,"ERR_INVALID_RECORD")},n);continue}yield r}}async _verifyRecordOnline(e){if(null==e.timeReceived)throw new k("invalid record received","ERR_INVALID_RECORD");await OS(this.validators,new IS(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=await $S(e),r=this.routingTable.closestPeers(n),s=[];for(const e of r)if(!e.equals(t))try{const t=await this.peerStore.get(e);s.push({id:e,multiaddrs:t.addresses.map((({multiaddr:e})=>e))})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return s.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",s.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),s}}class ZS{log;datastore;cache;cleanupInterval;provideValidity;syncQueue;started;cleaner;constructor(e,t={}){const{cacheSize:n,cleanupInterval:r,provideValidity:s}=t;this.log=e.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=e.datastore,this.cleanupInterval=r??gS,this.provideValidity=s??864e5,this.cache=Ta(n??256),this.syncQueue=new Sa({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval((()=>{this._cleanup().catch((e=>{this.log.error(e)}))}),this.cleanupInterval))}async stop(){this.started=!1,null!=this.cleaner&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add((async()=>{const e=Date.now();let t=0,n=0;const r=new Map,s=this.datastore.batch(),i=this.datastore.query({prefix:pS});for await(const e of i)try{const{cid:i,peerId:o}=t_(e.key),a=n_(e.value).getTime(),c=Date.now(),l=c-a,u=l>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",c,a,l,this.provideValidity,u?"(expired)":""),u){n++,s.delete(e.key);const t=r.get(i)??new Set;t.add(o),r.set(i,t)}t++}catch(e){this.log.error(e.message)}r.size>0?(this.log("deleting %d / %d entries",n,t),await s.commit()):this.log("nothing to delete");for(const[e,t]of r){const n=e_(e),r=this.cache.get(n);if(null!=r){for(const e of t)r.delete(e);0===r.size?this.cache.remove(n):this.cache.set(n,r)}}this.log("Cleanup successful (%dms)",Date.now()-e)}))}async _getProvidersMap(e){const t=e_(e);let n=this.cache.get(t);return null==n&&(n=await async function(e,t){const n=new Map,r=e.query({prefix:e_(t)});for await(const e of r){const{peerId:t}=t_(e.key);n.set(t,n_(e.value))}return n}(this.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add((async()=>{this.log("%p provides %s",t,e);const n=await this._getProvidersMap(e);this.log("loaded %s provs",n.size);const r=new Date;n.set(t.toString(),r);const s=e_(e);this.cache.set(s,n),await async function(e,t,n,r){const s=[e_(t),"/",n.toString()].join(""),i=new ia(s),o=re(r.getTime());await e.put(i,o)}(this.datastore,e,t,r)}))}async getProviders(e){return this.syncQueue.add((async()=>(this.log("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map((e=>xr(e))))),{throwOnTimeout:!0})}}function e_(e){const t="string"==typeof e?e:mr(e.multihash.bytes,"base32");return`${pS}/${t}`}function t_(e){const t=e.toString().split("/");if(5!==t.length)throw new Error(`incorrectly formatted provider entry key in datastore: ${e.toString()}`);return{cid:t[3],peerId:t[4]}}function n_(e){return new Date(se(e))}class r_{disjointPaths;alpha;shutDownController;running;queries;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;metrics;constructor(e,t){const{disjointPaths:n=yS,alpha:r=mS,logPrefix:s}=t;this.logPrefix=s,this.disjointPaths=n??yS,this.running=!1,this.alpha=r??mS,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,null!=e.metrics&&(this.metrics={runningQueries:e.metrics.registerMetric(`${s.replaceAll(":","_")}_running_queries`),queryTime:e.metrics.registerMetric(`${s.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,this.shutDownController.signal}isStarted(){return this.running}async start(){this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");const r=this.metrics?.queryTime.timer();if(null==n.signal){const e=AbortSignal.timeout(18e4);n={...n,signal:e}}const s=new AbortController,i=v([this.shutDownController.signal,s.signal,n.signal]);s.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+mr(e,"base58btc")),a=Date.now();let c=!1;try{!0!==n.isSelfQuery&&null!=this.initialQuerySelfHasRun&&(o("waiting for initial query-self query before continuing"),await M(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),o("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries);const r=await $S(e),s=this.routingTable.closestPeers(r),a=s.slice(0,Math.min(this.disjointPaths,s.length));if(0===s.length)return void o.error("Running query with no peers");const l=new ry,u=a.map(((r,s)=>async function*(e){const{key:t,startingPeer:n,ourPeerId:r,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,queryFuncTimeout:l,log:u,peersSeen:h,connectionManager:d}=e,f=new $({concurrency:o,sort:(e,t)=>QS(e.options.distance,t.options.distance)}),p=await $S(t);!function n(o,g){if(null==o)return;h.add(o);const y=YS(g,p);f.add((async()=>{const g=[s];null!=l&&g.push(AbortSignal.timeout(l));const m=v(g);try{for await(const e of i({key:t,peer:o,signal:m,pathIndex:a,numPaths:c})){if(m.aborted)return;if("PEER_RESPONSE"===e.name)for(const s of e.closer){if(h.has(s.id)){u("already seen %p in query",s.id);continue}if(r.equals(s.id)){u("not querying ourselves");continue}if(!await d.isDialable(s.multiaddrs)){u("not querying undialable peer");continue}const e=await VS(s.id);-1===QS(YS(e,p),y)?(u("querying closer peer %p",s.id),n(s.id,e)):u("skipping %p as they are not closer to %b than %p",s.id,t,o)}f.safeDispatchEvent("completed",{detail:e})}}catch(t){if(!s.aborted)return CS({from:o,error:t},e)}finally{m.clear()}}),{distance:y}).catch((e=>{u.error(e)}))}(n,await VS(n));try{for await(const e of f.toGenerator({signal:s}))null!=e&&(yield e)}catch(e){if(s.aborted)throw new k("Query aborted","ERR_QUERY_ABORTED");throw e}}({key:e,startingPeer:r,ourPeerId:this.peerId,signal:i,query:t,pathIndex:s,numPaths:a.length,alpha:this.alpha,queryFuncTimeout:n.queryFuncTimeout,log:o,peersSeen:l,onProgress:n.onProgress,connectionManager:this.connectionManager})));for await(const e of _e(...u)){if("QUERY_ERROR"===e.name&&o.error("query error",e.error),"PEER_RESPONSE"===e.name)for(const t of[...e.closer,...e.providers])await this.connectionManager.isDialable(t.multiaddrs)&&await this.routingTable.add(t.id);yield e}c=!0}catch(e){if(this.running||"ERR_QUERY_ABORTED"!==e.code)throw e}finally{c||(o("query exited early"),s.abort()),i.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),null!=r&&r(),o("query:done in %dms",Date.now()-a)}}}const s_=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{let t=0;for await(const n of e)t++;return t})();{let t=0;for(const n of e)t++;return t}};function i_(e,t,n){"function"==typeof n&&(n={filter:n});const r=function(e,t,n){let r;const s=new Promise(((s,i)=>{if(!((n={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...n}).count>=0)||n.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(n.count))throw new TypeError("The `count` option should be at least 0 or more");n.signal?.throwIfAborted();const o=[t].flat(),a=[],{addListener:c,removeListener:l}=(e=>{const t=e.addEventListener||e.on||e.addListener,n=e.removeEventListener||e.off||e.removeListener;if(!t||!n)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:n.bind(e)}})(e),u=(...e)=>{const t=n.multiArgs?e:e[0];n.filter&&!n.filter(t)||(a.push(t),n.count===a.length&&(r(),s(a)))},h=e=>{r(),i(e)};r=()=>{for(const e of o)l(e,u);for(const e of n.rejectionEvents)l(e,h)};for(const e of o)c(e,u);for(const e of n.rejectionEvents)c(e,h);n.signal&&n.signal.addEventListener("abort",(()=>{h(n.signal.reason)}),{once:!0}),n.resolveImmediately&&s(a)}));if(s.cancel=r,"number"==typeof n.timeout){const e=Ea(s,{milliseconds:n.timeout});return e.cancel=r,e}return s}(e,t,n={...n,count:1,resolveImmediately:!1}),s=r.then((e=>e[0]));return s.cancel=r.cancel,s}class o_{log;peerId;peerRouting;routingTable;count;interval;initialInterval;queryTimeout;started;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){const{peerRouting:n,logPrefix:r,count:s,interval:i,queryTimeout:o,routingTable:a}=t;this.peerId=e.peerId,this.log=e.logger.forComponent(`${r}:query-self`),this.started=!1,this.peerRouting=n,this.routingTable=a,this.count=s??yS,this.interval=i??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=o??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout((()=>{this.querySelf().catch((e=>{this.log.error("error running self-query",e)}))}),this.initialInterval))}stop(){this.started=!1,null!=this.timeoutId&&clearTimeout(this.timeoutId),null!=this.controller&&this.controller.abort()}async querySelf(){if(this.started){if(null!=this.querySelfPromise)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=x(),this.started){this.controller=new AbortController;const e=AbortSignal.timeout(this.queryTimeout),t=v([this.controller.signal,e]);this.controller.signal;try{0===this.routingTable.size&&(this.log("routing table was empty, waiting for some peers before running query"),await i_(this.routingTable,"peer:add",{signal:t})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const e=Date.now(),n=await Re(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:t,isSelfQuery:!0}),(e=>De(e,this.count)),(async e=>s_(e)));this.log("self-query found %d peers in %dms",n,Date.now()-e)}catch(e){this.log.error("self-query error",e)}finally{t.clear(),null!=this.initialQuerySelfHasRun&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout((()=>{this.querySelf().catch((e=>{this.log.error("error running self-query",e)}))}),this.interval))}else this.log("skip self-query because we are not started")}}function a_(e,t){if(!(t instanceof Uint8Array))throw new TypeError(e+" is not a Uint8Array");if(32!==t.byteLength)throw new TypeError(e+" had incorrect length")}function c_(e){return Array.isArray(e?.peers)}class l_ extends S{root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;constructor(e){super(),this.localPeer=e.localPeer,this.prefixLength=e.prefixLength,this.kBucketSize=e.kBucketSize??u_,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfNodesToPing??3,a_("options.localPeer.kadId",e.localPeer.kadId),this.root={prefix:"",depth:0,peers:[]}}add(e){a_("peer.kadId",e?.kadId);const t=this._determineBucket(e.kadId);if(!(this._indexOf(t,e.kadId)>-1))return t.peers.length===this.splitThreshold&&t.depth<this.prefixLength?(this._split(t),void this.add(e)):t.peers.length<this.kBucketSize?(t.peers.push(e),void this.safeDispatchEvent("added",{detail:e})):void this.safeDispatchEvent("ping",{detail:{oldContacts:t.peers.slice(0,this.numberOfNodesToPing),newContact:e}})}*closest(e,t=this.kBucketSize){const n=new JS(e,t);for(const e of this.toIterable())n.addWitKadId({id:e.peerId,multiaddrs:[]},e.kadId);yield*Se(n.peers,(e=>e.id))}count(){return function e(t){if(c_(t))return t.peers.length;let n=0;return null!=t.left&&(n+=e(t.left)),null!=t.right&&(n+=e(t.right)),n}(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}remove(e){const t=this._determineBucket(e),n=this._indexOf(t,e);if(n>-1){const e=t.peers.splice(n,1)[0];this.safeDispatchEvent("removed",{detail:e})}}*toIterable(){yield*function*e(t){c_(t)?yield*t.peers:(yield*e(t.left),yield*e(t.right))}(this.root)}distance(e,t){return BigInt("0x"+mr(YS(e,t),"base16"))}_determineBucket(e){const t=mr(e,"base2").substring(0,this.prefixLength);return function e(n,r=0){return c_(n)?n:e("0"===t[r]?n.left:n.right,r+1)}(this.root)}_indexOf(e,t){return e.peers.findIndex((e=>function(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let n=0,r=e.length;n<r;++n)if(e[n]!==t[n])return!1;return!0}(e.kadId,t)))}_split(e){const t=e.depth+1,n={prefix:"0",depth:t,peers:[]},r={prefix:"1",depth:t,peers:[]};for(const s of e.peers)"0"===mr(s.kadId,"base2")[t]?n.peers.push(s):r.peers.push(s);delete e.peers,e.left=n,e.right=r}}const u_=20;class h_ extends S{kBucketSize;kb;pingQueue;log;components;prefixLength;splitThreshold;pingTimeout;pingConcurrency;running;protocol;tagName;tagValue;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??u_,this.pingTimeout=t.pingTimeout??1e4,this.pingConcurrency=t.pingConcurrency??10,this.running=!1,this.protocol=t.protocol,this.tagName=t.tagName??"kad-close",this.tagValue=t.tagValue??50,this.prefixLength=t.prefixLength??32,this.splitThreshold=t.splitThreshold??u_,this.pingQueue=new V({concurrency:this.pingConcurrency,metricName:`${t.logPrefix.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",(e=>{this.log.error("error pinging peer",e.detail)})),null!=this.components.metrics&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_max_depth`)})}isStarted(){return this.running}async start(){this.running=!0;const e=new l_({localPeer:{kadId:await VS(this.components.peerId),peerId:this.components.peerId},kBucketSize:this.kBucketSize,prefixLength:this.prefixLength,splitThreshold:this.splitThreshold,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",(e=>{this._onPing(e).catch((e=>{this.log.error("could not process k-bucket ping event",e)}))}));let t=0;for(const e of await this.components.peerStore.all())if(e.protocols.includes(this.protocol)){const n=await VS(e.id);this.kb.add({kadId:n,peerId:e.id}),t++}this.log("added %d peer store peers to the routing table",t),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new ry;const n=function(e,t=100){let n;return()=>{clearTimeout(n),n=setTimeout((()=>{e()}),t)}}((()=>{const n=new ry(e.closest(e.localPeer.kadId,u_)),r=n.difference(t),s=t.difference(n);Promise.resolve().then((async()=>{for(const e of r)await this.components.peerStore.merge(e,{tags:{[this.tagName]:{value:this.tagValue}}});for(const e of s)await this.components.peerStore.merge(e,{tags:{[this.tagName]:void 0}})})).catch((e=>{this.log.error("Could not update peer tags",e)})),t=n}));e.addEventListener("added",(e=>{n(),this.safeDispatchEvent("peer:add",{detail:e.detail.peerId})})),e.addEventListener("removed",(e=>{n(),this.safeDispatchEvent("peer:remove",{detail:e.detail.peerId})}))}async _onPing(e){if(!this.running)return;const{oldContacts:t,newContact:n}=e.detail,r=await Promise.all(t.map((async e=>{const t=this.pingQueue.find(e.peerId);return null!=t?t.join():this.pingQueue.add((async()=>{let t;try{const n={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",e.peerId);const r=await this.components.connectionManager.openConnection(e.peerId,n);t=await r.newStream(this.protocol,n);const s=pv(t);await s.write({type:ES.PING},kS,n);const i=await s.read(kS,n);if(await s.unwrap().close(),i.type!==ES.PING)throw new k(`Incorrect message type received, expected PING got ${i.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(n){return this.running&&null!=this.kb&&(this.log.error("could not ping peer %p",e.peerId,n),this.log("evicting old contact after ping failed %p",e.peerId),this.kb.remove(e.kadId)),t?.abort(n),!1}finally{this.metrics?.routingTableSize.update(this.size)}}),{peerId:e.peerId})}))),s=r.filter((e=>e)).length;this.running&&s<t.length&&null!=this.kb&&(this.log("adding new contact %p",n.peerId),this.kb.add(n))}get size(){return null==this.kb?0:this.kb.count()}async find(e){const t=await VS(e);return this.kb?.get(t)?.peerId}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return null==this.kb?[]:[...this.kb.closest(e,t)]}async add(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await VS(e);this.kb.add({kadId:t,peerId:e}),this.log("added %p with kad id %b",e,t),this.updateMetrics()}async remove(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await VS(e);this.kb.remove(t),this.updateMetrics()}updateMetrics(){if(null==this.metrics||null==this.kb)return;let e=0,t=0,n=0;!function r(s){if(c_(s))return s.depth>n&&(n=s.depth),t++,void(e+=s.peers.length);r(s.left),r(s.right)}(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMaxDepth.update(n)}}const d_=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];class f_{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:n,routingTable:r,refreshInterval:s,refreshQueryTimeout:i,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:routing-table:refresh`),this.peerRouting=n,this.routingTable=r,this.refreshInterval=s??3e5,this.refreshQueryTimeout=i??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map((e=>e.toISOString())).join(", ")} ]`),Promise.all(n.map((async(r,s)=>{try{if(await this._refreshCommonPrefixLength(s,r,e),0===this._numPeersForCpl(t)){const t=Math.min(2*(s+1),n.length-1);for(let n=s+1;n<t+1;n++)try{await this._refreshCommonPrefixLength(n,r,e)}catch(e){this.log.error(e)}}}catch(e){this.log.error(e)}}))).catch((e=>{this.log.error(e)})).then((()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),null!=this.refreshTimeoutId.unref&&this.refreshTimeoutId.unref()})).catch((e=>{this.log.error(e)}))}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval)return void this.log("not running refresh for cpl %s as time since last refresh not above interval",e);const r=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,r,this.routingTable.size);const s=AbortSignal.timeout(this.refreshQueryTimeout),i=await s_(this.peerRouting.getClosestPeers(r.toBytes(),{signal:s}));this.log(`found ${i} peers that were close to imaginary peer %p`,r),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,r,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>15&&(e=15);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(null==this.routingTable.kb)throw new Error("Routing table not started");const t=ts(2),n=(t[1]<<8)+t[0];return Dr(await this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e))}async _makePeerId(e,t,n){if(n>15)throw new Error("Cannot generate peer ID for common prefix length greater than 15");const r=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1),s=65535<<16-(n+1),i=d_[(r^32768>>n)&s|t&~s],o=new ArrayBuffer(34),a=new DataView(o,0,o.byteLength);return a.setUint8(0,bn.code),a.setUint8(1,32),a.setUint32(2,i,!1),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(null!=this.routingTable.kb)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=YS(this.routingTable.kb.localPeer.kadId,e);let n=0;for(const e of t){if(0!==e)break;n++}yield n}}}class p_{providers;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.providers=t.providers}async handle(e,t){if(this.log("start"),null==t.key||0===t.key.length)throw new k("Missing key","ERR_MISSING_KEY");let n;try{n=Rn.decode(t.key)}catch(e){throw new k("Invalid CID","ERR_INVALID_CID")}null!=t.providers&&0!==t.providers.length||this.log.error("no providers found in message"),await Promise.all(t.providers.map((async t=>{e.equals(t.id)?t.multiaddrs.length<1?this.log("no valid addresses for provider %p. Ignore",e):(this.log("received provider %p for %s (addrs %s)",e,n,t.multiaddrs.map((e=>ei(e).toString()))),await this.providers.addProvider(n,Dr(t.id))):this.log("invalid provider peer %p from %p",t.id,e)})))}}class g_{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:n,logPrefix:r}=t;this.log=e.logger.forComponent(`${r}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),null==t.key)throw new k("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");const n=await this.peerRouting.getCloserPeersOffline(t.key,e);oe(this.peerId.toBytes(),t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map((e=>e.decapsulateCode(Ns("p2p").code)))});const r={type:ES.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter((({multiaddrs:e})=>e.length)).map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))}))),providers:[]};return 0===r.closer.length&&this.log("could not find any peers closer to %b than %p",t.key,e),r}}class y_{peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:n,providers:r,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:get-providers`),this.peerStore=e.peerStore,this.peerRouting=n,this.providers=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(null==t.key)throw new k("Invalid GET_PROVIDERS message received - key was missing","ERR_INVALID_MESSAGE");let n;try{n=Rn.decode(t.key)}catch(e){throw new k("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",e,n);const[r,s]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),i=await this._getPeers(r),o=await this._getPeers(s.map((({id:e})=>e))),a={type:ES.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:o.map(this.peerInfoMapper).filter((({multiaddrs:e})=>e.length)).map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))}))),providers:i.map(this.peerInfoMapper).filter((({multiaddrs:e})=>e.length)).map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))})))};return this.log("got %s providers %s closerPeers",a.providers.length,a.closer.length),a}async _getAddresses(e){return[]}async _getPeers(e){const t=[];for(const n of e)try{const e=await this.peerStore.get(n),r=this.peerInfoMapper({id:n,multiaddrs:e.addresses.map((({multiaddr:e})=>e))});r.multiaddrs.length>0&&t.push(r)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return t}}class m_{peerStore;datastore;peerRouting;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),null==n||0===n.length)throw new k("Invalid key","ERR_INVALID_KEY");const r={type:ES.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(function(e){return"/pk/"===mr(e.subarray(0,4))}(n)){this.log("is public key");const e=function(e){return Dr(e.subarray(4))}(n);let t;try{const n=await this.peerStore.get(e);if(null==n.id.publicKey)throw new k("No public key found in key book","ERR_NOT_FOUND");t=n.id.publicKey}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return this.log("returning found public key"),r.record=new IS(n,t,new Date).serialize(),r}const[s,i]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(n,e)]);return null!=s&&(this.log("had record for %b in local datastore",n),r.record=s.serialize()),i.length>0&&(this.log("had %s closer peers in routing table",i.length),r.closer=i.map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))})))),r}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=zS(e);let n;try{n=await this.datastore.get(t)}catch(e){if("ERR_NOT_FOUND"===e.code)return;throw e}const r=IS.deserialize(n);if(null==r)throw new k("Invalid record","ERR_INVALID_RECORD");if(!(null==r.timeReceived||Date.now()-r.timeReceived.getTime()>fS))return r;await this.datastore.delete(t)}}class w_{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class b_{components;validators;log;constructor(e,t){const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),null==t.record){const t=`Empty record from: ${e.toString()}`;throw this.log.error(t),new k(t,"ERR_EMPTY_RECORD")}try{const e=IS.deserialize(t.record);await OS(this.validators,e),e.timeReceived=new Date;const r=zS(e.key);await this.components.datastore.put(r,e.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,r)}catch(e){this.log("did not put record for key %b into datastore %o",n,e)}return t}}class E_{handlers;routingTable;log;constructor(e,t){const{providers:n,peerRouting:r,validators:s,logPrefix:i,peerInfoMapper:o}=t;this.log=e.logger.forComponent(`${i}:rpc`),this.routingTable=t.routingTable,this.handlers={[ES.GET_VALUE.toString()]:new m_(e,{peerRouting:r,logPrefix:i}),[ES.PUT_VALUE.toString()]:new b_(e,{validators:s,logPrefix:i}),[ES.FIND_NODE.toString()]:new g_(e,{peerRouting:r,logPrefix:i,peerInfoMapper:o}),[ES.ADD_PROVIDER.toString()]:new p_(e,{providers:n,logPrefix:i}),[ES.GET_PROVIDERS.toString()]:new y_(e,{peerRouting:r,providers:n,logPrefix:i,peerInfoMapper:o}),[ES.PING.toString()]:new w_(e,{logPrefix:i})}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(e){this.log.error("Failed to update the kbucket store",e)}const n=this.handlers[t.type];if(null!=n)return n.handle(e,t);this.log.error(`no handler found for message type: ${t.type}`)}onIncomingStream(e){Promise.resolve().then((async()=>{const{stream:t,connection:n}=e,r=n.remotePeer;try{await this.routingTable.add(r)}catch(e){this.log.error(e)}const s=this;await Re(t,(e=>Ee(e)),(async function*(e){for await(const t of e){const e=kS.decode(t);s.log("incoming %s from %p",e.type,r);const n=await s.handleMessage(r,e);null!=n&&(yield kS.encode(n))}}),(e=>fe(e)),t)})).catch((e=>{this.log.error(e)}))}}class v_ extends S{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:n,logPrefix:r}=t;this.components=e,this.log=e.logger.forComponent(`${r}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new _("peer",{detail:e}))}}))}async stop(){this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class S_{dht;constructor(e){this.dht=e}async provide(e,t={}){await z(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))"PROVIDER"===n.name&&(yield*n.providers)}async put(e,t,n){await z(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if("VALUE"===n.name)return n.value;throw new k("Not found","ERR_NOT_FOUND")}}class __{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if("FINAL_PEER"===n.name)return n.peer;throw new k("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))"FINAL_PEER"===n.name&&(yield n.peer)}}class R_ extends S{protocol;routingTable;providers;network;peerRouting;components;log;running;kBucketSize;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;constructor(e,t={}){super();const{kBucketSize:n,clientMode:r,validators:s,selectors:i,querySelfInterval:o,protocol:a,logPrefix:c,pingTimeout:l,pingConcurrency:u,maxInboundStreams:h,maxOutboundStreams:d,providers:f}=t,p=c??"libp2p:kad-dht";this.running=!1,this.components=e,this.log=e.logger.forComponent(p),this.protocol=a??"/ipfs/kad/1.0.0",this.kBucketSize=n??20,this.clientMode=r??!0,this.maxInboundStreams=h??32,this.maxOutboundStreams=d??64,this.peerInfoMapper=t.peerInfoMapper??FS,this.routingTable=new h_(e,{kBucketSize:n,pingTimeout:l,pingConcurrency:u,protocol:this.protocol,logPrefix:p}),this.providers=new ZS(e,f??{}),this.validators={...MS,...s},this.selectors={...BS,...i},this.network=new GS(e,{protocol:this.protocol,logPrefix:p});const g=x();!0===t.allowQueryWithZeroPeers&&g.resolve(),this.queryManager=new r_(e,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:p,initialQuerySelfHasRun:g,routingTable:this.routingTable}),this.peerRouting=new XS(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:p}),this.contentFetching=new KS(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:p}),this.contentRouting=new jS(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:p}),this.routingTableRefresh=new f_(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:p}),this.rpc=new E_(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:p,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new v_(e,{protocol:this.protocol,logPrefix:p}),this.querySelf=new o_(e,{peerRouting:this.peerRouting,interval:o,initialInterval:t.initialQuerySelfInterval,logPrefix:p,initialQuerySelfHasRun:g,routingTable:this.routingTable}),this.network.addEventListener("peer",(e=>{const t=e.detail;this.onPeerConnect(t).catch((e=>{this.log.error("could not add %p to routing table",t.id,e)})),this.dispatchEvent(new _("peer",{detail:t}))})),this.topologyListener.addEventListener("peer",(e=>{const t=e.detail;Promise.resolve().then((async()=>{const e=await this.components.peerStore.get(t),n={id:t,multiaddrs:e.addresses.map((({multiaddr:e})=>e)),protocols:e.protocols};await this.onPeerConnect(n)})).catch((e=>{this.log.error("could not add %p to routing table",t,e)}))})),this.dhtPeerRouting=new __(this),this.dhtContentRouting=new S_(this),null==t.clientMode&&e.events.addEventListener("self:peer:update",(e=>{this.log("received update of self-peer info"),Promise.resolve().then((async()=>{const t=e.detail.peer.addresses.some((({multiaddr:e})=>function(e){const t=e.stringTuples();for(const e of t)if(290===e[0])return!1;if(54===t[0][0]||55===t[0][0]||56===t[0][0])return!0;if(4===t[0][0]||41===t[0][0]){const e=Rs(`${t[0][1]}`);return null==e||!e}return!1}(e))),n=this.getMode();t&&"client"===n?await this.setMode("server"):"server"!==n||t||await this.setMode("client")})).catch((e=>{this.log.error("error setting dht server mode",e)}))}))}[Symbol.toStringTag]="@libp2p/kad-dht";[zg]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"];[Hg]=["@libp2p/identify"];get[ua](){return this.dhtContentRouting}get[ha](){return this.dhtPeerRouting}get[ny](){return this}async onPeerConnect(e){if(this.log("peer %p connected",e.id),0!==(e=this.peerInfoMapper(e)).multiaddrs.length)try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}else this.log("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map((e=>e.toString())))}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),"client"===e?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await fa(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.topologyListener,this.routingTableRefresh)}async stop(){this.running=!1,await pa(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var k_,A_;function I_(e={}){return t=>new R_(t,e)}!function(e){e[e.SEND_QUERY=0]="SEND_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADD_PEER=6]="ADD_PEER",e[e.DIAL_PEER=7]="DIAL_PEER"}(k_||(k_={})),function(e){e[e.NEW_STREAM=0]="NEW_STREAM",e[e.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",e[e.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",e[e.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",e[e.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",e[e.RESET_RECEIVER=5]="RESET_RECEIVER",e[e.RESET_INITIATOR=6]="RESET_INITIATOR"}(A_||(A_={}));const T_=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),x_=Object.freeze({NEW_STREAM:A_.NEW_STREAM,MESSAGE:A_.MESSAGE_INITIATOR,CLOSE:A_.CLOSE_INITIATOR,RESET:A_.RESET_INITIATOR}),D_=Object.freeze({MESSAGE:A_.MESSAGE_RECEIVER,CLOSE:A_.CLOSE_RECEIVER,RESET:A_.RESET_RECEIVER}),C_=1<<20;class N_{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=C_,t=4194304){this._buffer=new ue,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(null==e||0===e.length)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;0!==this._buffer.length;){if(null==this._headerInfo)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(e){if("ERR_MSG_TOO_BIG"===e.code)throw e;break}const{id:e,type:n,length:r,offset:s}=this._headerInfo;if(this._buffer.length-s<r)break;const i={id:e,type:n};n!==A_.NEW_STREAM&&n!==A_.MESSAGE_INITIATOR&&n!==A_.MESSAGE_RECEIVER||(i.data=this._buffer.sublist(s,s+r)),t.push(i),this._buffer.consume(s+r),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=B_(e),{value:r,offset:s}=B_(e,n),i=7&t;if(null==T_[i])throw new Error(`Invalid type received: ${i}`);if(r>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:i,offset:n+s,length:r}}}const P_=128,L_=127;function B_(e,t=0){let n,r=0,s=0,i=t;const o=e.length;do{if(i>=o||s>49)throw t=0,new RangeError("Could not decode varint");n=e.get(i++),r+=s<28?(n&L_)<<s:(n&L_)*Math.pow(2,s),s+=7}while(n>=P_);return{value:r,offset:t=i-t}}const O_=10240,M_=new class{_pool;_poolOffset;constructor(){this._pool=K(O_),this._poolOffset=0}write(e,t){const n=this._pool;let r=this._poolOffset;re(e.id<<3|e.type,n,r),r+=ee(e.id<<3|e.type),e.type!==A_.NEW_STREAM&&e.type!==A_.MESSAGE_INITIATOR&&e.type!==A_.MESSAGE_RECEIVER||null==e.data?(re(0,n,r),r+=ee(0)):(re(e.data.length,n,r),r+=ee(e.data.length));const s=n.subarray(this._poolOffset,r);O_-r<100?(this._pool=K(O_),this._poolOffset=0):this._poolOffset=r,t.append(s),e.type!==A_.NEW_STREAM&&e.type!==A_.MESSAGE_INITIATOR&&e.type!==A_.MESSAGE_RECEIVER||null==e.data||t.append(e.data)}};class U_ extends Wb{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types="outbound"===e.direction?x_:D_,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:x_.NEW_STREAM,data:new ue(Ln(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function F_(e){const t={...e,type:`${T_[e.type]} (${e.type})`};return e.type===A_.NEW_STREAM&&(t.data=mr(e.data instanceof Uint8Array?e.data:e.data.subarray())),e.type!==A_.MESSAGE_INITIATOR&&e.type!==A_.MESSAGE_RECEIVER||(t.data=mr(e.data instanceof Uint8Array?e.data:e.data.subarray(),"base16")),t}class $_{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??500,this.sink=this._createSink(),this._source=P({objectMode:!0,onEnd:()=>{for(const e of this._streams.initiators.values())e.destroy();for(const e of this._streams.receivers.values())e.destroy()}}),this.source=Re(this._source,(e=>async function*(e){for await(const t of e){const e=new ue;M_.write(t,e),yield e}}(e))),this.closeController=new AbortController,this.rateLimiter=new Qy({points:t.disconnectThreshold??5,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=null==e?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;const t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map((async e=>e.close({signal:t})))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(e){this.abort(e)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach((t=>{t.abort(e)})),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:n}=e,r=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:r})}_newStream(e){const{id:t,name:n,type:r,registry:s}=e;if(this.log("new %s stream %s",r,t),"initiator"===r&&this._streams.initiators.size===(this._init.maxOutboundStreams??1024))throw new k("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(s.has(t))throw new Error(`${r} stream ${t} already exists!`);const i=function(e){const{id:t,name:n,send:r,onEnd:s,type:i="initiator",maxMsgSize:o=C_}=e;return new U_({id:"initiator"===i?`i${t}`:`r${t}`,streamId:t,name:`${n??t}`,direction:"initiator"===i?"outbound":"inbound",maxDataSize:o,onEnd:s,send:r,log:e.logger.forComponent(`libp2p:mplex:stream:${i}:${t}`)})}({id:t,name:n,send:async e=>{this.log.enabled&&this.log.trace("%s stream %s send",r,t,F_(e)),this._source.push(e)},type:r,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",r,t,i.protocol),s.delete(t),null!=this._init.onStreamEnd&&this._init.onStreamEnd(i)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return s.set(t,i),i}_createSink(){return async e=>{const t=()=>{Kb(e,this.log)};this.closeController.signal.addEventListener("abort",t);try{const t=new N_(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const n of e)for(const e of t.write(n))await this._handleIncoming(e);this._source.end()}catch(e){this.log("error in sink",e),this._source.end(e)}finally{this.closeController.signal.removeEventListener("abort",t)}}}async _handleIncoming(e){const{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",F_(e)),e.type===A_.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??1024)){this.log("too many inbound streams open"),this._source.push({id:t,type:A_.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{return this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),void this.abort(new Error("Too many open streams"))}return}const n=this._newReceiverStream({id:t,name:mr(e.data instanceof Uint8Array?e.data:e.data.subarray())});return void(null!=this._init.onIncomingStream&&this._init.onIncomingStream(n))}const r=(1&~n?this._streams.receivers:this._streams.initiators).get(t);if(null==r){this.log("missing stream %s for message type %s",t,T_[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{return this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),void this.abort(new Error("Too many messages for missing streams"))}return}const s=this._init.maxStreamBufferSize??4194304;try{switch(n){case A_.MESSAGE_INITIATOR:case A_.MESSAGE_RECEIVER:if(r.sourceReadableLength()>s)throw this._source.push({id:e.id,type:n===A_.MESSAGE_INITIATOR?A_.RESET_RECEIVER:A_.RESET_INITIATOR}),new k("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");r.sourcePush(e.data);break;case A_.CLOSE_INITIATOR:case A_.CLOSE_RECEIVER:r.remoteCloseWrite();break;case A_.RESET_INITIATOR:case A_.RESET_RECEIVER:r.reset();break;default:this.log("unknown message type %s",n)}}catch(e){this.log.error("error while processing message",e),r.abort(e)}}}class V_{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[zg]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new $_(this.components,{...e,...this._init})}}function z_(e={}){return t=>new V_(t,e)}const H_="ERR_WRONG_PING_ACK";class K_{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnTransientConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnTransientConnection=t.runOnTransientConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,n=Date.now();AbortSignal.timeout(this.timeout).addEventListener("abort",(()=>{t?.abort(new k("ping timeout",I))})),Re(t,(async function*(e){let n=0;for await(const r of e){if(n+=r.byteLength,n>32)return void t?.abort(new k("Too much data received",T));yield r}}),t).catch((n=>{this.log.error("incoming ping from %p failed with error",e.connection.remotePeer,n),t?.abort(n)})).finally((()=>{const t=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,t)}))}async ping(e,t={}){this.log("pinging %p",e);const n=Date.now(),r=ts(32),s=await this.components.connectionManager.openConnection(e,t);let i,o=()=>{};if(null==t.signal){const e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{i=await s.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),o=()=>{i?.abort(new k("ping timeout",I))},t.signal?.addEventListener("abort",o,{once:!0});const e=await Re([r],i,(async e=>EE(e))),a=Date.now()-n;if(null==e)throw new k(`Did not receive a ping ack after ${a}ms`,H_);if(!oe(r,e.subarray()))throw new k(`Received wrong ping ack after ${a}ms`,H_);return this.log("ping %p complete in %dms",s.remotePeer,a),a}catch(e){throw this.log.error("error while pinging %p",s.remotePeer,e),i?.abort(e),e}finally{t.signal?.removeEventListener("abort",o),null!=i&&await i.close()}}}function q_(e={}){return t=>new K_(t,e)}var W_;!function(e){e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",e.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",e.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"}(W_||(W_={}));class j_ extends k{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}}class G_ extends j_{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,W_.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}}function Y_(e,t){return new G_(e,t)}class Q_ extends j_{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,W_.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}}function J_(e){return new Q_(e)}class X_ extends j_{constructor(e){super(`There was a problem with a provided argument: ${e}`,W_.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}}function Z_(e){return new X_(e)}class eR extends j_{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,W_.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}}function tR(e,t){return new eR(e,t)}class nR extends j_{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,W_.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}}class rR extends j_{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `,W_.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var sR=function(e,t,n){if(n||2===arguments.length)for(var r,s=0,i=t.length;s<i;s++)!r&&s in t||(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return e.concat(r||Array.prototype.slice.call(t))},iR=function(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"},oR=function(e){this.version=e,this.type="node",this.name="node",this.os=process.platform},aR=function(e,t,n,r){this.name=e,this.version=t,this.os=n,this.bot=r,this.type="bot-device"},cR=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},lR=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,uR=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],hR=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function dR(e){var t=function(e){return""!==e&&uR.reduce((function(t,n){var r=n[0],s=n[1];if(t)return t;var i=s.exec(e);return!!i&&[r,i]}),!1)}(e);if(!t)return null;var n=t[0],r=t[1];if("searchbot"===n)return new cR;var s=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);s?s.length<3&&(s=sR(sR([],s,!0),function(e){for(var t=[],n=0;n<e;n++)t.push("0");return t}(3-s.length),!0)):s=[];var i=s.join("."),o=function(e){for(var t=0,n=hR.length;t<n;t++){var r=hR[t],s=r[0];if(r[1].exec(e))return s}return null}(e),a=lR.exec(e);return a&&a[1]?new aR(n,i,o,a[1]):new iR(n,i,o)}const fR=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],pR="undefined"==typeof document&&"undefined"!=typeof navigator&&"ReactNative"===navigator.product?new function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}:"undefined"!=typeof navigator?dR(navigator.userAgent):"undefined"!=typeof process&&process.version?new oR(process.version.slice(1)):null;const gR=null!=pR&&"firefox"===pR.name,yR=async function*(){},mR=async e=>{};async function wR(e){return"function"==typeof(e=e??{})&&(e=await e()),e.iceServers=e.iceServers??fR.map((e=>({urls:[e]}))),e}class bR{log;peerConnection;remoteAddr;timeline;metrics;source=yR();sink=mR;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",n),"disconnected"!==this.peerConnection.connectionState&&"failed"!==this.peerConnection.connectionState&&"closed"!==this.peerConnection.connectionState||(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}var ER;!function(e){let t,n,r;!function(e){e.FIN="FIN",e.STOP_SENDING="STOP_SENDING",e.RESET="RESET",e.FIN_ACK="FIN_ACK"}(t=e.Flag||(e.Flag={})),function(e){e[e.FIN=0]="FIN",e[e.STOP_SENDING=1]="STOP_SENDING",e[e.RESET=2]="RESET",e[e.FIN_ACK=3]="FIN_ACK"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.Flag||(e.Flag={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.flag&&(n.uint32(8),e.Flag.codec().encode(t.flag,n)),null!=t.message&&(n.uint32(18),n.bytes(t.message)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.flag=e.Flag.codec().decode(t);break;case 2:r.message=t.bytes();break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(ER||(ER={}));const vR=16384,SR=function(e=16384){const t=ee(e-ee(e)),n=1+ee(Object.keys(ER.Flag).length-1);return t+n+1+ee(e-t-n-1)}();class _R extends Wb{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;constructor(e){const t=e.onEnd;switch(e.onEnd=e=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve((async()=>{if(null==this.timeline.abort&&null===this.timeline.reset)try{await Ea(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(e){this.log.error("error receiving FIN_ACK",e)}})).then((()=>{this.incomingData.end(),t?.(e)})).catch((e=>{this.log.error("error ending stream",e)}))},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=P(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??3e4,this.maxBufferedAmount=e.maxBufferedAmount??2097152,this.maxMessageSize=(e.maxMessageSize??vR)-SR,this.receiveFinAck=x(),this.finAckTimeout=e.closeTimeout??5e3,this.openTimeout=e.openTimeout??5e3,this.channel.readyState){case"open":this.timeline.open=(new Date).getTime();break;case"closed":case"closing":void 0!==this.timeline.close&&0!==this.timeline.close||(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new k("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=e=>{this.timeline.open=(new Date).getTime()},this.channel.onclose=e=>{this.receiveFinAck.resolve(),this.close().catch((e=>{this.log.error("error closing stream after channel closed",e)}))},this.channel.onerror=e=>{const t=e.error;this.abort(t)},this.channel.onmessage=async e=>{const{data:t}=e;null!==t&&0!==t.byteLength&&this.incomingData.push(new Uint8Array(t,0,t.byteLength))};const n=this;Promise.resolve().then((async()=>{for await(const e of Ee(this.incomingData)){const t=n.processIncomingProtobuf(e);null!=t&&n.sourcePush(new ue(t))}})).catch((e=>{this.log.error("error processing incoming data channel messages",e)}))}sendNewStream(){}async _sendMessage(e,t=!0){if(t&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await i_(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(e){if(e instanceof ya)throw new k(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT");throw e}if("closed"===this.channel.readyState||"closing"===this.channel.readyState)throw new k(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");"open"!==this.channel.readyState&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await i_(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxMessageSize),n=e.subarray(0,t),r=ER.encode({message:n}),s=fe.single(r);await this._sendMessage(s),e.consume(t)}}async sendReset(){await this._sendFlag(ER.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(ER.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await M(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(e){this.log.error("failed to await FIN_ACK",e)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(ER.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=ER.decode(e);if(void 0!==t.flag&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===ER.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(ER.Flag.FIN_ACK).catch((e=>{this.log.error("error sending FIN_ACK immediately",e)}))),t.flag===ER.Flag.RESET&&this.reset(),t.flag===ER.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===ER.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),"ready"===this.readStatus)return t.message}async _sendFlag(e){if("open"!==this.channel.readyState)return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());const t=ER.encode({flag:e}),n=fe.single(t);try{return await this._sendMessage(n,!1),!0}catch(t){this.log.error("could not send flag %s",e.toString(),t)}return!1}}function RR(e){const{channel:t,direction:n}=e;return new _R({id:"inbound"===n?`i${t.id}`:`r${t.id}`,log:e.logger.forComponent(`libp2p:webrtc:stream:${n}:${t.id}`),...e})}const kR="/webrtc";class AR{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??kR,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:t})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',t.id),"init"===t.label)return this.log.trace("closing early init channel"),void t.close();const n={},r=RR({channel:t,direction:"inbound",onEnd:e=>{n.onEnd(e)},logger:e.logger,...this.dataChannelOptions});n.stream=r,n.channel=t,n.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter((e=>e.stream.id!==r.id))},this.bufferedStreams.push(n)}}createStreamMuxer(e){return new IR(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class IR{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map((e=>e.stream)),this.peerConnection=t.peerConnection,this.protocol=t.protocol??kR,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:e})=>{if(this.log.trace("incoming datachannel with channel id %d",e.id),"init"===e.label)return this.log.trace("closing init channel"),void e.close();const n=RR({channel:e,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",e.id,e.readyState),this.#W(n,e)},logger:this.logger,...this.dataChannelOptions});this.streams.push(n),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(n)},this.init.streams.length>0&&queueMicrotask((()=>{this.init.streams.forEach((e=>{e.onEnd=()=>{this.log("incoming early channel %s ended with state %s",e.channel.id,e.channel.readyState),this.#W(e.stream,e.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(e.stream)}))}))}#W(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),function(e,t,n=3e4,r){"open"===e.readyState&&Promise.resolve().then((async()=>{if(e.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",t,e.bufferedAmount);const s=x();let i=!1;e.bufferedAmountLowThreshold=0;const o=()=>{i||(r.log("%s drain channel closed before drain",t),s.resolve())};e.addEventListener("close",o,{once:!0}),e.addEventListener("bufferedamountlow",(()=>{i=!0,e.removeEventListener("close",o),s.resolve()})),await Ea(s.promise,{milliseconds:n})}})).then((async()=>{"open"===e.readyState&&e.close()})).catch((e=>{r.log.error("error closing outbound stream",e)}))}(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter((t=>t.id!==e.id)),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map((async t=>t.close(e))))}catch(e){this.abort(e)}}abort(e){for(const t of this.streams)t.abort(e)}source=yR();sink=mR;newStream(){const e=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",e.id);const t=RR({channel:e,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",e.id,e.readyState),this.#W(t,e)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}}const TR=globalThis.RTCPeerConnection,xR=globalThis.RTCSessionDescription,DR=globalThis.RTCIceCandidate;var CR;!function(e){let t,n,r;!function(e){e.SDP_OFFER="SDP_OFFER",e.SDP_ANSWER="SDP_ANSWER",e.ICE_CANDIDATE="ICE_CANDIDATE"}(t=e.Type||(e.Type={})),function(e){e[e.SDP_OFFER=0]="SDP_OFFER",e[e.SDP_ANSWER=1]="SDP_ANSWER",e[e.ICE_CANDIDATE=2]="ICE_CANDIDATE"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.data&&(n.uint32(18),n.string(t.data)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.data=t.string();break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(CR||(CR={}));const NR=async(e,t,n)=>{try{const r=x();for(function(e,t){e[gR?"oniceconnectionstatechange":"onconnectionstatechange"]=n=>{switch(function(e){return gR?e.iceConnectionState:e.connectionState}(e)){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new k("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"))}}}(e,r);;){const s=await Promise.race([r.promise,t.read({signal:n.signal}).catch((()=>{}))]);if(null==s){n.signal?.throwIfAborted();break}if(s.type!==CR.Type.ICE_CANDIDATE)throw new k("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");const i=JSON.parse(s.data??"null");if(""===i||null===i){n.onProgress?.(new Ce("webrtc:end-of-ice-candidates")),n.log.trace("end-of-candidates received");continue}const o=new DR(i);n.log.trace("%s received new ICE candidate %o",n.direction,i);try{n.onProgress?.(new Ce("webrtc:add-ice-candidate",o.candidate)),await e.addIceCandidate(o)}catch(e){n.log.error("%s bad candidate received",n.direction,i,e)}}}catch(e){if(n.log.error("%s error parsing ICE candidate",n.direction,e),!0===n.signal?.aborted)throw e}};class PR extends S{peerId;transportManager;shutdownController;constructor(e,t){super(),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter((e=>e!==this)).map((e=>e.getAddrs().filter((e=>rv.matches(e))).map((e=>e.encapsulate(`/webrtc/p2p/${this.peerId}`))))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}const LR="/webrtc",BR="/p2p-circuit",OR="/webrtc-signaling/0.0.1";class MR{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[My]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[zg]=["@libp2p/transport"];[Hg]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(OR,(e=>{this._onProtocol(e).catch((t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)}))}),{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(OR),this._started=!1}createListener(e){return new PR(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Oi.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:r,muxerFactory:s}=await async function({rtcConfiguration:e,dataChannel:t,signal:n,metrics:r,multiaddr:s,connectionManager:i,transportManager:o,log:a,logger:c,onProgress:l}){const{baseAddr:u}=function(e){const t=e.toString().split(LR+"/");if(2!==t.length)throw new k("webrtc protocol was not present in multiaddr",W_.ERR_INVALID_MULTIADDR);if(!t[0].includes(BR))throw new k("p2p-circuit protocol was not present in multiaddr",W_.ERR_INVALID_MULTIADDR);let n=ei(t[0]);const r=ei("/"+t[1]).getPeerId();if(null==r)throw new k("destination peer id was missing",W_.ERR_INVALID_MULTIADDR);const s=n.protos().pop();if(void 0===s)throw new k("invalid multiaddr",W_.ERR_INVALID_MULTIADDR);return"p2p"!==s.name&&(n=n.encapsulate(`/p2p/${r}`)),{baseAddr:n,peerId:xr(r)}}(s);r?.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",u);const h=u.getPeerId();if(null==h)throw new k("Relay peer was missing","ERR_INVALID_ADDRESS");const d=i.getConnections(xr(h));let f,p=!1;0===d.length?(l?.(new Ce("webrtc:dial-relay")),f=await o.dial(u,{signal:n,onProgress:l}),p=!0):(l?.(new Ce("webrtc:reuse-relay-connection")),f=d[0]);try{l?.(new Ce("webrtc:open-signaling-stream"));const r=await f.newStream(OR,{signal:n,runOnTransientConnection:!0}),i=pv(r).pb(CR),o=new TR(e),u=new AR({logger:c},{peerConnection:o,dataChannelOptions:t});try{const e=o.createDataChannel("init");o.onicecandidate=({candidate:e})=>{const t=JSON.stringify(e?.toJSON()??null);a.trace("initiator sending ICE candidate %o",e),i.write({type:CR.Type.ICE_CANDIDATE,data:t},{signal:n}).catch((e=>{a.error("error sending ICE candidate",e)}))},o.onicecandidateerror=e=>{a.error("initiator ICE candidate error",e)};const t=await o.createOffer().catch((e=>{throw a.error("could not execute createOffer",e),new k("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")}));a.trace("initiator send SDP offer %s",t.sdp),l?.(new Ce("webrtc:send-sdp-offer")),await i.write({type:CR.Type.SDP_OFFER,data:t.sdp},{signal:n}),await o.setLocalDescription(t).catch((e=>{throw a.error("could not execute setLocalDescription",e),new k("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")})),l?.(new Ce("webrtc:read-sdp-answer"));const c=await i.read({signal:n});if(c.type!==CR.Type.SDP_ANSWER)throw new k("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",c.data);const h=new xR({type:"answer",sdp:c.data});return await o.setRemoteDescription(h).catch((e=>{throw a.error("could not execute setRemoteDescription",e),new k("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")})),a.trace("initiator read candidates until connected"),l?.(new Ce("webrtc:read-ice-candidates")),await NR(o,i,{direction:"initiator",signal:n,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),e.close(),l?.(new Ce("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await r.close({signal:n}),a.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:o,muxerFactory:u}}catch(e){throw a.error("outgoing signaling error",e),o.close(),r.abort(e),e}finally{o.onicecandidate=null,o.onicecandidateerror=null}}finally{if(p)try{await f.close({signal:n})}catch(e){f.abort(e)}}}({rtcConfiguration:await wR(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),i=new bR(this.components,{peerConnection:r,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),o=await t.upgrader.upgradeOutbound(i,{skipProtection:!0,skipEncryption:!0,muxerFactory:s,onProgress:t.onProgress});return this._closeOnShutdown(r,i),o}async _onProtocol({connection:e,stream:t}){const n=AbortSignal.timeout(this.init.inboundConnectionTimeout??3e4),r=new TR(await wR(this.init.rtcConfiguration)),s=new AR(this.components,{peerConnection:r,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:i}=await async function({peerConnection:e,stream:t,signal:n,connection:r,log:s}){s.trace("new inbound signaling stream");const i=pv(t).pb(CR);try{e.onicecandidate=({candidate:e})=>{const t=JSON.stringify(e?.toJSON()??null);s.trace("recipient sending ICE candidate %s",t),i.write({type:CR.Type.ICE_CANDIDATE,data:t},{signal:n}).catch((e=>{s.error("error sending ICE candidate",e)}))};const t=await i.read({signal:n});if(t.type!==CR.Type.SDP_OFFER)throw new k(`expected message type SDP_OFFER, received: ${t.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");s.trace("recipient receive SDP offer %s",t.data);const r=new xR({type:"offer",sdp:t.data});await e.setRemoteDescription(r).catch((e=>{throw s.error("could not execute setRemoteDescription",e),new k("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}));const o=await e.createAnswer().catch((e=>{throw s.error("could not execute createAnswer",e),new k("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")}));s.trace("recipient send SDP answer %s",o.sdp),await i.write({type:CR.Type.SDP_ANSWER,data:o.sdp},{signal:n}),await e.setLocalDescription(o).catch((e=>{throw s.error("could not execute setLocalDescription",e),new k("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")})),s.trace("recipient read candidates until connected"),await NR(e,i,{direction:"recipient",signal:n,log:s})}catch(t){if("connected"!==e.connectionState)throw s.error("error while handling signaling stream from peer %a",r.remoteAddr,t),e.close(),t;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,t)}const o=ei(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",o),{remoteAddress:o}}({peerConnection:r,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});const o=new bR(this.components,{peerConnection:r,timeline:{open:(new Date).getTime()},remoteAddr:i,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(o,{skipEncryption:!0,skipProtection:!0,muxerFactory:s}),this._closeOnShutdown(r,o)}catch(e){throw this.log.error("incoming signaling error",e),r.close(),t.abort(e),e}}_closeOnShutdown(e,t){const n=()=>{t.close().catch((e=>{this.log.error("could not close WebRTCMultiaddrConnection",e)}))};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",(()=>{this.shutdownController.signal.removeEventListener("abort",n)}))}}const UR=Object.values(xn).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)));const FR=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function $R(e){const t=e.stringTuples().filter((e=>e[0]===qR)).map((e=>e[1]))[0];if(void 0===t||""===t)throw J_(`Couldn't find a certhash component of multiaddr: ${e.toString()}`);return t}function VR(e){return dn(UR.decode(e))}function zR(e){switch(e){case 17:return"SHA-1";case 18:return"SHA-256";case 19:return"SHA-512";default:throw function(e){return new rR(e)}(e)}}function HR(e,t){const{host:n,port:r}=e.toOptions(),s=function(e){for(const t of e.protoNames())if(t.startsWith("ip"))return t.toUpperCase();return"IP6"}(e),[i]=function(e){const t=VR($R(e)),n=zR(t.code),r=t.digest.reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),""),s=r.match(/.{1,2}/g);if(null==s)throw tR(r,e.toString());return[`${n} ${s.join(":").toUpperCase()}`,r]}(e);return`v=0\no=- 0 0 IN ${s} ${n}\ns=-\nc=IN ${s} ${n}\nt=0 0\na=ice-lite\nm=application ${r} UDP/DTLS/SCTP webrtc-datachannel\na=mid:0\na=setup:passive\na=ice-ufrag:${t}\na=ice-pwd:${t}\na=fingerprint:${i}\na=sctp-port:5000\na=max-message-size:16384\na=candidate:1467250027 1 UDP 1467250027 ${n} ${r} typ host\r\n`}const KR=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),qR=(Ns("webrtc-direct").code,Ns("certhash").code);class WR{log;metrics;components;init;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[My]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[zg]=["@libp2p/transport"];async dial(e,t){const n=await this._connect(e,t);return this.log("dialing address: %a",e),n}createListener(e){throw new nR("WebRTCTransport.createListener")}listenFilter(e){return e.filter(Ci.exactMatch)}dialFilter(e){return this.listenFilter(e)}async _connect(e,t){const n=new AbortController,r=n.signal,s=e.getPeerId();if(null===s)throw J_("we need to have the remote's PeerId");const i=xr(s),o=VR($R(e)),a=await TR.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:zR(o.code)}),c=new TR({...await wR(this.init.rtcConfiguration),certificates:[a]});try{const s=new Promise(((e,t)=>{const n=c.createDataChannel("",{negotiated:!0,id:0}),r=setTimeout((()=>{const e=`Data channel was never opened: state: ${n.readyState}`;this.log.error(e),this.metrics?.dialerEvents.increment({open_error:!0}),t(Y_("data",e))}),1e4);n.onopen=t=>{clearTimeout(r),e(n)},n.onerror=e=>{clearTimeout(r);const n=`Error opening a data channel for handshaking: ${e.target?.toString()??"not specified"}`;this.log.error(n),this.metrics?.dialerEvents.increment({unknown_error:!0}),t(Y_("data",n))}})),a="libp2p+webrtc+v1/"+[...Array(32)].map((()=>KR.at(Math.floor(Math.random()*KR.length)))).join(""),l=function(e,t){if(void 0===e.sdp)throw Z_("Can't munge a missing SDP");return e.sdp=e.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,"\na=ice-ufrag:"+t+"\n").replace(/\na=ice-pwd:[^\n]*\n/,"\na=ice-pwd:"+t+"\n"),e}(await c.createOffer(),a);await c.setLocalDescription(l);const u=function(e,t){return{type:"answer",sdp:HR(e,t)}}(e,a);await c.setRemoteDescription(u);const h=await s,d=this.components.peerId,f=_b({prologueBytes:this.generateNoisePrologue(c,o.code,e)})(this.components),p=RR({channel:h,direction:"inbound",logger:this.components.logger,...this.init.dataChannel??{}}),g={...p,sink:p.sink.bind(p),source:async function*(){for await(const e of p.source)for(const t of e)yield t}()},y=new bR(this.components,{peerConnection:c,remoteAddr:e,timeline:{open:Date.now()},metrics:this.metrics?.dialerEvents}),m=gR?"iceconnectionstatechange":"connectionstatechange";c.addEventListener(m,(()=>{switch(c.connectionState){case"failed":case"disconnected":case"closed":y.close().catch((e=>{this.log.error("error closing connection",e)})).finally((()=>{n.abort()}))}}),{signal:r}),this.metrics?.dialerEvents.increment({peer_connection:!0});const w=new AR(this.components,{peerConnection:c,metrics:this.metrics?.dialerEvents,dataChannelOptions:this.init.dataChannel});return await f.secureInbound(d,g,i),await t.upgrader.upgradeOutbound(y,{skipProtection:!0,skipEncryption:!0,muxerFactory:w})}catch(e){throw c.close(),e}}generateNoisePrologue(e,t,n){if(0===e.getConfiguration().certificates?.length)throw Z_("no local certificate");const r=function(e,t){const n=e.getConfiguration().certificates?.at(0);if(null==n?.getFingerprints){t.log.trace("fetching fingerprint from local SDP");const n=e.localDescription;if(null==n)return;return function(e){const t=e.match(FR);return t?.groups?.fingerprint}(n.sdp)}if(t.log.trace("fetching fingerprint from local certificate"),0===n.getFingerprints().length)return;const r=n.getFingerprints()[0].value;if(null==r)throw tR("","no fingerprint on local certificate");return r}(e,{log:this.log});if(null==r)throw Z_("no local fingerprint found");const s=hn(t,Ln(r.trim().toLowerCase().replaceAll(":",""),"hex")),i=UR.decode($R(n));return ie([Ln("libp2p-webrtc-noise:"),s.bytes,i])}}function jR(e){return t=>new WR(t,e)}const GR=async e=>{if(e.readyState>=2)throw new Error("socket closed");1!==e.readyState&&await new Promise(((t,n)=>{function r(){e.removeEventListener("open",s),e.removeEventListener("error",i)}function s(){r(),t()}function i(t){r(),n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}e.addEventListener("open",s),e.addEventListener("error",i)}))},YR=(e,t)=>((t=t??{}).closeOnEnd=!1!==t.closeOnEnd,async n=>{for await(const t of n){try{await GR(e)}catch(e){if("socket closed"===e.message)break;throw e}if(e.readyState===e.CLOSING||e.readyState===e.CLOSED)break;e.send(t)}null!=t.closeOnEnd&&e.readyState<=1&&await new Promise(((t,n)=>{e.addEventListener("close",(e=>{if(e.wasClean||1006===e.code)t();else{const t=Object.assign(new Error("ws error"),{event:e});n(t)}})),setTimeout((()=>{e.close()}))}))});var QR=n(544);function JR(e){return e instanceof ArrayBuffer||"ArrayBuffer"===e?.constructor?.name&&"number"==typeof e?.byteLength}const XR=WebSocket,ZR={"http:":"ws:","https:":"wss:"};function ek(e,t){t=t??{};const n=((e,t)=>{if(e.startsWith("//")&&(e=`${t?.protocol??"ws:"}${e}`),e.startsWith("/")&&null!=t){const n=t.protocol??"ws:",r=t.host,s=null!=t.port&&!0!==r?.endsWith(`:${t.port}`)?`:${t.port}`:"";e=`${n}//${r}${s}${e}`}const n=new URL(e);for(const[e,t]of Object.entries(ZR))n.protocol===e&&(n.protocol=t);return n})(e,"undefined"==typeof window?void 0:window.location);return((e,t)=>{t=t??{};const n=(e=>{e.binaryType="arraybuffer";const t=async()=>{await new Promise(((t,n)=>{if(s)return void t();if(null!=r)return void n(r);const i=t=>{e.removeEventListener("open",o),e.removeEventListener("error",a),t()},o=()=>{i(t)},a=t=>{i((()=>{n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}))};e.addEventListener("open",o),e.addEventListener("error",a)}))},n=async function*(){const n=new QR.PP((({push:t,stop:n,fail:r})=>{const s=e=>{let n=null;"string"==typeof e.data&&(n=Ln(e.data)),JR(e.data)&&(n=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(n=e.data),null!=n&&t(n)},i=e=>{r(e.error??new Error("Socket error"))};return e.addEventListener("message",s),e.addEventListener("error",i),e.addEventListener("close",n),()=>{e.removeEventListener("message",s),e.removeEventListener("error",i),e.removeEventListener("close",n)}}),{highWaterMark:1/0});await t();for await(const e of n)yield JR(e)?new Uint8Array(e):e}();let r,s=1===e.readyState;return e.addEventListener("open",(()=>{s=!0,r=null})),e.addEventListener("close",(()=>{s=!1,r=null})),e.addEventListener("error",(t=>{s||(r=t.error??new Error(`connect ECONNREFUSED ${e.url}`))})),Object.assign(n,{connected:t})})(e);let r=t.remoteAddress,s=t.remotePort;if(null!=e.url)try{const t=new URL(e.url);r=t.hostname,s=parseInt(t.port,10)}catch{}if(null==r||null==s)throw new Error("Remote connection did not have address and/or port");return{sink:YR(e,t),source:n,connected:async()=>{await n.connected()},close:async()=>{e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN||await new Promise((t=>{e.addEventListener("close",(()=>{t()})),e.close()}))},destroy:()=>{null!=e.terminate?e.terminate():e.close()},remoteAddress:r,remotePort:s,socket:e}})(new XR(n.toString(),t.websocket),t)}class tk{log;init;logger;metrics;components;constructor(e,t){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[My]=!0;[Symbol.toStringTag]="@libp2p/websockets";[zg]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=function(e,t,n){const r=n.logger.forComponent("libp2p:websockets:maconn"),s=n.metrics,i=n.metricPrefix??"",o={log:r,async sink(t){try{await e.sink(async function*(){for await(const e of t)e instanceof Uint8Array?yield e:yield e.subarray()}())}catch(e){"aborted"!==e.type&&r.error(e)}},source:e.source,remoteAddr:t,timeline:{open:Date.now()},async close(t={}){const n=Date.now();if(null==t.signal){const e=AbortSignal.timeout(500);t={...t,signal:e}}const s=()=>{const{host:e,port:t}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",e,t,Date.now()-n),this.abort(new k("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};t.signal?.addEventListener("abort",s);try{await e.close()}catch(e){r.error("error closing WebSocket gracefully",e),this.abort(e)}finally{t.signal?.removeEventListener("abort",s),o.timeline.close=Date.now()}},abort(t){const{host:n,port:a}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",n,a,t),e.destroy(),o.timeline.close=Date.now(),s?.increment({[`${i}error`]:!0})}};return e.socket.addEventListener("close",(()=>{s?.increment({[`${i}close`]:!0}),null==o.timeline.close&&(o.timeline.close=Date.now())}),{once:!0}),o}(await this._connect(e,t),e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",n.remoteAddr);const r=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),r}async _connect(e,t){t?.signal?.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const r=x(),s=ek(Ki(e),this.init);s.socket.addEventListener("error",(()=>{const t=new k(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",t),this.metrics?.dialerEvents.increment({error:!0}),r.reject(t)}));try{t.onProgress?.(new Ce("websockets:open-connection")),await M(Promise.race([s.connected(),r.promise]),t.signal)}catch(e){throw!0===t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),s.close().catch((e=>{this.log.error("error closing raw socket",e)})),e}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),s}createListener(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}((this.logger,this.components.metrics),this.init)}listenFilter(e){return e=Array.isArray(e)?e:[e],null!=this.init?.filter?this.init?.filter(e):Kv||Gv?function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return KE.matches(t)}))}(e):function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return zE.matches(t)||KE.matches(t)}))}(e)}dialFilter(e){return this.listenFilter(e)}}function nk(e={}){return t=>new tk(t,e)}class rk extends Wb{writer;reader;constructor(e){super(e),this.writer=e.bidiStream.writable.getWriter(),this.reader=e.bidiStream.readable.getReader(),Promise.resolve().then((async()=>{for(;;){const t=await this.reader.read();if(t.done)return void e.log("remote closed write");null!=t.value&&this.sourcePush(new ue(t.value))}})).catch((t=>{e.log.error("error reading from stream",t),this.abort(t)})).finally((()=>{this.remoteCloseWrite()})),this.writer.closed.then((()=>{e.log("writer closed")})).catch((t=>{e.log("writer close promise rejected",t)})).finally((()=>{this.remoteCloseRead()}))}sendNewStream(e){}async sendData(e,t){for await(const n of e)this.log("sendData waiting for writer to be ready"),await M(this.writer.ready,t?.signal),this.writer.write(n).catch((e=>{this.log.error("error sending stream data",e)}))}async sendReset(e){this.log("sendReset aborting writer"),await M(this.writer.abort(),e?.signal),this.log("sendReset aborted writer")}async sendCloseWrite(e){this.log("sendCloseWrite closing writer"),await M(this.writer.close(),e?.signal),this.log("sendCloseWrite closed writer")}async sendCloseRead(e){this.log("sendCloseRead cancelling reader"),await M(this.reader.cancel(),e?.signal),this.log("sendCloseRead cancelled reader")}}async function sk(e,t,n,r,s,i){const o=i.forComponent(`libp2p:webtransport:stream:${n}:${t}`),a=new rk({bidiStream:e,id:t,direction:n,log:o,onEnd:()=>{const e=r.findIndex((e=>e===a));-1!==e&&r.splice(e,1),s?.(a)}});return a}function ik(){return{source:{[Symbol.asyncIterator]:()=>({next:async()=>new Promise((()=>{}))})},sink:async e=>new Promise((()=>{}))}}function ok(e,t,n,r){let s=0;const i=n.forComponent("libp2p:webtransport:muxer");return{protocol:"webtransport",createStreamMuxer:o=>{"function"==typeof o&&(o={onIncomingStream:o});const a=[];Promise.resolve().then((async()=>{for(;;){const{done:e,value:c}=await t.read();if(e)break;if(a.length>=r.maxInboundStreams)i(`too many inbound streams open - ${a.length}/${r.maxInboundStreams}, closing new incoming stream`),c.writable.close().catch((e=>{i.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${e.message}`)})),c.readable.cancel().catch((e=>{i.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${e.message}`)}));else{const e=await sk(c,String(s++),"inbound",a,o?.onStreamEnd,n);a.push(e),o?.onIncomingStream?.(e)}}})).catch((e=>{i.error("could not create a new stream",e)}));const c={protocol:"webtransport",streams:a,newStream:async t=>{i("new outgoing stream",t);const r=await e.createBidirectionalStream(),c=await sk(r,String(s++),o?.direction??"outbound",a,o?.onStreamEnd,n);return a.push(c),c},close:async()=>{i("closing webtransport muxer gracefully");try{e.close()}catch(e){c.abort(e)}},abort:t=>{i("closing webtransport muxer with err:",t);try{e.close()}catch(t){i.error("webtransport session threw error during close",t)}},...ik()};return c}}}const ak=Object.values(xn).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)));function ck(e){if(!Pi.matches(e))throw new k("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");const t=e.stringTuples(),n=t.filter((([e,t])=>e===Ns("certhash").code)).map((([e,t])=>function(e){return dn(ak.decode(e))}(t??""))),r=t.filter((([e,t])=>e===Ns("p2p").code)).map((([e,t])=>xr(t??"")))[0],s=e.toOptions();let i=s.host;return 6===s.family&&i?.includes(":")&&(i=`[${i}]`),{url:`https://${i}:${s.port}`,certhashes:n,remotePeer:r}}const lk=globalThis.WebTransport;class uk{log;components;config;metrics;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webtransport"),this.components=e,this.config={...t,maxInboundStreams:t.maxInboundStreams??1e3,certificates:t.certificates??[]},null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}[Symbol.toStringTag]="@libp2p/webtransport";[My]=!0;[zg]=["@libp2p/transport"];async dial(e,t){if(!0===t?.signal?.aborted)throw new R;this.log("dialing %s",e);const n=this.components.peerId;if(void 0===n)throw new k("Need a local peerid","ERR_INVALID_PARAMETERS");t=t??{};const{url:r,certhashes:s,remotePeer:i}=ck(e);let o,a,c=()=>{},l=!1,u=!1,h=!1;try{this.metrics?.dialerEvents.increment({pending:!0});const d=new lk(`${r}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:s.map((e=>({algorithm:"sha-256",value:e.digest})))});if(c=e=>{if(!l)try{this.metrics?.dialerEvents.increment({[e]:!0}),d.close()}catch(e){this.log.error("error closing wt session",e)}finally{null!=a&&(a.timeline.close=Date.now()),l=!0}},o=()=>{c(u?"noise_timeout":"ready_timeout")},t.signal?.addEventListener("abort",o,{once:!0}),this.log("wait for session to be ready"),t.onProgress?.(new Ce("webtransport:wait-for-session")),await Promise.race([d.closed,d.ready]),this.log("session became ready"),u=!0,this.metrics?.dialerEvents.increment({ready:!0}),d.closed.catch((e=>{this.log.error("error on remote wt session close",e)})).finally((()=>{c("remote_close")})),h=await M(this.authenticateWebTransport({wt:d,localPeer:n,remotePeer:i,certhashes:s,...t}),t.signal),!h)throw new k("Failed to authenticate webtransport","ERR_AUTHENTICATION_FAILED");return this.metrics?.dialerEvents.increment({open:!0}),a={close:async()=>{this.log("closing webtransport"),c("close")},abort:e=>{this.log("aborting webtransport due to passed err",e),c("abort")},remoteAddr:e,timeline:{open:Date.now()},log:this.components.logger.forComponent("libp2p:webtransport:maconn"),...ik()},await t.upgrader.upgradeOutbound(a,{skipEncryption:!0,muxerFactory:ok(d,d.incomingBidirectionalStreams.getReader(),this.components.logger,this.config),skipProtection:!0,onProgress:t.onProgress})}catch(e){throw this.log.error("caught wt session err",e),c(h?"upgrade_error":u?"noise_error":"ready_error"),e}finally{null!=o&&t.signal?.removeEventListener("abort",o)}}async authenticateWebTransport({wt:e,localPeer:t,remotePeer:n,certhashes:r,onProgress:s,signal:i}){i?.throwIfAborted(),s?.(new Ce("webtransport:open-authentication-stream"));const o=await e.createBidirectionalStream(),a=o.writable.getWriter(),c=o.readable.getReader(),l={source:async function*(){for(;;){const e=await c.read();if(null!=e.value&&(yield e.value),e.done)break}}(),sink:async e=>{for await(const t of e){await M(a.ready,i);const e=t instanceof Uint8Array?t:t.subarray();a.write(e).catch((e=>{this.log.error("could not write chunk during authentication of WebTransport stream",e)}))}}},u=_b()(this.components);s?.(new Ce("webtransport:secure-outbound-connection"));const{remoteExtensions:h}=await u.secureOutbound(t,l,n);if(s?.(new Ce("webtransport:close-authentication-stream")),a.close().catch((e=>{this.log.error(`Failed to close authentication stream writer: ${e.message}`)})),c.cancel().catch((e=>{this.log.error(`Failed to close authentication stream reader: ${e.message}`)})),d=h?.webtransportCerthashes??[],(f=r.map((e=>e.bytes))).filter((e=>Boolean(d.find((t=>oe(e,t)))))).length!==f.length)throw new Error("Our certhashes are not a subset of the remote's reported certhashes");var d,f;return!0}createListener(e){return function(){throw new Error("Not implemented")}(this.components,(this.config.certificates,this.config.maxInboundStreams))}listenFilter(){return[]}dialFilter(e){return null==globalThis.WebTransport?[]:e.filter((e=>{if(!Pi.exactMatch(e))return!1;const{url:t,certhashes:n}=ck(e);return null!=t&&n.length>0}))}}function hk(e={}){return t=>new uk(t,e)}function dk(e,t){const n=t.map(((e,t)=>({record:lE(e),index:t})));return n.sort(((e,t)=>{const n=e.record.sequence,r=t.record.sequence;if(n>r)return-1;if(n<r)return 1;if(e.record.validityType===sE.ValidityType.EOL&&t.record.validityType===sE.ValidityType.EOL){const n=pE.fromString(e.record.validity).toDate(),r=pE.fromString(t.record.validity).toDate();if(n.getTime()>r.getTime())return-1;if(n.getTime()<r.getTime())return 1}return 0})),n[0].index}const fk="4.2.6",pk="helia",gk={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};async function yk(e){const t=e.libp2p?.peerId,n=e.logger??Xo(),r=new ia("/pkcs8/self");let s;null==t&&null!=e.datastore&&(s=ty(e.keychain)({datastore:e.datastore,logger:n}),await e.datastore.has(r)&&(e.libp2p=e.libp2p??{},e.libp2p.peerId=await s.exportPeerId("self")));const i=function(e={}){const t=`${pk}/${fk} ${yw}/${gw} UserAgent=${globalThis.navigator.userAgent}`;return{peerId:e.peerId,dns:e.dns,addresses:{listen:["/webrtc"]},transports:[Lv({discoverRelays:1}),e=>new MR(e,void 0),jR(),hk(),nk()],connectionEncryption:[_b()],streamMuxers:[Xb(),z_()],peerDiscovery:[uv(gk)],services:{autoNAT:DE(),dcutr:Fv(),delegatedRouting:()=>function(e,t={}){return new IE(new URL("https://delegated-ipfs.dev"),t)}(),dht:I_({clientMode:!0,validators:{ipns:wE},selectors:{ipns:dk}}),identify:uS({agentVersion:t}),identifyPush:hS({agentVersion:t}),keychain:ty(e.keychain),ping:q_()}}}(e);i.datastore=i.datastore??e.datastore,e=e??{};const o=await async function(e={}){const t=await async function(e={}){const t=e.peerId??=await sy();if(null==t.privateKey)throw new k("peer id was missing private key","ERR_MISSING_PRIVATE_KEY");return e.privateKey??=await $g(t.privateKey),new mw(await async function(e){const t=Kg(Wy,e);if(null===t.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw new k(Ky.ERR_PROTECTOR_REQUIRED,qy.ERR_PROTECTOR_REQUIRED);if(null!=t.privateKey&&!(await Cr(t.privateKey.public.bytes,t.privateKey.bytes)).equals(t.peerId))throw new k("Private key doesn't match peer id",qy.ERR_INVALID_KEY);return t}(e))}(e);return!1!==e.start&&await t.start(),t}({...i,...e.libp2p,start:!1});return null!=t||null==s||await e.datastore.has(r)||await s.importPeer("self",o.peerId),o}async function mk(e={}){const t=e.datastore??new la,n=e.blockstore??new $o;let r;var s;r=null!=(s=e.libp2p)&&["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every((e=>"function"==typeof s[e]))?e.libp2p:await yk({...e,libp2p:{dns:e.dns,...e.libp2p,start:void 0},datastore:t});const i=new ku({...e,libp2p:r,datastore:t,blockstore:n,blockBrokers:e.blockBrokers??[Xi(),ps()],routers:[eo(r),xo()],metrics:r.metrics});return!1!==e.start&&await i.start(),i}const wk=function(e,t=1){return t=Number(t),null!=e[Symbol.asyncIterator]?async function*(){let n=[];if(t<1&&(t=1),t!==Math.round(t))throw new Error("Batch size must be an integer");for await(const r of e)for(n.push(r);n.length>=t;)yield n.slice(0,t),n=n.slice(t);for(;n.length>0;)yield n.slice(0,t),n=n.slice(t)}():function*(){let n=[];if(t<1&&(t=1),t!==Math.round(t))throw new Error("Batch size must be an integer");for(const r of e)for(n.push(r);n.length>=t;)yield n.slice(0,t),n=n.slice(t);for(;n.length>0;)yield n.slice(0,t),n=n.slice(t)}()};async function*bk(e,t=1){for await(const n of wk(e,t)){const e=n.map((async e=>e().then((e=>({ok:!0,value:e})),(e=>({ok:!1,err:e})))));for(let t=0;t<e.length;t++){const n=await e[t];if(!n.ok)throw n.err;yield n.value}}}const Ek=(e={})=>{const t=e.chunkSize??262144;return async function*(e){let n=new ue,r=0,s=!1;for await(const i of e)for(n.append(i),r+=i.length;r>=t;)if(yield n.slice(0,t),s=!0,t===n.length)n=new ue,r=0;else{const e=new ue;e.append(n.sublist(t)),n=e,r-=t}(!s||r>0)&&(yield n.subarray(0,r))}};class vk extends Error{static name="InvalidTypeError";static code="ERR_INVALID_TYPE";name=vk.name;code=vk.code;constructor(e="Invalid type"){super(e)}}var Sk,_k,Rk;!function(e){let t,n,r;!function(e){e.Raw="Raw",e.Directory="Directory",e.File="File",e.Metadata="Metadata",e.Symlink="Symlink",e.HAMTShard="HAMTShard"}(t=e.DataType||(e.DataType={})),function(e){e[e.Raw=0]="Raw",e[e.Directory=1]="Directory",e[e.File=2]="File",e[e.Metadata=3]="Metadata",e[e.Symlink=4]="Symlink",e[e.HAMTShard=5]="HAMTShard"}(n||(n={})),function(e){e.codec=()=>or(n)}(t=e.DataType||(e.DataType={})),e.codec=()=>(null==r&&(r=ar(((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.Type&&(n.uint32(8),e.DataType.codec().encode(t.Type,n)),null!=t.Data&&(n.uint32(18),n.bytes(t.Data)),null!=t.filesize&&(n.uint32(24),n.uint64(t.filesize)),null!=t.blocksizes)for(const e of t.blocksizes)n.uint32(32),n.uint64(e);null!=t.hashType&&(n.uint32(40),n.uint64(t.hashType)),null!=t.fanout&&(n.uint32(48),n.uint64(t.fanout)),null!=t.mode&&(n.uint32(56),n.uint32(t.mode)),null!=t.mtime&&(n.uint32(66),_k.codec().encode(t.mtime,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={blocksizes:[]},s=null==n?t.len:t.pos+n;for(;t.pos<s;){const n=t.uint32();switch(n>>>3){case 1:r.Type=e.DataType.codec().decode(t);break;case 2:r.Data=t.bytes();break;case 3:r.filesize=t.uint64();break;case 4:r.blocksizes.push(t.uint64());break;case 5:r.hashType=t.uint64();break;case 6:r.fanout=t.uint64();break;case 7:r.mode=t.uint32();break;case 8:r.mtime=_k.codec().decode(t,t.uint32());break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(Sk||(Sk={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.Seconds&&(t.uint32(8),t.int64(e.Seconds)),null!=e.FractionalNanoseconds&&(t.uint32(21),t.fixed32(e.FractionalNanoseconds)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Seconds=e.int64();break;case 2:n.FractionalNanoseconds=e.fixed32();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(_k||(_k={})),function(e){let t;e.codec=()=>(null==t&&(t=ar(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.MimeType&&(t.uint32(10),t.string(e.MimeType)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();t>>>3==1?n.MimeType=e.string():e.skipType(7&t)}return n}))),t),e.encode=t=>Gn(t,e.codec()),e.decode=t=>Qe(t,e.codec())}(Rk||(Rk={}));const kk={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},Ak=["directory","hamt-sharded-directory"],Ik=parseInt("0644",8),Tk=parseInt("0755",8);class xk{static unmarshal(e){const t=Sk.decode(e),n=new xk({type:kk[null!=t.Type?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:null!=t.mtime?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return n._originalMode=t.mode??0,n}type;data;blockSizes;hashType;fanout;mtime;_mode;_originalMode;constructor(e={type:"file"}){const{type:t,data:n,blockSizes:r,hashType:s,fanout:i,mtime:o,mode:a}=e;if(null!=t&&!Object.values(kk).includes(t))throw new vk("Type: "+t+" is not valid");this.type=t??"file",this.data=n,this.hashType=s,this.fanout=i,this.blockSizes=r??[],this._originalMode=0,this.mode=a,this.mtime=o}set mode(e){this._mode=null==e?this.isDirectory()?Tk:Ik:4095&e}get mode(){return this._mode}isDirectory(){return Ak.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach((t=>{e+=t})),null!=this.data&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=Sk.DataType.Raw;break;case"directory":e=Sk.DataType.Directory;break;case"file":e=Sk.DataType.File;break;case"metadata":e=Sk.DataType.Metadata;break;case"symlink":e=Sk.DataType.Symlink;break;case"hamt-sharded-directory":e=Sk.DataType.HAMTShard;break;default:throw new vk(`Type: ${e} is not valid`)}let t,n,r=this.data;return null!=this.data&&0!==this.data.length||(r=void 0),null!=this.mode&&(t=4294963200&this._originalMode|(this.mode??0),t!==Ik||this.isDirectory()||(t=void 0),t===Tk&&this.isDirectory()&&(t=void 0)),null!=this.mtime&&(n={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),Sk.encode({Type:e,Data:r,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:t,mtime:n})}}const Dk=async(e,t,n)=>{null==n.codec&&(n.codec=y);const r=await bn.digest(e),s=Rn.create(n.cidVersion,n.codec.code,r);return await t.put(s,e,n),s};function Ck(e){return async function*(t,n){let r=0n;for await(let s of t.content)yield async()=>{let i;const o={codec:y,cidVersion:e.cidVersion,onProgress:e.onProgress};e.rawLeaves?(o.codec=d,o.cidVersion=1):(i=new xk({type:e.leafType,data:s}),s=ou({Data:i.marshal(),Links:[]}));const a=await Dk(s,n,o);return r+=BigInt(s.byteLength),e.onProgress?.(new Ce("unixfs:importer:progress:file:write",{bytesWritten:r,cid:a,path:t.path})),{cid:a,unixfs:i,size:BigInt(s.length),block:s}}}}class Nk extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=Nk.name;code=Nk.code;constructor(e="Invalid parameters"){super(e)}}Error,Error,Error;class Pk extends Error{static name="InvalidContentError";static code="ERR_INVALID_CONTENT";name=Pk.name;code=Pk.code;constructor(e="Invalid content"){super(e)}}const Lk=async(e,t,n)=>{const r=new xk({type:"directory",mtime:e.mtime,mode:e.mode}),s=ou(eu({Data:r.marshal()}));return{cid:await Dk(s,t,n),path:e.path,unixfs:r,size:BigInt(s.length),originalPath:e.originalPath,block:s}};function Bk(e){return!0===e.single}const Ok=async(e,t,n)=>n.layout(async function*(e,t,n){let r,s=-1;for await(const i of bk(n.bufferImporter(e,t),n.blockWriteConcurrency))s++,0!==s?(1===s&&null!=r&&(yield{...r,block:void 0,single:void 0},r=void 0),yield{...i,block:void 0}):r={...i,single:!0};null!=r&&(yield r)}(e,t,n),((e,t,n)=>async function(r){if(1===r.length&&Bk(r[0])&&n.reduceSingleLeafToSelf){const s=r[0];let i=s.block;return!Bk(s)||void 0===e.mtime&&void 0===e.mode||(s.unixfs=new xk({type:"file",mtime:e.mtime,mode:e.mode,data:s.block}),i={Data:s.unixfs.marshal(),Links:[]},s.block=ou(eu(i)),s.cid=await Dk(s.block,t,{...n,cidVersion:n.cidVersion}),s.size=BigInt(s.block.length)),n.onProgress?.(new Ce("unixfs:importer:progress:file:layout",{cid:s.cid,path:s.originalPath})),{cid:s.cid,path:e.path,unixfs:s.unixfs,size:s.size,originalPath:s.originalPath}}const s=new xk({type:"file",mtime:e.mtime,mode:e.mode}),i=r.filter((e=>e.cid.code===Ht&&e.size>0||null!=e.unixfs&&null==e.unixfs.data&&e.unixfs.fileSize()>0n||Boolean(e.unixfs?.data?.length))).map((e=>e.cid.code===Ht?(s.addBlockSize(e.size),{Name:"",Tsize:Number(e.size),Hash:e.cid}):(null==e.unixfs?.data?s.addBlockSize(e.unixfs?.fileSize()??0n):s.addBlockSize(BigInt(e.unixfs.data.length)),{Name:"",Tsize:Number(e.size),Hash:e.cid}))),o={Data:s.marshal(),Links:i},a=ou(eu(o)),c=await Dk(a,t,n);return n.onProgress?.(new Ce("unixfs:importer:progress:file:layout",{cid:c,path:e.originalPath})),{cid:c,path:e.path,unixfs:s,size:BigInt(a.length+o.Links.reduce(((e,t)=>e+(t.Tsize??0)),0)),originalPath:e.originalPath,block:a}})(e,t,n));function Mk(e){try{if(e instanceof Uint8Array)return async function*(){yield e}();if(t=e,Symbol.iterator in t)return async function*(){yield*e}();if(function(e){return Symbol.asyncIterator in e}(e))return e}catch{throw new Pk("Content was invalid")}var t;throw new Pk("Content was invalid")}function Uk(e){return null!=e.content}const Fk=()=>async function*(e){for await(const t of e){if(void 0===t.length)throw new Pk("Content was invalid");if("string"==typeof t||t instanceof String)yield Ln(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else{if(!(t instanceof Uint8Array))throw new Pk("Content was invalid");yield t}}},$k=174;function Vk(e){const t=e?.maxChildrenPerNode??$k;return async function e(n,r){const s=[];for await(const e of wk(n,t))s.push(await r(e));return s.length>1?e(s,r):s[0]}}class zk{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}const Hk=Rn.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),Kk=Rn.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");class qk extends zk{_children;constructor(e,t){super(e,t),this._children=new Map}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,t)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}async*eachChildSeries(){for(const[e,t]of this._children.entries())yield{key:e,child:t}}estimateNodeSize(){if(void 0!==this.nodeSize)return this.nodeSize;this.nodeSize=0;for(const[e,t]of this._children.entries())null!=t.size&&null!=t.cid&&(this.nodeSize+=e.length+(1===this.options.cidVersion?Kk.bytes.byteLength:Hk.bytes.byteLength));return this.nodeSize}async*flush(e){const t=[];for(const[n,r]of this._children.entries()){let s=r;if(r instanceof zk)for await(const t of r.flush(e))s=t,yield t;null!=s.size&&null!=s.cid&&t.push({Name:n,Tsize:Number(s.size),Hash:s.cid})}const n=new xk({type:"directory",mtime:this.mtime,mode:this.mode}),r={Data:n.marshal(),Links:t},s=ou(eu(r)),i=await Dk(s,e,this.options),o=s.length+r.Links.reduce(((e,t)=>e+(t.Tsize??0)),0);this.cid=i,this.size=o,yield{cid:i,unixfs:n,path:this.path,size:BigInt(o)}}}yn({name:"murmur3-32",code:35,encode:e=>function(e){const t=new Array(4);for(let n=0;n<4;n++)t[n]=255&e,e>>=8;return new Uint8Array(t)}(ns.x86.hash32(e))});const Wk=yn({name:"murmur3-128",code:34,encode:e=>Xe(ns.x64.hash128(e))});yn({name:"murmur3-x64-64",code:34,encode:e=>Xe(ns.x64.hash128(e)).subarray(0,8)});var jk=n(669);class Gk{_options;_popCount;_parent;_posAtParent;_children;key;constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new jk,this.key=null}async put(e,t){const n=await this._findNewBucketAndPos(e);n.bucket._putAt(n,e,t)}async get(e){const t=await this._findChild(e);if(null!=t)return t.value}async del(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);null!=n&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce(((e,t)=>t instanceof Gk?e+t.leafCount():e+1),0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof Gk?yield*t.eachLeafSeries():yield t}serialize(e,t){return t(this._children.reduce(((n,r,s)=>(null!=r&&(r instanceof Gk?n.push(r.serialize(e,t)):n.push(e(r,s))),n)),[]))}async asyncTransform(e,t){return Xk(this,e,t)}toJSON(){return this.serialize(Qk,Jk)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof Gk))return null!=n&&n.key===e?n:void 0}async _findPlace(e){const t=this._options.hash("string"==typeof e?Ln(e):e),n=await t.take(this._options.bits),r=this._children.get(n);return r instanceof Gk?r._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:r}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(null!=t.existingChild&&t.existingChild.key!==e){const e=new Gk(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,e);const n=await e._findPlace(t.existingChild.hash);return n.bucket._putAt(n,t.existingChild.key,t.existingChild.value),e._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){null==this._children.get(e)&&this._popCount++,this._children.set(e,t)}_delAt(e){if(-1===e)throw new Error("Invalid position");null!=this._children.get(e)&&this._popCount--,this._children.unset(e),this._level()}_level(){if(null!=this._parent&&this._popCount<=1)if(1===this._popCount){const e=this._children.find(Yk);if(null!=e&&!(e instanceof Gk)){const t=e.hash;t.untake(this._options.bits);const n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function Yk(e){return Boolean(e)}function Qk(e,t){return e.key}function Jk(e){return e}async function Xk(e,t,n){const r=[];for(const s of e._children.compactArray())if(s instanceof Gk)await Xk(s,t,n);else{const n=await t(s);r.push({bitField:e._children.bitField(),children:n})}return n(r)}const Zk=[255,254,252,248,240,224,192,128],eA=[1,3,7,15,31,63,127,255];class tA{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+8*this._currentBytePos}totalBits(){return 8*this._value.length}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const e=this._value[this._currentBytePos],r=this._currentBitPos+1,s=Math.min(r,t);n=(n<<s)+nA(e,r-s,s),t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function nA(e,t,n){const r=function(e,t){return Zk[e]&eA[Math.min(t+e-1,7)]}(t,n);return(e&r)>>>t}function rA(e){return function(t){return t instanceof sA?t:new sA(t,e)}}class sA{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const e=this._buffers[this._currentBufferIndex],r=Math.min(e.availableBits(),t);n=(n<<r)+e.take(r),t-=r,this._availableBits-=r,0===e.availableBits()&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const e=this._buffers[this._currentBufferIndex],n=Math.min(e.totalBits()-e.availableBits(),t);e.untake(n),t-=n,this._availableBits+=n,this._currentBufferIndex>0&&e.totalBits()===e.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?ie([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new tA(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}function iA(e){if(null==e||null==e.hashFn)throw new Error("please define an options.hashFn");const t={bits:e.bits??8,hash:rA(e.hashFn)};return new Gk(t)}async function oA(e){return(await Wk.encode(e)).slice(0,8).reverse()}const aA=BigInt(34),cA=class extends zk{_bucket;constructor(e,t){super(e,t),this._bucket=iA({hashFn:oA,bits:t.shardFanoutBits??8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return void 0!==this.nodeSize||(this.nodeSize=uA(this._bucket,this,this.options)),this.nodeSize}async*flush(e){for await(const t of lA(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*lA(e,t,n,r){const s=e._children,i=(e.tableSize()-1).toString(16).length,o=[];let a=0n;for(let e=0;e<s.length;e++){const n=s.get(e);if(null==n)continue;const c=e.toString(16).toUpperCase().padStart(i,"0");if(n instanceof Gk){let e;for await(const s of lA(n,t,null,r))e=s;if(null==e)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:c,Tsize:Number(e.size),Hash:e.cid}),a+=e.size}else if("function"==typeof n.value.flush){const e=n.value;let r;for await(const n of e.flush(t))r=n,yield r;if(null==r)throw new Error("Did not flush dir");const s=c+n.key;o.push({Name:s,Tsize:Number(r.size),Hash:r.cid}),a+=r.size}else{const e=n.value;if(null==e.cid)continue;const t=c+n.key,r=e.size;o.push({Name:t,Tsize:Number(r),Hash:e.cid}),a+=BigInt(r??0)}}const c=Uint8Array.from(s.bitField().reverse()),l=new xk({type:"hamt-sharded-directory",data:c,fanout:BigInt(e.tableSize()),hashType:aA,mtime:n?.mtime,mode:n?.mode}),u=ou(eu({Data:l.marshal(),Links:o})),h=await Dk(u,t,r),d=BigInt(u.byteLength)+a;yield{cid:h,unixfs:l,size:d}}function uA(e,t,n){const r=e._children,s=(e.tableSize()-1).toString(16).length,i=[];for(let e=0;e<r.length;e++){const t=r.get(e);if(null==t)continue;const o=e.toString(16).toUpperCase().padStart(s,"0");if(t instanceof Gk){const e=uA(t,null,n);i.push({Name:o,Tsize:Number(e),Hash:0===n.cidVersion?Hk:Kk})}else if("function"==typeof t.value.flush){const e=t.value.nodeSize();i.push({Name:o+t.key,Tsize:Number(e),Hash:0===n.cidVersion?Hk:Kk})}else{const e=t.value;if(null==e.cid)continue;const n=o+t.key,r=e.size;i.push({Name:n,Tsize:Number(r),Hash:e.cid})}}const o=Uint8Array.from(r.bitField().reverse());return ou(eu({Data:new xk({type:"hamt-sharded-directory",data:o,fanout:BigInt(e.tableSize()),hashType:aA,mtime:t?.mtime,mode:t?.mode}).marshal(),Links:i})).length}async function hA(e,t,n,r){let s=t;t instanceof qk&&t.estimateNodeSize()>n&&(s=await async function(e,t){const n=new cA({root:e.root,dir:!0,parent:e.parent,parentKey:e.parentKey,path:e.path,dirty:e.dirty,flat:!1,mtime:e.mtime,mode:e.mode},t);for await(const{key:t,child:r}of e.eachChildSeries())await n.put(t,r);return n}(t,r));const i=s.parent;if(null!=i){if(s!==t){if(null!=e&&(e.parent=s),null==s.parentKey)throw new Error("No parent key found");await i.put(s.parentKey,s)}return hA(s,i,n,r)}return s}const dA=(e="")=>e.split(/(?<!\\)\//).filter(Boolean);async function fA(e,t,n){const r=dA(e.path??""),s=r.length-1;let i=t,o="";for(let a=0;a<r.length;a++){const c=r[a];o+=`${""!==o?"/":""}${c}`;const l=a===s;if(i.dirty=!0,i.cid=void 0,i.size=void 0,l)await i.put(c,e),t=await hA(null,i,n.shardSplitThresholdBytes,n);else{let e=await i.get(c);null!=e&&e instanceof zk||(e=new qk({root:!1,dir:!0,parent:i,parentKey:c,path:o,dirty:!0,flat:!0,mtime:e?.unixfs?.mtime,mode:e?.unixfs?.mode},n)),await i.put(c,e),i=e}}return t}async function*pA(e,t){e instanceof zk?yield*e.flush(t):!0===e.unixfs?.isDirectory()&&(yield e)}async function*gA(e,t,n={}){let r;r=Symbol.asyncIterator in e||Symbol.iterator in e?e:[e];const s=n.wrapWithDirectory??!1,i=n.shardSplitThresholdBytes??262144,o=n.shardFanoutBits??8,a=n.cidVersion??1,c=n.rawLeaves??!0,l=n.leafType??"file",u=n.fileImportConcurrency??50,h=n.blockWriteConcurrency??10,d=n.reduceSingleLeafToSelf??!0,f=n.chunker??Ek(),p=n.chunkValidator??Fk(),g=n.dagBuilder??function(e){return async function*(t,n){for await(const r of t){let t;if(null!=r.path&&(t=r.path,r.path=r.path.split("/").filter((e=>null!=e&&"."!==e)).join("/")),Uk(r)){const s={path:r.path,mtime:r.mtime,mode:r.mode,content:async function*(){let t=0n;for await(const n of e.chunker(e.chunkValidator(Mk(r.content)))){const s=BigInt(n.byteLength);t+=s,e.onProgress?.(new Ce("unixfs:importer:progress:file:read",{bytesRead:t,chunkSize:s,path:r.path})),yield n}}(),originalPath:t};yield async()=>Ok(s,n,e)}else{if(null==r.path)throw new Error("Import candidate must have content or path or both");{const s={path:r.path,mtime:r.mtime,mode:r.mode,originalPath:t};yield async()=>Lk(s,n,e)}}}}}({chunker:f,chunkValidator:p,wrapWithDirectory:s,layout:n.layout??Vk(),bufferImporter:n.bufferImporter??Ck({cidVersion:a,rawLeaves:c,leafType:l,onProgress:n.onProgress}),blockWriteConcurrency:h,reduceSingleLeafToSelf:d,cidVersion:a,onProgress:n.onProgress}),y=n.treeBuilder??function(e){return async function*(t,n){let r,s=new qk({root:!0,dir:!0,path:"",dirty:!0,flat:!0},e),i=!1;for await(const n of t){if(null==n)continue;const t=`${n.originalPath??""}`.split("/")[0];null!=t&&""!==t&&(null==r?(r=t,i=!0):r!==t&&(i=!1)),s=await fA(n,s,e),!0!==n.unixfs?.isDirectory()&&(yield n)}if(e.wrapWithDirectory||i&&s.childCount()>1)yield*pA(s,n);else for await(const e of s.eachChildSeries())null!=e&&(yield*pA(e.child,n))}}({wrapWithDirectory:s,shardSplitThresholdBytes:i,shardFanoutBits:o,cidVersion:a,onProgress:n.onProgress});for await(const e of y(bk(g(r,t),u),t))yield{cid:e.cid,path:e.path,unixfs:e.unixfs,size:e.size}}async function yA(e,t,n={}){const r=await EE(gA([e],t,n));if(null==r)throw new Nk("Nothing imported");return r}const mA={cidVersion:1,rawLeaves:!0,layout:Vk({maxChildrenPerNode:1024}),chunker:Ek({chunkSize:1048576})};const wA=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{let t;for await(const n of e)t=n;return t})();let t;for(const n of e)t=n;return t};class bA extends Error{static name="BadPathError";static code="ERR_BAD_PATH";name=bA.name;code=bA.code;constructor(e="Bad path"){super(e)}}class EA extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=EA.name;code=EA.code;constructor(e="Not found"){super(e)}}class vA extends Error{static name="NoResolverError";static code="ERR_NO_RESOLVER";name=vA.name;code=vA.code;constructor(e="No resolver"){super(e)}}class SA extends Error{static name="NotUnixFSError";static code="ERR_NOT_UNIXFS";name=SA.name;code=SA.code;constructor(e="Not UnixFS"){super(e)}}class _A extends Error{static name="OverReadError";static code="ERR_OVER_READ";name=_A.name;code=_A.code;constructor(e="Over read"){super(e)}}class RA extends Error{static name="UnderReadError";static code="ERR_UNDER_READ";name=RA.name;code=RA.code;constructor(e="Under read"){super(e)}}class kA extends Error{static name="NoPropError";static code="ERR_NO_PROP";name=kA.name;code=kA.code;constructor(e="No Property found"){super(e)}}class AA extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=AA.name;code=AA.code;constructor(e="Invalid parameters"){super(e)}}function IA(e,t,n,r,s,i,o){let a=e,c=s;for(;i.length>0;){const l=i[0];if(!(l in a))throw new kA(`No property named ${l} found in node ${n}`);{i.shift(),c=`${c}/${l}`;const u=Rn.asCID(a[l]);if(null!=u)return{entry:{type:"object",name:r,path:s,cid:n,node:t,depth:o,size:BigInt(t.length),content:async function*(){yield e}},next:{cid:u,name:l,path:c,toResolve:i}};a=a[l]}}return{entry:{type:"object",name:r,path:s,cid:n,node:t,depth:o,size:BigInt(t.length),content:async function*(){yield e}}}}const TA=function(e,t,n,r){const s=BigInt(e.length),i=BigInt(t+s);return n>=i||r<t?new Uint8Array(0):(r>=t&&r<i&&(e=e.subarray(0,Number(r-t))),n>=t&&n<i&&(e=e.subarray(Number(n-t))),e)},xA=(e,t=0,n=e)=>{const r=BigInt(e),s=BigInt(t??0);let i=BigInt(n);if(i!==r&&(i=s+i),i>r&&(i=r),s<0n)throw new AA("Offset must be greater than or equal to 0");if(s>r)throw new AA("Offset must be less than the file size");if(i<0n)throw new AA("Length must be greater than or equal to 0");if(i>r)throw new AA("Length must be less than the file size");return{start:s,end:i}},DA=async function(e){return(await Wk.encode(e)).slice(0,8).reverse()},CA=(e,t)=>e.toString(16).toUpperCase().padStart(t,"0").substring(0,t),NA=async(e,t,n,r,s)=>{if(null==r){if(null==e.Data)throw new SA("no data in PBNode");let t;try{t=xk.unmarshal(e.Data)}catch(e){throw new SA(e.message)}if("hamt-sharded-directory"!==t.type)throw new SA("not a HAMT");if(null==t.fanout)throw new SA("missing fanout");const n=iA({hashFn:DA,bits:Math.log2(Number(t.fanout))});r={rootBucket:n,hamtDepth:1,lastBucket:n}}const i=(r.lastBucket.tableSize()-1).toString(16).length;await(async(e,t,n)=>{const r=(t.tableSize()-1).toString(16).length;await Promise.all(e.map((async e=>{if(null==e.Name)throw new Error("Unexpected Link without a Name");if(e.Name.length!==r)await n.put(e.Name.substring(2),!0);else{const r=parseInt(e.Name,16);t._putObjectAt(r,new Gk({hash:n._options.hash,bits:n._options.bits},t,r))}})))})(e.Links,r.lastBucket,r.rootBucket);const o=await r.rootBucket._findNewBucketAndPos(t);let a=CA(o.pos,i);const c=(e=>{let t=e.bucket;const n=[];for(;null!=t._parent;)n.push(t),t=t._parent;return n.push(t),n.reverse()})(o);c.length>r.hamtDepth&&(r.lastBucket=c[r.hamtDepth],a=CA(r.lastBucket._posAtParent,i));const l=e.Links.find((e=>{if(null==e.Name)return!1;const n=e.Name.substring(0,i),r=e.Name.substring(i);return n===a&&(""===r||r===t)}));if(null!=l)return null!=l.Name&&l.Name.substring(i)===t?l.Hash:(r.hamtDepth++,e=au(await n.get(l.Hash,s)),NA(e,t,n,r,s))},PA=NA;async function LA(e,t,n,r,s,i,o){if(t instanceof Uint8Array){const e=TA(t,r,s,i);return void n.push(e)}if(null==t.Data)throw new SA("no data in PBNode");let a;try{a=xk.unmarshal(t.Data)}catch(e){throw new SA(e.message)}if(null!=a.data){const e=a.data,t=TA(e,r,s,i);n.push(t),r+=BigInt(t.byteLength)}const c=[];if(t.Links.length!==a.blockSizes.length)throw new SA("Inconsistent block sizes and dag links");for(let e=0;e<t.Links.length;e++){const n=t.Links[e],o=r,l=o+a.blockSizes[e];if((s>=o&&s<l||i>=o&&i<=l||s<o&&i>l)&&c.push({link:n,blockStart:r}),(r=l)>i)break}await Re(c,(t=>Se(t,(t=>async()=>{const n=await e.get(t.link.Hash,o);return{...t,block:n}}))),(e=>Ym(e,{ordered:!0,concurrency:o.blockReadConcurrency})),(async t=>{for await(const{link:r,block:a,blockStart:c}of t){let t;switch(r.Hash.code){case iu:t=au(a);break;case Ht:t=a;break;default:return void n.end(new SA(`Unsupported codec: ${r.Hash.code}`))}const l=new Sa({concurrency:1});l.on("error",(e=>{n.end(e)})),l.add((async()=>{o.onProgress?.(new Ce("unixfs:exporter:walk:file",{cid:r.Hash})),await LA(e,t,n,c,s,i,o)})),await l.onIdle()}})),r>=i&&n.end()}const BA=(e,t,n,r,s,i,o)=>async function*(r={}){const s=n.fileSize();if(void 0===s)throw new Error("File was a directory");const{start:i,end:a}=xA(s,r.offset,r.length);if(0n===a)return;let c=0n;const l=a-i,u=P();r.onProgress?.(new Ce("unixfs:exporter:walk:file",{cid:e})),LA(o,t,u,0n,i,a,r).catch((e=>{u.end(e)}));for await(const e of u)if(null!=e){if(c+=BigInt(e.byteLength),c>l)throw u.end(),new _A("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");c===l&&u.end(),r.onProgress?.(new Ce("unixfs:exporter:progress:unixfs:file",{bytesRead:c,totalBytes:l,fileSize:s})),yield e}if(c<l)throw new RA("Traversed entire DAG but did not read enough bytes")};async function*OA(e,t,n,r,s,i){const o=e.Links;if(null==e.Data)throw new SA("no data in PBNode");let a;try{a=xk.unmarshal(e.Data)}catch(e){throw new SA(e.message)}if(null==a.fanout)throw new SA("missing fanout");const c=(a.fanout-1n).toString(16).length,l=Re(o,(o=>Se(o,(o=>async()=>{const a=null!=o.Name?o.Name.substring(c):null;if(null!=a&&""!==a){const e=await n(o.Hash,a,`${t}/${a}`,[],r+1,s,i);return{entries:null==e.entry?[]:[e.entry]}}{const a=await s.get(o.Hash,i);return e=au(a),i.onProgress?.(new Ce("unixfs:exporter:walk:hamt-sharded-directory",{cid:o.Hash})),{entries:OA(e,t,n,r,s,i)}}}))),(e=>Ym(e,{ordered:!0,concurrency:i.blockReadConcurrency})));for await(const{entries:e}of l)yield*e}const MA={raw:BA,file:BA,directory:(e,t,n,r,s,i,o)=>async function*(n={}){const a=n.offset??0,c=n.length??t.Links.length,l=t.Links.slice(a,c);n.onProgress?.(new Ce("unixfs:exporter:walk:directory",{cid:e})),yield*Re(l,(e=>Se(e,(e=>async()=>{const t=e.Name??"",a=`${r}/${t}`;return(await s(e.Hash,t,a,[],i+1,o,n)).entry}))),(e=>Ym(e,{ordered:!0,concurrency:n.blockReadConcurrency})),(e=>ea(e,(e=>null!=e))))},"hamt-sharded-directory":(e,t,n,r,s,i,o)=>function(n={}){return n.onProgress?.(new Ce("unixfs:exporter:walk:hamt-sharded-directory",{cid:e})),OA(t,r,s,i,o,n)},metadata:(e,t,n,r,s,i,o)=>()=>[],symlink:(e,t,n,r,s,i,o)=>()=>[]},UA={[iu]:async(e,t,n,r,s,i,o,a)=>{const c=au(await o.get(e,a));let l,u;if(null==t&&(t=e.toString()),null==c.Data)throw new SA("no data in PBNode");try{l=xk.unmarshal(c.Data)}catch(e){throw new SA(e.message)}if(null==n&&(n=t),r.length>0){let e;if(e="hamt-sharded-directory"===l?.type?await PA(c,r[0],o):((e,t)=>{const n=e.Links.find((e=>e.Name===t));return n?.Hash})(c,r[0]),null==e)throw new EA("file does not exist");const t=r.shift();u={cid:e,toResolve:r,name:t??"",path:`${n}/${t}`}}const h=MA[l.type](e,c,l,n,s,i,o);if(null==h)throw new EA("could not find content exporter");return l.isDirectory()?{entry:{type:"directory",name:t,path:n,cid:e,content:h,unixfs:l,depth:i,node:c,size:l.fileSize()},next:u}:{entry:{type:"file",name:t,path:n,cid:e,content:h,unixfs:l,depth:i,node:c,size:l.fileSize()},next:u}},[Ht]:async(e,t,n,r,s,i,o,a)=>{if(r.length>0)throw new EA(`No link named ${n} found in raw node ${e}`);const c=await o.get(e,a);return{entry:{type:"raw",name:t,path:n,cid:e,content:(l=c,async function*(e={}){const{start:t,end:n}=xA(l.length,e.offset,e.length),r=TA(l,0n,t,n);e.onProgress?.(new Ce("unixfs:exporter:progress:raw",{bytesRead:BigInt(r.byteLength),totalBytes:n-t,fileSize:BigInt(l.byteLength)})),yield r}),depth:i,size:BigInt(c.length),node:c}};var l},[xl]:async(e,t,n,r,s,i,o,a)=>{const c=await o.get(e,a);return IA(nl(function(e){return e instanceof ArrayBuffer?new Uint8Array(e,0,e.byteLength):e}(c),Tl),c,e,t,n,r,i)},[Ll]:async(e,t,n,r,s,i,o,a)=>{const c=await o.get(e,a);return IA((e=>{const t=function(e){return e instanceof ArrayBuffer?new Uint8Array(e,0,e.byteLength):e}(e);return Cl(t,Object.assign(Pl,{tokenizer:new Nl(t,Pl)}))})(c),c,e,t,n,r,i)},[gn.code]:async(e,t,n,r,s,i,o,a)=>{if(r.length>0)throw new EA(`No link named ${n} found in raw node ${e}`);const c=dn(e.multihash.bytes);return{entry:{type:"identity",name:t,path:n,cid:e,content:(l=c.digest,async function*(e={}){const{start:t,end:n}=xA(l.length,e.offset,e.length),r=TA(l,0n,t,n);e.onProgress?.(new Ce("unixfs:exporter:progress:identity",{bytesRead:BigInt(r.byteLength),totalBytes:n-t,fileSize:BigInt(l.byteLength)})),yield r}),depth:i,size:BigInt(c.digest.length),node:c.digest}};var l},[Ft]:async(e,t,n,r,s,i,o,a)=>{const c=await o.get(e,a);return IA(Vt(c),c,e,t,n,r,i)}},FA=async(e,t,n,r,s,i,o)=>{const a=UA[e.code];if(null==a)throw new vA(`No resolver for code ${e.code}`);return a(e,t,n,r,FA,s,i,o)},$A=FA,VA=e=>{if(e instanceof Uint8Array)return{cid:Rn.decode(e),toResolve:[]};const t=Rn.asCID(e);if(null!=t)return{cid:t,toResolve:[]};if("string"==typeof e){0===e.indexOf("/ipfs/")&&(e=e.substring(6));const t=((e="")=>(e.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean))(e);return{cid:Rn.parse(t[0]),toResolve:t.slice(1)}}throw new bA(`Unknown path type ${e}`)};async function*zA(e,t,n={}){let{cid:r,toResolve:s}=VA(e),i=r.toString(),o=i;const a=s.length;for(;;){const c=await $A(r,i,o,s,a,t,n);if(null==c.entry&&null==c.next)throw new EA(`Could not resolve ${e}`);if(null!=c.entry&&(yield c.entry),null==c.next)return;s=c.next.toResolve,r=c.next.cid,i=c.next.name,o=c.next.path}}async function HA(e,t,n={}){const r=await wA(zA(e,t,n));if(null==r)throw new EA(`Could not resolve ${e}`);return r}async function*KA(e,t,n={}){const r=await HA(e,t,n);if(null!=r&&(yield r,"directory"===r.type))for await(const e of async function*e(t,n){for await(const r of t.content(n))yield r,r instanceof Uint8Array||"directory"===r.type&&(yield*e(r,n))}(r,n))yield e}class qA extends Error{name;code;constructor(e,t,n){super(e),this.name=t,this.code=n}}class WA extends qA{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}}class jA extends qA{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PBNODE")}}class GA extends qA{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}}class YA extends qA{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}}class QA extends qA{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}}class JA extends qA{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}}class XA extends qA{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}}class ZA extends qA{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}}class eI extends qA{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}}function tI(e){return function(t){return t instanceof nI?t:new nI(t,e)}}class nI{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const e=this._buffers[this._currentBufferIndex],r=Math.min(e.availableBits(),t);n=(n<<r)+e.take(r),t-=r,this._availableBits-=r,0===e.availableBits()&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const e=this._buffers[this._currentBufferIndex],n=Math.min(e.totalBits()-e.availableBits(),t);e.untake(n),t-=n,this._availableBits+=n,this._currentBufferIndex>0&&e.totalBits()===e.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?ie([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new iI(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}const rI=[255,254,252,248,240,224,192,128],sI=[1,3,7,15,31,63,127,255];class iI{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+8*this._currentBytePos}totalBits(){return 8*this._value.length}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const e=this._value[this._currentBytePos],r=this._currentBitPos+1,s=Math.min(r,t);n=(n<<s)+oI(e,r-s,s),t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function oI(e,t,n){const r=function(e,t){return rI[e]&sI[Math.min(t+e-1,7)]}(t,n);return(e&r)>>>t}const aI=BigInt(Wk.code);async function cI(e){return(await Wk.encode(e)).subarray(0,8).reverse()}const lI=async(e,t,n)=>{null==n.codec&&(n.codec=y);const r=await bn.digest(e),s=Rn.create(n.cidVersion,n.codec.code,r);return await t.put(s,e,{...n,signal:n.signal}),s};class uI{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}class hI extends uI{_bucket;constructor(e,t){super(e,t),this._bucket=iA({hashFn:cI,bits:8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return void 0!==this.nodeSize||(this.nodeSize=fI(this._bucket,this,this.options)),this.nodeSize}async*flush(e){for await(const t of dI(this._bucket,e,this,this.options))yield{...t,path:this.path}}}async function*dI(e,t,n,r){const s=e._children,i=[];let o=0n;for(let e=0;e<s.length;e++){const n=s.get(e);if(null==n)continue;const a=e.toString(16).toUpperCase().padStart(2,"0");if(n instanceof Gk){let e;for await(const s of dI(n,t,null,r))e=s;if(null==e)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:a,Tsize:Number(e.size),Hash:e.cid}),o+=e.size}else if("function"==typeof n.value.flush){const e=n.value;let r;for await(const n of e.flush(t))r=n,yield r;if(null==r)throw new Error("Did not flush dir");const s=a+n.key;i.push({Name:s,Tsize:Number(r.size),Hash:r.cid}),o+=r.size}else{const e=n.value;if(null==e.cid)continue;const t=a+n.key,r=e.size;i.push({Name:t,Tsize:Number(r),Hash:e.cid}),o+=BigInt(r??0)}}const a=Uint8Array.from(s.bitField().reverse()),c=new xk({type:"hamt-sharded-directory",data:a,fanout:BigInt(e.tableSize()),hashType:aI,mtime:n?.mtime,mode:n?.mode}),l=ou(eu({Data:c.marshal(),Links:i})),u=await lI(l,t,r),h=BigInt(l.byteLength)+o;yield{cid:u,unixfs:c,size:h}}function fI(e,t,n){const r=e._children,s=[];for(let e=0;e<r.length;e++){const t=r.get(e);if(null==t)continue;const i=e.toString(16).toUpperCase().padStart(2,"0");if(t instanceof Gk){const e=fI(t,null,n);s.push({Name:i,Tsize:Number(e),Hash:0===n.cidVersion?pI:gI})}else if("function"==typeof t.value.flush){const e=t.value.nodeSize();s.push({Name:i+t.key,Tsize:Number(e),Hash:0===n.cidVersion?pI:gI})}else{const e=t.value;if(null==e.cid)continue;const n=i+t.key,r=e.size;s.push({Name:n,Tsize:Number(r),Hash:e.cid})}}const i=Uint8Array.from(r.bitField().reverse());return ou(eu({Data:new xk({type:"hamt-sharded-directory",data:i,fanout:BigInt(e.tableSize()),hashType:aI,mtime:t?.mtime,mode:t?.mode}).marshal(),Links:s})).length}const pI=Rn.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),gI=Rn.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi"),yI=Zo("helia:unixfs:commands:utils:hamt-utils"),mI=e=>e.toString(16).toUpperCase().padStart(2,"0").substring(0,2),wI=async(e,t,n)=>{const r=xk.unmarshal(e[0].node.Data??new Uint8Array(0)),s=BigInt(Math.pow(2,8));let i,o;e.reverse();for(let a=0;a<e.length;a++){const c=a===e.length-1,l=e[a],u=Uint8Array.from(l.children.bitField().reverse()),h=new xk({type:"hamt-sharded-directory",data:u,fanout:s,hashType:aI});c&&(h.mtime=r.mtime,h.mode=r.mode),o={Data:h.marshal(),Links:l.node.Links};const d=ou(eu(o));if(i=await lI(d,t,n),!c){const t=e[a+1];if(null==t)throw new Error("Was not operating on shard root but also had no parent?");yI("updating link in parent sub-shard with prefix %s",t.prefix),t.node.Links=t.node.Links.filter((e=>e.Name!==t.prefix)),t.node.Links.push({Name:t.prefix,Hash:i,Tsize:l.node.Links.reduce(((e,t)=>e+(t.Tsize??0)),d.byteLength)})}}if(null==i||null==o)throw new Error("Noting persisted");return{cid:i,node:o}},bI=async(e,t,n,r)=>{const s=tI(cI)(Ln(t)),i=[];for(;;){const o=au(await n.get(e,r)),a=new jk,c=await s.take(8),l=mI(c);let u;i.push({prefix:l,children:a,node:o});for(const e of o.Links){const t=e.Name??"";if(t.length<2)throw new Error("Invalid HAMT - link name was too short");const n=parseInt(t.substring(0,2),16);a.set(n,!0),t.startsWith(l)&&(u=e)}if(null==u){yI("no link found with prefix %s for %s",l,t);break}const h=u.Name??"";if(h.length<2)throw new Error("Invalid HAMT - link name was too short");if(2!==h.length)break;e=u.Hash,yI("descend into sub-shard with prefix %s",h)}return{path:i,hash:s}};async function EI(e,t,n,r){if(null==e.Data)throw new Error("DagPB node had no data");const s=xk.unmarshal(e.Data);let i;if("directory"===s.type)i=function(e){let t=0;for(const n of e.Links)t+=(n.Name??"").length,t+=1===n.Hash.version?gI.bytes.byteLength:pI.bytes.byteLength;return t}(e);else{if("hamt-sharded-directory"!==s.type)throw new Error("Can only estimate the size of directories or shards");i=await vI(e,0,n,t,r)}return i>n}async function vI(e,t,n,r,s){if(t>n)return n;if(null==e.Data)return t;if(!xk.unmarshal(e.Data).isDirectory())return t;for(const i of e.Links){let e=i.Name??"";if(e=e.substring(2),t+=e.length,t+=i.Hash.bytes.byteLength,i.Hash.code===iu){const e=au(await r.get(i.Hash,s));t+=await vI(e,t,n,r,s)}}return t}const SI=Zo("helia:unixfs:components:utils:add-link");async function _I(e,t,n,r){if(null==e.node.Data)throw new eI("Invalid parent passed to addLink");if("hamt-sharded-directory"===xk.unmarshal(e.node.Data).type)return SI("adding link to sharded directory"),AI(e,t,n,r);SI(`adding ${t.Name} (${t.Hash}) to regular directory`);const s=await kI(e,t,n,r);if(await EI(s.node,n,r.shardSplitThresholdBytes,r)){SI("converting directory to sharded directory");const e=await RI(s,n);s.cid=e.cid,s.node=au(await n.get(e.cid,r))}return s}const RI=async(e,t)=>{if(null==e.node.Data)throw new eI("Invalid parent passed to convertToShardedDirectory");const n=xk.unmarshal(e.node.Data),r=await(async(e,t,n)=>{const r=new hI({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:n.mtime,mode:n.mode},n);for(let e=0;e<t.length;e++)await r._bucket.put(t[e].name,{size:t[e].size,cid:t[e].cid});const s=await wA(r.flush(e));if(null==s)throw new Error("Flushing shard yielded no result");return s})(t,e.node.Links.map((e=>({name:e.Name??"",size:BigInt(e.Tsize??0),cid:e.Hash}))),{mode:n.mode,mtime:n.mtime,cidVersion:e.cid.version});return SI(`converted directory to sharded directory ${r.cid}`),r},kI=async(e,t,n,r)=>{const s=e.node.Links.filter((e=>{const n=e.Name===t.Name;if(n&&!r.allowOverwriting)throw new YA;return!n}));if(s.push(t),null==e.node.Data)throw new jA("Parent node with no data passed to addToDirectory");const i=xk.unmarshal(e.node.Data);let o;if(null!=i.mtime){const e=Date.now(),t=Math.floor(e/1e3);i.mtime={secs:BigInt(t),nsecs:1e3*(e-1e3*t)},o=i.marshal()}else o=e.node.Data;e.node=eu({Data:o,Links:s});const a=ou(e.node),c=await bn.digest(a),l=Rn.create(e.cid.version,iu,c);return await n.put(l,a),{node:e.node,cid:l}},AI=async(e,t,n,r)=>{const{path:s,hash:i}=await bI(e.cid,t.Name,n,r),o=s[s.length-1];if(null==o)throw new Error("Invalid HAMT, could not generate path");const a=o.prefix,c=parseInt(a,16);SI("next prefix for %s is %s",t.Name,a);const l=`${a}${t.Name}`,u=o.node.Links.find((e=>(e.Name??"").startsWith(a)));if(null!=u)if(SI("link %s was present in shard",l),u.Name===l){if(!r.allowOverwriting)throw new YA;SI("overwriting %s in subshard",t.Name),o.node.Links=o.node.Links.filter((e=>e.Name!==l)),o.node.Links.push({Name:l,Hash:t.Hash,Tsize:t.Tsize})}else{if(2===u.Name?.length)throw new Error("Existing link was subshard?!");{SI("prefix %s already exists, creating new subshard",a);const e=o.node.Links.findIndex((e=>e.Name?.startsWith(a))),n=o.node.Links.splice(e,1)[0],r=(n.Name??"").substring(2),c=tI(cI)(Ln(r));for(let e=0;e<s.length;e++)await c.take(8);for(;;){const e=await c.take(8),o=mI(e);n.Name=`${o}${r}`;const l=await i.take(8),u=mI(l);if(o===u){const e=new jk;e.set(l,!0),s.push({prefix:u,children:e,node:{Links:[]}});continue}const h=new jk;h.set(l,!0),h.set(e,!0),s.push({prefix:a,children:h,node:{Links:[n,{Name:`${u}${t.Name}`,Hash:t.Hash,Tsize:t.Tsize}]}});break}}}else SI("link %s was not present in sub-shard",l),t.Name=l,o.node.Links.push(t),o.children.set(c,!0),SI("adding %s to existing sub-shard",l);return wI(s,n,r)};async function II(e,t,n={}){const r=await HA(e,t,n);if("directory"!==r.type)throw new ZA(`${e.toString()} was not a UnixFS directory`);return{cid:e,node:r.node}}async function TI(e,t,n,r){const s=await HA(e,n,r);if("directory"!==s.type&&"file"!==s.type&&"raw"!==s.type)throw new WA(`${e.toString()} was not a UnixFS node`);return{Name:t,Tsize:s.node instanceof Uint8Array?s.node.byteLength:xI(s.node),Hash:e}}function xI(e){const t=e.Links.reduce(((e,t)=>e+(t.Tsize??0)),0);return ou(e).byteLength+t}const DI=Zo("helia:unixfs:components:utils:resolve");async function CI(e,t,n,r){if(null==t||""===t)return{cid:e};const s=`/ipfs/${e}${null==t?"":`/${t}`}`,i=await oa(zA(s,n,r));if(0===i.length)throw new QA("Could not find path in directory");return DI("resolved %s to %c",t,e),{cid:i[i.length-1].cid,path:t,segments:i}}async function NI(e,t,n,r){if(null==t.segments||0===t.segments.length)return e;let s=t.segments.pop();if(null==s)throw new Error("Insufficient segments");s.cid=e,t.segments.reverse();for(const i of t.segments){const[t,o]=await Promise.all([II(i.cid,n,r),TI(s.cid,s.name,n,r)]);e=(await _I(t,o,n,{...r,allowOverwriting:!0,cidVersion:e.version})).cid,i.cid=e,s=i}return e}const PI=Kg.bind({ignoreUndefined:!0}),LI={},BI=262144,OI=Kg.bind({ignoreUndefined:!0}),MI=Zo("helia:unixfs:chmod"),UI={recursive:!1,shardSplitThresholdBytes:BI},FI=Kg.bind({ignoreUndefined:!0}),$I=Zo("helia:unixfs:cp"),VI={force:!1,shardSplitThresholdBytes:BI},zI=Kg.bind({ignoreUndefined:!0}),HI={},KI=Kg.bind({ignoreUndefined:!0}),qI=Zo("helia:unixfs:mkdir"),WI={cidVersion:1,force:!1,shardSplitThresholdBytes:BI},jI=Zo("helia:unixfs:utils:remove-link"),GI=Kg.bind({ignoreUndefined:!0}),YI=Zo("helia:unixfs:rm"),QI={shardSplitThresholdBytes:BI};async function JI(e,t,n,r={}){const s=GI(QI,r);if(t.includes("/"))throw new eI("Name must not have slashes");const i=await II(e,n,s);YI("Removing %s from %c",t,e);const o=await async function(e,t,n,r){if(null==e.node.Data)throw new jA("Parent node had no data");if("hamt-sharded-directory"===xk.unmarshal(e.node.Data).type){jI(`removing ${t} from sharded directory`);const s=await(async(e,t,n,r)=>{const{path:s}=await bI(e.cid,t,n,r),i=s[s.length-1];if(null==i)throw new Error("Invalid HAMT, could not generate path");const o=i.node.Links.filter((e=>(e.Name??"").substring(2)===t)).map((e=>e.Name)).pop();if(null==o)throw new Error("File not found");const a=o.substring(0,2),c=parseInt(a,16);if(i.node.Links=i.node.Links.filter((e=>e.Name!==o)),i.children.unset(c),1===i.node.Links.length)for(;1!==s.length;){const e=s[s.length-1];if(null==e||e.node.Links.length>1)break;s.pop();const t=s[s.length-1];if(null==t)break;const n=e.node.Links[0];t.node.Links=t.node.Links.filter((e=>!(e.Name??"").startsWith(t.prefix))),t.node.Links.push({Hash:n.Hash,Name:`${t.prefix}${(n.Name??"").substring(2)}`,Tsize:n.Tsize})}return wI(s,n,r)})(e,t,n,r);return await EI(s.node,n,r.shardSplitThresholdBytes,r)?s:(jI("converting shard to flat directory %c",e.cid),(async(e,t,n)=>{if(null==e.node.Data)throw new eI("Invalid parent passed to convertToFlatDirectory");const r={Links:[]},s=await HA(e.cid,t);if("directory"!==s.type)throw new Error("Unexpected node type");for await(const e of s.content()){let t=0;t=e.node instanceof Uint8Array?e.node.byteLength:ou(e.node).length,r.Links.push({Hash:e.cid,Name:e.name,Tsize:t})}const i=xk.unmarshal(e.node.Data);r.Data=new xk({type:"directory",mode:i.mode,mtime:i.mtime}).marshal();const o=ou(eu(r));return{cid:await lI(o,t,{codec:y,cidVersion:e.cid.version,signal:n.signal}),node:r}})(s,n,r))}return jI(`removing link ${t} regular directory`),(async(e,t,n,r)=>{e.node.Links=e.node.Links.filter((e=>e.Name!==t));const s=ou(e.node),i=await lI(s,n,{...r,cidVersion:e.cid.version});return jI(`Updated regular directory ${i}`),{node:e.node,cid:i}})(e,t,n,r)}(i,t,n,{...s,cidVersion:e.version});return o.cid}const XI=Kg.bind({ignoreUndefined:!0}),ZI=Zo("helia:unixfs:stat"),eT={};async function tT(e,t,n={}){const r=XI(eT,n),s=await CI(e,n.path,t,r);ZI("stat %c",s.cid);const i=await HA(s.cid,t,r);if("file"!==i.type&&"directory"!==i.type&&"raw"!==i.type)throw new WA;let o,a,c=0n,l=0n,u=0n,h=0n,d=0;const f=i.type;let p;if("raw"===i.type&&(c=BigInt(i.node.byteLength),l=BigInt(i.node.byteLength),u=BigInt(i.node.byteLength),h=BigInt(i.node.byteLength),d=1),"directory"===i.type&&(c=0n,l=BigInt(i.unixfs.marshal().byteLength),u=0n,h=l,d=1,o=i.unixfs.mode,a=i.unixfs.mtime,p=i.unixfs),"file"===i.type){const e=await nT(s.cid,t,r);c=i.unixfs.fileSize(),l=BigInt((i.node.Data?.byteLength??0)+i.node.Links.reduce(((e,t)=>e+(t.Tsize??0)),0)),u=BigInt(e.localFileSize),h=BigInt(e.localDagSize),d=e.blocks,o=i.unixfs.mode,a=i.unixfs.mtime,p=i.unixfs}return{cid:s.cid,mode:o,mtime:a,fileSize:c,dagSize:l,localFileSize:u,localDagSize:h,blocks:d,type:f,unixfs:p}}async function nT(e,t,n){const r={localFileSize:0,localDagSize:0,blocks:0};if(await t.has(e,n)){const s=await t.get(e,n);if(r.blocks++,r.localDagSize+=s.byteLength,e.code===Ht)r.localFileSize+=s.byteLength;else{if(e.code!==iu)throw new GA(`${e.toString()} was neither DAG_PB nor RAW`);{const i=au(s);if(i.Links.length>0)for(const e of i.Links){const s=await nT(e.Hash,t,n);r.localFileSize+=s.localFileSize,r.localDagSize+=s.localDagSize,r.blocks+=s.blocks}else{if(null==i.Data)throw new jA(`PBNode ${e.toString()} had no data`);const t=xk.unmarshal(i.Data);if(null==t.data)throw new jA(`UnixFS node ${e.toString()} had no data`);r.localFileSize+=t.data.byteLength??0}}}}return r}const rT=Kg.bind({ignoreUndefined:!0}),sT=Zo("helia:unixfs:touch"),iT={recursive:!1,shardSplitThresholdBytes:BI};class oT{components;constructor(e){this.components=e}async*addAll(e,t={}){yield*async function*(e,t,n={}){yield*gA(e,t,{...mA,...n})}(e,this.components.blockstore,t)}async addBytes(e,t={}){return async function(e,t,n={}){const{cid:r}=await async function(e,t,n={}){return yA({content:e},t,n)}(e,t,{...mA,...n});return r}(e,this.components.blockstore,t)}async addByteStream(e,t={}){return async function(e,t,n={}){const{cid:r}=await async function(e,t,n={}){return yA({content:e},t,n)}(e,t,{...mA,...n});return r}(e,this.components.blockstore,t)}async addFile(e,t={}){return async function(e,t,n={}){const{cid:r}=await yA(e,t,{...mA,...n});return r}(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return async function(e,t,n={}){const{cid:r}=await async function(e,t,n={}){const r=await EE(gA([e],t,n));if(null==r)throw new Nk("Nothing imported");return r}({...e,path:e.path??"-"},t,{...mA,...n});return r}(e,this.components.blockstore,t)}async*cat(e,t={}){yield*async function*(e,t,n={}){const r=PI(LI,n),s=await CI(e,r.path,t,r),i=await HA(s.cid,t,r);if("file"!==i.type&&"raw"!==i.type)throw new XA;if(null==i.content)throw new JA;yield*i.content(r)}(e,this.components.blockstore,t)}async chmod(e,t,n={}){return async function(e,t,n,r={}){const s=OI(UI,r),i=await CI(e,s.path,n,r);if(MI("chmod %c %d",i.cid,t),s.recursive){const o=await Re((async function*(){for await(const e of KA(i.cid,n,r)){let n,r=[];if("raw"===e.type)n=new xk({type:"file",data:e.node});else{if("file"!==e.type&&"directory"!==e.type)throw new WA;n=e.unixfs,r=e.node.Links}n.mode=t;const s={Data:n.marshal(),Links:r};yield{path:e.path,content:s}}}),(t=>gA(t,n,{...s,dagBuilder:async function*(t,n){for await(const r of t)yield async function(){const t=r.content,i=ou(t),o=await lI(i,n,{...s,cidVersion:e.version});if(null==t.Data)throw new jA(`${o} had no data`);const a=xk.unmarshal(t.Data);return{cid:o,size:BigInt(i.length),path:r.path,unixfs:a}}}})),(async e=>wA(e)));if(null==o)throw new GA(`Could not chmod ${i.cid.toString()}`);return NI(o.cid,i,n,s)}const o=await n.get(i.cid,r);let a,c=[];if(i.cid.code===Ht)a=new xk({type:"file",data:o});else{const e=au(o);if(null==e.Data)throw new jA(`${i.cid.toString()} had no data`);c=e.Links,a=xk.unmarshal(e.Data)}a.mode=t;const l=ou({Data:a.marshal(),Links:c}),u=await bn.digest(l),h=Rn.create(i.cid.version,iu,u);return await n.put(h,l),NI(h,i,n,s)}(e,t,this.components.blockstore,n)}async cp(e,t,n,r={}){return async function(e,t,n,r,s={}){const i=FI(VI,s);if(n.includes("/"))throw new eI("Name must not have slashes");const[o,a]=await Promise.all([II(t,r,i),TI(e,n,r,i)]);return $I('Adding %c as "%s" to %c',e,n,t),(await _I(o,a,r,{allowOverwriting:i.force,cidVersion:t.version,...i})).cid}(e,t,n,this.components.blockstore,r)}async*ls(e,t={}){yield*async function*(e,t,n={}){const r=zI(HI,n),s=await CI(e,r.path,t,r),i=await HA(s.cid,t);if("file"!==i.type&&"raw"!==i.type){if(null==i.content)throw new JA;if("directory"!==i.type)throw new ZA;yield*i.content({offset:n.offset,length:n.length})}else yield i}(e,this.components.blockstore,t)}async mkdir(e,t,n={}){return async function(e,t,n,r={}){const s=KI(WI,r);if(t.includes("/"))throw new eI("Path must not have slashes");if("directory"!==(await HA(e,n,r)).type)throw new ZA(`${e.toString()} was not a UnixFS directory`);qI("creating %s",t);const i=ou({Data:new xk({type:"directory",mode:s.mode,mtime:s.mtime}).marshal(),Links:[]}),o=await bn.digest(i),a=Rn.create(s.cidVersion,iu,o);await n.put(a,i);const[c,l]=await Promise.all([II(e,n,s),TI(a,t,n,s)]);return qI("adding empty dir called %s to %c",t,e),(await _I(c,l,n,{...s,allowOverwriting:s.force})).cid}(e,t,this.components.blockstore,n)}async rm(e,t,n={}){return JI(e,t,this.components.blockstore,n)}async stat(e,t={}){return tT(e,this.components.blockstore,t)}async touch(e,t={}){return async function(e,t,n={}){const r=rT(iT,n),s=await CI(e,r.path,t,r),i=r.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(sT("touch %c %o",s.cid,i),r.recursive){const n=await Re((async function*(){for await(const e of KA(s.cid,t)){let t,n;if("raw"===e.type)t=new xk({data:e.node}),n=[];else{if("file"!==e.type&&"directory"!==e.type)throw new WA;t=e.unixfs,n=e.node.Links}t.mtime=i;const r={Data:t.marshal(),Links:n};yield{path:e.path,content:r}}}),(n=>gA(n,t,{...r,dagBuilder:async function*(t,n){for await(const s of t)yield async function(){const t=s.content,i=ou(t),o=await lI(i,n,{...r,cidVersion:e.version});if(null==t.Data)throw new jA(`${o} had no data`);const a=xk.unmarshal(t.Data);return{cid:o,size:BigInt(i.length),path:s.path,unixfs:a}}}})),(async e=>wA(e)));if(null==n)throw new GA(`Could not chmod ${s.cid.toString()}`);return NI(n.cid,s,t,r)}const o=await t.get(s.cid,n);let a,c=[];if(s.cid.code===Ht)a=new xk({data:o});else{const e=au(o);if(c=e.Links,null==e.Data)throw new jA(`${s.cid.toString()} had no data`);a=xk.unmarshal(e.Data)}a.mtime=i;const l=ou({Data:a.marshal(),Links:c}),u=await bn.digest(l),h=Rn.create(s.cid.version,iu,u);return await t.put(h,l),NI(h,s,t,r)}(e,this.components.blockstore,t)}}function aT(e){return new oT(e)}function cT(e){return cT="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},cT(e)}function lT(){lT=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,s=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof m?t:m,o=Object.create(i.prototype),a=new D(r||[]);return s(o,"_invoke",{value:A(e,n,a)}),o}function h(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var d="suspendedStart",f="suspendedYield",p="executing",g="completed",y={};function m(){}function w(){}function b(){}var E={};l(E,o,(function(){return this}));var v=Object.getPrototypeOf,S=v&&v(v(C([])));S&&S!==n&&r.call(S,o)&&(E=S);var _=b.prototype=m.prototype=Object.create(E);function R(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(s,i,o,a){var c=h(e[s],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==cT(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var i;s(this,"_invoke",{value:function(e,r){function s(){return new t((function(t,s){n(e,r,t,s)}))}return i=i?i.then(s,s):s()}})}function A(t,n,r){var s=d;return function(i,o){if(s===p)throw Error("Generator is already running");if(s===g){if("throw"===i)throw o;return{value:e,done:!0}}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var c=I(a,r);if(c){if(c===y)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(s===d)throw s=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);s=p;var l=h(t,n,r);if("normal"===l.type){if(s=r.done?g:f,l.arg===y)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(s=g,r.method="throw",r.arg=l.arg)}}}function I(t,n){var r=n.method,s=t.iterator[r];if(s===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,I(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var i=h(s,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,y;var o=i.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,y):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,y)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function D(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function C(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var s=-1,i=function n(){for(;++s<t.length;)if(r.call(t,s))return n.value=t[s],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(cT(t)+" is not iterable")}return w.prototype=b,s(_,"constructor",{value:b,configurable:!0}),s(b,"constructor",{value:w,configurable:!0}),w.displayName=l(b,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,l(e,c,"GeneratorFunction")),e.prototype=Object.create(_),e},t.awrap=function(e){return{__await:e}},R(k.prototype),l(k.prototype,a,(function(){return this})),t.AsyncIterator=k,t.async=function(e,n,r,s,i){void 0===i&&(i=Promise);var o=new k(u(e,n,r,s),i);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},R(_),l(_,c,"Generator"),l(_,o,(function(){return this})),l(_,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=C,D.prototype={constructor:D,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(x),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function s(r,s){return a.type="throw",a.arg=t,n.next=r,s&&(n.method="next",n.arg=e),!!s}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return s("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return s(o.catchLoc,!0);if(this.prev<o.finallyLoc)return s(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return s(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return s(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var s=this.tryEntries[n];if(s.tryLoc<=this.prev&&r.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var i=s;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),x(n),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var s=r.arg;x(n)}return s}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:C(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),y}},t}function uT(e,t,n,r,s,i,o){try{var a=e[i](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,s)}function hT(e){return function(){var t=this,n=arguments;return new Promise((function(r,s){var i=e.apply(t,n);function o(e){uT(i,r,s,o,a,"next",e)}function a(e){uT(i,r,s,o,a,"throw",e)}o(void 0)}))}}var dT,fT,pT="https://ipfs.cloud.fx.land",gT=!1,yT=function(){var e=hT(lT().mark((function e(){return lT().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,mk({});case 3:return dT=e.sent,fT=aT(dT),console.log("Helia node is running"),e.abrupt("return",dT);case 9:throw e.prev=9,e.t0=e.catch(0),console.error("Failed to create Helia node:",e.t0),e.t0;case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}();function mT(){return wT.apply(this,arguments)}function wT(){return(wT=hT(lT().mark((function e(){return lT().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(gT){e.next=11;break}return e.prev=1,e.next=4,yT();case 4:gT=!0,e.next=11;break;case 7:throw e.prev=7,e.t0=e.catch(1),console.error("Failed to initialize Helia:",e.t0),e.t0;case 11:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}function bT(e,t,n){return ET.apply(this,arguments)}function ET(){return ET=hT(lT().mark((function e(t,n,r){var s,i,o,a,c,l,u,h,d,f,p,g,y,m;return lT().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=Date.now().toString(),e.prev=1,ST(s,"started","Saving the file..."),e.next=5,fetch(t);case 5:if((i=e.sent).ok){e.next=8;break}throw new Error("HTTP error! status: ".concat(i.status));case 8:return console.log("object was fetched"),ST(s,"saved","Saved object locally"),e.next=12,i.blob();case 12:return o=e.sent,e.next=15,o.arrayBuffer();case 15:if(a=e.sent,fT){e.next=18;break}throw new Error("Helia is not initialized");case 18:return ST(s,"uploading","Uploading to Helia..."),e.next=21,fT.addBytes(new Uint8Array(a));case 21:return c=e.sent,l=c.toString(),console.log("cid created from object: "+l),u=vT(t),h=r.url||"No URL",d=(new Date).toISOString(),f="fula-".concat(h,"-").concat(d,"-").concat(u),console.log("name of file="+f),ST(s,"uploading","Uploading to server..."),(p=new FormData).append("file",o),e.next=34,fetch(pT+"/upload",{method:"POST",headers:{Authorization:"Bearer ".concat(n)},body:p});case 34:if((g=e.sent).ok){e.next=37;break}throw new Error("Server upload failed: ".concat(g.status));case 37:return e.next=39,g.json();case 39:if(y=e.sent,m=y.cid,console.log("CID received from server:",m),l===m){e.next=48;break}console.error("Received pin is different than expected"),ST(s,"error","Received pin is different than expected"),_T({type:"error",message:"Received pin is different than expected"},r.id),e.next=54;break;case 48:return ST(s,"pinning","Pinning to Fula..."),e.next=51,RT(l,n,f);case 51:ST(s,"pinned","Pinned successfully"),console.log("File successfully pinned to Fula"),_T({type:"success",message:"File uploaded and pinned. CID: ".concat(l),cid:l},r.id);case 54:e.next=61;break;case 56:e.prev=56,e.t0=e.catch(1),console.error("Failed to download and pin file:",e.t0),ST(s,"error","Error: ".concat(e.t0.message)),_T({type:"error",message:e.t0.message},r.id);case 61:case"end":return e.stop()}}),e,null,[[1,56]])}))),ET.apply(this,arguments)}function vT(e){var t=e.split("/"),n=t[t.length-1];return n=n.split("?")[0],(n=decodeURIComponent(n))||"unknown"}function ST(e,t,n){chrome.storage.local.get("pinningStatus",(function(r){var s=r.pinningStatus||{};s[e]={status:t,message:n,timestamp:Date.now()},chrome.storage.local.set({pinningStatus:s}),chrome.runtime.sendMessage({action:"pinningStatus",id:e,status:t,message:n})}))}function _T(e){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t[0]&&chrome.tabs.sendMessage(t[0].id,e,(function(e){chrome.runtime.lastError?console.log("Error sending message:",chrome.runtime.lastError):console.log("Message sent successfully")}))}))}function RT(e,t,n){return kT.apply(this,arguments)}function kT(){return(kT=hT(lT().mark((function e(t,n,r){var s,i,o,a;return lT().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Attempting to pin CID: ".concat(t," to Fula")),e.prev=1,s=r.replace(/[^a-zA-Z0-9-_\.]/g,"_").substring(0,255),e.next=5,fetch("https://api.cloud.fx.land/pins",{method:"POST",headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"},body:JSON.stringify({cid:t,name:s})});case 5:if(i=e.sent,console.log("Received response from Fula API. Status: ".concat(i.status)),i.ok){e.next=13;break}return e.next=10,i.text();case 10:throw o=e.sent,console.error("Failed to pin file. Status: ".concat(i.status,", Error: ").concat(o)),new Error("Failed to pin file: ".concat(i.status," - ").concat(o));case 13:return e.next=15,i.json();case 15:return a=e.sent,console.log("Successfully pinned file. Response:",a),e.abrupt("return",a);case 20:throw e.prev=20,e.t0=e.catch(1),console.error("Error in pinToFula function:",e.t0),e.t0;case 24:case"end":return e.stop()}}),e,null,[[1,20]])})))).apply(this,arguments)}chrome.runtime.onInstalled.addListener(hT(lT().mark((function e(){return lT().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,yT();case 3:chrome.contextMenus.create({id:"saveToFula",title:"Save to Fula",contexts:["image","video"]}),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),console.error("Failed to initialize Helia:",e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))),chrome.contextMenus.onClicked.addListener(function(){var e=hT(lT().mark((function e(t,n){var r,s;return lT().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("saveToFula"!==t.menuItemId){e.next=18;break}return e.prev=1,e.next=4,mT();case 4:return e.next=6,chrome.storage.local.get("apiKey");case 6:if(r=e.sent,s=r.apiKey){e.next=10;break}throw new Error("API key not set. Please set up your API key first.");case 10:return e.next=12,bT(t.srcUrl,s,n);case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(1),console.error("Error:",e.t0),chrome.tabs.sendMessage(n.id,{type:"error",message:e.t0.message});case 18:case"end":return e.stop()}}),e,null,[[1,14]])})));return function(t,n){return e.apply(this,arguments)}}()),chrome.runtime.onStartup.addListener((function(){gT=!1})),chrome.runtime.onSuspend.addListener((function(){gT=!1})),console.log("Background script loaded"),chrome.runtime.onMessage.addListener((function(e,t,n){if(console.log("Background script received message:",e),"initHelia"===e.action)return yT().then((function(){console.log("Helia initialized successfully"),n({success:!0})})).catch((function(e){console.error("Failed to initialize Helia:",e),n({success:!1,error:e.message})})),!0}))})()})();