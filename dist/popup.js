let currentPage=1;const itemsPerPage=10,ipfs_gateway="https://ipfs.cloud.fx.land";function showPinningProgress(e,t){showElement("pinningProgress");const n=document.getElementById("pinningStatusList"),i=document.createElement("li");i.id=`pinning-${e}`,i.textContent=t,n.appendChild(i)}function updatePinningStatus(e,t){const n=document.getElementById(`pinning-${e}`);n&&(n.textContent=t)}function removePinningStatus(e){setTimeout((()=>{const t=document.getElementById(`pinning-${e}`);t&&t.remove(),0===document.getElementById("pinningStatusList").children.length&&hideElement("pinningProgress")}),1e4)}async function saveApiKey(){const e=document.getElementById("apiKey").value.trim();if(e)try{await chrome.storage.local.set({apiKey:e}),showPinnedItems(e)}catch(e){showError("Failed to save API key: "+e.message)}else showError("Please enter a valid API key")}async function showPinnedItems(e){showLoading();try{renderPinnedItems(await fetchPinnedItems(e)),hideLoading(),showElement("pinnedItems"),hideElement("setup")}catch(e){hideLoading(),showError("Failed to fetch pinned items: "+e.message)}}async function fetchPinnedItems(e){try{const t=await fetch(`https://api.cloud.fx.land/pins?limit=${itemsPerPage}&offset=${(currentPage-1)*itemsPerPage}`,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok){if(500===t.status)throw new Error("Fula API server error. Please try again later.");throw new Error(`HTTP error! status: ${t.status}`)}return await t.json()}catch(e){throw console.error("Error fetching pinned items:",e),e}}function renderPinnedItems(e){const t=document.getElementById("pinnedList");t.innerHTML="",e.results.forEach((e=>{const n=document.createElement("li"),i=document.createElement("a");i.href=`${ipfs_gateway}/gateway/${e.pin.cid}`,i.textContent=e.pin.name||"Unnamed",i.target="_blank",i.addEventListener("click",(async t=>{t.preventDefault();try{console.log("download started");const t=await fetch(i.href),n=await t.blob();let o=e.pin.name||"file";const a=n.type;let s="";console.log("mimeType is : "+a),a.startsWith("text/")?s=".txt":"image/png"===a?s=".png":"image/jpeg"===a?s=".jpg":"image/webp"===a?s=".webp":"video/mp4"===a&&(s=".mp4"),console.log("extension is: "+s),s&&!o.toLowerCase().endsWith(s)&&(o+=s);const r=URL.createObjectURL(n),d=document.createElement("a");d.href=r,d.download=o,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(r)}catch(e){console.error("Download failed:",e)}})),n.appendChild(i),t.appendChild(n)})),updatePagination(e.count)}function updatePagination(e){const t=Math.ceil(e/itemsPerPage);document.getElementById("pageInfo").textContent=`Page ${currentPage} of ${t}`,document.getElementById("prevPage").disabled=1===currentPage,document.getElementById("nextPage").disabled=currentPage===t}async function changePage(e){currentPage+=e;const{apiKey:t}=await chrome.storage.local.get("apiKey");showPinnedItems(t)}function showSetup(){showElement("setup"),hideElement("pinnedItems")}function showLoading(){showElement("loading")}function hideLoading(){hideElement("loading")}function showError(e){document.getElementById("error").querySelector("#errorMessage").textContent=e,showElement("error")}function showElement(e){document.getElementById(e).classList.remove("hidden")}function hideElement(e){document.getElementById(e).classList.add("hidden")}chrome.runtime.onMessage.addListener(((e,t,n)=>{"pinningStatus"===e.action&&("started"===e.status?showPinningProgress(e.id,"Saving the file..."):"uploading"===e.status?updatePinningStatus(e.id,"Uploading to Helia..."):"sending"===e.status?updatePinningStatus(e.id,"Sending request to Fula..."):"pinned"===e.status&&(updatePinningStatus(e.id,"Pinned successfully"),removePinningStatus(e.id)))})),document.addEventListener("DOMContentLoaded",(async function(){try{console.log("Sending initHelia message to background script");const e=await chrome.runtime.sendMessage({action:"initHelia"});if(console.log("Received response from background script:",e),!e||!e.success)throw new Error(e?e.error:"No response from background script");console.log("Helia node is running");const{apiKey:t}=await chrome.storage.local.get("apiKey");t?showPinnedItems(t):showSetup()}catch(e){showError("Failed to initialize Helia: "+e.message)}document.getElementById("saveApiKey").addEventListener("click",saveApiKey),document.getElementById("prevPage").addEventListener("click",(()=>changePage(-1))),document.getElementById("nextPage").addEventListener("click",(()=>changePage(1))),chrome.storage.local.get("pinningStatus",(e=>{const t=e.pinningStatus||{};Object.entries(t).forEach((([e,t])=>{"pinned"!==t.status&&"error"!==t.status&&showPinningProgress(e,`${t.status}: ${t.message}`)}))}))}));