/*! For license information please see helia.min.js.LICENSE.txt */
!function(e,t){"object"==typeof module&&module.exports?module.exports=t():e.Helia=t()}("undefined"!=typeof self?self:this,(function(){"use strict";var e=(()=>{var e=Object.create,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),a=(e,r)=>{for(var n in r)t(e,n,{get:r[n],enumerable:!0})},l=(e,i,o,a)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let l of n(i))!s.call(e,l)&&l!==o&&t(e,l,{get:()=>i[l],enumerable:!(a=r(i,l))||a.enumerable});return e},c=(r,n,s)=>(s=null!=r?e(i(r)):{},l(!n&&r&&r.__esModule?s:t(s,"default",{value:r,enumerable:!0}),r)),u=o((e=>{var t=class e{static isArrayBuffer(e){return"[object ArrayBuffer]"===Object.prototype.toString.call(e)}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(t,r){let n=e.toUint8Array(t),i=e.toUint8Array(r);if(n.length!==i.byteLength)return!1;for(let e=0;e<n.length;e++)if(n[e]!==i[e])return!1;return!0}static concat(...e){let t;t=Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?e[0]:e[e.length-1]instanceof Function?e.slice(0,e.length-1):e;let r=0;for(let e of t)r+=e.byteLength;let n=new Uint8Array(r),i=0;for(let e of t){let t=this.toUint8Array(e);n.set(t,i),i+=t.length}return e[e.length-1]instanceof Function?this.toView(n,e[e.length-1]):n.buffer}},r="string",n=/^[0-9a-f]+$/i,i=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,s=/^[a-zA-Z0-9-_]+$/,o=class{static fromString(e){let t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r.buffer}static toString(e){let r=t.toUint8Array(e),n="";for(let e=0;e<r.length;e++)n+=String.fromCharCode(r[e]);return decodeURIComponent(escape(n))}},a=class{static toString(e,r=!1){let n=t.toArrayBuffer(e),i=new DataView(n),s="";for(let e=0;e<n.byteLength;e+=2){let t=i.getUint16(e,r);s+=String.fromCharCode(t)}return s}static fromString(e,t=!1){let r=new ArrayBuffer(2*e.length),n=new DataView(r);for(let r=0;r<e.length;r++)n.setUint16(2*r,e.charCodeAt(r),t);return r}},l=class e{static isHex(e){return typeof e===r&&n.test(e)}static isBase64(e){return typeof e===r&&i.test(e)}static isBase64Url(e){return typeof e===r&&s.test(e)}static ToString(e,r="utf8"){let n=t.toUint8Array(e);switch(r.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return a.toString(n,!0);case"utf16":case"utf16be":return a.toString(n);default:throw new Error(`Unknown type of encoding '${r}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return a.fromString(e,!0);case"utf16":case"utf16be":return a.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let r=t.toUint8Array(e);if(typeof btoa<"u"){let e=this.ToString(r,"binary");return btoa(e)}return Buffer.from(r).toString("base64")}static FromBase64(t){let r=this.formatString(t);if(!r)return new ArrayBuffer(0);if(!e.isBase64(r))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(r)):new Uint8Array(Buffer.from(r,"base64")).buffer}static FromBase64Url(t){let r=this.formatString(t);if(!r)return new ArrayBuffer(0);if(!e.isBase64Url(r))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(r.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(t,r=e.DEFAULT_UTF8_ENCODING){switch(r){case"ascii":return this.FromBinary(t);case"utf8":return o.fromString(t);case"utf16":case"utf16be":return a.fromString(t);case"utf16le":case"usc2":return a.fromString(t,!0);default:throw new Error(`Unknown type of encoding '${r}'`)}}static ToUtf8String(t,r=e.DEFAULT_UTF8_ENCODING){switch(r){case"ascii":return this.ToBinary(t);case"utf8":return o.toString(t);case"utf16":case"utf16be":return a.toString(t);case"utf16le":case"usc2":return a.toString(t,!0);default:throw new Error(`Unknown type of encoding '${r}'`)}}static FromBinary(e){let t=e.length,r=new Uint8Array(t);for(let n=0;n<t;n++)r[n]=e.charCodeAt(n);return r.buffer}static ToBinary(e){let r=t.toUint8Array(e),n="";for(let e=0;e<r.length;e++)n+=String.fromCharCode(r[e]);return n}static ToHex(e){let r=t.toUint8Array(e),n="",i=r.length;for(let e=0;e<i;e++){let t=r[e];t<16&&(n+="0"),n+=t.toString(16)}return n}static FromHex(t){let r=this.formatString(t);if(!r)return new ArrayBuffer(0);if(!e.isHex(r))throw new TypeError("Argument 'hexString' is not HEX encoded");r.length%2&&(r=`0${r}`);let n=new Uint8Array(r.length/2);for(let e=0;e<r.length;e+=2){let t=r.slice(e,e+2);n[e/2]=parseInt(t,16)}return n.buffer}static ToUtf16String(e,t=!1){return a.toString(e,t)}static FromUtf16String(e,t=!1){return a.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let r=0;r<t;r++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};l.DEFAULT_UTF8_ENCODING="utf8",e.BufferSourceConverter=t,e.Convert=l,e.assign=function(e,...t){let r=arguments[0];for(let e=1;e<arguments.length;e++){let t=arguments[e];for(let e in t)r[e]=t[e]}return r},e.combine=function(...e){let t=e.map((e=>e.byteLength)).reduce(((e,t)=>e+t)),r=new Uint8Array(t),n=0;return e.map((e=>new Uint8Array(e))).forEach((e=>{for(let t of e)r[n++]=t})),r.buffer},e.isEqual=function(e,t){if(!e||!t||e.byteLength!==t.byteLength)return!1;let r=new Uint8Array(e),n=new Uint8Array(t);for(let t=0;t<e.byteLength;t++)if(r[t]!==n[t])return!1;return!0}})),h=o(((e,t)=>{!function(r,n){var i={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function s(e){if(!Array.isArray(e)&&!ArrayBuffer.isView(e))return!1;for(var t=0;t<e.length;t++)if(!Number.isInteger(e[t])||e[t]<0||e[t]>255)return!1;return!0}function o(e,t){return(65535&e)*t+(((e>>>16)*t&65535)<<16)}function a(e,t){return e<<t|e>>>32-t}function l(e){return e=o(e^=e>>>16,2246822507),(e=o(e^=e>>>13,3266489909))^e>>>16}function c(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var r=[0,0,0,0];return r[3]+=e[3]+t[3],r[2]+=r[3]>>>16,r[3]&=65535,r[2]+=e[2]+t[2],r[1]+=r[2]>>>16,r[2]&=65535,r[1]+=e[1]+t[1],r[0]+=r[1]>>>16,r[1]&=65535,r[0]+=e[0]+t[0],r[0]&=65535,[r[0]<<16|r[1],r[2]<<16|r[3]]}function u(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var r=[0,0,0,0];return r[3]+=e[3]*t[3],r[2]+=r[3]>>>16,r[3]&=65535,r[2]+=e[2]*t[3],r[1]+=r[2]>>>16,r[2]&=65535,r[2]+=e[3]*t[2],r[1]+=r[2]>>>16,r[2]&=65535,r[1]+=e[1]*t[3],r[0]+=r[1]>>>16,r[1]&=65535,r[1]+=e[2]*t[2],r[0]+=r[1]>>>16,r[1]&=65535,r[1]+=e[3]*t[1],r[0]+=r[1]>>>16,r[1]&=65535,r[0]+=e[0]*t[3]+e[1]*t[2]+e[2]*t[1]+e[3]*t[0],r[0]&=65535,[r[0]<<16|r[1],r[2]<<16|r[3]]}function h(e,t){return 32==(t%=64)?[e[1],e[0]]:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t|e[0]>>>32-t]:(t-=32,[e[1]<<t|e[0]>>>32-t,e[0]<<t|e[1]>>>32-t])}function d(e,t){return 0==(t%=64)?e:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t]:[e[1]<<t-32,0]}function f(e,t){return[e[0]^t[0],e[1]^t[1]]}function p(e){return e=f(e,[0,e[0]>>>1]),e=f(e=u(e,[4283543511,3981806797]),[0,e[0]>>>1]),f(e=u(e,[3301882366,444984403]),[0,e[0]>>>1])}i.x86.hash32=function(e,t){if(i.inputValidation&&!s(e))return n;t=t||0;for(var r=e.length%4,c=e.length-r,u=t,h=0,d=3432918353,f=461845907,p=0;p<c;p+=4)h=o(h=e[p]|e[p+1]<<8|e[p+2]<<16|e[p+3]<<24,d),h=o(h=a(h,15),f),u=o(u=a(u^=h,13),5)+3864292196;switch(h=0,r){case 3:h^=e[p+2]<<16;case 2:h^=e[p+1]<<8;case 1:h=o(h^=e[p],d),u^=h=o(h=a(h,15),f)}return(u=l(u^=e.length))>>>0},i.x86.hash128=function(e,t){if(i.inputValidation&&!s(e))return n;t=t||0;for(var r=e.length%16,c=e.length-r,u=t,h=t,d=t,f=t,p=0,g=0,m=0,y=0,w=597399067,b=2869860233,E=951274213,v=2716044179,S=0;S<c;S+=16)p=e[S]|e[S+1]<<8|e[S+2]<<16|e[S+3]<<24,g=e[S+4]|e[S+5]<<8|e[S+6]<<16|e[S+7]<<24,m=e[S+8]|e[S+9]<<8|e[S+10]<<16|e[S+11]<<24,y=e[S+12]|e[S+13]<<8|e[S+14]<<16|e[S+15]<<24,p=a(p=o(p,w),15),u=a(u^=p=o(p,b),19),u=o(u+=h,5)+1444728091,g=a(g=o(g,b),16),h=a(h^=g=o(g,E),17),h=o(h+=d,5)+197830471,m=a(m=o(m,E),17),d=a(d^=m=o(m,v),15),d=o(d+=f,5)+2530024501,y=a(y=o(y,v),18),f=a(f^=y=o(y,w),13),f=o(f+=u,5)+850148119;switch(p=0,g=0,m=0,y=0,r){case 15:y^=e[S+14]<<16;case 14:y^=e[S+13]<<8;case 13:y=o(y^=e[S+12],v),f^=y=o(y=a(y,18),w);case 12:m^=e[S+11]<<24;case 11:m^=e[S+10]<<16;case 10:m^=e[S+9]<<8;case 9:m=o(m^=e[S+8],E),d^=m=o(m=a(m,17),v);case 8:g^=e[S+7]<<24;case 7:g^=e[S+6]<<16;case 6:g^=e[S+5]<<8;case 5:g=o(g^=e[S+4],b),h^=g=o(g=a(g,16),E);case 4:p^=e[S+3]<<24;case 3:p^=e[S+2]<<16;case 2:p^=e[S+1]<<8;case 1:p=o(p^=e[S],w),u^=p=o(p=a(p,15),b)}return u^=e.length,u+=h^=e.length,u+=d^=e.length,h+=u+=f^=e.length,d+=u,f+=u,u=l(u),u+=h=l(h),u+=d=l(d),h+=u+=f=l(f),d+=u,f+=u,("00000000"+(u>>>0).toString(16)).slice(-8)+("00000000"+(h>>>0).toString(16)).slice(-8)+("00000000"+(d>>>0).toString(16)).slice(-8)+("00000000"+(f>>>0).toString(16)).slice(-8)},i.x64.hash128=function(e,t){if(i.inputValidation&&!s(e))return n;t=t||0;for(var r=e.length%16,o=e.length-r,a=[0,t],l=[0,t],g=[0,0],m=[0,0],y=[2277735313,289559509],w=[1291169091,658871167],b=0;b<o;b+=16)g=[e[b+4]|e[b+5]<<8|e[b+6]<<16|e[b+7]<<24,e[b]|e[b+1]<<8|e[b+2]<<16|e[b+3]<<24],m=[e[b+12]|e[b+13]<<8|e[b+14]<<16|e[b+15]<<24,e[b+8]|e[b+9]<<8|e[b+10]<<16|e[b+11]<<24],g=h(g=u(g,y),31),a=c(a=h(a=f(a,g=u(g,w)),27),l),a=c(u(a,[0,5]),[0,1390208809]),m=h(m=u(m,w),33),l=c(l=h(l=f(l,m=u(m,y)),31),a),l=c(u(l,[0,5]),[0,944331445]);switch(g=[0,0],m=[0,0],r){case 15:m=f(m,d([0,e[b+14]],48));case 14:m=f(m,d([0,e[b+13]],40));case 13:m=f(m,d([0,e[b+12]],32));case 12:m=f(m,d([0,e[b+11]],24));case 11:m=f(m,d([0,e[b+10]],16));case 10:m=f(m,d([0,e[b+9]],8));case 9:m=u(m=f(m,[0,e[b+8]]),w),l=f(l,m=u(m=h(m,33),y));case 8:g=f(g,d([0,e[b+7]],56));case 7:g=f(g,d([0,e[b+6]],48));case 6:g=f(g,d([0,e[b+5]],40));case 5:g=f(g,d([0,e[b+4]],32));case 4:g=f(g,d([0,e[b+3]],24));case 3:g=f(g,d([0,e[b+2]],16));case 2:g=f(g,d([0,e[b+1]],8));case 1:g=u(g=f(g,[0,e[b]]),y),a=f(a,g=u(g=h(g,31),w))}return a=c(a=f(a,[0,e.length]),l=f(l,[0,e.length])),l=c(l,a),a=c(a=p(a),l=p(l)),l=c(l,a),("00000000"+(a[0]>>>0).toString(16)).slice(-8)+("00000000"+(a[1]>>>0).toString(16)).slice(-8)+("00000000"+(l[0]>>>0).toString(16)).slice(-8)+("00000000"+(l[1]>>>0).toString(16)).slice(-8)},typeof e<"u"?(typeof t<"u"&&t.exports&&(e=t.exports=i),e.murmurHash3=i):"function"==typeof define&&define.amd?define([],(function(){return i})):(i._murmurHash3=r.murmurHash3,i.noConflict=function(){return r.murmurHash3=i._murmurHash3,i._murmurHash3=n,i.noConflict=n,i},r.murmurHash3=i)}(e)})),d=o(((e,t)=>{t.exports=h()})),f=o(((e,t)=>{var r=Object.prototype.hasOwnProperty,n="~";function i(){}function s(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function o(e,t,r,i,o){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new s(r,i||e,o),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],a]:e._events[l].push(a):(e._events[l]=a,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new i:delete e._events[t]}function l(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),l.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(n?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},l.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,s=r.length,o=new Array(s);i<s;i++)o[i]=r[i].fn;return o},l.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},l.prototype.emit=function(e,t,r,i,s,o){var a=n?n+e:e;if(!this._events[a])return!1;var l,c,u=this._events[a],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,i),!0;case 5:return u.fn.call(u.context,t,r,i,s),!0;case 6:return u.fn.call(u.context,t,r,i,s,o),!0}for(c=1,l=new Array(h-1);c<h;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var d,f=u.length;for(c=0;c<f;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),h){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,i);break;default:if(!l)for(d=1,l=new Array(h-1);d<h;d++)l[d-1]=arguments[d];u[c].fn.apply(u[c].context,l)}}return!0},l.prototype.on=function(e,t,r){return o(this,e,t,r,!1)},l.prototype.once=function(e,t,r){return o(this,e,t,r,!0)},l.prototype.removeListener=function(e,t,r,i){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var o=this._events[s];if(o.fn)o.fn===t&&(!i||o.once)&&(!r||o.context===r)&&a(this,s);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||i&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[s]=1===c.length?c[0]:c:a(this,s)}return this},l.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new i,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=n,l.EventEmitter=l,typeof t<"u"&&(t.exports=l)})),p=o(((e,t)=>{t.exports=function(e){if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,r=Object.create(null),n=Object.create(null);function i(i,s){r[i]=s,++t>=e&&(t=0,n=r,r=Object.create(null))}return{has:function(e){return void 0!==r[e]||void 0!==n[e]},remove:function(e){void 0!==r[e]&&(r[e]=void 0),void 0!==n[e]&&(n[e]=void 0)},get:function(e){var t=r[e];return void 0!==t?t:void 0!==(t=n[e])?(i(e,t),t):void 0},set:function(e,t){void 0!==r[e]?r[e]=t:i(e,t)},clear:function(){r=Object.create(null),n=Object.create(null)}}}})),g=o(((e,t)=>{function r(e,t){for(let r in t)Object.defineProperty(e,r,{value:t[r],enumerable:!0,configurable:!0});return e}t.exports=function(e,t,n){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");n||(n={}),"object"==typeof t&&(n=t,t=""),t&&(n.code=t);try{return r(e,n)}catch{n.message=e.message,n.stack=e.stack;let t=function(){};return t.prototype=Object.create(Object.getPrototypeOf(e)),r(new t,n)}}})),m=o((e=>{(function(){var t,r,n,i,s,o,a,l;l=function(e){return[(e&255<<24)>>>24,(e&255<<16)>>>16,(65280&e)>>>8,255&e].join(".")},a=function(e){var t,n,i,s,o,a;for(t=[],i=s=0;s<=3&&0!==e.length;i=++s){if(i>0){if("."!==e[0])throw new Error("Invalid IP");e=e.substring(1)}o=(a=r(e))[0],n=a[1],e=e.substring(n),t.push(o)}if(0!==e.length)throw new Error("Invalid IP");switch(t.length){case 1:if(t[0]>4294967295)throw new Error("Invalid IP");return t[0]>>>0;case 2:if(t[0]>255||t[1]>16777215)throw new Error("Invalid IP");return(t[0]<<24|t[1])>>>0;case 3:if(t[0]>255||t[1]>255||t[2]>65535)throw new Error("Invalid IP");return(t[0]<<24|t[1]<<16|t[2])>>>0;case 4:if(t[0]>255||t[1]>255||t[2]>255||t[3]>255)throw new Error("Invalid IP");return(t[0]<<24|t[1]<<16|t[2]<<8|t[3])>>>0;default:throw new Error("Invalid IP")}},i=(n=function(e){return e.charCodeAt(0)})("0"),o=n("a"),s=n("A"),r=function(e){var t,r,a,l,c;for(l=0,t=10,r="9",a=0,e.length>1&&"0"===e[a]&&("x"===e[a+1]||"X"===e[a+1]?(a+=2,t=16):"0"<=e[a+1]&&e[a+1]<="9"&&(a++,t=8,r="7")),c=a;a<e.length;){if("0"<=e[a]&&e[a]<=r)l=l*t+(n(e[a])-i)>>>0;else{if(16!==t)break;if("a"<=e[a]&&e[a]<="f")l=l*t+(10+n(e[a])-o)>>>0;else{if(!("A"<=e[a]&&e[a]<="F"))break;l=l*t+(10+n(e[a])-s)>>>0}}if(l>4294967295)throw new Error("too large");a++}if(a===c)throw new Error("empty octet");return[l,a]},t=function(){function e(e,t){var r,n,i;if("string"!=typeof e)throw new Error("Missing `net' parameter");if(t||(i=e.split("/",2),e=i[0],t=i[1]),t||(t=32),"string"==typeof t&&t.indexOf(".")>-1){try{this.maskLong=a(t)}catch(e){throw new Error("Invalid mask: "+t)}for(r=n=32;n>=0;r=--n)if(this.maskLong===4294967295<<32-r>>>0){this.bitmask=r;break}}else{if(!t&&0!==t)throw new Error("Invalid mask: empty");this.bitmask=parseInt(t,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0)}try{this.netLong=(a(e)&this.maskLong)>>>0}catch(t){throw new Error("Invalid net address: "+e)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+t);this.size=Math.pow(2,32-this.bitmask),this.base=l(this.netLong),this.mask=l(this.maskLong),this.hostmask=l(~this.maskLong),this.first=this.bitmask<=30?l(this.netLong+1):this.base,this.last=this.bitmask<=30?l(this.netLong+this.size-2):l(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?l(this.netLong+this.size-1):void 0}return e.prototype.contains=function(t){return"string"==typeof t&&(t.indexOf("/")>0||4!==t.split(".").length)&&(t=new e(t)),t instanceof e?this.contains(t.base)&&this.contains(t.broadcast||t.last):(a(t)&this.maskLong)>>>0==(this.netLong&this.maskLong)>>>0},e.prototype.next=function(t){return null==t&&(t=1),new e(l(this.netLong+this.size*t),this.mask)},e.prototype.forEach=function(e){var t,r,n;for(n=a(this.first),r=a(this.last),t=0;n<=r;)e(l(n),n,t),t++,n++},e.prototype.toString=function(){return this.base+"/"+this.bitmask},e}(),e.ip2long=a,e.long2ip=l,e.Netmask=t}).call(e)})),y=o(((e,t)=>{!function(){typeof t<"u"&&(t.exports=m);var e=86400,r=3200,n=146097*r/400,i=e*n,s=1e3*i,o=864e13,a=4294967296,l=1e6,c="000000000",u=Math.trunc||function(e){var t=e-e%1;return 0==t&&(e<0||0===e&&1/e!=1/0)?-0:t},h=m.prototype,d=(m.fromDate=function(e){return new m(+e)},m.fromInt64BE=v(0,1,2,3,0,4),m.fromInt64LE=v(3,2,1,0,4,0),m.fromString=function(e){var t,r=new m;if(1<(e=(e+="").replace(/^\s*[+\-]?\d+/,(function(e){var t=1970+((e=+e)-1970)%400;return r.year=e-t,t})).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,(function(e,r,n){return r<0&&(n*=-1),t=6e4*(60*+r+ +n),""})).replace(/\.\d+$/,(function(e){return r.nano=+(e+c).substr(1,9),""})).split(/\D+/)).length?e[1]--:e[1]=0,r.time=t=Date.UTC.apply(Date,e)-(t||0),isNaN(t))throw new TypeError("Invalid Date");return y(r)},m.fromTimeT=function(e){return b(e,0)},h.year=0,h.time=0,h.nano=0,h.addNano=function(e){return this.nano+=+e||0,this},h.getNano=function(){var e=y(this);return(e.time%1e3*l+ +e.nano+1e9)%1e9},h.getTimeT=function(){var t=y(this),i=Math.floor(t.time/1e3);return(t=t.year)&&(i+=t*n*e/r),i},h.getYear=function(){return this.toDate().getUTCFullYear()+this.year},h.toDate=function(){return w(y(this).time)},h.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},h.toString=function(e){var t=this,r=t.toDate(),n={H:function(){return R(r.getUTCHours())},L:function(){return A(r.getUTCMilliseconds(),3)},M:function(){return R(r.getUTCMinutes())},N:function(){return A(t.getNano(),9)},S:function(){return R(r.getUTCSeconds())},Y:function(){var e=t.getYear();return 999999<e?"+"+e:9999<e?"+"+A(e,6):0<=e?A(e,4):-999999<=e?"-"+A(-e,6):e},a:function(){return p[r.getUTCDay()]},b:function(){return f[r.getUTCMonth()]},d:function(){return R(r.getUTCDate())},e:function(){return(9<(e=r.getUTCDate())?"":" ")+(0|e);var e},m:function(){return R(r.getUTCMonth()+1)}};return function e(t){return t.replace(/%./g,(function(t){var r=t[1],i=g[r];return r=n[r],i?e(i):r?r():t}))}(e||d)},h.writeInt64BE=E(0,1,2,3,0,4),h.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:"\n",R:"%H:%M",T:"%H:%M:%S",t:"\t",X:"%T",Z:"GMT",z:"+0000"};return m;function m(e,t,r){var n=this;if(!(n instanceof m))return new m(e,t,r);n.time=+e||0,n.nano=+t||0,n.year=+r||0,y(n)}function y(e){var t,n,i,a=e.year,c=e.time,h=e.nano,d=((h<0||l<=h)&&(h-=(n=Math.floor(h/l))*l,c+=n,n=1),a%r);return(c<-o||o<c||d)&&((t=u(c/s))&&(a+=t*r,c-=t*s),(i=w(c)).setUTCFullYear(d+i.getUTCFullYear()),i=(c=+i)+(t=u((a-=d)/r))*s,t&&-o<=i&&i<=o&&(a-=t*r,c=i),n=1),n&&(e.year=a,e.time=c,e.nano=h),e}function w(e){var t=new Date(0);return t.setTime(e),t}function b(e,t){e=+e||0;var n=u((t=(0|t)*a)/i)+u(e/i);return(e=u((t=t%i+e%i)/i))&&(n+=e,t-=e*i),new m(1e3*t,0,n*r)}function E(t,i,s,o,l,c){return function(t,i){var s=y(this);S(t=t||new Array(8),i|=0);var o=Math.floor(s.time/1e3),d=(s=s.year*(n*e/r),u(s/a)+u(o/a));return s=s%a+o%a,(o=Math.floor(s/a))&&(d+=o,s-=o*a),h(t,i+l,d),h(t,i+c,s),t};function h(e,r,n){e[r+t]=n>>24&255,e[r+i]=n>>16&255,e[r+s]=n>>8&255,e[r+o]=255&n}}function v(e,t,r,n,i,s){return function(e,t){S(e,t|=0);var r=o(e,t+i);return b(o(e,t+s),r)};function o(i,s){return 16777216*i[s+e]+(i[s+t]<<16|i[s+r]<<8|i[s+n])}}function S(e,t){if(null==(e=e&&e.length))throw new TypeError("Invalid Buffer");if(e<t+8)throw new RangeError("Out of range")}function R(e){return(9<e?"":"0")+(0|e)}function A(e,t){return(c+(0|e)).substr(-t)}}()})),w=o(((e,t)=>{t.exports=function(){return!!(typeof window<"u"&&"object"==typeof window.process&&"renderer"===window.process.type||typeof process<"u"&&"object"==typeof process.versions&&process.versions.electron||"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0)}})),b=o(((e,t)=>{t.exports=e=>{if("[object Object]"!==Object.prototype.toString.call(e))return!1;let t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}})),E=o(((e,t)=>{var r=b(),{hasOwnProperty:n}=Object.prototype,{propertyIsEnumerable:i}=Object,s=(e,t,r)=>Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0}),o=e,a={concatArrays:!1,ignoreUndefined:!1},l=e=>{let t=[];for(let r in e)n.call(e,r)&&t.push(r);if(Object.getOwnPropertySymbols){let r=Object.getOwnPropertySymbols(e);for(let n of r)i.call(e,n)&&t.push(n)}return t};function c(e){return Array.isArray(e)?function(e){let t=e.slice(0,0);return l(e).forEach((r=>{s(t,r,c(e[r]))})),t}(e):r(e)?function(e){let t=null===Object.getPrototypeOf(e)?Object.create(null):{};return l(e).forEach((r=>{s(t,r,c(e[r]))})),t}(e):e}var u=(e,t,r,n)=>(r.forEach((r=>{typeof t[r]>"u"&&n.ignoreUndefined||(r in e&&e[r]!==Object.getPrototypeOf(e)?s(e,r,d(e[r],t[r],n)):s(e,r,c(t[r])))})),e),h=(e,t,r)=>{let i=e.slice(0,0),o=0;return[e,t].forEach((t=>{let a=[];for(let r=0;r<t.length;r++)n.call(t,r)&&(a.push(String(r)),s(i,o++,t===e?t[r]:c(t[r])));i=u(i,t,l(t).filter((e=>!a.includes(e))),r)})),i};function d(e,t,n){return n.concatArrays&&Array.isArray(e)&&Array.isArray(t)?h(e,t,n):r(t)&&r(e)?u(e,t,l(t),n):c(t)}t.exports=function(...e){let t=d(c(a),this!==o&&this||{},a),n={_:{}};for(let i of e)if(void 0!==i){if(!r(i))throw new TypeError("`"+i+"` is not an Option Object");n=d(n,{_:i},t)}return n._}})),v=o(((e,t)=>{function r(e){return e>=56320&&e<=57343}t.exports=function(e,t,n){if("string"!=typeof t)throw new Error("Input must be string");for(var i,s,o=t.length,a=0,l=0;l<o;l+=1){if(i=t.charCodeAt(l),s=t[l],(c=i)>=55296&&c<=56319&&r(t.charCodeAt(l+1))&&(s+=t[l+=1]),(a+=e(s))===n)return t.slice(0,l+1);if(a>n)return t.slice(0,l-s.length+1)}var c;return t}})),S=o(((e,t)=>{function r(e){return e>=55296&&e<=56319}t.exports=function(e){if("string"!=typeof e)throw new Error("Input must be string");for(var t=e.length,n=0,i=null,s=null,o=0;o<t;o++)(a=i=e.charCodeAt(o))>=56320&&a<=57343?null!=s&&r(s)?n+=1:n+=3:i<=127?n+=1:i>=128&&i<=2047?n+=2:i>=2048&&i<=65535&&(n+=3),s=i;var a;return n}})),R=o(((e,t)=>{var r=v(),n=S();t.exports=r.bind(null,n)})),A=o(((e,t)=>{var r=R(),n=/[\/\?<>\\:\*\|"]/g,i=/[\x00-\x1f\x80-\x9f]/g,s=/^\.+$/,o=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,a=/[\. ]+$/;function l(e,t){if("string"!=typeof e)throw new Error("Input must be string");var l=e.replace(n,t).replace(i,t).replace(s,t).replace(o,t).replace(a,t);return r(l,255)}t.exports=function(e,t){var r=t&&t.replacement||"",n=l(e,r);return""===r?n:l(n,"")}})),_=o((e=>{Object.defineProperty(e,"__esModule",{value:!0});var t=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let e=this.pullQueue.shift();e&&e.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),void 0!==this.highWaterMark&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch((()=>{})),this.pushQueue.push(t)}}remove(){Promise.resolve().then((()=>{this.removeCallback&&this.removeCallback()}))}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(void 0!==this.lowWaterMark&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise(((e,t)=>{this.pullQueue.push({resolve:e,reject:t})}))},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},r=class{constructor(e,{highWaterMark:r=100,lowWaterMark:n=1}={}){let i=new t;i.highWaterMark=r,i.lowWaterMark=n,i.removeCallback=e({push:e=>i.push(e),stop:()=>i.stop(),fail:e=>i.fail(e),on:(e,t)=>{i.eventHandlers[e]=t}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};e.EventIterator=r,e.default=r})),I=o((e=>{Object.defineProperty(e,"__esModule",{value:!0});var t=_();e.EventIterator=t.EventIterator,e.subscribe=function(e,r,n){return new t.EventIterator((({push:t})=>(this.addEventListener(e,t,r),()=>this.removeEventListener(e,t,r))),n)},e.default=t.EventIterator})),k={};a(k,{DEFAULT_SESSION_MAX_PROVIDERS:()=>qf,DEFAULT_SESSION_MIN_PROVIDERS:()=>Hf,createHelia:()=>R_,libp2pDefaults:()=>QR});var T=Symbol.for("@libp2p/connection"),C=Symbol.for("@libp2p/content-routing"),D=Symbol.for("@libp2p/peer-discovery"),x=Symbol.for("@libp2p/peer-id");function N(e){return null!=e&&!!e[x]}var P,L,O=Symbol.for("@libp2p/peer-routing"),B=Symbol.for("@libp2p/transport");(L=P||(P={}))[L.FATAL_ALL=0]="FATAL_ALL",L[L.NO_FATAL=1]="NO_FATAL";var M=class e extends Error{code;type;constructor(t="The operation was aborted"){super(t),this.name="AbortError",this.code=e.code,this.type=e.type}static code="ABORT_ERR";static type="aborted"},U=class extends Error{code;props;constructor(e,t,r){super(e),this.code=t,this.name=r?.name??"CodeError",this.props=r??{}}},F=class extends AggregateError{code;props;constructor(e,t,r,n){super(e,t),this.code=r,this.name=n?.name??"AggregateCodeError",this.props=n??{}}},$="ERR_TIMEOUT",V="ERR_INVALID_MESSAGE",K=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return null==t?0:t.length}addEventListener(e,t,r){super.addEventListener(e,t,r);let n=this.#e.get(e);null==n&&(n=[],this.#e.set(e,n)),n.push({callback:t,once:(!0!==r&&!1!==r&&r?.once)??!1})}removeEventListener(e,t,r){super.removeEventListener(e.toString(),t??null,r);let n=this.#e.get(e);null!=n&&(n=n.filter((({callback:e})=>e!==t)),this.#e.set(e,n))}dispatchEvent(e){let t=super.dispatchEvent(e),r=this.#e.get(e.type);return null==r||(r=r.filter((({once:e})=>!e)),this.#e.set(e.type,r)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new H(e,t))}},H=globalThis.CustomEvent;function q(e){return null!=e&&"function"==typeof e.start&&"function"==typeof e.stop}async function z(...e){let t=[];for(let r of e)q(r)&&t.push(r);await Promise.all(t.map((async e=>{null!=e.beforeStart&&await e.beforeStart()}))),await Promise.all(t.map((async e=>{await e.start()}))),await Promise.all(t.map((async e=>{null!=e.afterStart&&await e.afterStart()})))}async function W(...e){let t=[];for(let r of e)q(r)&&t.push(r);await Promise.all(t.map((async e=>{null!=e.beforeStop&&await e.beforeStop()}))),await Promise.all(t.map((async e=>{await e.stop()}))),await Promise.all(t.map((async e=>{null!=e.afterStop&&await e.afterStop()})))}var j=Symbol.for("@libp2p/service-capabilities"),G=Symbol.for("@libp2p/service-dependencies");function Y(e){let t=new globalThis.AbortController;function r(){t.abort();for(let t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",r)}for(let t of e){if(!0===t?.aborted){r();break}null!=t?.addEventListener&&t.addEventListener("abort",r)}let n=t.signal;return n.clear=function(){for(let t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",r)},n}function Q(){let e={};return e.promise=new Promise(((t,r)=>{e.resolve=t,e.reject=r})),e}var J=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}},Z=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new J(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new J(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}},X=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ee(e={}){return function(e,t){let r,n,i,s=(t=t??{}).onEnd,o=new Z,a=Q(),l=e=>null!=n?n(e):(o.push(e),r),c=e=>{if(i)return r;if(!0!==t?.objectMode&&null==e?.byteLength)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},u=e=>i?r:(i=!0,null!=e?(e=>(o=new Z,null!=n?n({error:e}):(o.push({error:e}),r)))(e):l({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:async()=>{try{return o.isEmpty()?i?{done:!0}:await new Promise(((t,i)=>{n=s=>{n=null,o.push(s);try{t(e(o))}catch(e){i(e)}return r}})):e(o)}finally{o.isEmpty()&&queueMicrotask((()=>{a.resolve(),a=Q()}))}},return:()=>(o=new Z,u(),{done:!0}),throw:e=>(u(e),{done:!0}),push:c,end:u,get readableLength(){return o.size},onEmpty:async e=>{let t,r,n=e?.signal;if(n?.throwIfAborted(),!o.isEmpty()){null!=n&&(t=new Promise(((e,t)=>{r=()=>{t(new X)},n.addEventListener("abort",r)})));try{await Promise.race([a.promise,t])}finally{null!=r&&null!=n&&n?.removeEventListener("abort",r)}}}},null==s)return r;let h=r;return r={[Symbol.asyncIterator](){return this},next:()=>h.next(),throw:e=>(h.throw(e),null!=s&&(s(e),s=void 0),{done:!0}),return:()=>(h.return(),null!=s&&(s(),s=void 0),{done:!0}),push:c,end:e=>(h.end(e),null!=s&&(s(e),s=void 0),r),get readableLength(){return h.readableLength},onEmpty:e=>h.onEmpty(e)},r}((e=>{let t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),e)}var te=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function re(e,t,r,n){let i=new te(n?.errorMessage,n?.errorCode);return!0===r?.aborted?Promise.reject(i):new Promise(((s,o)=>{function a(){r?.removeEventListener("abort",u),e.removeEventListener(t,l),null!=n?.errorEvent&&e.removeEventListener(n.errorEvent,c)}let l=e=>{try{if(!1===n?.filter?.(e))return}catch(e){return a(),void o(e)}a(),s(e)},c=e=>{a(),o(e.detail)},u=()=>{a(),o(i)};r?.addEventListener("abort",u),e.addEventListener(t,l),null!=n?.errorEvent&&e.addEventListener(n.errorEvent,c)}))}var ne=class extends Error{type;code;constructor(e,t,r){super(e??"The operation was aborted"),this.type="aborted",this.name=r??"AbortError",this.code=t??"ABORT_ERR"}};async function ie(e,t,r){if(null==t)return e;if(t.aborted)return Promise.reject(new ne(r?.errorMessage,r?.errorCode,r?.errorName));let n,i=new ne(r?.errorMessage,r?.errorCode,r?.errorName);try{return await Promise.race([e,new Promise(((e,r)=>{n=()=>{r(i)},t.addEventListener("abort",n)}))])}finally{null!=n&&t.removeEventListener("abort",n)}}var se=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Q(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new M)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}},oe=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce(((e,t)=>e&&!0===t.signal?.aborted),!0)&&(this.controller.abort(new M),this.cleanup())}async join(e={}){let t=new se(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await ie(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach((t=>{t.deferred.resolve(e)})),this.status="complete"}catch(e){this.recipients.forEach((t=>{t.deferred.reject(e)})),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach((e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)}))}},ae=class extends K{concurrency;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.pending=0,null!=e.metricName&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(0===this.size)return queueMicrotask((()=>{this.safeDispatchEvent("empty")})),0===this.running&&queueMicrotask((()=>{this.safeDispatchEvent("idle")})),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally((()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")})),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}async add(e,t){t?.signal?.throwIfAborted();let r=new oe(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.tryToStartAnother(),r.join(t).then((e=>(this.safeDispatchEvent("completed",{detail:e}),this.safeDispatchEvent("success",{detail:{job:r,result:e}}),e))).catch((e=>{if("queued"===r.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===r){this.queue.splice(e,1);break}throw this.safeDispatchEvent("error",{detail:e}),this.safeDispatchEvent("failure",{detail:{job:r,error:e}}),e}))}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach((e=>{e.abort(new M)})),this.clear()}async onEmpty(e){0!==this.size&&await re(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await re(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await re(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=ee({objectMode:!0}),r=e=>{null!=e?this.abort():this.clear(),t.end(e)},n=e=>{null!=e.detail&&t.push(e.detail)},i=e=>{r(e.detail)},s=()=>{r()},o=()=>{r(new U("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",n),this.addEventListener("error",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("completed",n),this.removeEventListener("error",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",o),r()}}},le=class extends ae{has(e){return null!=this.find(e)}find(e){return this.queue.find((t=>e.equals(t.options.peerId)))}},ce=function(e){if(function(e){return null!=e[Symbol.asyncIterator]}(e))return(async()=>{for await(let t of e);})();for(let t of e);};function ue(e=0){return new Uint8Array(e)}function he(e=0){return new Uint8Array(e)}var de=Math.pow(2,7),fe=Math.pow(2,14),pe=Math.pow(2,21),ge=Math.pow(2,28),me=Math.pow(2,35),ye=Math.pow(2,42),we=Math.pow(2,49),be=128,Ee=127;function ve(e){if(e<de)return 1;if(e<fe)return 2;if(e<pe)return 3;if(e<ge)return 4;if(e<me)return 5;if(e<ye)return 6;if(e<we)return 7;if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Se(e,t,r=0){switch(ve(e)){case 8:t[r++]=255&e|be,e/=128;case 7:t[r++]=255&e|be,e/=128;case 6:t[r++]=255&e|be,e/=128;case 5:t[r++]=255&e|be,e/=128;case 4:t[r++]=255&e|be,e>>>=7;case 3:t[r++]=255&e|be,e>>>=7;case 2:t[r++]=255&e|be,e>>>=7;case 1:t[r++]=255&e,e>>>=7;break;default:throw new Error("unreachable")}return t}function Re(e,t){let r=e[t],n=0;if(n+=r&Ee,r<be||(r=e[t+1],n+=(r&Ee)<<7,r<be)||(r=e[t+2],n+=(r&Ee)<<14,r<be)||(r=e[t+3],n+=(r&Ee)<<21,r<be)||(r=e[t+4],n+=(r&Ee)*ge,r<be)||(r=e[t+5],n+=(r&Ee)*me,r<be)||(r=e[t+6],n+=(r&Ee)*ye,r<be)||(r=e[t+7],n+=(r&Ee)*we,r<be))return n;throw new RangeError("Could not decode varint")}function Ae(e,t,r=0){return null==t&&(t=he(ve(e))),t instanceof Uint8Array?Se(e,t,r):function(e,t,r=0){switch(ve(e)){case 8:t.set(r++,255&e|be),e/=128;case 7:t.set(r++,255&e|be),e/=128;case 6:t.set(r++,255&e|be),e/=128;case 5:t.set(r++,255&e|be),e/=128;case 4:t.set(r++,255&e|be),e>>>=7;case 3:t.set(r++,255&e|be),e>>>=7;case 2:t.set(r++,255&e|be),e>>>=7;case 1:t.set(r++,255&e),e>>>=7;break;default:throw new Error("unreachable")}return t}(e,t,r)}function _e(e,t=0){return e instanceof Uint8Array?Re(e,t):function(e,t){let r=e.get(t),n=0;if(n+=r&Ee,r<be||(r=e.get(t+1),n+=(r&Ee)<<7,r<be)||(r=e.get(t+2),n+=(r&Ee)<<14,r<be)||(r=e.get(t+3),n+=(r&Ee)<<21,r<be)||(r=e.get(t+4),n+=(r&Ee)*ge,r<be)||(r=e.get(t+5),n+=(r&Ee)*me,r<be)||(r=e.get(t+6),n+=(r&Ee)*ye,r<be)||(r=e.get(t+7),n+=(r&Ee)*we,r<be))return n;throw new RangeError("Could not decode varint")}(e,t)}function Ie(e,t){null==t&&(t=e.reduce(((e,t)=>e+t.length),0));let r=he(t),n=0;for(let t of e)r.set(t,n),n+=t.length;return r}function ke(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}var Te=Symbol.for("@achingbrain/uint8arraylist");function Ce(e,t){if(null==t||t<0)throw new RangeError("index is out of bounds");let r=0;for(let n of e){let e=r+n.byteLength;if(t<e)return{buf:n,index:t-r};r=e}throw new RangeError("index is out of bounds")}function De(e){return!!e?.[Te]}var xe=class e{bufs;length;[Te]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let r of e)if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.push(r);else{if(!De(r))throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");t+=r.byteLength,this.bufs.push(...r.bufs)}this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let r of e.reverse())if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.unshift(r);else{if(!De(r))throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");t+=r.byteLength,this.bufs.unshift(...r.bufs)}this.length+=t}get(e){let t=Ce(this.bufs,e);return t.buf[t.index]}set(e,t){let r=Ce(this.bufs,e);r.buf[r.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let r=0;r<e.length;r++)this.set(t+r,e[r]);else{if(!De(e))throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList");for(let r=0;r<e.length;r++)this.set(t+r,e.get(r))}}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength)return this.bufs=[],void(this.length=0);for(;this.bufs.length>0;){if(!(e>=this.bufs[0].byteLength)){this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift()}}}slice(e,t){let{bufs:r,length:n}=this._subList(e,t);return Ie(r,n)}subarray(e,t){let{bufs:r,length:n}=this._subList(e,t);return 1===r.length?r[0]:Ie(r,n)}sublist(t,r){let{bufs:n,length:i}=this._subList(t,r),s=new e;return s.length=i,s.bufs=[...n],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(0===e&&t===this.length)return{bufs:this.bufs,length:this.length};let r=[],n=0;for(let i=0;i<this.bufs.length;i++){let s=this.bufs[i],o=n,a=o+s.byteLength;if(n=a,e>=a)continue;let l=e>=o&&e<a,c=t>o&&t<=a;if(l&&c){if(e===o&&t===a){r.push(s);break}let n=e-o;r.push(s.subarray(n,n+(t-e)));break}if(l){if(0===e){r.push(s);continue}r.push(s.subarray(e-o))}else{if(c){if(t===a){r.push(s);break}r.push(s.subarray(0,t-o));break}r.push(s)}}return{bufs:r,length:t-e}}indexOf(e,t=0){if(!(De(e)||e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let r=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;let n=r.byteLength;if(0===n)throw new TypeError("search must be at least 1 byte long");let i=new Int32Array(256);for(let e=0;e<256;e++)i[e]=-1;for(let e=0;e<n;e++)i[r[e]]=e;let s,o=i,a=this.byteLength-r.byteLength,l=r.byteLength-1;for(let e=t;e<=a;e+=s){s=0;for(let t=l;t>=0;t--){let n=this.get(e+t);if(r[t]!==n){s=Math.max(1,t-o[n]);break}}if(0===s)return e}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let r=he(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,t),this.write(r,e)}getInt16(e,t){let r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,t)}setInt16(e,t,r){let n=ue(2);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt16(0,t,r),this.write(n,e)}getInt32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,t)}setInt32(e,t,r){let n=ue(4);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt32(0,t,r),this.write(n,e)}getBigInt64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,t)}setBigInt64(e,t,r){let n=ue(8);new DataView(n.buffer,n.byteOffset,n.byteLength).setBigInt64(0,t,r),this.write(n,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let r=he(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,t),this.write(r,e)}getUint16(e,t){let r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,t)}setUint16(e,t,r){let n=ue(2);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint16(0,t,r),this.write(n,e)}getUint32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,t)}setUint32(e,t,r){let n=ue(4);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint32(0,t,r),this.write(n,e)}getBigUint64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,t)}setBigUint64(e,t,r){let n=ue(8);new DataView(n.buffer,n.byteOffset,n.byteLength).setBigUint64(0,t,r),this.write(n,e)}getFloat32(e,t){let r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,t)}setFloat32(e,t,r){let n=ue(4);new DataView(n.buffer,n.byteOffset,n.byteLength).setFloat32(0,t,r),this.write(n,e)}getFloat64(e,t){let r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,t)}setFloat64(e,t,r){let n=ue(8);new DataView(n.buffer,n.byteOffset,n.byteLength).setFloat64(0,t,r),this.write(n,e)}equals(t){if(null==t||!(t instanceof e)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!ke(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,r){let n=new e;return n.bufs=t,null==r&&(r=t.reduce(((e,t)=>e+t.byteLength),0)),n.length=r,n}};function Ne(e){return null!=e[Symbol.asyncIterator]}var Pe=e=>{let t=ve(e),r=he(t);return Ae(e,r),Pe.bytes=t,r};function Le(e,t){let r=(t=t??{}).lengthEncoder??Pe;function*n(e){let t=r(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return Ne(e)?async function*(){for await(let t of e)yield*n(t)}():function*(){for(let t of e)yield*n(t)}()}Pe.bytes=0,Le.single=(e,t)=>{let r=(t=t??{}).lengthEncoder??Pe;return new xe(r(e.byteLength),e)};var Oe,Be=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Me=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Ue=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Fe=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(Oe||(Oe={}));var $e=e=>{let t=_e(e);return $e.bytes=ve(t),t};function Ve(e,t){let r=new xe,n=Oe.LENGTH,i=-1,s=t?.lengthDecoder??$e,o=t?.maxLengthLength??8,a=t?.maxDataLength??4194304;function*l(){for(;r.byteLength>0;){if(n===Oe.LENGTH)try{if(i=s(r),i<0)throw new Be("Invalid message length");if(i>a)throw new Me("Message length too long");let e=s.bytes;r.consume(e),null!=t?.onLength&&t.onLength(i),n=Oe.DATA}catch(e){if(e instanceof RangeError){if(r.byteLength>o)throw new Ue("Message length length too long");break}throw e}if(n===Oe.DATA){if(r.byteLength<i)break;let e=r.sublist(0,i);r.consume(i),null!=t?.onData&&t.onData(e),yield e,n=Oe.LENGTH}}}return Ne(e)?async function*(){for await(let t of e)r.append(t),yield*l();if(r.byteLength>0)throw new Fe("Unexpected end of input")}():function*(){for(let t of e)r.append(t),yield*l();if(r.byteLength>0)throw new Fe("Unexpected end of input")}()}$e.bytes=0,Ve.fromReader=(e,t)=>{let r=1;return Ve(async function*(){for(;;)try{let{done:t,value:n}=await e.next(r);if(!0===t)return;null!=n&&(yield n)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{r=1}}(),{...t??{},onLength:e=>{r=e}})};var Ke=function(e){let[t,r]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>t.next(),push:e=>{n.push(e)},next:()=>n.length>0?{done:!1,value:n.shift()}:t.next(),[r](){return this}}},He=function(e,t){let r=0;if(function(e){return null!=e[Symbol.asyncIterator]}(e))return async function*(){for await(let n of e)yield t(n,r++)}();let n=Ke(e),{value:i,done:s}=n.next();if(!0===s)return function*(){}();let o=t(i,r++);if("function"==typeof o.then)return async function*(){yield await o;for await(let e of n)yield t(e,r++)}();let a=t;return function*(){yield o;for(let e of n)yield a(e,r++)}()};function qe(e){return null!=e[Symbol.asyncIterator]}var ze=function(...e){let t=[];for(let r of e)qe(r)||t.push(r);return t.length===e.length?function*(){for(let e of t)yield*e}():async function*(){let t=ee({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(e.map((async e=>{for await(let r of e)t.push(r)}))),t.end()}catch(e){t.end(e)}})),yield*t}()};function We(e,...t){if(null==e)throw new Error("Empty pipeline");if(Qe(e)){let t=e;e=()=>t.source}else if(Ye(e)||Ge(e)){let t=e;e=()=>t}let r=[e,...t];if(r.length>1&&Qe(r[r.length-1])&&(r[r.length-1]=r[r.length-1].sink),r.length>2)for(let e=1;e<r.length-1;e++)Qe(r[e])&&(r[e]=Je(r[e]));return je(...r)}var je=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},Ge=e=>null!=e?.[Symbol.asyncIterator],Ye=e=>null!=e?.[Symbol.iterator],Qe=e=>null!=e&&null!=e.sink&&null!=e.source,Je=e=>t=>{let r=e.sink(t);if(null!=r?.then){let t=ee({objectMode:!0});r.then((()=>{t.end()}),(e=>{t.end(e)}));let n,i=e.source;if(Ge(i))n=async function*(){yield*i,t.end()};else{if(!Ye(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");n=function*(){yield*i,t.end()}}return ze(t,n())}return e.source},Ze=function(e,t){return function(e){return null!=e[Symbol.asyncIterator]}(e)?async function*(){let r=0;if(!(t<1))for await(let n of e)if(yield n,r++,r===t)return}():function*(){let r=0;if(!(t<1))for(let n of e)if(yield n,r++,r===t)return}()},Xe=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}},et="/ipfs/bitswap/1.2.0",tt=new Float32Array([-0]),rt=new Uint8Array(tt.buffer);function nt(e,t,r){tt[0]=e,t[r]=rt[0],t[r+1]=rt[1],t[r+2]=rt[2],t[r+3]=rt[3]}var it=new Float64Array([-0]),st=new Uint8Array(it.buffer);function ot(e,t,r){it[0]=e,t[r]=st[0],t[r+1]=st[1],t[r+2]=st[2],t[r+3]=st[3],t[r+4]=st[4],t[r+5]=st[5],t[r+6]=st[6],t[r+7]=st[7]}var at=BigInt(Number.MAX_SAFE_INTEGER),lt=BigInt(Number.MIN_SAFE_INTEGER),ct=class e{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}toNumber(e=!1){if(!e&&this.hi>>>31>0){let e=1+~this.lo>>>0,t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(e+4294967296*t)}return this.lo+4294967296*this.hi}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let e=1+~this.lo>>>0,t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(BigInt(e)+(BigInt(t)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return 0===r?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}static fromBigInt(t){if(0n===t)return ut;if(t<at&&t>lt)return this.fromNumber(Number(t));let r=t<0n;r&&(t=-t);let n=t>>32n,i=t-(n<<32n);return r&&(n=0n|~n,i=0n|~i,++i>ht&&(i=0n,++n>ht&&(n=0n))),new e(Number(i),Number(n))}static fromNumber(t){if(0===t)return ut;let r=t<0;r&&(t=-t);let n=t>>>0,i=(t-n)/4294967296>>>0;return r&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new e(n,i)}static from(t){return"number"==typeof t?e.fromNumber(t):"bigint"==typeof t?e.fromBigInt(t):"string"==typeof t?e.fromBigInt(BigInt(t)):null!=t.low||null!=t.high?new e(t.low>>>0,t.high>>>0):ut}},ut=new ct(0,0);ut.toBigInt=function(){return 0n},ut.zzEncode=ut.zzDecode=function(){return this},ut.length=function(){return 1};var ht=4294967296n;function dt(e,t,r){let n,i,s=r;for(let s=0;s<e.length;++s)n=e.charCodeAt(s),n<128?t[r++]=n:n<2048?(t[r++]=n>>6|192,t[r++]=63&n|128):55296==(64512&n)&&56320==(64512&(i=e.charCodeAt(s+1)))?(n=65536+((1023&n)<<10)+(1023&i),++s,t[r++]=n>>18|240,t[r++]=n>>12&63|128,t[r++]=n>>6&63|128,t[r++]=63&n|128):(t[r++]=n>>12|224,t[r++]=n>>6&63|128,t[r++]=63&n|128);return r-s}function ft(e,t){return RangeError(`index out of range: ${e.pos} + ${t??1} > ${e.len}`)}function pt(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}var gt=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128||(e=(e|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,ft(this,10);return e}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}bool(){return 0!==this.uint32()}fixed32(){if(this.pos+4>this.len)throw ft(this,4);return pt(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw ft(this,4);return 0|pt(this.buf,this.pos+=4)}float(){if(this.pos+4>this.len)throw ft(this,4);let e=function(e,t){return rt[0]=e[t],rt[1]=e[t+1],rt[2]=e[t+2],rt[3]=e[t+3],tt[0]}(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw ft(this,4);let e=function(e,t){return st[0]=e[t],st[1]=e[t+1],st[2]=e[t+2],st[3]=e[t+3],st[4]=e[t+4],st[5]=e[t+5],st[6]=e[t+6],st[7]=e[t+7],it[0]}(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw ft(this,e);return this.pos+=e,t===r?new Uint8Array(0):this.buf.subarray(t,r)}string(){let e=this.bytes();return function(e,t,r){if(r-t<1)return"";let n,i,s=[],o=0;for(;t<r;)i=e[t++],i<128?s[o++]=i:i>191&&i<224?s[o++]=(31&i)<<6|63&e[t++]:i>239&&i<365?(i=((7&i)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,s[o++]=55296+(i>>10),s[o++]=56320+(1023&i)):s[o++]=(15&i)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((n??(n=[])).push(String.fromCharCode.apply(String,s)),o=0);return null!=n?(o>0&&n.push(String.fromCharCode.apply(String,s.slice(0,o))),n.join("")):String.fromCharCode.apply(String,s.slice(0,o))}(e,0,e.length)}skip(e){if("number"==typeof e){if(this.pos+e>this.len)throw ft(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw ft(this)}while(128&this.buf[this.pos++]);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new ct(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw ft(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw ft(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw ft(this,8);let e=pt(this.buf,this.pos+=4),t=pt(this.buf,this.pos+=4);return new ct(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=Re(this.buf,this.pos);return this.pos+=ve(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function mt(e,t,r){let n=function(e){return new gt(e instanceof Uint8Array?e:e.subarray())}(e);return t.decode(n,void 0,r)}var yt={};function wt(e){if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")}a(yt,{base10:()=>Tt}),new Uint8Array(0);var bt=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),n=0;n<r.length;n++)r[n]=255;for(var i=0;i<e.length;i++){var s=e.charAt(i),o=s.charCodeAt(0);if(255!==r[o])throw new TypeError(s+" is ambiguous");r[o]=i}var a=e.length,l=e.charAt(0),c=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var n=0,i=0;e[t]===l;)n++,t++;for(var s=(e.length-t)*c+1>>>0,o=new Uint8Array(s);e[t];){var u=r[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=s-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*o[d]>>>0,o[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=s-i;f!==s&&0===o[f];)f++;for(var p=new Uint8Array(n+(s-f)),g=n;f!==s;)p[g++]=o[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var r=0,n=0,i=0,s=t.length;i!==s&&0===t[i];)i++,r++;for(var o=(s-i)*u+1>>>0,c=new Uint8Array(o);i!==s;){for(var h=t[i],d=0,f=o-1;(0!==h||d<n)&&-1!==f;f--,d++)h+=256*c[f]>>>0,c[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");n=d,i++}for(var p=o-n;p!==o&&0===c[p];)p++;for(var g=l.repeat(r);p<o;++p)g+=e.charAt(c[p]);return g},decodeUnsafe:h,decode:function(e){var r=h(e);if(r)return r;throw new Error(`Non-${t} character`)}}},Et=class{name;prefix;baseEncode;constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},vt=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,r){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=r}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return Rt(this,e)}},St=class{decoders;constructor(e){this.decoders=e}or(e){return Rt(this,e)}decode(e){let t=e[0],r=this.decoders[t];if(null!=r)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Rt(e,t){return new St({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}var At=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,r,n){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=n,this.encoder=new Et(e,t,r),this.decoder=new vt(e,t,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function _t({name:e,prefix:t,encode:r,decode:n}){return new At(e,t,r,n)}function It({name:e,prefix:t,alphabet:r}){let{encode:n,decode:i}=bt(r,e);return _t({prefix:t,name:e,encode:n,decode:e=>wt(i(e))})}function kt({name:e,prefix:t,bitsPerChar:r,alphabet:n}){return _t({prefix:t,name:e,encode:e=>function(e,t,r){let n="="===t[t.length-1],i=(1<<r)-1,s="",o=0,a=0;for(let n=0;n<e.length;++n)for(a=a<<8|e[n],o+=8;o>r;)o-=r,s+=t[i&a>>o];if(0!==o&&(s+=t[i&a<<r-o]),n)for(;s.length*r&7;)s+="=";return s}(e,n,r),decode:t=>function(e,t,r,n){let i={};for(let e=0;e<t.length;++e)i[t[e]]=e;let s=e.length;for(;"="===e[s-1];)--s;let o=new Uint8Array(s*r/8|0),a=0,l=0,c=0;for(let t=0;t<s;++t){let s=i[e[t]];if(void 0===s)throw new SyntaxError(`Non-${n} character`);l=l<<r|s,a+=r,a>=8&&(a-=8,o[c++]=255&l>>a)}if(a>=r||255&l<<8-a)throw new SyntaxError("Unexpected end of data");return o}(t,n,r,e)})}var Tt=It({prefix:"9",name:"base10",alphabet:"0123456789"}),Ct={};a(Ct,{base16:()=>Dt,base16upper:()=>xt});var Dt=kt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),xt=kt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Nt={};a(Nt,{base2:()=>Pt});var Pt=kt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Lt={};a(Lt,{base256emoji:()=>Ut});var Ot=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),Bt=Ot.reduce(((e,t,r)=>(e[r]=t,e)),[]),Mt=Ot.reduce(((e,t,r)=>(e[t.codePointAt(0)]=r,e)),[]),Ut=_t({prefix:"🚀",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+Bt[t]),"")},decode:function(e){let t=[];for(let r of e){let e=Mt[r.codePointAt(0)];if(void 0===e)throw new Error(`Non-base256emoji character: ${r}`);t.push(e)}return new Uint8Array(t)}}),Ft={};a(Ft,{base32:()=>$t,base32hex:()=>qt,base32hexpad:()=>Wt,base32hexpadupper:()=>jt,base32hexupper:()=>zt,base32pad:()=>Kt,base32padupper:()=>Ht,base32upper:()=>Vt,base32z:()=>Gt});var $t=kt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Vt=kt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Kt=kt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ht=kt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),qt=kt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),zt=kt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Wt=kt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),jt=kt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Gt=kt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Yt={};a(Yt,{base36:()=>Qt,base36upper:()=>Jt});var Qt=It({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Jt=It({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Zt={};a(Zt,{base58btc:()=>Xt,base58flickr:()=>er});var Xt=It({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),er=It({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),tr={};a(tr,{base64:()=>rr,base64pad:()=>nr,base64url:()=>ir,base64urlpad:()=>sr});var rr=kt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),nr=kt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ir=kt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),sr=kt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),or={};a(or,{base8:()=>ar});var ar=kt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),lr={};a(lr,{identity:()=>cr});var cr=_t({prefix:"\0",name:"identity",encode:e=>function(e){return(new TextDecoder).decode(e)}(e),decode:e=>function(e){return(new TextEncoder).encode(e)}(e)});a((new TextEncoder,new TextDecoder,{}),{identity:()=>Or});var ur={};a(ur,{Digest:()=>Pr,create:()=>Dr,decode:()=>xr,equals:()=>Nr});var hr=128,dr=-128,fr=Math.pow(2,31),pr=128,gr=127,mr=Math.pow(2,7),yr=Math.pow(2,14),wr=Math.pow(2,21),br=Math.pow(2,28),Er=Math.pow(2,35),vr=Math.pow(2,42),Sr=Math.pow(2,49),Rr=Math.pow(2,56),Ar=Math.pow(2,63),_r={encode:function e(t,r,n){r=r||[];for(var i=n=n||0;t>=fr;)r[n++]=255&t|hr,t/=128;for(;t&dr;)r[n++]=255&t|hr,t>>>=7;return r[n]=0|t,e.bytes=n-i+1,r},decode:function e(t,r){var n,i=0,s=0,o=r=r||0,a=t.length;do{if(o>=a)throw e.bytes=0,new RangeError("Could not decode varint");n=t[o++],i+=s<28?(n&gr)<<s:(n&gr)*Math.pow(2,s),s+=7}while(n>=pr);return e.bytes=o-r,i},encodingLength:function(e){return e<mr?1:e<yr?2:e<wr?3:e<br?4:e<Er?5:e<vr?6:e<Sr?7:e<Rr?8:e<Ar?9:10}},Ir=_r;function kr(e,t=0){return[Ir.decode(e,t),Ir.decode.bytes]}function Tr(e,t,r=0){return Ir.encode(e,t,r),t}function Cr(e){return Ir.encodingLength(e)}function Dr(e,t){let r=t.byteLength,n=Cr(e),i=n+Cr(r),s=new Uint8Array(i+r);return Tr(e,s,0),Tr(r,s,n),s.set(t,i),new Pr(e,r,t,s)}function xr(e){let t=wt(e),[r,n]=kr(t),[i,s]=kr(t.subarray(n)),o=t.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Pr(r,i,o,t)}function Nr(e,t){if(e===t)return!0;{let r=t;return e.code===r.code&&e.size===r.size&&r.bytes instanceof Uint8Array&&function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}(e.bytes,r.bytes)}}var Pr=class{code;size;digest;bytes;constructor(e,t,r,n){this.code=e,this.size=t,this.digest=r,this.bytes=n}},Lr=wt,Or={code:0,name:"identity",encode:Lr,digest:function(e){return Dr(0,Lr(e))}};function Br({name:e,code:t,encode:r}){return new Mr(e,t,r)}a({},{sha256:()=>Fr,sha512:()=>$r});var Mr=class{name;code;encode;constructor(e,t,r){this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Dr(this.code,t):t.then((e=>Dr(this.code,e)))}throw Error("Unknown type, must be binary type")}};function Ur(e){return async t=>new Uint8Array(await crypto.subtle.digest(e,t))}var Fr=Br({name:"sha2-256",code:18,encode:Ur("SHA-256")}),$r=Br({name:"sha2-512",code:19,encode:Ur("SHA-512")});function Vr(e,t){let{bytes:r,version:n}=e;return 0===n?function(e,t,r){let{prefix:n}=r;if(n!==Xt.prefix)throw Error(`Cannot string encode V0 in ${r.name} encoding`);let i=t.get(n);if(null==i){let i=r.encode(e).slice(1);return t.set(n,i),i}return i}(r,Hr(e),t??Xt.encoder):function(e,t,r){let{prefix:n}=r,i=t.get(n);if(null==i){let i=r.encode(e);return t.set(n,i),i}return i}(r,Hr(e),t??$t.encoder)}var Kr=new WeakMap;function Hr(e){let t=Kr.get(e);if(null==t){let t=new Map;return Kr.set(e,t),t}return t}var qr=class e{code;version;multihash;bytes;"/";constructor(e,t,r,n){this.code=t,this.version=e,this.multihash=r,this.bytes=n,this["/"]=n}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:t,multihash:r}=this;if(t!==zr)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(r.code!==Wr)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return e.createV0(r)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:t,digest:r}=this.multihash,n=Dr(t,r);return e.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return e.equals(this,t)}static equals(e,t){let r=t;return null!=r&&e.code===r.code&&e.version===r.version&&Nr(e.multihash,r.multihash)}toString(e){return Vr(this,e)}toJSON(){return{"/":Vr(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(t){if(null==t)return null;let r=t;if(r instanceof e)return r;if(null!=r["/"]&&r["/"]===r.bytes||r.asCID===r){let{version:t,code:n,multihash:i,bytes:s}=r;return new e(t,n,i,s??jr(t,n,i.bytes))}if(!0===r[Gr]){let{version:t,multihash:n,code:i}=r,s=xr(n);return e.create(t,i,s)}return null}static create(t,r,n){if("number"!=typeof r)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:if(r!==zr)throw new Error(`Version 0 CID must use dag-pb (code: ${zr}) block encoding`);return new e(t,r,n,n.bytes);case 1:{let i=jr(t,r,n.bytes);return new e(t,r,n,i)}default:throw new Error("Invalid version")}}static createV0(t){return e.create(0,zr,t)}static createV1(t,r){return e.create(1,t,r)}static decode(t){let[r,n]=e.decodeFirst(t);if(0!==n.length)throw new Error("Incorrect length");return r}static decodeFirst(t){let r=e.inspectBytes(t),n=r.size-r.multihashSize,i=wt(t.subarray(n,n+r.multihashSize));if(i.byteLength!==r.multihashSize)throw new Error("Incorrect length");let s=i.subarray(r.multihashSize-r.digestSize),o=new Pr(r.multihashCode,r.digestSize,s,i);return[0===r.version?e.createV0(o):e.createV1(r.codec,o),t.subarray(r.size)]}static inspectBytes(e){let t=0,r=()=>{let[r,n]=kr(e.subarray(t));return t+=n,r},n=r(),i=zr;if(18===n?(n=0,t=0):i=r(),0!==n&&1!==n)throw new RangeError(`Invalid CID version ${n}`);let s=t,o=r(),a=r(),l=t+a;return{version:n,codec:i,multihashCode:o,digestSize:a,multihashSize:l-s,size:l}}static parse(t,r){let[n,i]=function(e,t){switch(e[0]){case"Q":{let r=t??Xt;return[Xt.prefix,r.decode(`${Xt.prefix}${e}`)]}case Xt.prefix:{let r=t??Xt;return[Xt.prefix,r.decode(e)]}case $t.prefix:{let r=t??$t;return[$t.prefix,r.decode(e)]}case Qt.prefix:{let r=t??Qt;return[Qt.prefix,r.decode(e)]}default:if(null==t)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}(t,r),s=e.decode(i);if(0===s.version&&"Q"!==t[0])throw Error("Version 0 CID string must not include multibase prefix");return Hr(s).set(n,t),s}},zr=112,Wr=18;function jr(e,t,r){let n=Cr(e),i=n+Cr(t),s=new Uint8Array(i+r.byteLength);return Tr(e,s,0),Tr(t,s,n),s.set(r,i),s}var Gr=Symbol.for("@ipld/js-cid/CID"),Yr={...lr,...Nt,...or,...yt,...Ct,...Ft,...Yt,...Zt,...tr,...Lt};function Qr(e,t,r,n){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:r},decoder:{decode:n}}}var Jr=Qr("utf8","u",(e=>"u"+new TextDecoder("utf8").decode(e)),(e=>(new TextEncoder).encode(e.substring(1)))),Zr=Qr("ascii","a",(e=>{let t="a";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}),(e=>{let t=he((e=e.substring(1)).length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t})),Xr={utf8:Jr,"utf-8":Jr,hex:Yr.base16,latin1:Zr,ascii:Zr,binary:Zr,...Yr};function en(e,t="utf8"){let r=Xr[t];if(null==r)throw new Error(`Unsupported encoding "${t}"`);return r.decoder.decode(`${r.prefix}${e}`)}var tn=class{fn;len;next;val;constructor(e,t,r){this.fn=e,this.len=t,this.next=void 0,this.val=r}};function rn(){}var nn=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},sn=function(){let e,t=8192,r=t;return function(n){if(n<1||n>4096)return he(n);r+n>t&&(e=he(t),r=0);let i=e.subarray(r,r+=n);return 7&r&&(r=1+(7|r)),i}}(),on=class{len;head;tail;states;constructor(){this.len=0,this.head=new tn(rn,0,0),this.tail=this.head,this.states=null}_push(e,t,r){return this.tail=this.tail.next=new tn(e,t,r),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new un((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(hn,10,ct.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=ct.fromBigInt(e);return this._push(hn,t.length(),t)}uint64Number(e){return this._push(Se,ve(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=ct.fromBigInt(e).zzEncode();return this._push(hn,t.length(),t)}sint64Number(e){let t=ct.fromNumber(e).zzEncode();return this._push(hn,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(an,1,e?1:0)}fixed32(e){return this._push(dn,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=ct.fromBigInt(e);return this._push(dn,4,t.lo)._push(dn,4,t.hi)}fixed64Number(e){let t=ct.fromNumber(e);return this._push(dn,4,t.lo)._push(dn,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(nt,4,e)}double(e){return this._push(ot,8,e)}bytes(e){let t=e.length>>>0;return 0===t?this._push(an,1,0):this.uint32(t)._push(fn,t,e)}string(e){let t=function(e){let t=0,r=0;for(let n=0;n<e.length;++n)r=e.charCodeAt(n),r<128?t+=1:r<2048?t+=2:55296==(64512&r)&&56320==(64512&e.charCodeAt(n+1))?(++n,t+=4):t+=3;return t}(e);return 0!==t?this.uint32(t)._push(dt,t,e):this._push(an,1,0)}fork(){return this.states=new nn(this),this.head=this.tail=new tn(rn,0,0),this.len=0,this}reset(){return null!=this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new tn(rn,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),0!==r&&(this.tail.next=e.next,this.tail=t,this.len+=r),this}finish(){let e=this.head.next,t=function(e){return null!=globalThis.Buffer?he(e):sn(e)}(this.len),r=0;for(;null!=e;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t}};function an(e,t,r){t[r]=255&e}function ln(e,t,r){for(;e>127;)t[r++]=127&e|128,e>>>=7;t[r]=e}var cn,un=class extends tn{next;constructor(e,t){super(ln,e,t),this.next=void 0}};function hn(e,t,r){for(;0!==e.hi;)t[r++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[r++]=127&e.lo|128,e.lo=e.lo>>>7;t[r++]=e.lo}function dn(e,t,r){t[r]=255&e,t[r+1]=e>>>8&255,t[r+2]=e>>>16&255,t[r+3]=e>>>24}function fn(e,t,r){t.set(e,r)}function pn(e,t,r){t.set(e,r)}function gn(e,t,r){e.length<40?dt(e,t,r):null!=t.utf8Write?t.utf8Write(e,r):t.set(en(e),r)}function mn(e,t){let r=new on;return t.encode(e,r,{lengthDelimited:!1}),r.finish()}function yn(e,t,r,n){return{name:e,type:t,encode:r,decode:n}}function wn(e){function t(t){if(null==e[t.toString()])throw new Error("Invalid enum value");return e[t]}return yn("enum",cn.VARINT,(function(e,r){let n=t(e);r.int32(n)}),(function(e){return t(e.int32())}))}function bn(e,t){return yn("message",cn.LENGTH_DELIMITED,e,t)}null!=globalThis.Buffer&&(on.prototype.bytes=function(e){let t=e.length>>>0;return this.uint32(t),t>0&&this._push(pn,t,e),this},on.prototype.string=function(e){let t=globalThis.Buffer.byteLength(e);return this.uint32(t),t>0&&this._push(gn,t,e),this}),function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(cn||(cn={}));var En,vn,Sn,Rn,An,_n,In,kn,Tn,Cn=class extends Error{code;constructor(e,t){super(e),this.code=t}};!function(e){e.WantBlock="WantBlock",e.WantHave="WantHave"}(En||(En={})),function(e){e[e.WantBlock=0]="WantBlock",e[e.WantHave=1]="WantHave"}(vn||(vn={})),function(e){e.codec=()=>wn(vn)}(En||(En={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.cid&&e.cid.byteLength>0&&(t.uint32(10),t.bytes(e.cid)),null!=e.priority&&0!==e.priority&&(t.uint32(16),t.int32(e.priority)),null!=e.cancel&&(t.uint32(24),t.bool(e.cancel)),null!=e.wantType&&(t.uint32(32),En.codec().encode(e.wantType,t)),null!=e.sendDontHave&&(t.uint32(40),t.bool(e.sendDontHave)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={cid:ue(0),priority:0},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.cid=e.bytes();break;case 2:n.priority=e.int32();break;case 3:n.cancel=e.bool();break;case 4:n.wantType=En.codec().decode(e);break;case 5:n.sendDontHave=e.bool();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(Sn||(Sn={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.entries)for(let r of e.entries)t.uint32(10),Sn.codec().encode(r,t);null!=e.full&&(t.uint32(16),t.bool(e.full)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={entries:[]},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:if(null!=r.limits?.entries&&n.entries.length===r.limits.entries)throw new Cn('decode error - map field "entries" had too many elements',"ERR_MAX_LENGTH");n.entries.push(Sn.codec().decode(e,e.uint32(),{limits:r.limits?.entries$}));break;case 2:n.full=e.bool();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(Rn||(Rn={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.prefix&&e.prefix.byteLength>0&&(t.uint32(10),t.bytes(e.prefix)),null!=e.data&&e.data.byteLength>0&&(t.uint32(18),t.bytes(e.data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={prefix:ue(0),data:ue(0)},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.prefix=e.bytes();break;case 2:n.data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(An||(An={})),function(e){e.HaveBlock="HaveBlock",e.DontHaveBlock="DontHaveBlock"}(_n||(_n={})),function(e){e[e.HaveBlock=0]="HaveBlock",e[e.DontHaveBlock=1]="DontHaveBlock"}(In||(In={})),function(e){e.codec=()=>wn(In)}(_n||(_n={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.cid&&e.cid.byteLength>0&&(t.uint32(10),t.bytes(e.cid)),null!=e.type&&0!==In[e.type]&&(t.uint32(16),_n.codec().encode(e.type,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={cid:ue(0),type:_n.HaveBlock},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.cid=e.bytes();break;case 2:n.type=_n.codec().decode(e);break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(kn||(kn={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.wantlist&&(t.uint32(10),Rn.codec().encode(e.wantlist,t)),null!=e.blocks)for(let r of e.blocks)t.uint32(26),An.codec().encode(r,t);if(null!=e.blockPresences)for(let r of e.blockPresences)t.uint32(34),kn.codec().encode(r,t);null!=e.pendingBytes&&0!==e.pendingBytes&&(t.uint32(40),t.int32(e.pendingBytes)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={blocks:[],blockPresences:[],pendingBytes:0},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.wantlist=Rn.codec().decode(e,e.uint32(),{limits:r.limits?.wantlist});break;case 3:if(null!=r.limits?.blocks&&n.blocks.length===r.limits.blocks)throw new Cn('decode error - map field "blocks" had too many elements',"ERR_MAX_LENGTH");n.blocks.push(An.codec().decode(e,e.uint32(),{limits:r.limits?.blocks$}));break;case 4:if(null!=r.limits?.blockPresences&&n.blockPresences.length===r.limits.blockPresences)throw new Cn('decode error - map field "blockPresences" had too many elements',"ERR_MAX_LENGTH");n.blockPresences.push(kn.codec().decode(e,e.uint32(),{limits:r.limits?.blockPresences$}));break;case 5:n.pendingBytes=e.int32();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(Tn||(Tn={}));function Dn(e,t,r,n,i,s){let o=0,a=!1;for(let l=r;l<e.length;l++){let r=e[l],c=s(r);if(c>4193664)throw new U("Cannot send block as after encoding it is over the max message size","ERR_BLOCK_TOO_LARGE");let u=i+c;if(u>n){a=!0;break}t.push(r),o++,i=u}return{hasMore:a,added:o,newSize:i}}function xn(e){return Ln(3,An.encode(e))}function Nn(e){return Ln(4,kn.encode(e))}function Pn(e){return Ln(1,Sn.encode(e))}function Ln(e,t){return ve(e)+ve(t.byteLength)+t.byteLength}var On=class extends K{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnTransientConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[et],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnTransientConnections=t.runOnTransientConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??4194304,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??4194304,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new le({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",(e=>{this.log.error("error sending wantlist to peer",e.detail)}))}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnections});let e={onConnect:e=>{this.safeDispatchEvent("peer:connected",{detail:e})},onDisconnect:e=>{this.safeDispatchEvent("peer:disconnected",{detail:e})}};this.registrarIds=[];for(let t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach((e=>{this.safeDispatchEvent("peer:connected",{detail:e.remotePeer})}))}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),null!=this.registrarIds){for(let e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;let{stream:t,connection:r}=e;Promise.resolve().then((async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,r.remotePeer);let e=()=>{"open"===t.status?t.abort(new U(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`,"ERR_TIMEOUT")):this.log("stream aborted with status %s",t.status)},n=AbortSignal.timeout(this.messageReceiveTimeout);n.addEventListener("abort",e),await t.closeWrite(),await We(t,(e=>Ve(e,{maxDataLength:this.maxIncomingMessageSize})),(async i=>{for await(let s of i)try{let i=Tn.decode(s);this.log("incoming new bitswap %s message from %p on stream",t.protocol,r.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:r.remotePeer,message:i}}),n.removeEventListener("abort",e),n=AbortSignal.timeout(this.messageReceiveTimeout),n.addEventListener("abort",e)}catch(e){this.log.error("error reading incoming bitswap message from %p on stream",r.remotePeer,t.id,e),t.abort(e);break}}))})).catch((e=>{this.log.error("error handling incoming stream from %p",r.remotePeer,e),t.abort(e)}))}async*findProviders(e,t){t?.onProgress?.(new Xe("bitswap:network:find-providers",e));for await(let r of this.routing.findProviders(e,t))await this.libp2p.isDialable(r.multiaddrs,{runOnTransientConnection:this.runOnTransientConnections})&&(yield r)}async findAndConnect(e,t){await ce(He(Ze(this.findProviders(e,t),t?.maxProviders??3),(async e=>this.connectTo(e.id,t)))).catch((e=>{this.log.error(e)}))}async sendMessage(e,t,r){if(!this.running)throw new Error("network isn't running");let n=this.sendQueue.queue.find((t=>e.equals(t.options.peerId)&&"queued"===t.status));if(null!=n)return n.options.message=function(e,t){for(let[r,n]of t.wantlist.entries()){let t=e.wantlist.get(r);null!=t&&(t.priority>n.priority&&(n.priority=t.priority),n.cancel=n.cancel??t.cancel,n.wantType=n.wantType??t.wantType,n.sendDontHave=n.sendDontHave??t.sendDontHave),e.wantlist.set(r,n)}for(let[r,n]of t.blockPresences.entries())e.blockPresences.set(r,n);for(let[r,n]of t.blocks.entries())e.blocks.set(r,n);return t.full&&!e.full&&(e.full=!0),e}(n.options.message,t),void await n.join({signal:r?.signal});await this.sendQueue.add((async t=>{let r=t?.message;if(null==r)throw new U("No message to send","ERR_NO_MESSAGE");this.log("sendMessage to %p",e),t?.onProgress?.(new Xe("bitswap:network:send-wantlist",e));let n=await this.libp2p.dialProtocol(e,et,t);await n.closeRead();try{await We(function*(e,t){let r=[...e.wantlist.values()],n=[...e.blockPresences.values()],i=[...e.blocks.values()],s=0,o=0,a=0,l=!1;for(;;){let c={wantlist:{full:e.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0},u=Tn.encode(c).byteLength,{added:h,hasMore:d,newSize:f}=Dn(i,c.blocks,a,t,u,xn);a+=h,u=f;let p=d;({added:h,hasMore:d,newSize:f}=Dn(n,c.blockPresences,o,t,u,Nn)),o+=h,u=f;let g=d;if(({added:h,hasMore:d,newSize:f}=Dn(r,c.wantlist.entries,s,t,u,Pn)),s+=h,u=f,l=!p&&!g&&!d,l||(c.wantlist.full=!1),yield Tn.encode(c),l)break}}(r,this.maxOutgoingMessageSize),(e=>Le(e)),n),await n.close(t)}catch(r){t?.onProgress?.(new Xe("bitswap:network:send-wantlist:error",{peer:e,error:r})),this.log.error("error sending message to %p",e,r),n.abort(r)}this._updateSentStats(r.blocks)}),{peerId:e,signal:r?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new U("Network isn't running","ERR_NOT_STARTED");t?.onProgress?.(new Xe("bitswap:network:dial",e));let[r]=await Promise.all([this.libp2p.dial(e,t),re(this.libp2p,"peer:identify",t?.signal,{filter:t=>{if(!t.detail.peerId.equals(e))return!1;if(t.detail.protocols.includes(et))return!0;throw new U(`${e} did not support ${et}`,"ERR_BITSWAP_UNSUPPORTED_BY_PEER")}})]);return r}_updateSentStats(e){let t=0;for(let r of e.values())t+=r.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};function Bn(e,t="utf8"){let r=Xr[t];if(null==r)throw new Error(`Unsupported encoding "${t}"`);return r.encoder.encode(e).substring(1)}var Mn=Symbol.for("nodejs.util.inspect.custom"),Un=Object.values(Yr).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),Yr.identity.decoder),Fn=114,$n=36,Vn=37,Kn=class{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[x]=!0;toString(){return null==this.string&&(this.string=Xt.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return qr.createV1(Fn,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return ke(this.multihash.bytes,e);if("string"==typeof e)return Gn(e).equals(this);if(null!=e?.multihash?.bytes)return ke(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[Mn](){return`PeerId(${this.toString()})`}},Hn=class extends Kn{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},qn=class extends Kn{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}},zn=class extends Kn{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}},Wn=2336,jn=class{type="url";multihash;privateKey;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Or.digest(en(this.url))}[Mn](){return`PeerId(${this.url})`}[x]=!0;toString(){return this.toCID().toString()}toCID(){return qr.createV1(Wn,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Bn(e)),e.toString()===this.toString())}};function Gn(e,t){if(t=t??Un,"1"===e.charAt(0)||"Q"===e.charAt(0)){let t=xr(Xt.decode(`z${e}`));return e.startsWith("12D")?new qn({multihash:t}):e.startsWith("16U")?new zn({multihash:t}):new Hn({multihash:t})}return Yn(Un.decode(e))}function Yn(e){try{let t=xr(e);if(t.code===Or.code){if(t.digest.length===$n)return new qn({multihash:t});if(t.digest.length===Vn)return new zn({multihash:t})}if(t.code===Fr.code)return new Hn({multihash:t})}catch{return function(e){if(null==e?.multihash||null==e.version||1===e.version&&e.code!==Fn&&e.code!==Wn)throw new Error("Supplied PeerID CID is invalid");if(e.code===Wn){let t=Bn(e.multihash.digest);return new jn(new URL(t))}let t=e.multihash;if(t.code===Fr.code)return new Hn({multihash:e.multihash});if(t.code===Or.code){if(t.digest.length===$n)return new qn({multihash:e.multihash});if(t.digest.length===Vn)return new zn({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(qr.decode(e))}throw new Error("Supplied PeerID CID is invalid")}async function Qn(e,t){return e.length===$n?new qn({multihash:Dr(Or.code,e),privateKey:t}):e.length===Vn?new zn({multihash:Dr(Or.code,e),privateKey:t}):new Hn({multihash:await Fr.digest(e),publicKey:e,privateKey:t})}function Jn(e,t){let r={[Symbol.iterator]:()=>r,next:()=>{let r=e.next(),n=r.value;return!0===r.done||null==n?{done:!0,value:void 0}:{done:!1,value:t(n)}}};return r}var Zn=class{map;constructor(e){if(this.map=new Map,null!=e)for(let[t,r]of e.entries())this.map.set(t.toString(),r)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Jn(this.map.entries(),(e=>[Gn(e[0]),e[1]]))}forEach(e){this.map.forEach(((t,r)=>{e(t,Gn(r),this)}))}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return Jn(this.map.keys(),(e=>Gn(e)))}values(){return this.map.values()}get size(){return this.map.size}},Xn=class e{set;constructor(e){if(this.set=new Set,null!=e)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Jn(this.set.entries(),(e=>{let t=Gn(e[0]);return[t,t]}))}forEach(e){this.set.forEach((t=>{let r=Gn(t);e(r,r,this)}))}has(e){return this.set.has(e.toString())}values(){return Jn(this.set.values(),(e=>Gn(e)))}intersection(t){let r=new e;for(let e of t)this.has(e)&&r.add(e);return r}difference(t){let r=new e;for(let e of this)t.has(e)||r.add(e);return r}union(t){let r=new e;for(let e of t)r.add(e);for(let e of this)r.add(e);return r}},ei={get(e=globalThis){let t=e.crypto;if(null==t?.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return t}},ti={SHA1:20,SHA256:32,SHA512:64},ri={SHA1:"SHA-1",SHA256:"SHA-256",SHA512:"SHA-512"},ni={};a(ni,{Ed25519PrivateKey:()=>So,Ed25519PublicKey:()=>vo,MAX_RSA_KEY_SIZE:()=>fc,RsaPrivateKey:()=>gc,RsaPublicKey:()=>pc,Secp256k1PrivateKey:()=>qc,Secp256k1PublicKey:()=>Hc,generateEphemeralKeyPair:()=>Po,generateKeyPair:()=>Jc,generateKeyPairFromSeed:()=>Zc,importKey:()=>nu,keyStretcher:()=>Oo,keysPBM:()=>Eo,marshalPrivateKey:()=>ru,marshalPublicKey:()=>eu,supportedKeys:()=>Gc,unmarshalPrivateKey:()=>tu,unmarshalPublicKey:()=>Xc});var ii={};function si(e,t){let r=en(e,"base64urlpad");if(null!=t){if(r.length>t)throw new Error("byte array longer than desired length");r=Ie([new Uint8Array(t-r.length),r])}return r}function oi(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally}function ai(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function li(e,...t){if(!function(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function ci(e){if("function"!=typeof e||"function"!=typeof e.create)throw new Error("Hash should be wrapped by utils.wrapConstructor");ai(e.outputLen),ai(e.blockLen)}function ui(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}a(ii,{Ed25519PrivateKey:()=>So,Ed25519PublicKey:()=>vo,generateKeyPair:()=>_o,generateKeyPairFromSeed:()=>Io,unmarshalEd25519PrivateKey:()=>Ro,unmarshalEd25519PublicKey:()=>Ao});var hi="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0,di=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),fi=(e,t)=>e<<32-t|e>>>t,pi=(e,t)=>e<<t|e>>>32-t>>>0,gi=(new Uint8Array(new Uint32Array([287454020]).buffer)[0],async()=>{});async function mi(e,t,r){let n=Date.now();for(let i=0;i<e;i++){r(i);let e=Date.now()-n;e>=0&&e<t||(await gi(),n+=e)}}function yi(e){return"string"==typeof e&&(e=function(e){if("string"!=typeof e)throw new Error("utf8ToBytes expected string, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e)),li(e),e}var wi=class{clone(){return this._cloneInto()}},bi={}.toString;function Ei(e){let t=t=>e().update(yi(t)).digest(),r=e();return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=()=>e(),t}function vi(e=32){if(hi&&"function"==typeof hi.getRandomValues)return hi.getRandomValues(new Uint8Array(e));if(hi&&"function"==typeof hi.randomBytes)return hi.randomBytes(e);throw new Error("crypto.getRandomValues must be defined")}var Si=(e,t,r)=>e&t^~e&r,Ri=(e,t,r)=>e&t^e&r^t&r,Ai=class extends wi{constructor(e,t,r,n){super(),this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=n,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=di(this.buffer)}update(e){ui(this);let{view:t,buffer:r,blockLen:n}=this,i=(e=yi(e)).length;for(let s=0;s<i;){let o=Math.min(n-this.pos,i-s);if(o!==n)r.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===n&&(this.process(t,0),this.pos=0);else{let t=di(e);for(;n<=i-s;s+=n)this.process(t,s)}}return this.length+=e.length,this.roundClean(),this}digestInto(e){ui(this),function(e,t){li(e);let r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}(e,this),this.finished=!0;let{buffer:t,view:r,blockLen:n,isLE:i}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>n-s&&(this.process(r,0),s=0);for(let e=s;e<n;e++)t[e]=0;(function(e,t,r,n){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,r,n);let i=BigInt(32),s=BigInt(4294967295),o=Number(r>>i&s),a=Number(r&s),l=n?4:0,c=n?0:4;e.setUint32(t+l,o,n),e.setUint32(t+c,a,n)})(r,n-8,BigInt(8*this.length),i),this.process(r,0);let o=di(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=a/4,c=this.get();if(l>c.length)throw new Error("_sha2: outputLen bigger than state");for(let e=0;e<l;e++)o.setUint32(4*e,c[e],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:r,length:n,finished:i,destroyed:s,pos:o}=this;return e.length=n,e.pos=o,e.finished=i,e.destroyed=s,n%t&&e.buffer.set(r),e}},_i=BigInt(4294967295),Ii=BigInt(32);function ki(e,t=!1){return t?{h:Number(e&_i),l:Number(e>>Ii&_i)}:{h:0|Number(e>>Ii&_i),l:0|Number(e&_i)}}var Ti={fromBig:ki,split:function(e,t=!1){let r=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let i=0;i<e.length;i++){let{h:s,l:o}=ki(e[i],t);[r[i],n[i]]=[s,o]}return[r,n]},toBig:(e,t)=>BigInt(e>>>0)<<Ii|BigInt(t>>>0),shrSH:(e,t,r)=>e>>>r,shrSL:(e,t,r)=>e<<32-r|t>>>r,rotrSH:(e,t,r)=>e>>>r|t<<32-r,rotrSL:(e,t,r)=>e<<32-r|t>>>r,rotrBH:(e,t,r)=>e<<64-r|t>>>r-32,rotrBL:(e,t,r)=>e>>>r-32|t<<64-r,rotr32H:(e,t)=>t,rotr32L:(e,t)=>e,rotlSH:(e,t,r)=>e<<r|t>>>32-r,rotlSL:(e,t,r)=>t<<r|e>>>32-r,rotlBH:(e,t,r)=>t<<r-32|e>>>64-r,rotlBL:(e,t,r)=>e<<r-32|t>>>64-r,add:function(e,t,r,n){let i=(t>>>0)+(n>>>0);return{h:e+r+(i/2**32|0)|0,l:0|i}},add3L:(e,t,r)=>(e>>>0)+(t>>>0)+(r>>>0),add3H:(e,t,r,n)=>t+r+n+(e/2**32|0)|0,add4L:(e,t,r,n)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0),add4H:(e,t,r,n,i)=>t+r+n+i+(e/2**32|0)|0,add5H:(e,t,r,n,i,s)=>t+r+n+i+s+(e/2**32|0)|0,add5L:(e,t,r,n,i)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0)+(i>>>0)},Ci=Ti,[Di,xi]=Ci.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map((e=>BigInt(e)))),Ni=new Uint32Array(80),Pi=new Uint32Array(80),Li=class extends Ai{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){let{Ah:e,Al:t,Bh:r,Bl:n,Ch:i,Cl:s,Dh:o,Dl:a,Eh:l,El:c,Fh:u,Fl:h,Gh:d,Gl:f,Hh:p,Hl:g}=this;return[e,t,r,n,i,s,o,a,l,c,u,h,d,f,p,g]}set(e,t,r,n,i,s,o,a,l,c,u,h,d,f,p,g){this.Ah=0|e,this.Al=0|t,this.Bh=0|r,this.Bl=0|n,this.Ch=0|i,this.Cl=0|s,this.Dh=0|o,this.Dl=0|a,this.Eh=0|l,this.El=0|c,this.Fh=0|u,this.Fl=0|h,this.Gh=0|d,this.Gl=0|f,this.Hh=0|p,this.Hl=0|g}process(e,t){for(let r=0;r<16;r++,t+=4)Ni[r]=e.getUint32(t),Pi[r]=e.getUint32(t+=4);for(let e=16;e<80;e++){let t=0|Ni[e-15],r=0|Pi[e-15],n=Ci.rotrSH(t,r,1)^Ci.rotrSH(t,r,8)^Ci.shrSH(t,r,7),i=Ci.rotrSL(t,r,1)^Ci.rotrSL(t,r,8)^Ci.shrSL(t,r,7),s=0|Ni[e-2],o=0|Pi[e-2],a=Ci.rotrSH(s,o,19)^Ci.rotrBH(s,o,61)^Ci.shrSH(s,o,6),l=Ci.rotrSL(s,o,19)^Ci.rotrBL(s,o,61)^Ci.shrSL(s,o,6),c=Ci.add4L(i,l,Pi[e-7],Pi[e-16]),u=Ci.add4H(c,n,a,Ni[e-7],Ni[e-16]);Ni[e]=0|u,Pi[e]=0|c}let{Ah:r,Al:n,Bh:i,Bl:s,Ch:o,Cl:a,Dh:l,Dl:c,Eh:u,El:h,Fh:d,Fl:f,Gh:p,Gl:g,Hh:m,Hl:y}=this;for(let e=0;e<80;e++){let t=Ci.rotrSH(u,h,14)^Ci.rotrSH(u,h,18)^Ci.rotrBH(u,h,41),w=Ci.rotrSL(u,h,14)^Ci.rotrSL(u,h,18)^Ci.rotrBL(u,h,41),b=u&d^~u&p,E=h&f^~h&g,v=Ci.add5L(y,w,E,xi[e],Pi[e]),S=Ci.add5H(v,m,t,b,Di[e],Ni[e]),R=0|v,A=Ci.rotrSH(r,n,28)^Ci.rotrBH(r,n,34)^Ci.rotrBH(r,n,39),_=Ci.rotrSL(r,n,28)^Ci.rotrBL(r,n,34)^Ci.rotrBL(r,n,39),I=r&i^r&o^i&o,k=n&s^n&a^s&a;m=0|p,y=0|g,p=0|d,g=0|f,d=0|u,f=0|h,({h:u,l:h}=Ci.add(0|l,0|c,0|S,0|R)),l=0|o,c=0|a,o=0|i,a=0|s,i=0|r,s=0|n;let T=Ci.add3L(R,_,k);r=Ci.add3H(T,S,A,I),n=0|T}({h:r,l:n}=Ci.add(0|this.Ah,0|this.Al,0|r,0|n)),({h:i,l:s}=Ci.add(0|this.Bh,0|this.Bl,0|i,0|s)),({h:o,l:a}=Ci.add(0|this.Ch,0|this.Cl,0|o,0|a)),({h:l,l:c}=Ci.add(0|this.Dh,0|this.Dl,0|l,0|c)),({h:u,l:h}=Ci.add(0|this.Eh,0|this.El,0|u,0|h)),({h:d,l:f}=Ci.add(0|this.Fh,0|this.Fl,0|d,0|f)),({h:p,l:g}=Ci.add(0|this.Gh,0|this.Gl,0|p,0|g)),({h:m,l:y}=Ci.add(0|this.Hh,0|this.Hl,0|m,0|y)),this.set(r,n,i,s,o,a,l,c,u,h,d,f,p,g,m,y)}roundClean(){Ni.fill(0),Pi.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},Oi=Ei((()=>new Li)),Bi={};a(Bi,{aInRange:()=>as,abool:()=>Ki,abytes:()=>Vi,bitGet:()=>cs,bitLen:()=>ls,bitMask:()=>hs,bitSet:()=>us,bytesToHex:()=>qi,bytesToNumberBE:()=>Qi,bytesToNumberLE:()=>Ji,concatBytes:()=>rs,createHmacDrbg:()=>ps,ensureBytes:()=>ts,equalBytes:()=>ns,hexToBytes:()=>Yi,hexToNumber:()=>Wi,inRange:()=>os,isBytes:()=>$i,memoized:()=>ws,notImplemented:()=>ys,numberToBytesBE:()=>Zi,numberToBytesLE:()=>Xi,numberToHexUnpadded:()=>zi,numberToVarBytesBE:()=>es,utf8ToBytes:()=>is,validateObject:()=>ms});var Mi=BigInt(0),Ui=BigInt(1),Fi=BigInt(2);function $i(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}function Vi(e){if(!$i(e))throw new Error("Uint8Array expected")}function Ki(e,t){if("boolean"!=typeof t)throw new Error(`${e} must be valid boolean, got "${t}".`)}var Hi=Array.from({length:256},((e,t)=>t.toString(16).padStart(2,"0")));function qi(e){Vi(e);let t="";for(let r=0;r<e.length;r++)t+=Hi[e[r]];return t}function zi(e){let t=e.toString(16);return 1&t.length?`0${t}`:t}function Wi(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);return BigInt(""===e?"0":`0x${e}`)}var ji={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function Gi(e){return e>=ji._0&&e<=ji._9?e-ji._0:e>=ji._A&&e<=ji._F?e-(ji._A-10):e>=ji._a&&e<=ji._f?e-(ji._a-10):void 0}function Yi(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);let t=e.length,r=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);let n=new Uint8Array(r);for(let t=0,i=0;t<r;t++,i+=2){let r=Gi(e.charCodeAt(i)),s=Gi(e.charCodeAt(i+1));if(void 0===r||void 0===s){let t=e[i]+e[i+1];throw new Error('hex string expected, got non-hex character "'+t+'" at index '+i)}n[t]=16*r+s}return n}function Qi(e){return Wi(qi(e))}function Ji(e){return Vi(e),Wi(qi(Uint8Array.from(e).reverse()))}function Zi(e,t){return Yi(e.toString(16).padStart(2*t,"0"))}function Xi(e,t){return Zi(e,t).reverse()}function es(e){return Yi(zi(e))}function ts(e,t,r){let n;if("string"==typeof t)try{n=Yi(t)}catch(r){throw new Error(`${e} must be valid hex string, got "${t}". Cause: ${r}`)}else{if(!$i(t))throw new Error(`${e} must be hex string or Uint8Array`);n=Uint8Array.from(t)}let i=n.length;if("number"==typeof r&&i!==r)throw new Error(`${e} expected ${r} bytes, got ${i}`);return n}function rs(...e){let t=0;for(let r=0;r<e.length;r++){let n=e[r];Vi(n),t+=n.length}let r=new Uint8Array(t);for(let t=0,n=0;t<e.length;t++){let i=e[t];r.set(i,n),n+=i.length}return r}function ns(e,t){if(e.length!==t.length)return!1;let r=0;for(let n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}function is(e){if("string"!=typeof e)throw new Error("utf8ToBytes expected string, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}var ss=e=>"bigint"==typeof e&&Mi<=e;function os(e,t,r){return ss(e)&&ss(t)&&ss(r)&&t<=e&&e<r}function as(e,t,r,n){if(!os(t,r,n))throw new Error(`expected valid ${e}: ${r} <= n < ${n}, got ${typeof t} ${t}`)}function ls(e){let t;for(t=0;e>Mi;e>>=Ui,t+=1);return t}function cs(e,t){return e>>BigInt(t)&Ui}function us(e,t,r){return e|(r?Ui:Mi)<<BigInt(t)}var hs=e=>(Fi<<BigInt(e-1))-Ui,ds=e=>new Uint8Array(e),fs=e=>Uint8Array.from(e);function ps(e,t,r){if("number"!=typeof e||e<2)throw new Error("hashLen must be a number");if("number"!=typeof t||t<2)throw new Error("qByteLen must be a number");if("function"!=typeof r)throw new Error("hmacFn must be a function");let n=ds(e),i=ds(e),s=0,o=()=>{n.fill(1),i.fill(0),s=0},a=(...e)=>r(i,n,...e),l=(e=ds())=>{i=a(fs([0]),e),n=a(),0!==e.length&&(i=a(fs([1]),e),n=a())},c=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let e=0,r=[];for(;e<t;){n=a();let t=n.slice();r.push(t),e+=n.length}return rs(...r)};return(e,t)=>{let r;for(o(),l(e);!(r=t(c()));)l();return o(),r}}var gs={bigint:e=>"bigint"==typeof e,function:e=>"function"==typeof e,boolean:e=>"boolean"==typeof e,string:e=>"string"==typeof e,stringOrUint8Array:e=>"string"==typeof e||$i(e),isSafeInteger:e=>Number.isSafeInteger(e),array:e=>Array.isArray(e),field:(e,t)=>t.Fp.isValid(e),hash:e=>"function"==typeof e&&Number.isSafeInteger(e.outputLen)};function ms(e,t,r={}){let n=(t,r,n)=>{let i=gs[r];if("function"!=typeof i)throw new Error(`Invalid validator "${r}", expected function`);let s=e[t];if(!(n&&void 0===s||i(s,e)))throw new Error(`Invalid param ${String(t)}=${s} (${typeof s}), expected ${r}`)};for(let[e,r]of Object.entries(t))n(e,r,!1);for(let[e,t]of Object.entries(r))n(e,t,!0);return e}var ys=()=>{throw new Error("not implemented")};function ws(e){let t=new WeakMap;return(r,...n)=>{let i=t.get(r);if(void 0!==i)return i;let s=e(r,...n);return t.set(r,s),s}}var bs=BigInt(0),Es=BigInt(1),vs=BigInt(2),Ss=BigInt(3),Rs=BigInt(4),As=BigInt(5),_s=BigInt(8);function Is(e,t){let r=e%t;return r>=bs?r:t+r}function ks(e,t,r){if(r<=bs||t<bs)throw new Error("Expected power/modulo > 0");if(r===Es)return bs;let n=Es;for(;t>bs;)t&Es&&(n=n*e%r),e=e*e%r,t>>=Es;return n}function Ts(e,t,r){let n=e;for(;t-- >bs;)n*=n,n%=r;return n}function Cs(e,t){if(e===bs||t<=bs)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let r=Is(e,t),n=t,i=bs,s=Es,o=Es,a=bs;for(;r!==bs;){let e=n/r,t=n%r,l=i-o*e,c=s-a*e;n=r,r=t,i=o,s=a,o=l,a=c}if(n!==Es)throw new Error("invert: does not exist");return Is(i,t)}BigInt(9),BigInt(16);var Ds=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function xs(e,t){let r=void 0!==t?t:e.toString(2).length;return{nBitLength:r,nByteLength:Math.ceil(r/8)}}function Ns(e,t,r=!1,n={}){if(e<=bs)throw new Error(`Expected Field ORDER > 0, got ${e}`);let{nBitLength:i,nByteLength:s}=xs(e,t);if(s>2048)throw new Error("Field lengths over 2048 bytes are not supported");let o=function(e){if(e%Rs===Ss){let t=(e+Es)/Rs;return function(e,r){let n=e.pow(r,t);if(!e.eql(e.sqr(n),r))throw new Error("Cannot find square root");return n}}if(e%_s===As){let t=(e-As)/_s;return function(e,r){let n=e.mul(r,vs),i=e.pow(n,t),s=e.mul(r,i),o=e.mul(e.mul(s,vs),i),a=e.mul(s,e.sub(o,e.ONE));if(!e.eql(e.sqr(a),r))throw new Error("Cannot find square root");return a}}return function(e){let t,r,n,i=(e-Es)/vs;for(t=e-Es,r=0;t%vs===bs;t/=vs,r++);for(n=vs;n<e&&ks(n,i,e)!==e-Es;n++);if(1===r){let t=(e+Es)/Rs;return function(e,r){let n=e.pow(r,t);if(!e.eql(e.sqr(n),r))throw new Error("Cannot find square root");return n}}let s=(t+Es)/vs;return function(e,o){if(e.pow(o,i)===e.neg(e.ONE))throw new Error("Cannot find square root");let a=r,l=e.pow(e.mul(e.ONE,n),t),c=e.pow(o,s),u=e.pow(o,t);for(;!e.eql(u,e.ONE);){if(e.eql(u,e.ZERO))return e.ZERO;let t=1;for(let r=e.sqr(u);t<a&&!e.eql(r,e.ONE);t++)r=e.sqr(r);let r=e.pow(l,Es<<BigInt(a-t-1));l=e.sqr(r),c=e.mul(c,r),u=e.mul(u,l),a=t}return c}}(e)}(e),a=Object.freeze({ORDER:e,BITS:i,BYTES:s,MASK:hs(i),ZERO:bs,ONE:Es,create:t=>Is(t,e),isValid:t=>{if("bigint"!=typeof t)throw new Error("Invalid field element: expected bigint, got "+typeof t);return bs<=t&&t<e},is0:e=>e===bs,isOdd:e=>(e&Es)===Es,neg:t=>Is(-t,e),eql:(e,t)=>e===t,sqr:t=>Is(t*t,e),add:(t,r)=>Is(t+r,e),sub:(t,r)=>Is(t-r,e),mul:(t,r)=>Is(t*r,e),pow:(e,t)=>function(e,t,r){if(r<bs)throw new Error("Expected power > 0");if(r===bs)return e.ONE;if(r===Es)return t;let n=e.ONE,i=t;for(;r>bs;)r&Es&&(n=e.mul(n,i)),i=e.sqr(i),r>>=Es;return n}(a,e,t),div:(t,r)=>Is(t*Cs(r,e),e),sqrN:e=>e*e,addN:(e,t)=>e+t,subN:(e,t)=>e-t,mulN:(e,t)=>e*t,inv:t=>Cs(t,e),sqrt:n.sqrt||(e=>o(a,e)),invertBatch:e=>function(e,t){let r=new Array(t.length),n=t.reduce(((t,n,i)=>e.is0(n)?t:(r[i]=t,e.mul(t,n))),e.ONE),i=e.inv(n);return t.reduceRight(((t,n,i)=>e.is0(n)?t:(r[i]=e.mul(t,r[i]),e.mul(t,n))),i),r}(a,e),cmov:(e,t,r)=>r?t:e,toBytes:e=>r?Xi(e,s):Zi(e,s),fromBytes:e=>{if(e.length!==s)throw new Error(`Fp.fromBytes: expected ${s}, got ${e.length}`);return r?Ji(e):Qi(e)}});return Object.freeze(a)}function Ps(e){if("bigint"!=typeof e)throw new Error("field order must be bigint");let t=e.toString(2).length;return Math.ceil(t/8)}function Ls(e){let t=Ps(e);return t+Math.ceil(t/2)}var Os=BigInt(0),Bs=BigInt(1),Ms=new WeakMap,Us=new WeakMap;function Fs(e,t){let r=(e,t)=>{let r=t.negate();return e?r:t},n=e=>{if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error(`Wrong window size=${e}, should be [1..${t}]`)},i=e=>(n(e),{windows:Math.ceil(t/e)+1,windowSize:2**(e-1)});return{constTimeNegate:r,unsafeLadder(t,r){let n=e.ZERO,i=t;for(;r>Os;)r&Bs&&(n=n.add(i)),i=i.double(),r>>=Bs;return n},precomputeWindow(e,t){let{windows:r,windowSize:n}=i(t),s=[],o=e,a=o;for(let e=0;e<r;e++){a=o,s.push(a);for(let e=1;e<n;e++)a=a.add(o),s.push(a);o=a.double()}return s},wNAF(t,n,s){let{windows:o,windowSize:a}=i(t),l=e.ZERO,c=e.BASE,u=BigInt(2**t-1),h=2**t,d=BigInt(t);for(let e=0;e<o;e++){let t=e*a,i=Number(s&u);s>>=d,i>a&&(i-=h,s+=Bs);let o=t,f=t+Math.abs(i)-1,p=e%2!=0,g=i<0;0===i?c=c.add(r(p,n[o])):l=l.add(r(g,n[f]))}return{p:l,f:c}},wNAFCached(e,t,r){let n=Us.get(e)||1,i=Ms.get(e);return i||(i=this.precomputeWindow(e,n),1!==n&&Ms.set(e,r(i))),this.wNAF(n,i,t)},setWindowSize(e,t){n(t),Us.set(e,t),Ms.delete(e)}}}function $s(e,t,r,n){if(!Array.isArray(r)||!Array.isArray(n)||n.length!==r.length)throw new Error("arrays of points and scalars must have equal length");n.forEach(((e,r)=>{if(!t.isValid(e))throw new Error(`wrong scalar at index ${r}`)})),r.forEach(((t,r)=>{if(!(t instanceof e))throw new Error(`wrong point at index ${r}`)}));let i=ls(BigInt(r.length)),s=i>12?i-3:i>4?i-2:i?2:1,o=(1<<s)-1,a=new Array(o+1).fill(e.ZERO),l=Math.floor((t.BITS-1)/s)*s,c=e.ZERO;for(let t=l;t>=0;t-=s){a.fill(e.ZERO);for(let e=0;e<n.length;e++){let i=n[e],s=Number(i>>BigInt(t)&BigInt(o));a[s]=a[s].add(r[e])}let i=e.ZERO;for(let t=a.length-1,r=e.ZERO;t>0;t--)r=r.add(a[t]),i=i.add(r);if(c=c.add(i),0!==t)for(let e=0;e<s;e++)c=c.double()}return c}function Vs(e){return function(e){ms(e,Ds.reduce(((e,t)=>(e[t]="function",e)),{ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"}))}(e.Fp),ms(e,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...xs(e.n,e.nBitLength),...e,p:e.Fp.ORDER})}var Ks=BigInt(0),Hs=BigInt(1),qs=BigInt(2),zs=BigInt(8),Ws={zip215:!0},js=BigInt(0),Gs=BigInt(1),Ys=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),Qs=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),Js=(BigInt(0),BigInt(1)),Zs=BigInt(2),Xs=BigInt(3),eo=BigInt(5),to=BigInt(8);function ro(e){let t=BigInt(10),r=BigInt(20),n=BigInt(40),i=BigInt(80),s=Ys,o=e*e%s*e%s,a=Ts(o,Zs,s)*o%s,l=Ts(a,Js,s)*e%s,c=Ts(l,eo,s)*l%s,u=Ts(c,t,s)*c%s,h=Ts(u,r,s)*u%s,d=Ts(h,n,s)*h%s,f=Ts(d,i,s)*d%s,p=Ts(f,i,s)*d%s,g=Ts(p,t,s)*c%s;return{pow_p_5_8:Ts(g,Zs,s)*e%s,b2:o}}function no(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}var io=Ns(Ys,void 0,!0),so={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:io,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:to,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:Oi,randomBytes:vi,adjustScalarBytes:no,uvRatio:function(e,t){let r=Ys,n=Is(t*t*t,r),i=Is(n*n*t,r),s=Is(e*n*ro(e*i).pow_p_5_8,r),o=Is(t*s*s,r),a=s,l=Is(s*Qs,r),c=o===e,u=o===Is(-e,r),h=o===Is(-e*Qs,r);return c&&(s=a),(u||h)&&(s=l),((e,t)=>(Is(e,t)&Es)===Es)(s,r)&&(s=Is(-s,r)),{isValid:c||u,value:s}}},oo=function(e){let t=function(e){let t=Vs(e);return ms(e,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...t})}(e),{Fp:r,n,prehash:i,hash:s,randomBytes:o,nByteLength:a,h:l}=t,c=qs<<BigInt(8*a)-Hs,u=r.create,h=Ns(t.n,t.nBitLength),d=t.uvRatio||((e,t)=>{try{return{isValid:!0,value:r.sqrt(e*r.inv(t))}}catch{return{isValid:!1,value:Ks}}}),f=t.adjustScalarBytes||(e=>e),p=t.domain||((e,t,r)=>{if(Ki("phflag",r),t.length||r)throw new Error("Contexts/pre-hash are not supported");return e});function g(e,t){as("coordinate "+e,t,Ks,c)}function m(e){if(!(e instanceof b))throw new Error("ExtendedPoint expected")}let y=ws(((e,t)=>{let{ex:n,ey:i,ez:s}=e,o=e.is0();null==t&&(t=o?zs:r.inv(s));let a=u(n*t),l=u(i*t),c=u(s*t);if(o)return{x:Ks,y:Hs};if(c!==Hs)throw new Error("invZ was invalid");return{x:a,y:l}})),w=ws((e=>{let{a:r,d:n}=t;if(e.is0())throw new Error("bad point: ZERO");let{ex:i,ey:s,ez:o,et:a}=e,l=u(i*i),c=u(s*s),h=u(o*o),d=u(h*h),f=u(l*r);if(u(h*u(f+c))!==u(d+u(n*u(l*c))))throw new Error("bad point: equation left != right (1)");if(u(i*s)!==u(o*a))throw new Error("bad point: equation left != right (2)");return!0}));class b{constructor(e,t,r,n){this.ex=e,this.ey=t,this.ez=r,this.et=n,g("x",e),g("y",t),g("z",r),g("t",n),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(e){if(e instanceof b)throw new Error("extended point not allowed");let{x:t,y:r}=e||{};return g("x",t),g("y",r),new b(t,r,Hs,u(t*r))}static normalizeZ(e){let t=r.invertBatch(e.map((e=>e.ez)));return e.map(((e,r)=>e.toAffine(t[r]))).map(b.fromAffine)}static msm(e,t){return $s(b,h,e,t)}_setWindowSize(e){S.setWindowSize(this,e)}assertValidity(){w(this)}equals(e){m(e);let{ex:t,ey:r,ez:n}=this,{ex:i,ey:s,ez:o}=e,a=u(t*o),l=u(i*n),c=u(r*o),h=u(s*n);return a===l&&c===h}is0(){return this.equals(b.ZERO)}negate(){return new b(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){let{a:e}=t,{ex:r,ey:n,ez:i}=this,s=u(r*r),o=u(n*n),a=u(qs*u(i*i)),l=u(e*s),c=r+n,h=u(u(c*c)-s-o),d=l+o,f=d-a,p=l-o,g=u(h*f),m=u(d*p),y=u(h*p),w=u(f*d);return new b(g,m,w,y)}add(e){m(e);let{a:r,d:n}=t,{ex:i,ey:s,ez:o,et:a}=this,{ex:l,ey:c,ez:h,et:d}=e;if(r===BigInt(-1)){let e=u((s-i)*(c+l)),t=u((s+i)*(c-l)),r=u(t-e);if(r===Ks)return this.double();let n=u(o*qs*d),f=u(a*qs*h),p=f+n,g=t+e,m=f-n,y=u(p*r),w=u(g*m),E=u(p*m),v=u(r*g);return new b(y,w,v,E)}let f=u(i*l),p=u(s*c),g=u(a*n*d),y=u(o*h),w=u((i+s)*(l+c)-f-p),E=y-g,v=y+g,S=u(p-r*f),R=u(w*E),A=u(v*S),_=u(w*S),I=u(E*v);return new b(R,A,I,_)}subtract(e){return this.add(e.negate())}wNAF(e){return S.wNAFCached(this,e,b.normalizeZ)}multiply(e){let t=e;as("scalar",t,Hs,n);let{p:r,f:i}=this.wNAF(t);return b.normalizeZ([r,i])[0]}multiplyUnsafe(e){let t=e;return as("scalar",t,Ks,n),t===Ks?v:this.equals(v)||t===Hs?this:this.equals(E)?this.wNAF(t).p:S.unsafeLadder(this,t)}isSmallOrder(){return this.multiplyUnsafe(l).is0()}isTorsionFree(){return S.unsafeLadder(this,n).is0()}toAffine(e){return y(this,e)}clearCofactor(){let{h:e}=t;return e===Hs?this:this.multiplyUnsafe(e)}static fromHex(e,n=!1){let{d:i,a:s}=t,o=r.BYTES;e=ts("pointHex",e,o),Ki("zip215",n);let a=e.slice(),l=e[o-1];a[o-1]=-129&l;let h=Ji(a),f=n?c:r.ORDER;as("pointHex.y",h,Ks,f);let p=u(h*h),g=u(p-Hs),m=u(i*p-s),{isValid:y,value:w}=d(g,m);if(!y)throw new Error("Point.fromHex: invalid y coordinate");let E=(w&Hs)===Hs,v=!!(128&l);if(!n&&w===Ks&&v)throw new Error("Point.fromHex: x=0 and x_0=1");return v!==E&&(w=u(-w)),b.fromAffine({x:w,y:h})}static fromPrivateKey(e){return _(e).point}toRawBytes(){let{x:e,y:t}=this.toAffine(),n=Xi(t,r.BYTES);return n[n.length-1]|=e&Hs?128:0,n}toHex(){return qi(this.toRawBytes())}}b.BASE=new b(t.Gx,t.Gy,Hs,u(t.Gx*t.Gy)),b.ZERO=new b(Ks,Hs,Hs,Ks);let{BASE:E,ZERO:v}=b,S=Fs(b,8*a);function R(e){return Is(e,n)}function A(e){return R(Ji(e))}function _(e){let t=a;e=ts("private key",e,t);let r=ts("hashed private key",s(e),2*t),n=f(r.slice(0,t)),i=r.slice(t,2*t),o=A(n),l=E.multiply(o),c=l.toRawBytes();return{head:n,prefix:i,scalar:o,point:l,pointBytes:c}}function I(e=new Uint8Array,...t){let r=rs(...t);return A(s(p(r,ts("context",e),!!i)))}let k=Ws;return E._setWindowSize(8),{CURVE:t,getPublicKey:function(e){return _(e).pointBytes},sign:function(e,t,s={}){e=ts("message",e),i&&(e=i(e));let{prefix:o,scalar:l,pointBytes:c}=_(t),u=I(s.context,o,e),h=E.multiply(u).toRawBytes(),d=R(u+I(s.context,h,c,e)*l);return as("signature.s",d,Ks,n),ts("result",rs(h,Xi(d,r.BYTES)),2*a)},verify:function(e,t,n,s=k){let{context:o,zip215:a}=s,l=r.BYTES;e=ts("signature",e,2*l),t=ts("message",t),void 0!==a&&Ki("zip215",a),i&&(t=i(t));let c,u,h,d=Ji(e.slice(l,2*l));try{c=b.fromHex(n,a),u=b.fromHex(e.slice(0,l),a),h=E.multiplyUnsafe(d)}catch{return!1}if(!a&&c.isSmallOrder())return!1;let f=I(o,u.toRawBytes(),c.toRawBytes(),t);return u.add(c.multiplyUnsafe(f)).subtract(h).clearCofactor().equals(b.ZERO)},ExtendedPoint:b,utils:{getExtendedPublicKey:_,randomPrivateKey:()=>o(r.BYTES),precompute:(e=8,t=b.BASE)=>(t._setWindowSize(e),t.multiply(BigInt(3)),t)}}}(so),ao=function(e){let t=function(e){return ms(e,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...e})}(e),{P:r}=t,n=e=>Is(e,r),i=t.montgomeryBits,s=Math.ceil(i/8),o=t.nByteLength,a=t.adjustScalarBytes||(e=>e),l=t.powPminus2||(e=>ks(e,r-BigInt(2),r));function c(e,t,r){let i=n(e*(t-r));return[t=n(t-i),r=n(r+i)]}let u=(t.a-BigInt(2))/BigInt(4);function h(e){return Xi(n(e),s)}function d(e,t){let d=function(e){let t=ts("u coordinate",e,s);return 32===o&&(t[31]&=127),Ji(t)}(t),f=function(e){let t=ts("scalar",e),r=t.length;if(r!==s&&r!==o)throw new Error(`Expected ${s} or ${o} bytes, got ${r}`);return Ji(a(t))}(e),p=function(e,t){as("u",e,js,r),as("scalar",t,js,r);let s,o=t,a=e,h=Gs,d=js,f=e,p=Gs,g=js;for(let e=BigInt(i-1);e>=js;e--){let t=o>>e&Gs;g^=t,s=c(g,h,f),h=s[0],f=s[1],s=c(g,d,p),d=s[0],p=s[1],g=t;let r=h+d,i=n(r*r),l=h-d,m=n(l*l),y=i-m,w=f+p,b=n((f-p)*r),E=n(w*l),v=b+E,S=b-E;f=n(v*v),p=n(a*n(S*S)),h=n(i*m),d=n(y*(i+n(u*y)))}s=c(g,h,f),h=s[0],f=s[1],s=c(g,d,p),d=s[0],p=s[1];let m=l(d);return n(h*m)}(d,f);if(p===js)throw new Error("Invalid private or public key received");return h(p)}let f=h(t.Gu);function p(e){return d(e,f)}return{scalarMult:d,scalarMultBase:p,getSharedSecret:(e,t)=>d(e,t),getPublicKey:e=>p(e),utils:{randomPrivateKey:()=>t.randomBytes(t.nByteLength)},GuBytes:f}}({P:Ys,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:e=>{let t=Ys,{pow_p_5_8:r,b2:n}=ro(e);return Is(Ts(r,Xs,t)*n,t)},adjustScalarBytes:no,randomBytes:vi}),lo=32,co=64,uo=32;function ho(e,t){let r=new Uint8Array(co);for(let n=0;n<uo;n++)r[n]=e[n],r[uo+n]=t[n];return r}var fo={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function po(e){let t=e?.algorithm??"AES-GCM",r=e?.keyLength??16,n=e?.nonceLength??12,i=e?.digest??"SHA-256",s=e?.saltLength??16,o=e?.iterations??32767,a=ei.get();return r*=8,{encrypt:async function(e,l){let c,u=a.getRandomValues(new Uint8Array(s)),h=a.getRandomValues(new Uint8Array(n)),d={name:t,iv:h};if("string"==typeof l&&(l=en(l)),0===l.length){c=await a.subtle.importKey("jwk",fo,{name:"AES-GCM"},!0,["encrypt"]);try{let e={name:"PBKDF2",salt:u,iterations:o,hash:{name:i}},n=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);c=await a.subtle.deriveKey(e,n,{name:t,length:r},!0,["encrypt"])}catch{c=await a.subtle.importKey("jwk",fo,{name:"AES-GCM"},!0,["encrypt"])}}else{let e={name:"PBKDF2",salt:u,iterations:o,hash:{name:i}},n=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);c=await a.subtle.deriveKey(e,n,{name:t,length:r},!0,["encrypt"])}let f=await a.subtle.encrypt(d,c,e);return Ie([u,d.iv,new Uint8Array(f)])},decrypt:async function(e,l){let c,u=e.subarray(0,s),h=e.subarray(s,s+n),d=e.subarray(s+n),f={name:t,iv:h};if("string"==typeof l&&(l=en(l)),0===l.length)try{let e={name:"PBKDF2",salt:u,iterations:o,hash:{name:i}},n=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);c=await a.subtle.deriveKey(e,n,{name:t,length:r},!0,["decrypt"])}catch{c=await a.subtle.importKey("jwk",fo,{name:"AES-GCM"},!0,["decrypt"])}else{let e={name:"PBKDF2",salt:u,iterations:o,hash:{name:i}},n=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);c=await a.subtle.deriveKey(e,n,{name:t,length:r},!0,["decrypt"])}let p=await a.subtle.decrypt(f,c,d);return new Uint8Array(p)}}}async function go(e,t){let r=await po().encrypt(e,t);return rr.encode(r)}var mo,yo,wo,bo,Eo={};a(Eo,{KeyType:()=>mo,PrivateKey:()=>bo,PublicKey:()=>wo}),function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(mo||(mo={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(yo||(yo={})),function(e){e.codec=()=>wn(yo)}(mo||(mo={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),mo.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.Type=mo.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(wo||(wo={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),mo.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.Type=mo.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(bo||(bo={}));var vo=class{_key;constructor(e){this._key=ko(e,lo)}verify(e,t){return function(e,t,r){return oo.verify(t,r instanceof Uint8Array?r:r.subarray(),e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return wo.encode({Type:mo.Ed25519,Data:this.marshal()}).subarray()}equals(e){return ke(this.bytes,e.bytes)}hash(){let e=Fr.digest(this.bytes);return oi(e)?e.then((({bytes:e})=>e)):e.bytes}},So=class{_key;_publicKey;constructor(e,t){this._key=ko(e,co),this._publicKey=ko(t,lo)}sign(e){return function(e,t){let r=e.subarray(0,uo);return oo.sign(t instanceof Uint8Array?t:t.subarray(),r)}(this._key,e)}get public(){return new vo(this._publicKey)}marshal(){return this._key}get bytes(){return bo.encode({Type:mo.Ed25519,Data:this.marshal()}).subarray()}equals(e){return ke(this.bytes,e.bytes)}async hash(){let e,t=Fr.digest(this.bytes);return oi(t)?({bytes:e}=await t):e=t.bytes,e}async id(){let e=Or.digest(this.public.bytes);return Xt.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if("libp2p-key"===t)return go(this.bytes,e);throw new U(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function Ro(e){if(e.length>co){let t=(e=ko(e,co+lo)).subarray(0,co),r=e.subarray(co,e.length);return new So(t,r)}let t=(e=ko(e,co)).subarray(0,co),r=e.subarray(lo);return new So(t,r)}function Ao(e){return e=ko(e,lo),new vo(e)}async function _o(){let{privateKey:e,publicKey:t}=function(){let e=oo.utils.randomPrivateKey(),t=oo.getPublicKey(e);return{privateKey:ho(e,t),publicKey:t}}();return new So(e,t)}async function Io(e){let{privateKey:t,publicKey:r}=function(e){if(e.length!==uo)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let t=e,r=oo.getPublicKey(t);return{privateKey:ho(t,r),publicKey:r}}(e);return new So(t,r)}function ko(e,t){if((e=Uint8Array.from(e??[])).length!==t)throw new U(`Key must be a Uint8Array of length ${t}, got ${e.length}`,"ERR_INVALID_KEY_TYPE");return e}var To={"P-256":256,"P-384":384,"P-521":521},Co=Object.keys(To).join(" / "),Do={"P-256":32,"P-384":48,"P-521":66};function xo(e){if(null==e.crv||null==e.x||null==e.y)throw new U("JWK was missing components","ERR_INVALID_PARAMETERS");if("P-256"!==e.crv&&"P-384"!==e.crv&&"P-521"!==e.crv)throw new U(`Unknown curve: ${e.crv}. Must be ${Co}`,"ERR_INVALID_CURVE");let t=Do[e.crv];return Ie([Uint8Array.from([4]),si(e.x,t),si(e.y,t)],1+2*t)}function No(e,t){if("P-256"!==e&&"P-384"!==e&&"P-521"!==e)throw new U(`Unknown curve: ${e}. Must be ${Co}`,"ERR_INVALID_CURVE");let r=Do[e];if(!ke(t.subarray(0,1),Uint8Array.from([4])))throw new U("Cannot unmarshal public key - invalid key format","ERR_INVALID_KEY_FORMAT");return{kty:"EC",crv:e,x:Bn(t.subarray(1,r+1),"base64url"),y:Bn(t.subarray(1+r),"base64url"),ext:!0}}var Po=async function(e){if("P-256"!==e&&"P-384"!==e&&"P-521"!==e)throw new U(`Unknown curve: ${e}. Must be ${Co}`,"ERR_INVALID_CURVE");let t=await ei.get().subtle.generateKey({name:"ECDH",namedCurve:e},!0,["deriveBits"]);return{key:xo(await ei.get().subtle.exportKey("jwk",t.publicKey)),genSharedKey:async(r,n)=>{let i;i=null!=n?await ei.get().subtle.importKey("jwk",((e,t)=>({...No(e,t.public),d:Bn(t.private,"base64url")}))(e,n),{name:"ECDH",namedCurve:e},!1,["deriveBits"]):t.privateKey;let s=await ei.get().subtle.importKey("jwk",No(e,r),{name:"ECDH",namedCurve:e},!1,[]),o=await ei.get().subtle.deriveBits({name:"ECDH",namedCurve:e,public:s},i,To[e]);return new Uint8Array(o,0,o.byteLength)}}},Lo={"AES-128":{ivSize:16,keySize:16},"AES-256":{ivSize:16,keySize:32},Blowfish:{ivSize:8,keySize:32}};async function Oo(e,t,r){let n=Lo[e];if(null==n){let t=Object.keys(Lo).join(" / ");throw new U(`unknown cipher type '${e}'. Must be ${t}`,"ERR_INVALID_CIPHER_TYPE")}if(null==t)throw new U("missing hash type","ERR_MISSING_HASH_TYPE");let i=n.keySize,s=n.ivSize,o=en("key expansion"),a=2*(s+i+20),l=await async function(e,t){let r=ri[e],n=await ei.get().subtle.importKey("raw",t,{name:"HMAC",hash:{name:r}},!1,["sign"]);return{digest:async e=>(async(e,t)=>{let r=await ei.get().subtle.sign({name:"HMAC"},e,t);return new Uint8Array(r,0,r.byteLength)})(n,e),length:ti[e]}}(t,r),c=await l.digest(o),u=[],h=0;for(;h<a;){let e=await l.digest(Ie([c,o])),t=e.length;h+t>a&&(t=a-h),u.push(e),h+=t,c=await l.digest(c)}let d=a/2,f=Ie(u),p=f.subarray(0,d),g=f.subarray(d,a),m=e=>({iv:e.subarray(0,s),cipherKey:e.subarray(s,s+i),macKey:e.subarray(s+i)});return{k1:m(p),k2:m(g)}}var Bo={};function Mo(e){if(isNaN(e)||e<=0)throw new U("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return vi(e)}a(Bo,{MAX_RSA_KEY_SIZE:()=>fc,RsaPrivateKey:()=>gc,RsaPublicKey:()=>pc,fromJwk:()=>wc,generateKeyPair:()=>bc,unmarshalRsaPrivateKey:()=>mc,unmarshalRsaPublicKey:()=>yc});var Uo={};a(Uo,{exportToPem:()=>sc,importFromPem:()=>oc,jwkToPkcs1:()=>Jl,jwkToPkix:()=>Xl,pkcs1ToJwk:()=>Ql,pkixToJwk:()=>Zl});var Fo=class extends wi{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,ci(e);let r=yi(t);if(this.iHash=e.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,i=new Uint8Array(n);i.set(r.length>n?e.create().update(r).digest():r);for(let e=0;e<i.length;e++)i[e]^=54;this.iHash.update(i),this.oHash=e.create();for(let e=0;e<i.length;e++)i[e]^=106;this.oHash.update(i),i.fill(0)}update(e){return ui(this),this.iHash.update(e),this}digestInto(e){ui(this),li(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:r,finished:n,destroyed:i,blockLen:s,outputLen:o}=this;return e.finished=n,e.destroyed=i,e.blockLen=s,e.outputLen=o,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},$o=(e,t,r)=>new Fo(e,t).update(r).digest();function Vo(e,t,r,n){ci(e);let i=function(e,t){if(void 0!==t&&"[object Object]"!==bi.call(t))throw new Error("Options should be object or undefined");return Object.assign({dkLen:32,asyncTick:10},t)}(0,n),{c:s,dkLen:o,asyncTick:a}=i;if(ai(s),ai(o),ai(a),s<1)throw new Error("PBKDF2: iterations (c) should be >= 1");let l=yi(t),c=yi(r),u=new Uint8Array(o),h=$o.create(e,l),d=h._cloneInto().update(c);return{c:s,dkLen:o,asyncTick:a,DK:u,PRF:h,PRFSalt:d}}function Ko(e,t,r,n,i){return e.destroy(),t.destroy(),n&&n.destroy(),i.fill(0),r}async function Ho(e,t,r,n){let i,{c:s,dkLen:o,asyncTick:a,DK:l,PRF:c,PRFSalt:u}=Vo(e,t,r,n),h=new Uint8Array(4),d=di(h),f=new Uint8Array(c.outputLen);for(let e=1,t=0;t<o;e++,t+=c.outputLen){let r=l.subarray(t,t+c.outputLen);d.setInt32(0,e,!1),(i=u._cloneInto(i)).update(h).digestInto(f),r.set(f.subarray(0,r.length)),await mi(s-1,a,(()=>{c._cloneInto(i).update(f).digestInto(f);for(let e=0;e<r.length;e++)r[e]^=f[e]}))}return Ko(c,u,l,i,f)}$o.create=(e,t)=>new Fo(e,t);var qo=c(u());function zo(e,t){let r=0;if(1===e.length)return e[0];for(let n=e.length-1;n>=0;n--)r+=e[e.length-1-n]*Math.pow(2,t*n);return r}function Wo(e,t,r=-1){let n=r,i=e,s=0,o=Math.pow(2,t);for(let r=1;r<8;r++){if(e<o){let e;if(n<0)e=new ArrayBuffer(r),s=r;else{if(n<r)return new ArrayBuffer(0);e=new ArrayBuffer(n),s=n}let o=new Uint8Array(e);for(let e=r-1;e>=0;e--){let r=Math.pow(2,e*t);o[s-e-1]=Math.floor(i/r),i-=o[s-e-1]*r}return e}o*=Math.pow(2,t)}return new ArrayBuffer(0)}function jo(...e){let t=0,r=0;for(let r of e)t+=r.length;let n=new ArrayBuffer(t),i=new Uint8Array(n);for(let t of e)i.set(t,r),r+=t.length;return i}function Go(){let e=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let t=255===e[0]&&128&e[1],r=0===e[0]&&!(128&e[1]);(t||r)&&this.warnings.push("Needlessly long format")}let t=new ArrayBuffer(this.valueHex.byteLength),r=new Uint8Array(t);for(let e=0;e<this.valueHex.byteLength;e++)r[e]=0;r[0]=128&e[0];let n=zo(r,8),i=new ArrayBuffer(this.valueHex.byteLength),s=new Uint8Array(i);for(let t=0;t<this.valueHex.byteLength;t++)s[t]=e[t];return s[0]&=127,zo(s,8)-n}function Yo(e,t){let r=e.toString(10);if(t<r.length)return"";let n=t-r.length,i=new Array(n);for(let e=0;e<n;e++)i[e]="0";return i.join("").concat(r)}function Qo(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Jo(e){let t=0,r=0;for(let r=0;r<e.length;r++)t+=e[r].byteLength;let n=new Uint8Array(t);for(let t=0;t<e.length;t++){let i=e[t];n.set(new Uint8Array(i),r),r+=i.byteLength}return n.buffer}function Zo(e,t,r,n){return t instanceof Uint8Array?t.byteLength?r<0?(e.error="Wrong parameter: inputOffset less than zero",!1):n<0?(e.error="Wrong parameter: inputLength less than zero",!1):!(t.byteLength-r-n<0&&(e.error="End of input reached before message was fully decoded (inconsistent offset and length values)",1)):(e.error="Wrong parameter: inputBuffer has zero length",!1):(e.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}Math.log(2);var Xo=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return Jo(this.items)}},ea=[new Uint8Array([1])],ta="0123456789",ra=new ArrayBuffer(0),na=new Uint8Array(0),ia="EndOfContent",sa="OCTET STRING",oa="BIT STRING";function aa(e){var t;return(t=class extends e{constructor(...e){var t;super(...e);let r=e[0]||{};this.isHexOnly=null!==(t=r.isHexOnly)&&void 0!==t&&t,this.valueHexView=r.valueHex?qo.BufferSourceConverter.toUint8Array(r.valueHex):na}get valueHex(){return this.valueHexView.slice().buffer}set valueHex(e){this.valueHexView=new Uint8Array(e)}fromBER(e,t,r){let n=e instanceof ArrayBuffer?new Uint8Array(e):e;if(!Zo(this,n,t,r))return-1;let i=t+r;return this.valueHexView=n.subarray(t,i),this.valueHexView.length?(this.blockLength=r,i):(this.warnings.push("Zero buffer length"),t)}toBER(e=!1){return this.isHexOnly?e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",ra)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:qo.Convert.ToHex(this.valueHexView)}}}).NAME="hexBlock",t}var la=class{constructor({blockLength:e=0,error:t="",warnings:r=[],valueBeforeDecode:n=na}={}){this.blockLength=e,this.error=t,this.warnings=r,this.valueBeforeDecodeView=qo.BufferSourceConverter.toUint8Array(n)}static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:qo.Convert.ToHex(this.valueBeforeDecodeView)}}};la.NAME="baseBlock";var ca=class extends la{fromBER(e,t,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};ca.NAME="valueBlock";var ua=class extends(aa(la)){constructor({idBlock:e={}}={}){var t,r,n,i;super(),e?(this.isHexOnly=null!==(t=e.isHexOnly)&&void 0!==t&&t,this.valueHexView=e.valueHex?qo.BufferSourceConverter.toUint8Array(e.valueHex):na,this.tagClass=null!==(r=e.tagClass)&&void 0!==r?r:-1,this.tagNumber=null!==(n=e.tagNumber)&&void 0!==n?n:-1,this.isConstructed=null!==(i=e.isConstructed)&&void 0!==i&&i):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",ra}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let r=new Uint8Array(1);if(!e){let e=this.tagNumber;e&=31,t|=e,r[0]=t}return r.buffer}if(!this.isHexOnly){let r=Wo(this.tagNumber,7),n=new Uint8Array(r),i=r.byteLength,s=new Uint8Array(i+1);if(s[0]=31|t,!e){for(let e=0;e<i-1;e++)s[e+1]=128|n[e];s[i]=n[i-1]}return s.buffer}let r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=31|t,!e){let e=this.valueHexView;for(let t=0;t<e.length-1;t++)r[t+1]=128|e[t];r[this.valueHexView.byteLength]=e[e.length-1]}return r.buffer}fromBER(e,t,r){let n=qo.BufferSourceConverter.toUint8Array(e);if(!Zo(this,n,t,r))return-1;let i=n.subarray(t,t+r);if(0===i.length)return this.error="Zero buffer length",-1;switch(192&i[0]){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=!(32&~i[0]),this.isHexOnly=!1;let s=31&i[0];if(31!==s)this.tagNumber=s,this.blockLength=1;else{let e=1,t=this.valueHexView=new Uint8Array(255),r=255;for(;128&i[e];){if(t[e-1]=127&i[e],e++,e>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(e===r){r+=255;let e=new Uint8Array(r);for(let r=0;r<t.length;r++)e[r]=t[r];t=this.valueHexView=new Uint8Array(r)}}this.blockLength=e+1,t[e-1]=127&i[e];let n=new Uint8Array(e);for(let r=0;r<e;r++)n[r]=t[r];t=this.valueHexView=new Uint8Array(e),t.set(n),this.blockLength<=9?this.tagNumber=zo(t,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(1===this.tagClass&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};ua.NAME="identificationBlock";var ha=class extends la{constructor({lenBlock:e={}}={}){var t,r,n;super(),this.isIndefiniteForm=null!==(t=e.isIndefiniteForm)&&void 0!==t&&t,this.longFormUsed=null!==(r=e.longFormUsed)&&void 0!==r&&r,this.length=null!==(n=e.length)&&void 0!==n?n:0}fromBER(e,t,r){let n=qo.BufferSourceConverter.toUint8Array(e);if(!Zo(this,n,t,r))return-1;let i=n.subarray(t,t+r);if(0===i.length)return this.error="Zero buffer length",-1;if(255===i[0])return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=128===i[0],this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(128&i[0]),!1===this.longFormUsed)return this.length=i[0],this.blockLength=1,t+this.blockLength;let s=127&i[0];if(s>8)return this.error="Too big integer",-1;if(s+1>i.length)return this.error="End of input reached before message was fully decoded",-1;let o=t+1,a=n.subarray(o,o+s);return 0===a[s-1]&&this.warnings.push("Needlessly long encoded length"),this.length=zo(a,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=s+1,t+this.blockLength}toBER(e=!1){let t,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),!1===e&&(r=new Uint8Array(t),r[0]=128),t;if(this.longFormUsed){let n=Wo(this.length,8);if(n.byteLength>127)return this.error="Too big length",ra;if(t=new ArrayBuffer(n.byteLength+1),e)return t;let i=new Uint8Array(n);r=new Uint8Array(t),r[0]=128|n.byteLength;for(let e=0;e<n.byteLength;e++)r[e+1]=i[e];return t}return t=new ArrayBuffer(1),!1===e&&(r=new Uint8Array(t),r[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};ha.NAME="lengthBlock";var da={},fa=class extends la{constructor({name:e="",optional:t=!1,primitiveSchema:r,...n}={},i){super(n),this.name=e,this.optional=t,r&&(this.primitiveSchema=r),this.idBlock=new ua(n),this.lenBlock=new ha(n),this.valueBlock=i?new i(n):new ca(n)}fromBER(e,t,r){let n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return-1===n?(this.error=this.valueBlock.error,n):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),n)}toBER(e,t){let r=t||new Xo;t||pa(this);let n=this.idBlock.toBER(e);if(r.write(n),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,r),r.write(new ArrayBuffer(2));else{let t=this.valueBlock.toBER(e);this.lenBlock.length=t.byteLength;let n=this.lenBlock.toBER(e);r.write(n),r.write(t)}return t?ra:r.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return"ascii"===e?this.onAsciiEncoding():qo.Convert.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${qo.Convert.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(e){return this===e||e instanceof this.constructor&&function(e,t){if(e.byteLength!==t.byteLength)return!1;let r=new Uint8Array(e),n=new Uint8Array(t);for(let e=0;e<r.length;e++)if(r[e]!==n[e])return!1;return!0}(this.toBER(),e.toBER())}};function pa(e){if(e instanceof da.Constructed)for(let t of e.valueBlock.value)pa(t)&&(e.lenBlock.isIndefiniteForm=!0);return!!e.lenBlock.isIndefiniteForm}fa.NAME="BaseBlock";var ga=class extends fa{constructor({value:e="",...t}={},r){super(t,r),e&&this.fromString(e)}getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}fromBER(e,t,r){let n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return-1===n?(this.error=this.valueBlock.error,n):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),n)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};ga.NAME="BaseStringBlock";var ma=class extends(aa(ca)){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};ma.NAME="PrimitiveValueBlock";var ya,wa=class extends fa{constructor(e={}){super(e,ma),this.idBlock.isConstructed=!1}};function ba(e,t=0,r=e.length){let n=t,i=new fa({},ca),s=new la;if(!Zo(s,e,t,r))return i.error=s.error,{offset:-1,result:i};if(!e.subarray(t,t+r).length)return i.error="Zero buffer length",{offset:-1,result:i};let o=i.idBlock.fromBER(e,t,r);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),-1===o)return i.error=i.idBlock.error,{offset:-1,result:i};if(t=o,r-=i.idBlock.blockLength,o=i.lenBlock.fromBER(e,t,r),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),-1===o)return i.error=i.lenBlock.error,{offset:-1,result:i};if(t=o,r-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let a=fa;if(1===i.idBlock.tagClass){if(i.idBlock.tagNumber>=37&&!1===i.idBlock.isHexOnly)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};a=da.EndOfContent;break;case 1:a=da.Boolean;break;case 2:a=da.Integer;break;case 3:a=da.BitString;break;case 4:a=da.OctetString;break;case 5:a=da.Null;break;case 6:a=da.ObjectIdentifier;break;case 10:a=da.Enumerated;break;case 12:a=da.Utf8String;break;case 13:a=da.RelativeObjectIdentifier;break;case 14:a=da.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:a=da.Sequence;break;case 17:a=da.Set;break;case 18:a=da.NumericString;break;case 19:a=da.PrintableString;break;case 20:a=da.TeletexString;break;case 21:a=da.VideotexString;break;case 22:a=da.IA5String;break;case 23:a=da.UTCTime;break;case 24:a=da.GeneralizedTime;break;case 25:a=da.GraphicString;break;case 26:a=da.VisibleString;break;case 27:a=da.GeneralString;break;case 28:a=da.UniversalString;break;case 29:a=da.CharacterString;break;case 30:a=da.BmpString;break;case 31:a=da.DATE;break;case 32:a=da.TimeOfDay;break;case 33:a=da.DateTime;break;case 34:a=da.Duration;break;default:{let e=i.idBlock.isConstructed?new da.Constructed:new da.Primitive;e.idBlock=i.idBlock,e.lenBlock=i.lenBlock,e.warnings=i.warnings,i=e}}}else a=i.idBlock.isConstructed?da.Constructed:da.Primitive;return i=function(e,t){if(e instanceof t)return e;let r=new t;return r.idBlock=e.idBlock,r.lenBlock=e.lenBlock,r.warnings=e.warnings,r.valueBeforeDecodeView=e.valueBeforeDecodeView,r}(i,a),o=i.fromBER(e,t,i.lenBlock.isIndefiniteForm?r:i.lenBlock.length),i.valueBeforeDecodeView=e.subarray(n,n+i.blockLength),{offset:o,result:i}}function Ea(e){if(!e.byteLength){let e=new fa({},ca);return e.error="Input buffer has zero length",{offset:-1,result:e}}return ba(qo.BufferSourceConverter.toUint8Array(e).slice(),0,e.byteLength)}function va(e,t){return e?1:t}ya=wa,da.Primitive=ya,wa.NAME="PRIMITIVE";var Sa=class extends ca{constructor({value:e=[],isIndefiniteForm:t=!1,...r}={}){super(r),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,r){let n=qo.BufferSourceConverter.toUint8Array(e);if(!Zo(this,n,t,r))return-1;if(this.valueBeforeDecodeView=n.subarray(t,t+r),0===this.valueBeforeDecodeView.length)return this.warnings.push("Zero buffer length"),t;let i=t;for(;va(this.isIndefiniteForm,r)>0;){let e=ba(n,i,r);if(-1===e.offset)return this.error=e.result.error,this.warnings.concat(e.result.warnings),-1;if(i=e.offset,this.blockLength+=e.result.blockLength,r-=e.result.blockLength,this.value.push(e.result),this.isIndefiniteForm&&e.result.constructor.NAME===ia)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===ia?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){let r=t||new Xo;for(let t=0;t<this.value.length;t++)this.value[t].toBER(e,r);return t?ra:r.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};Sa.NAME="ConstructedValueBlock";var Ra,Aa=class extends fa{constructor(e={}){super(e,Sa),this.idBlock.isConstructed=!0}fromBER(e,t,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return-1===n?(this.error=this.valueBlock.error,n):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),n)}onAsciiEncoding(){let e=[];for(let t of this.valueBlock.value)e.push(t.toString("ascii").split("\n").map((e=>`  ${e}`)).join("\n"));let t=3===this.idBlock.tagClass?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :\n${e.join("\n")}`:`${t} :`}};Ra=Aa,da.Constructed=Ra,Aa.NAME="CONSTRUCTED";var _a=class extends ca{fromBER(e,t,r){return t}toBER(e){return ra}};_a.override="EndOfContentValueBlock";var Ia,ka=class extends fa{constructor(e={}){super(e,_a),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};Ia=ka,da.EndOfContent=Ia,ka.NAME=ia;var Ta,Ca=class extends fa{constructor(e={}){super(e,ca),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,t+r>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+r}toBER(e,t){let r=new ArrayBuffer(2);if(!e){let e=new Uint8Array(r);e[0]=5,e[1]=0}return t&&t.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}};Ta=Ca,da.Null=Ta,Ca.NAME="NULL";var Da=class extends(aa(ca)){constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=qo.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}fromBER(e,t,r){let n=qo.BufferSourceConverter.toUint8Array(e);return Zo(this,n,t,r)?(this.valueHexView=n.subarray(t,t+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,Go.call(this),this.blockLength=r,t+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};Da.NAME="BooleanValueBlock";var xa,Na=class extends fa{constructor(e={}){super(e,Da),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};xa=Na,da.Boolean=xa,Na.NAME="BOOLEAN";var Pa=class extends(aa(Sa)){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,r){let n=0;if(this.isConstructed){if(this.isHexOnly=!1,n=Sa.prototype.fromBER.call(this,e,t,r),-1===n)return n;for(let e=0;e<this.value.length;e++){let t=this.value[e].constructor.NAME;if(t===ia){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(t!==sa)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,n=super.fromBER(e,t,r),this.blockLength=r;return n}toBER(e,t){return this.isConstructed?Sa.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};Pa.NAME="OctetStringValueBlock";var La,Oa=class e extends fa{constructor({idBlock:e={},lenBlock:t={},...r}={}){var n,i;null!==(n=r.isConstructed)&&void 0!==n||(r.isConstructed=!(null===(i=r.value)||void 0===i||!i.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},Pa),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,0===r)return 0===this.idBlock.error.length&&(this.blockLength+=this.idBlock.blockLength),0===this.lenBlock.error.length&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let n=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+r);try{if(n.byteLength){let e=ba(n,0,n.byteLength);-1!==e.offset&&e.offset===r&&(this.valueBlock.value=[e.result])}}catch{}}return super.fromBER(e,t,r)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?Aa.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${qo.Convert.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let t=[];for(let r of this.valueBlock.value)r instanceof e&&t.push(r.valueBlock.valueHexView);return qo.BufferSourceConverter.concat(t)}};La=Oa,da.OctetString=La,Oa.NAME=sa;var Ba=class extends(aa(Sa)){constructor({unusedBits:e=0,isConstructed:t=!1,...r}={}){super(r),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,r){if(!r)return t;let n=-1;if(this.isConstructed){if(n=Sa.prototype.fromBER.call(this,e,t,r),-1===n)return n;for(let e of this.value){let t=e.constructor.NAME;if(t===ia){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(t!==oa)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let r=e.valueBlock;if(this.unusedBits>0&&r.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=r.unusedBits}return n}let i=qo.BufferSourceConverter.toUint8Array(e);if(!Zo(this,i,t,r))return-1;let s=i.subarray(t,t+r);if(this.unusedBits=s[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let e=s.subarray(1);try{if(e.byteLength){let t=ba(e,0,e.byteLength);-1!==t.offset&&t.offset===r-1&&(this.value=[t.result])}}catch{}}return this.valueHexView=s.subarray(1),this.blockLength=s.length,t+r}toBER(e,t){if(this.isConstructed)return Sa.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return ra;let r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};Ba.NAME="BitStringValueBlock";var Ma,Ua,Fa=class extends fa{constructor({idBlock:e={},lenBlock:t={},...r}={}){var n,i;null!==(n=r.isConstructed)&&void 0!==n||(r.isConstructed=!(null===(i=r.value)||void 0===i||!i.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},Ba),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Aa.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let r of t)e.push(r.toString(2).padStart(8,"0"));let r=e.join("");return`${this.constructor.NAME} : ${r.substring(0,r.length-this.valueBlock.unusedBits)}`}}};function $a(e,t){let r=new Uint8Array([0]),n=new Uint8Array(e),i=new Uint8Array(t),s=n.slice(0),o=s.length-1,a=i.slice(0),l=a.length-1,c=0,u=0;for(let e=l<o?o:l;e>=0;e--,u++)c=1==u<a.length?s[o-u]+a[l-u]+r[0]:s[o-u]+r[0],r[0]=c/10,1==u>=s.length?s=jo(new Uint8Array([c%10]),s):s[o-u]=c%10;return r[0]>0&&(s=jo(r,s)),s}function Va(e){if(e>=ea.length)for(let t=ea.length;t<=e;t++){let e=new Uint8Array([0]),r=ea[t-1].slice(0);for(let t=r.length-1;t>=0;t--){let n=new Uint8Array([(r[t]<<1)+e[0]]);e[0]=n[0]/10,r[t]=n[0]%10}e[0]>0&&(r=jo(e,r)),ea.push(r)}return ea[e]}function Ka(e,t){let r,n=0,i=new Uint8Array(e),s=new Uint8Array(t),o=i.slice(0),a=o.length-1,l=s.slice(0),c=l.length-1,u=0;for(let e=c;e>=0;e--,u++)r=o[a-u]-l[c-u]-n,1==r<0?(n=1,o[a-u]=r+10):(n=0,o[a-u]=r);if(n>0)for(let e=a-c+1;e>=0;e--,u++){if(r=o[a-u]-n,!(r<0)){n=0,o[a-u]=r;break}n=1,o[a-u]=r+10}return o.slice()}Ma=Fa,da.BitString=Ma,Fa.NAME=oa;var Ha=class extends(aa(ca)){constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),void 0!==e&&(this.valueDec=e)}setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=Go.call(this)))}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(function(e){let t=e<0?-1*e:e,r=128;for(let n=1;n<8;n++){if(t<=r){if(e<0){let e=Wo(r-t,8,n);return new Uint8Array(e)[0]|=128,e}let i=Wo(t,8,n),s=new Uint8Array(i);if(128&s[0]){let e=i.slice(0),t=new Uint8Array(e);i=new ArrayBuffer(i.byteLength+1),s=new Uint8Array(i);for(let r=0;r<e.byteLength;r++)s[r+1]=t[r];s[0]=0}return i}r*=Math.pow(2,8)}return new ArrayBuffer(0)}(e))}get valueDec(){return this._valueDec}fromDER(e,t,r,n=0){let i=this.fromBER(e,t,r);if(-1===i)return i;let s=this.valueHexView;return 0===s[0]&&128&s[1]?this.valueHexView=s.subarray(1):0!==n&&s.length<n&&(n-s.length>1&&(n=s.length+1),this.valueHexView=s.subarray(n-s.length)),i}toDER(e=!1){let t=this.valueHexView;switch(!0){case!!(128&t[0]):{let e=new Uint8Array(this.valueHexView.length+1);e[0]=0,e.set(t,1),this.valueHexView=e}break;case 0===t[0]&&!(128&t[1]):this.valueHexView=this.valueHexView.subarray(1)}return this.toBER(e)}fromBER(e,t,r){let n=super.fromBER(e,t,r);return-1===n||this.setValueHex(),n}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e,t=8*this.valueHexView.length-1,r=new Uint8Array(8*this.valueHexView.length/3),n=0,i=this.valueHexView,s="",o=!1;for(let o=i.byteLength-1;o>=0;o--){e=i[o];for(let i=0;i<8;i++)1&~e||(n===t?(r=Ka(Va(n),r),s="-"):r=$a(r,Va(n))),n++,e>>=1}for(let e=0;e<r.length;e++)r[e]&&(o=!0),o&&(s+=ta.charAt(r[e]));return!1===o&&(s+=ta.charAt(0)),s}};Ua=Ha,Ha.NAME="IntegerValueBlock",Object.defineProperty(Ua.prototype,"valueHex",{set:function(e){this.valueHexView=new Uint8Array(e),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var qa,za=class e extends fa{constructor(e={}){super(e,Ha),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Qo(),BigInt(this.valueBlock.toString())}static fromBigInt(t){Qo();let r=BigInt(t),n=new Xo,i=r.toString(16).replace(/^-/,""),s=new Uint8Array(qo.Convert.FromHex(i));if(r<0){let e=new Uint8Array(s.length+(128&s[0]?1:0));e[0]|=128;let t=BigInt(`0x${qo.Convert.ToHex(e)}`)+r,i=qo.BufferSourceConverter.toUint8Array(qo.Convert.FromHex(t.toString(16)));i[0]|=128,n.write(i)}else 128&s[0]&&n.write(new Uint8Array([0])),n.write(s);return new e({valueHex:n.final()})}convertToDER(){let t=new e({valueHex:this.valueBlock.valueHexView});return t.valueBlock.toDER(),t}convertFromDER(){return new e({valueHex:0===this.valueBlock.valueHexView[0]?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};qa=za,da.Integer=qa,za.NAME="INTEGER";var Wa,ja=class extends za{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};Wa=ja,da.Enumerated=Wa,ja.NAME="ENUMERATED";var Ga=class extends(aa(ca)){constructor({valueDec:e=-1,isFirstSid:t=!1,...r}={}){super(r),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,r){if(!r)return t;let n=qo.BufferSourceConverter.toUint8Array(e);if(!Zo(this,n,t,r))return-1;let i=n.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let e=0;e<r&&(this.valueHexView[e]=127&i[e],this.blockLength++,128&i[e]);e++);let s=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength;e++)s[e]=this.valueHexView[e];return this.valueHexView=s,128&i[this.blockLength-1]?(this.error="End of input reached before message was fully decoded",-1):(0===this.valueHexView[0]&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zo(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Qo();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let r=new Uint8Array(t.length/7);for(let e=0;e<r.length;e++)r[e]=parseInt(t.slice(7*e,7*e+7),2)+(e+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let t=this.valueHexView,r=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength-1;e++)r[e]=128|t[e];return r[this.blockLength-1]=t[this.blockLength-1],r.buffer}let t=Wo(this.valueDec,7);if(0===t.byteLength)return this.error="Error during encoding SID value",ra;let r=new Uint8Array(t.byteLength);if(!e){let e=new Uint8Array(t),n=t.byteLength-1;for(let t=0;t<n;t++)r[t]=128|e[t];r[n]=e[n]}return r}toString(){let e="";if(this.isHexOnly)e=qo.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};Ga.NAME="sidBlock";var Ya=class extends ca{constructor({value:e="",...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let n=t;for(;r>0;){let t=new Ga;if(n=t.fromBER(e,n,r),-1===n)return this.blockLength=0,this.error=t.error,n;0===this.value.length&&(t.isFirstSid=!0),this.blockLength+=t.blockLength,r-=t.blockLength,this.value.push(t)}return n}toBER(e){let t=[];for(let r=0;r<this.value.length;r++){let n=this.value[r].toBER(e);if(0===n.byteLength)return this.error=this.value[r].error,ra;t.push(n)}return Jo(t)}fromString(e){this.value=[];let t=0,r=0,n="",i=!1;do{if(r=e.indexOf(".",t),n=-1===r?e.substring(t):e.substring(t,r),t=r+1,i){let e=this.value[0],t=0;switch(e.valueDec){case 0:break;case 1:t=40;break;case 2:t=80;break;default:return void(this.value=[])}let r=parseInt(n,10);if(isNaN(r))return;e.valueDec=r+t,i=!1}else{let e=new Ga;if(n>Number.MAX_SAFE_INTEGER){Qo();let t=BigInt(n);e.valueBigInt=t}else if(e.valueDec=parseInt(n,10),isNaN(e.valueDec))return;this.value.length||(e.isFirstSid=!0,i=!0),this.value.push(e)}}while(-1!==r)}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let n=this.value[r].toString();0!==r&&(e=`${e}.`),t?(n=`{${n}}`,this.value[r].isFirstSid?e=`2.{${n} - 80}`:e+=n):e+=n}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};Ya.NAME="ObjectIdentifierValueBlock";var Qa,Ja=class extends fa{constructor(e={}){super(e,Ya),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};Qa=Ja,da.ObjectIdentifier=Qa,Ja.NAME="OBJECT IDENTIFIER";var Za=class extends(aa(la)){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,r){if(0===r)return t;let n=qo.BufferSourceConverter.toUint8Array(e);if(!Zo(this,n,t,r))return-1;let i=n.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let e=0;e<r&&(this.valueHexView[e]=127&i[e],this.blockLength++,128&i[e]);e++);let s=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength;e++)s[e]=this.valueHexView[e];return this.valueHexView=s,128&i[this.blockLength-1]?(this.error="End of input reached before message was fully decoded",-1):(0===this.valueHexView[0]&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zo(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let t=this.valueHexView,r=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength-1;e++)r[e]=128|t[e];return r[this.blockLength-1]=t[this.blockLength-1],r.buffer}let t=Wo(this.valueDec,7);if(0===t.byteLength)return this.error="Error during encoding SID value",ra;let r=new Uint8Array(t.byteLength);if(!e){let e=new Uint8Array(t),n=t.byteLength-1;for(let t=0;t<n;t++)r[t]=128|e[t];r[n]=e[n]}return r.buffer}toString(){let e="";return e=this.isHexOnly?qo.Convert.ToHex(this.valueHexView):this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};Za.NAME="relativeSidBlock";var Xa=class extends ca{constructor({value:e="",...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let n=t;for(;r>0;){let t=new Za;if(n=t.fromBER(e,n,r),-1===n)return this.blockLength=0,this.error=t.error,n;this.blockLength+=t.blockLength,r-=t.blockLength,this.value.push(t)}return n}toBER(e,t){let r=[];for(let t=0;t<this.value.length;t++){let n=this.value[t].toBER(e);if(0===n.byteLength)return this.error=this.value[t].error,ra;r.push(n)}return Jo(r)}fromString(e){this.value=[];let t=0,r=0,n="";do{r=e.indexOf(".",t),n=-1===r?e.substring(t):e.substring(t,r),t=r+1;let i=new Za;if(i.valueDec=parseInt(n,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(-1!==r);return!0}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let n=this.value[r].toString();0!==r&&(e=`${e}.`),t&&(n=`{${n}}`),e+=n}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};Xa.NAME="RelativeObjectIdentifierValueBlock";var el,tl=class extends fa{constructor(e={}){super(e,Xa),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};el=tl,da.RelativeObjectIdentifier=el,tl.NAME="RelativeObjectIdentifier";var rl,nl=class extends Aa{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};rl=nl,da.Sequence=rl,nl.NAME="SEQUENCE";var il,sl=class extends Aa{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};il=sl,da.Set=il,sl.NAME="SET";var ol=class extends(aa(ca)){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=""}toJSON(){return{...super.toJSON(),value:this.value}}};ol.NAME="StringValueBlock";var al=class extends ol{};al.NAME="SimpleStringValueBlock";var ll=class extends ga{constructor({...e}={}){super(e,al)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,qo.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t);for(let n=0;n<t;n++)r[n]=e.charCodeAt(n);this.valueBlock.value=e}};ll.NAME="SIMPLE STRING";var cl=class extends ll{fromBuffer(e){this.valueBlock.valueHexView=qo.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=qo.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=qo.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(qo.Convert.FromUtf8String(e)),this.valueBlock.value=e}};cl.NAME="Utf8StringValueBlock";var ul,hl=class extends cl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};ul=hl,da.Utf8String=ul,hl.NAME="UTF8String";var dl=class extends ll{fromBuffer(e){this.valueBlock.value=qo.Convert.ToUtf16String(e),this.valueBlock.valueHexView=qo.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(qo.Convert.FromUtf16String(e))}};dl.NAME="BmpStringValueBlock";var fl,pl=class extends dl{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};fl=pl,da.BmpString=fl,pl.NAME="BMPString";var gl=class extends ll{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),r=new Uint8Array(t);for(let e=0;e<r.length;e+=4)r[e]=r[e+3],r[e+1]=r[e+2],r[e+2]=0,r[e+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(4*t);for(let n=0;n<t;n++){let t=Wo(e.charCodeAt(n),8),i=new Uint8Array(t);if(i.length>4)continue;let s=4-i.length;for(let e=i.length-1;e>=0;e--)r[4*n+e+s]=i[e]}this.valueBlock.value=e}};gl.NAME="UniversalStringValueBlock";var ml,yl=class extends gl{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};ml=yl,da.UniversalString=ml,yl.NAME="UniversalString";var wl,bl=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};wl=bl,da.NumericString=wl,bl.NAME="NumericString";var El,vl=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};El=vl,da.PrintableString=El,vl.NAME="PrintableString";var Sl,Rl=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};Sl=Rl,da.TeletexString=Sl,Rl.NAME="TeletexString";var Al,_l=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};Al=_l,da.VideotexString=Al,_l.NAME="VideotexString";var Il,kl=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};Il=kl,da.IA5String=Il,kl.NAME="IA5String";var Tl,Cl=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};Tl=Cl,da.GraphicString=Tl,Cl.NAME="GraphicString";var Dl,xl=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};Dl=xl,da.VisibleString=Dl,xl.NAME="VisibleString";var Nl,Pl=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};Nl=Pl,da.GeneralString=Nl,Pl.NAME="GeneralString";var Ll,Ol=class extends ll{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};Ll=Ol,da.CharacterString=Ll,Ol.NAME="CharacterString";var Bl,Ml=class extends xl{constructor({value:e,valueDate:t,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let t=0;t<e.length;t++)this.valueBlock.valueHexView[t]=e.charCodeAt(t)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,qo.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),r=new Uint8Array(t);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let t=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/gi.exec(e);if(null===t)return void(this.error="Wrong input string for conversion");let r=parseInt(t[1],10);this.year=r>=50?1900+r:2e3+r,this.month=parseInt(t[2],10),this.day=parseInt(t[3],10),this.hour=parseInt(t[4],10),this.minute=parseInt(t[5],10),this.second=parseInt(t[6],10)}toString(e="iso"){if("iso"===e){let e=new Array(7);return e[0]=Yo(this.year<2e3?this.year-1900:this.year-2e3,2),e[1]=Yo(this.month,2),e[2]=Yo(this.day,2),e[3]=Yo(this.hour,2),e[4]=Yo(this.minute,2),e[5]=Yo(this.second,2),e[6]="Z",e.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};Bl=Ml,da.UTCTime=Bl,Ml.NAME="UTCTime";var Ul,Fl=class extends Ml{constructor(e={}){var t;super(e),null!==(t=this.millisecond)&&void 0!==t||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))}fromString(e){let t,r=!1,n="",i="",s=0,o=0,a=0;if("Z"===e[e.length-1])n=e.substring(0,e.length-1),r=!0;else{let t=new Number(e[e.length-1]);if(isNaN(t.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(r){if(-1!==n.indexOf("+"))throw new Error("Wrong input string for conversion");if(-1!==n.indexOf("-"))throw new Error("Wrong input string for conversion")}else{let e=1,t=n.indexOf("+"),r="";if(-1===t&&(t=n.indexOf("-"),e=-1),-1!==t){if(r=n.substring(t+1),n=n.substring(0,t),2!==r.length&&4!==r.length)throw new Error("Wrong input string for conversion");let i=parseInt(r.substring(0,2),10);if(isNaN(i.valueOf()))throw new Error("Wrong input string for conversion");if(o=e*i,4===r.length){if(i=parseInt(r.substring(2,4),10),isNaN(i.valueOf()))throw new Error("Wrong input string for conversion");a=e*i}}}let l=n.indexOf(".");if(-1===l&&(l=n.indexOf(",")),-1!==l){let e=new Number(`0${n.substring(l)}`);if(isNaN(e.valueOf()))throw new Error("Wrong input string for conversion");s=e.valueOf(),i=n.substring(0,l)}else i=n;switch(!0){case 8===i.length:if(t=/(\d{4})(\d{2})(\d{2})/gi,-1!==l)throw new Error("Wrong input string for conversion");break;case 10===i.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})/gi,-1!==l){let e=60*s;this.minute=Math.floor(e),e=60*(e-this.minute),this.second=Math.floor(e),e=1e3*(e-this.second),this.millisecond=Math.floor(e)}break;case 12===i.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/gi,-1!==l){let e=60*s;this.second=Math.floor(e),e=1e3*(e-this.second),this.millisecond=Math.floor(e)}break;case 14===i.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/gi,-1!==l){let e=1e3*s;this.millisecond=Math.floor(e)}break;default:throw new Error("Wrong input string for conversion")}let c=t.exec(i);if(null===c)throw new Error("Wrong input string for conversion");for(let e=1;e<c.length;e++)switch(e){case 1:this.year=parseInt(c[e],10);break;case 2:this.month=parseInt(c[e],10);break;case 3:this.day=parseInt(c[e],10);break;case 4:this.hour=parseInt(c[e],10)+o;break;case 5:this.minute=parseInt(c[e],10)+a;break;case 6:this.second=parseInt(c[e],10);break;default:throw new Error("Wrong input string for conversion")}if(!1===r){let e=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=e.getUTCFullYear(),this.month=e.getUTCMonth(),this.day=e.getUTCDay(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds(),this.millisecond=e.getUTCMilliseconds()}}toString(e="iso"){if("iso"===e){let e=[];return e.push(Yo(this.year,4)),e.push(Yo(this.month,2)),e.push(Yo(this.day,2)),e.push(Yo(this.hour,2)),e.push(Yo(this.minute,2)),e.push(Yo(this.second,2)),0!==this.millisecond&&(e.push("."),e.push(Yo(this.millisecond,3))),e.push("Z"),e.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};Ul=Fl,da.GeneralizedTime=Ul,Fl.NAME="GeneralizedTime";var $l,Vl=class extends hl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};$l=Vl,da.DATE=$l,Vl.NAME="DATE";var Kl,Hl=class extends hl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};Kl=Hl,da.TimeOfDay=Kl,Hl.NAME="TimeOfDay";var ql,zl=class extends hl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};ql=zl,da.DateTime=ql,zl.NAME="DateTime";var Wl,jl=class extends hl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};Wl=jl,da.Duration=Wl,jl.NAME="Duration";var Gl,Yl=class extends hl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};function Ql(e){let{result:t}=Ea(e),r=t.valueBlock.value;return{n:Bn(ec(r[1].toBigInt()),"base64url"),e:Bn(ec(r[2].toBigInt()),"base64url"),d:Bn(ec(r[3].toBigInt()),"base64url"),p:Bn(ec(r[4].toBigInt()),"base64url"),q:Bn(ec(r[5].toBigInt()),"base64url"),dp:Bn(ec(r[6].toBigInt()),"base64url"),dq:Bn(ec(r[7].toBigInt()),"base64url"),qi:Bn(ec(r[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function Jl(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new U("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new nl({value:[new za({value:0}),za.fromBigInt(tc(en(e.n,"base64url"))),za.fromBigInt(tc(en(e.e,"base64url"))),za.fromBigInt(tc(en(e.d,"base64url"))),za.fromBigInt(tc(en(e.p,"base64url"))),za.fromBigInt(tc(en(e.q,"base64url"))),za.fromBigInt(tc(en(e.dp,"base64url"))),za.fromBigInt(tc(en(e.dq,"base64url"))),za.fromBigInt(tc(en(e.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Zl(e){let{result:t}=Ea(e),r=t.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:Bn(ec(r[0].toBigInt()),"base64url"),e:Bn(ec(r[1].toBigInt()),"base64url")}}function Xl(e){if(null==e.n||null==e.e)throw new U("JWK was missing components","ERR_INVALID_PARAMETERS");let t=new nl({value:[new nl({value:[new Ja({value:"1.2.840.113549.1.1.1"}),new Ca]}),new Fa({valueHex:new nl({value:[za.fromBigInt(tc(en(e.n,"base64url"))),za.fromBigInt(tc(en(e.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function ec(e){let t=e.toString(16);t.length%2>0&&(t=`0${t}`);let r=t.length/2,n=new Uint8Array(r),i=0,s=0;for(;i<r;)n[i]=parseInt(t.slice(s,s+2),16),i+=1,s+=2;return n}function tc(e){let t=[];return e.forEach((function(e){let r=e.toString(16);r.length%2>0&&(r=`0${r}`),t.push(r)})),BigInt("0x"+t.join(""))}Gl=Yl,da.TIME=Gl,Yl.NAME="TIME";var rc=16,nc=32,ic=1e4;async function sc(e,t){let r=ei.get(),n=new nl({value:[new za({value:0}),new nl({value:[new Ja({value:"1.2.840.113549.1.1.1"}),new Ca]}),new Oa({valueHex:e.marshal()})]}).toBER(),i=new Uint8Array(n,0,n.byteLength),s=Mo(rc),o=await Ho(Oi,t,s,{c:ic,dkLen:nc}),a=Mo(16),l=await r.subtle.importKey("raw",o,"AES-CBC",!1,["encrypt"]),c=await r.subtle.encrypt({name:"AES-CBC",iv:a},l,i),u=new nl({value:[new Oa({valueHex:s}),new za({value:ic}),new za({value:nc}),new nl({value:[new Ja({value:"1.2.840.113549.2.11"}),new Ca]})]}),h=new nl({value:[new Ja({value:"1.2.840.113549.1.5.13"}),new nl({value:[new nl({value:[new Ja({value:"1.2.840.113549.1.5.12"}),u]}),new nl({value:[new Ja({value:"2.16.840.1.101.3.4.1.42"}),new Oa({valueHex:a})]})]})]}),d=new nl({value:[h,new Oa({valueHex:c})]}).toBER();return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...Bn(new Uint8Array(d,0,d.byteLength),"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join("\n")}async function oc(e,t){let r,n=ei.get();if(e.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let i=en(e.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=Ea(i),{iv:o,salt:a,iterations:l,keySize:c,cipherText:u}=function(e){let t=e.valueBlock.value[0];if("OBJECT IDENTIFIER : 1.2.840.113549.1.5.13"!==t.valueBlock.value[0].toString())throw new U("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");let r=t.valueBlock.value[1].valueBlock.value[0];if("OBJECT IDENTIFIER : 1.2.840.113549.1.5.12"!==r.valueBlock.value[0].toString())throw new U("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");let n=r.valueBlock.value[1],i=lc(n.valueBlock.value[0].getValue()),s=ic,o=nc;if(3===n.valueBlock.value.length)s=Number(n.valueBlock.value[1].toBigInt()),o=Number(n.valueBlock.value[2].toBigInt());else if(2===n.valueBlock.value.length)throw new U("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");let a=t.valueBlock.value[1].valueBlock.value[1],l=a.valueBlock.value[0].toString();if("OBJECT IDENTIFIER : 1.2.840.113549.3.7"!==l&&"OBJECT IDENTIFIER : 1.3.14.3.2.7"!==l&&"OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"!==l&&"OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"!==l&&"OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42"!==l)throw new U("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS");let c=lc(a.valueBlock.value[1].getValue());return{cipherText:lc(e.valueBlock.value[1].getValue()),salt:i,iterations:s,keySize:o,iv:c}}(s),h=await Ho(Oi,t,a,{c:l,dkLen:c}),d=await n.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),f=lc(await n.subtle.decrypt({name:"AES-CBC",iv:o},d,u)),{result:p}=Ea(f);r=ac(p)}else{if(!e.includes("-----BEGIN PRIVATE KEY-----"))throw new U("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");{let t=en(e.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:n}=Ea(t);r=ac(n)}}return mc(r)}function ac(e){return lc(e.valueBlock.value[2].getValue())}function lc(e){return new Uint8Array(e,0,e.byteLength)}async function cc(e){let t=[await ei.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await hc(e)],r=await uc({privateKey:t[0],publicKey:t[1]});return{privateKey:r[0],publicKey:r[1]}}async function uc(e){if(null==e.privateKey||null==e.publicKey)throw new U("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([ei.get().subtle.exportKey("jwk",e.privateKey),ei.get().subtle.exportKey("jwk",e.publicKey)])}async function hc(e){return ei.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function dc(e){if("RSA"!==e.kty)throw new U("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new U("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*en(e.n,"base64url").length}var fc=8192,pc=class{_key;constructor(e){this._key=e}verify(e,t){return async function(e,t,r){let n=await ei.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return ei.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,t,r instanceof Uint8Array?r:r.subarray())}(this._key,t,e)}marshal(){return Uo.jwkToPkix(this._key)}get bytes(){return wo.encode({Type:mo.RSA,Data:this.marshal()}).subarray()}equals(e){return ke(this.bytes,e.bytes)}hash(){let e=Fr.digest(this.bytes);return oi(e)?e.then((({bytes:e})=>e)):e.bytes}},gc=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return Mo(16)}sign(e){return async function(e,t){let r=await ei.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await ei.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},r,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(n,0,n.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new U("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new pc(this._publicKey)}marshal(){return Uo.jwkToPkcs1(this._key)}get bytes(){return bo.encode({Type:mo.RSA,Data:this.marshal()}).subarray()}equals(e){return ke(this.bytes,e.bytes)}hash(){let e=Fr.digest(this.bytes);return oi(e)?e.then((({bytes:e})=>e)):e.bytes}async id(){return Bn(await this.public.hash(),"base58btc")}async export(e,t="pkcs-8"){if("pkcs-8"===t)return Uo.exportToPem(this,e);if("libp2p-key"===t)return go(this.bytes,e);throw new U(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};async function mc(e){let t=Uo.pkcs1ToJwk(e);if(dc(t)>fc)throw new U("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let r=await cc(t);return new gc(r.privateKey,r.publicKey)}function yc(e){let t=Uo.pkixToJwk(e);if(dc(t)>fc)throw new U("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new pc(t)}async function wc(e){if(dc(e)>fc)throw new U("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await cc(e);return new gc(t.privateKey,t.publicKey)}async function bc(e){if(e>fc)throw new U("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await async function(e){let t=await ei.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),r=await uc(t);return{privateKey:r[0],publicKey:r[1]}}(e);return new gc(t.privateKey,t.publicKey)}var Ec={};a(Ec,{Secp256k1PrivateKey:()=>qc,Secp256k1PublicKey:()=>Hc,generateKeyPair:()=>jc,unmarshalSecp256k1PrivateKey:()=>zc,unmarshalSecp256k1PublicKey:()=>Wc});var vc=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Sc=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Rc=new Uint32Array(64),Ac=class extends Ai{constructor(){super(64,32,8,!1),this.A=0|Sc[0],this.B=0|Sc[1],this.C=0|Sc[2],this.D=0|Sc[3],this.E=0|Sc[4],this.F=0|Sc[5],this.G=0|Sc[6],this.H=0|Sc[7]}get(){let{A:e,B:t,C:r,D:n,E:i,F:s,G:o,H:a}=this;return[e,t,r,n,i,s,o,a]}set(e,t,r,n,i,s,o,a){this.A=0|e,this.B=0|t,this.C=0|r,this.D=0|n,this.E=0|i,this.F=0|s,this.G=0|o,this.H=0|a}process(e,t){for(let r=0;r<16;r++,t+=4)Rc[r]=e.getUint32(t,!1);for(let e=16;e<64;e++){let t=Rc[e-15],r=Rc[e-2],n=fi(t,7)^fi(t,18)^t>>>3,i=fi(r,17)^fi(r,19)^r>>>10;Rc[e]=i+Rc[e-7]+n+Rc[e-16]|0}let{A:r,B:n,C:i,D:s,E:o,F:a,G:l,H:c}=this;for(let e=0;e<64;e++){let t=c+(fi(o,6)^fi(o,11)^fi(o,25))+Si(o,a,l)+vc[e]+Rc[e]|0,u=(fi(r,2)^fi(r,13)^fi(r,22))+Ri(r,n,i)|0;c=l,l=a,a=o,o=s+t|0,s=i,i=n,n=r,r=t+u|0}r=r+this.A|0,n=n+this.B|0,i=i+this.C|0,s=s+this.D|0,o=o+this.E|0,a=a+this.F|0,l=l+this.G|0,c=c+this.H|0,this.set(r,n,i,s,o,a,l,c)}roundClean(){Rc.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}},_c=Ei((()=>new Ac));function Ic(e){void 0!==e.lowS&&Ki("lowS",e.lowS),void 0!==e.prehash&&Ki("prehash",e.prehash)}var{bytesToNumberBE:kc,hexToBytes:Tc}=Bi,Cc={Err:class extends Error{constructor(e=""){super(e)}},_tlv:{encode:(e,t)=>{let{Err:r}=Cc;if(e<0||e>256)throw new r("tlv.encode: wrong tag");if(1&t.length)throw new r("tlv.encode: unpadded data");let n=t.length/2,i=zi(n);if(i.length/2&128)throw new r("tlv.encode: long form length too big");let s=n>127?zi(i.length/2|128):"";return`${zi(e)}${s}${i}${t}`},decode(e,t){let{Err:r}=Cc,n=0;if(e<0||e>256)throw new r("tlv.encode: wrong tag");if(t.length<2||t[n++]!==e)throw new r("tlv.decode: wrong tlv");let i=t[n++],s=0;if(128&i){let e=127&i;if(!e)throw new r("tlv.decode(long): indefinite length not supported");if(e>4)throw new r("tlv.decode(long): byte length is too big");let o=t.subarray(n,n+e);if(o.length!==e)throw new r("tlv.decode: length bytes not complete");if(0===o[0])throw new r("tlv.decode(long): zero leftmost byte");for(let e of o)s=s<<8|e;if(n+=e,s<128)throw new r("tlv.decode(long): not minimal encoding")}else s=i;let o=t.subarray(n,n+s);if(o.length!==s)throw new r("tlv.decode: wrong value length");return{v:o,l:t.subarray(n+s)}}},_int:{encode(e){let{Err:t}=Cc;if(e<Dc)throw new t("integer: negative integers are not allowed");let r=zi(e);if(8&Number.parseInt(r[0],16)&&(r="00"+r),1&r.length)throw new t("unexpected assertion");return r},decode(e){let{Err:t}=Cc;if(128&e[0])throw new t("Invalid signature integer: negative");if(0===e[0]&&!(128&e[1]))throw new t("Invalid signature integer: unnecessary leading zero");return kc(e)}},toSig(e){let{Err:t,_int:r,_tlv:n}=Cc,i="string"==typeof e?Tc(e):e;Vi(i);let{v:s,l:o}=n.decode(48,i);if(o.length)throw new t("Invalid signature: left bytes after parsing");let{v:a,l}=n.decode(2,s),{v:c,l:u}=n.decode(2,l);if(u.length)throw new t("Invalid signature: left bytes after parsing");return{r:r.decode(a),s:r.decode(c)}},hexFromSig(e){let{_tlv:t,_int:r}=Cc,n=`${t.encode(2,r.encode(e.r))}${t.encode(2,r.encode(e.s))}`;return t.encode(48,n)}},Dc=BigInt(0),xc=BigInt(1),Nc=(BigInt(2),BigInt(3));function Pc(e){let t=function(e){let t=Vs(e);return ms(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}(e),{Fp:r,n}=t,i=r.BYTES+1,s=2*r.BYTES+1;function o(e){return Is(e,n)}function a(e){return Cs(e,n)}let{ProjectivePoint:l,normPrivateKeyToScalar:c,weierstrassEquation:u,isWithinCurveOrder:h}=function(e){let t=function(e){let t=Vs(e);ms(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:r,Fp:n,a:i}=t;if(r){if(!n.eql(i,n.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if("object"!=typeof r||"bigint"!=typeof r.beta||"function"!=typeof r.splitScalar)throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}(e),{Fp:r}=t,n=Ns(t.n,t.nBitLength),i=t.toBytes||((e,t,n)=>{let i=t.toAffine();return rs(Uint8Array.from([4]),r.toBytes(i.x),r.toBytes(i.y))}),s=t.fromBytes||(e=>{let t=e.subarray(1);return{x:r.fromBytes(t.subarray(0,r.BYTES)),y:r.fromBytes(t.subarray(r.BYTES,2*r.BYTES))}});function o(e){let{a:n,b:i}=t,s=r.sqr(e),o=r.mul(s,e);return r.add(r.add(o,r.mul(e,n)),i)}if(!r.eql(r.sqr(t.Gy),o(t.Gx)))throw new Error("bad generator point: equation left != right");function a(e){let r,{allowedPrivateKeyLengths:n,nByteLength:i,wrapPrivateKey:s,n:o}=t;if(n&&"bigint"!=typeof e){if($i(e)&&(e=qi(e)),"string"!=typeof e||!n.includes(e.length))throw new Error("Invalid key");e=e.padStart(2*i,"0")}try{r="bigint"==typeof e?e:Qi(ts("private key",e,i))}catch{throw new Error(`private key must be ${i} bytes, hex or bigint, not ${typeof e}`)}return s&&(r=Is(r,o)),as("private key",r,xc,o),r}function l(e){if(!(e instanceof h))throw new Error("ProjectivePoint expected")}let c=ws(((e,t)=>{let{px:n,py:i,pz:s}=e;if(r.eql(s,r.ONE))return{x:n,y:i};let o=e.is0();null==t&&(t=o?r.ONE:r.inv(s));let a=r.mul(n,t),l=r.mul(i,t),c=r.mul(s,t);if(o)return{x:r.ZERO,y:r.ZERO};if(!r.eql(c,r.ONE))throw new Error("invZ was invalid");return{x:a,y:l}})),u=ws((e=>{if(e.is0()){if(t.allowInfinityPoint&&!r.is0(e.py))return;throw new Error("bad point: ZERO")}let{x:n,y:i}=e.toAffine();if(!r.isValid(n)||!r.isValid(i))throw new Error("bad point: x or y not FE");let s=r.sqr(i),a=o(n);if(!r.eql(s,a))throw new Error("bad point: equation left != right");if(!e.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0}));class h{constructor(e,t,n){if(this.px=e,this.py=t,this.pz=n,null==e||!r.isValid(e))throw new Error("x required");if(null==t||!r.isValid(t))throw new Error("y required");if(null==n||!r.isValid(n))throw new Error("z required");Object.freeze(this)}static fromAffine(e){let{x:t,y:n}=e||{};if(!e||!r.isValid(t)||!r.isValid(n))throw new Error("invalid affine point");if(e instanceof h)throw new Error("projective point not allowed");let i=e=>r.eql(e,r.ZERO);return i(t)&&i(n)?h.ZERO:new h(t,n,r.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(e){let t=r.invertBatch(e.map((e=>e.pz)));return e.map(((e,r)=>e.toAffine(t[r]))).map(h.fromAffine)}static fromHex(e){let t=h.fromAffine(s(ts("pointHex",e)));return t.assertValidity(),t}static fromPrivateKey(e){return h.BASE.multiply(a(e))}static msm(e,t){return $s(h,n,e,t)}_setWindowSize(e){f.setWindowSize(this,e)}assertValidity(){u(this)}hasEvenY(){let{y:e}=this.toAffine();if(r.isOdd)return!r.isOdd(e);throw new Error("Field doesn't support isOdd")}equals(e){l(e);let{px:t,py:n,pz:i}=this,{px:s,py:o,pz:a}=e,c=r.eql(r.mul(t,a),r.mul(s,i)),u=r.eql(r.mul(n,a),r.mul(o,i));return c&&u}negate(){return new h(this.px,r.neg(this.py),this.pz)}double(){let{a:e,b:n}=t,i=r.mul(n,Nc),{px:s,py:o,pz:a}=this,l=r.ZERO,c=r.ZERO,u=r.ZERO,d=r.mul(s,s),f=r.mul(o,o),p=r.mul(a,a),g=r.mul(s,o);return g=r.add(g,g),u=r.mul(s,a),u=r.add(u,u),l=r.mul(e,u),c=r.mul(i,p),c=r.add(l,c),l=r.sub(f,c),c=r.add(f,c),c=r.mul(l,c),l=r.mul(g,l),u=r.mul(i,u),p=r.mul(e,p),g=r.sub(d,p),g=r.mul(e,g),g=r.add(g,u),u=r.add(d,d),d=r.add(u,d),d=r.add(d,p),d=r.mul(d,g),c=r.add(c,d),p=r.mul(o,a),p=r.add(p,p),d=r.mul(p,g),l=r.sub(l,d),u=r.mul(p,f),u=r.add(u,u),u=r.add(u,u),new h(l,c,u)}add(e){l(e);let{px:n,py:i,pz:s}=this,{px:o,py:a,pz:c}=e,u=r.ZERO,d=r.ZERO,f=r.ZERO,p=t.a,g=r.mul(t.b,Nc),m=r.mul(n,o),y=r.mul(i,a),w=r.mul(s,c),b=r.add(n,i),E=r.add(o,a);b=r.mul(b,E),E=r.add(m,y),b=r.sub(b,E),E=r.add(n,s);let v=r.add(o,c);return E=r.mul(E,v),v=r.add(m,w),E=r.sub(E,v),v=r.add(i,s),u=r.add(a,c),v=r.mul(v,u),u=r.add(y,w),v=r.sub(v,u),f=r.mul(p,E),u=r.mul(g,w),f=r.add(u,f),u=r.sub(y,f),f=r.add(y,f),d=r.mul(u,f),y=r.add(m,m),y=r.add(y,m),w=r.mul(p,w),E=r.mul(g,E),y=r.add(y,w),w=r.sub(m,w),w=r.mul(p,w),E=r.add(E,w),m=r.mul(y,E),d=r.add(d,m),m=r.mul(v,E),u=r.mul(b,u),u=r.sub(u,m),m=r.mul(b,y),f=r.mul(v,f),f=r.add(f,m),new h(u,d,f)}subtract(e){return this.add(e.negate())}is0(){return this.equals(h.ZERO)}wNAF(e){return f.wNAFCached(this,e,h.normalizeZ)}multiplyUnsafe(e){as("scalar",e,Dc,t.n);let n=h.ZERO;if(e===Dc)return n;if(e===xc)return this;let{endo:i}=t;if(!i)return f.unsafeLadder(this,e);let{k1neg:s,k1:o,k2neg:a,k2:l}=i.splitScalar(e),c=n,u=n,d=this;for(;o>Dc||l>Dc;)o&xc&&(c=c.add(d)),l&xc&&(u=u.add(d)),d=d.double(),o>>=xc,l>>=xc;return s&&(c=c.negate()),a&&(u=u.negate()),u=new h(r.mul(u.px,i.beta),u.py,u.pz),c.add(u)}multiply(e){let n,i,{endo:s,n:o}=t;if(as("scalar",e,xc,o),s){let{k1neg:t,k1:o,k2neg:a,k2:l}=s.splitScalar(e),{p:c,f:u}=this.wNAF(o),{p:d,f:p}=this.wNAF(l);c=f.constTimeNegate(t,c),d=f.constTimeNegate(a,d),d=new h(r.mul(d.px,s.beta),d.py,d.pz),n=c.add(d),i=u.add(p)}else{let{p:t,f:r}=this.wNAF(e);n=t,i=r}return h.normalizeZ([n,i])[0]}multiplyAndAddUnsafe(e,t,r){let n=h.BASE,i=(e,t)=>t!==Dc&&t!==xc&&e.equals(n)?e.multiply(t):e.multiplyUnsafe(t),s=i(this,t).add(i(e,r));return s.is0()?void 0:s}toAffine(e){return c(this,e)}isTorsionFree(){let{h:e,isTorsionFree:r}=t;if(e===xc)return!0;if(r)return r(h,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:e,clearCofactor:r}=t;return e===xc?this:r?r(h,this):this.multiplyUnsafe(t.h)}toRawBytes(e=!0){return Ki("isCompressed",e),this.assertValidity(),i(h,this,e)}toHex(e=!0){return Ki("isCompressed",e),qi(this.toRawBytes(e))}}h.BASE=new h(t.Gx,t.Gy,r.ONE),h.ZERO=new h(r.ZERO,r.ONE,r.ZERO);let d=t.nBitLength,f=Fs(h,t.endo?Math.ceil(d/2):d);return{CURVE:t,ProjectivePoint:h,normPrivateKeyToScalar:a,weierstrassEquation:o,isWithinCurveOrder:function(e){return os(e,xc,t.n)}}}({...t,toBytes(e,t,n){let i=t.toAffine(),s=r.toBytes(i.x),o=rs;return Ki("isCompressed",n),n?o(Uint8Array.from([t.hasEvenY()?2:3]),s):o(Uint8Array.from([4]),s,r.toBytes(i.y))},fromBytes(e){let t=e.length,n=e[0],o=e.subarray(1);if(t!==i||2!==n&&3!==n){if(t===s&&4===n)return{x:r.fromBytes(o.subarray(0,r.BYTES)),y:r.fromBytes(o.subarray(r.BYTES,2*r.BYTES))};throw new Error(`Point of length ${t} was invalid. Expected ${i} compressed bytes or ${s} uncompressed bytes`)}{let e=Qi(o);if(!os(e,xc,r.ORDER))throw new Error("Point is not on curve");let t,i=u(e);try{t=r.sqrt(i)}catch(e){let t=e instanceof Error?": "+e.message:"";throw new Error("Point is not on curve"+t)}return!(1&~n)!=((t&xc)===xc)&&(t=r.neg(t)),{x:e,y:t}}}}),d=e=>qi(Zi(e,t.nByteLength));function f(e){return e>n>>xc}let p=(e,t,r)=>Qi(e.slice(t,r));class g{constructor(e,t,r){this.r=e,this.s=t,this.recovery=r,this.assertValidity()}static fromCompact(e){let r=t.nByteLength;return e=ts("compactSignature",e,2*r),new g(p(e,0,r),p(e,r,2*r))}static fromDER(e){let{r:t,s:r}=Cc.toSig(ts("DER",e));return new g(t,r)}assertValidity(){as("r",this.r,xc,n),as("s",this.s,xc,n)}addRecoveryBit(e){return new g(this.r,this.s,e)}recoverPublicKey(e){let{r:n,s:i,recovery:s}=this,c=b(ts("msgHash",e));if(null==s||![0,1,2,3].includes(s))throw new Error("recovery id invalid");let u=2===s||3===s?n+t.n:n;if(u>=r.ORDER)throw new Error("recovery id 2 or 3 invalid");let h=1&s?"03":"02",f=l.fromHex(h+d(u)),p=a(u),g=o(-c*p),m=o(i*p),y=l.BASE.multiplyAndAddUnsafe(f,g,m);if(!y)throw new Error("point at infinify");return y.assertValidity(),y}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new g(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return Yi(this.toDERHex())}toDERHex(){return Cc.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Yi(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}let m={isValidPrivateKey(e){try{return c(e),!0}catch{return!1}},normPrivateKeyToScalar:c,randomPrivateKey:()=>{let e=Ls(t.n);return function(e,t,r=!1){let n=e.length,i=Ps(t),s=Ls(t);if(n<16||n<s||n>1024)throw new Error(`expected ${s}-1024 bytes of input, got ${n}`);let o=Is(r?Qi(e):Ji(e),t-Es)+Es;return r?Xi(o,i):Zi(o,i)}(t.randomBytes(e),t.n)},precompute:(e=8,t=l.BASE)=>(t._setWindowSize(e),t.multiply(BigInt(3)),t)};function y(e){let t=$i(e),r="string"==typeof e,n=(t||r)&&e.length;return t?n===i||n===s:r?n===2*i||n===2*s:e instanceof l}let w=t.bits2int||function(e){let r=Qi(e),n=8*e.length-t.nBitLength;return n>0?r>>BigInt(n):r},b=t.bits2int_modN||function(e){return o(w(e))},E=hs(t.nBitLength);function v(e){return as(`num < 2^${t.nBitLength}`,e,Dc,E),Zi(e,t.nByteLength)}let S={lowS:t.lowS,prehash:!1},R={lowS:t.lowS,prehash:!1};return l.BASE._setWindowSize(8),{CURVE:t,getPublicKey:function(e,t=!0){return l.fromPrivateKey(e).toRawBytes(t)},getSharedSecret:function(e,t,r=!0){if(y(e))throw new Error("first arg must be private key");if(!y(t))throw new Error("second arg must be public key");return l.fromHex(t).multiply(c(e)).toRawBytes(r)},sign:function(e,n,i=S){let{seed:s,k2sig:u}=function(e,n,i=S){if(["recovered","canonical"].some((e=>e in i)))throw new Error("sign() legacy options not supported");let{hash:s,randomBytes:u}=t,{lowS:d,prehash:p,extraEntropy:m}=i;null==d&&(d=!0),e=ts("msgHash",e),Ic(i),p&&(e=ts("prehashed msgHash",s(e)));let y=b(e),E=c(n),R=[v(E),v(y)];if(null!=m&&!1!==m){let e=!0===m?u(r.BYTES):m;R.push(ts("extraEntropy",e))}let A=rs(...R),_=y;return{seed:A,k2sig:function(e){let t=w(e);if(!h(t))return;let r=a(t),n=l.BASE.multiply(t).toAffine(),i=o(n.x);if(i===Dc)return;let s=o(r*o(_+i*E));if(s===Dc)return;let c=(n.x===i?0:2)|Number(n.y&xc),u=s;return d&&f(s)&&(u=function(e){return f(e)?o(-e):e}(s),c^=1),new g(i,u,c)}}}(e,n,i),d=t;return ps(d.hash.outputLen,d.nByteLength,d.hmac)(s,u)},verify:function(e,r,n,i=R){let s=e;if(r=ts("msgHash",r),n=ts("publicKey",n),"strict"in i)throw new Error("options.strict was renamed to lowS");Ic(i);let c,u,{lowS:h,prehash:d}=i;try{if("string"==typeof s||$i(s))try{c=g.fromDER(s)}catch(e){if(!(e instanceof Cc.Err))throw e;c=g.fromCompact(s)}else{if("object"!=typeof s||"bigint"!=typeof s.r||"bigint"!=typeof s.s)throw new Error("PARSE");{let{r:e,s:t}=s;c=new g(e,t)}}u=l.fromHex(n)}catch(e){if("PARSE"===e.message)throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(h&&c.hasHighS())return!1;d&&(r=t.hash(r));let{r:f,s:p}=c,m=b(r),y=a(p),w=o(m*y),E=o(f*y),v=l.BASE.multiplyAndAddUnsafe(u,w,E)?.toAffine();return!!v&&o(v.x)===f},ProjectivePoint:l,Signature:g,utils:m}}function Lc(e){return{hash:e,hmac:(t,...r)=>$o(e,t,function(...e){let t=0;for(let r=0;r<e.length;r++){let n=e[r];li(n),t+=n.length}let r=new Uint8Array(t);for(let t=0,n=0;t<e.length;t++){let i=e[t];r.set(i,n),n+=i.length}return r}(...r)),randomBytes:vi}}BigInt(4);var Oc=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Bc=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),Mc=BigInt(1),Uc=BigInt(2),Fc=(e,t)=>(e+t/Uc)/t,$c=Ns(Oc,void 0,void 0,{sqrt:function(e){let t=Oc,r=BigInt(3),n=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),l=BigInt(88),c=e*e*e%t,u=c*c*e%t,h=Ts(u,r,t)*u%t,d=Ts(h,r,t)*u%t,f=Ts(d,Uc,t)*c%t,p=Ts(f,i,t)*f%t,g=Ts(p,s,t)*p%t,m=Ts(g,a,t)*g%t,y=Ts(m,l,t)*m%t,w=Ts(y,a,t)*g%t,b=Ts(w,r,t)*u%t,E=Ts(b,o,t)*p%t,v=Ts(E,n,t)*c%t,S=Ts(v,Uc,t);if(!$c.eql($c.sqr(S),e))throw new Error("Cannot find square root");return S}}),Vc=function(e,t){let r=t=>Pc({...e,...Lc(t)});return Object.freeze({...r(t),create:r})}({a:BigInt(0),b:BigInt(7),Fp:$c,n:Bc,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:e=>{let t=Bc,r=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-Mc*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=r,o=BigInt("0x100000000000000000000000000000000"),a=Fc(s*e,t),l=Fc(-n*e,t),c=Is(e-a*r-l*i,t),u=Is(-a*n-l*s,t),h=c>o,d=u>o;if(h&&(c=t-c),d&&(u=t-u),c>o||u>o)throw new Error("splitScalar: Endomorphism failed, k="+e);return{k1neg:h,k1:c,k2neg:d,k2:u}}}},_c);function Kc(e){try{Vc.ProjectivePoint.fromHex(e)}catch(e){throw new U(String(e),"ERR_INVALID_PUBLIC_KEY")}}BigInt(0),Vc.ProjectivePoint;var Hc=class{_key;constructor(e){Kc(e),this._key=e}verify(e,t){return function(e,t,r){let n=Fr.digest(r instanceof Uint8Array?r:r.subarray());if(oi(n))return n.then((({digest:r})=>Vc.verify(t,r,e))).catch((e=>{throw new U(String(e),"ERR_INVALID_INPUT")}));try{return Vc.verify(t,n.digest,e)}catch(e){throw new U(String(e),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return function(e){return Vc.ProjectivePoint.fromHex(e).toRawBytes(!0)}(this._key)}get bytes(){return wo.encode({Type:mo.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return ke(this.bytes,e.bytes)}async hash(){let e,t=Fr.digest(this.bytes);return oi(t)?({bytes:e}=await t):e=t.bytes,e}},qc=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??function(e){try{return Vc.getPublicKey(e,!0)}catch(e){throw new U(String(e),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Vc.getPublicKey(e,!0)}catch(e){throw new U(String(e),"ERR_INVALID_PRIVATE_KEY")}}(this._key),Kc(this._publicKey)}sign(e){return function(e,t){let r=Fr.digest(t instanceof Uint8Array?t:t.subarray());if(oi(r))return r.then((({digest:t})=>Vc.sign(t,e).toDERRawBytes())).catch((e=>{throw new U(String(e),"ERR_INVALID_INPUT")}));try{return Vc.sign(r.digest,e).toDERRawBytes()}catch(e){throw new U(String(e),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new Hc(this._publicKey)}marshal(){return this._key}get bytes(){return bo.encode({Type:mo.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return ke(this.bytes,e.bytes)}hash(){let e=Fr.digest(this.bytes);return oi(e)?e.then((({bytes:e})=>e)):e.bytes}async id(){return Bn(await this.public.hash(),"base58btc")}async export(e,t="libp2p-key"){if("libp2p-key"===t)return go(this.bytes,e);throw new U(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function zc(e){return new qc(e)}function Wc(e){return new Hc(e)}async function jc(){let e=Vc.utils.randomPrivateKey();return new qc(e)}var Gc={rsa:Bo,ed25519:ii,secp256k1:Ec};function Yc(e){let t=Object.keys(Gc).join(" / ");return new U(`invalid or unsupported key type ${e}. Must be ${t}`,"ERR_UNSUPPORTED_KEY_TYPE")}function Qc(e){if("rsa"===(e=e.toLowerCase())||"ed25519"===e||"secp256k1"===e)return Gc[e];throw Yc(e)}async function Jc(e,t){return Qc(e).generateKeyPair(t??2048)}async function Zc(e,t,r){if("ed25519"!==e.toLowerCase())throw new U("Seed key derivation is unimplemented for RSA or secp256k1","ERR_UNSUPPORTED_KEY_DERIVATION_TYPE");return Io(t)}function Xc(e){let t=wo.decode(e),r=t.Data??new Uint8Array;switch(t.Type){case mo.RSA:return Gc.rsa.unmarshalRsaPublicKey(r);case mo.Ed25519:return Gc.ed25519.unmarshalEd25519PublicKey(r);case mo.Secp256k1:return Gc.secp256k1.unmarshalSecp256k1PublicKey(r);default:throw Yc(t.Type??"unknown")}}function eu(e,t){return Qc(t=(t??"rsa").toLowerCase()),e.bytes}async function tu(e){let t=bo.decode(e),r=t.Data??new Uint8Array;switch(t.Type){case mo.RSA:return Gc.rsa.unmarshalRsaPrivateKey(r);case mo.Ed25519:return Gc.ed25519.unmarshalEd25519PrivateKey(r);case mo.Secp256k1:return Gc.secp256k1.unmarshalSecp256k1PrivateKey(r);default:throw Yc(t.Type??"RSA")}}function ru(e,t){return Qc(t=(t??"rsa").toLowerCase()),e.bytes}async function nu(e,t){try{let r=await async function(e,t){let r=rr.decode(e);return po().decrypt(r,t)}(e,t);return await tu(r)}catch{}if(!e.includes("BEGIN"))throw new U("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return oc(e,t)}var iu=new Uint32Array([1732584193,4023233417,2562383102,271733878,3285377520]),su=new Uint32Array(80),ou=class extends Ai{constructor(){super(64,20,8,!1),this.A=0|iu[0],this.B=0|iu[1],this.C=0|iu[2],this.D=0|iu[3],this.E=0|iu[4]}get(){let{A:e,B:t,C:r,D:n,E:i}=this;return[e,t,r,n,i]}set(e,t,r,n,i){this.A=0|e,this.B=0|t,this.C=0|r,this.D=0|n,this.E=0|i}process(e,t){for(let r=0;r<16;r++,t+=4)su[r]=e.getUint32(t,!1);for(let e=16;e<80;e++)su[e]=pi(su[e-3]^su[e-8]^su[e-14]^su[e-16],1);let{A:r,B:n,C:i,D:s,E:o}=this;for(let e=0;e<80;e++){let t,a;e<20?(t=Si(n,i,s),a=1518500249):e<40?(t=n^i^s,a=1859775393):e<60?(t=Ri(n,i,s),a=2400959708):(t=n^i^s,a=3395469782);let l=pi(r,5)+t+o+a+su[e]|0;o=s,s=i,i=pi(n,30),n=r,r=l}r=r+this.A|0,n=n+this.B|0,i=i+this.C|0,s=s+this.D|0,o=o+this.E|0,this.set(r,n,i,s,o)}roundClean(){su.fill(0)}destroy(){this.set(0,0,0,0,0),this.buffer.fill(0)}},au={sha1:Ei((()=>new ou)),"sha2-256":_c,"sha2-512":Oi};function lu(e,t,r,n,i){if("sha1"!==i&&"sha2-256"!==i&&"sha2-512"!==i){let e=Object.keys(au).join(" / ");throw new U(`Hash '${i}' is unknown or not supported. Must be ${e}`,"ERR_UNSUPPORTED_HASH_TYPE")}let s=function(e,t,r,n){let i,{c:s,dkLen:o,DK:a,PRF:l,PRFSalt:c}=Vo(e,t,r,n),u=new Uint8Array(4),h=di(u),d=new Uint8Array(l.outputLen);for(let e=1,t=0;t<o;e++,t+=l.outputLen){let r=a.subarray(t,t+l.outputLen);h.setInt32(0,e,!1),(i=c._cloneInto(i)).update(u).digestInto(d),r.set(d.subarray(0,r.length));for(let e=1;e<s;e++){l._cloneInto(i).update(d).digestInto(d);for(let e=0;e<r.length;e++)r[e]^=d[e]}}return Ko(l,c,a,i,d)}(au[i],e,t,{c:r,dkLen:n});return rr.encode(s).substring(1)}var cu=c(d(),1),uu=Math.LN2*Math.LN2,hu=class{seeds;bits;buffer;constructor(e={}){null!=e.seeds?this.seeds=e.seeds:this.seeds=function(e){let t,r,n=[];for(let i=0;i<e;i++)for(t=new xe(Mo(4)),n[i]=t.getUint32(0,!0),r=0;r<i;r++)if(n[i]===n[r]){i--;break}return n}(e.hashes??8),this.bits=e.bits??1024,this.buffer=ue(Math.ceil(this.bits/8))}add(e){"string"==typeof e&&(e=en(e));for(let t=0;t<this.seeds.length;t++){let r=cu.default.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(r)}}has(e){"string"==typeof e&&(e=en(e));for(let t=0;t<this.seeds.length;t++){let r=cu.default.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(r))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;let n=this.buffer[t];n|=1<<r,this.buffer[t]=n}getbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;return!!(this.buffer[t]&1<<r)}};var du=64,fu=class{fp;h;seed;constructor(e,t,r,n=2){if(n>du)throw new TypeError("Invalid Fingerprint Size");let i=t.hashV(e,r),s=ue(n);for(let e=0;e<s.length;e++)s[e]=i[e];0===s.length&&(s[0]=7),this.fp=s,this.h=t,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array&&ke(this.fp,e.fp)}};function pu(e,t){return Math.floor(Math.random()*(t-e))+e}var gu=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof fu))throw new TypeError("Invalid Fingerprint");return this.contents.some((t=>e.equals(t)))}add(e){if(!(e instanceof fu))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(null==this.contents[t])return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof fu))throw new TypeError("Invalid Fingerprint");let t=pu(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof fu))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex((t=>e.equals(t)));return t>-1&&(this.contents[t]=null,!0)}},mu={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},yu={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},wu=new globalThis.TextEncoder;c(d(),1);var bu={hash:e=>Number(function(e,{size:t=32,utf8Buffer:r}={}){if(!mu[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if("string"==typeof e){if(r)return function(e,t,r){if(0===r.length)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=mu[t],i=yu[t],s=e;for(;s.length>0;){let e=wu.encodeInto(s,r);s=s.slice(e.read);for(let s=0;s<e.written;s++)i^=BigInt(r[s]),i=BigInt.asUintN(t,i*n)}return i}(e,t,r);e=wu.encode(e)}return function(e,t){let r=mu[t],n=yu[t];for(let i=0;i<e.length;i++)n^=BigInt(e[i]),n=BigInt.asUintN(t,n*r);return n}(e,t)}(e,{size:32})),hashV:(e,t)=>function(e){let t=e.toString(16);return t.length%2==1&&(t=`0${t}`),en(t,"base16")}(bu.hash(e,t))},Eu=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??bu,this.seed=e.seed??pu(0,Math.pow(2,10))}add(e){"string"==typeof e&&(e=en(e));let t=new fu(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,n=(r^t.hash())%this.filterSize;if(null==this.buckets[r]&&(this.buckets[r]=new gu(this.bucketSize)),null==this.buckets[n]&&(this.buckets[n]=new gu(this.bucketSize)),this.buckets[r].add(t)||this.buckets[n].add(t))return this.count++,!0;let i=[r,n],s=i[pu(0,i.length-1)];null==this.buckets[s]&&(this.buckets[s]=new gu(this.bucketSize));for(let e=0;e<500;e++){let e=this.buckets[s].swap(t);if(null!=e&&(s=(s^e.hash())%this.filterSize,null==this.buckets[s]&&(this.buckets[s]=new gu(this.bucketSize)),this.buckets[s].add(e)))return this.count++,!0}return!1}has(e){"string"==typeof e&&(e=en(e));let t=new fu(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,n=this.buckets[r]?.has(t)??!1;if(n)return n;let i=(r^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){"string"==typeof e&&(e=en(e));let t=new fu(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,n=this.buckets[r]?.remove(t)??!1;if(n)return this.count--,n;let i=(r^t.hash())%this.filterSize,s=this.buckets[i]?.remove(t)??!1;return s&&this.count--,s}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}},vu={1:.5,2:.84,4:.95,8:.98};function Su(e,t=.001){let r=function(e=.001){return e>.002?2:e>1e-5?4:8}(t),n=vu[r];return{filterSize:Math.round(e/n),bucketSize:r,fingerprintSize:Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*r)),du)}}var Ru=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??bu,this.seed=e.seed??pu(0,Math.pow(2,10)),this.filterSeries=[new Eu({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if("string"==typeof e&&(e=en(e)),this.has(e))return!0;let t=this.filterSeries.find((e=>e.reliable));if(null==t){let e=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Eu({filterSize:e,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){"string"==typeof e&&(e=en(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){"string"==typeof e&&(e=en(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce(((e,t)=>e+t.count),0)}};function Au(e,t=.001,r){return new Ru({...Su(e,t),...r??{}})}var _u=class{filter;constructor(e,t){this.filter=Au(e,t)}has(e){return this.filter.has(e.toBytes())}add(e){this.filter.add(e.toBytes())}remove(e){this.filter.remove?.(e.toBytes())}};function Iu(e,t=.001){return new _u(e,t)}var ku=class extends Zn{metric;constructor(e){super();let{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Tu(e){let t,{name:r,metrics:n}=e;return t=null!=n?new ku({name:r,metrics:n}):new Zn,t}var Cu=class{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){let r=rr.encode(e.multihash.bytes);this.wantlist.set(r,t)}addBlockPresence(e,t){let r=rr.encode(e.multihash.bytes);this.blockPresences.set(r,t)}addBlock(e,t){let r=rr.encode(e.multihash.bytes);this.blocks.set(r,t)}};function Du(e){return function(e){let t=new Uint8Array(e.reduce(((e,t)=>e+ve(t)),0)),r=0;for(let n of e)t=Ae(n,t,r),r+=ve(n);return t}([e.version,e.code,e.multihash.code,e.multihash.digest.byteLength])}var xu=class{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){let t=new Cu,r=new Set;for(let[n,i]of this.wants.entries())try{let s=await this.blockstore.get(i.cid,e);i.wantType===En.WantHave?s.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),r.add(n),t.addBlock(i.cid,{data:s,prefix:Du(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:_n.HaveBlock})):(this.log("sending block for %c",i.cid),r.add(n),t.addBlock(i.cid,{data:s,prefix:Du(i.cid)}))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||!0===i.sentDontHave)continue;i.sentDontHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:_n.DontHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce(((e,t)=>e+t.data.byteLength),0));for(let e of r)this.wants.delete(e)}}},Nu=class{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Tu({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",(e=>{this.receiveMessage(e.detail.peer,e.detail.message).catch((t=>{this.log.error("error receiving bitswap message from %p",e.detail.peer,t)}))})),this.network.addEventListener("peer:disconnected",(e=>{this.peerDisconnected(e.detail)}))}ledgerForPeer(e){let t=this.ledgerMap.get(e);if(null!=t)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){let t=this.ledgerMap.get(e);if(null!=t)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map((e=>e.peerId))}async receiveMessage(e,t){let r=this.ledgerMap.get(e);if(null==r&&(r=new xu({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,r)),r.receivedBytes(t.blocks?.reduce(((e,t)=>e+t.data.byteLength),0)??0),null!=t.wantlist){!0===t.wantlist.full&&r.wants.clear();for(let n of t.wantlist.entries){let t=qr.decode(n.cid),i=Bn(t.multihash.bytes,"base64");!0===n.cancel?(this.log("peer %p cancelled want of block for %c",e,t),r.wants.delete(i)):(n.wantType===En.WantHave?this.log("peer %p wanted block presence for %c",e,t):this.log("peer %p wanted block for %c",e,t),r.wants.set(i,{cid:t,priority:n.priority,wantType:n.wantType??En.WantBlock,sendDontHave:n.sendDontHave??!1}))}}this.log("send blocks to peer"),await r.sendBlocksToPeer()}async receivedBlock(e,t){let r=Bn(e.multihash.bytes,"base64"),n=[];for(let e of this.ledgerMap.values())e.wants.has(r)&&n.push(e);await Promise.all(n.map((async e=>e.sendBlocksToPeer(t))))}peerDisconnected(e){this.ledgerMap.delete(e)}},Pu=function(e,t){try{if("string"==typeof e&&e.length>0)return function(e){if((e=String(e)).length>100)throw new Error("Value exceeds the maximum length of 100 characters.");let t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return NaN;let r=parseFloat(t[1]),n=(t[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return 6048e5*r;case"days":case"day":case"d":return 864e5*r;case"hours":case"hour":case"hrs":case"hr":case"h":return 36e5*r;case"minutes":case"minute":case"mins":case"min":case"m":return 6e4*r;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}(e);if("number"==typeof e&&isFinite(e))return t?.long?function(e){let t=Math.abs(e);return t>=864e5?Lu(e,t,864e5,"day"):t>=36e5?Lu(e,t,36e5,"hour"):t>=6e4?Lu(e,t,6e4,"minute"):t>=1e3?Lu(e,t,1e3,"second"):`${e} ms`}(e):function(e){let t=Math.abs(e);return t>=864e5?`${Math.round(e/864e5)}d`:t>=36e5?`${Math.round(e/36e5)}h`:t>=6e4?`${Math.round(e/6e4)}m`:t>=1e3?`${Math.round(e/1e3)}s`:`${e}ms`}(e);throw new Error("Value is not a string or number.")}catch(t){let r=function(e){return"object"==typeof e&&null!==e&&"message"in e}(t)?`${t.message}. value=${JSON.stringify(e)}`:"An unknown error has occured.";throw new Error(r)}};function Lu(e,t,r,n){let i=t>=1.5*r;return`${Math.round(e/r)} ${n}${i?"s":""}`}var Ou=function(){try{return localStorage}catch{}}(),Bu=console.debug??console.log??(()=>{}),Mu=function(e){function t(e){let n,i,s,o=null;function a(...e){if(!a.enabled)return;let r=a,i=Number(new Date),s=i-(n||i);r.diff=s,r.prev=n,r.curr=i,n=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((n,i)=>{if("%%"===n)return"%";o++;let s=t.formatters[i];if("function"==typeof s){let t=e[o];n=s.call(r,t),e.splice(o,1),o--}return n})),t.formatArgs.call(r,e),(r.log||t.log).apply(r,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=r,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==t.namespaces&&(i=t.namespaces,s=t.enabled(e)),s),set:e=>{o=e}}),"function"==typeof t.init&&t.init(a),a}function r(e,r){let n=t(this.namespace+(typeof r>"u"?":":r)+e);return n.log=this.log,n}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack??e.message:e},t.disable=function(){let e=[...t.names.map(n),...t.skips.map(n).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){t.save(e),t.namespaces=e,t.names=[],t.skips=[];let r,n=("string"==typeof e?e:"").split(/[\s,]+/),i=n.length;for(r=0;r<i;r++)n[r]&&("-"===(e=n[r].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,n;for(r=0,n=t.skips.length;r<n;r++)if(t.skips[r].test(e))return!1;for(r=0,n=t.names.length;r<n;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=Pu,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.setupFormatters(t.formatters),t.enable(t.load()),t}({formatArgs:function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+Pu(this.diff),!this.useColors)return;let t="color: "+this.color;e.splice(1,0,t,"color: inherit");let r=0,n=0;e[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(r++,"%c"===e&&(n=r))})),e.splice(n,0,t)},save:function(e){try{e?Ou?.setItem("debug",e):Ou?.removeItem("debug")}catch{}},load:function(){let e;try{e=Ou?.getItem("debug")}catch{}return!e&&typeof process<"u"&&"env"in process&&(e=process.env.DEBUG),e},useColors:function(){return!(!(typeof window<"u"&&window.process)||"renderer"!==window.process.type&&!window.process.__nwjs)||!(typeof navigator<"u"&&null!=navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/))&&(typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&null!=navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/))},setupFormatters:function(e){e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},colors:["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],storage:Ou,log:Bu}),Uu=Mu;function Fu(){return{forComponent:e=>$u(e)}}function $u(e){let t=function(e){let t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}(`${e}:trace`);return Uu.enabled(`${e}:trace`)&&null!=Uu.names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=Uu(`${e}:trace`)),Object.assign(Uu(e),{error:Uu(`${e}:error`),trace:t})}Uu.formatters.b=e=>null==e?"undefined":Xt.baseEncode(e),Uu.formatters.t=e=>null==e?"undefined":$t.baseEncode(e),Uu.formatters.m=e=>null==e?"undefined":rr.baseEncode(e),Uu.formatters.p=e=>null==e?"undefined":e.toString(),Uu.formatters.c=e=>null==e?"undefined":e.toString(),Uu.formatters.k=e=>null==e?"undefined":e.toString(),Uu.formatters.a=e=>null==e?"undefined":e.toString();var Vu=c(f(),1),Ku=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Hu=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},qu=e=>void 0===globalThis.DOMException?new Hu(e):new DOMException(e),zu=e=>{let t=void 0===e.reason?qu("This operation was aborted."):e.reason;return t instanceof Error?t:qu(t)};function Wu(e,t){let r,{milliseconds:n,fallback:i,message:s,customTimers:o={setTimeout,clearTimeout}}=t,a=new Promise(((a,l)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(t.signal){let{signal:e}=t;e.aborted&&l(zu(e)),e.addEventListener("abort",(()=>{l(zu(e))}))}if(n===Number.POSITIVE_INFINITY)return void e.then(a,l);let c=new Ku;r=o.setTimeout.call(void 0,(()=>{if(i)try{a(i())}catch(e){l(e)}else"function"==typeof e.cancel&&e.cancel(),!1===s?a():s instanceof Error?l(s):(c.message=s??`Promise timed out after ${n} milliseconds`,l(c))}),n),(async()=>{try{a(await e)}catch(e){l(e)}})()})).finally((()=>{a.clear()}));return a.clear=()=>{o.clearTimeout.call(void 0,r),r=void 0},a}var ju=class{#e=[];enqueue(e,t){let r={priority:(t={priority:0,...t}).priority,run:e};if(this.size&&this.#e[this.size-1].priority>=t.priority)return void this.#e.push(r);let n=function(e,t,r){let n=0,i=e.length;for(;i>0;){let s=Math.trunc(i/2),o=n+s;r(e[o],t)<=0?(n=++o,i-=s+1):i=s}return n}(this.#e,r,((e,t)=>t.priority-e.priority));this.#e.splice(n,0,r)}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this.#e.length}},Gu=class extends Vu.default{#e;#t;#r=0;#n;#i;#s=0;#o;#a;#l;#c;#u=0;#h;#d;#f;timeout;constructor(e){if(super(),!("number"==typeof(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:ju,...e}).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||0===e.interval,this.#n=e.intervalCap,this.#i=e.interval,this.#l=new e.queueClass,this.#c=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#f=!0===e.throwOnTimeout,this.#d=!1===e.autoStart}get#p(){return this.#t||this.#r<this.#n}get#g(){return this.#u<this.#h}#m(){this.#u--,this.#y(),this.emit("next")}#w(){this.#b(),this.#E(),this.#a=void 0}get#v(){let e=Date.now();if(void 0===this.#o){let t=this.#s-e;if(!(t<0))return void 0===this.#a&&(this.#a=setTimeout((()=>{this.#w()}),t)),!0;this.#r=this.#e?this.#u:0}return!1}#y(){if(0===this.#l.size)return this.#o&&clearInterval(this.#o),this.#o=void 0,this.emit("empty"),0===this.#u&&this.emit("idle"),!1;if(!this.#d){let e=!this.#v;if(this.#p&&this.#g){let t=this.#l.dequeue();return!!t&&(this.emit("active"),t(),e&&this.#E(),!0)}}return!1}#E(){this.#t||void 0!==this.#o||(this.#o=setInterval((()=>{this.#b()}),this.#i),this.#s=Date.now()+this.#i)}#b(){0===this.#r&&0===this.#u&&this.#o&&(clearInterval(this.#o),this.#o=void 0),this.#r=this.#e?this.#u:0,this.#S()}#S(){for(;this.#y(););}get concurrency(){return this.#h}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#h=e,this.#S()}async#R(e){return new Promise(((t,r)=>{e.addEventListener("abort",(()=>{r(e.reason)}),{once:!0})}))}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:this.#f,...t},new Promise(((r,n)=>{this.#l.enqueue((async()=>{this.#u++,this.#r++;try{t.signal?.throwIfAborted();let n=e({signal:t.signal});t.timeout&&(n=Wu(Promise.resolve(n),{milliseconds:t.timeout})),t.signal&&(n=Promise.race([n,this.#R(t.signal)]));let i=await n;r(i),this.emit("completed",i)}catch(e){if(e instanceof Ku&&!t.throwOnTimeout)return void r();n(e),this.emit("error",e)}finally{this.#m()}}),t),this.emit("add"),this.#y()}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this.#d?(this.#d=!1,this.#S(),this):this}pause(){this.#d=!0}clear(){this.#l=new this.#c}async onEmpty(){0!==this.#l.size&&await this.#A("empty")}async onSizeLessThan(e){this.#l.size<e||await this.#A("next",(()=>this.#l.size<e))}async onIdle(){0===this.#u&&0===this.#l.size||await this.#A("idle")}async#A(e,t){return new Promise((r=>{let n=()=>{t&&!t()||(this.off(e,n),r())};this.on(e,n)}))}get size(){return this.#l.size}sizeBy(e){return this.#l.filter(e).length}get pending(){return this.#u}get isPaused(){return this.#d}};function Yu(e){let t=[Xu.A];return null==e?t:Array.isArray(e)?0===e.length?t:e:[e]}var Qu=60;function Ju(e){return{Status:e.Status??0,TC:e.TC??e.flag_tc??!1,RD:e.RD??e.flag_rd??!1,RA:e.RA??e.flag_ra??!1,AD:e.AD??e.flag_ad??!1,CD:e.CD??e.flag_cd??!1,Question:(e.Question??e.questions??[]).map((e=>({name:e.name,type:Xu[e.type]}))),Answer:(e.Answer??e.answers??[]).map((e=>({name:e.name,type:Xu[e.type],TTL:e.TTL??e.ttl??Qu,data:e.data instanceof Uint8Array?Bn(e.data):e.data})))}}function Zu(e,t={}){let r=new Gu({concurrency:t.queryConcurrency??4});return async(t,n={})=>{let i=new URLSearchParams;i.set("name",t),Yu(n.types).forEach((e=>{i.append("type",Xu[e])})),n.onProgress?.(new Xe("dns:query",{detail:t}));let s=await r.add((async()=>{let t=await fetch(`${e}?${i}`,{headers:{accept:"application/dns-json"},signal:n?.signal});if(200!==t.status)throw new Error(`Unexpected HTTP status: ${t.status} - ${t.statusText}`);let r=Ju(await t.json());return n.onProgress?.(new Xe("dns:response",{detail:r})),r}),{signal:n.signal});if(null==s)throw new Error("No DNS response received");return s}}var Xu,eh=c(p(),1),th=class{lru;constructor(e){this.lru=(0,eh.default)(e)}get(e,t){let r=!0,n=[];for(let i of t){let t=this.getAnswers(e,i);if(0===t.length){r=!1;break}n.push(...t)}if(r)return Ju({answers:n})}getAnswers(e,t){let r=`${e.toLowerCase()}-${t}`,n=this.lru.get(r);if(null!=n){let e=n.filter((e=>e.expires>Date.now())).map((({expires:e,value:t})=>({...t,TTL:Math.round((e-Date.now())/1e3),type:Xu[t.type]})));return 0===e.length&&this.lru.remove(r),e}return[]}add(e,t){let r=`${e.toLowerCase()}-${t.type}`,n=this.lru.get(r)??[];n.push({expires:Date.now()+1e3*(t.TTL??Qu),value:t}),this.lru.set(r,n)}remove(e,t){let r=`${e.toLowerCase()}-${t}`;this.lru.remove(r)}clear(){this.lru.clear()}},rh=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=function(e){return new th(e)}(e.cacheSize??1e3),Object.entries(e.resolvers??{}).forEach((([e,t])=>{Array.isArray(t)||(t=[t]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=t})),null==this.resolvers["."]&&(this.resolvers["."]=[Zu("https://cloudflare-dns.com/dns-query"),Zu("https://dns.google/resolve")])}async query(e,t={}){let r=Yu(t.types),n=!1!==t.cached?this.cache.get(e,r):void 0;if(null!=n)return t.onProgress?.(new Xe("dns:cache",{detail:n})),n;let i=`${e.split(".").pop()}.`,s=(this.resolvers[i]??this.resolvers["."]).sort((()=>Math.random()>.5?-1:1)),o=[];for(let n of s){if(!0===t.signal?.aborted)break;try{let i=await n(e,{...t,types:r});for(let t of i.Answer)this.cache.add(e,t);return i}catch(e){o.push(e),t.onProgress?.(new Xe("dns:error",{detail:e}))}}throw 1===o.length?o[0]:new AggregateError(o,`DNS lookup of ${e} ${r} failed`)}};function nh(e={}){return new rh(e)}!function(e){e[e.A=1]="A",e[e.CNAME=5]="CNAME",e[e.TXT=16]="TXT",e[e.AAAA=28]="AAAA"}(Xu||(Xu={}));var ih=["string","number","bigint","symbol"],sh=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];var oh=class{constructor(e,t,r){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=r}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};oh.uint=new oh(0,"uint",!0),oh.negint=new oh(1,"negint",!0),oh.bytes=new oh(2,"bytes",!0),oh.string=new oh(3,"string",!0),oh.array=new oh(4,"array",!1),oh.map=new oh(5,"map",!1),oh.tag=new oh(6,"tag",!1),oh.float=new oh(7,"float",!0),oh.false=new oh(7,"false",!0),oh.true=new oh(7,"true",!0),oh.null=new oh(7,"null",!0),oh.undefined=new oh(7,"undefined",!0),oh.break=new oh(7,"break",!0);var ah=class{constructor(e,t,r){this.type=e,this.value=t,this.encodedLength=r,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}},lh=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.isBuffer,ch=new TextDecoder,uh=new TextEncoder;function hh(e){return lh&&globalThis.Buffer.isBuffer(e)}function dh(e){return e instanceof Uint8Array?hh(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e:Uint8Array.from(e)}var fh=lh?(e,t,r)=>r-t>64?globalThis.Buffer.from(e.subarray(t,r)).toString("utf8"):Eh(e,t,r):(e,t,r)=>r-t>64?ch.decode(e.subarray(t,r)):Eh(e,t,r),ph=lh?e=>e.length>64?globalThis.Buffer.from(e):bh(e):e=>e.length>64?uh.encode(e):bh(e),gh=e=>Uint8Array.from(e),mh=lh?(e,t,r)=>hh(e)?new Uint8Array(e.subarray(t,r)):e.slice(t,r):(e,t,r)=>e.slice(t,r),yh=lh?(e,t)=>(e=e.map((e=>e instanceof Uint8Array?e:globalThis.Buffer.from(e))),dh(globalThis.Buffer.concat(e,t))):(e,t)=>{let r=new Uint8Array(t),n=0;for(let t of e)n+t.length>r.length&&(t=t.subarray(0,r.length-n)),r.set(t,n),n+=t.length;return r},wh=lh?e=>globalThis.Buffer.allocUnsafe(e):e=>new Uint8Array(e);function bh(e){let t=[],r=0;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);i<128?t[r++]=i:i<2048?(t[r++]=i>>6|192,t[r++]=63&i|128):55296==(64512&i)&&n+1<e.length&&56320==(64512&e.charCodeAt(n+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++n)),t[r++]=i>>18|240,t[r++]=i>>12&63|128,t[r++]=i>>6&63|128,t[r++]=63&i|128):(t[r++]=i>>12|224,t[r++]=i>>6&63|128,t[r++]=63&i|128)}return t}function Eh(e,t,r){let n=[];for(;t<r;){let i=e[t],s=null,o=i>239?4:i>223?3:i>191?2:1;if(t+o<=r){let r,n,a,l;switch(o){case 1:i<128&&(s=i);break;case 2:r=e[t+1],128==(192&r)&&(l=(31&i)<<6|63&r,l>127&&(s=l));break;case 3:r=e[t+1],n=e[t+2],128==(192&r)&&128==(192&n)&&(l=(15&i)<<12|(63&r)<<6|63&n,l>2047&&(l<55296||l>57343)&&(s=l));break;case 4:r=e[t+1],n=e[t+2],a=e[t+3],128==(192&r)&&128==(192&n)&&128==(192&a)&&(l=(15&i)<<18|(63&r)<<12|(63&n)<<6|63&a,l>65535&&l<1114112&&(s=l))}}null===s?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|1023&s),n.push(s),t+=o}return Sh(n)}var vh=4096;function Sh(e){let t=e.length;if(t<=vh)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=vh));return r}var Rh=class{constructor(e=256){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),null!==this._initReuseChunk&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let r=t.length-(this.maxCursor-this.cursor)-1;t.set(e,r)}else{if(t){let e=t.length-(this.maxCursor-this.cursor)-1;e<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,e),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=wh(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,null===this._initReuseChunk&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(1===this.chunks.length){let r=this.chunks[0];e&&this.cursor>r.length/2?(t=this.cursor===r.length?r:r.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=mh(r,0,this.cursor)}else t=yh(this.chunks,this.cursor);return e&&this.reset(),t}},Ah="CBOR decode error:",_h="CBOR encode error:",Ih=[];function kh(e,t,r){if(e.length-t<r)throw new Error(`${Ah} not enough data for type`)}Ih[23]=1,Ih[24]=2,Ih[25]=3,Ih[26]=5,Ih[27]=9;var Th=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Ch(e,t,r){kh(e,t,1);let n=e[t];if(!0===r.strict&&n<Th[0])throw new Error(`${Ah} integer encoded in more bytes than necessary (strict decode)`);return n}function Dh(e,t,r){kh(e,t,2);let n=e[t]<<8|e[t+1];if(!0===r.strict&&n<Th[1])throw new Error(`${Ah} integer encoded in more bytes than necessary (strict decode)`);return n}function xh(e,t,r){kh(e,t,4);let n=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];if(!0===r.strict&&n<Th[2])throw new Error(`${Ah} integer encoded in more bytes than necessary (strict decode)`);return n}function Nh(e,t,r){kh(e,t,8);let n=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3],i=16777216*e[t+4]+(e[t+5]<<16)+(e[t+6]<<8)+e[t+7],s=(BigInt(n)<<BigInt(32))+BigInt(i);if(!0===r.strict&&s<Th[3])throw new Error(`${Ah} integer encoded in more bytes than necessary (strict decode)`);if(s<=Number.MAX_SAFE_INTEGER)return Number(s);if(!0===r.allowBigInt)return s;throw new Error(`${Ah} integers outside of the safe integer range are not supported`)}function Ph(e,t){return Lh(e,0,t.value)}function Lh(e,t,r){if(r<Th[0]){let n=Number(r);e.push([t|n])}else if(r<Th[1]){let n=Number(r);e.push([24|t,n])}else if(r<Th[2]){let n=Number(r);e.push([25|t,n>>>8,255&n])}else if(r<Th[3]){let n=Number(r);e.push([26|t,n>>>24&255,n>>>16&255,n>>>8&255,255&n])}else{let n=BigInt(r);if(!(n<Th[4]))throw new Error(`${Ah} encountered BigInt larger than allowable range`);{let r=[27|t,0,0,0,0,0,0,0],i=Number(n&BigInt(4294967295)),s=Number(n>>BigInt(32)&BigInt(4294967295));r[8]=255&i,i>>=8,r[7]=255&i,i>>=8,r[6]=255&i,i>>=8,r[5]=255&i,r[4]=255&s,s>>=8,r[3]=255&s,s>>=8,r[2]=255&s,s>>=8,r[1]=255&s,e.push(r)}}}Ph.encodedSize=function(e){return Lh.encodedSize(e.value)},Lh.encodedSize=function(e){return e<Th[0]?1:e<Th[1]?2:e<Th[2]?3:e<Th[3]?5:9},Ph.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};var Oh=BigInt(-1),Bh=BigInt(1);function Mh(e,t){let r=t.value,n="bigint"==typeof r?r*Oh-Bh:-1*r-1;Lh(e,t.type.majorEncoded,n)}function Uh(e,t,r,n){kh(e,t,r+n);let i=mh(e,t+r,t+r+n);return new ah(oh.bytes,i,r+n)}function Fh(e,t,r,n){return Uh(e,t,1,r)}function $h(e){return void 0===e.encodedBytes&&(e.encodedBytes=e.type===oh.string?ph(e.value):e.value),e.encodedBytes}function Vh(e,t){let r=$h(t);Lh(e,t.type.majorEncoded,r.length),e.push(r)}function Kh(e,t,r,n,i){let s=r+n;kh(e,t,s);let o=new ah(oh.string,fh(e,t+r,t+s),s);return!0===i.retainStringBytes&&(o.byteValue=mh(e,t+r,t+s)),o}function Hh(e,t,r,n){return Kh(e,t,1,r,n)}Mh.encodedSize=function(e){let t=e.value,r="bigint"==typeof t?t*Oh-Bh:-1*t-1;return r<Th[0]?1:r<Th[1]?2:r<Th[2]?3:r<Th[3]?5:9},Mh.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0},Vh.encodedSize=function(e){let t=$h(e);return Lh.encodedSize(t.length)+t.length},Vh.compareTokens=function(e,t){return function(e,t){return e.length<t.length?-1:e.length>t.length?1:function(e,t){if(hh(e)&&hh(t))return e.compare(t);for(let r=0;r<e.length;r++)if(e[r]!==t[r])return e[r]<t[r]?-1:1;return 0}(e,t)}($h(e),$h(t))};var qh=Vh;function zh(e,t,r,n){return new ah(oh.array,n,r)}function Wh(e,t,r,n){return zh(0,0,1,r)}function jh(e,t){Lh(e,oh.array.majorEncoded,t.value)}function Gh(e,t,r,n){return new ah(oh.map,n,r)}function Yh(e,t,r,n){return Gh(0,0,1,r)}function Qh(e,t){Lh(e,oh.map.majorEncoded,t.value)}function Jh(e,t,r,n){return new ah(oh.tag,r,1)}function Zh(e,t){Lh(e,oh.tag.majorEncoded,t.value)}jh.compareTokens=Ph.compareTokens,jh.encodedSize=function(e){return Lh.encodedSize(e.value)},Qh.compareTokens=Ph.compareTokens,Qh.encodedSize=function(e){return Lh.encodedSize(e.value)},Zh.compareTokens=Ph.compareTokens,Zh.encodedSize=function(e){return Lh.encodedSize(e.value)};function Xh(e,t,r){if(r){if(!1===r.allowNaN&&Number.isNaN(e))throw new Error(`${Ah} NaN values are not supported`);if(!1===r.allowInfinity&&(e===1/0||e===-1/0))throw new Error(`${Ah} Infinity values are not supported`)}return new ah(oh.float,e,t)}function ed(e,t,r){let n=t.value;if(!1===n)e.push([20|oh.float.majorEncoded]);else if(!0===n)e.push([21|oh.float.majorEncoded]);else if(null===n)e.push([22|oh.float.majorEncoded]);else if(void 0===n)e.push([23|oh.float.majorEncoded]);else{let t,i=!1;(!r||!0!==r.float64)&&(id(n),t=sd(nd,1),n===t||Number.isNaN(n)?(nd[0]=249,e.push(nd.slice(0,3)),i=!0):(od(n),t=ad(nd,1),n===t&&(nd[0]=250,e.push(nd.slice(0,5)),i=!0))),i||(function(e){rd.setFloat64(0,e,!1)}(n),t=ld(nd,1),nd[0]=251,e.push(nd.slice(0,9)))}}ed.encodedSize=function(e,t){let r=e.value;if(!1===r||!0===r||null==r)return 1;if(!t||!0!==t.float64){id(r);let e=sd(nd,1);if(r===e||Number.isNaN(r))return 3;if(od(r),e=ad(nd,1),r===e)return 5}return 9};var td=new ArrayBuffer(9),rd=new DataView(td,1),nd=new Uint8Array(td,0);function id(e){if(e===1/0)rd.setUint16(0,31744,!1);else if(e===-1/0)rd.setUint16(0,64512,!1);else if(Number.isNaN(e))rd.setUint16(0,32256,!1);else{rd.setFloat32(0,e);let t=rd.getUint32(0),r=(2139095040&t)>>23,n=8388607&t;if(255===r)rd.setUint16(0,31744,!1);else if(0===r)rd.setUint16(0,(2147483648&e)>>16|n>>13,!1);else{let e=r-127;e<-24?rd.setUint16(0,0):e<-14?rd.setUint16(0,(2147483648&t)>>16|1<<24+e,!1):rd.setUint16(0,(2147483648&t)>>16|e+15<<10|n>>13,!1)}}}function sd(e,t){if(e.length-t<2)throw new Error(`${Ah} not enough data for float16`);let r=(e[t]<<8)+e[t+1];if(31744===r)return 1/0;if(64512===r)return-1/0;if(32256===r)return NaN;let n,i=r>>10&31,s=1023&r;return n=0===i?s*2**-24:31!==i?(s+1024)*2**(i-25):0===s?1/0:NaN,32768&r?-n:n}function od(e){rd.setFloat32(0,e,!1)}function ad(e,t){if(e.length-t<4)throw new Error(`${Ah} not enough data for float32`);let r=(e.byteOffset||0)+t;return new DataView(e.buffer,r,4).getFloat32(0,!1)}function ld(e,t){if(e.length-t<8)throw new Error(`${Ah} not enough data for float64`);let r=(e.byteOffset||0)+t;return new DataView(e.buffer,r,8).getFloat64(0,!1)}function cd(e,t,r){throw new Error(`${Ah} encountered invalid minor (${r}) for major ${e[t]>>>5}`)}function ud(e){return()=>{throw new Error(`${Ah} ${e}`)}}ed.compareTokens=Ph.compareTokens;var hd=[];for(let e=0;e<=23;e++)hd[e]=cd;hd[24]=function(e,t,r,n){return new ah(oh.uint,Ch(e,t+1,n),2)},hd[25]=function(e,t,r,n){return new ah(oh.uint,Dh(e,t+1,n),3)},hd[26]=function(e,t,r,n){return new ah(oh.uint,xh(e,t+1,n),5)},hd[27]=function(e,t,r,n){return new ah(oh.uint,Nh(e,t+1,n),9)},hd[28]=cd,hd[29]=cd,hd[30]=cd,hd[31]=cd;for(let e=32;e<=55;e++)hd[e]=cd;hd[56]=function(e,t,r,n){return new ah(oh.negint,-1-Ch(e,t+1,n),2)},hd[57]=function(e,t,r,n){return new ah(oh.negint,-1-Dh(e,t+1,n),3)},hd[58]=function(e,t,r,n){return new ah(oh.negint,-1-xh(e,t+1,n),5)},hd[59]=function(e,t,r,n){let i=Nh(e,t+1,n);if("bigint"!=typeof i){let e=-1-i;if(e>=Number.MIN_SAFE_INTEGER)return new ah(oh.negint,e,9)}if(!0!==n.allowBigInt)throw new Error(`${Ah} integers outside of the safe integer range are not supported`);return new ah(oh.negint,Oh-BigInt(i),9)},hd[60]=cd,hd[61]=cd,hd[62]=cd,hd[63]=cd;for(let e=64;e<=87;e++)hd[e]=Fh;hd[88]=function(e,t,r,n){return Uh(e,t,2,Ch(e,t+1,n))},hd[89]=function(e,t,r,n){return Uh(e,t,3,Dh(e,t+1,n))},hd[90]=function(e,t,r,n){return Uh(e,t,5,xh(e,t+1,n))},hd[91]=function(e,t,r,n){let i=Nh(e,t+1,n);if("bigint"==typeof i)throw new Error(`${Ah} 64-bit integer bytes lengths not supported`);return Uh(e,t,9,i)},hd[92]=cd,hd[93]=cd,hd[94]=cd,hd[95]=ud("indefinite length bytes/strings are not supported");for(let e=96;e<=119;e++)hd[e]=Hh;hd[120]=function(e,t,r,n){return Kh(e,t,2,Ch(e,t+1,n),n)},hd[121]=function(e,t,r,n){return Kh(e,t,3,Dh(e,t+1,n),n)},hd[122]=function(e,t,r,n){return Kh(e,t,5,xh(e,t+1,n),n)},hd[123]=function(e,t,r,n){let i=Nh(e,t+1,n);if("bigint"==typeof i)throw new Error(`${Ah} 64-bit integer string lengths not supported`);return Kh(e,t,9,i,n)},hd[124]=cd,hd[125]=cd,hd[126]=cd,hd[127]=ud("indefinite length bytes/strings are not supported");for(let e=128;e<=151;e++)hd[e]=Wh;hd[152]=function(e,t,r,n){return zh(0,0,2,Ch(e,t+1,n))},hd[153]=function(e,t,r,n){return zh(0,0,3,Dh(e,t+1,n))},hd[154]=function(e,t,r,n){return zh(0,0,5,xh(e,t+1,n))},hd[155]=function(e,t,r,n){let i=Nh(e,t+1,n);if("bigint"==typeof i)throw new Error(`${Ah} 64-bit integer array lengths not supported`);return zh(0,0,9,i)},hd[156]=cd,hd[157]=cd,hd[158]=cd,hd[159]=function(e,t,r,n){if(!1===n.allowIndefinite)throw new Error(`${Ah} indefinite length items not allowed`);return zh(0,0,1,1/0)};for(let e=160;e<=183;e++)hd[e]=Yh;hd[184]=function(e,t,r,n){return Gh(0,0,2,Ch(e,t+1,n))},hd[185]=function(e,t,r,n){return Gh(0,0,3,Dh(e,t+1,n))},hd[186]=function(e,t,r,n){return Gh(0,0,5,xh(e,t+1,n))},hd[187]=function(e,t,r,n){let i=Nh(e,t+1,n);if("bigint"==typeof i)throw new Error(`${Ah} 64-bit integer map lengths not supported`);return Gh(0,0,9,i)},hd[188]=cd,hd[189]=cd,hd[190]=cd,hd[191]=function(e,t,r,n){if(!1===n.allowIndefinite)throw new Error(`${Ah} indefinite length items not allowed`);return Gh(0,0,1,1/0)};for(let e=192;e<=215;e++)hd[e]=Jh;hd[216]=function(e,t,r,n){return new ah(oh.tag,Ch(e,t+1,n),2)},hd[217]=function(e,t,r,n){return new ah(oh.tag,Dh(e,t+1,n),3)},hd[218]=function(e,t,r,n){return new ah(oh.tag,xh(e,t+1,n),5)},hd[219]=function(e,t,r,n){return new ah(oh.tag,Nh(e,t+1,n),9)},hd[220]=cd,hd[221]=cd,hd[222]=cd,hd[223]=cd;for(let e=224;e<=243;e++)hd[e]=ud("simple values are not supported");hd[244]=cd,hd[245]=cd,hd[246]=cd,hd[247]=function(e,t,r,n){if(!1===n.allowUndefined)throw new Error(`${Ah} undefined values are not supported`);return!0===n.coerceUndefinedToNull?new ah(oh.null,null,1):new ah(oh.undefined,void 0,1)},hd[248]=ud("simple values are not supported"),hd[249]=function(e,t,r,n){return Xh(sd(e,t+1),3,n)},hd[250]=function(e,t,r,n){return Xh(ad(e,t+1),5,n)},hd[251]=function(e,t,r,n){return Xh(ld(e,t+1),9,n)},hd[252]=cd,hd[253]=cd,hd[254]=cd,hd[255]=function(e,t,r,n){if(!1===n.allowIndefinite)throw new Error(`${Ah} indefinite length items not allowed`);return new ah(oh.break,void 0,1)};var dd=[];for(let e=0;e<24;e++)dd[e]=new ah(oh.uint,e,1);for(let e=-1;e>=-24;e--)dd[31-e]=new ah(oh.negint,e,1);dd[64]=new ah(oh.bytes,new Uint8Array(0),1),dd[96]=new ah(oh.string,"",1),dd[128]=new ah(oh.array,0,1),dd[160]=new ah(oh.map,0,1),dd[244]=new ah(oh.false,!1,1),dd[245]=new ah(oh.true,!0,1),dd[246]=new ah(oh.null,null,1);var fd={float64:!1,mapSorter:function(e,t){let r=Array.isArray(e[0])?e[0][0]:e[0],n=Array.isArray(t[0])?t[0][0]:t[0];if(r.type!==n.type)return r.type.compare(n.type);let i=r.type.major,s=pd[i].compareTokens(r,n);return 0===s&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),s},quickEncodeToken:function(e){switch(e.type){case oh.false:return gh([244]);case oh.true:return gh([245]);case oh.null:return gh([246]);case oh.bytes:return e.value.length?void 0:gh([64]);case oh.string:return""===e.value?gh([96]):void 0;case oh.array:return 0===e.value?gh([128]):void 0;case oh.map:return 0===e.value?gh([160]):void 0;case oh.uint:return e.value<24?gh([Number(e.value)]):void 0;case oh.negint:if(e.value>=-24)return gh([31-Number(e.value)])}}},pd=function(){let e=[];return e[oh.uint.major]=Ph,e[oh.negint.major]=Mh,e[oh.bytes.major]=Vh,e[oh.string.major]=qh,e[oh.array.major]=jh,e[oh.map.major]=Qh,e[oh.tag.major]=Zh,e[oh.float.major]=ed,e}(),gd=new Rh,md=class e{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do{if(t.obj===e)return!0}while(t=t.parent);return!1}static createCheck(t,r){if(t&&t.includes(r))throw new Error(`${_h} object contains circular references`);return new e(r,t)}},yd={null:new ah(oh.null,null),undefined:new ah(oh.undefined,void 0),true:new ah(oh.true,!0),false:new ah(oh.false,!1),emptyArray:new ah(oh.array,0),emptyMap:new ah(oh.map,0)},wd={number:(e,t,r,n)=>Number.isInteger(e)&&Number.isSafeInteger(e)?new ah(e>=0?oh.uint:oh.negint,e):new ah(oh.float,e),bigint:(e,t,r,n)=>e>=BigInt(0)?new ah(oh.uint,e):new ah(oh.negint,e),Uint8Array:(e,t,r,n)=>new ah(oh.bytes,e),string:(e,t,r,n)=>new ah(oh.string,e),boolean:(e,t,r,n)=>e?yd.true:yd.false,null:(e,t,r,n)=>yd.null,undefined:(e,t,r,n)=>yd.undefined,ArrayBuffer:(e,t,r,n)=>new ah(oh.bytes,new Uint8Array(e)),DataView:(e,t,r,n)=>new ah(oh.bytes,new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),Array(e,t,r,n){if(!e.length)return!0===r.addBreakTokens?[yd.emptyArray,new ah(oh.break)]:yd.emptyArray;n=md.createCheck(n,e);let i=[],s=0;for(let t of e)i[s++]=bd(t,r,n);return r.addBreakTokens?[new ah(oh.array,e.length),i,new ah(oh.break)]:[new ah(oh.array,e.length),i]},Object(e,t,r,n){let i="Object"!==t,s=i?e.keys():Object.keys(e),o=i?e.size:s.length;if(!o)return!0===r.addBreakTokens?[yd.emptyMap,new ah(oh.break)]:yd.emptyMap;n=md.createCheck(n,e);let a=[],l=0;for(let t of s)a[l++]=[bd(t,r,n),bd(i?e.get(t):e[t],r,n)];return function(e,t){t.mapSorter&&e.sort(t.mapSorter)}(a,r),r.addBreakTokens?[new ah(oh.map,o),a,new ah(oh.break)]:[new ah(oh.map,o),a]}};wd.Map=wd.Object,wd.Buffer=wd.Uint8Array;for(let e of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))wd[`${e}Array`]=wd.DataView;function bd(e,t={},r){let n=function(e){if(null===e)return"null";if(void 0===e)return"undefined";if(!0===e||!1===e)return"boolean";let t=typeof e;if(ih.includes(t))return t;if("function"===t)return"Function";if(Array.isArray(e))return"Array";if(function(e){return e&&e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer.call(null,e)}(e))return"Buffer";let r=function(e){let t=Object.prototype.toString.call(e).slice(8,-1);if(sh.includes(t))return t}(e);return r||"Object"}(e),i=t&&t.typeEncoders&&t.typeEncoders[n]||wd[n];if("function"==typeof i){let s=i(e,n,t,r);if(null!=s)return s}let s=wd[n];if(!s)throw new Error(`${_h} unsupported type: ${n}`);return s(e,n,t,r)}function Ed(e,t,r,n){if(Array.isArray(t))for(let i of t)Ed(e,i,r,n);else r[t.type.major](e,t,n)}function vd(e,t,r){let n=bd(e,r);if(!Array.isArray(n)&&r.quickEncodeToken){let e=r.quickEncodeToken(n);if(e)return e;let i=t[n.type.major];if(i.encodedSize){let e=i.encodedSize(n,r),t=new Rh(e);if(i(t,n,r),1!==t.chunks.length)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return dh(t.chunks[0])}}return gd.reset(),Ed(gd,n,t,r),gd.toBytes(!0)}function Sd(e,t){return t=Object.assign({},fd,t),vd(e,pd,t)}var Rd={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},Ad=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=dd[e];if(void 0===t){let r=hd[e];if(!r)throw new Error(`${Ah} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let n=31&e;t=r(this.data,this._pos,n,this.options)}return this._pos+=t.encodedLength,t}},_d=Symbol.for("DONE"),Id=Symbol.for("BREAK");function kd(e,t){if(e.done())return _d;let r=e.next();if(r.type===oh.break)return Id;if(r.type.terminal)return r.value;if(r.type===oh.array)return function(e,t,r){let n=[];for(let i=0;i<e.value;i++){let s=kd(t,r);if(s===Id){if(e.value===1/0)break;throw new Error(`${Ah} got unexpected break to lengthed array`)}if(s===_d)throw new Error(`${Ah} found array but not enough entries (got ${i}, expected ${e.value})`);n[i]=s}return n}(r,e,t);if(r.type===oh.map)return function(e,t,r){let n=!0===r.useMaps,i=n?void 0:{},s=n?new Map:void 0;for(let o=0;o<e.value;o++){let a=kd(t,r);if(a===Id){if(e.value===1/0)break;throw new Error(`${Ah} got unexpected break to lengthed map`)}if(a===_d)throw new Error(`${Ah} found map but not enough entries (got ${o} [no key], expected ${e.value})`);if(!0!==n&&"string"!=typeof a)throw new Error(`${Ah} non-string keys not supported (got ${typeof a})`);if(!0===r.rejectDuplicateMapKeys&&(n&&s.has(a)||!n&&a in i))throw new Error(`${Ah} found repeat map key "${a}"`);let l=kd(t,r);if(l===_d)throw new Error(`${Ah} found map but not enough entries (got ${o} [no value], expected ${e.value})`);n?s.set(a,l):i[a]=l}return n?s:i}(r,e,t);if(r.type===oh.tag){if(t.tags&&"function"==typeof t.tags[r.value]){let n=kd(e,t);return t.tags[r.value](n)}throw new Error(`${Ah} tag not supported (${r.value})`)}throw new Error("unsupported")}function Td(e,t){let[r,n]=function(e,t){if(!(e instanceof Uint8Array))throw new Error(`${Ah} data to decode must be a Uint8Array`);let r=(t=Object.assign({},Rd,t)).tokenizer||new Ad(e,t),n=kd(r,t);if(n===_d)throw new Error(`${Ah} did not find any content to decode`);if(n===Id)throw new Error(`${Ah} got unexpected break`);return[n,e.subarray(r.pos())]}(e,t);if(n.length>0)throw new Error(`${Ah} too many terminals, data makes no sense`);return r}var Cd="/",Dd=(new TextEncoder).encode(Cd),xd=Dd[0],Nd=class e{_buf;constructor(e,t){if("string"==typeof e)this._buf=en(e);else{if(!(e instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==xd)throw new Error("Invalid key")}toString(e="utf8"){return Bn(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new e(t.join(Cd))}static random(){return new e(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||"string"==typeof t?new e(t):"function"==typeof t.uint8Array?new e(t.uint8Array()):null}clean(){if((null==this._buf||0===this._buf.byteLength)&&(this._buf=Dd),this._buf[0]!==xd){let e=new Uint8Array(this._buf.byteLength+1);e.fill(xd,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===xd;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),r=e.list();for(let e=0;e<t.length;e++){if(r.length<e+1)return!1;let n=t[e],i=r[e];if(n<i)return!0;if(n>i)return!1}return t.length<r.length}reverse(){return e.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Cd).slice(1)}type(){return function(e){let t=e.split(":");return t.length<2?"":t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){let t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(t){return new e(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(Cd)||(t+=Cd),t+=this.type(),new e(t)}parent(){let t=this.list();return 1===t.length?new e(Cd):new e(t.slice(0,-1).join(Cd))}child(t){return this.toString()===Cd?t:t.toString()===Cd?this:new e(this.toString()+t.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(...t){return e.withNamespaces([...this.namespaces(),...Pd(t.map((e=>e.namespaces())))])}};function Pd(e){return[].concat(...e)}var Ld="/pin/",Od="/pinned-block/",Bd=Qt;function Md(e){return 0===e.version&&(e=e.toV1()),new Nd(`${Ld}${e.toString(Bd)}`)}var Ud=class{datastore;blockstore;dagWalkers;constructor(e,t,r){this.datastore=e,this.blockstore=t,this.dagWalkers=r}async*add(e,t={}){let r=Md(e);if(await this.datastore.has(r))throw new Error("Already pinned");let n=Math.round(t.depth??1/0);if(n<0)throw new Error("Depth must be greater than or equal to 0");let i=new ae({concurrency:1});for await(let r of this.#e(e,i,{...t,depth:n}))await this.#t(r,(t=>null==t.pinnedBy.find((t=>ke(t,e.bytes)))&&(t.pinCount++,t.pinnedBy.push(e.bytes),!0)),t),yield r;let s={depth:n,metadata:t.metadata??{}};await this.datastore.put(r,Sd(s),t)}async*#e(e,t,r){if(-1===r.depth)return;let n=this.dagWalkers[e.code];if(null==n)throw new Error(`No dag walker found for cid codec ${e.code}`);let i=await this.blockstore.get(e,r);yield e;for await(let e of n.walk(i))yield*await t.add((async()=>this.#e(e,t,{...r,depth:r.depth-1})))}async#t(e,t,r){let n=new Nd(`${Od}${Bd.encode(e.multihash.bytes)}`),i={pinCount:0,pinnedBy:[]};try{i=Td(await this.datastore.get(n,r))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(t(i)){if(0===i.pinCount&&await this.datastore.has(n))return void await this.datastore.delete(n);await this.datastore.put(n,Sd(i),r),r.onProgress?.(new Xe("helia:pin:add",e))}}async*rm(e,t={}){let r=Md(e),n=Td(await this.datastore.get(r,t));await this.datastore.delete(r,t);let i=new ae({concurrency:1});for await(let r of this.#e(e,i,{...t,depth:n.depth}))await this.#t(r,(t=>(t.pinCount--,t.pinnedBy=t.pinnedBy.filter((t=>ke(t,e.bytes))),!0)),{...t,depth:n.depth}),yield r}async*ls(e={}){for await(let{key:t,value:r}of this.datastore.query({prefix:Ld+(null!=e.cid?`${e.cid.toString(Qt)}`:"")},e)){let e=qr.parse(t.toString().substring(5),Qt),n=Td(r);yield{cid:e,...n}}}async isPinned(e,t={}){let r=new Nd(`${Od}${Bd.encode(e.multihash.bytes)}`);return this.datastore.has(r,t)}},Fd=class{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??5}async start(){await z(...this.routers)}async stop(){await W(...this.routers)}async*findProviders(e,t={}){if(0===this.routers.length)throw new U("No content routers available","ERR_NO_ROUTERS_AVAILABLE");let r=new le({concurrency:this.providerLookupConcurrency});r.addEventListener("error",(()=>{}));for await(let n of ze(r.toGenerator(),...$d(this.routers,"findProviders").map((r=>r.findProviders(e,t)))))if(null!=n){if(0===n.multiaddrs.length){if(null!=r.find(n.id))continue;r.add((async()=>{try{let e=await this.findPeer(n.id,t);return 0===e.multiaddrs.length?null:e}catch(e){return this.log.error("could not load multiaddrs for peer %p",n.id,e),null}}),{peerId:n.id,signal:t.signal}).catch((e=>{this.log.error("could not load multiaddrs for peer %p",n.id,e)}))}yield n}}async provide(e,t={}){if(0===this.routers.length)throw new U("No content routers available","ERR_NO_ROUTERS_AVAILABLE");await Promise.all($d(this.routers,"provide").map((async r=>{await r.provide(e,t)})))}async put(e,t,r){await Promise.all($d(this.routers,"put").map((async n=>{await n.put(e,t,r)})))}async get(e,t){return Promise.any($d(this.routers,"get").map((async r=>r.get(e,t))))}async findPeer(e,t){if(0===this.routers.length)throw new U("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");let r=this,n=ze(...$d(this.routers,"findPeer").map((n=>async function*(){try{yield await n.findPeer(e,t)}catch(e){r.log.error(e)}}())));for await(let e of n)if(null!=e)return e;throw new U("Could not find peer in routing","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new U("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");for await(let r of ze(...$d(this.routers,"getClosestPeers").map((r=>r.getClosestPeers(e,t)))))null!=r&&(yield r)}};function $d(e,t){return e.filter((e=>null!=e[t]))}var Vd={},Kd=e=>{e.addEventListener("message",(t=>{Kd.dispatchEvent("message",e,t)})),null!=e.port&&e.port.addEventListener("message",(t=>{Kd.dispatchEvent("message",e,t)}))};Kd.addEventListener=(e,t)=>{null==Vd[e]&&(Vd[e]=[]),Vd[e].push(t)},Kd.removeEventListener=(e,t)=>{null!=Vd[e]&&(Vd[e]=Vd[e].filter((e=>e===t)))},Kd.dispatchEvent=function(e,t,r){null!=Vd[e]&&Vd[e].forEach((e=>e(t,r)))};var Hd,qd=Kd,zd="lock:worker:request-read",Wd="lock:worker:release-read",jd="lock:master:grant-read",Gd="lock:worker:request-write",Yd="lock:worker:release-write",Qd="lock:master:grant-write",Jd=(e,t,r,n,i)=>(s,o)=>{if(o.data.type!==r)return;let a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};e.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>{s.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise((e=>{let t=r=>{if(null==r||null==r.data)return;let i=r.data.type,o=(r.data.name,r.data.identifier);i===n&&o===a.identifier&&(s.removeEventListener("message",t),e())};s.addEventListener("message",t)}))}}}))},Zd=(e,t,r,n)=>async()=>{let i=Math.random().toString().substring(2);return globalThis.postMessage({type:t,identifier:i,name:e}),new Promise((t=>{let s=o=>{if(null==o||null==o.data)return;let a=o.data.type,l=o.data.identifier;a===r&&l===i&&(globalThis.removeEventListener("message",s),t((()=>{globalThis.postMessage({type:n,identifier:i,name:e})})))};globalThis.addEventListener("message",s)}))},Xd={singleProcess:!1},ef={};async function tf(e,t){let r,n=new Promise((e=>{r=e}));return e.add((async()=>Wu((async()=>{await new Promise((e=>{r((()=>{e()}))}))})(),{milliseconds:t.timeout}))),n}var rf={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function nf(e){let t=Object.assign({},rf,e);return null==Hd&&(Hd=(e=>{if(e=Object.assign({},Xd,e),globalThis.document||e.singleProcess){let e=new EventTarget;return qd.addEventListener("message",Jd(e,"requestReadLock",zd,Wd,jd)),qd.addEventListener("message",Jd(e,"requestWriteLock",Gd,Yd,Qd)),e}return{isWorker:!0,readLock:e=>Zd(e,zd,jd,Wd),writeLock:e=>Zd(e,Gd,Qd,Yd)}})(t),!0!==Hd.isWorker&&(Hd.addEventListener("requestReadLock",(e=>{null!=ef[e.data.name]&&ef[e.data.name].readLock().then((async t=>e.data.handler().finally((()=>{t()}))))})),Hd.addEventListener("requestWriteLock",(async e=>{null!=ef[e.data.name]&&ef[e.data.name].writeLock().then((async t=>e.data.handler().finally((()=>{t()}))))})))),null==ef[t.name]&&(ef[t.name]=((e,t)=>{if(!0===Hd.isWorker)return{readLock:Hd.readLock(e,t),writeLock:Hd.writeLock(e,t)};let r,n=new Gu({concurrency:1});return{async readLock(){if(null!=r)return tf(r,t);r=new Gu({concurrency:t.concurrency,autoStart:!1});let e=r,i=tf(r,t);return n.add((async()=>{e.start(),await e.onIdle().then((()=>{r===e&&(r=null)}))})),i},writeLock:async()=>(r=null,tf(n,t))}})(t.name,t)),ef[t.name]}var sf=class{lock;child;pins;started;constructor(e,t,r={}){this.child=e,this.pins=t,this.lock=nf({singleProcess:r.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await z(this.child),this.started=!0}async stop(){await W(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,r={}){r?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.put(e,t,r)}finally{n()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();let r=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{r()}}async get(e,t={}){t?.signal?.throwIfAborted();let r=await this.lock.readLock();try{return await this.child.get(e,t)}finally{r()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();let r=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{r()}}async delete(e,t={}){t?.signal?.throwIfAborted();let r=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{r()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();let r=await this.lock.writeLock();try{let r=this;yield*this.child.deleteMany(async function*(){for await(let t of e){if(await r.pins.isPinned(t))throw new Error("CID was pinned");yield t}}(),t)}finally{r()}}async has(e,t={}){t?.signal?.throwIfAborted();let r=await this.lock.readLock();try{return await this.child.has(e,t)}finally{r()}}async*getAll(e={}){e?.signal?.throwIfAborted();let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}},of={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};of.tags[42]=function(e){if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return qr.decode(e.subarray(1))},of.tags.slice(),oh.uint.major,oh.negint.major,oh.bytes.major,oh.string.major,oh.array.major,oh.map.major,oh.tag.major,oh.float.major;var af=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;32===e||9===e||13===e||10===e;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${Ah} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${Ah} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,r=!1,n=e=>{for(;!this.done();){let t=this.ch();if(!e.includes(t))break;this._pos++}};if(45===this.ch()&&(t=!0,this._pos++),48===this.ch()){if(this._pos++,46!==this.ch())return new ah(oh.uint,0,this._pos-e);this._pos++,r=!0}if(n([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${Ah} unexpected token at position ${this._pos}`);if(!this.done()&&46===this.ch()){if(r)throw new Error(`${Ah} unexpected token at position ${this._pos}`);r=!0,this._pos++,n([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(101===this.ch()||69===this.ch())&&(r=!0,this._pos++,!this.done()&&(43===this.ch()||45===this.ch())&&this._pos++,n([48,49,50,51,52,53,54,55,56,57]));let i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),s=parseFloat(i);return r?new ah(oh.float,s,this._pos-e):!0!==this.options.allowBigInt||Number.isSafeInteger(s)?new ah(s>=0?oh.uint:oh.negint,s,this._pos-e):new ah(s>=0?oh.uint:oh.negint,BigInt(i),this._pos-e)}parseString(){if(34!==this.ch())throw new Error(`${Ah} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let e=this._pos,t=0;e<this.data.length&&t<65536;e++,t++){let r=this.data[e];if(92===r||r<32||r>=128)break;if(34===r){let r=String.fromCharCode.apply(null,this.data.subarray(this._pos,e));return this._pos=e+1,new ah(oh.string,r,t)}}let e=this._pos,t=[],r=()=>{if(this._pos+4>=this.data.length)throw new Error(`${Ah} unexpected end of unicode escape sequence at position ${this._pos}`);let e=0;for(let t=0;t<4;t++){let t=this.ch();if(t>=48&&t<=57)t-=48;else if(t>=97&&t<=102)t=t-97+10;else{if(!(t>=65&&t<=70))throw new Error(`${Ah} unexpected unicode escape character at position ${this._pos}`);t=t-65+10}e=16*e+t,this._pos++}return e},n=()=>{let e,r,n,i,s=this.ch(),o=null,a=s>239?4:s>223?3:s>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${Ah} unexpected unicode sequence at position ${this._pos}`);switch(a){case 1:s<128&&(o=s);break;case 2:e=this.data[this._pos+1],128==(192&e)&&(i=(31&s)<<6|63&e,i>127&&(o=i));break;case 3:e=this.data[this._pos+1],r=this.data[this._pos+2],128==(192&e)&&128==(192&r)&&(i=(15&s)<<12|(63&e)<<6|63&r,i>2047&&(i<55296||i>57343)&&(o=i));break;case 4:e=this.data[this._pos+1],r=this.data[this._pos+2],n=this.data[this._pos+3],128==(192&e)&&128==(192&r)&&128==(192&n)&&(i=(15&s)<<18|(63&e)<<12|(63&r)<<6|63&n,i>65535&&i<1114112&&(o=i))}null===o?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|1023&o),t.push(o),this._pos+=a};for(;!this.done();){let i,s=this.ch();switch(s){case 92:if(this._pos++,this.done())throw new Error(`${Ah} unexpected string termination at position ${this._pos}`);switch(i=this.ch(),this._pos++,i){case 34:case 39:case 92:case 47:t.push(i);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(r());break;default:throw new Error(`${Ah} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new ah(oh.string,Sh(t),this._pos-e);default:if(s<32)throw new Error(`${Ah} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):n()}}throw new Error(`${Ah} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new ah(oh.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new ah(oh.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new ah(oh.null,null,4);case 102:return this.expect([102,97,108,115,101]),new ah(oh.false,!1,5);case 116:return this.expect([116,114,117,101]),new ah(oh.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${Ah} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":if(this.modeStack.pop(),93===this.ch())return this._pos++,this.skipWhitespace(),new ah(oh.break,void 0,1);if(44!==this.ch())throw new Error(`${Ah} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue();case"array-start":return this.modeStack.pop(),93===this.ch()?(this._pos++,this.skipWhitespace(),new ah(oh.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(125===this.ch())return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new ah(oh.break,void 0,1);if(44!==this.ch())throw new Error(`${Ah} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),125===this.ch())return this._pos++,this.skipWhitespace(),new ah(oh.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),58!==this.ch())throw new Error(`${Ah} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${Ah} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};qr.parse,new TextDecoder,new TextEncoder;var lf=new TextDecoder;function cf(e,t){let r=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(t>=e.length)throw new Error("protobuf: unexpected end of data");let i=e[t++];if(r+=n<28?(127&i)<<n:(127&i)*2**n,i<128)break}return[r,t]}function uf(e,t){let r;[r,t]=cf(e,t);let n=t+r;if(r<0||n<0)throw new Error("protobuf: invalid length");if(n>e.length)throw new Error("protobuf: unexpected end of data");return[e.subarray(t,n),n]}function hf(e,t){let r;return[r,t]=cf(e,t),[7&r,r>>3,t]}function df(e){let t={},r=e.length,n=0;for(;n<r;){let r,i;if([r,i,n]=hf(e,n),1===i){if(t.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(2!==r)throw new Error(`protobuf: (PBLink) wrong wireType (${r}) for Hash`);if(void 0!==t.Name)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[t.Hash,n]=uf(e,n)}else if(2===i){if(void 0!==t.Name)throw new Error("protobuf: (PBLink) duplicate Name section");if(2!==r)throw new Error(`protobuf: (PBLink) wrong wireType (${r}) for Name`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let i;[i,n]=uf(e,n),t.Name=lf.decode(i)}else{if(3!==i)throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(0!==r)throw new Error(`protobuf: (PBLink) wrong wireType (${r}) for Tsize`);[t.Tsize,n]=cf(e,n)}}if(n>r)throw new Error("protobuf: (PBLink) unexpected end of data");return t}new TextEncoder,new TextEncoder;var ff={codec:112,*walk(e){yield*function(e){let t=function(e){return e instanceof ArrayBuffer?new Uint8Array(e,0,e.byteLength):e}(e),r=function(e){let t,r,n=e.length,i=0,s=!1;for(;i<n;){let n,o;if([n,o,i]=hf(e,i),2!==n)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${n}`);if(1===o){if(r)throw new Error("protobuf: (PBNode) duplicate Data section");[r,i]=uf(e,i),t&&(s=!0)}else{if(2!==o)throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${o}`);{if(s)throw new Error("protobuf: (PBNode) duplicate Links section");let r;t||(t=[]),[r,i]=uf(e,i),t.push(df(r))}}}if(i>n)throw new Error("protobuf: (PBNode) unexpected end of data");let o={};return r&&(o.Data=r),o.Links=t||[],o}(t),n={};return r.Data&&(n.Data=r.Data),r.Links&&(n.Links=r.Links.map((e=>{let t={};try{t.Hash=qr.decode(e.Hash)}catch{}if(!t.Hash)throw new Error("Invalid Hash field found in link, expected CID");return void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),n}(e).Links.map((e=>e.Hash))}},pf={codec:85,*walk(){}},gf={codec:113,*walk(e){let t=[],r=[];r[42]=e=>{if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");let r=qr.decode(e.subarray(1));return t.push(r),r},Td(e,{tags:r}),yield*t}},mf=class extends af{tokenBuffer;constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===oh.map){let e=this._next();if(e.type===oh.string&&"/"===e.value){let e=this._next();if(e.type===oh.string){if(this._next().type!==oh.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(e),new ah(oh.tag,42,0)}if(e.type===oh.map){let e=this._next();if(e.type===oh.string&&"bytes"===e.value){let e=this._next();if(e.type===oh.string){for(let e=0;e<2;e++)if(this._next().type!==oh.break)throw new Error("Invalid encoded Bytes form");let t=rr.decode(`m${e.value}`);return new ah(oh.bytes,t,e.value.length)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}return e}},yf={codec:297,*walk(e){let t=[],r=[];r[42]=e=>{let r=qr.parse(e);return t.push(r),r},function(e,t){Td(e,t=Object.assign({tokenizer:new af(e,t)},t))}(e,{tags:r,tokenizer:new mf(e,{tags:r,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*t}},wf={codec:512,*walk(){}},bf=new Nd("/version"),Ef=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:r,block:n}of e)await this.put(r,n,t),yield r}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(let r of e)yield{cid:r,block:await this.get(r,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let r of e)await this.delete(r,t),yield r}async*getAll(e){throw new Error(".getAll is not implemented")}},vf={};a(vf,{abortedError:()=>Df,closeFailedError:()=>Af,deleteFailedError:()=>kf,getFailedError:()=>If,hasFailedError:()=>Tf,notFoundError:()=>Cf,openFailedError:()=>Rf,putFailedError:()=>_f});var Sf=c(g(),1);function Rf(e){return e=e??new Error("Open failed"),(0,Sf.default)(e,"ERR_OPEN_FAILED")}function Af(e){return e=e??new Error("Close failed"),(0,Sf.default)(e,"ERR_CLOSE_FAILED")}function _f(e){return e=e??new Error("Put failed"),(0,Sf.default)(e,"ERR_PUT_FAILED")}function If(e){return e=e??new Error("Get failed"),(0,Sf.default)(e,"ERR_GET_FAILED")}function kf(e){return e=e??new Error("Delete failed"),(0,Sf.default)(e,"ERR_DELETE_FAILED")}function Tf(e){return e=e??new Error("Has failed"),(0,Sf.default)(e,"ERR_HAS_FAILED")}function Cf(e){return e=e??new Error("Not Found"),(0,Sf.default)(e,"ERR_NOT_FOUND")}function Df(e){return e=e??new Error("Aborted"),(0,Sf.default)(e,"ERR_ABORTED")}var xf=class extends Ef{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set($t.encode(e.multihash.bytes),t),e}get(e){let t=this.data.get($t.encode(e.multihash.bytes));if(null==t)throw Cf();return t}has(e){return this.data.has($t.encode(e.multihash.bytes))}async delete(e){this.data.delete($t.encode(e.multihash.bytes))}async*getAll(){for(let[e,t]of this.data.entries())yield{cid:qr.createV1(85,xr($t.decode(e))),block:t}}},Nf=function(e,t){let r=0;if(function(e){return null!=e[Symbol.asyncIterator]}(e))return async function*(){for await(let n of e)await t(n,r++)&&(yield n)}();let n=Ke(e),{value:i,done:s}=n.next();if(!0===s)return function*(){}();let o=t(i,r++);if("function"==typeof o.then)return async function*(){await o&&(yield i);for await(let e of n)await t(e,r++)&&(yield e)}();let a=t;return function*(){!0===o&&(yield i);for(let e of n)a(e,r++)&&(yield e)}()},Pf=($u("blockstore:core:tiered"),{...vf}),Lf=class extends Ef{child;constructor(e){super(),this.child=e}put(e,t){return 0===e.multihash.code||null==this.child?e:this.child.put(e,t)}get(e){if(0===e.multihash.code)return e.multihash.digest;if(null==this.child)throw Pf.notFoundError();return this.child.get(e)}has(e){return 0===e.multihash.code||null!=this.child&&this.child.has(e)}delete(e){if(0!==e.code&&null!=this.child)return this.child.delete(e)}getAll(e){return null!=this.child?this.child.getAll(e):[]}};function Of(e){return null!=e?.then}var Bf=function(e,t){let r=0;if(function(e){return null!=e[Symbol.asyncIterator]}(e))return async function*(){for await(let n of e){let e=t(n,r++);Of(e)&&await e,yield n}}();let n=Ke(e),{value:i,done:s}=n.next();if(!0===s)return function*(){}();if("function"==typeof t(i,r++)?.then)return async function*(){yield i;for await(let e of n){let n=t(e,r++);Of(n)&&await n,yield e}}();let o=t;return function*(){yield i;for(let e of n)o(e,r++),yield e}()},Mf=class{child;hashers;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new Lf(e.blockstore),this.hashers=e.hashers??{}}async put(e,t,r={}){return await this.child.has(e,r)?(r.onProgress?.(new Xe("blocks:put:duplicate",e)),e):(r.onProgress?.(new Xe("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async n=>n.announce?.(e,t,r)))),r.onProgress?.(new Xe("blocks:put:blockstore:put",e)),this.child.put(e,t,r))}async*putMany(e,t={}){let r=Nf(e,(async({cid:e})=>{let r=await this.child.has(e,t);return r&&t.onProgress?.(new Xe("blocks:put-many:duplicate",e)),!r})),n=Bf(r,(async({cid:e,block:r})=>{t.onProgress?.(new Xe("blocks:put-many:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async n=>n.announce?.(e,r,t))))}));t.onProgress?.(new Xe("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(n,t)}async get(e,t={}){if(!0!==t.offline&&!await this.child.has(e,t)){t.onProgress?.(new Xe("blocks:get:providers:get",e));let r=await Kf(e,this.components.blockBrokers,this.hashers[e.multihash.code],{...t,log:this.log});return t.onProgress?.(new Xe("blocks:get:blockstore:put",e)),await this.child.put(e,r,t),t.onProgress?.(new Xe("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async n=>n.announce?.(e,r,t)))),r}return t.onProgress?.(new Xe("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new Xe("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Bf(e,(async e=>{if(!0!==t.offline&&!await this.child.has(e,t)){t.onProgress?.(new Xe("blocks:get-many:providers:get",e));let r=await Kf(e,this.components.blockBrokers,this.hashers[e.multihash.code],{...t,log:this.log});t.onProgress?.(new Xe("blocks:get-many:blockstore:put",e)),await this.child.put(e,r,t),t.onProgress?.(new Xe("blocks:get-many:providers:notify",e)),await Promise.all(this.components.blockBrokers.map((async n=>n.announce?.(e,r,t))))}})))}async delete(e,t={}){t.onProgress?.(new Xe("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new Xe("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let t of e)yield t}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new Xe("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},Uf=class extends Mf{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await z(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await W(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){let r=this.components.blockBrokers.map((e=>null==e.createSession?e:e.createSession(t)));return new Ff({blockstore:this.child,blockBrokers:r,hashers:this.hashers,logger:this.logger},{root:e})}},Ff=class extends Mf{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,r={}){let n=Y([this.closeController.signal,r.signal]);try{return await super.put(e,t,{...r,signal:n})}finally{n.clear()}}async*putMany(e,t={}){let r=Y([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:r})}finally{r.clear()}}async get(e,t={}){let r=Y([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:r})}finally{r.clear()}}async*getMany(e,t={}){let r=Y([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:r})}finally{r.clear()}}async delete(e,t={}){let r=Y([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:r})}finally{r.clear()}}async*deleteMany(e,t={}){let r=Y([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:r})}finally{r.clear()}}async has(e,t={}){let r=Y([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:r})}finally{r.clear()}}async*getAll(e={}){let t=Y([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}};function $f(e){return"function"==typeof e.retrieve}var Vf=(e,t)=>{if(null==t)throw new U(`No hasher configured for multihash code 0x${e.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async r=>{if(!ke((await t.digest(r)).digest,e.multihash.digest))throw new U("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function Kf(e,t,r,n){let i=Vf(e,r),s=new AbortController,o=Y([s.signal,n.signal]);s.signal;let a=[];for(let e of t)$f(e)&&a.push(e);try{return await Promise.any(a.map((async t=>{try{let r=!1,s=await t.retrieve(e,{...n,signal:o,validateFn:async e=>{await i(e),r=!0}});return r||await i(s),s}catch(t){throw n.log.error("could not retrieve verified block for %c",e,t),t}})))}finally{s.abort(),o.clear()}}var Hf=1,qf=5,zf=c(d(),1),Wf=Math.LN2*Math.LN2,jf=class e{static create(t,r=.005){let n=function(e,t=.005){let r=Math.round(-1*e*Math.log(t)/Wf);return{bits:r,hashes:Math.round(r/e*Math.LN2)}}(t,r);return new e(n)}seeds;bits;buffer;constructor(e={}){null!=e.seeds?this.seeds=e.seeds:this.seeds=function(e){let t,r,n=[];for(let i=0;i<e;i++)for(t=new xe(Mo(4)),n[i]=t.getUint32(0,!0),r=0;r<i;r++)if(n[i]===n[r]){i--;break}return n}(e.hashes??8),this.bits=e.bits??1024,this.buffer=ue(Math.ceil(this.bits/8))}add(e){"string"==typeof e&&(e=en(e));for(let t=0;t<this.seeds.length;t++){let r=zf.default.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(r)}}has(e){"string"==typeof e&&(e=en(e));for(let t=0;t<this.seeds.length;t++){let r=zf.default.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(r))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;let n=this.buffer[t];n|=1<<r,this.buffer[t]=n}getbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;return!!(this.buffer[t]&1<<r)}},Gf=class extends K{intialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=jf.create(this.maxProviders)}async retrieve(e,t={}){let r=rr.encode(e.multihash.bytes),n=this.requests.get(r);if(null!=n)return this.log("join existing request for %c",e),n;let i=Q();if(this.requests.set(r,i.promise),0===this.providers.length){let r=!1;null==this.intialPeerSearchComplete&&(r=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.intialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.intialPeerSearchComplete,r&&this.log("found initial session peers for %c",e)}let s=!1,o=new ae({concurrency:this.maxProviders});o.addEventListener("error",(()=>{})),o.addEventListener("failure",(e=>{this.log.error("error querying provider %o, evicting from session",e.detail.job.options.provider,e.detail.error),this.evict(e.detail.job.options.provider)})),o.addEventListener("success",(e=>{s=!0,i.resolve(e.detail.result)})),o.addEventListener("idle",(()=>{s||!0===t.signal?.aborted||Promise.resolve().then((async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let e=0;e<this.minProviders&&0!==this.providers.length;e++){let e=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(e)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(r),i.resolve(await this.retrieve(e,t))})).catch((t=>{this.log.error("could not find new providers for %c",e,t),i.reject(t)}))}));let a=r=>{o.add((async()=>this.queryProvider(e,r.detail,t)),{provider:r.detail}).catch((r=>{!0!==t.signal?.aborted&&this.log.error("error retrieving session block for %c",e,r)}))};this.addEventListener("provider",a),Promise.all([...this.providers].map((async r=>o.add((async()=>this.queryProvider(e,r,t)),{provider:r})))).catch((r=>{!0!==t.signal?.aborted&&this.log.error("error retrieving session block for %c",e,r)}));try{return await i.promise}finally{this.removeEventListener("provider",a),o.clear(),this.requests.delete(r)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));let t=this.providers.findIndex((t=>this.equals(t,e)));-1!==t&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!(null==this.providers.find((t=>this.equals(t,e)))&&!this.isEvicted(e))}async findProviders(e,t,r){let n=Q(),i=0;return Promise.resolve().then((async()=>{this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e);for await(let s of this.findNewProviders(e,r)){if(i===this.maxProviders||!0===r.signal?.aborted)break;if(!this.hasProvider(s)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(s),this.safeDispatchEvent("provider",{detail:s}),i++,i===t&&(this.log("session is ready"),n.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new U(`Found ${i} of ${t} ${this.name} providers for ${e}`,"ERR_INSUFFICIENT_PROVIDERS_FOUND")})).catch((t=>{this.log.error("error searching routing for potential session peers for %c",e,t.errors??t),n.reject(t)})),n.promise}},Yf=class{blockstore;datastore;pins;logger;routing;dagWalkers;hashers;dns;metrics;log;constructor(e){this.logger=e.logger??Fu(),this.log=this.logger.forComponent("helia"),this.hashers=function(e=[]){let t={};return[Fr,$r,Or,...e].forEach((e=>{t[e.code]=e})),t}(e.hashers),this.dagWalkers=function(e=[]){let t={};return[ff,pf,gf,yf,wf,...e].forEach((e=>{t[e.codec]=e})),t}(e.dagWalkers),this.dns=e.dns??nh(),this.metrics=e.metrics;let t={blockstore:e.blockstore,datastore:e.datastore,hashers:this.hashers,dagWalkers:this.dagWalkers,logger:this.logger,blockBrokers:[],dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new Fd(t,{routers:(e.routers??[]).flatMap((e=>{let t=[e];return null!=e[C]&&t.push(e[C]),null!=e[O]&&t.push(e[O]),t})),providerLookupConcurrency:e.providerLookupConcurrency});let r=new Uf(t);this.pins=new Ud(e.datastore,r,this.dagWalkers),this.blockstore=new sf(r,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map((e=>e(t)))}async start(){await async function(e){if(!await e.has(bf))return void await e.put(bf,en("1"));let t=Bn(await e.get(bf));if(1!==parseInt(t,10))throw new Error("Unknown datastore version, a datastore migration may be required")}(this.datastore),await z(this.blockstore,this.datastore,this.routing)}async stop(){await W(this.blockstore,this.datastore,this.routing)}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let t=this,r=this.blockstore.unwrap();this.log("gc start"),await ce(r.deleteMany(async function*(){for await(let{cid:n}of r.getAll())try{if(await t.pins.isPinned(n,e))continue;yield n,e.onProgress?.(new Xe("helia:gc:deleted",n))}catch(r){t.log.error("Error during gc",r),e.onProgress?.(new Xe("helia:gc:error",r))}}()))}finally{t()}this.log("gc finished")}},Qf=class extends Gf{wantList;network;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network}async queryProvider(e,t,r){this.log("sending WANT-BLOCK for %c to %p",e,t);let n=await this.wantList.wantSessionBlock(e,t,r);if(this.log("%p %s %c",t,n.has?"has":"does not have",e),n.has&&null!=n.block)return n.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(let r of this.network.findProviders(e,t))yield r.id}toEvictionKey(e){return e.toBytes()}equals(e,t){return e.equals(t)}},Jf=class{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){let r={global:e};null!=t&&(r[t.toString()]=e),this.blocksReceived?.increment(r)}updateDuplicateBlocksReceived(e=1,t){let r={global:e};null!=t&&(r[t.toString()]=e),this.duplicateBlocksReceived?.increment(r)}updateDataReceived(e,t){let r={global:e};null!=t&&(r[t.toString()]=e),this.dataReceived?.increment(r)}updateDuplicateDataReceived(e,t){let r={global:e};null!=t&&(r[t.toString()]=e),this.duplicateDataReceived?.increment(r)}},Zf=class extends Map{metric;constructor(e){super();let{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Xf(e){let t,{name:r,metrics:n}=e;return t=null!=n?new Zf({name:r,metrics:n}):new Map,t}var ep=function(e){if(!(e instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let t=[];for(;e.length>0;){let r=_e(e);t.push(r),e=e.slice(ve(r))}return t},tp=class extends K{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Tu({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=Xf({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",(e=>{this.receiveMessage(e.detail.peer,e.detail.message).catch((t=>{this.log.error("error receiving bitswap message from %p",e.detail.peer,t)}))})),this.network.addEventListener("peer:connected",(e=>{this.peerConnected(e.detail).catch((t=>{this.log.error("error processing newly connected bitswap peer %p",e.detail,t)}))})),this.network.addEventListener("peer:disconnected",(e=>{this.peerDisconnected(e.detail)}))}async addEntry(e,t){let r=Bn(e.multihash.bytes,"base64"),n=this.wants.get(r);null==n&&(n={cid:e,priority:t.priority??1,wantType:t.wantType??En.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(r,n)),n.wantType===En.WantHave&&t.wantType===En.WantBlock&&(n.wantType=En.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===En.WantBlock?(await re(this,"block",t?.signal,{filter:t=>ke(e.multihash.digest,t.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await re(this,"presence",t?.signal,{filter:t=>ke(e.multihash.digest,t.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{!0===t.signal?.aborted&&(this.log("want for %c was aborted, cancelling want",e),n.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await(this.sendingMessages?.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout((()=>{this.sendMessages().catch((e=>{this.log("error sending messages to peers",e)}))}),this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Q(),await Promise.all([...this.peers.entries()].map((async([e,t])=>{let r=new Set,n=new Cu;for(let[e,i]of this.wants.entries())t.has(e)||i.cancel||(r.add(e),n.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:i.priority,wantType:i.wantType,cancel:i.cancel,sendDontHave:i.sendDontHave}));if(0!==n.wantlist.size)try{await this.network.sendMessage(e,n);for(let e of r)t.add(e)}catch(e){this.log.error("error sending full wantlist to new peer",e)}}))).catch((e=>{this.log.error("error sending messages",e)}));for(let[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(let t of this.peers.values())t.delete(e)}this.sendingMessages.resolve()}has(e){let t=Bn(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,r={}){let n=new Cu;return n.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:En.WantHave,priority:1}),await this.network.sendMessage(t,n),(await re(this,"presence",r.signal,{filter:r=>t.equals(r.detail.sender)&&ke(e.multihash.digest,r.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:En.WantBlock})}async wantSessionBlock(e,t,r={}){let n=new Cu;return n.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:En.WantBlock,priority:1}),await this.network.sendMessage(t,n),(await re(this,"presence",r.signal,{filter:r=>t.equals(r.detail.sender)&&ke(e.multihash.digest,r.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){let r=Bn(e.multihash.bytes,"base64"),n=this.wants.get(r);null!=n&&(n.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let r=!1;for(let n of t.blocks){if(null==n.prefix||null==n.data)continue;let t=ep(n.prefix),i=t[0],s=t[1],o=t[2],a=o===Fr.code?Fr:await(this.hashLoader?.getHasher(o));if(null==a){this.log.error("unknown hash algorithm",o);continue}let l=a.digest(n.data);null!=l.then&&(l=await l);let c=qr.create(0===i?0:1,s,l);this.log("received block from %p for %c",e,c),this.safeDispatchEvent("block",{detail:{sender:e,cid:c,block:n.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:c,has:!0,block:n.data}});let u=Bn(c.multihash.bytes,"base64"),h=this.wants.get(u);null!=h&&(h.cancel=!0,r=!0)}for(let{cid:r,type:n}of t.blockPresences){let t=qr.decode(r);this.log("received %s from %p for %c",n,e,t),this.safeDispatchEvent("presence",{detail:{sender:e,cid:t,has:n===_n.HaveBlock}})}r&&await this.sendMessagesDebounced()}async peerConnected(e){let t=new Set,r=new Cu(!0);for(let[e,n]of this.wants.entries())n.cancel||(t.add(e),r.addWantlistEntry(n.cid,{cid:n.cid.bytes,priority:1,wantType:En.WantBlock,cancel:!1,sendDontHave:!1}));if(0!==r.wantlist.size)try{await this.network.sendMessage(e,r),this.peers.set(e,t)}catch(t){this.log.error("error sending full wantlist to new peer %p",e,t)}else this.peers.set(e,t)}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}},rp=class{log;logger;stats;network;blockstore;peerWantLists;wantList;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new Jf(e),this.network=new On(e,t),this.peerWantLists=new Nu({...e,network:this.network},t),this.wantList=new tp({...e,network:this.network},t)}createSession(e={}){return function(e,t){return new Qf(e,t)}({wantList:this.wantList,network:this.network,logger:this.logger},e)}async want(e,t={}){let r=new AbortController,n=Y([r.signal,t.signal]);r.signal,this.network.findAndConnect(e,{...t,signal:n}).catch((t=>{r.signal.aborted||this.log.error("error during finding and connect for cid %c",e,t)}));try{return(await this.wantList.wantBlock(e,{...t,signal:n})).block}finally{r.abort(),n.clear()}}async notify(e,t,r={}){await Promise.all([this.peerWantLists.receivedBlock(e,r),this.wantList.receivedBlock(e,r)])}getWantlist(){return[...this.wantList.wants.values()].filter((e=>!e.cancel)).map((e=>({cid:e.cid,priority:e.priority,wantType:e.wantType})))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}},np=class{bitswap;started;constructor(e,t={}){let{hashers:r}=e;this.bitswap=((e,t={})=>new rp(e,t))(e,{hashLoader:{getHasher:async e=>{let t;if(t="string"==typeof e?Object.values(r).find((t=>t.name===e)):r[e],null!=t)return t;throw new Error(`Could not load hasher for code/name "${e}"`)}},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,r){await this.bitswap.notify(e,t,r)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){let t=this.bitswap.createSession(e);return{announce:async(e,t,r)=>{await this.bitswap.notify(e,t,r)},retrieve:async(e,r)=>t.retrieve(e,r)}}};function ip(e={}){return t=>new np(t,e)}var sp=45,op=15,ap=new class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,r=e();return void 0===r&&(this.index=t),r}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically((()=>{let t=this.readChar();if(t===e)return t}))}readSeparator(e,t,r){return this.readAtomically((()=>{if(!(t>0&&void 0===this.readGivenChar(e)))return r()}))}readNumber(e,t,r,n){return this.readAtomically((()=>{let i=0,s=0,o=this.peekChar();if(void 0===o)return;let a="0"===o,l=2**(8*n)-1;for(;;){let r=this.readAtomically((()=>{let t=this.readChar();if(void 0===t)return;let r=Number.parseInt(t,e);return Number.isNaN(r)?void 0:r}));if(void 0===r)break;if(i*=e,i+=r,i>l||(s+=1,void 0!==t&&s>t))return}return 0!==s?!r&&a&&s>1?void 0:i:void 0}))}readIPv4Addr(){return this.readAtomically((()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let r=this.readSeparator(".",t,(()=>this.readNumber(10,3,!1,1)));if(void 0===r)return;e[t]=r}return e}))}readIPv6Addr(){let e=e=>{for(let t=0;t<e.length/2;t++){let r=2*t;if(t<e.length-3){let n=this.readSeparator(":",t,(()=>this.readIPv4Addr()));if(void 0!==n)return e[r]=n[0],e[r+1]=n[1],e[r+2]=n[2],e[r+3]=n[3],[r+4,!0]}let n=this.readSeparator(":",t,(()=>this.readNumber(16,4,!0,2)));if(void 0===n)return[r,!1];e[r]=n>>8,e[r+1]=255&n}return[e.length,!1]};return this.readAtomically((()=>{let t=new Uint8Array(16),[r,n]=e(t);if(16===r)return t;if(n||void 0===this.readGivenChar(":")||void 0===this.readGivenChar(":"))return;let i=new Uint8Array(14),s=16-(r+2),[o]=e(i.subarray(0,s));return t.set(i.subarray(0,o),16-o),t}))}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};function lp(e){return!!function(e){if(!(e.length>op))return ap.new(e).parseWith((()=>ap.readIPv4Addr()))}(e)}function cp(e){return!!function(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>sp))return ap.new(e).parseWith((()=>ap.readIPv6Addr()))}(e)}function up(e){return!!function(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>sp))return ap.new(e).parseWith((()=>ap.readIPAddr()))}(e)}var hp=c(m(),1),dp=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map((e=>new hp.Netmask(e)));function fp(e){for(let t of dp)if(t.contains(e))return!0;return!1}function pp(e){return lp(e)?fp(e):function(e){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(e)}(e)?function(e){let t=e.split(":");if(t.length<2)return!1;let r=t[t.length-1].padStart(4,"0"),n=t[t.length-2].padStart(4,"0");return fp(`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}`)}(e):function(e){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)}(e)?function(e){let t=e.split(":");return fp(t[t.length-1])}(e):cp(e)?function(e){return/^::$/.test(e)||/^::1$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}(e):void 0}parseInt("0xFFFF",16),new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);var gp=lp,mp=cp,yp=function(e){let t=0;if(e=e.toString().trim(),gp(e)){let r=new Uint8Array(t+4);return e.split(/\./g).forEach((e=>{r[t++]=255&parseInt(e,10)})),r}if(mp(e)){let r,n=e.split(":",8);for(r=0;r<n.length;r++){let e;gp(n[r])&&(e=yp(n[r]),n[r]=Bn(e.slice(0,2),"base16")),null!=e&&++r<8&&n.splice(r,0,Bn(e.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(r=0;r<n.length&&""!==n[r];r++);let e=[r,1];for(r=9-n.length;r>0;r--)e.push("0");n.splice.apply(n,e)}let i=new Uint8Array(t+16);for(r=0;r<n.length;r++){let e=parseInt(n[r],16);i[t++]=e>>8&255,i[t++]=255&e}return i}throw new Error("invalid ip address")},wp=function(e,t=0,r){t=~~t,r=r??e.length-t;let n=new DataView(e.buffer);if(4===r){let n=[];for(let i=0;i<r;i++)n.push(e[t+i]);return n.join(".")}if(16===r){let e=[];for(let i=0;i<r;i+=2)e.push(n.getUint16(t+i).toString(16));return e.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},bp={},Ep={};function vp(e){if("number"==typeof e){if(null!=Ep[e])return Ep[e];throw new Error(`no protocol with code: ${e}`)}if("string"==typeof e){if(null!=bp[e])return bp[e];throw new Error(`no protocol with name: ${e}`)}throw new Error("invalid protocol id type: "+typeof e)}function Sp(e,t){switch(vp(e).code){case 4:case 41:return function(e){let t=wp(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!up(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Cp(t);case 6:case 273:case 33:case 132:return kp(t).toString();case 421:return function(e){let t=_e(e),r=e.slice(ve(t));if(r.length!==t)throw new Error("inconsistent lengths");return Bn(r,"base58btc")}(t);case 444:case 445:return function(e){let t=e.slice(0,e.length-2),r=e.slice(e.length-2);return`${Bn(t,"base32")}:${kp(r)}`}(t);case 466:return function(e){let t=_e(e),r=e.slice(ve(t));if(r.length!==t)throw new Error("inconsistent lengths");return"u"+Bn(r,"base64url")}(t);case 481:return globalThis.encodeURIComponent(Cp(t));default:return Bn(t,"base16")}}function Rp(e,t){switch(vp(e).code){case 4:case 41:return function(e){if(!up(e))throw new Error("invalid ip address");return yp(e)}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Tp(t);case 6:case 273:case 33:case 132:return Ip(parseInt(t,10));case 421:return function(e){let t;t="Q"===e[0]||"1"===e[0]?xr(Xt.decode(`z${e}`)).bytes:qr.parse(e).multihash.bytes;let r=Uint8Array.from(Ae(t.length));return Ie([r,t],r.length+t.length)}(t);case 444:return function(e){let t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);let r=$t.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=Ip(n);return Ie([r,i],r.length+i.length)}(t);case 445:return function(e){let t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);let r=$t.decode(`b${t[0]}`),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=Ip(n);return Ie([r,i],r.length+i.length)}(t);case 466:return function(e){let t=_p.decode(e),r=Uint8Array.from(Ae(t.length));return Ie([r,t],r.length+t.length)}(t);case 481:return Tp(globalThis.decodeURIComponent(t));default:return en(t,"base16")}}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,-1,"http-path"],[777,-1,"memory"]].forEach((e=>{let t=function(e,t,r,n,i){return{code:e,size:t,name:r,resolvable:!!n,path:!!i}}(...e);Ep[t.code]=t,bp[t.name]=t})),vp("ip4"),vp("ip6"),vp("ipcidr");var Ap=Object.values(Yr).map((e=>e.decoder)),_p=function(){let e=Ap[0].or(Ap[1]);return Ap.slice(2).forEach((t=>e=e.or(t))),e}();function Ip(e){let t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function kp(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function Tp(e){let t=en(e),r=Uint8Array.from(Ae(t.length));return Ie([r,t],r.length+t.length)}function Cp(e){let t=_e(e);if((e=e.slice(ve(t))).length!==t)throw new Error("inconsistent lengths");return Bn(e)}function Dp(e){let t=[],r=[],n=null,i=0;for(;i<e.length;){let s=_e(e,i),o=ve(s),a=vp(s),l=Pp(a,e.slice(i+o));if(0===l){t.push([s]),r.push([s]),i+=o;continue}let c=e.slice(i+o,i+o+l);if(i+=l+o,i>e.length)throw Op("Invalid address Uint8Array: "+Bn(e,"base16"));t.push([s,c]);let u=Sp(s,c);if(r.push([s,u]),!0===a.path){n=u;break}}return{bytes:Uint8Array.from(e),string:xp(r),tuples:t,stringTuples:r,path:n}}function xp(e){let t=[];return e.map((e=>{let r=vp(e[0]);return t.push(r.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),Lp(t.join("/"))}function Np(e){return Ie(e.map((e=>{let t=vp(e[0]),r=Uint8Array.from(Ae(t.code));return e.length>1&&null!=e[1]&&(r=Ie([r,e[1]])),r})))}function Pp(e,t){if(e.size>0)return e.size/8;if(0===e.size)return 0;{let e=_e(t instanceof Uint8Array?t:Uint8Array.from(t));return e+ve(e)}}function Lp(e){return"/"+e.trim().split("/").filter((e=>e)).join("/")}function Op(e){return new Error("Error parsing address: "+e)}var Bp=Symbol.for("nodejs.util.inspect.custom"),Mp=Symbol.for("@multiformats/js-multiaddr/multiaddr"),Up=[vp("dns").code,vp("dns4").code,vp("dns6").code,vp("dnsaddr").code],Fp=class extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}},$p=class e{bytes;#e;#t;#r;#n;[Mp]=!0;constructor(e){let t;if(null==e&&(e=""),e instanceof Uint8Array)t=Dp(e);else if("string"==typeof e){if(e.length>0&&"/"!==e.charAt(0))throw new Error(`multiaddr "${e}" must start with a "/"`);t=function(e){let t=[],r=[],n=null,i=(e=Lp(e)).split("/").slice(1);if(1===i.length&&""===i[0])return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let s=0;s<i.length;s++){let o=vp(i[s]);if(0===o.size){t.push([o.code]),r.push([o.code]);continue}if(s++,s>=i.length)throw Op("invalid address: "+e);if(!0===o.path){n=Lp(i.slice(s).join("/")),t.push([o.code,Rp(o.code,n)]),r.push([o.code,n]);break}let a=Rp(o.code,i[s]);t.push([o.code,a]),r.push([o.code,Sp(o.code,a)])}return{string:xp(r),bytes:Np(t),tuples:t,stringTuples:r,path:n}}(e)}else{if(!Kp(e))throw new Error("addr must be a string, Buffer, or another Multiaddr");t=Dp(e.bytes)}this.bytes=t.bytes,this.#e=t.string,this.#t=t.tuples,this.#r=t.stringTuples,this.#n=t.path}toString(){return this.#e}toJSON(){return this.toString()}toOptions(){let e,t,r,n,i="",s=vp("tcp"),o=vp("udp"),a=vp("ip4"),l=vp("ip6"),c=vp("dns6"),u=vp("ip6zone");for(let[h,d]of this.stringTuples())h===u.code&&(i=`%${d??""}`),Up.includes(h)&&(t=s.name,n=443,r=`${d??""}${i}`,e=h===c.code?6:4),(h===s.code||h===o.code)&&(t=vp(h).name,n=parseInt(d??"")),(h===a.code||h===l.code)&&(t=vp(h).name,r=`${d??""}${i}`,e=h===l.code?6:4);if(null==e||null==t||null==r||null==n)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:r,transport:t,port:n}}protos(){return this.#t.map((([e])=>Object.assign({},vp(e))))}protoCodes(){return this.#t.map((([e])=>e))}protoNames(){return this.#t.map((([e])=>vp(e).name))}tuples(){return this.#t}stringTuples(){return this.#r}encapsulate(t){return t=new e(t),new e(this.toString()+t.toString())}decapsulate(t){let r=t.toString(),n=this.toString(),i=n.lastIndexOf(r);if(i<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new e(n.slice(0,i))}decapsulateCode(t){let r=this.tuples();for(let n=r.length-1;n>=0;n--)if(r[n][0]===t)return new e(Np(r.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach((([t,r])=>{t===bp.p2p.code&&e.push([t,r]),t===bp["p2p-circuit"].code&&(e=[])}));let t=e.pop();if(null!=t?.[1]){let e=t[1];return"Q"===e[0]||"1"===e[0]?Bn(Xt.decode(`z${e}`),"base58btc"):Bn(qr.parse(e).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#n}equals(e){return ke(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find((e=>e.resolvable));if(null==t)return[this];let r=Vp.get(t.name);if(null==r)throw new Fp(`no available resolver for ${t.name}`);return(await r(this,e)).map((e=>Hp(e)))}nodeAddress(){let e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){let t=(e??this).protos();return!(2!==t.length||4!==t[0].code&&41!==t[0].code||6!==t[1].code&&273!==t[1].code)}[Bp](){return`Multiaddr(${this.#e})`}},Vp=new Map;function Kp(e){return!!e?.[Mp]}function Hp(e){return new $p(e)}var qp=e=>({match:t=>!(t.length<1)&&!!e(t[0])&&t.slice(1),pattern:"fn"}),zp=e=>({match:t=>qp((t=>t===e)).match(t),pattern:e}),Wp=()=>({match:e=>qp((e=>"string"==typeof e)).match(e),pattern:"{string}"}),jp=()=>({match:e=>qp((e=>!isNaN(parseInt(e)))).match(e),pattern:"{number}"}),Gp=()=>({match:e=>{if(e.length<2||"p2p"!==e[0]&&"ipfs"!==e[0])return!1;if(!e[1].startsWith("Q")&&!e[1].startsWith("1"))return!1;try{Xt.decode(`z${e[1]}`)}catch{return!1}return e.slice(2)},pattern:"/p2p/{peerid}"}),Yp=()=>({match:e=>{if(e.length<2||"certhash"!==e[0])return!1;try{ir.decode(e[1])}catch{return!1}return e.slice(2)},pattern:"/certhash/{certhash}"}),Qp=e=>({match:t=>{let r=e.match(t);return!1===r?t:r},pattern:`optional(${e.pattern})`}),Jp=(...e)=>({match:t=>{let r;for(let n of e){let e=n.match(t);!1!==e&&(null==r||e.length<r.length)&&(r=e)}return r??!1},pattern:`or(${e.map((e=>e.pattern)).join(", ")})`}),Zp=(...e)=>({match:t=>{for(let r of e){let e=r.match(t);if(!1===e)return!1;t=e}return t},pattern:`and(${e.map((e=>e.pattern)).join(", ")})`});function Xp(...e){function t(t){let r=(e=>e.toString().split("/").slice(1))(t);for(let t of e){let e=t.match(r);if(!1===e)return!1;r=e}return r}return{matches:function(e){return!1!==t(e)},exactMatch:function(e){let r=t(e);return!1!==r&&0===r.length}}}var eg=Zp(zp("dns4"),Wp()),tg=Zp(zp("dns6"),Wp()),rg=Zp(zp("dnsaddr"),Wp()),ng=Zp(zp("dns"),Wp()),ig=(Xp(eg),Xp(tg),Xp(rg),Xp(Jp(ng,rg,eg,tg))),sg=Zp(zp("ip4"),qp(lp)),og=Zp(zp("ip6"),qp(cp)),ag=Jp(sg,og),lg=Jp(ag,ng,eg,tg,rg),cg=Xp(lg),ug=(Xp(sg),Xp(og),Xp(ag)),hg=Zp(lg,zp("tcp"),jp()),dg=Zp(lg,zp("udp"),jp()),fg=(Xp(hg),Xp(dg),Zp(dg,zp("quic"))),pg=Zp(dg,zp("quic-v1")),gg=Jp(fg,pg),mg=(Xp(fg),Xp(pg),Jp(lg,hg,dg,fg,pg)),yg=Jp(Zp(mg,zp("ws"),Qp(Gp()))),wg=(Xp(yg),Jp(Zp(mg,zp("wss"),Qp(Gp())),Zp(mg,zp("tls"),zp("ws"),Qp(Gp())))),bg=(Xp(wg),Zp(dg,zp("webrtc-direct"),Qp(Yp()),Qp(Yp()),Qp(Gp()))),Eg=Xp(bg),vg=Zp(pg,zp("webtransport"),Qp(Yp()),Qp(Yp()),Qp(Gp())),Sg=Xp(vg),Rg=Jp(yg,wg,Zp(hg,Qp(Gp())),Zp(gg,Qp(Gp())),Zp(lg,Qp(Gp())),bg,vg,Gp()),Ag=(Xp(Rg),Xp(Zp(Rg,zp("p2p-circuit"),Gp()))),_g=Xp(Jp(Zp(Rg,zp("p2p-circuit"),zp("webrtc"),Qp(Gp())),Zp(Rg,zp("webrtc"),Qp(Gp())),zp("webrtc"))),Ig=Xp(Jp(Zp(lg,zp("tcp"),jp(),zp("http"),Qp(Gp())),Zp(lg,zp("http"),Qp(Gp())))),kg=Xp(Jp(Zp(lg,zp("tcp"),Jp(Zp(zp("443"),zp("http")),Zp(jp(),zp("https"))),Qp(Gp())),Zp(lg,zp("tls"),zp("http"),Qp(Gp())),Zp(lg,zp("https"),Qp(Gp())))),Tg=[vp("tcp").code,vp("dns").code,vp("dnsaddr").code,vp("dns4").code,vp("dns6").code];function Cg(e){let t;try{t=vp("sni").code}catch{return null}for(let[r,n]of e)if(r===t&&void 0!==n)return n;return null}function Dg(e){return e.some((([e,t])=>e===vp("tls").code))}function xg(e,t,r){let n=Ng[vp(e).name];if(void 0===n)throw new Error(`Can't interpret protocol ${vp(e).name}`);let i=n(t,r);return e===vp("ip6").code?`[${i}]`:i}var Ng={ip4:(e,t)=>e,ip6:(e,t)=>0===t.length?e:`[${e}]`,tcp:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`tcp://${xg(r[0],r[1]??"",t)}:${e}`},udp:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`udp://${xg(r[0],r[1]??"",t)}:${e}`},dnsaddr:(e,t)=>e,dns4:(e,t)=>e,dns6:(e,t)=>e,dns:(e,t)=>e,ipfs:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`${xg(r[0],r[1]??"",t)}/ipfs/${e}`},p2p:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`${xg(r[0],r[1]??"",t)}/p2p/${e}`},http:(e,t)=>{let r=Dg(t),n=Cg(t);if(r&&null!==n)return`https://${n}`;let i=r?"https://":"http://",s=t.pop();if(void 0===s)throw new Error("Unexpected end of multiaddr");let o=xg(s[0],s[1]??"",t);return o=o.replace("tcp://",""),`${i}${o}`},"http-path":(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`${xg(r[0],r[1]??"",t)}/${decodeURIComponent(e)}`},tls:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return xg(r[0],r[1]??"",t)},sni:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return xg(r[0],r[1]??"",t)},https:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");let n=xg(r[0],r[1]??"",t);return n=n.replace("tcp://",""),`https://${n}`},ws:(e,t)=>{let r=Dg(t),n=Cg(t);if(r&&null!==n)return`wss://${n}`;let i=r?"wss://":"ws://",s=t.pop();if(void 0===s)throw new Error("Unexpected end of multiaddr");let o=xg(s[0],s[1]??"",t);return o=o.replace("tcp://",""),`${i}${o}`},wss:(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");let n=xg(r[0],r[1]??"",t);return n=n.replace("tcp://",""),`wss://${n}`},"p2p-websocket-star":(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`${xg(r[0],r[1]??"",t)}/p2p-websocket-star`},"p2p-webrtc-star":(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`${xg(r[0],r[1]??"",t)}/p2p-webrtc-star`},"p2p-webrtc-direct":(e,t)=>{let r=t.pop();if(void 0===r)throw new Error("Unexpected end of multiaddr");return`${xg(r[0],r[1]??"",t)}/p2p-webrtc-direct`}};function Pg(e,t){let r=Hp(e).stringTuples(),n=r.pop();if(void 0===n)throw new Error("Unexpected end of multiaddr");let i=vp(n[0]),s=Ng[i.name];if(null==s)throw new Error(`No interpreter found for ${i.name}`);let o=s(n[1]??"",r);return!1!==t?.assumeHttp&&Tg.includes(n[0])&&(o=o.replace(/^.*:\/\//,""),o="443"===n[1]?`https://${o}`:`http://${o}`),(o.startsWith("http://")||o.startsWith("https://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}var Lg=class{url;#e=0;#t=0;#r=0;#n=0;#i=new Map;log;constructor(e,t){this.url=e instanceof URL?e:new URL(e),this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#s(e){let t=e.multihash.bytes;return rr.encode(t)}async getRawBlock(e,t){let r=new URL(this.url.toString());if(r.pathname=`/ipfs/${e.toString()}`,r.search="?format=raw",!0===t?.aborted)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);let n=this.#s(e),i=new AbortController,s=()=>{i.abort()};t?.addEventListener("abort",s);try{let t=this.#i.get(n);return null==t&&(this.#e++,t=fetch(r.toString(),{signal:i.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"}).then((async t=>{if(this.log("GET %s %d",r,t.status),!t.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#n++,new Uint8Array(await t.arrayBuffer())})),this.#i.set(n,t)),await t}catch{throw!0===t?.aborted?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",s),this.#i.delete(n)}}reliability(){return 0===this.#e?1:this.#r>0?-1/0:this.#n/(this.#e+3*this.#t)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#n,pendingResponses:this.#i.size}}};function Og(e,t,r){return e.filter((e=>{if(kg.matches(e)||t&&Ig.matches(e))return!(!r&&!ig.matches(e))||!1===pp(e.toOptions().host);if(!t&&r){let{host:t}=e.toOptions();if("127.0.0.1"===t||"localhost"===t||t.endsWith(".localhost"))return!0}return!1}))}async function*Bg(e,t,r,n,i,s){for await(let o of t.findProviders(e,s)){let e=Og(o.multiaddrs,n,i);if(0===e.length)continue;let t=Pg(e[0]);yield new Lg(t,r)}}var Mg=class extends Gf{routing;allowInsecure;allowLocal;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??Fg,this.allowLocal=t.allowLocal??$g}async queryProvider(e,t,r){this.log("fetching BLOCK for %c from %s",e,t.url);let n=await t.getRawBlock(e,r.signal);return this.log.trace("got block for %c from %s",e,t.url),await(r.validateFn?.(n)),n}async*findNewProviders(e,t={}){yield*Bg(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,t)}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}},Ug=class{allowInsecure;allowLocal;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??Fg,this.allowLocal=t.allowLocal??$g}async retrieve(e,t={}){let r=[];for await(let n of Bg(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,t)){this.log("getting block for %c from %s",e,n.url);try{let r=await n.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,n.url);try{await(t.validateFn?.(r))}catch(t){this.log.error("failed to validate block for %c from %s",e,n.url,t);continue}return r}catch(i){if(this.log.error("failed to get block for %c from %s",e,n.url,i),i instanceof Error?r.push(i):r.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${n.url}`)),!0===t.signal?.aborted){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,n.url);break}}}throw r.length>0?new AggregateError(r,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return function(e,t){return new Mg(e,t)}({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure})}},Fg=!1,$g=!1;function Vg(e={}){return t=>new Ug(t,e)}async function*Kg(e,t={}){let r=e.getReader();try{for(;;){let e=await r.read();if(e.done)return;yield e.value}}finally{!0!==t.preventCancel&&await r.cancel(),r.releaseLock()}}c(g(),1),c(y(),1);var Hg,qg="ERR_UNRECOGNIZED_VALIDITY",zg="ERR_SIGNATURE_VERIFICATION",Wg="ERR_UNDEFINED_PARAMETER",jg="ERR_RECORD_TOO_LARGE";!function(e){let t,r,n;var i;(t=e.ValidityType||(e.ValidityType={})).EOL="EOL",(i=r||(r={}))[i.EOL=0]="EOL",function(e){e.codec=()=>wn(r)}(t=e.ValidityType||(e.ValidityType={})),e.codec=()=>(null==n&&(n=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.value&&(r.uint32(10),r.bytes(t.value)),null!=t.signatureV1&&(r.uint32(18),r.bytes(t.signatureV1)),null!=t.validityType&&(r.uint32(24),e.ValidityType.codec().encode(t.validityType,r)),null!=t.validity&&(r.uint32(34),r.bytes(t.validity)),null!=t.sequence&&(r.uint32(40),r.uint64(t.sequence)),null!=t.ttl&&(r.uint32(48),r.uint64(t.ttl)),null!=t.pubKey&&(r.uint32(58),r.bytes(t.pubKey)),null!=t.signatureV2&&(r.uint32(66),r.bytes(t.signatureV2)),null!=t.data&&(r.uint32(74),r.bytes(t.data)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.value=t.bytes();break;case 2:n.signatureV1=t.bytes();break;case 3:n.validityType=e.ValidityType.codec().decode(t);break;case 4:n.validity=t.bytes();break;case 5:n.sequence=t.uint64();break;case 6:n.ttl=t.uint64();break;case 7:n.pubKey=t.bytes();break;case 8:n.signatureV2=t.bytes();break;case 9:n.data=t.bytes();break;default:t.skipType(7&r)}}return n}))),n),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(Hg||(Hg={}));var Gg=c(g(),1),Yg=$u("ipns:utils"),Qg=en("/ipns/"),Jg=async(e,t)=>{if(null==t||null==e){let e=new Error("one or more of the provided parameters are not defined");throw Yg.error(e),(0,Gg.default)(e,Wg)}let r;if(null!=t.pubKey){try{r=Xc(t.pubKey)}catch(e){throw Yg.error(e),e}if(!(await Qn(t.pubKey)).equals(e))throw(0,Gg.default)(new Error("Embedded public key did not match PeerID"),"ERR_INVALID_EMBEDDED_KEY")}else null!=e.publicKey&&(r=Xc(e.publicKey));if(null!=r)return r;throw(0,Gg.default)(new Error("no public key is available"),Wg)},Zg=e=>"signatureV1"in e?Hg.encode({value:en(e.value),signatureV1:e.signatureV1,validityType:e.validityType,validity:en(e.validity),sequence:e.sequence,ttl:e.ttl,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data}):Hg.encode({pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data});function Xg(e){let t=Hg.decode(e);if(null!=t.sequence&&(t.sequence=BigInt(t.sequence)),null!=t.ttl&&(t.ttl=BigInt(t.ttl)),null==t.signatureV2||null==t.data)throw(0,Gg.default)(new Error("missing data or signatureV2"),zg);let r=tm(t.data),n=rm(r.Value),i=Bn(r.Validity);if(null!=t.value&&null!=t.signatureV1)return nm(t),{value:n,validityType:Hg.ValidityType.EOL,validity:i,sequence:r.Sequence,ttl:r.TTL,pubKey:t.pubKey,signatureV1:t.signatureV1,signatureV2:t.signatureV2,data:t.data};if(null!=t.signatureV2)return{value:n,validityType:Hg.ValidityType.EOL,validity:i,sequence:r.Sequence,ttl:r.TTL,pubKey:t.pubKey,signatureV2:t.signatureV2,data:t.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}var em=e=>Yn(e.slice(Qg.length)),tm=e=>{let t=Td(e);if(0!==t.ValidityType)throw(0,Gg.default)(new Error("Unknown validity type"),qg);return t.ValidityType=Hg.ValidityType.EOL,Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t},rm=e=>{if(null!=e){if(N(e))return`/ipns/${e.toCID().toString(Qt)}`;if(e instanceof Uint8Array){let t=Bn(e);t.startsWith("/")&&(e=t)}let t=e.toString().trim();if(t.startsWith("/")&&t.length>1)return t;let r=qr.asCID(e);if(null!=r)return 114===r.code?`/ipns/${r.toString(Qt)}`:`/ipfs/${r.toV1().toString()}`;try{return e instanceof Uint8Array?`/ipfs/${qr.decode(e).toV1().toString()}`:`/ipfs/${qr.parse(t).toV1().toString()}`}catch{}}throw(0,Gg.default)(new Error("Value must be a valid content path starting with /"),"ERR_INVALID_VALUE")},nm=e=>{if(null==e.data)throw(0,Gg.default)(new Error("Record data is missing"),"ERR_INVALID_RECORD_DATA");let t=tm(e.data);if(!ke(t.Value,e.value??new Uint8Array(0)))throw(0,Gg.default)(new Error('Field "value" did not match between protobuf and CBOR'),zg);if(!ke(t.Validity,e.validity??new Uint8Array(0)))throw(0,Gg.default)(new Error('Field "validity" did not match between protobuf and CBOR'),zg);if(t.ValidityType!==e.validityType)throw(0,Gg.default)(new Error('Field "validityType" did not match between protobuf and CBOR'),zg);if(t.Sequence!==e.sequence)throw(0,Gg.default)(new Error('Field "sequence" did not match between protobuf and CBOR'),zg);if(t.TTL!==e.ttl)throw(0,Gg.default)(new Error('Field "ttl" did not match between protobuf and CBOR'),zg)},im=($u("ipns"),Or.code,c(g(),1)),sm=c(y(),1),om=$u("ipns:validator"),am=10240,lm=async(e,t)=>{let r,n=Xg(t);try{let t=(e=>Ie([en("ipns-signature:"),e]))(n.data);r=await e.verify(t,n.signatureV2)}catch{r=!1}if(!r)throw om.error("record signature verification failed"),(0,im.default)(new Error("record signature verification failed"),zg);if(n.validityType===Hg.ValidityType.EOL){if(sm.default.fromString(n.validity).toDate().getTime()<Date.now())throw om.error("record has expired"),(0,im.default)(new Error("record has expired"),"ERR_IPNS_EXPIRED_RECORD")}else if(null!=n.validityType)throw om.error("unrecognized validity type"),(0,im.default)(new Error("unrecognized validity type"),qg);om("ipns record for %s is valid",n.value)};async function cm(e,t){if(t.byteLength>am)throw(0,im.default)(new Error("record too large"),jg);let r=em(e),n=Xg(t),i=await Jg(r,n);await lm(i,t)}async function*um(e){let t=/\r?\n/,r=new TextDecoder("utf8"),n="";for await(let i of e){"string"==typeof i&&(i=(new TextEncoder).encode(i)),n+=r.decode(i,{stream:!0});let e=n.split(t);n=e.pop()??"";for(let t=0;t<e.length;t++)yield JSON.parse(e[t])}n+=r.decode(),""!==n&&(yield JSON.parse(n))}var hm=function(e){if(function(e){return null!=e[Symbol.asyncIterator]}(e))return(async()=>{for await(let t of e)return t})();for(let t of e)return t},dm=en("/ipns/");function fm(e){return ke(e.subarray(0,dm.byteLength),dm)}var pm=e=>Yn(e.slice(dm.length)),gm=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*He(this.client.getProviders(e,t),(e=>({id:e.ID,multiaddrs:e.Addrs??[]})))}async provide(){}async put(e,t,r){if(!fm(e))return;let n=pm(e),i=Xg(t);await this.client.putIPNS(n,i,r)}async get(e,t){if(!fm(e))throw new U("Not found","ERR_NOT_FOUND");let r=pm(e);try{let e=await this.client.getIPNS(r,t);return Zg(e)}catch(e){throw"ERR_BAD_RESPONSE"===e.code?new U("Not found","ERR_NOT_FOUND"):e}}},mm=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let r=await hm(this.client.getPeers(e,t));if(null!=r)return{id:r.ID,multiaddrs:r.Addrs??[]};throw new U("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){}},ym=$u("delegated-routing-v1-http-api-client"),wm=class{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new Gu({concurrency:t.concurrentRequests??4}),this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??3e4,this.contentRouting=new gm(this),this.peerRouting=new mm(this)}get[C](){return this.contentRouting}get[O](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(e,t={}){ym("getProviders starts: %c",e);let r=AbortSignal.timeout(this.timeout),n=Y([this.shutDownController.signal,r,t.signal]),i=Q(),s=Q();this.httpQueue.add((async()=>(i.resolve(),s.promise)));try{await i.promise;let t=`${this.clientUrl}routing/v1/providers/${e.toString()}`,r=await fetch(t,{headers:{Accept:"application/x-ndjson"},signal:n});if(404===r.status)throw new U("No matching records found.","ERR_NOT_FOUND");if(422===r.status)throw new U("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==r.body)throw new U("Routing response had no body","ERR_BAD_RESPONSE");if("application/json"===r.headers.get("Content-Type")){let e=await r.json();for(let t of e.Providers){let e=this.#e(t);null!=e&&(yield e)}}else for await(let e of um(Kg(r.body))){let t=this.#e(e);null!=t&&(yield t)}}catch(e){ym.error("getProviders errored:",e)}finally{n.clear(),s.resolve(),ym("getProviders finished: %c",e)}}async*getPeers(e,t={}){ym("getPeers starts: %c",e);let r=AbortSignal.timeout(this.timeout),n=Y([this.shutDownController.signal,r,t.signal]),i=Q(),s=Q();this.httpQueue.add((async()=>(i.resolve(),s.promise)));try{await i.promise;let t=`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`,r=await fetch(t,{headers:{Accept:"application/x-ndjson"},signal:n});if(404===r.status)throw new U("No matching records found.","ERR_NOT_FOUND");if(422===r.status)throw new U("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==r.body)throw new U("Routing response had no body","ERR_BAD_RESPONSE");if("application/json"===r.headers.get("Content-Type")){let e=await r.json();for(let t of e.Peers){let e=this.#e(t);null!=e&&(yield e)}}else for await(let e of um(Kg(r.body))){let t=this.#e(e);null!=t&&(yield t)}}catch(e){ym.error("getPeers errored:",e)}finally{n.clear(),s.resolve(),ym("getPeers finished: %c",e)}}async getIPNS(e,t={}){ym("getIPNS starts: %c",e);let r=AbortSignal.timeout(this.timeout),n=Y([this.shutDownController.signal,r,t.signal]),i=Q(),s=Q();this.httpQueue.add((async()=>(i.resolve(),s.promise)));let o=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await i.promise;let r=await fetch(o,{headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:n});if(ym("getIPNS GET %s %d",o,r.status),404===r.status)throw new U("No matching records found.","ERR_NOT_FOUND");if(422===r.status)throw new U("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==r.body)throw new U("GET ipns response had no body","ERR_BAD_RESPONSE");let s=await r.arrayBuffer(),a=new Uint8Array(s,0,s.byteLength);return!1!==t.validate&&await cm((e=>Ie([Qg,e.toBytes()]))(e),a),Xg(a)}catch(e){throw ym.error("getIPNS GET %s error:",o,e),e}finally{n.clear(),s.resolve(),ym("getIPNS finished: %c",e)}}async putIPNS(e,t,r={}){ym("putIPNS starts: %c",e);let n=AbortSignal.timeout(this.timeout),i=Y([this.shutDownController.signal,n,r.signal]),s=Q(),o=Q();this.httpQueue.add((async()=>(s.resolve(),o.promise)));let a=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await s.promise;let e=Zg(t),r=await fetch(a,{method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:e,signal:i});if(ym("putIPNS PUT %s %d",a,r.status),200!==r.status)throw new U("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}catch(e){throw ym.error("putIPNS PUT %s error:",a,e.stack),e}finally{i.clear(),o.resolve(),ym("putIPNS finished: %c",e)}}#e(e){try{let t=[],r=e.Addrs?.map(Hp)??[];return null!=e.Protocols&&t.push(...e.Protocols),null!=e.Protocol&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:Gn(e.ID),Addrs:r,Protocols:t}}catch(e){ym.error("could not conform record to peer schema",e)}}},bm="[a-fA-F\\d:]",Em=e=>e&&e.includeBoundaries?`(?:(?<=\\s|^)(?=${bm})|(?<=${bm})(?=\\s|$))`:"",vm="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Sm="[a-fA-F\\d]{1,4}",Rm=`\n(?:\n(?:${Sm}:){7}(?:${Sm}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:${Sm}:){6}(?:${vm}|:${Sm}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:${Sm}:){5}(?::${vm}|(?::${Sm}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:${Sm}:){4}(?:(?::${Sm}){0,1}:${vm}|(?::${Sm}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:${Sm}:){3}(?:(?::${Sm}){0,2}:${vm}|(?::${Sm}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:${Sm}:){2}(?:(?::${Sm}){0,3}:${vm}|(?::${Sm}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:${Sm}:){1}(?:(?::${Sm}){0,4}:${vm}|(?::${Sm}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::${Sm}){0,5}:${vm}|(?::${Sm}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),Am=new RegExp(`(?:^${vm}$)|(?:^${Rm}$)`),_m=new RegExp(`^${vm}$`),Im=new RegExp(`^${Rm}$`),km=e=>e&&e.exact?Am:new RegExp(`(?:${Em(e)}${vm}${Em(e)})|(?:${Em(e)}${Rm}${Em(e)})`,"g");km.v4=e=>e&&e.exact?_m:new RegExp(`${Em(e)}${vm}${Em(e)}`,"g"),km.v6=e=>e&&e.exact?Im:new RegExp(`${Em(e)}${Rm}${Em(e)}`,"g");var Tm=km,{toString:Cm}=Object.prototype,Dm={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function xm(e,t,{timeout:r}={}){try{return function(e){let t=(...t)=>e(...t);return Object.defineProperty(t,"name",{value:`functionTimeout(${e.name||"<anonymous>"})`,configurable:!0}),t}((()=>function(e,t={}){if(!function(e){return"[object RegExp]"===Cm.call(e)}(e))throw new TypeError("Expected a RegExp instance");let r=Object.keys(Dm).map((r=>("boolean"==typeof t[r]?t[r]:e[r])?Dm[r]:"")).join(""),n=new RegExp(t.source||e.source,r);return n.lastIndex="number"==typeof t.lastIndex?t.lastIndex:e.lastIndex,n}(e).test(t)))()}catch(e){throw e}}var Nm=15,Pm=45,Lm={timeout:400};function Om(e){return!(e.length>Pm)&&xm(Tm.v6({exact:!0}),e,Lm)}var Bm={http:"80",https:"443",ws:"80",wss:"443"},Mm=["http","https","ws","wss"];function Um(e,t){let r=(t=t??{}).defaultDnsType??"dns4",{scheme:n,hostname:i,port:s}=function(e){let[t]=e.split(":");Mm.includes(t)||(e="http"+e.substring(t.length));let{protocol:r,hostname:n,port:i}=new URL(e);if(null==i||""===i){let e=function(e){if(null!=e&&""!==e&&null!=Bm[e])return Bm[e]}(t);null!=e&&(i=e),null==e&&"http:"===r&&(i="80")}return{scheme:t,hostname:n,port:i}}(e);return Hp("/"+[Fm(i,r),$m(s,n),Vm(n)].filter((e=>!!e)).reduce(((e,t)=>e.concat(t)),[]).join("/"))}function Fm(e,t){if(null!=e&&""!==e){if(function(e){return!(e.length>Nm)&&xm(Tm.v4({exact:!0}),e,Lm)}(e))return["ip4",e];if(Om(e))return["ip6",e];if("["===e[0]){let t=e.substring(1,e.length-1);if(Om(t))return["ip6",t]}return[t,e]}}function $m(e,t){if(null!=e&&""!==e)return"udp"===t?["udp",e]:["tcp",e]}function Vm(e){if(null==e.match(/^tcp$|^udp$/))return[e]}var Km=["https://trustless-gateway.link","https://4everland.io"],Hm=Symbol.for("nodejs.util.inspect.custom"),qm=class{type="url";multihash;privateKey;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Or.digest(en(this.url))}[Hm](){return`PeerId(${this.url})`}[x]=!0;toString(){return this.toCID().toString()}toCID(){return qr.createV1(2336,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Bn(e)),e.toString()===this.toString())}},zm=class{gateways;constructor(e={}){this.gateways=(e.gateways??Km).map((e=>function(e){return e=e.toString(),{id:new qm(new URL(e)),multiaddrs:[Um(e)]}}(e)))}async*findProviders(e,t){yield*this.gateways.toSorted((()=>Math.random()>.5?1:-1)).map((e=>({...e,protocols:["transport-ipfs-gateway-http"]})))}};function Wm(e={}){return new zm(e)}var jm=class{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,r){await this.libp2p.contentRouting.put(e,t,r)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}};function Gm(e){return new jm(e)}var Ym=c(g(),1),Qm=function(e){if(function(e){return null!=e[Symbol.asyncIterator]}(e))return(async()=>{let t=[];for await(let r of e)t.push(r);return t})();let t=[];for(let r of e)t.push(r);return t},Jm=function(e,t){return function(e){return null!=e[Symbol.asyncIterator]}(e)?async function*(){yield*(await Qm(e)).sort(t)}():function*(){yield*Qm(e).sort(t)}()},Zm=class{put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:r,value:n}of e)await this.put(r,n,t),yield r}async*getMany(e,t={}){for await(let r of e)yield{key:r,value:await this.get(r,t)}}async*deleteMany(e,t={}){for await(let r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(t,r){e.push({key:t,value:r})},delete(e){t.push(e)},commit:async r=>{await ce(this.putMany(e,r)),e=[],await ce(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(null!=e.prefix){let t=e.prefix;r=Nf(r,(e=>e.key.toString().startsWith(t)))}if(Array.isArray(e.filters)&&(r=e.filters.reduce(((e,t)=>Nf(e,t)),r)),Array.isArray(e.orders)&&(r=e.orders.reduce(((e,t)=>Jm(e,t)),r)),null!=e.offset){let t=0,n=e.offset;r=Nf(r,(()=>t++>=n))}return null!=e.limit&&(r=Ze(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(null!=e.prefix){let t=e.prefix;r=Nf(r,(e=>e.toString().startsWith(t)))}if(Array.isArray(e.filters)&&(r=e.filters.reduce(((e,t)=>Nf(e,t)),r)),Array.isArray(e.orders)&&(r=e.orders.reduce(((e,t)=>Jm(e,t)),r)),null!=e.offset){let t=e.offset,n=0;r=Nf(r,(()=>n++>=t))}return null!=e.limit&&(r=Ze(r,e.limit)),r}},Xm=class extends Zm{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){let t=this.data.get(e.toString());if(null==t)throw function(e){return e=e??new Error("Not Found"),(0,Ym.default)(e,"ERR_NOT_FOUND")}();return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(let[e,t]of this.data.entries())yield{key:new Nd(e),value:t}}*_allKeys(){for(let e of this.data.keys())yield new Nd(e)}},ey=(new Nd("SHARDING"),$u("datastore:core:tiered"),class extends Yf{libp2p;constructor(e){super({...e,components:{libp2p:e.libp2p}}),this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}),ty=class{readNext;haveNext;ended;nextResult;constructor(){this.ended=!1,this.readNext=Q(),this.haveNext=Q()}[Symbol.asyncIterator](){return this}async next(){if(null==this.nextResult&&await this.haveNext.promise,null==this.nextResult)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Q(),e}async throw(e){return this.ended=!0,null!=e&&(this.haveNext.promise.catch((()=>{})),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){return await this._push(void 0),{done:!0,value:void 0}}async push(e,t){await this._push(e,t)}async end(e,t){null!=e?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(null!=e&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;null!=this.nextResult;)await this.readNext.promise;null!=e?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Q(),await ie(this.readNext.promise,t?.signal,t)}},ry=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"},ny=class extends Error{code;constructor(e,t){super(e),this.code=t}},iy=class extends ny{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted",this.name="AbortError"}};function sy(e,t){let r=new ty;e.sink(r).catch((async e=>{await r.end(e)})),e.sink=async e=>{for await(let t of e)await r.push(t);await r.end()};let n=e.source;null!=e.source[Symbol.iterator]?n=e.source[Symbol.iterator]():null!=e.source[Symbol.asyncIterator]&&(n=e.source[Symbol.asyncIterator]());let i=new xe;return{read:async(e,t)=>{t?.signal?.throwIfAborted();let r,s=new Promise(((e,n)=>{r=()=>{n(new iy("Read aborted"))},t?.signal?.addEventListener("abort",r)}));try{if(null==e){let{done:e,value:t}=await Promise.race([n.next(),s]);return!0===e?new xe:t}for(;i.byteLength<e;){let{value:e,done:t}=await Promise.race([n.next(),s]);if(!0===t)throw new ry("unexpected end of input");i.append(e)}let t=i.sublist(0,e);return i.consume(e),t}finally{null!=r&&t?.signal?.removeEventListener("abort",r)}},write:async(e,t)=>{t?.signal?.throwIfAborted(),e instanceof Uint8Array?await r.push(e,t):await r.push(e.subarray(),t)},unwrap:()=>{if(i.byteLength>0){let r=e.source;e.source=async function*(){!1===t?.yieldBytes?yield i:yield*i,yield*r}()}return e}}}var oy=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},ay=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},ly=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function cy(e,t={}){let r=sy(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=ve(t.maxDataLength));let n=t?.lengthDecoder??_e,i=t?.lengthEncoder??Ae;return{read:async e=>{let i=-1,s=new xe;for(;;){s.append(await r.read(1,e));try{i=n(s)}catch(e){if(e instanceof RangeError)continue;throw e}if(i<0)throw new oy("Invalid message length");if(null!=t?.maxLengthLength&&s.byteLength>t.maxLengthLength)throw new ly("message length length too long");if(i>-1)break}if(null!=t?.maxDataLength&&i>t.maxDataLength)throw new ay("message length too long");return r.read(i,e)},write:async(e,t)=>{await r.write(new xe(i(e.byteLength),e),t)},writeV:async(e,t)=>{let n=new xe(...e.flatMap((e=>[i(e.byteLength),e])));await r.write(n,t)},unwrap:()=>r.unwrap()}}function uy(){let e=Q(),t=!1;return{sink:async r=>{if(t)throw new Error("already piped");t=!0,e.resolve(r)},source:async function*(){yield*await e.promise}()}}var hy=!!globalThis.process?.env?.DUMP_SESSION_KEYS;function dy(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function fy(e){if("boolean"!=typeof e)throw new Error(`boolean expected, not ${e}`)}function py(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}function gy(e,...t){if(!py(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function my(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}var yy=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4));if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");function wy(e){if("string"==typeof e)e=function(e){if("string"!=typeof e)throw new Error("string expected, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e);else{if(!py(e))throw new Error("Uint8Array expected, got "+typeof e);e=vy(e)}return e}var by=(e,t)=>(Object.assign(t,e),t);function Ey(e,t,r,n){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,r,n);let i=BigInt(32),s=BigInt(4294967295),o=Number(r>>i&s),a=Number(r&s),l=n?4:0,c=n?0:4;e.setUint32(t+l,o,n),e.setUint32(t+c,a,n)}function vy(e){return Uint8Array.from(e)}function Sy(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}var Ry=e=>Uint8Array.from(e.split("").map((e=>e.charCodeAt(0)))),Ay=Ry("expand 16-byte k"),_y=Ry("expand 32-byte k"),Iy=yy(Ay),ky=yy(_y);function Ty(e,t){return e<<t|e>>>32-t}function Cy(e){return e.byteOffset%4==0}ky.slice();var Dy=2**32-1,xy=new Uint32Array;function Ny(e,t){let{allowShortKeys:r,extendNonceFn:n,counterLength:i,counterRight:s,rounds:o}=function(e,t){if(null==t||"object"!=typeof t)throw new Error("options must be defined");return Object.assign({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t)}(0,t);if("function"!=typeof e)throw new Error("core must be a function");return dy(i),dy(o),fy(s),fy(r),(t,a,l,c,u=0)=>{gy(t),gy(a),gy(l);let h=l.length;if(void 0===c&&(c=new Uint8Array(h)),gy(c),dy(u),u<0||u>=Dy)throw new Error("arx: counter overflow");if(c.length<h)throw new Error(`arx: output (${c.length}) is shorter than data (${h})`);let d,f,p=[],g=t.length;if(32===g)p.push(d=vy(t)),f=ky;else{if(16!==g||!r)throw new Error(`arx: invalid 32-byte key, got length=${g}`);d=new Uint8Array(32),d.set(t),d.set(t,16),f=Iy,p.push(d)}Cy(a)||p.push(a=vy(a));let m=yy(d);if(n){if(24!==a.length)throw new Error("arx: extended nonce must be 24 bytes");n(f,m,yy(a.subarray(0,16)),m),a=a.subarray(16)}let y=16-i;if(y!==a.length)throw new Error(`arx: nonce must be ${y} or 16 bytes`);if(12!==y){let e=new Uint8Array(12);e.set(a,s?0:12-a.length),a=e,p.push(a)}let w=yy(a);return function(e,t,r,n,i,s,o,a){let l=i.length,c=new Uint8Array(64),u=yy(c),h=Cy(i)&&Cy(s),d=h?yy(i):xy,f=h?yy(s):xy;for(let p=0;p<l;o++){if(e(t,r,n,u,o,a),o>=Dy)throw new Error("arx: counter overflow");let g=Math.min(64,l-p);if(h&&64===g){let e=p/4;if(p%4!=0)throw new Error("arx: invalid block position");for(let t,r=0;r<16;r++)t=e+r,f[t]=d[t]^u[r];p+=64}else{for(let e,t=0;t<g;t++)e=p+t,s[e]=i[e]^c[t];p+=g}}}(e,f,m,w,l,c,u,o),Sy(...p),c}}var Py=(e,t)=>255&e[t++]|(255&e[t++])<<8,Ly=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,gy(e=wy(e),32);let t=Py(e,0),r=Py(e,2),n=Py(e,4),i=Py(e,6),s=Py(e,8),o=Py(e,10),a=Py(e,12),l=Py(e,14);this.r[0]=8191&t,this.r[1]=8191&(t>>>13|r<<3),this.r[2]=7939&(r>>>10|n<<6),this.r[3]=8191&(n>>>7|i<<9),this.r[4]=255&(i>>>4|s<<12),this.r[5]=s>>>1&8190,this.r[6]=8191&(s>>>14|o<<2),this.r[7]=8065&(o>>>11|a<<5),this.r[8]=8191&(a>>>8|l<<8),this.r[9]=l>>>5&127;for(let t=0;t<8;t++)this.pad[t]=Py(e,16+2*t)}process(e,t,r=!1){let n=r?0:2048,{h:i,r:s}=this,o=s[0],a=s[1],l=s[2],c=s[3],u=s[4],h=s[5],d=s[6],f=s[7],p=s[8],g=s[9],m=Py(e,t+0),y=Py(e,t+2),w=Py(e,t+4),b=Py(e,t+6),E=Py(e,t+8),v=Py(e,t+10),S=Py(e,t+12),R=Py(e,t+14),A=i[0]+(8191&m),_=i[1]+(8191&(m>>>13|y<<3)),I=i[2]+(8191&(y>>>10|w<<6)),k=i[3]+(8191&(w>>>7|b<<9)),T=i[4]+(8191&(b>>>4|E<<12)),C=i[5]+(E>>>1&8191),D=i[6]+(8191&(E>>>14|v<<2)),x=i[7]+(8191&(v>>>11|S<<5)),N=i[8]+(8191&(S>>>8|R<<8)),P=i[9]+(R>>>5|n),L=0,O=L+A*o+_*(5*g)+I*(5*p)+k*(5*f)+T*(5*d);L=O>>>13,O&=8191,O+=C*(5*h)+D*(5*u)+x*(5*c)+N*(5*l)+P*(5*a),L+=O>>>13,O&=8191;let B=L+A*a+_*o+I*(5*g)+k*(5*p)+T*(5*f);L=B>>>13,B&=8191,B+=C*(5*d)+D*(5*h)+x*(5*u)+N*(5*c)+P*(5*l),L+=B>>>13,B&=8191;let M=L+A*l+_*a+I*o+k*(5*g)+T*(5*p);L=M>>>13,M&=8191,M+=C*(5*f)+D*(5*d)+x*(5*h)+N*(5*u)+P*(5*c),L+=M>>>13,M&=8191;let U=L+A*c+_*l+I*a+k*o+T*(5*g);L=U>>>13,U&=8191,U+=C*(5*p)+D*(5*f)+x*(5*d)+N*(5*h)+P*(5*u),L+=U>>>13,U&=8191;let F=L+A*u+_*c+I*l+k*a+T*o;L=F>>>13,F&=8191,F+=C*(5*g)+D*(5*p)+x*(5*f)+N*(5*d)+P*(5*h),L+=F>>>13,F&=8191;let $=L+A*h+_*u+I*c+k*l+T*a;L=$>>>13,$&=8191,$+=C*o+D*(5*g)+x*(5*p)+N*(5*f)+P*(5*d),L+=$>>>13,$&=8191;let V=L+A*d+_*h+I*u+k*c+T*l;L=V>>>13,V&=8191,V+=C*a+D*o+x*(5*g)+N*(5*p)+P*(5*f),L+=V>>>13,V&=8191;let K=L+A*f+_*d+I*h+k*u+T*c;L=K>>>13,K&=8191,K+=C*l+D*a+x*o+N*(5*g)+P*(5*p),L+=K>>>13,K&=8191;let H=L+A*p+_*f+I*d+k*h+T*u;L=H>>>13,H&=8191,H+=C*c+D*l+x*a+N*o+P*(5*g),L+=H>>>13,H&=8191;let q=L+A*g+_*p+I*f+k*d+T*h;L=q>>>13,q&=8191,q+=C*u+D*c+x*l+N*a+P*o,L+=q>>>13,q&=8191,L=(L<<2)+L|0,L=L+O|0,O=8191&L,L>>>=13,B+=L,i[0]=O,i[1]=B,i[2]=M,i[3]=U,i[4]=F,i[5]=$,i[6]=V,i[7]=K,i[8]=H,i[9]=q}finalize(){let{h:e,pad:t}=this,r=new Uint16Array(10),n=e[1]>>>13;e[1]&=8191;for(let t=2;t<10;t++)e[t]+=n,n=e[t]>>>13,e[t]&=8191;e[0]+=5*n,n=e[0]>>>13,e[0]&=8191,e[1]+=n,n=e[1]>>>13,e[1]&=8191,e[2]+=n,r[0]=e[0]+5,n=r[0]>>>13,r[0]&=8191;for(let t=1;t<10;t++)r[t]=e[t]+n,n=r[t]>>>13,r[t]&=8191;r[9]-=8192;let i=(1^n)-1;for(let e=0;e<10;e++)r[e]&=i;i=~i;for(let t=0;t<10;t++)e[t]=e[t]&i|r[t];e[0]=65535&(e[0]|e[1]<<13),e[1]=65535&(e[1]>>>3|e[2]<<10),e[2]=65535&(e[2]>>>6|e[3]<<7),e[3]=65535&(e[3]>>>9|e[4]<<4),e[4]=65535&(e[4]>>>12|e[5]<<1|e[6]<<14),e[5]=65535&(e[6]>>>2|e[7]<<11),e[6]=65535&(e[7]>>>5|e[8]<<8),e[7]=65535&(e[8]>>>8|e[9]<<5);let s=e[0]+t[0];e[0]=65535&s;for(let r=1;r<8;r++)s=(e[r]+t[r]|0)+(s>>>16)|0,e[r]=65535&s;Sy(r)}update(e){my(this);let{buffer:t,blockLen:r}=this,n=(e=wy(e)).length;for(let i=0;i<n;){let s=Math.min(r-this.pos,n-i);if(s!==r)t.set(e.subarray(i,i+s),this.pos),this.pos+=s,i+=s,this.pos===r&&(this.process(t,0,!1),this.pos=0);else for(;r<=n-i;i+=r)this.process(e,i)}return this}destroy(){Sy(this.h,this.r,this.buffer,this.pad)}digestInto(e){my(this),function(e,t){gy(e);let r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}(e,this),this.finished=!0;let{buffer:t,h:r}=this,{pos:n}=this;if(n){for(t[n++]=1;n<16;n++)t[n]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let t=0;t<8;t++)e[i++]=r[t]>>>0,e[i++]=r[t]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let r=e.slice(0,t);return this.destroy(),r}},Oy=function(e){let t=(t,r)=>e(r).update(wy(t)).digest(),r=e(new Uint8Array(32));return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=t=>e(t),t}((e=>new Ly(e)));function By(e,t,r,n,i,s=20){let o=e[0],a=e[1],l=e[2],c=e[3],u=t[0],h=t[1],d=t[2],f=t[3],p=t[4],g=t[5],m=t[6],y=t[7],w=i,b=r[0],E=r[1],v=r[2],S=o,R=a,A=l,_=c,I=u,k=h,T=d,C=f,D=p,x=g,N=m,P=y,L=w,O=b,B=E,M=v;for(let e=0;e<s;e+=2)S=S+I|0,L=Ty(L^S,16),D=D+L|0,I=Ty(I^D,12),S=S+I|0,L=Ty(L^S,8),D=D+L|0,I=Ty(I^D,7),R=R+k|0,O=Ty(O^R,16),x=x+O|0,k=Ty(k^x,12),R=R+k|0,O=Ty(O^R,8),x=x+O|0,k=Ty(k^x,7),A=A+T|0,B=Ty(B^A,16),N=N+B|0,T=Ty(T^N,12),A=A+T|0,B=Ty(B^A,8),N=N+B|0,T=Ty(T^N,7),_=_+C|0,M=Ty(M^_,16),P=P+M|0,C=Ty(C^P,12),_=_+C|0,M=Ty(M^_,8),P=P+M|0,C=Ty(C^P,7),S=S+k|0,M=Ty(M^S,16),N=N+M|0,k=Ty(k^N,12),S=S+k|0,M=Ty(M^S,8),N=N+M|0,k=Ty(k^N,7),R=R+T|0,L=Ty(L^R,16),P=P+L|0,T=Ty(T^P,12),R=R+T|0,L=Ty(L^R,8),P=P+L|0,T=Ty(T^P,7),A=A+C|0,O=Ty(O^A,16),D=D+O|0,C=Ty(C^D,12),A=A+C|0,O=Ty(O^A,8),D=D+O|0,C=Ty(C^D,7),_=_+I|0,B=Ty(B^_,16),x=x+B|0,I=Ty(I^x,12),_=_+I|0,B=Ty(B^_,8),x=x+B|0,I=Ty(I^x,7);let U=0;n[U++]=o+S|0,n[U++]=a+R|0,n[U++]=l+A|0,n[U++]=c+_|0,n[U++]=u+I|0,n[U++]=h+k|0,n[U++]=d+T|0,n[U++]=f+C|0,n[U++]=p+D|0,n[U++]=g+x|0,n[U++]=m+N|0,n[U++]=y+P|0,n[U++]=w+L|0,n[U++]=b+O|0,n[U++]=E+B|0,n[U++]=v+M|0}var My=Ny(By,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Uy=Ny(By,{counterRight:!1,counterLength:8,extendNonceFn:function(e,t,r,n){let i=e[0],s=e[1],o=e[2],a=e[3],l=t[0],c=t[1],u=t[2],h=t[3],d=t[4],f=t[5],p=t[6],g=t[7],m=r[0],y=r[1],w=r[2],b=r[3];for(let e=0;e<20;e+=2)i=i+l|0,m=Ty(m^i,16),d=d+m|0,l=Ty(l^d,12),i=i+l|0,m=Ty(m^i,8),d=d+m|0,l=Ty(l^d,7),s=s+c|0,y=Ty(y^s,16),f=f+y|0,c=Ty(c^f,12),s=s+c|0,y=Ty(y^s,8),f=f+y|0,c=Ty(c^f,7),o=o+u|0,w=Ty(w^o,16),p=p+w|0,u=Ty(u^p,12),o=o+u|0,w=Ty(w^o,8),p=p+w|0,u=Ty(u^p,7),a=a+h|0,b=Ty(b^a,16),g=g+b|0,h=Ty(h^g,12),a=a+h|0,b=Ty(b^a,8),g=g+b|0,h=Ty(h^g,7),i=i+c|0,b=Ty(b^i,16),p=p+b|0,c=Ty(c^p,12),i=i+c|0,b=Ty(b^i,8),p=p+b|0,c=Ty(c^p,7),s=s+u|0,m=Ty(m^s,16),g=g+m|0,u=Ty(u^g,12),s=s+u|0,m=Ty(m^s,8),g=g+m|0,u=Ty(u^g,7),o=o+h|0,y=Ty(y^o,16),d=d+y|0,h=Ty(h^d,12),o=o+h|0,y=Ty(y^o,8),d=d+y|0,h=Ty(h^d,7),a=a+l|0,w=Ty(w^a,16),f=f+w|0,l=Ty(l^f,12),a=a+l|0,w=Ty(w^a,8),f=f+w|0,l=Ty(l^f,7);let E=0;n[E++]=i,n[E++]=s,n[E++]=o,n[E++]=a,n[E++]=m,n[E++]=y,n[E++]=w,n[E++]=b},allowShortKeys:!1}),Fy=new Uint8Array(16),$y=(e,t)=>{e.update(t);let r=t.length%16;r&&e.update(Fy.subarray(r))},Vy=new Uint8Array(32);function Ky(e,t,r,n,i){let s=e(t,r,Vy),o=Oy.create(s);i&&$y(o,i),$y(o,n);let a=new Uint8Array(16),l=(e=>new DataView(e.buffer,e.byteOffset,e.byteLength))(a);Ey(l,0,BigInt(i?i.length:0),!0),Ey(l,8,BigInt(n.length),!0),o.update(a);let c=o.digest();return Sy(s,a),c}var Hy=e=>(t,r,n)=>(gy(t,32),gy(r),{encrypt(i,s){let o=i.length,a=o+16;s?gy(s,a):s=new Uint8Array(a),e(t,r,i,s,1);let l=Ky(e,t,r,s.subarray(0,-16),n);return s.set(l,o),Sy(l),s},decrypt(i,s){let o=i.length,a=o-16;if(o<16)throw new Error("encrypted data must be at least 16 bytes");s?gy(s,a):s=new Uint8Array(a);let l=i.subarray(0,-16),c=i.subarray(-16),u=Ky(e,t,r,l,n);if(!function(e,t){if(e.length!==t.length)return!1;let r=0;for(let n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}(c,u))throw new Error("invalid tag");return e(t,r,l,s,1),Sy(u),s}}),qy=by({blockSize:64,nonceLength:12,tagLength:16},Hy(My));by({blockSize:64,nonceLength:24,tagLength:16},Hy(Uy));var zy=new Uint8Array([0]),Wy=new Uint8Array,jy={hashSHA256:e=>_c(e.subarray()),getHKDF(e,t){let r=function(e,t,r){return ci(e),void 0===r&&(r=new Uint8Array(e.outputLen)),$o(e,yi(r),yi(t))}(_c,t,e),n=function(e,t,r,n=32){if(ci(e),ai(n),n>255*e.outputLen)throw new Error("Length should be <= 255*HashLen");let i=Math.ceil(n/e.outputLen);void 0===r&&(r=Wy);let s=new Uint8Array(i*e.outputLen),o=$o.create(e,t),a=o._cloneInto(),l=new Uint8Array(o.outputLen);for(let t=0;t<i;t++)zy[0]=t+1,a.update(0===t?Wy:l).update(r).update(zy).digestInto(l),s.set(l,e.outputLen*t),o._cloneInto(a);return o.destroy(),a.destroy(),l.fill(0),zy.fill(0),s.slice(0,n)}(_c,r,void 0,96);return[n.subarray(0,32),n.subarray(32,64),n.subarray(64,96)]},generateX25519KeyPair(){let e=ao.utils.randomPrivateKey();return{publicKey:ao.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:ao.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>ao.getSharedSecret(e.subarray(),t.subarray()),chaCha20Poly1305Encrypt:(e,t,r,n)=>qy(n,t,r).encrypt(e.subarray()),chaCha20Poly1305Decrypt:(e,t,r,n,i)=>qy(n,t,r).decrypt(e.subarray(),i)},Gy=jy,Yy=e=>{let t=he(2);return t[0]=e>>8,t[1]=e,t};Yy.bytes=2;var Qy=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");if(e instanceof Uint8Array){let t=0;return t+=e[0]<<8,t+=e[1],t}return e.getUint16(0)};function Jy(e,t){!t.enabled||!hy||(e?(t(`LOCAL_STATIC_PUBLIC_KEY ${Bn(e.publicKey,"hex")}`),t(`LOCAL_STATIC_PRIVATE_KEY ${Bn(e.privateKey,"hex")}`)):t("Missing local static keys."))}function Zy(e,t){!t.enabled||!hy||(e?(t(`LOCAL_PUBLIC_EPHEMERAL_KEY ${Bn(e.publicKey,"hex")}`),t(`LOCAL_PRIVATE_EPHEMERAL_KEY ${Bn(e.privateKey,"hex")}`)):t("Missing local ephemeral keys."))}function Xy(e,t){!t.enabled||!hy||t(e?`REMOTE_EPHEMERAL_PUBLIC_KEY ${Bn(e.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function ew(e,t,r){!r.enabled||!hy||(r(`CIPHER_STATE_1 ${e.n.getUint64()} ${e.k&&Bn(e.k,"hex")}`),r(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&Bn(t.k,"hex")}`))}function tw(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");let r=he(e.length);for(let n=0;n<e.length;n++)r[n]=e[n]^t[n];return r}Qy.bytes=2;var rw,nw,iw=class e extends Error{code;constructor(t="Unexpected Peer"){super(t),this.code=e.code}static code="ERR_UNEXPECTED_PEER"},sw=class e extends Error{code;constructor(t="Invalid crypto exchange"){super(t),this.code=e.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"},ow=class{n;bytes;view;constructor(e=0){this.n=e,this.bytes=ue(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}},aw=ue(0),lw=class{k;n;crypto;constructor(e,t=void 0,r=0){this.crypto=e,this.k=t,this.n=new ow(r)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();let r=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),r}decryptWithAd(e,t,r){if(!this.hasKey())return t;this.n.assertValue();let n=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,r);return this.n.increment(),n}},cw=class{cs;ck;h;crypto;constructor(e,t){this.crypto=e;let r=en(t,"utf-8");this.h=function(e,t){if(t.length<=32){let e=ue(32);return e.set(t),e}return e.hash(t)}(e,r),this.ck=this.h,this.cs=new lw(e)}mixKey(e){let[t,r]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new lw(this.crypto,r)}mixHash(e){this.h=this.crypto.hash(new xe(this.h,e))}encryptAndHash(e){let t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){let t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){let[e,t]=this.crypto.hkdf(this.ck,aw);return[new lw(this.crypto,e),new lw(this.crypto,t)]}},uw=class{ss;s;e;rs;re;initiator;crypto;constructor(e){let{crypto:t,protocolName:r,prologue:n,initiator:i,s,e:o,rs:a,re:l}=e;this.crypto=t,this.ss=new cw(t,r),this.ss.mixHash(n),this.initiator=i,this.s=s,this.e=o,this.rs=a,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");let r=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+r)throw new Error("message is not long enough");let n=e.sublist(t,t+r);return this.rs=this.ss.decryptAndHash(n),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},hw=class extends uw{writeMessageA(e){return new xe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){let t=this.writeE();this.writeEE();let r=this.writeS();return this.writeES(),new xe(t,r,this.ss.encryptAndHash(e))}writeMessageC(e){let t=this.writeS();return this.writeSE(),new xe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(e){throw new sw(`handshake stage 0 validation fail: ${e.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();let t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(e){throw new sw(`handshake stage 1 validation fail: ${e.message}`)}}readMessageC(e){try{let t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(e){throw new sw(`handshake stage 2 validation fail: ${e.message}`)}}};async function dw(e,t,r){let n=await e.sign(pw(t));return nw.encode({identityKey:e.public.bytes,identitySig:n,extensions:r})}async function fw(e,t,r){try{let n=nw.decode(e);if(r){let e=r.subarray();if(!ke(e,n.identityKey))throw new Error(`Payload identity key ${Bn(n.identityKey,"hex")} does not match expected remote identity key ${Bn(e,"hex")}`)}if(!t)throw new Error("Remote static does not exist");let i=pw(t);if(!await Xc(n.identityKey).verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(e){throw new iw(e.message)}}function pw(e){let t=en("noise-libp2p-static-key:");return e instanceof Uint8Array?Ie([t,e],t.length+e.length):(e.prepend(t),e)}!function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(let r of e.webtransportCerthashes)t.uint32(10),t.bytes(r);!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={webtransportCerthashes:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();t>>>3==1?r.webtransportCerthashes.push(e.bytes()):e.skipType(7&t)}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(rw||(rw={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.identityKey&&e.identityKey.byteLength>0&&(t.uint32(10),t.bytes(e.identityKey)),null!=e.identitySig&&e.identitySig.byteLength>0&&(t.uint32(18),t.bytes(e.identitySig)),null!=e.extensions&&(t.uint32(34),rw.codec().encode(e.extensions,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={identityKey:ue(0),identitySig:ue(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.identityKey=e.bytes();break;case 2:r.identitySig=e.bytes();break;case 4:r.extensions=rw.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(nw||(nw={}));var gw=class{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){let{staticNoiseKey:r,extensions:n,crypto:i,prologueBytes:s}=t,{metrics:o}=e;this.components=e;let a=i??Gy;this.crypto=function(e){return{generateKeypair:e.generateX25519KeyPair,dh:(t,r)=>e.generateX25519SharedKey(t.privateKey,r).subarray(0,32),encrypt:e.chaCha20Poly1305Encrypt,decrypt:e.chaCha20Poly1305Decrypt,hash:e.hashSHA256,hkdf:e.getHKDF}}(a),this.extensions=n,this.metrics=o?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(o):void 0,this.staticKey=r?a.generateX25519KeyPairFromSeed(r):a.generateX25519KeyPair(),this.prologue=s??ue(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[j]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(...e){let{localPeer:t,connection:r,remotePeer:n,signal:i}=this.parseArgs(e),s=cy(r,{lengthEncoder:Yy,lengthDecoder:Qy,maxDataLength:65535});if(!t.privateKey)throw new U("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");let o=await tu(t.privateKey),a=n?.publicKey,l=await this.performHandshakeInitiator(s,o,a,{signal:i}),c=await this.createSecureConnection(s,l);return r.source=c.source,r.sink=c.sink,{conn:r,remoteExtensions:l.payload.extensions,remotePeer:await Qn(l.payload.identityKey)}}async secureInbound(...e){let{localPeer:t,connection:r,remotePeer:n,signal:i}=this.parseArgs(e),s=cy(r,{lengthEncoder:Yy,lengthDecoder:Qy,maxDataLength:65535});if(!t.privateKey)throw new U("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");let o=await tu(t.privateKey),a=n?.publicKey,l=await this.performHandshakeResponder(s,o,a,{signal:i}),c=await this.createSecureConnection(s,l);return r.source=c.source,r.sink=c.sink,{conn:r,remoteExtensions:l.payload.extensions,remotePeer:await Qn(l.payload.identityKey)}}async performHandshakeInitiator(e,t,r,n){let i;try{i=await async function(e,t){let{log:r,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:l,extensions:c}=e,u=await dw(s,a.publicKey,c),h=new hw({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});Jy(h.s,r),r.trace("Stage 0 - Initiator starting to send first message."),await n.write(h.writeMessageA(aw),t),r.trace("Stage 0 - Initiator finished sending first message."),Zy(h.e,r),r.trace("Stage 1 - Initiator waiting to receive first message from responder...");let d=h.readMessageB(await n.read(t));r.trace("Stage 1 - Initiator received the message."),Xy(h.re,r),function(e,t){!t.enabled||!hy||t(e?`REMOTE_STATIC_PUBLIC_KEY ${Bn(e.subarray(),"hex")}`:"Missing remote static public key.")}(h.rs,r),r.trace("Initiator going to check remote's signature...");let f=await fw(d,h.rs,l);r.trace("All good with the signature!"),r.trace("Stage 2 - Initiator sending third handshake message."),await n.write(h.writeMessageC(u),t),r.trace("Stage 2 - Initiator sent message with signed payload.");let[p,g]=h.ss.split();return ew(p,g,r),{payload:f,encrypt:e=>p.encryptWithAd(aw,e),decrypt:(e,t)=>g.decryptWithAd(aw,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},n),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return i}async performHandshakeResponder(e,t,r,n){let i;try{i=await async function(e,t){let{log:r,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:l,extensions:c}=e,u=await dw(s,a.publicKey,c),h=new hw({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});Jy(h.s,r),r.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await n.read(t)),r.trace("Stage 0 - Responder received first message."),Xy(h.re,r),r.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(h.writeMessageB(u),t),r.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Zy(h.e,r),r.trace("Stage 2 - Responder waiting for third handshake message...");let d=h.readMessageC(await n.read(t));r.trace("Stage 2 - Responder received the message, finished handshake.");let f=await fw(d,h.rs,l),[p,g]=h.ss.split();return ew(p,g,r),{payload:f,encrypt:e=>g.encryptWithAd(aw,e),decrypt:(e,t)=>p.decryptWithAd(aw,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},n),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return i}async createSecureConnection(e,t){let[r,n]=function(){let e=uy(),t=uy();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}(),i=e.unwrap();return await We(r,function(e,t){return async function*(r){for await(let n of r)for(let r=0;r<n.length;r+=65519){let i,s=r+65519;s>n.length&&(s=n.length),i=n instanceof Uint8Array?e.encrypt(n.subarray(r,s)):e.encrypt(n.sublist(r,s)),t?.encryptedPackets.increment(),yield new xe(Yy(i.byteLength),i)}}}(t,this.metrics),i,(e=>Ve(e,{lengthDecoder:Qy})),function(e,t){return async function*(r){for await(let n of r)for(let r=0;r<n.length;r+=65535){let i=r+65535;if(i>n.length&&(i=n.length),i-16<r)throw new Error("Invalid chunk");let s=n.sublist(r,i),o=n.subarray(r,i-16);try{let r=e.decrypt(s,o);t?.decryptedPackets.increment(),yield r}catch(e){throw t?.decryptErrors.increment(),e}}}}(t,this.metrics),r),n}parseArgs(e){return N(e[0])?{localPeer:e[0],connection:e[1],remotePeer:e[2]}:{localPeer:this.components.peerId,connection:e[0],remotePeer:e[1]?.remotePeer,signal:e[1]?.signal}}};function mw(e={}){return t=>new gw(t,e)}function yw(e){if(null!=e){if("function"==typeof e[Symbol.iterator])return e[Symbol.iterator]();if("function"==typeof e[Symbol.asyncIterator])return e[Symbol.asyncIterator]();if("function"==typeof e.next)return e}throw new Error("argument is not an iterator or iterable")}var ww,bw,Ew,vw="ERR_INVALID_FRAME",Sw="ERR_UNREQUESTED_PING",Rw="ERR_NOT_MATCHING_PING",Aw="ERR_STREAM_ALREADY_EXISTS",_w="ERR_DECODE_INVALID_VERSION",Iw="ERR_BOTH_CLIENTS",kw="ERR_RECV_WINDOW_EXCEEDED",Tw=new Set([vw,Sw,Rw,Aw,_w,Iw,kw]),Cw="ERR_INVALID_CONFIG",Dw="ERR_MUXER_LOCAL_CLOSED",xw="ERR_MUXER_REMOTE_CLOSED",Nw=262144,Pw={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Nw,maxStreamWindowSize:16777216,maxMessageSize:65536};!function(e){e[e.Data=0]="Data",e[e.WindowUpdate=1]="WindowUpdate",e[e.Ping=2]="Ping",e[e.GoAway=3]="GoAway"}(ww||(ww={})),function(e){e[e.SYN=1]="SYN",e[e.ACK=2]="ACK",e[e.FIN=4]="FIN",e[e.RST=8]="RST"}(bw||(bw={})),Object.values(bw).filter((e=>"string"!=typeof e)),function(e){e[e.NormalTermination=0]="NormalTermination",e[e.ProtocolError=1]="ProtocolError",e[e.InternalError=2]="InternalError"}(Ew||(Ew={}));var Lw=2**24,Ow=class{source;buffer;frameInProgress;constructor(e){this.source=function(e){if(void 0!==e[Symbol.iterator]){let t=e[Symbol.iterator]();return t.return=void 0,{[Symbol.iterator]:()=>t}}if(void 0!==e[Symbol.asyncIterator]){let t=e[Symbol.asyncIterator]();return t.return=void 0,{[Symbol.asyncIterator]:()=>t}}throw new Error("a source must be either an iterable or an async iterable")}(e),this.buffer=new xe,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let e=this.readHeader();if(void 0===e)break;let{type:t,length:r}=e;t===ww.Data?(this.frameInProgress=!0,yield{header:e,readData:this.readBytes.bind(this,r)}):yield{header:e}}}readHeader(){if(this.frameInProgress)throw new U("decoding frame already in progress","ERR_DECODE_IN_PROGRESS");if(this.buffer.length<12)return;let e=function(e){if(0!==e[0])throw new U("Invalid frame version",_w);return{type:e[1],flag:(e[2]<<8)+e[3],streamID:e[4]*Lw+(e[5]<<16)+(e[6]<<8)+e[7],length:e[8]*Lw+(e[9]<<16)+(e[10]<<8)+e[11]}}(this.buffer.subarray(0,12));return this.buffer.consume(12),e}async readBytes(e){if(this.buffer.length<e)for await(let t of this.source)if(this.buffer.append(t),this.buffer.length>=e)break;let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function Bw(e){let t=new Uint8Array(12);return t[1]=e.type,t[2]=e.flag>>>8,t[3]=e.flag,t[4]=e.streamID>>>24,t[5]=e.streamID>>>16,t[6]=e.streamID>>>8,t[7]=e.streamID,t[8]=e.length>>>24,t[9]=e.length>>>16,t[10]=e.length>>>8,t[11]=e.length,t}function Mw(e,t){let r=yw(e).return?.();(function(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally})(r)&&r.catch((e=>{t.error("could not cause iterator to return",e)}))}function Uw(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally}var Fw,$w=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=Q(),this.closed=Q(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??5e3,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=ee({onEnd:e=>{null!=e?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(e){if("ready"!==this.writeStatus)throw new U(`writable end state is "${this.writeStatus}" not "ready"`,"ERR_SINK_INVALID_STATE");try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if("outbound"===this.direction){let e=this.sendNewStream(t);Uw(e)&&await e}let r=()=>{Mw(e,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let r of e){r=r instanceof Uint8Array?new xe(r):r;let e=this.sendData(r,t);Uw(e)&&(this.sendingData=Q(),await e,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),"writing"===this.writeStatus&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){null==this.timeline.closeRead&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseRead?.(),null!=this.timeline.closeWrite?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){null==this.timeline.closeWrite&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseWrite?.(),null!=this.timeline.closeRead?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await ie(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if("closing"===this.readStatus||"closed"===this.readStatus)return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing","reset"!==this.status&&"aborted"!==this.status&&null==this.timeline.closeRead&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),"ready"===t&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){"closing"===this.writeStatus||"closed"===this.writeStatus||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),"ready"===this.writeStatus&&(this.log.trace("sink was never sunk, sink an empty array"),await ie(this.sink([]),e.signal)),"writing"===this.writeStatus&&(null!=this.sendingData&&await ie(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await ie(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();Uw(t)&&t.catch((e=>{this.log.error("error sending reset message",e)})),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;let e=new U("stream reset","ERR_STREAM_RESET");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){"writing"===this.writeStatus&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){"closing"!==this.readStatus&&"closed"!==this.readStatus&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){"closing"!==this.readStatus&&"closed"!==this.readStatus?(this.log.trace("remote close write"),this._closeSource()):this.log("received remote close write but local source is already closed")}remoteCloseRead(){"closing"!==this.writeStatus&&"closed"!==this.writeStatus?(this.log.trace("remote close read"),this._closeSink()):this.log("received remote close read but local sink is already closed")}destroy(){"closed"!==this.status&&"aborted"!==this.status&&"reset"!==this.status?(this.log.trace("stream destroyed"),this._closeSinkAndSource()):this.log("received destroy but we are already closed")}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};!function(e){e[e.Init=0]="Init",e[e.SYNSent=1]="SYNSent",e[e.SYNReceived=2]="SYNReceived",e[e.Established=3]="Established",e[e.Finished=4]="Finished"}(Fw||(Fw={}));var Vw=class extends $w{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=Fw.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Nw,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=Bf(this.source,(()=>{this.sendWindowUpdate()}))}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();0!==e.byteLength;){if(0===this.sendWindowCapacity&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),"closed"===this.status||"aborted"===this.status||"reset"===this.status))return void this.log?.trace("%s while waiting for send window capacity",this.status);let r=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-12,e.length),n=this.getSendFlags();this.sendFrame({type:ww.Data,flag:n,streamID:this._id,length:r},e.sublist(0,r)),this.sendWindowCapacity-=r,e.consume(r)}}async sendReset(){this.sendFrame({type:ww.WindowUpdate,flag:bw.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|bw.FIN;this.sendFrame({type:ww.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,r,n=()=>{"open"===this.status||"closing"===this.status?r(new U("stream aborted","ERR_STREAM_ABORT")):t()};e.signal?.addEventListener("abort",n);try{await new Promise(((e,n)=>{this.sendWindowCapacityUpdate=()=>{e()},r=n,t=e}))}finally{e.signal?.removeEventListener("abort",n)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,0===t&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new U("receive window exceeded",kw,{available:this.recvWindowCapacity,recv:e.length});let r=await t();this.recvWindowCapacity-=e.length,this.sourcePush(r)}processFlags(e){(e&bw.ACK)===bw.ACK&&this.state===Fw.SYNSent&&(this.state=Fw.Established),(e&bw.FIN)===bw.FIN&&this.remoteCloseWrite(),(e&bw.RST)===bw.RST&&this.reset()}getSendFlags(){switch(this.state){case Fw.Init:return this.state=Fw.SYNSent,bw.SYN;case Fw.SYNReceived:return this.state=Fw.Established,bw.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),r=this.getRTT();if(0===e&&r>-1&&t-this.epochStart<4*r&&(this.recvWindow=Math.min(2*this.recvWindow,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&0===e)return;let n=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:ww.WindowUpdate,flag:e,streamID:this._id,length:n})}},Kw="/yamux/1.0.0",Hw=class{protocol=Kw;_components;_init;constructor(e,t={}){this._components=e,this._init=t}createStreamMuxer(e){return new qw(this._components,{...this._init,...e})}},qw=class{protocol=Kw;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client="outbound"===t.direction,this.config={...Pw,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),function(e){if(e.keepAliveInterval<=0)throw new U("keep-alive interval must be positive",Cw);if(e.maxInboundStreams<0)throw new U("max inbound streams must be larger or equal 0",Cw);if(e.maxOutboundStreams<0)throw new U("max outbound streams must be larger or equal 0",Cw);if(e.initialStreamWindowSize<Nw)throw new U("InitialStreamWindowSize must be larger or equal 256 kB",Cw);if(e.maxStreamWindowSize<e.initialStreamWindowSize)throw new U("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Cw);if(e.maxStreamWindowSize>2**32-1)throw new U("MaxStreamWindowSize must be less than equal MAX_UINT32",Cw);if(e.maxMessageSize<1024)throw new U("MaxMessageSize must be greater than a kilobyte",Cw)}(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=ee({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach((e=>{e.destroy()}))}}),this.sink=async e=>{let t,r,n=()=>{let t=yw(e);if(null!=t.return){let e=t.return();(function(e){return null!=e&&"function"==typeof e.then})(e)&&e.catch((e=>{this.log?.("could not cause sink source to return",e)}))}};try{let r=new Ow(e);try{this.closeController.signal.addEventListener("abort",n);for await(let e of r.emitFrames())await this.handleFrame(e.header,e.readData)}finally{this.closeController.signal.removeEventListener("abort",n)}t=Ew.NormalTermination}catch(e){let n=e.code;Tw.has(n)?(this.log?.error("protocol error in sink",e),t=Ew.ProtocolError):(this.log?.error("internal error in sink",e),t=Ew.InternalError),r=e}this.log?.trace("muxer sink ended"),null!=r?this.abort(r,t):await this.close({reason:t})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch((e=>this.log?.error("keepalive error: %s",e))),this.ping().catch((e=>this.log?.error("ping error: %s",e)))}get streams(){return Array.from(this._streams.values())}newStream(e){if(void 0!==this.remoteGoAway)throw new U("muxer closed remotely",xw);if(void 0!==this.localGoAway)throw new U("muxer closed locally",Dw);let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new U("max outbound streams exceeded","ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED");this.log?.trace("new outgoing stream id=%s",t);let r=this._newStream(t,e,Fw.Init,"outbound");return this._streams.set(t,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(void 0!==this.remoteGoAway)throw new U("muxer closed remotely",xw);if(void 0!==this.localGoAway)throw new U("muxer closed locally",Dw);if(void 0===this.activePing){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise(((t,r)=>{let n=()=>{r(new U("muxer closed locally",Dw))};this.closeController.signal.addEventListener("abort",n,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",n),t()}})),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let r=Date.now();this.rtt=r-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??Ew.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),null==e.signal){let t=AbortSignal.timeout(500);e={...e,signal:t}}try{await Promise.all([...this._streams.values()].map((async t=>t.close(e)))),this.sendGoAway(t),this._closeMuxer()}catch(e){this.abort(e)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Ew.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let t of this._streams.values())t.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,r,n){if(null!=this._streams.get(e))throw new U("Stream already exists",Aw,{id:e});let i=new Vw({id:e.toString(),name:t,state:r,direction:n,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${n}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2==0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise(((e,t)=>{this.closeController.signal.addEventListener("abort",t,{once:!0})}));for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise((e=>{t=setTimeout(e,this.config.keepAliveInterval)}))]),this.ping().catch((e=>this.log?.error("ping error: %s",e)))}catch{return void clearInterval(t)}}}async handleFrame(e,t){let{streamID:r,type:n,length:i}=e;if(this.log?.trace("received frame %o",e),0===r)switch(n){case ww.Ping:return void this.handlePing(e);case ww.GoAway:return void this.handleGoAway(i);default:throw new U("Invalid frame type",vw,{header:e})}else switch(e.type){case ww.Data:case ww.WindowUpdate:return void await this.handleStreamMessage(e,t);default:throw new U("Invalid frame type",vw,{header:e})}}handlePing(e){if(e.flag===bw.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,bw.ACK);else{if(e.flag!==bw.ACK)throw new U("Invalid frame flag",vw,{header:e});this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length)}}handlePingResponse(e){if(void 0===this.activePing)throw new U("ping not requested",Sw);if(this.activePing.id!==e)throw new U("ping doesn't match our id",Rw);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Ew[e]??"unknown"),this.remoteGoAway=e;for(let e of this._streams.values())e.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:r,flag:n,type:i}=e;(n&bw.SYN)===bw.SYN&&this.incomingStream(r);let s=this._streams.get(r);if(void 0!==s)switch(i){case ww.WindowUpdate:return void s.handleWindowUpdate(e);case ww.Data:if(void 0===t)throw new Error("unreachable");return void await s.handleData(e,t);default:throw new Error("unreachable")}else if(i===ww.Data){if(this.log?.("discarding data for stream id=%s",r),void 0===t)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",r)}incomingStream(e){if(this.client!==(e%2==0))throw new U("both endpoints are clients",Iw);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),void 0!==this.localGoAway)return void this.sendFrame({type:ww.WindowUpdate,flag:bw.RST,streamID:e,length:0});if(this.numInboundStreams>=this.config.maxInboundStreams)return this.log?.("maxIncomingStreams exceeded, forcing stream reset"),void this.sendFrame({type:ww.WindowUpdate,flag:bw.RST,streamID:e,length:0});let t=this._newStream(e,void 0,Fw.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===ww.Data){if(void 0===t)throw new U("invalid frame",vw);this.source.push(new xe(Bw(e),t))}else this.source.push(Bw(e))}sendPing(e,t=bw.SYN){t===bw.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:ww.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Ew.NormalTermination){this.log?.("sending GoAway reason=%s",Ew[e]),this.localGoAway=e,this.sendFrame({type:ww.GoAway,flag:0,streamID:0,length:e})}};function zw(e={}){return t=>new Hw(t,e)}var Ww,jw=globalThis.CustomEvent??Event;async function*Gw(e,t={}){let r=t.concurrency??1/0;r<1&&(r=1/0);let n,i=null!=t.ordered&&t.ordered,s=new EventTarget,o=[],a=Q(),l=Q(),c=!1,u=!1;function h(){return i?o[0]?.done:!!o.find((e=>e.done))}function*d(){for(;o.length>0&&o[0].done;){let e=o[0];if(o.shift(),!e.ok)throw u=!0,a.resolve(),e.err;yield e.value,a.resolve()}}function*f(){for(;h();)for(let e=0;e<o.length;e++)if(o[e].done){let t=o[e];if(o.splice(e,1),e--,!t.ok)throw u=!0,a.resolve(),t.err;yield t.value,a.resolve()}}for(s.addEventListener("task-complete",(()=>{l.resolve()})),Promise.resolve().then((async()=>{try{for await(let t of e){if(o.length===r&&(a=Q(),await a.promise),u)break;let e={done:!1};o.push(e),t().then((t=>{e.done=!0,e.ok=!0,e.value=t,s.dispatchEvent(new jw("task-complete"))}),(t=>{e.done=!0,e.err=t,s.dispatchEvent(new jw("task-complete"))}))}c=!0,s.dispatchEvent(new jw("task-complete"))}catch(e){n=e,s.dispatchEvent(new jw("task-complete"))}}));;){if(h()||(l=Q(),await l.promise),null!=n)throw n;if(i?yield*d():yield*f(),c&&0===o.length)break}}!function(e){let t;var r;let n,i,s,o,a,l,c;(r=t=e.MessageType||(e.MessageType={})).DIAL="DIAL",r.DIAL_RESPONSE="DIAL_RESPONSE",function(e){e[e.DIAL=0]="DIAL",e[e.DIAL_RESPONSE=1]="DIAL_RESPONSE"}(n||(n={})),function(e){e.codec=()=>wn(n)}(t=e.MessageType||(e.MessageType={})),function(e){e.OK="OK",e.E_DIAL_ERROR="E_DIAL_ERROR",e.E_DIAL_REFUSED="E_DIAL_REFUSED",e.E_BAD_REQUEST="E_BAD_REQUEST",e.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(i=e.ResponseStatus||(e.ResponseStatus={})),function(e){e[e.OK=0]="OK",e[e.E_DIAL_ERROR=100]="E_DIAL_ERROR",e[e.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",e[e.E_BAD_REQUEST=200]="E_BAD_REQUEST",e[e.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"}(s||(s={})),function(e){e.codec=()=>wn(s)}(i=e.ResponseStatus||(e.ResponseStatus={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.id&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(let r of e.addrs)t.uint32(18),t.bytes(r);!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={addrs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=e.bytes();break;case 2:r.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(o=e.PeerInfo||(e.PeerInfo={})),function(t){let r;t.codec=()=>(null==r&&(r=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.peer&&(r.uint32(10),e.PeerInfo.codec().encode(t.peer,r)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();r>>>3==1?n.peer=e.PeerInfo.codec().decode(t,t.uint32()):t.skipType(7&r)}return n}))),r),t.encode=e=>mn(e,t.codec()),t.decode=e=>mt(e,t.codec())}(a=e.Dial||(e.Dial={})),function(t){let r;t.codec=()=>(null==r&&(r=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.status&&(r.uint32(8),e.ResponseStatus.codec().encode(t.status,r)),null!=t.statusText&&(r.uint32(18),r.string(t.statusText)),null!=t.addr&&(r.uint32(26),r.bytes(t.addr)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.status=e.ResponseStatus.codec().decode(t);break;case 2:n.statusText=t.string();break;case 3:n.addr=t.bytes();break;default:t.skipType(7&r)}}return n}))),r),t.encode=e=>mn(e,t.codec()),t.decode=e=>mt(e,t.codec())}(l=e.DialResponse||(e.DialResponse={})),e.codec=()=>(null==c&&(c=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.type&&(r.uint32(8),e.MessageType.codec().encode(t.type,r)),null!=t.dial&&(r.uint32(18),e.Dial.codec().encode(t.dial,r)),null!=t.dialResponse&&(r.uint32(26),e.DialResponse.codec().encode(t.dialResponse,r)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.type=e.MessageType.codec().decode(t);break;case 2:n.dial=e.Dial.codec().decode(t,t.uint32());break;case 3:n.dialResponse=e.DialResponse.codec().decode(t,t.uint32());break;default:t.skipType(7&r)}}return n}))),c),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(Ww||(Ww={}));var Yw=class{components;startupDelay;refreshInterval;protocol;timeout;maxInboundStreams;maxOutboundStreams;verifyAddressTimeout;started;log;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:autonat"),this.started=!1,this.protocol=`/${t.protocolPrefix??"libp2p"}/autonat/1.0.0`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.startupDelay=t.startupDelay??5e3,this.refreshInterval=t.refreshInterval??6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}[Symbol.toStringTag]="@libp2p/autonat";isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,(e=>{this.handleIncomingAutonatStream(e).catch((e=>{this.log.error("error handling incoming autonat stream",e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(e){let t=AbortSignal.timeout(this.timeout),r=()=>{e.stream.abort(new U("handleIncomingAutonatStream timeout",$))};t.addEventListener("abort",r,{once:!0});try{let r=this;await We(e.stream,(e=>Ve(e)),(async function*(n){let i,s=await hm(n);if(null==s)return r.log("no message received"),void(yield Ww.encode({type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}}));try{i=Ww.decode(s)}catch(e){return r.log.error("could not decode message",e),void(yield Ww.encode({type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}}))}yield Ww.encode(await r.handleAutonatMessage(i,e.connection,{signal:t}))}),(e=>Le(e)),e.stream)}catch(e){this.log.error("error handling incoming autonat stream",e)}finally{t.removeEventListener("abort",r)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch((e=>{this.log.error("error verifying external address",e)}))}async handleAutonatMessage(e,t,r){let n=this.components.addressManager.getAddresses().map((e=>e.toOptions().host)),i=e.dial;if(null==i)return this.log.error("dial was missing from message"),{type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let s,o=i.peer;if(null==o?.id)return this.log.error("PeerId missing from message"),{type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{s=Yn(o.id)}catch(e){return this.log.error("invalid PeerId",e),{type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",s),!t.remotePeer.equals(s))return this.log("target peer %p did not equal sending peer %p",s,t.remotePeer),{type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};let a=o.addrs.map((e=>Hp(e))).filter((e=>{let r=e.toOptions().host===t.remoteAddr.toOptions().host;return this.log.trace("request to dial %a was sent from %a is same host %s",e,t.remoteAddr,r),r})).filter((e=>{let t=e.toOptions().host,r=!pp(t);return this.log.trace("host %s was public %s",t,r),r})).filter((e=>{let t=e.toOptions().host,r=!n.includes(t);return this.log.trace("host %s was not our host %s",t,r),r})).filter((e=>{let t=!!this.components.transportManager.dialTransportForMultiaddr(e);return this.log.trace("transport for %a is supported %s",e,t),t})).map((e=>(null==e.getPeerId()&&(e=e.encapsulate(`/p2p/${s.toString()}`)),e)));if(0===a.length)return this.log("no valid multiaddrs for %p in message",s),{type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",a.map((e=>e.toString())).join(", "),s);let l="",c=a[0];for await(let e of a){let t;c=e;try{if(t=await this.components.connectionManager.openConnection(e,r),!t.remoteAddr.equals(e))throw this.log.error("tried to dial %a but dialed %a",e,t.remoteAddr),new Error("Unexpected remote address");return this.log("Success %p",s),{type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.OK,addr:t.remoteAddr.decapsulateCode(vp("p2p").code).bytes}}}catch(e){this.log("could not dial %p",s,e),l=e.message}finally{null!=t&&await t.close()}}return{type:Ww.MessageType.DIAL_RESPONSE,dialResponse:{status:Ww.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:c.bytes}}}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;let e=this.components.addressManager,t=e.getObservedAddrs().filter((e=>!pp(e.toOptions().host)));if(0===t.length)return this.log("no public addresses found, not requesting verification"),void(this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval));let r=AbortSignal.timeout(this.timeout),n=this;try{this.log("verify multiaddrs %s",t.map((e=>e.toString())).join(", "));let i=Ww.encode({type:Ww.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:t.map((e=>e.bytes))}}}),s={},o=[],a=async e=>{let t=()=>{};try{this.log("asking %p to verify multiaddr",e.id);let s=await n.components.connectionManager.openConnection(e.id,{signal:r}),a=await s.newStream(this.protocol,{signal:r});t=()=>{a.abort(new U("verifyAddress timeout",$))},r.addEventListener("abort",t,{once:!0});let l=await We([i],(e=>Le(e)),a,(e=>Ve(e)),(async e=>hm(e)));if(null==l)return void this.log("no response received from %p",s.remotePeer);let c=Ww.decode(l);if(c.type!==Ww.MessageType.DIAL_RESPONSE||null==c.dialResponse)return void this.log("invalid autonat response from %p",s.remotePeer);if(c.dialResponse.status===Ww.ResponseStatus.OK){let e,t=s.remoteAddr.toOptions();if(4===t.family)e=t.host.split(".")[0];else{if(6!==t.family)return void this.log('remote address "%s" was not IP4 or IP6?',t.host);e=t.host.split(":")[0]}if(o.includes(e))return void this.log("already have response from network segment %d - %s",e,t.host);o.push(e)}return c.dialResponse}catch(e){this.log.error("error asking remote to verify multiaddr",e)}finally{r.removeEventListener("abort",t)}};for await(let n of Gw(He(this.components.randomWalk.walk({signal:r}),(e=>async()=>a(e))),{concurrency:4}))try{if(null==n)continue;let r=null==n.addr?t[0]:Hp(n.addr);if(this.log("autonat response for %a is %s",r,n.status),n.status===Ww.ResponseStatus.E_BAD_REQUEST||n.status===Ww.ResponseStatus.E_DIAL_REFUSED||null==n.addr&&t.length>1)continue;if(!t.some((e=>e.equals(r)))){this.log("peer reported %a as %s but it was not in our observed address list",r,n.status);continue}let i=r.toString();if(null==s[i]&&(s[i]={success:0,failure:0}),n.status===Ww.ResponseStatus.OK?s[i].success++:n.status===Ww.ResponseStatus.E_DIAL_ERROR&&s[i].failure++,4===s[i].success)return this.log("%a is externally dialable",r),void e.confirmObservedAddr(r);if(4===s[i].failure)return this.log("%a is not externally dialable",r),void e.removeObservedAddr(r)}catch(e){this.log.error("could not verify external address",e)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}};function Qw(e={}){return t=>new Yw(t,e)}var Jw=Tb("dns4"),Zw=Tb("dns6"),Xw=Tb("dnsaddr"),eb=kb(Tb("dns"),Xw,Jw,Zw),tb=kb(Tb("ip4"),Tb("ip6")),rb=kb(Ib(tb,Tb("tcp")),Ib(eb,Tb("tcp"))),nb=Ib(tb,Tb("udp")),ib=Ib(nb,Tb("utp")),sb=Ib(nb,Tb("quic")),ob=Ib(nb,Tb("quic-v1")),ab=kb(Ib(rb,Tb("ws")),Ib(eb,Tb("ws"))),lb=kb(Ib(ab,Tb("p2p")),ab),cb=kb(Ib(rb,Tb("wss")),Ib(eb,Tb("wss")),Ib(rb,Tb("tls"),Tb("ws")),Ib(eb,Tb("tls"),Tb("ws"))),ub=kb(Ib(cb,Tb("p2p")),cb),hb=kb(Ib(rb,Tb("http")),Ib(tb,Tb("http")),Ib(eb,Tb("http"))),db=kb(Ib(rb,Tb("https")),Ib(tb,Tb("https")),Ib(eb,Tb("https"))),fb=Ib(nb,Tb("webrtc-direct"),Tb("certhash")),pb=kb(Ib(fb,Tb("p2p")),fb),gb=Ib(ob,Tb("webtransport"),Tb("certhash"),Tb("certhash")),mb=kb(Ib(gb,Tb("p2p")),gb),yb=kb(Ib(lb,Tb("p2p-webrtc-star"),Tb("p2p")),Ib(ub,Tb("p2p-webrtc-star"),Tb("p2p")),Ib(lb,Tb("p2p-webrtc-star")),Ib(ub,Tb("p2p-webrtc-star"))),wb=(kb(Ib(lb,Tb("p2p-websocket-star"),Tb("p2p")),Ib(ub,Tb("p2p-websocket-star"),Tb("p2p")),Ib(lb,Tb("p2p-websocket-star")),Ib(ub,Tb("p2p-websocket-star"))),kb(Ib(hb,Tb("p2p-webrtc-direct"),Tb("p2p")),Ib(db,Tb("p2p-webrtc-direct"),Tb("p2p")),Ib(hb,Tb("p2p-webrtc-direct")),Ib(db,Tb("p2p-webrtc-direct")))),bb=kb(ab,cb,hb,db,yb,wb,rb,ib,sb,eb,pb,mb),Eb=(kb(Ib(bb,Tb("p2p-stardust"),Tb("p2p")),Ib(bb,Tb("p2p-stardust"))),kb(Ib(bb,Tb("p2p")),yb,wb,pb,mb,Tb("p2p"))),vb=kb(Ib(Eb,Tb("p2p-circuit"),Eb),Ib(Eb,Tb("p2p-circuit")),Ib(Tb("p2p-circuit"),Eb),Ib(bb,Tb("p2p-circuit")),Ib(Tb("p2p-circuit"),bb),Tb("p2p-circuit")),Sb=()=>kb(Ib(vb,Sb),vb),Rb=Sb(),Ab=kb(Ib(Rb,Eb,Rb),Ib(Eb,Rb),Ib(Rb,Eb),Rb,Eb);function _b(e){return function(t){let r;try{r=Hp(t)}catch{return!1}let n=e(r.protoNames());return null!==n&&(!0===n||!1===n?n:0===n.length)}}function Ib(...e){function t(t){if(t.length<e.length)return null;let r=t;return e.some((e=>(r="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(r)&&(t=r),null===r))),r}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:_b(t),partialMatch:t}}function kb(...e){function t(t){let r=null;return e.some((e=>{let n="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=n&&(r=n,!0)})),r}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:_b(t),partialMatch:t}}function Tb(e){let t=e;return{toString:function(){return t},matches:function(e){let r;try{r=Hp(e)}catch{return!1}let n=r.protoNames();return 1===n.length&&n[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}kb(Ib(Rb,Tb("webrtc"),Tb("p2p")),Ib(Rb,Tb("webrtc")),Ib(bb,Tb("webrtc"),Tb("p2p")),Ib(bb,Tb("webrtc")),Tb("webrtc"));var Cb=class extends K{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(null==t.list||0===t.list.length)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??1e3,this.list=[];for(let e of t.list){if(!Ab.matches(e)){this.log.error("Invalid multiaddr");continue}let t=Hp(e),r=t.getPeerId();if(null==r){this.log.error("Invalid bootstrap multiaddr without peer id");continue}let n={id:Gn(r),multiaddrs:[t]};this.list.push(n)}this._init=t}[D]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[j]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout((()=>{this._discoverBootstrapPeers().catch((e=>{this.log.error(e)}))}),this.timeout))}async _discoverBootstrapPeers(){if(null!=this.timer)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??"bootstrap"]:{value:this._init.tagValue??50,ttl:this._init.tagTTL??12e4}}}),null==this.timer)return;this.safeDispatchEvent("peer",{detail:e})}}stop(){null!=this.timer&&clearTimeout(this.timer),this.timer=void 0}};function Db(e){return t=>new Cb(t,e)}var xb;!function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.publicKey=e.bytes();break;case 2:r.payloadType=e.bytes();break;case 3:r.payload=e.bytes();break;case 5:r.signature=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(xb||(xb={}));var Nb,Pb=class e{static createFromProtobuf=async t=>{let r=xb.decode(t),n=await Qn(r.publicKey);return new e({peerId:n,payloadType:r.payloadType,payload:r.payload,signature:r.signature})};static seal=async(t,r)=>{if(null==r.privateKey)throw new Error("Missing private key");let n=t.domain,i=t.codec,s=t.marshal(),o=Lb(n,i,s),a=await(await tu(r.privateKey)).sign(o.subarray());return new e({peerId:r,payloadType:i,payload:s,signature:a})};static openAndCertify=async(t,r)=>{let n=await e.createFromProtobuf(t);if(!await n.validate(r))throw new U("envelope signature is not valid for the given domain","ERR_SIGNATURE_NOT_VALID");return n};peerId;payloadType;payload;signature;marshaled;constructor(e){let{peerId:t,payloadType:r,payload:n,signature:i}=e;this.peerId=t,this.payloadType=r,this.payload=n,this.signature=i}marshal(){if(null==this.peerId.publicKey)throw new Error("Missing public key");return null==this.marshaled&&(this.marshaled=xb.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return ke(this.marshal(),e.marshal())}async validate(e){let t=Lb(e,this.payloadType,this.payload);if(null==this.peerId.publicKey)throw new Error("Missing public key");return Xc(this.peerId.publicKey).verify(t.subarray(),this.signature)}},Lb=(e,t,r)=>{let n=en(e),i=Ae(n.byteLength),s=Ae(t.length),o=Ae(r.length);return new xe(i,n,s,t,o,r)},Ob=Uint8Array.from([3,1]);!function(e){let t,r;!function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={multiaddr:new Uint8Array(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();t>>>3==1?r.multiaddr=e.bytes():e.skipType(7&t)}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(t=e.AddressInfo||(e.AddressInfo={})),e.codec=()=>(null==r&&(r=bn(((t,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(r.uint32(10),r.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(r.uint32(16),r.uint64(t.seq)),null!=t.addresses)for(let n of t.addresses)r.uint32(26),e.AddressInfo.codec().encode(n,r);!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.peerId=t.bytes();break;case 2:n.seq=t.uint64();break;case 3:n.addresses.push(e.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(7&r)}}return n}))),r),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(Nb||(Nb={}));var Bb=class e{static createFromProtobuf=t=>{let r=Nb.decode(t),n=Yn(r.peerId),i=(r.addresses??[]).map((e=>Hp(e.multiaddr))),s=r.seq;return new e({peerId:n,multiaddrs:i,seqNumber:s})};static DOMAIN="libp2p-peer-record";static CODEC=Ob;peerId;multiaddrs;seqNumber;domain=e.DOMAIN;codec=e.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:r,seqNumber:n}=e;this.peerId=t,this.multiaddrs=r??[],this.seqNumber=n??BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=Nb.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map((e=>({multiaddr:e.bytes})))})),this.marshaled}equals(t){return!!(t instanceof e&&this.peerId.equals(t.peerId)&&this.seqNumber===t.seqNumber&&function(e,t){let r=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(r),e.sort(r).every(((e,r)=>t[r].equals(e))))}(this.multiaddrs,t.multiaddrs))}};function Mb(e,t){let r=cy(e,t),n={read:async(e,t)=>{let n=await r.read(t);return e.decode(n)},write:async(e,t,n)=>{await r.write(t.encode(e),n)},writeV:async(e,t,n)=>{await r.writeV(e.map((e=>t.encode(e))),n)},pb:e=>({read:async t=>n.read(e,t),write:async(t,r)=>n.write(t,e,r),writeV:async(t,r)=>n.writeV(t,e,r),unwrap:()=>n}),unwrap:()=>r.unwrap()};return n}var Ub,Fb,$b,Vb,Kb,Hb,qb,zb,Wb="circuit-relay-relay",jb=(BigInt(131072),"/libp2p/circuit/relay/0.2.0/hop"),Gb="/libp2p/circuit/relay/0.2.0/stop",Yb="ERR_RELAYED_DIAL";function Qb(e){let t=e*BigInt(1e3),r=(new Date).getTime();return Number(t-BigInt(r))}function Jb(e){let{stream:t,remoteAddr:r,logger:n}=e,i=n.forComponent("libp2p:stream:converter"),s=!1,o=!1,a=t.close.bind(t);t.close=async e=>{await a(e),h(!0)};let l=t.abort.bind(t);t.abort=e=>{l(e),h(!0)};let c=t.sink.bind(t);t.sink=async e=>{try{await c(e)}catch(e){"aborted"!==e.type&&i.error("%s error in sink",r,e)}finally{o=!0,h()}};let u={log:i,sink:t.sink,source:async function*(){try{for await(let e of t.source)e instanceof Uint8Array?yield e:yield*e}finally{s=!0,h()}}(),remoteAddr:r,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function h(e){!0===e&&(s=!0,o=!0),s&&o&&null==u.timeline.close&&(u.timeline.close=Date.now())}return u}!function(e){let t;var r;let n,i;(r=t=e.Type||(e.Type={})).RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS",function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(n||(n={})),function(e){e.codec=()=>wn(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==i&&(i=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.type&&(r.uint32(8),e.Type.codec().encode(t.type,r)),null!=t.peer&&(r.uint32(18),$b.codec().encode(t.peer,r)),null!=t.reservation&&(r.uint32(26),Vb.codec().encode(t.reservation,r)),null!=t.limit&&(r.uint32(34),Kb.codec().encode(t.limit,r)),null!=t.status&&(r.uint32(40),Hb.codec().encode(t.status,r)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r,n={})=>{let i={},s=null==r?t.len:t.pos+r;for(;t.pos<s;){let r=t.uint32();switch(r>>>3){case 1:i.type=e.Type.codec().decode(t);break;case 2:i.peer=$b.codec().decode(t,t.uint32(),{limits:n.limits?.peer});break;case 3:i.reservation=Vb.codec().decode(t,t.uint32(),{limits:n.limits?.reservation});break;case 4:i.limit=Kb.codec().decode(t,t.uint32(),{limits:n.limits?.limit});break;case 5:i.status=Hb.codec().decode(t);break;default:t.skipType(7&r)}}return i}))),i),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(Ub||(Ub={})),function(e){let t;var r;let n,i;(r=t=e.Type||(e.Type={})).CONNECT="CONNECT",r.STATUS="STATUS",function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(n||(n={})),function(e){e.codec=()=>wn(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==i&&(i=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.type&&(r.uint32(8),e.Type.codec().encode(t.type,r)),null!=t.peer&&(r.uint32(18),$b.codec().encode(t.peer,r)),null!=t.limit&&(r.uint32(26),Kb.codec().encode(t.limit,r)),null!=t.status&&(r.uint32(32),Hb.codec().encode(t.status,r)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r,n={})=>{let i={},s=null==r?t.len:t.pos+r;for(;t.pos<s;){let r=t.uint32();switch(r>>>3){case 1:i.type=e.Type.codec().decode(t);break;case 2:i.peer=$b.codec().decode(t,t.uint32(),{limits:n.limits?.peer});break;case 3:i.limit=Kb.codec().decode(t,t.uint32(),{limits:n.limits?.limit});break;case 4:i.status=Hb.codec().decode(t);break;default:t.skipType(7&r)}}return i}))),i),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(Fb||(Fb={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(let r of e.addrs)t.uint32(18),t.bytes(r);!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={id:ue(0),addrs:[]},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:if(null!=r.limits?.addrs&&n.addrs.length===r.limits.addrs)throw new Cn('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");n.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}($b||($b={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.expire&&0n!==e.expire&&(t.uint32(8),t.uint64(e.expire)),null!=e.addrs)for(let r of e.addrs)t.uint32(18),t.bytes(r);null!=e.voucher&&(t.uint32(26),t.bytes(e.voucher)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={expire:0n,addrs:[]},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.expire=e.uint64();break;case 2:if(null!=r.limits?.addrs&&n.addrs.length===r.limits.addrs)throw new Cn('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");n.addrs.push(e.bytes());break;case 3:n.voucher=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(Vb||(Vb={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.duration&&(t.uint32(8),t.uint32(e.duration)),null!=e.data&&(t.uint32(16),t.uint64(e.data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.duration=e.uint32();break;case 2:n.data=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(Kb||(Kb={})),function(e){e.UNUSED="UNUSED",e.OK="OK",e.RESERVATION_REFUSED="RESERVATION_REFUSED",e.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONNECTION_FAILED="CONNECTION_FAILED",e.NO_RESERVATION="NO_RESERVATION",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE",e.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"}(Hb||(Hb={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.OK=100]="OK",e[e.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",e[e.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",e[e.PERMISSION_DENIED=202]="PERMISSION_DENIED",e[e.CONNECTION_FAILED=203]="CONNECTION_FAILED",e[e.NO_RESERVATION=204]="NO_RESERVATION",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",e[e.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"}(qb||(qb={})),function(e){e.codec=()=>wn(qb)}(Hb||(Hb={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.relay&&e.relay.byteLength>0&&(t.uint32(10),t.bytes(e.relay)),null!=e.peer&&e.peer.byteLength>0&&(t.uint32(18),t.bytes(e.peer)),null!=e.expiration&&0n!==e.expiration&&(t.uint32(24),t.uint64(e.expiration)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={relay:ue(0),peer:ue(0),expiration:0n},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.relay=e.bytes();break;case 2:n.peer=e.bytes();break;case 3:n.expiration=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(zb||(zb={}));var Zb=class extends K{peerStore;registrar;connectionManager;randomWalk;started;running;topologyId;log;discoveryController;filter;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(jb,{filter:this.filter,onConnect:e=>{this.log("discovered relay %p",e),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then((async()=>{this.log("searching peer store for relays");let e=await this.peerStore.all({filters:[e=>e.protocols.includes(jb)],orders:[()=>Math.random()<.5?1:-1]});for(let t of e)this.log.trace("found relay peer %p in peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});this.log("found %d relay peers in peer store",e.length);let t=new le({concurrency:5});this.log("start random walk");for await(let e of this.randomWalk.walk({signal:this.discoveryController.signal}))this.log.trace("found random peer %p",e.id),t.has(e.id)?this.log.trace("random peer %p was already in queue",e.id):this.connectionManager.getConnections(e.id)?.length>0?this.log.trace("random peer %p was already connected",e.id):await this.connectionManager.isDialable(e.multiaddrs)?(this.log.trace("wait for space in queue for %p",e.id),await ie(t.onSizeLessThan(10),this.discoveryController.signal),this.log("adding random peer %p to dial queue (length: %d)",e.id,t.size),t.add((async()=>{let t=Y([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(e.id,{signal:t})}finally{t.clear()}}),{peerId:e.id,signal:this.discoveryController.signal}).catch((t=>{this.log.error("error opening connection to random peer %p",e.id,t)}))):this.log.trace("random peer %p was not dialable",e.id,e.multiaddrs.map((e=>e.toString())));await t.onIdle()})).catch((e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)})))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}},Xb=class extends K{connectionManager;relayStore;listeningAddrs;log;constructor(e){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Zn,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}_onRemoveRelayPeer=e=>{this.#e(e.detail)};async listen(e){this.log("listen on %a",e);let t=e.decapsulate("/p2p-circuit"),r=await this.connectionManager.openConnection(t);if(!this.relayStore.hasReservation(r.remotePeer))return this.log("making reservation on peer %p",r.remotePeer),void await this.relayStore.addRelay(r.remotePeer,"configured");let n=this.relayStore.getReservation(r.remotePeer);if(null==n)throw new U("Did not have reservation after making reservation","ERR_NO_RESERVATION");this.listeningAddrs.has(r.remotePeer)?this.log("already listening on relay %p",r.remotePeer):(this.listeningAddrs.set(r.remotePeer,n.addrs.map((e=>Hp(e).encapsulate("/p2p-circuit")))),this.safeDispatchEvent("listening",{}))}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}#e(e){let t=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}},eE=class extends K{peerId;connectionManager;transportManager;peerStore;events;reserveQueue;reservations;maxDiscoveredRelays;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Zn,this.maxDiscoveredRelays=t?.discoverRelays??0,this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??1e3,this.started=!1,this.relayFilter=function(e,t=.005){let r=function(e,t=.005){let r=Math.round(-1*e*Math.log(t)/uu);return{bits:r,hashes:Math.round(r/e*Math.LN2)}}(e,t);return new hu(r)}(100),this.reserveQueue=new le({concurrency:t?.reservationConcurrency??1,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("peer:disconnect",(e=>{this.#t(e.detail)}))}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))}stop(){this.reserveQueue.clear(),this.reservations.forEach((({timeout:e})=>{clearTimeout(e)})),this.reservations.clear(),this.started=!1}async addRelay(e,t){this.peerId.equals(e)?this.log("not trying to use self as relay"):this.reserveQueue.size>this.maxReservationQueueLength?this.log("not adding potential relay peer %p as the queue is full",e):this.reserveQueue.has(e)?this.log("potential relay peer %p is already in the reservation queue",e):this.relayFilter.has(e.toBytes())?this.log("potential relay peer %p has failed previously, not trying again",e):(this.log("try to reserve relay slot with %p",e),await this.reserveQueue.add((async()=>{let r=Date.now();try{let r=this.reservations.get(e);if(null!=r){if(Qb(r.reservation.expire)>6e5)return void this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);clearTimeout(r.timeout),this.reservations.delete(e)}if("discovered"===t&&[...this.reservations.values()].reduce(((e,t)=>("discovered"===t.type&&e++,e)),0)>=this.maxDiscoveredRelays)return void this.log("already have enough discovered relays");let n=AbortSignal.timeout(this.reservationCompletionTimeout),i=await this.connectionManager.openConnection(e,{signal:n});if(i.remoteAddr.protoNames().includes("p2p-circuit"))return void this.log("not creating reservation over relayed connection");let s=await this.#e(i,{signal:n});this.log("created reservation on relay peer %p",e);let o=Qb(s.expire),a=Math.min(Math.max(o-3e5,3e4),Math.pow(2,31)-1),l=setTimeout((()=>{this.addRelay(e,t).catch((t=>{this.log.error("could not refresh reservation to relay %p",e,t)}))}),a);this.reservations.set(e,{timeout:l,reservation:s,type:t}),await this.peerStore.merge(e,{tags:{[Wb]:{value:1,ttl:o}}}),await this.transportManager.listen([Hp(`/p2p/${e.toString()}/p2p-circuit`)]),this.safeDispatchEvent("relay:created-reservation",{detail:e})}catch(t){this.log.error("could not reserve slot on %p after %dms",e,Date.now()-r,t);let n=this.reservations.get(e);null!=n&&clearTimeout(n.timeout),this.reservations.delete(e),this.relayFilter.add(e.toBytes())}}),{peerId:e}))}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(){return this.reservations.size}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let r,n=await e.newStream(jb,t),i=Mb(n).pb(Ub);await i.write({type:Ub.Type.RESERVE},t);try{r=await i.read(t)}catch(e){throw n.abort(e),e}finally{"closed"!==n.status&&await n.close(t)}if(r.status===Hb.OK&&null!=r.reservation){let t=!1,n=e.remoteAddr.bytes;for(let e of r.reservation.addrs)if(ke(n,e)){t=!0;break}return t||r.reservation.addrs.push(n),r.reservation}let s=`reservation failed with status ${r.status??"undefined"}`;throw this.log.error(s),new Error(s)}#t(e){let t=this.reservations.get(e);null!=t&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}},tE=class{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;stopTimeout;started;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??300,this.maxOutboundStopStreams=t.maxOutboundStopStreams??300,this.stopTimeout=t.stopTimeout??3e4;let r=t.discoverRelays??0;r>0&&(this.discovery=new Zb(e,{filter:t.discoveryFilter??Iu(4096,.001)}),this.discovery.addEventListener("relay:discover",(e=>{this.reservationStore.addRelay(e.detail,"discovered").catch((t=>{this.log.error("could not add discovered relay %p",e.detail,t)}))}))),this.reservationStore=new eE(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",(()=>{this.discovery?.startDiscovery()})),this.reservationStore.addEventListener("relay:created-reservation",(()=>{this.reservationStore.reservationCount()>=r&&this.discovery?.stopDiscovery()})),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[j]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[G](){return null!=this.discovery?["@libp2p/identify"]:[]}[B]=!0;isStarted(){return this.started}async start(){await this.registrar.handle(Gb,(e=>{this.onStop(e).catch((t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)}))}),{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),await z(this.discovery,this.reservationStore),this.started=!0}async stop(){await W(this.discovery,this.reservationStore),await this.registrar.unhandle(Gb),this.started=!1}async dial(e,t){if(1!==e.protoCodes().filter((e=>290===e)).length){let t="Invalid circuit relay address";throw this.log.error(t,e),new U(t,Yb)}let r=e.toString().split("/p2p-circuit"),n=Hp(r[0]),i=Hp(r[r.length-1]),s=n.getPeerId(),o=i.getPeerId();if(null==s||null==o){let t=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw this.log.error(t),new U(t,Yb)}let a,l=Gn(s),c=Gn(o),u=!1,h=this.connectionManager.getConnections(l)[0];null==h?(await this.peerStore.merge(l,{multiaddrs:[n]}),t.onProgress?.(new Xe("circuit-relay:open-connection")),h=await this.connectionManager.openConnection(l,t),u=!0):t.onProgress?.(new Xe("circuit-relay:reuse-connection"));try{return t.onProgress?.(new Xe("circuit-relay:open-hop-stream")),a=await h.newStream(jb),await this.connectV2({stream:a,connection:h,destinationPeer:c,destinationAddr:i,relayAddr:n,ma:e,disconnectOnFailure:u,onProgress:t.onProgress})}catch(e){throw this.log.error("circuit relay dial to destination %p via relay %p failed",c,l,e),a?.abort(e),u&&await h.close(),e}}async connectV2({stream:e,connection:t,destinationPeer:r,destinationAddr:n,relayAddr:i,ma:s,disconnectOnFailure:o,onProgress:a}){try{let t=Mb(e),o=t.pb(Ub);a?.(new Xe("circuit-relay:write-connect-message")),await o.write({type:Ub.Type.CONNECT,peer:{id:r.toBytes(),addrs:[Hp(n).bytes]}}),a?.(new Xe("circuit-relay:read-connect-response"));let l=await o.read();if(l.status!==Hb.OK)throw new U(`failed to connect via relay with status ${l?.status?.toString()??"undefined"}`,"ERR_HOP_REQUEST_FAILED");let c=Jb({stream:t.unwrap(),remoteAddr:s,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger});return this.log("new outbound relayed connection %a",c.remoteAddr),await this.upgrader.upgradeOutbound(c,{transient:null!=l.limit,onProgress:a})}catch(e){throw this.log.error(`Circuit relay dial to destination ${r.toString()} via relay ${t.remotePeer.toString()} failed`,e),o&&await t.close(),e}}createListener(e){return function(e){return new Xb(e)}({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}listenFilter(e){return(e=Array.isArray(e)?e:[e]).filter((e=>Rb.matches(e)))}dialFilter(e){return this.listenFilter(e)}async onStop({connection:e,stream:t}){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(e){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",e)}let r=AbortSignal.timeout(this.stopTimeout),n=Mb(t).pb(Fb),i=await n.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),void 0===i?.type)return this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await n.write({type:Fb.Type.STATUS,status:Hb.MALFORMED_MESSAGE},{signal:r}),void await t.close();if(i.type!==Fb.Type.CONNECT)return this.log.error("invalid stop connect request via peer %p",e.remotePeer),await n.write({type:Fb.Type.STATUS,status:Hb.UNEXPECTED_MESSAGE},{signal:r}),void await t.close();if(!(e=>{if(null==e.peer)return!1;try{e.peer.addrs.forEach(Hp)}catch{return!1}return!0})(i))return this.log.error("invalid stop connect request via peer %p",e.remotePeer),await n.write({type:Fb.Type.STATUS,status:Hb.MALFORMED_MESSAGE},{signal:r}),void await t.close();let s=Yn(i.peer.id);if(!0===await(this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,s)))return this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await n.write({type:Fb.Type.STATUS,status:Hb.PERMISSION_DENIED},{signal:r}),void await t.close();this.log.trace("sending success response to %p",e.remotePeer),await n.write({type:Fb.Type.STATUS,status:Hb.OK},{signal:r});let o=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${s.toString()}`),a=this.addressManager.getAddresses()[0],l=Jb({stream:n.unwrap().unwrap(),remoteAddr:o,localAddr:a,logger:this.logger});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:null!=i.limit}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}};function rE(e={}){return t=>new tE(t,e)}var nE,iE=()=>{let e=new Error("Delay aborted");return e.name="AbortError",e},sE=new WeakMap,oE=function({clearTimeout:e,setTimeout:t}={}){return(r,{value:n,signal:i}={})=>{if(i?.aborted)return Promise.reject(iE());let s,o,a,l=e??clearTimeout,c=()=>{l(s),a(iE())},u=new Promise(((e,l)=>{o=()=>{i&&i.removeEventListener("abort",c),e(n)},a=l,s=(t??setTimeout)(o,r)}));return i&&i.addEventListener("abort",c,{once:!0}),sE.set(u,(()=>{l(s),s=null,o()})),u}}(),aE=oE;function lE(e,t){return!Ag.matches(e)&&null!=t.dialTransportForMultiaddr(e)&&(!!ig.matches(e)||!!ug.matches(e)&&!1===pp(e.toOptions().host))}!function(e){let t;var r;let n,i;(r=t=e.Type||(e.Type={})).UNUSED="UNUSED",r.CONNECT="CONNECT",r.SYNC="SYNC",function(e){e[e.UNUSED=0]="UNUSED",e[e.CONNECT=100]="CONNECT",e[e.SYNC=300]="SYNC"}(n||(n={})),function(e){e.codec=()=>wn(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==i&&(i=bn(((t,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=t.type&&(r.uint32(8),e.Type.codec().encode(t.type,r)),null!=t.observedAddresses)for(let e of t.observedAddresses)r.uint32(18),r.bytes(e);!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={observedAddresses:[]},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.type=e.Type.codec().decode(t);break;case 2:n.observedAddresses.push(t.bytes());break;default:t.skipType(7&r)}}return n}))),i),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(nE||(nE={}));var cE,uE=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??5e3,this.retries=t.retries??3,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1}[Symbol.toStringTag]="@libp2p/dcutr";[G]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(hE,{notifyOnTransient:!0,onConnect:(e,t)=>{t.transient&&"inbound"===t.direction&&this.upgradeInbound(t).catch((e=>{this.log.error("error during outgoing DCUtR attempt",e)}))}}),await this.registrar.handle(hE,(e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch((t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(hE),null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let r=0;r<this.retries;r++){let n={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([hE],{signal:n.signal,runOnTransientConnection:!0});let r=Mb(t,{maxDataLength:4096}).pb(nE);this.log("B sending connect to %p",e.remotePeer);let i=Date.now();await r.write({type:nE.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map((e=>e.bytes))},n),this.log("B receiving connect from %p",e.remotePeer);let s=await r.read(n);if(s.type!==nE.Type.CONNECT)throw this.log("A sent wrong message type"),new U("DCUtR message type was incorrect",V);let o=this.getDialableMultiaddrs(s.observedAddresses);if(0===o.length)throw this.log("A did not have any dialable multiaddrs"),new U("DCUtR connect message had no multiaddrs",V);let a=Date.now()-i;this.log("A sending sync, rtt %dms",a),await r.write({type:nE.Type.SYNC,observedAddresses:[]},n),this.log("A waiting for half RTT"),await aE(a/2),this.log("B dialing",o);let l=await this.connectionManager.openConnection(o,{signal:n.signal,priority:100});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,l.remoteAddr),await e.close(n);break}catch(e){if(this.log.error("error while attempting DCUtR on attempt %d of %d",r+1,this.retries,e),t?.abort(e),r===this.retries)throw e}finally{null!=t&&await t.close(n)}}}async attemptUnilateralConnectionUpgrade(e){let t=(await this.peerStore.get(e.remotePeer)).addresses.map((t=>{let r=t.multiaddr;return null==r.getPeerId()?r.encapsulate(`/p2p/${e.remotePeer}`):r})).filter((e=>lE(e,this.transportManager)));if(t.length>0){let r=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",t);let n=await this.connectionManager.openConnection(t,{signal:r,force:!0});if(n.transient)throw new Error("Could not open a new, non-transient, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,n.remoteAddr),await e.close({signal:r}),!0}catch(r){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,t,r)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let r={signal:AbortSignal.timeout(this.timeout)};try{let n=Mb(e,{maxDataLength:4096}).pb(nE);this.log("A receiving connect");let i=await n.read(r);if(i.type!==nE.Type.CONNECT)throw this.log("B sent wrong message type"),new U("DCUtR message type was incorrect",V);if(0===i.observedAddresses.length)throw this.log("B sent no multiaddrs"),new U("DCUtR connect message had no multiaddrs",V);let s=this.getDialableMultiaddrs(i.observedAddresses);if(0===s.length)throw this.log("B had no dialable multiaddrs"),new U("DCUtR connect message had no dialable multiaddrs",V);if(this.log("A sending connect"),await n.write({type:nE.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map((e=>e.bytes))}),this.log("A receiving sync"),(await n.read(r)).type!==nE.Type.SYNC)throw new U("DCUtR message type was incorrect",V);this.log("A dialing",s);let o=await this.connectionManager.openConnection(s,{signal:r.signal,priority:100,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,o.remoteAddr),await t.close(r)}catch(r){this.log.error("incoming DCUtR from %p failed",t.remotePeer,r),e.abort(r)}finally{await e.close(r)}}getDialableMultiaddrs(e){let t=[];for(let r of e)if(null!=r&&0!==r.length)try{let e=Hp(r);if(!lE(e,this.transportManager))continue;t.push(e)}catch{}return t}},hE="/libp2p/dcutr";function dE(e={}){return t=>new uE(t,e)}!function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(let r of e.listenAddrs)t.uint32(18),t.bytes(r);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(let r of e.protocols)t.uint32(26),t.string(r);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={listenAddrs:[],protocols:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 5:r.protocolVersion=e.string();break;case 6:r.agentVersion=e.string();break;case 1:r.publicKey=e.bytes();break;case 2:r.listenAddrs.push(e.bytes());break;case 4:r.observedAddr=e.bytes();break;case 3:r.protocols.push(e.string());break;case 8:r.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(cE||(cE={}));var fE=c(w(),1),pE="object"==typeof window&&"object"==typeof document&&9===document.nodeType,gE=(0,fE.default)(),mE=pE&&!gE,yE=gE&&!pE,wE=gE&&pE,bE=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&"node"===globalThis.process.release.name&&!gE,EE="function"==typeof importScripts&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,vE=(typeof globalThis.process<"u"&&typeof globalThis.process.env<"u"&&globalThis.process.env.NODE_ENV,typeof navigator<"u"&&"ReactNative"===navigator.product),SE="ipfs";function RE(e,t){return null!=t||(t=`${e.name}/${e.version}`,bE||yE?t+=` UserAgent=${globalThis.process.version}`:(mE||EE||wE||vE)&&(t+=` UserAgent=${globalThis.navigator.userAgent}`)),t}async function AE(e,t,r,n,i){if(r("received identify from %p",n.remotePeer),null==i)throw new U("message was null or undefined","ERR_INVALID_MESSAGE");let s,o={};if(i.listenAddrs.length>0&&(o.addresses=i.listenAddrs.map((e=>({isCertified:!1,multiaddr:Hp(e)})))),i.protocols.length>0&&(o.protocols=i.protocols),null!=i.publicKey&&(o.publicKey=i.publicKey,!(await Qn(i.publicKey)).equals(n.remotePeer)))throw new U("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");if(null!=i.signedPeerRecord){r("received signedPeerRecord from %p",n.remotePeer);let t,a=i.signedPeerRecord,l=await Pb.openAndCertify(a,Bb.DOMAIN),c=Bb.createFromProtobuf(l.payload);if(!c.peerId.equals(l.peerId))throw new U("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!n.remotePeer.equals(c.peerId))throw new U("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");try{t=await e.get(c.peerId)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t&&(o.metadata=t.metadata,null!=t.peerRecordEnvelope)){let e=await Pb.createFromProtobuf(t.peerRecordEnvelope),n=Bb.createFromProtobuf(e.payload);n.seqNumber>=c.seqNumber&&(r("sequence number was lower or equal to existing sequence number - stored: %d received: %d",n.seqNumber,c.seqNumber),c=n,a=t.peerRecordEnvelope)}o.peerRecordEnvelope=a,o.addresses=c.multiaddrs.map((e=>({isCertified:!0,multiaddr:e}))),s={seq:c.seqNumber,addresses:c.multiaddrs}}else r("%p did not send a signed peer record",n.remotePeer);if(r("patching %p with",n.remotePeer,o),await e.patch(n.remotePeer,o),null!=i.agentVersion||null!=i.protocolVersion){let t={};null!=i.agentVersion&&(t.AgentVersion=en(i.agentVersion)),null!=i.protocolVersion&&(t.ProtocolVersion=en(i.protocolVersion)),r("merging %p metadata",n.remotePeer,t),await e.merge(n.remotePeer,{metadata:t})}let a={peerId:n.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map((e=>Hp(e))),observedAddr:null==i.observedAddr?void 0:Hp(i.observedAddr),protocols:i.protocols,signedPeerRecord:s,connection:n};return t.safeDispatchEvent("peer:identify",{detail:a}),a}var _E=class{host;protocol;started;timeout;peerId;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnTransientConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??5e3,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.maxMessageSize=t.maxMessageSize??8192,this.maxObservedAddresses=t.maxObservedAddresses??10,this.runOnTransientConnection=t.runOnTransientConnection??true,this.host={protocolVersion:`${t.protocolPrefix??SE}/0.1.0`,agentVersion:RE(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:en(this.host.agentVersion),ProtocolVersion:en(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,(e=>{this.handleProtocol(e).catch((e=>{this.log.error(e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}},IE=class extends _E{connectionManager;concurrency;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??SE}/id/push/1.0.0`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??32,(t.runOnSelfUpdate??true)&&e.events.addEventListener("self:peer:update",(e=>{this.push().catch((e=>{this.log.error(e)}))}))}[j]=["@libp2p/identify-push"];async push(){if(!this.isStarted())return;let e=this.addressManager.getAddresses().map((e=>e.decapsulateCode(vp("p2p").code))),t=new Bb({peerId:this.peerId,multiaddrs:e}),r=await Pb.seal(t,this.peerId),n=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),s=Bn(i.metadata.get("AgentVersion")??en(this.host.agentVersion)),o=Bn(i.metadata.get("ProtocolVersion")??en(this.host.protocolVersion)),a=this;await ce(Gw(async function*(){for(let t of a.connectionManager.getConnections())(await a.peerStore.get(t.remotePeer)).protocols.includes(a.protocol)&&(yield async()=>{let i,l=AbortSignal.timeout(a.timeout);try{i=await t.newStream(a.protocol,{signal:l,runOnTransientConnection:a.runOnTransientConnection}),await Mb(i,{maxDataLength:a.maxMessageSize}).pb(cE).write({listenAddrs:e.map((e=>e.bytes)),signedPeerRecord:r.marshal(),protocols:n,agentVersion:s,protocolVersion:o},{signal:l}),await i.close({signal:l})}catch(e){a.log.error("could not push identify update to peer",e),i?.abort(e)}})}(),{concurrency:this.concurrency}))}async handleProtocol(e){let{connection:t,stream:r}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let e={signal:AbortSignal.timeout(this.timeout)},n=await Mb(r,{maxDataLength:this.maxMessageSize}).pb(cE).read(e);await r.close(e),await AE(this.peerStore,this.events,this.log,t,n)}catch(e){return this.log.error("received invalid message",e),void r.abort(e)}this.log("handled push from %p",t.remotePeer)}},kE=class extends _E{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??SE}/id/1.0.0`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??true)&&e.events.addEventListener("connection:open",(e=>{let t=e.detail;this.identify(t).catch((e=>{this.log.error("error during identify trigged by connection:open",e)}))}))}[j]=["@libp2p/identify"];async _identify(e,t={}){let r;if(null==t.signal){let e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{r=await e.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection});let n=await Mb(r,{maxDataLength:this.maxMessageSize}).pb(cE).read(t);return await r.close(t),n}catch(e){throw this.log.error("error while reading identify message",e),r?.abort(e),e}}async identify(e,t={}){let r=await this._identify(e,t),{publicKey:n,protocols:i,observedAddr:s}=r;if(null==n)throw new U("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");let o=await Qn(n);if(!e.remotePeer.equals(o))throw new U("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(o))throw new U("identified peer is our own peer id?","ERR_INVALID_PEER");let a=function(e){if(null!=e&&e.length>0)try{return Hp(e)}catch{}}(s);return this.log("identify completed for peer %p and protocols %o",o,i),this.log("our observed address is %a",a),null!=a&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",a),this.addressManager.addObservedAddr(a)),AE(this.peerStore,this.events,this.log,e,r)}async handleProtocol(e){let{connection:t,stream:r}=e,n=AbortSignal.timeout(this.timeout);try{let e=this.peerId.publicKey??new Uint8Array(0),i=await this.peerStore.get(this.peerId),s=this.addressManager.getAddresses().map((e=>e.decapsulateCode(vp("p2p").code))),o=i.peerRecordEnvelope;if(s.length>0&&null==o){let e=new Bb({peerId:this.peerId,multiaddrs:s});o=(await Pb.seal(e,this.peerId)).marshal().subarray()}let a=t.remoteAddr.bytes;cg.matches(t.remoteAddr)||(a=void 0),await Mb(r).pb(cE).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:e,listenAddrs:s.map((e=>e.bytes)),signedPeerRecord:o,observedAddr:a,protocols:i.protocols},{signal:n}),await r.close({signal:n})}catch(e){this.log.error("could not respond to identify request",e),r.abort(e)}}};function TE(e={}){return t=>new kE(t,e)}function CE(e={}){return t=>new IE(t,e)}var DE,xE="/dht/provider";function NE(e){let t=e.getUTCFullYear(),r=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0"),i=String(e.getUTCHours()).padStart(2,"0"),s=String(e.getUTCMinutes()).padStart(2,"0"),o=String(e.getUTCSeconds()).padStart(2,"0"),a=e.getUTCMilliseconds();return`${t}-${r}-${n}T${i}:${s}:${o}.${String(1e3*a*1e3).padStart(9,"0")}Z`}!function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&e.key.byteLength>0&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),null!=e.timeReceived&&""!==e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{let n={key:ue(0),value:ue(0),timeReceived:""},i=null==t?e.len:e.pos+t;for(;e.pos<i;){let t=e.uint32();switch(t>>>3){case 1:n.key=e.bytes();break;case 2:n.value=e.bytes();break;case 5:n.timeReceived=e.string();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>mn(t,e.codec()),e.decode=(t,r)=>mt(t,e.codec(),r)}(DE||(DE={}));var PE,LE,OE,BE,ME,UE,FE,$E=class e{key;value;timeReceived;constructor(e,t,r){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return DE.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:NE(this.timeReceived)}}static deserialize(t){let r=DE.decode(t);return new e(r.key,r.value,new Date(r.timeReceived))}static fromDeserialized(t){let r=function(e){let t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),r=String(e).trim().match(t);if(null==r)throw new Error("Invalid format");let n=parseInt(r[1],10),i=parseInt(r[2],10)-1,s=parseInt(r[3],10),o=parseInt(r[4],10),a=parseInt(r[5],10),l=parseInt(r[6],10),c=parseInt(r[7].slice(0,-6),10);return new Date(Date.UTC(n,i,s,o,a,l,c))}(t.timeReceived);if(null==t.key)throw new Error("key missing from deserialized object");if(null==t.value)throw new Error("value missing from deserialized object");return new e(t.key,t.value,r)}};function VE(e,t={}){let r={...e,name:"SEND_QUERY",type:0,messageName:e.type,messageType:e.type};return t.onProgress?.(new H("kad-dht:query:send-query",{detail:r})),r}function KE(e,t={}){let r={...e,name:"PEER_RESPONSE",type:1,messageName:e.messageType,closer:e.closer??[],providers:e.providers??[]};return t.onProgress?.(new H("kad-dht:query:peer-response",{detail:r})),r}function HE(e,t={}){let r={...e,name:"FINAL_PEER",type:2};return t.onProgress?.(new H("kad-dht:query:final-peer",{detail:r})),r}function qE(e,t={}){let r={...e,name:"QUERY_ERROR",type:3};return t.onProgress?.(new H("kad-dht:query:query-error",{detail:r})),r}function zE(e,t={}){let r={...e,name:"PROVIDER",type:4};return t.onProgress?.(new H("kad-dht:query:provider",{detail:r})),r}function WE(e,t={}){let r={...e,name:"VALUE",type:5};return t.onProgress?.(new H("kad-dht:query:value",{detail:r})),r}function jE(e,t={}){let r={...e,name:"DIAL_PEER",type:7};return t.onProgress?.(new H("kad-dht:query:dial-peer",{detail:r})),r}!function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&(t.uint32(18),t.bytes(e.value)),null!=e.author&&(t.uint32(26),t.bytes(e.author)),null!=e.signature&&(t.uint32(34),t.bytes(e.signature)),null!=e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.key=e.bytes();break;case 2:r.value=e.bytes();break;case 3:r.author=e.bytes();break;case 4:r.signature=e.bytes();break;case 5:r.timeReceived=e.string();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(PE||(PE={})),function(e){e.PUT_VALUE="PUT_VALUE",e.GET_VALUE="GET_VALUE",e.ADD_PROVIDER="ADD_PROVIDER",e.GET_PROVIDERS="GET_PROVIDERS",e.FIND_NODE="FIND_NODE",e.PING="PING"}(LE||(LE={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(OE||(OE={})),function(e){e.codec=()=>wn(OE)}(LE||(LE={})),function(e){e.NOT_CONNECTED="NOT_CONNECTED",e.CONNECTED="CONNECTED",e.CAN_CONNECT="CAN_CONNECT",e.CANNOT_CONNECT="CANNOT_CONNECT"}(BE||(BE={})),function(e){e[e.NOT_CONNECTED=0]="NOT_CONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.CAN_CONNECT=2]="CAN_CONNECT",e[e.CANNOT_CONNECT=3]="CANNOT_CONNECT"}(ME||(ME={})),function(e){e.codec=()=>wn(ME)}(BE||(BE={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.multiaddrs)for(let r of e.multiaddrs)t.uint32(18),t.bytes(r);null!=e.connection&&(t.uint32(24),BE.codec().encode(e.connection,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={id:ue(0),multiaddrs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=e.bytes();break;case 2:r.multiaddrs.push(e.bytes());break;case 3:r.connection=BE.codec().decode(e);break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(UE||(UE={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.type&&0!==OE[e.type]&&(t.uint32(8),LE.codec().encode(e.type,t)),null!=e.clusterLevel&&(t.uint32(80),t.int32(e.clusterLevel)),null!=e.key&&(t.uint32(18),t.bytes(e.key)),null!=e.record&&(t.uint32(26),t.bytes(e.record)),null!=e.closer)for(let r of e.closer)t.uint32(66),UE.codec().encode(r,t);if(null!=e.providers)for(let r of e.providers)t.uint32(74),UE.codec().encode(r,t);!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={type:LE.PUT_VALUE,closer:[],providers:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.type=LE.codec().decode(e);break;case 10:r.clusterLevel=e.int32();break;case 2:r.key=e.bytes();break;case 3:r.record=e.bytes();break;case 8:r.closer.push(UE.codec().decode(e,e.uint32()));break;case 9:r.providers.push(UE.codec().decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(FE||(FE={}));var GE={pk:function(e,t){return 0}};async function YE(e,t){let r=t.key,n=Bn(r).split("/");if(n.length<3)return;let i=e[n[1].toString()];if(null==i){let e=`No validator available for key type "${n[1]}"`;throw new U(e,"ERR_INVALID_RECORD_KEY_TYPE")}await i(r,t.value)}var QE={pk:async(e,t)=>{if(!(e instanceof Uint8Array))throw new U('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(e.byteLength<5)throw new U("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if("/pk/"!==Bn(e.subarray(0,4)))throw new U("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");if(!ke(e.slice(4),(await Fr.digest(t)).bytes))throw new U("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")}},JE=en("/pk/");function ZE(e){return{...e,multiaddrs:e.multiaddrs.filter((e=>{let[[t,r]]=e.stringTuples();if(53===t||54===t||55===t)return"localhost"!==r;if(4!==t&&6!==t||null==r)return!1;let n=pp(r);return null==n||!n}))}}async function XE(e){return(await Fr.digest(e)).digest}async function ev(e){return XE(e.toBytes())}function tv(e){return new Nd(`/dht/record/${Bn(e,"base32")}`,!1)}function rv(e,t){let r=new Date;return new $E(e,t,r).serialize()}var nv=class{log;components;validators;selectors;peerRouting;queryManager;network;constructor(e,t){let{validators:r,selectors:n,peerRouting:i,queryManager:s,network:o,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-fetching`),this.validators=r,this.selectors=n,this.peerRouting=i,this.queryManager=s,this.network=o}async getLocal(e){this.log("getLocal %b",e);let t=tv(e);this.log("fetching record for key %k",t);let r=await this.components.datastore.get(t);this.log("found %k in local datastore",t);let n=$E.deserialize(r);return await YE(this.validators,n),n}async*sendCorrectionRecord(e,t,r,n={}){this.log("sendCorrection for %b",e);let i=rv(e,r);for(let{value:s,from:o}of t){if(ke(s,r)){this.log("record was ok");continue}if(this.components.peerId.equals(o)){try{let t=tv(e);this.log(`Storing corrected record for key ${t.toString()}`),await this.components.datastore.put(t,i.subarray())}catch(e){this.log.error("Failed error correcting self",e)}continue}let t=!1,a={type:LE.PUT_VALUE,key:e,record:i};for await(let e of this.network.sendRequest(o,a,n))"PEER_RESPONSE"===e.name&&null!=e.record&&ke(e.record.value,$E.deserialize(i).value)&&(t=!0),yield e;t||(yield qE({from:o,error:new U("value not put correctly","ERR_PUT_VALUE_INVALID")},n)),this.log.error("Failed error correcting entry")}}async*put(e,t,r={}){this.log("put key %b value %b",e,t);let n=rv(e,t),i=tv(e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,n.subarray()),yield*We(this.peerRouting.getClosestPeers(e,{signal:r.signal}),(t=>He(t,(t=>async()=>{if("FINAL_PEER"!==t.name)return[t];let i=[],s={type:LE.PUT_VALUE,key:e,record:n};this.log("send put to %p",t.peer.id);for await(let e of this.network.sendRequest(t.peer.id,s,r))i.push(e),"PEER_RESPONSE"===e.name&&(null!=e.record&&ke(e.record.value,$E.deserialize(n).value)||i.push(qE({from:t.peer.id,error:new U("value not put correctly","ERR_PUT_VALUE_INVALID")},r)));return i}))),(e=>Gw(e,{ordered:!1,concurrency:3})),(async function*(e){for await(let t of e)yield*t}))}async*get(e,t={}){this.log("get %b",e);let r=[];for await(let n of this.getMany(e,t))"VALUE"===n.name&&r.push(n),yield n;if(0===r.length)return;let n=r.map((e=>e.value)),i=0;try{i=function(e,t,r){if(0===r.length)throw new U("No records given","ERR_NO_RECORDS_RECEIVED");let n=Bn(t).split("/");if(n.length<3)throw new U("Record key does not have a selector function","ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY");let i=e[n[1].toString()];if(null==i){let e=`No selector function configured for key type "${n[1]}"`;throw new U(e,"ERR_UNRECOGNIZED_KEY_PREFIX")}return 1===r.length?0:i(t,r)}(this.selectors,e,n)}catch(e){if("ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY"!==e.code)throw e}let s=n[i];if(this.log("GetValue %b %b",e,s),null==s)throw new U("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,r,s,t),yield r[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let r=await this.getLocal(e);yield WE({value:r.value,from:this.components.peerId},t)}catch(t){this.log("error getting local value for %b",e,t)}let r=this;yield*this.queryManager.run(e,(async function*({peer:n,signal:i}){for await(let s of r.peerRouting.getValueOrPeers(n,e,{signal:i}))yield s,"PEER_RESPONSE"===s.name&&null!=s.record&&(yield WE({from:n,value:s.record.value},t))}),t)}};function iv(e,t){return{id:e.id.toBytes(),multiaddrs:(e.multiaddrs??[]).map((e=>e.bytes)),connection:t}}function sv(e){if(null==e.id)throw new Error("Invalid peer in message");return{id:Yn(e.id),multiaddrs:(e.multiaddrs??[]).map((e=>Hp(e)))}}var ov=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:r,peerRouting:n,queryManager:i,routingTable:s,providers:o,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-routing`),this.network=r,this.peerRouting=n,this.queryManager=i,this.routingTable=s,this.providers=o}async*provide(e,t,r={}){this.log("provide %s",e);let n=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);let i={type:LE.ADD_PROVIDER,key:n,providers:[iv({id:this.components.peerId,multiaddrs:t})]},s=0,o=t=>async()=>{if("FINAL_PEER"!==t.name)return[t];let n=[];this.log("putProvider %s to %p",e,t.peer.id);try{this.log("sending provider record for %s to %p",e,t.peer.id);for await(let o of this.network.sendMessage(t.peer.id,i,r))"PEER_RESPONSE"===o.name&&(this.log("sent provider record for %s to %p",e,t.peer.id),s++),n.push(o)}catch(e){this.log.error("error sending provide record to peer %p",t.peer.id,e),n.push(qE({from:t.peer.id,error:e},r))}return n};yield*We(this.peerRouting.getClosestPeers(n,r),(e=>He(e,(e=>o(e)))),(e=>Gw(e,{ordered:!1,concurrency:3})),(async function*(e){for await(let t of e)yield*t})),this.log("sent provider records to %d peers",s)}async*findProviders(e,t){let r=this.routingTable.kBucketSize,n=0,i=e.multihash.bytes,s=this;this.log("findProviders %c",e);let o=await this.providers.getProviders(e);if(o.length>0){let e=[];for(let t of o.slice(0,r))try{let r=await this.components.peerStore.get(t);e.push({id:t,multiaddrs:r.addresses.map((({multiaddr:e})=>e))})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e;this.log("no peer store entry for %p",t)}if(yield KE({from:this.components.peerId,messageType:LE.GET_PROVIDERS,providers:e},t),yield zE({from:this.components.peerId,providers:e},t),n+=e.length,n>=r)return}let a=async function*({peer:e,signal:r}){let n={type:LE.GET_PROVIDERS,key:i};yield*s.network.sendRequest(e,n,{...t,signal:r})},l=new Xn(o);for await(let s of this.queryManager.run(i,a,t))if(yield s,"PEER_RESPONSE"===s.name){this.log("Found %d provider entries for %c and %d closer peers",s.providers.length,e,s.closer.length);let i=[];for(let e of s.providers)l.has(e.id)||(l.add(e.id),i.push(e));if(i.length>0&&(yield zE({from:s.from,providers:i},t),n+=i.length,n>=r))return}}},av=class{movingAverage;variance;deviation;forecast;timespan;previousTime;constructor(e){this.timespan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timespan)}push(e,t=Date.now()){if(null!=this.previousTime){let r=this.alpha(t,this.previousTime),n=e-this.movingAverage,i=r*n;this.movingAverage=r*e+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+n*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*n}else this.movingAverage=e;this.previousTime=t}},lv=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;constructor(e={}){this.success=new av(e.interval??5e3),this.failure=new av(e.interval??5e3),this.next=new av(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??2,this.timeoutMultiplier=e.timeoutMultiplier??1.2,this.minTimeout=e.minTimeout??2e3,null!=e.metricName&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),r=AbortSignal.timeout(t),n=Y([e.signal,r]);return n.start=Date.now(),n.timeout=t,n}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}},cv=class extends K{log;protocol;running;components;timeout;constructor(e,t){super();let{protocol:r}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=r,this.timeout=new lv({...t.timeout??{},metrics:e.metrics,metricName:`${t.logPrefix.replaceAll(":","_")}_network_message_send_times_milliseconds`})}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,r={}){if(!this.running)return;let n=t.type;if(null==n)throw new Cn("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",t.type,e),yield jE({peer:e},r),yield VE({to:e,type:n},r);let i,s=this.timeout.getTimeoutSignal(r);r={...r,signal:s};try{i=await(await this.components.connectionManager.openConnection(e,r)).newStream(this.protocol,r);let n=await this._writeReadMessage(i,t,r);i.close(r).catch((t=>{this.log.error("error closing stream to %p",e,t),i?.abort(t)})),yield KE({from:e,messageType:n.type,closer:n.closer.map(sv),providers:n.providers.map(sv),record:null==n.record?void 0:$E.deserialize(n.record)},r)}catch(n){i?.abort(n),this.log.error("could not send %s to %p",t.type,e,n),yield qE({from:e,error:n},r)}finally{this.timeout.cleanUp(s)}}async*sendMessage(e,t,r={}){if(!this.running)return;let n=t.type;if(null==n)throw new Cn("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",t.type,e),yield jE({peer:e},r),yield VE({to:e,type:n},r);let i,s=this.timeout.getTimeoutSignal(r);r={...r,signal:s};try{i=await(await this.components.connectionManager.openConnection(e,r)).newStream(this.protocol,r),await this._writeMessage(i,t,r),i.close(r).catch((t=>{this.log.error("error closing stream to %p",e,t),i?.abort(t)})),yield KE({from:e,messageType:n},r)}catch(t){i?.abort(t),yield qE({from:e,error:t},r)}finally{this.timeout.cleanUp(s)}}async _writeMessage(e,t,r){let n=Mb(e);await n.write(t,FE,r),await n.unwrap().close(r)}async _writeReadMessage(e,t,r){let n=Mb(e);await n.write(t,FE,r);let i=await n.read(FE,r);return await n.unwrap().close(r),i.closer.forEach((e=>{this.safeDispatchEvent("peer",{detail:sv(e)})})),i.providers.forEach((e=>{this.safeDispatchEvent("peer",{detail:sv(e)})})),i}};function uv(e,t){if(e.byteLength!==t.byteLength)throw new Error("Inputs should have the same length");for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return e[r]<t[r]?-1:1;return 0}var hv=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map((e=>e.peer))}async add(e){let t=await ev(e.id);this.addWitKadId(e,t)}addWitKadId(e,t){if(null!=this.peerDistances.find((t=>t.peer.id.equals(e.id))))return;let r={peer:e,distance:tw(this.originDhtKey,t)};this.peerDistances.push(r),this.peerDistances.sort(((e,t)=>uv(e.distance,t.distance))),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){return 0===this.length||-1===uv(tw(await ev(e),this.originDhtKey),this.peerDistances[this.peerDistances.length-1].distance)}async anyCloser(e){return 0!==e.length&&Promise.any(e.map((async e=>this.isCloser(e))))}},dv=class{log;routingTable;network;validators;queryManager;peerStore;peerId;constructor(e,t){let{routingTable:r,network:n,validators:i,queryManager:s,logPrefix:o}=t;this.routingTable=r,this.network=n,this.validators=i,this.queryManager=s,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${o}:peer-routing`)}async findPeerLocal(e){let t,r=await this.routingTable.find(e);if(null!=r){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(r)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}}if(null==t)try{t=await this.peerStore.get(e)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map((e=>e.multiaddr))}}async*_getValueSingle(e,t,r={}){let n={type:LE.GET_VALUE,key:t};yield*this.network.sendRequest(e,n,r)}async*getPublicKeyFromNode(e,t={}){let r=function(e){return Ie([JE,e.toBytes()])}(e);for await(let n of this._getValueSingle(e,r,t))if(yield n,"PEER_RESPONSE"===n.name&&null!=n.record){let r=await Qn(ni.marshalPublicKey({bytes:n.record.value}));if(!r.equals(e))throw new U("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(null==r.publicKey)throw new U("public key missing","ERR_PUBLIC_KEY_MISSING");yield WE({from:e,value:r.publicKey},t)}throw new U(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){if(this.log("findPeer %p",e),!1!==t.useCache){let r=await this.findPeerLocal(e);if(null!=r)return this.log("found local"),void(yield HE({from:this.peerId,peer:r},t))}let r=!1;if(!1!==t.useNetwork){let n=this,i=async function*({peer:r,signal:i}){let s={type:LE.FIND_NODE,key:e.toBytes()};for await(let o of n.network.sendRequest(r,s,{...t,signal:i}))if(yield o,"PEER_RESPONSE"===o.name){let r=o.closer.find((t=>t.id.equals(e)));null!=r&&(yield HE({from:o.from,peer:r},t))}};for await(let n of this.queryManager.run(e.toBytes(),i,t))"FINAL_PEER"===n.name&&(r=!0),yield n}r||(yield qE({from:this.peerId,error:new U("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let r=await XE(e),n=this.routingTable.closestPeers(r),i=this,s=new hv(r,this.routingTable.kBucketSize);await Promise.all(n.map((async e=>{await s.add({id:e,multiaddrs:[]})})));let o=async function*({peer:r,signal:n}){i.log("closerPeersSingle %s from %p",Bn(e,"base32"),r);let s={type:LE.FIND_NODE,key:e};yield*i.network.sendRequest(r,s,{...t,signal:n})};for await(let r of this.queryManager.run(e,o,t))"PEER_RESPONSE"===r.name&&await Promise.all(r.closer.map((async e=>{await s.add(e)}))),yield r;this.log("found %d peers close to %b",s.length,e);for(let e of s.peers)yield HE({from:this.peerId,peer:e},t)}async*getValueOrPeers(e,t,r={}){for await(let n of this._getValueSingle(e,t,r)){if("PEER_RESPONSE"===n.name&&null!=n.record)try{await this._verifyRecordOnline(n.record)}catch{let e="invalid record received, discarded";this.log(e),yield qE({from:n.from,error:new U(e,"ERR_INVALID_RECORD")},r);continue}yield n}}async _verifyRecordOnline(e){if(null==e.timeReceived)throw new U("invalid record received","ERR_INVALID_RECORD");await YE(this.validators,new $E(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){let r=await XE(e),n=this.routingTable.closestPeers(r),i=[];for(let e of n)if(!e.equals(t))try{let t=await this.peerStore.get(e);i.push({id:e,multiaddrs:t.addresses.map((({multiaddr:e})=>e))})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),i}},fv=c(p(),1),pv=class{log;datastore;cache;cleanupInterval;provideValidity;syncQueue;started;cleaner;constructor(e,t={}){let{cacheSize:r,cleanupInterval:n,provideValidity:i}=t;this.log=e.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=e.datastore,this.cleanupInterval=n??36e5,this.provideValidity=i??864e5,this.cache=(0,fv.default)(r??256),this.syncQueue=new Gu({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval((()=>{this._cleanup().catch((e=>{this.log.error(e)}))}),this.cleanupInterval))}async stop(){this.started=!1,null!=this.cleaner&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add((async()=>{let e=Date.now(),t=0,r=0,n=new Map,i=this.datastore.batch(),s=this.datastore.query({prefix:xE});for await(let e of s)try{let{cid:s,peerId:o}=mv(e.key),a=yv(e.value).getTime(),l=Date.now(),c=l-a,u=c>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",l,a,c,this.provideValidity,u?"(expired)":""),u){r++,i.delete(e.key);let t=n.get(s)??new Set;t.add(o),n.set(s,t)}t++}catch(e){this.log.error(e.message)}n.size>0?(this.log("deleting %d / %d entries",r,t),await i.commit()):this.log("nothing to delete");for(let[e,t]of n){let r=gv(e),n=this.cache.get(r);if(null!=n){for(let e of t)n.delete(e);0===n.size?this.cache.remove(r):this.cache.set(r,n)}}this.log("Cleanup successful (%dms)",Date.now()-e)}))}async _getProvidersMap(e){let t=gv(e),r=this.cache.get(t);return null==r&&(r=await async function(e,t){let r=new Map,n=e.query({prefix:gv(t)});for await(let e of n){let{peerId:t}=mv(e.key);r.set(t,yv(e.value))}return r}(this.datastore,e),this.cache.set(t,r)),r}async addProvider(e,t){await this.syncQueue.add((async()=>{this.log("%p provides %s",t,e);let r=await this._getProvidersMap(e);this.log("loaded %s provs",r.size);let n=new Date;r.set(t.toString(),n);let i=gv(e);this.cache.set(i,r),await async function(e,t,r,n){let i=[gv(t),"/",r.toString()].join(""),s=new Nd(i),o=Ae(n.getTime());await e.put(s,o)}(this.datastore,e,t,n)}))}async getProviders(e){return this.syncQueue.add((async()=>(this.log("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map((e=>Gn(e))))),{throwOnTimeout:!0})}};function gv(e){let t="string"==typeof e?e:Bn(e.multihash.bytes,"base32");return`${xE}/${t}`}function mv(e){let t=e.toString().split("/");if(5!==t.length)throw new Error(`incorrectly formatted provider entry key in datastore: ${e.toString()}`);return{cid:t[3],peerId:t[4]}}function yv(e){return new Date(_e(e))}var wv=class{disjointPaths;alpha;shutDownController;running;queries;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;metrics;constructor(e,t){let{disjointPaths:r=20,alpha:n=3,logPrefix:i}=t;this.logPrefix=i,this.disjointPaths=r??20,this.running=!1,this.alpha=n??3,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,null!=e.metrics&&(this.metrics={runningQueries:e.metrics.registerMetric(`${i.replaceAll(":","_")}_running_queries`),queryTime:e.metrics.registerMetric(`${i.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,this.shutDownController.signal}isStarted(){return this.running}async start(){this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,r={}){if(!this.running)throw new Error("QueryManager not started");let n=this.metrics?.queryTime.timer();if(null==r.signal){let e=AbortSignal.timeout(18e4);r={...r,signal:e}}let i=new AbortController,s=Y([this.shutDownController.signal,i.signal,r.signal]);i.signal;let o=this.logger.forComponent(`${this.logPrefix}:query:`+Bn(e,"base58btc")),a=Date.now(),l=!1;try{!0!==r.isSelfQuery&&null!=this.initialQuerySelfHasRun&&(o("waiting for initial query-self query before continuing"),await ie(this.initialQuerySelfHasRun.promise,s),this.initialQuerySelfHasRun=void 0),o("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries);let n=await XE(e),i=this.routingTable.closestPeers(n),a=i.slice(0,Math.min(this.disjointPaths,i.length));if(0===i.length)return void o.error("Running query with no peers");let c=new Xn,u=a.map(((n,i)=>async function*(e){let{key:t,startingPeer:r,ourPeerId:n,signal:i,query:s,alpha:o,pathIndex:a,numPaths:l,queryFuncTimeout:c,log:u,peersSeen:h,connectionManager:d}=e,f=new ae({concurrency:o,sort:(e,t)=>uv(e.options.distance,t.options.distance)}),p=await XE(t);!function r(o,g){if(null==o)return;h.add(o);let m=tw(g,p);f.add((async()=>{let g=[i];null!=c&&g.push(AbortSignal.timeout(c));let y=Y(g);try{for await(let e of s({key:t,peer:o,signal:y,pathIndex:a,numPaths:l})){if(y.aborted)return;if("PEER_RESPONSE"===e.name)for(let i of e.closer){if(h.has(i.id)){u("already seen %p in query",i.id);continue}if(n.equals(i.id)){u("not querying ourselves");continue}if(!await d.isDialable(i.multiaddrs)){u("not querying undialable peer");continue}let e=await ev(i.id);-1===uv(tw(e,p),m)?(u("querying closer peer %p",i.id),r(i.id,e)):u("skipping %p as they are not closer to %b than %p",i.id,t,o)}f.safeDispatchEvent("completed",{detail:e})}}catch(t){if(!i.aborted)return qE({from:o,error:t},e)}finally{y.clear()}}),{distance:m}).catch((e=>{u.error(e)}))}(r,await ev(r));try{for await(let e of f.toGenerator({signal:i}))null!=e&&(yield e)}catch(e){throw i.aborted?new U("Query aborted","ERR_QUERY_ABORTED"):e}}({key:e,startingPeer:n,ourPeerId:this.peerId,signal:s,query:t,pathIndex:i,numPaths:a.length,alpha:this.alpha,queryFuncTimeout:r.queryFuncTimeout,log:o,peersSeen:c,onProgress:r.onProgress,connectionManager:this.connectionManager})));for await(let e of ze(...u)){if("QUERY_ERROR"===e.name&&o.error("query error",e.error),"PEER_RESPONSE"===e.name)for(let t of[...e.closer,...e.providers])await this.connectionManager.isDialable(t.multiaddrs)&&await this.routingTable.add(t.id);yield e}l=!0}catch(e){if(this.running||"ERR_QUERY_ABORTED"!==e.code)throw e}finally{l||(o("query exited early"),i.abort()),s.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),n?.(),o("query:done in %dms",Date.now()-a)}}},bv=function(e){if(function(e){return null!=e[Symbol.asyncIterator]}(e))return(async()=>{let t=0;for await(let r of e)t++;return t})();{let t=0;for(let r of e)t++;return t}};function Ev(e,t,r){"function"==typeof r&&(r={filter:r});let n=function(e,t,r){let n,i=new Promise(((i,s)=>{if(!((r={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...r}).count>=0)||r.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(r.count))throw new TypeError("The `count` option should be at least 0 or more");r.signal?.throwIfAborted();let o=[t].flat(),a=[],{addListener:l,removeListener:c}=(e=>{let t=e.addEventListener||e.on||e.addListener,r=e.removeEventListener||e.off||e.removeListener;if(!t||!r)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:r.bind(e)}})(e),u=(...e)=>{let t=r.multiArgs?e:e[0];r.filter&&!r.filter(t)||(a.push(t),r.count===a.length&&(n(),i(a)))},h=e=>{n(),s(e)};n=()=>{for(let e of o)c(e,u);for(let e of r.rejectionEvents)c(e,h)};for(let e of o)l(e,u);for(let e of r.rejectionEvents)l(e,h);r.signal&&r.signal.addEventListener("abort",(()=>{h(r.signal.reason)}),{once:!0}),r.resolveImmediately&&i(a)}));if(i.cancel=n,"number"==typeof r.timeout){let e=Wu(i,{milliseconds:r.timeout});return e.cancel=n,e}return i}(e,t,r={...r,count:1,resolveImmediately:!1}),i=n.then((e=>e[0]));return i.cancel=n.cancel,i}var vv=class{log;peerId;peerRouting;routingTable;count;interval;initialInterval;queryTimeout;started;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){let{peerRouting:r,logPrefix:n,count:i,interval:s,queryTimeout:o,routingTable:a}=t;this.peerId=e.peerId,this.log=e.logger.forComponent(`${n}:query-self`),this.started=!1,this.peerRouting=r,this.routingTable=a,this.count=i??20,this.interval=s??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=o??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout((()=>{this.querySelf().catch((e=>{this.log.error("error running self-query",e)}))}),this.initialInterval))}stop(){this.started=!1,null!=this.timeoutId&&clearTimeout(this.timeoutId),null!=this.controller&&this.controller.abort()}async querySelf(){if(this.started){if(null!=this.querySelfPromise)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Q(),this.started){this.controller=new AbortController;let e=AbortSignal.timeout(this.queryTimeout),t=Y([this.controller.signal,e]);this.controller.signal;try{0===this.routingTable.size&&(this.log("routing table was empty, waiting for some peers before running query"),await Ev(this.routingTable,"peer:add",{signal:t})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let e=Date.now(),r=await We(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:t,isSelfQuery:!0}),(e=>Ze(e,this.count)),(async e=>bv(e)));this.log("self-query found %d peers in %dms",r,Date.now()-e)}catch(e){this.log.error("self-query error",e)}finally{t.clear(),null!=this.initialQuerySelfHasRun&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout((()=>{this.querySelf().catch((e=>{this.log.error("error running self-query",e)}))}),this.interval))}else this.log("skip self-query because we are not started")}};function Sv(e,t){if(!(t instanceof Uint8Array))throw new TypeError(e+" is not a Uint8Array");if(32!==t.byteLength)throw new TypeError(e+" had incorrect length")}function Rv(e){return Array.isArray(e?.peers)}var Av,_v=class extends K{root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;constructor(e){super(),this.localPeer=e.localPeer,this.prefixLength=e.prefixLength,this.kBucketSize=e.kBucketSize??Iv,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfNodesToPing??3,Sv("options.localPeer.kadId",e.localPeer.kadId),this.root={prefix:"",depth:0,peers:[]}}add(e){Sv("peer.kadId",e?.kadId);let t=this._determineBucket(e.kadId);if(!(this._indexOf(t,e.kadId)>-1)){if(t.peers.length===this.splitThreshold&&t.depth<this.prefixLength)return this._split(t),void this.add(e);if(t.peers.length<this.kBucketSize)return t.peers.push(e),void this.safeDispatchEvent("added",{detail:e});this.safeDispatchEvent("ping",{detail:{oldContacts:t.peers.slice(0,this.numberOfNodesToPing),newContact:e}})}}*closest(e,t=this.kBucketSize){let r=new hv(e,t);for(let e of this.toIterable())r.addWitKadId({id:e.peerId,multiaddrs:[]},e.kadId);yield*He(r.peers,(e=>e.id))}count(){return function e(t){if(Rv(t))return t.peers.length;let r=0;return null!=t.left&&(r+=e(t.left)),null!=t.right&&(r+=e(t.right)),r}(this.root)}get(e){let t=this._determineBucket(e),r=this._indexOf(t,e);return t.peers[r]}remove(e){let t=this._determineBucket(e),r=this._indexOf(t,e);if(r>-1){let e=t.peers.splice(r,1)[0];this.safeDispatchEvent("removed",{detail:e})}}*toIterable(){yield*function*e(t){Rv(t)?yield*t.peers:(yield*e(t.left),yield*e(t.right))}(this.root)}distance(e,t){return BigInt("0x"+Bn(tw(e,t),"base16"))}_determineBucket(e){let t=Bn(e,"base2").substring(0,this.prefixLength);return function e(r,n=0){return Rv(r)?r:"0"===t[n]?e(r.left,n+1):e(r.right,n+1)}(this.root)}_indexOf(e,t){return e.peers.findIndex((e=>function(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0,n=e.length;r<n;++r)if(e[r]!==t[r])return!1;return!0}(e.kadId,t)))}_split(e){let t=e.depth+1,r={prefix:"0",depth:t,peers:[]},n={prefix:"1",depth:t,peers:[]};for(let i of e.peers)"0"===Bn(i.kadId,"base2")[t]?r.peers.push(i):n.peers.push(i);delete e.peers,e.left=r,e.right=n}},Iv=20,kv=class extends K{kBucketSize;kb;pingQueue;log;components;prefixLength;splitThreshold;pingTimeout;pingConcurrency;running;protocol;tagName;tagValue;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??Iv,this.pingTimeout=t.pingTimeout??1e4,this.pingConcurrency=t.pingConcurrency??10,this.running=!1,this.protocol=t.protocol,this.tagName=t.tagName??"kad-close",this.tagValue=t.tagValue??50,this.prefixLength=t.prefixLength??32,this.splitThreshold=t.splitThreshold??Iv,this.pingQueue=new le({concurrency:this.pingConcurrency,metricName:`${t.logPrefix.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",(e=>{this.log.error("error pinging peer",e.detail)})),null!=this.components.metrics&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_max_depth`)})}isStarted(){return this.running}async start(){this.running=!0;let e=new _v({localPeer:{kadId:await ev(this.components.peerId),peerId:this.components.peerId},kBucketSize:this.kBucketSize,prefixLength:this.prefixLength,splitThreshold:this.splitThreshold,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",(e=>{this._onPing(e).catch((e=>{this.log.error("could not process k-bucket ping event",e)}))}));let t=0;for(let e of await this.components.peerStore.all())if(e.protocols.includes(this.protocol)){let r=await ev(e.id);this.kb.add({kadId:r,peerId:e.id}),t++}this.log("added %d peer store peers to the routing table",t),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new Xn,r=function(e,t=100){let r;return()=>{clearTimeout(r),r=setTimeout((()=>{e()}),t)}}((()=>{let r=new Xn(e.closest(e.localPeer.kadId,Iv)),n=r.difference(t),i=t.difference(r);Promise.resolve().then((async()=>{for(let e of n)await this.components.peerStore.merge(e,{tags:{[this.tagName]:{value:this.tagValue}}});for(let e of i)await this.components.peerStore.merge(e,{tags:{[this.tagName]:void 0}})})).catch((e=>{this.log.error("Could not update peer tags",e)})),t=r}));e.addEventListener("added",(e=>{r(),this.safeDispatchEvent("peer:add",{detail:e.detail.peerId})})),e.addEventListener("removed",(e=>{r(),this.safeDispatchEvent("peer:remove",{detail:e.detail.peerId})}))}async _onPing(e){if(!this.running)return;let{oldContacts:t,newContact:r}=e.detail,n=(await Promise.all(t.map((async e=>{let t=this.pingQueue.find(e.peerId);return null!=t?t.join():this.pingQueue.add((async()=>{let t;try{let r={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",e.peerId),t=await(await this.components.connectionManager.openConnection(e.peerId,r)).newStream(this.protocol,r);let n=Mb(t);await n.write({type:LE.PING},FE,r);let i=await n.read(FE,r);if(await n.unwrap().close(),i.type!==LE.PING)throw new U(`Incorrect message type received, expected PING got ${i.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(r){return this.running&&null!=this.kb&&(this.log.error("could not ping peer %p",e.peerId,r),this.log("evicting old contact after ping failed %p",e.peerId),this.kb.remove(e.kadId)),t?.abort(r),!1}finally{this.metrics?.routingTableSize.update(this.size)}}),{peerId:e.peerId})})))).filter((e=>e)).length;this.running&&n<t.length&&null!=this.kb&&(this.log("adding new contact %p",r.peerId),this.kb.add(r))}get size(){return null==this.kb?0:this.kb.count()}async find(e){let t=await ev(e);return this.kb?.get(t)?.peerId}closestPeer(e){let t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return null==this.kb?[]:[...this.kb.closest(e,t)]}async add(e){if(null==this.kb)throw new Error("RoutingTable is not started");let t=await ev(e);this.kb.add({kadId:t,peerId:e}),this.log("added %p with kad id %b",e,t),this.updateMetrics()}async remove(e){if(null==this.kb)throw new Error("RoutingTable is not started");let t=await ev(e);this.kb.remove(t),this.updateMetrics()}updateMetrics(){if(null==this.metrics||null==this.kb)return;let e=0,t=0,r=0;(function n(i){if(Rv(i))return i.depth>r&&(r=i.depth),t++,void(e+=i.peers.length);n(i.left),n(i.right)})(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMaxDepth.update(r)}},Tv=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Cv=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){let{peerRouting:r,routingTable:n,refreshInterval:i,refreshQueryTimeout:s,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:routing-table:refresh`),this.peerRouting=r,this.routingTable=n,this.refreshInterval=i??3e5,this.refreshQueryTimeout=s??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");let t=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${r.map((e=>e.toISOString())).join(", ")} ]`),Promise.all(r.map((async(n,i)=>{try{if(await this._refreshCommonPrefixLength(i,n,e),0===this._numPeersForCpl(t)){let t=Math.min(2*(i+1),r.length-1);for(let r=i+1;r<t+1;r++)try{await this._refreshCommonPrefixLength(r,n,e)}catch(e){this.log.error(e)}}}catch(e){this.log.error(e)}}))).catch((e=>{this.log.error(e)})).then((()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),null!=this.refreshTimeoutId.unref&&this.refreshTimeoutId.unref()})).catch((e=>{this.log.error(e)}))}async _refreshCommonPrefixLength(e,t,r){if(!r&&t.getTime()>Date.now()-this.refreshInterval)return void this.log("not running refresh for cpl %s as time since last refresh not above interval",e);let n=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,n,this.routingTable.size);let i=AbortSignal.timeout(this.refreshQueryTimeout),s=await bv(this.peerRouting.getClosestPeers(n.toBytes(),{signal:i}));this.log(`found ${s} peers that were close to imaginary peer %p`,n),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,n,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>15&&(e=15);let t=[];for(let r=0;r<=e;r++)t[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return t}async _generateRandomPeerId(e){if(null==this.routingTable.kb)throw new Error("Routing table not started");let t=Mo(2),r=(t[1]<<8)+t[0];return Yn(await this._makePeerId(this.routingTable.kb.localPeer.kadId,r,e))}async _makePeerId(e,t,r){if(r>15)throw new Error("Cannot generate peer ID for common prefix length greater than 15");let n=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>r,i=65535<<16-(r+1),s=Tv[n&i|t&~i],o=new ArrayBuffer(34),a=new DataView(o,0,o.byteLength);return a.setUint8(0,Fr.code),a.setUint8(1,32),a.setUint32(2,s,!1),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let r of this._prefixLengths())r===e&&t++;return t}*_prefixLengths(){if(null!=this.routingTable.kb)for(let{kadId:e}of this.routingTable.kb.toIterable()){let t=tw(this.routingTable.kb.localPeer.kadId,e),r=0;for(let e of t){if(0!==e)break;r++}yield r}}},Dv=class{providers;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.providers=t.providers}async handle(e,t){if(this.log("start"),null==t.key||0===t.key.length)throw new U("Missing key","ERR_MISSING_KEY");let r;try{r=qr.decode(t.key)}catch{throw new U("Invalid CID","ERR_INVALID_CID")}(null==t.providers||0===t.providers.length)&&this.log.error("no providers found in message"),await Promise.all(t.providers.map((async t=>{e.equals(t.id)?t.multiaddrs.length<1?this.log("no valid addresses for provider %p. Ignore",e):(this.log("received provider %p for %s (addrs %s)",e,r,t.multiaddrs.map((e=>Hp(e).toString()))),await this.providers.addProvider(r,Yn(t.id))):this.log("invalid provider peer %p from %p",t.id,e)})))}},xv=class{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){let{peerRouting:r,logPrefix:n}=t;this.log=e.logger.forComponent(`${n}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),null==t.key)throw new U("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");let r=await this.peerRouting.getCloserPeersOffline(t.key,e);ke(this.peerId.toBytes(),t.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map((e=>e.decapsulateCode(vp("p2p").code)))});let n={type:LE.FIND_NODE,clusterLevel:t.clusterLevel,closer:r.map(this.peerInfoMapper).filter((({multiaddrs:e})=>e.length)).map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))}))),providers:[]};return 0===n.closer.length&&this.log("could not find any peers closer to %b than %p",t.key,e),n}},Nv=class{peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){let{peerRouting:r,providers:n,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerStore=e.peerStore,this.peerRouting=r,this.providers=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(null==t.key)throw new U("Invalid GET_PROVIDERS message received - key was missing","ERR_INVALID_MESSAGE");let r;try{r=qr.decode(t.key)}catch{throw new U("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",e,r);let[n,i]=await Promise.all([this.providers.getProviders(r),this.peerRouting.getCloserPeersOffline(t.key,e)]),s=await this._getPeers(n),o=await this._getPeers(i.map((({id:e})=>e))),a={type:LE.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:o.map(this.peerInfoMapper).filter((({multiaddrs:e})=>e.length)).map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))}))),providers:s.map(this.peerInfoMapper).filter((({multiaddrs:e})=>e.length)).map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))})))};return this.log("got %s providers %s closerPeers",a.providers.length,a.closer.length),a}async _getAddresses(e){return[]}async _getPeers(e){let t=[];for(let r of e)try{let e=await this.peerStore.get(r),n=this.peerInfoMapper({id:r,multiaddrs:e.addresses.map((({multiaddr:e})=>e))});n.multiaddrs.length>0&&t.push(n)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return t}},Pv=class{peerStore;datastore;peerRouting;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let r=t.key;if(this.log("%p asked for key %b",e,r),null==r||0===r.length)throw new U("Invalid key","ERR_INVALID_KEY");let n={type:LE.GET_VALUE,key:r,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(function(e){return"/pk/"===Bn(e.subarray(0,4))}(r)){this.log("is public key");let e,t=function(e){return Yn(e.subarray(4))}(r);try{let r=await this.peerStore.get(t);if(null==r.id.publicKey)throw new U("No public key found in key book","ERR_NOT_FOUND");e=r.id.publicKey}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=e)return this.log("returning found public key"),n.record=new $E(r,e,new Date).serialize(),n}let[i,s]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getCloserPeersOffline(r,e)]);return null!=i&&(this.log("had record for %b in local datastore",r),n.record=i.serialize()),s.length>0&&(this.log("had %s closer peers in routing table",s.length),n.closer=s.map((e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map((e=>e.bytes))})))),n}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t,r=tv(e);try{t=await this.datastore.get(r)}catch(e){if("ERR_NOT_FOUND"===e.code)return;throw e}let n=$E.deserialize(t);if(null==n)throw new U("Invalid record","ERR_INVALID_RECORD");if(!(null==n.timeReceived||Date.now()-n.timeReceived.getTime()>1296e5))return n;await this.datastore.delete(r)}},Lv=class{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}},Ov=class{components;validators;log;constructor(e,t){let{validators:r}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.validators=r}async handle(e,t){let r=t.key;if(this.log("%p asked us to store value for key %b",e,r),null==t.record){let t=`Empty record from: ${e.toString()}`;throw this.log.error(t),new U(t,"ERR_EMPTY_RECORD")}try{let e=$E.deserialize(t.record);await YE(this.validators,e),e.timeReceived=new Date;let n=tv(e.key);await this.components.datastore.put(n,e.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,n)}catch(e){this.log("did not put record for key %b into datastore %o",r,e)}return t}},Bv=class{handlers;routingTable;log;constructor(e,t){let{providers:r,peerRouting:n,validators:i,logPrefix:s,peerInfoMapper:o}=t;this.log=e.logger.forComponent(`${s}:rpc`),this.routingTable=t.routingTable,this.handlers={[LE.GET_VALUE.toString()]:new Pv(e,{peerRouting:n,logPrefix:s}),[LE.PUT_VALUE.toString()]:new Ov(e,{validators:i,logPrefix:s}),[LE.FIND_NODE.toString()]:new xv(e,{peerRouting:n,logPrefix:s,peerInfoMapper:o}),[LE.ADD_PROVIDER.toString()]:new Dv(e,{providers:r,logPrefix:s}),[LE.GET_PROVIDERS.toString()]:new Nv(e,{peerRouting:n,providers:r,logPrefix:s,peerInfoMapper:o}),[LE.PING.toString()]:new Lv(e,{logPrefix:s})}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(e){this.log.error("Failed to update the kbucket store",e)}let r=this.handlers[t.type];if(null!=r)return r.handle(e,t);this.log.error(`no handler found for message type: ${t.type}`)}onIncomingStream(e){Promise.resolve().then((async()=>{let{stream:t,connection:r}=e,n=r.remotePeer;try{await this.routingTable.add(n)}catch(e){this.log.error(e)}let i=this;await We(t,(e=>Ve(e)),(async function*(e){for await(let t of e){let e=FE.decode(t);i.log("incoming %s from %p",e.type,n);let r=await i.handleMessage(n,e);null!=r&&(yield FE.encode(r))}}),(e=>Le(e)),t)})).catch((e=>{this.log.error(e)}))}},Mv=class extends K{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:r,logPrefix:n}=t;this.components=e,this.log=e.logger.forComponent(`${n}:topology-listener`),this.running=!1,this.protocol=r}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new H("peer",{detail:e}))}}))}async stop(){this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}},Uv=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await ce(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(let r of this.dht.findProviders(e,t))"PROVIDER"===r.name&&(yield*r.providers)}async put(e,t,r){await ce(this.dht.put(e,t,r))}async get(e,t){for await(let r of this.dht.get(e,t))if("VALUE"===r.name)return r.value;throw new U("Not found","ERR_NOT_FOUND")}},Fv=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let r of this.dht.findPeer(e,t))if("FINAL_PEER"===r.name)return r.peer;throw new U("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(let r of this.dht.getClosestPeers(e,t))"FINAL_PEER"===r.name&&(yield r.peer)}},$v=class extends K{protocol;routingTable;providers;network;peerRouting;components;log;running;kBucketSize;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;constructor(e,t={}){super();let{kBucketSize:r,clientMode:n,validators:i,selectors:s,querySelfInterval:o,protocol:a,logPrefix:l,pingTimeout:c,pingConcurrency:u,maxInboundStreams:h,maxOutboundStreams:d,providers:f}=t,p=l??"libp2p:kad-dht";this.running=!1,this.components=e,this.log=e.logger.forComponent(p),this.protocol=a??"/ipfs/kad/1.0.0",this.kBucketSize=r??20,this.clientMode=n??!0,this.maxInboundStreams=h??32,this.maxOutboundStreams=d??64,this.peerInfoMapper=t.peerInfoMapper??ZE,this.routingTable=new kv(e,{kBucketSize:r,pingTimeout:c,pingConcurrency:u,protocol:this.protocol,logPrefix:p}),this.providers=new pv(e,f??{}),this.validators={...QE,...i},this.selectors={...GE,...s},this.network=new cv(e,{protocol:this.protocol,logPrefix:p});let g=Q();!0===t.allowQueryWithZeroPeers&&g.resolve(),this.queryManager=new wv(e,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:p,initialQuerySelfHasRun:g,routingTable:this.routingTable}),this.peerRouting=new dv(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:p}),this.contentFetching=new nv(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:p}),this.contentRouting=new ov(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:p}),this.routingTableRefresh=new Cv(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:p}),this.rpc=new Bv(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:p,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new Mv(e,{protocol:this.protocol,logPrefix:p}),this.querySelf=new vv(e,{peerRouting:this.peerRouting,interval:o,initialInterval:t.initialQuerySelfInterval,logPrefix:p,initialQuerySelfHasRun:g,routingTable:this.routingTable}),this.network.addEventListener("peer",(e=>{let t=e.detail;this.onPeerConnect(t).catch((e=>{this.log.error("could not add %p to routing table",t.id,e)})),this.dispatchEvent(new H("peer",{detail:t}))})),this.topologyListener.addEventListener("peer",(e=>{let t=e.detail;Promise.resolve().then((async()=>{let e=await this.components.peerStore.get(t),r={id:t,multiaddrs:e.addresses.map((({multiaddr:e})=>e)),protocols:e.protocols};await this.onPeerConnect(r)})).catch((e=>{this.log.error("could not add %p to routing table",t,e)}))})),this.dhtPeerRouting=new Fv(this),this.dhtContentRouting=new Uv(this),null==t.clientMode&&e.events.addEventListener("self:peer:update",(e=>{this.log("received update of self-peer info"),Promise.resolve().then((async()=>{let t=e.detail.peer.addresses.some((({multiaddr:e})=>function(e){let t=e.stringTuples();for(let e of t)if(290===e[0])return!1;if(54===t[0][0]||55===t[0][0]||56===t[0][0])return!0;if(4===t[0][0]||41===t[0][0]){let e=pp(`${t[0][1]}`);return null==e||!e}return!1}(e))),r=this.getMode();t&&"client"===r?await this.setMode("server"):"server"===r&&!t&&await this.setMode("client")})).catch((e=>{this.log.error("error setting dht server mode",e)}))}))}[Symbol.toStringTag]="@libp2p/kad-dht";[j]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"];[G]=["@libp2p/identify"];get[C](){return this.dhtContentRouting}get[O](){return this.dhtPeerRouting}get[D](){return this}async onPeerConnect(e){if(this.log("peer %p connected",e.id),0!==(e=this.peerInfoMapper(e)).multiaddrs.length)try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}else this.log("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map((e=>e.toString())))}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),"client"===e?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await z(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.topologyListener,this.routingTableRefresh)}async stop(){this.running=!1,await W(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener)}async*put(e,t,r={}){yield*this.contentFetching.put(e,t,r)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}};function Vv(e={}){return t=>new $v(t,e)}!function(e){e[e.SEND_QUERY=0]="SEND_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADD_PEER=6]="ADD_PEER",e[e.DIAL_PEER=7]="DIAL_PEER"}(Av||(Av={}));var Kv,Hv=c(E(),1).default,qv=c(A(),1);!function(e){e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"}(Kv||(Kv={}));var zv="/info/",Wv=new WeakMap,jv={dek:{keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Gv(e){return null!=e&&"string"==typeof e&&e===(0,qv.default)(e.trim())&&e.length>0}async function Yv(){let e=800*Math.random()+200;await new Promise((t=>setTimeout(t,e)))}function Qv(e){return new Nd("/pkcs8/"+e)}function Jv(e){return new Nd(zv+e)}var Zv=class{components;init;log;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=Hv(jv,t),null!=this.init.pass&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(null!=this.init.dek?.keyLength&&this.init.dek.keyLength<14)throw new Error("dek.keyLength must be least 14 bytes");if(null!=this.init.dek?.salt?.length&&this.init.dek.salt.length<16)throw new Error("dek.saltLength must be least 16 bytes");if(null!=this.init.dek?.iterationCount&&this.init.dek.iterationCount<1e3)throw new Error("dek.iterationCount must be least 1000");let r=null!=this.init.pass&&null!=this.init.dek?.salt?lu(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Wv.set(this,{dek:r})}[Symbol.toStringTag]="@libp2p/keychain";[j]=["@libp2p/keychain"];static generateOptions(){let e=Object.assign({},jv),t=3*Math.ceil(16/3);return e.dek.salt=Bn(Mo(t),"base64"),e}static get options(){return jv}async createKey(e,t,r=2048){if(!Gv(e)||"self"===e)throw await Yv(),new U("Invalid key name",Kv.ERR_INVALID_KEY_NAME);if("string"!=typeof t)throw await Yv(),new U("Invalid key type",Kv.ERR_INVALID_KEY_TYPE);let n,i=Qv(e);if(await this.components.datastore.has(i))throw await Yv(),new U("Key name already exists",Kv.ERR_KEY_ALREADY_EXISTS);if("rsa"===t.toLowerCase()&&(!Number.isSafeInteger(r)||r<2048))throw await Yv(),new U("Invalid RSA key size",Kv.ERR_INVALID_KEY_SIZE);try{let s=await Jc(t,r),o=await s.id(),a=Wv.get(this);if(null==a)throw new U("dek missing",Kv.ERR_INVALID_PARAMETERS);let l=a.dek,c=await s.export(l);n={name:e,id:o};let u=this.components.datastore.batch();u.put(i,en(c)),u.put(Jv(e),en(JSON.stringify(n))),await u.commit()}catch(e){throw await Yv(),e}return n}async listKeys(){let e={prefix:zv},t=[];for await(let r of this.components.datastore.query(e))t.push(JSON.parse(Bn(r.value)));return t}async findKeyById(e){try{let t=(await this.listKeys()).find((t=>t.id===e));if(null==t)throw new U(`Key with id '${e}' does not exist.`,Kv.ERR_KEY_NOT_FOUND);return t}catch(e){throw await Yv(),e}}async findKeyByName(e){if(!Gv(e))throw await Yv(),new U(`Invalid key name '${e}'`,Kv.ERR_INVALID_KEY_NAME);let t=Jv(e);try{let e=await this.components.datastore.get(t);return JSON.parse(Bn(e))}catch(t){throw await Yv(),this.log.error(t),new U(`Key '${e}' does not exist.`,Kv.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!Gv(e)||"self"===e)throw await Yv(),new U(`Invalid key name '${e}'`,Kv.ERR_INVALID_KEY_NAME);let t=Qv(e),r=await this.findKeyByName(e),n=this.components.datastore.batch();return n.delete(t),n.delete(Jv(e)),await n.commit(),r}async renameKey(e,t){if(!Gv(e)||"self"===e)throw await Yv(),new U(`Invalid old key name '${e}'`,Kv.ERR_OLD_KEY_NAME_INVALID);if(!Gv(t)||"self"===t)throw await Yv(),new U(`Invalid new key name '${t}'`,Kv.ERR_NEW_KEY_NAME_INVALID);let r=Qv(e),n=Qv(t),i=Jv(e),s=Jv(t);if(await this.components.datastore.has(n))throw await Yv(),new U(`Key '${t}' already exists`,Kv.ERR_KEY_ALREADY_EXISTS);try{let e=await this.components.datastore.get(r),o=await this.components.datastore.get(i),a=JSON.parse(Bn(o));a.name=t;let l=this.components.datastore.batch();return l.put(n,e),l.put(s,en(JSON.stringify(a))),l.delete(r),l.delete(i),await l.commit(),a}catch(e){throw await Yv(),e}}async exportKey(e,t){if(!Gv(e))throw await Yv(),new U(`Invalid key name '${e}'`,Kv.ERR_INVALID_KEY_NAME);if(null==t)throw await Yv(),new U("Password is required",Kv.ERR_PASSWORD_REQUIRED);let r=Qv(e);try{let e=Bn(await this.components.datastore.get(r)),n=Wv.get(this);if(null==n)throw new U("dek missing",Kv.ERR_INVALID_PARAMETERS);let i=n.dek;return await(await nu(e,i)).export(t)}catch(e){throw await Yv(),e}}async exportPeerId(e){let t="temporary-password",r=await this.exportKey(e,t),n=await nu(r,t);return Qn(n.public.bytes,n.bytes)}async importKey(e,t,r){if(!Gv(e)||"self"===e)throw await Yv(),new U(`Invalid key name '${e}'`,Kv.ERR_INVALID_KEY_NAME);if(null==t)throw await Yv(),new U("PEM encoded key is required",Kv.ERR_PEM_REQUIRED);let n,i,s=Qv(e);if(await this.components.datastore.has(s))throw await Yv(),new U(`Key '${e}' already exists`,Kv.ERR_KEY_ALREADY_EXISTS);try{n=await nu(t,r)}catch{throw await Yv(),new U("Cannot read the key, most likely the password is wrong",Kv.ERR_CANNOT_READ_KEY)}try{i=await n.id();let e=Wv.get(this);if(null==e)throw new U("dek missing",Kv.ERR_INVALID_PARAMETERS);let r=e.dek;t=await n.export(r)}catch(e){throw await Yv(),e}let o={name:e,id:i},a=this.components.datastore.batch();return a.put(s,en(t)),a.put(Jv(e),en(JSON.stringify(o))),await a.commit(),o}async importPeer(e,t){try{if(!Gv(e))throw new U(`Invalid key name '${e}'`,Kv.ERR_INVALID_KEY_NAME);if(null==t)throw new U("PeerId is required",Kv.ERR_MISSING_PRIVATE_KEY);if(null==t.privateKey)throw new U("PeerId.privKey is required",Kv.ERR_MISSING_PRIVATE_KEY);let r=await tu(t.privateKey),n=Qv(e);if(await this.components.datastore.has(n))throw await Yv(),new U(`Key '${e}' already exists`,Kv.ERR_KEY_ALREADY_EXISTS);let i=Wv.get(this);if(null==i)throw new U("dek missing",Kv.ERR_INVALID_PARAMETERS);let s=i.dek,o=await r.export(s),a={name:e,id:t.toString()},l=this.components.datastore.batch();return l.put(n,en(o)),l.put(Jv(e),en(JSON.stringify(a))),await l.commit(),a}catch(e){throw await Yv(),e}}async getPrivateKey(e){if(!Gv(e))throw await Yv(),new U(`Invalid key name '${e}'`,Kv.ERR_INVALID_KEY_NAME);try{let t=Qv(e);return Bn(await this.components.datastore.get(t))}catch(t){throw await Yv(),this.log.error(t),new U(`Key '${e}' does not exist.`,Kv.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if("string"!=typeof e)throw await Yv(),new U(`Invalid old pass type '${typeof e}'`,Kv.ERR_INVALID_OLD_PASS_TYPE);if("string"!=typeof t)throw await Yv(),new U(`Invalid new pass type '${typeof t}'`,Kv.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await Yv(),new U(`Invalid pass length ${t.length}`,Kv.ERR_INVALID_PASS_LENGTH);this.log("recreating keychain");let r=Wv.get(this);if(null==r)throw new U("dek missing",Kv.ERR_INVALID_PARAMETERS);let n=r.dek;this.init.pass=t;let i=null!=t&&null!=this.init.dek?.salt?lu(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Wv.set(this,{dek:i});let s=await this.listKeys();for(let e of s){let t=Bn(await this.components.datastore.get(Qv(e.name))),r=await nu(t,n),s=i.toString(),o=await r.export(s),a=this.components.datastore.batch(),l={name:e.name,id:e.id};a.put(Qv(e.name),en(o)),a.put(Jv(e.name),en(JSON.stringify(l))),await a.commit()}this.log("keychain reconstructed")}};function Xv(e={}){return t=>new Zv(t,e)}var eS,tS=class{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??1e3*this.duration/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new rS}async consume(e,t=1,r={}){let n=this.getKey(e),i=this._getKeySecDuration(r),s=this.memoryStorage.incrby(n,t,i);if(s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.consumedPoints>this.points)throw this.blockDuration>0&&s.consumedPoints<=this.points+t&&(s=this.memoryStorage.set(n,s.consumedPoints,this.blockDuration)),new U("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",s);if(this.execEvenly&&s.msBeforeNext>0&&!s.isFirstInDuration){let e=Math.ceil(s.msBeforeNext/(s.remainingPoints+2));e<this.execEvenlyMinDelayMs&&(e=s.consumedPoints*this.execEvenlyMinDelayMs),await aE(e)}return s}penalty(e,t=1,r={}){let n=this.getKey(e),i=this._getKeySecDuration(r),s=this.memoryStorage.incrby(n,t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}reward(e,t=1,r={}){let n=this.getKey(e),i=this._getKeySecDuration(r),s=this.memoryStorage.incrby(n,-t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}block(e,t){let r=1e3*t,n=this.points+1;return this.memoryStorage.set(this.getKey(e),n,t),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:n,isFirstInDuration:!1}}set(e,t,r=0){let n=1e3*(r>=0?r:this.duration);return this.memoryStorage.set(this.getKey(e),t,r),{remainingPoints:0,msBeforeNext:0===n?-1:n,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return null!=t&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return null!=e?.customDuration&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},rS=class{storage;constructor(){this.storage=new Map}incrby(e,t,r){let n=this.storage.get(e);if(null!=n){let i=null!=n.expiresAt?n.expiresAt.getTime()-(new Date).getTime():-1;return null==n.expiresAt||i>0?(n.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:n.value,isFirstInDuration:!1}):this.set(e,t,r)}return this.set(e,t,r)}set(e,t,r){let n=1e3*r,i=this.storage.get(e);null!=i&&clearTimeout(i.timeoutId);let s={value:t,expiresAt:n>0?new Date(Date.now()+n):void 0};return this.storage.set(e,s),n>0&&(s.timeoutId=setTimeout((()=>{this.storage.delete(e)}),n),null!=s.timeoutId.unref&&s.timeoutId.unref()),{remainingPoints:0,msBeforeNext:0===n?-1:n,consumedPoints:s.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(null!=t)return{remainingPoints:0,msBeforeNext:null!=t.expiresAt?t.expiresAt.getTime()-(new Date).getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return null!=t&&(null!=t.timeoutId&&clearTimeout(t.timeoutId),this.storage.delete(e),!0)}};!function(e){e[e.NEW_STREAM=0]="NEW_STREAM",e[e.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",e[e.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",e[e.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",e[e.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",e[e.RESET_RECEIVER=5]="RESET_RECEIVER",e[e.RESET_INITIATOR=6]="RESET_INITIATOR"}(eS||(eS={}));var nS=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),iS=Object.freeze({NEW_STREAM:eS.NEW_STREAM,MESSAGE:eS.MESSAGE_INITIATOR,CLOSE:eS.CLOSE_INITIATOR,RESET:eS.RESET_INITIATOR}),sS=Object.freeze({MESSAGE:eS.MESSAGE_RECEIVER,CLOSE:eS.CLOSE_RECEIVER,RESET:eS.RESET_RECEIVER}),oS=1<<20,aS=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=oS,t=4194304){this._buffer=new xe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(null==e||0===e.length)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});let t=[];for(;0!==this._buffer.length;){if(null==this._headerInfo)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(e){if("ERR_MSG_TOO_BIG"===e.code)throw e;break}let{id:e,type:r,length:n,offset:i}=this._headerInfo;if(this._buffer.length-i<n)break;let s={id:e,type:r};(r===eS.NEW_STREAM||r===eS.MESSAGE_INITIATOR||r===eS.MESSAGE_RECEIVER)&&(s.data=this._buffer.sublist(i,i+n)),t.push(s),this._buffer.consume(i+n),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:r}=uS(e),{value:n,offset:i}=uS(e,r),s=7&t;if(null==nS[s])throw new Error(`Invalid type received: ${s}`);if(n>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:s,offset:r+i,length:n}}},lS=128,cS=127;function uS(e,t=0){let r,n=0,i=0,s=t,o=e.length;do{if(s>=o||i>49)throw t=0,new RangeError("Could not decode varint");r=e.get(s++),n+=i<28?(r&cS)<<i:(r&cS)*Math.pow(2,i),i+=7}while(r>=lS);return{value:n,offset:t=s-t}}var hS=10240,dS=new class{_pool;_poolOffset;constructor(){this._pool=he(hS),this._poolOffset=0}write(e,t){let r=this._pool,n=this._poolOffset;Ae(e.id<<3|e.type,r,n),n+=ve(e.id<<3|e.type),e.type!==eS.NEW_STREAM&&e.type!==eS.MESSAGE_INITIATOR&&e.type!==eS.MESSAGE_RECEIVER||null==e.data?(Ae(0,r,n),n+=ve(0)):(Ae(e.data.length,r,n),n+=ve(e.data.length));let i=r.subarray(this._poolOffset,n);hS-n<100?(this._pool=he(hS),this._poolOffset=0):this._poolOffset=n,t.append(i),(e.type===eS.NEW_STREAM||e.type===eS.MESSAGE_INITIATOR||e.type===eS.MESSAGE_RECEIVER)&&null!=e.data&&t.append(e.data)}},fS=class extends $w{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types="outbound"===e.direction?iS:sS,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:iS.NEW_STREAM,data:new xe(en(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function pS(e){let t={...e,type:`${nS[e.type]} (${e.type})`};return e.type===eS.NEW_STREAM&&(t.data=Bn(e.data instanceof Uint8Array?e.data:e.data.subarray())),(e.type===eS.MESSAGE_INITIATOR||e.type===eS.MESSAGE_RECEIVER)&&(t.data=Bn(e.data instanceof Uint8Array?e.data:e.data.subarray(),"base16")),t}var gS=class{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??500,this.sink=this._createSink(),this._source=ee({objectMode:!0,onEnd:()=>{for(let e of this._streams.initiators.values())e.destroy();for(let e of this._streams.receivers.values())e.destroy()}}),this.source=We(this._source,(e=>async function*(e){for await(let t of e){let e=new xe;dS.write(t,e),yield e}}(e))),this.closeController=new AbortController,this.rateLimiter=new tS({points:t.disconnectThreshold??5,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");let t=this._streamId++;e=null==e?t.toString():e.toString();let r=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:r})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map((async e=>e.close({signal:t})))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(e){this.abort(e)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach((t=>{t.abort(e)})),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:r}=e,n=this._streams.receivers;return this._newStream({id:t,name:r,type:"receiver",registry:n})}_newStream(e){let{id:t,name:r,type:n,registry:i}=e;if(this.log("new %s stream %s",n,t),"initiator"===n&&this._streams.initiators.size===(this._init.maxOutboundStreams??1024))throw new U("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(t))throw new Error(`${n} stream ${t} already exists!`);let s=function(e){let{id:t,name:r,send:n,onEnd:i,type:s="initiator",maxMsgSize:o=oS}=e;return new fS({id:"initiator"===s?`i${t}`:`r${t}`,streamId:t,name:`${r??t}`,direction:"initiator"===s?"outbound":"inbound",maxDataSize:o,onEnd:i,send:n,log:e.logger.forComponent(`libp2p:mplex:stream:${s}:${t}`)})}({id:t,name:r,send:async e=>{this.log.enabled&&this.log.trace("%s stream %s send",n,t,pS(e)),this._source.push(e)},type:n,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",n,t,s.protocol),i.delete(t),null!=this._init.onStreamEnd&&this._init.onStreamEnd(s)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return i.set(t,s),s}_createSink(){return async e=>{let t=()=>{Mw(e,this.log)};this.closeController.signal.addEventListener("abort",t);try{let t=new aS(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let r of e)for(let e of t.write(r))await this._handleIncoming(e);this._source.end()}catch(e){this.log("error in sink",e),this._source.end(e)}finally{this.closeController.signal.removeEventListener("abort",t)}}}async _handleIncoming(e){let{id:t,type:r}=e;if(this.log.enabled&&this.log.trace("incoming message",pS(e)),e.type===eS.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??1024)){this.log("too many inbound streams open"),this._source.push({id:t,type:eS.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{return this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),void this.abort(new Error("Too many open streams"))}return}let r=this._newReceiverStream({id:t,name:Bn(e.data instanceof Uint8Array?e.data:e.data.subarray())});return void(null!=this._init.onIncomingStream&&this._init.onIncomingStream(r))}let n=(1&~r?this._streams.receivers:this._streams.initiators).get(t);if(null==n){this.log("missing stream %s for message type %s",t,nS[r]);try{await this.rateLimiter.consume("missing-stream",1)}catch{return this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),void this.abort(new Error("Too many messages for missing streams"))}return}let i=this._init.maxStreamBufferSize??4194304;try{switch(r){case eS.MESSAGE_INITIATOR:case eS.MESSAGE_RECEIVER:if(n.sourceReadableLength()>i)throw this._source.push({id:e.id,type:r===eS.MESSAGE_INITIATOR?eS.RESET_RECEIVER:eS.RESET_INITIATOR}),new U("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");n.sourcePush(e.data);break;case eS.CLOSE_INITIATOR:case eS.CLOSE_RECEIVER:n.remoteCloseWrite();break;case eS.RESET_INITIATOR:case eS.RESET_RECEIVER:n.reset();break;default:this.log("unknown message type %s",r)}}catch(e){this.log.error("error while processing message",e),n.abort(e)}}},mS=class{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[j]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new gS(this.components,{...e,...this._init})}};function yS(e={}){return t=>new mS(t,e)}var wS,bS="ERR_WRONG_PING_ACK",ES=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnTransientConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnTransientConnection=t.runOnTransientConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,r=Date.now();AbortSignal.timeout(this.timeout).addEventListener("abort",(()=>{t?.abort(new U("ping timeout",$))})),We(t,(async function*(e){let r=0;for await(let n of e){if(r+=n.byteLength,r>32)return void t?.abort(new U("Too much data received",V));yield n}}),t).catch((r=>{this.log.error("incoming ping from %p failed with error",e.connection.remotePeer,r),t?.abort(r)})).finally((()=>{let t=Date.now()-r;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,t)}))}async ping(e,t={}){this.log("pinging %p",e);let r,n=Date.now(),i=Mo(32),s=await this.components.connectionManager.openConnection(e,t),o=()=>{};if(null==t.signal){let e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{r=await s.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),o=()=>{r?.abort(new U("ping timeout",$))},t.signal?.addEventListener("abort",o,{once:!0});let e=await We([i],r,(async e=>hm(e))),a=Date.now()-n;if(null==e)throw new U(`Did not receive a ping ack after ${a}ms`,bS);if(!ke(i,e.subarray()))throw new U(`Received wrong ping ack after ${a}ms`,bS);return this.log("ping %p complete in %dms",s.remotePeer,a),a}catch(e){throw this.log.error("error while pinging %p",s.remotePeer,e),r?.abort(e),e}finally{t.signal?.removeEventListener("abort",o),null!=r&&await r.close()}}};function vS(e={}){return t=>new ES(t,e)}!function(e){e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",e.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",e.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"}(wS||(wS={}));var SS=class extends U{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}},RS=class extends SS{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,wS.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}};function AS(e,t){return new RS(e,t)}var _S=class extends SS{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,wS.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}};function IS(e){return new _S(e)}var kS=class extends SS{constructor(e){super(`There was a problem with a provided argument: ${e}`,wS.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}};function TS(e){return new kS(e)}var CS=class extends SS{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,wS.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}};function DS(e,t){return new CS(e,t)}var xS=class extends SS{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,wS.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}},NS=class extends SS{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `,wS.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}},PS=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)(n||!(i in t))&&(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},LS=function(e,t,r){this.name=e,this.version=t,this.os=r,this.type="browser"},OS=function(e){this.version=e,this.type="node",this.name="node",this.os=process.platform},BS=function(e,t,r,n){this.name=e,this.version=t,this.os=r,this.bot=n,this.type="bot-device"},MS=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},US=function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null},FS=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,$S=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],VS=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function KS(e){var t=function(e){return""!==e&&$S.reduce((function(t,r){var n=r[0],i=r[1];if(t)return t;var s=i.exec(e);return!!s&&[n,s]}),!1)}(e);if(!t)return null;var r=t[0],n=t[1];if("searchbot"===r)return new MS;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<3&&(i=PS(PS([],i,!0),function(e){for(var t=[],r=0;r<e;r++)t.push("0");return t}(3-i.length),!0)):i=[];var s=i.join("."),o=function(e){for(var t=0,r=VS.length;t<r;t++){var n=VS[t],i=n[0];if(n[1].exec(e))return i}return null}(e),a=FS.exec(e);return a&&a[1]?new BS(r,s,o,a[1]):new LS(r,s,o)}var HS=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],qS=typeof document>"u"&&typeof navigator<"u"&&"ReactNative"===navigator.product?new US:typeof navigator<"u"?KS(navigator.userAgent):typeof process<"u"&&process.version?new OS(process.version.slice(1)):null,zS=null!=qS&&"firefox"===qS.name,WS=async function*(){},jS=async e=>{};async function GS(e){return"function"==typeof(e=e??{})&&(e=await e()),e.iceServers=e.iceServers??HS.map((e=>({urls:[e]}))),e}var YS,QS=class{log;peerConnection;remoteAddr;timeline;metrics;source=WS();sink=jS;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;let r=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",r),("disconnected"===this.peerConnection.connectionState||"failed"===this.peerConnection.connectionState||"closed"===this.peerConnection.connectionState)&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};!function(e){let t;var r;let n,i;(r=t=e.Flag||(e.Flag={})).FIN="FIN",r.STOP_SENDING="STOP_SENDING",r.RESET="RESET",r.FIN_ACK="FIN_ACK",function(e){e[e.FIN=0]="FIN",e[e.STOP_SENDING=1]="STOP_SENDING",e[e.RESET=2]="RESET",e[e.FIN_ACK=3]="FIN_ACK"}(n||(n={})),function(e){e.codec=()=>wn(n)}(t=e.Flag||(e.Flag={})),e.codec=()=>(null==i&&(i=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.flag&&(r.uint32(8),e.Flag.codec().encode(t.flag,r)),null!=t.message&&(r.uint32(18),r.bytes(t.message)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.flag=e.Flag.codec().decode(t);break;case 2:n.message=t.bytes();break;default:t.skipType(7&r)}}return n}))),i),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(YS||(YS={}));var JS=16384,ZS=function(e=JS){let t=ve(e-ve(e)),r=1+ve(Object.keys(YS.Flag).length-1);return t+r+1+ve(e-t-r-1)}(),XS=class extends $w{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;constructor(e){let t=e.onEnd;switch(e.onEnd=e=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve((async()=>{if(null==this.timeline.abort&&null===this.timeline.reset)try{await Wu(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(e){this.log.error("error receiving FIN_ACK",e)}})).then((()=>{this.incomingData.end(),t?.(e)})).catch((e=>{this.log.error("error ending stream",e)}))},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=ee(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??3e4,this.maxBufferedAmount=e.maxBufferedAmount??2097152,this.maxMessageSize=(e.maxMessageSize??JS)-ZS,this.receiveFinAck=Q(),this.finAckTimeout=e.closeTimeout??5e3,this.openTimeout=e.openTimeout??5e3,this.channel.readyState){case"open":this.timeline.open=(new Date).getTime();break;case"closed":case"closing":(void 0===this.timeline.close||0===this.timeline.close)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new U("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=e=>{this.timeline.open=(new Date).getTime()},this.channel.onclose=e=>{this.receiveFinAck.resolve(),this.close().catch((e=>{this.log.error("error closing stream after channel closed",e)}))},this.channel.onerror=e=>{let t=e.error;this.abort(t)},this.channel.onmessage=async e=>{let{data:t}=e;null===t||0===t.byteLength||this.incomingData.push(new Uint8Array(t,0,t.byteLength))};let r=this;Promise.resolve().then((async()=>{for await(let e of Ve(this.incomingData)){let t=r.processIncomingProtobuf(e);null!=t&&r.sourcePush(new xe(t))}})).catch((e=>{this.log.error("error processing incoming data channel messages",e)}))}sendNewStream(){}async _sendMessage(e,t=!0){if(t&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Ev(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(e){throw e instanceof Ku?new U(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):e}if("closed"===this.channel.readyState||"closing"===this.channel.readyState)throw new U(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");"open"!==this.channel.readyState&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Ev(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxMessageSize),r=e.subarray(0,t),n=YS.encode({message:r}),i=Le.single(n);await this._sendMessage(i),e.consume(t)}}async sendReset(){await this._sendFlag(YS.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(YS.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await ie(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(e){this.log.error("failed to await FIN_ACK",e)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(YS.Flag.STOP_SENDING)}processIncomingProtobuf(e){let t=YS.decode(e);if(void 0!==t.flag&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===YS.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(YS.Flag.FIN_ACK).catch((e=>{this.log.error("error sending FIN_ACK immediately",e)}))),t.flag===YS.Flag.RESET&&this.reset(),t.flag===YS.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===YS.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),"ready"===this.readStatus)return t.message}async _sendFlag(e){if("open"!==this.channel.readyState)return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());let t=YS.encode({flag:e}),r=Le.single(t);try{return await this._sendMessage(r,!1),!0}catch(t){this.log.error("could not send flag %s",e.toString(),t)}return!1}};function eR(e){let{channel:t,direction:r}=e;return new XS({id:"inbound"===r?`i${t.id}`:`r${t.id}`,log:e.logger.forComponent(`libp2p:webrtc:stream:${r}:${t.id}`),...e})}var tR,rR="/webrtc",nR=class{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??rR,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:t})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',t.id),"init"===t.label)return this.log.trace("closing early init channel"),void t.close();let r={},n=eR({channel:t,direction:"inbound",onEnd:e=>{r.onEnd(e)},logger:e.logger,...this.dataChannelOptions});r.stream=n,r.channel=t,r.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter((e=>e.stream.id!==n.id))},this.bufferedStreams.push(r)}}createStreamMuxer(e){return new iR(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}},iR=class{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map((e=>e.stream)),this.peerConnection=t.peerConnection,this.protocol=t.protocol??rR,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:e})=>{if(this.log.trace("incoming datachannel with channel id %d",e.id),"init"===e.label)return this.log.trace("closing init channel"),void e.close();let r=eR({channel:e,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",e.id,e.readyState),this.#e(r,e)},logger:this.logger,...this.dataChannelOptions});this.streams.push(r),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(r)},this.init.streams.length>0&&queueMicrotask((()=>{this.init.streams.forEach((e=>{e.onEnd=()=>{this.log("incoming early channel %s ended with state %s",e.channel.id,e.channel.readyState),this.#e(e.stream,e.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(e.stream)}))}))}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),function(e,t,r=3e4,n){"open"===e.readyState&&Promise.resolve().then((async()=>{if(e.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",t,e.bufferedAmount);let i=Q(),s=!1;e.bufferedAmountLowThreshold=0;let o=()=>{s||(n.log("%s drain channel closed before drain",t),i.resolve())};e.addEventListener("close",o,{once:!0}),e.addEventListener("bufferedamountlow",(()=>{s=!0,e.removeEventListener("close",o),i.resolve()})),await Wu(i.promise,{milliseconds:r})}})).then((async()=>{"open"===e.readyState&&e.close()})).catch((e=>{n.log.error("error closing outbound stream",e)}))}(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter((t=>t.id!==e.id)),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map((async t=>t.close(e))))}catch(e){this.abort(e)}}abort(e){for(let t of this.streams)t.abort(e)}source=WS();sink=jS;newStream(){let e=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",e.id);let t=eR({channel:e,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",e.id,e.readyState),this.#e(t,e)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}},sR=globalThis.RTCPeerConnection,oR=globalThis.RTCSessionDescription,aR=globalThis.RTCIceCandidate;!function(e){let t;var r;let n,i;(r=t=e.Type||(e.Type={})).SDP_OFFER="SDP_OFFER",r.SDP_ANSWER="SDP_ANSWER",r.ICE_CANDIDATE="ICE_CANDIDATE",function(e){e[e.SDP_OFFER=0]="SDP_OFFER",e[e.SDP_ANSWER=1]="SDP_ANSWER",e[e.ICE_CANDIDATE=2]="ICE_CANDIDATE"}(n||(n={})),function(e){e.codec=()=>wn(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==i&&(i=bn(((t,r,n={})=>{!1!==n.lengthDelimited&&r.fork(),null!=t.type&&(r.uint32(8),e.Type.codec().encode(t.type,r)),null!=t.data&&(r.uint32(18),r.string(t.data)),!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.type=e.Type.codec().decode(t);break;case 2:n.data=t.string();break;default:t.skipType(7&r)}}return n}))),i),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(tR||(tR={}));var lR=async(e,t,r)=>{try{let n=Q();for(function(e,t){e[zS?"oniceconnectionstatechange":"onconnectionstatechange"]=r=>{switch(function(e){return zS?e.iceConnectionState:e.connectionState}(e)){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new U("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"))}}}(e,n);;){let i=await Promise.race([n.promise,t.read({signal:r.signal}).catch((()=>{}))]);if(null==i){r.signal?.throwIfAborted();break}if(i.type!==tR.Type.ICE_CANDIDATE)throw new U("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");let s=JSON.parse(i.data??"null");if(""===s||null===s){r.onProgress?.(new Xe("webrtc:end-of-ice-candidates")),r.log.trace("end-of-candidates received");continue}let o=new aR(s);r.log.trace("%s received new ICE candidate %o",r.direction,s);try{r.onProgress?.(new Xe("webrtc:add-ice-candidate",o.candidate)),await e.addIceCandidate(o)}catch(e){r.log.error("%s bad candidate received",r.direction,s,e)}}}catch(e){if(r.log.error("%s error parsing ICE candidate",r.direction,e),!0===r.signal?.aborted)throw e}};var cR=class extends K{peerId;transportManager;shutdownController;constructor(e,t){super(),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter((e=>e!==this)).map((e=>e.getAddrs().filter((e=>Rb.matches(e))).map((e=>e.encapsulate(`/webrtc/p2p/${this.peerId}`))))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}},uR="/webrtc",hR="/p2p-circuit",dR="/webrtc-signaling/0.0.1",fR=class{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[B]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[j]=["@libp2p/transport"];[G]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(dR,(e=>{this._onProtocol(e).catch((t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)}))}),{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(dR),this._started=!1}createListener(e){return new cR(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(_g.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);let{remoteAddress:r,peerConnection:n,muxerFactory:i}=await async function({rtcConfiguration:e,dataChannel:t,signal:r,metrics:n,multiaddr:i,connectionManager:s,transportManager:o,log:a,logger:l,onProgress:c}){let{baseAddr:u}=function(e){let t=e.toString().split(uR+"/");if(2!==t.length)throw new U("webrtc protocol was not present in multiaddr",wS.ERR_INVALID_MULTIADDR);if(!t[0].includes(hR))throw new U("p2p-circuit protocol was not present in multiaddr",wS.ERR_INVALID_MULTIADDR);let r=Hp(t[0]),n=Hp("/"+t[1]).getPeerId();if(null==n)throw new U("destination peer id was missing",wS.ERR_INVALID_MULTIADDR);let i=r.protos().pop();if(void 0===i)throw new U("invalid multiaddr",wS.ERR_INVALID_MULTIADDR);return"p2p"!==i.name&&(r=r.encapsulate(`/p2p/${n}`)),{baseAddr:r,peerId:Gn(n)}}(i);n?.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",u);let h=u.getPeerId();if(null==h)throw new U("Relay peer was missing","ERR_INVALID_ADDRESS");let d,f=s.getConnections(Gn(h)),p=!1;0===f.length?(c?.(new Xe("webrtc:dial-relay")),d=await o.dial(u,{signal:r,onProgress:c}),p=!0):(c?.(new Xe("webrtc:reuse-relay-connection")),d=f[0]);try{c?.(new Xe("webrtc:open-signaling-stream"));let n=await d.newStream(dR,{signal:r,runOnTransientConnection:!0}),s=Mb(n).pb(tR),o=new sR(e),u=new nR({logger:l},{peerConnection:o,dataChannelOptions:t});try{let e=o.createDataChannel("init");o.onicecandidate=({candidate:e})=>{let t=JSON.stringify(e?.toJSON()??null);a.trace("initiator sending ICE candidate %o",e),s.write({type:tR.Type.ICE_CANDIDATE,data:t},{signal:r}).catch((e=>{a.error("error sending ICE candidate",e)}))},o.onicecandidateerror=e=>{a.error("initiator ICE candidate error",e)};let t=await o.createOffer().catch((e=>{throw a.error("could not execute createOffer",e),new U("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")}));a.trace("initiator send SDP offer %s",t.sdp),c?.(new Xe("webrtc:send-sdp-offer")),await s.write({type:tR.Type.SDP_OFFER,data:t.sdp},{signal:r}),await o.setLocalDescription(t).catch((e=>{throw a.error("could not execute setLocalDescription",e),new U("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")})),c?.(new Xe("webrtc:read-sdp-answer"));let l=await s.read({signal:r});if(l.type!==tR.Type.SDP_ANSWER)throw new U("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",l.data);let h=new oR({type:"answer",sdp:l.data});return await o.setRemoteDescription(h).catch((e=>{throw a.error("could not execute setRemoteDescription",e),new U("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")})),a.trace("initiator read candidates until connected"),c?.(new Xe("webrtc:read-ice-candidates")),await lR(o,s,{direction:"initiator",signal:r,log:a,onProgress:c}),a.trace("initiator connected, closing init channel"),e.close(),c?.(new Xe("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await n.close({signal:r}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:o,muxerFactory:u}}catch(e){throw a.error("outgoing signaling error",e),o.close(),n.abort(e),e}finally{o.onicecandidate=null,o.onicecandidateerror=null}}finally{if(p)try{await d.close({signal:r})}catch(e){d.abort(e)}}}({rtcConfiguration:await GS(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),s=new QS(this.components,{peerConnection:n,timeline:{open:Date.now()},remoteAddr:r,metrics:this.metrics?.dialerEvents}),o=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress});return this._closeOnShutdown(n,s),o}async _onProtocol({connection:e,stream:t}){let r=AbortSignal.timeout(this.init.inboundConnectionTimeout??3e4),n=new sR(await GS(this.init.rtcConfiguration)),i=new nR(this.components,{peerConnection:n,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:s}=await async function({peerConnection:e,stream:t,signal:r,connection:n,log:i}){i.trace("new inbound signaling stream");let s=Mb(t).pb(tR);try{e.onicecandidate=({candidate:e})=>{let t=JSON.stringify(e?.toJSON()??null);i.trace("recipient sending ICE candidate %s",t),s.write({type:tR.Type.ICE_CANDIDATE,data:t},{signal:r}).catch((e=>{i.error("error sending ICE candidate",e)}))};let t=await s.read({signal:r});if(t.type!==tR.Type.SDP_OFFER)throw new U(`expected message type SDP_OFFER, received: ${t.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");i.trace("recipient receive SDP offer %s",t.data);let n=new oR({type:"offer",sdp:t.data});await e.setRemoteDescription(n).catch((e=>{throw i.error("could not execute setRemoteDescription",e),new U("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}));let o=await e.createAnswer().catch((e=>{throw i.error("could not execute createAnswer",e),new U("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")}));i.trace("recipient send SDP answer %s",o.sdp),await s.write({type:tR.Type.SDP_ANSWER,data:o.sdp},{signal:r}),await e.setLocalDescription(o).catch((e=>{throw i.error("could not execute setLocalDescription",e),new U("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")})),i.trace("recipient read candidates until connected"),await lR(e,s,{direction:"recipient",signal:r,log:i})}catch(t){if("connected"!==e.connectionState)throw i.error("error while handling signaling stream from peer %a",n.remoteAddr,t),e.close(),t;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,t)}let o=Hp(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",o),{remoteAddress:o}}({peerConnection:n,connection:e,stream:t,signal:r,log:this.log});await t.close({signal:r});let o=new QS(this.components,{peerConnection:n,timeline:{open:(new Date).getTime()},remoteAddr:s,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(o,{skipEncryption:!0,skipProtection:!0,muxerFactory:i}),this._closeOnShutdown(n,o)}catch(e){throw this.log.error("incoming signaling error",e),n.close(),t.abort(e),e}}_closeOnShutdown(e,t){let r=()=>{t.close().catch((e=>{this.log.error("could not close WebRTCMultiaddrConnection",e)}))};this.shutdownController.signal.addEventListener("abort",r),e.addEventListener("close",(()=>{this.shutdownController.signal.removeEventListener("abort",r)}))}},pR=Object.values(Yr).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)));var gR=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function mR(e){let t=e.stringTuples().filter((e=>e[0]===vR)).map((e=>e[1]))[0];if(void 0===t||""===t)throw IS(`Couldn't find a certhash component of multiaddr: ${e.toString()}`);return t}function yR(e){return ur.decode(pR.decode(e))}function wR(e){switch(e){case 17:return"SHA-1";case 18:return"SHA-256";case 19:return"SHA-512";default:throw function(e){return new NS(e)}(e)}}function bR(e,t){let{host:r,port:n}=e.toOptions(),i=function(e){for(let t of e.protoNames())if(t.startsWith("ip"))return t.toUpperCase();return"IP6"}(e),[s]=function(e){let t=yR(mR(e)),r=wR(t.code),n=t.digest.reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),""),i=n.match(/.{1,2}/g);if(null==i)throw DS(n,e.toString());return[`${r} ${i.join(":").toUpperCase()}`,n]}(e);return`v=0\no=- 0 0 IN ${i} ${r}\ns=-\nc=IN ${i} ${r}\nt=0 0\na=ice-lite\nm=application ${n} UDP/DTLS/SCTP webrtc-datachannel\na=mid:0\na=setup:passive\na=ice-ufrag:${t}\na=ice-pwd:${t}\na=fingerprint:${s}\na=sctp-port:5000\na=max-message-size:16384\na=candidate:1467250027 1 UDP 1467250027 ${r} ${n} typ host\r\n`}var ER=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),vR=(vp("webrtc-direct").code,vp("certhash").code),SR=class{log;metrics;components;init;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[B]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[j]=["@libp2p/transport"];async dial(e,t){let r=await this._connect(e,t);return this.log("dialing address: %a",e),r}createListener(e){throw new xS("WebRTCTransport.createListener")}listenFilter(e){return e.filter(Eg.exactMatch)}dialFilter(e){return this.listenFilter(e)}async _connect(e,t){let r=new AbortController,n=r.signal,i=e.getPeerId();if(null===i)throw IS("we need to have the remote's PeerId");let s=Gn(i),o=yR(mR(e)),a=await sR.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:wR(o.code)}),l=new sR({...await GS(this.init.rtcConfiguration),certificates:[a]});try{let i=new Promise(((e,t)=>{let r=l.createDataChannel("",{negotiated:!0,id:0}),n=setTimeout((()=>{let e=`Data channel was never opened: state: ${r.readyState}`;this.log.error(e),this.metrics?.dialerEvents.increment({open_error:!0}),t(AS("data",e))}),1e4);r.onopen=t=>{clearTimeout(n),e(r)},r.onerror=e=>{clearTimeout(n);let r=`Error opening a data channel for handshaking: ${e.target?.toString()??"not specified"}`;this.log.error(r),this.metrics?.dialerEvents.increment({unknown_error:!0}),t(AS("data",r))}})),a="libp2p+webrtc+v1/"+[...Array(32)].map((()=>ER.at(Math.floor(Math.random()*ER.length)))).join(""),c=function(e,t){if(void 0===e.sdp)throw TS("Can't munge a missing SDP");return e.sdp=e.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,"\na=ice-ufrag:"+t+"\n").replace(/\na=ice-pwd:[^\n]*\n/,"\na=ice-pwd:"+t+"\n"),e}(await l.createOffer(),a);await l.setLocalDescription(c);let u=function(e,t){return{type:"answer",sdp:bR(e,t)}}(e,a);await l.setRemoteDescription(u);let h=await i,d=this.components.peerId,f=mw({prologueBytes:this.generateNoisePrologue(l,o.code,e)})(this.components),p=eR({channel:h,direction:"inbound",logger:this.components.logger,...this.init.dataChannel??{}}),g={...p,sink:p.sink.bind(p),source:async function*(){for await(let e of p.source)for(let t of e)yield t}()},m=new QS(this.components,{peerConnection:l,remoteAddr:e,timeline:{open:Date.now()},metrics:this.metrics?.dialerEvents}),y=zS?"iceconnectionstatechange":"connectionstatechange";l.addEventListener(y,(()=>{switch(l.connectionState){case"failed":case"disconnected":case"closed":m.close().catch((e=>{this.log.error("error closing connection",e)})).finally((()=>{r.abort()}))}}),{signal:n}),this.metrics?.dialerEvents.increment({peer_connection:!0});let w=new nR(this.components,{peerConnection:l,metrics:this.metrics?.dialerEvents,dataChannelOptions:this.init.dataChannel});return await f.secureInbound(d,g,s),await t.upgrader.upgradeOutbound(m,{skipProtection:!0,skipEncryption:!0,muxerFactory:w})}catch(e){throw l.close(),e}}generateNoisePrologue(e,t,r){if(0===e.getConfiguration().certificates?.length)throw TS("no local certificate");let n=function(e,t){let r=e.getConfiguration().certificates?.at(0);if(null==r?.getFingerprints){t.log.trace("fetching fingerprint from local SDP");let r=e.localDescription;return null==r?void 0:function(e){return e.match(gR)?.groups?.fingerprint}(r.sdp)}if(t.log.trace("fetching fingerprint from local certificate"),0===r.getFingerprints().length)return;let n=r.getFingerprints()[0].value;if(null==n)throw DS("","no fingerprint on local certificate");return n}(e,{log:this.log});if(null==n)throw TS("no local fingerprint found");let i=Dr(t,en(n.trim().toLowerCase().replaceAll(":",""),"hex")),s=pR.decode(mR(r));return Ie([en("libp2p-webrtc-noise:"),i.bytes,s])}};function RR(e){return t=>new SR(t,e)}function AR(e){return t=>new fR(t,e)}var _R=async e=>{if(e.readyState>=2)throw new Error("socket closed");1!==e.readyState&&await new Promise(((t,r)=>{function n(){e.removeEventListener("open",i),e.removeEventListener("error",s)}function i(){n(),t()}function s(t){n(),r(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}e.addEventListener("open",i),e.addEventListener("error",s)}))},IR=(e,t)=>((t=t??{}).closeOnEnd=!1!==t.closeOnEnd,async r=>{for await(let t of r){try{await _R(e)}catch(e){if("socket closed"===e.message)break;throw e}if(e.readyState===e.CLOSING||e.readyState===e.CLOSED)break;e.send(t)}null!=t.closeOnEnd&&e.readyState<=1&&await new Promise(((t,r)=>{e.addEventListener("close",(e=>{if(e.wasClean||1006===e.code)t();else{let t=Object.assign(new Error("ws error"),{event:e});r(t)}})),setTimeout((()=>{e.close()}))}))}),kR=c(I(),1);function TR(e){return e instanceof ArrayBuffer||"ArrayBuffer"===e?.constructor?.name&&"number"==typeof e?.byteLength}var CR=WebSocket,DR={"http:":"ws:","https:":"wss:"};function xR(e,t){t=t??{};let r=((e,t)=>{if(e.startsWith("//")&&(e=`${t?.protocol??"ws:"}${e}`),e.startsWith("/")&&null!=t){let r=t.protocol??"ws:",n=t.host,i=null!=t.port&&!0!==n?.endsWith(`:${t.port}`)?`:${t.port}`:"";e=`${r}//${n}${i}${e}`}let r=new URL(e);for(let[e,t]of Object.entries(DR))r.protocol===e&&(r.protocol=t);return r})(e,typeof window>"u"?void 0:window.location);return((e,t)=>{t=t??{};let r=(e=>{e.binaryType="arraybuffer";let t,r=async()=>{await new Promise(((r,n)=>{if(i)return void r();if(null!=t)return void n(t);let s=t=>{e.removeEventListener("open",o),e.removeEventListener("error",a),t()},o=()=>{s(r)},a=t=>{s((()=>{n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}))};e.addEventListener("open",o),e.addEventListener("error",a)}))},n=async function*(){let t=new kR.EventIterator((({push:t,stop:r,fail:n})=>{let i=e=>{let r=null;"string"==typeof e.data&&(r=en(e.data)),TR(e.data)&&(r=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(r=e.data),null!=r&&t(r)},s=e=>{n(e.error??new Error("Socket error"))};return e.addEventListener("message",i),e.addEventListener("error",s),e.addEventListener("close",r),()=>{e.removeEventListener("message",i),e.removeEventListener("error",s),e.removeEventListener("close",r)}}),{highWaterMark:1/0});await r();for await(let e of t)yield TR(e)?new Uint8Array(e):e}(),i=1===e.readyState;return e.addEventListener("open",(()=>{i=!0,t=null})),e.addEventListener("close",(()=>{i=!1,t=null})),e.addEventListener("error",(r=>{i||(t=r.error??new Error(`connect ECONNREFUSED ${e.url}`))})),Object.assign(n,{connected:r})})(e),n=t.remoteAddress,i=t.remotePort;if(null!=e.url)try{let t=new URL(e.url);n=t.hostname,i=parseInt(t.port,10)}catch{}if(null==n||null==i)throw new Error("Remote connection did not have address and/or port");return{sink:IR(e,t),source:r,connected:async()=>{await r.connected()},close:async()=>{(e.readyState===e.CONNECTING||e.readyState===e.OPEN)&&await new Promise((t=>{e.addEventListener("close",(()=>{t()})),e.close()}))},destroy:()=>{null!=e.terminate?e.terminate():e.close()},remoteAddress:n,remotePort:i,socket:e}})(new CR(r.toString(),t.websocket),t)}var NR=class{log;init;logger;metrics;components;constructor(e,t){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[B]=!0;[Symbol.toStringTag]="@libp2p/websockets";[j]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};let r=function(e,t,r){let n=r.logger.forComponent("libp2p:websockets:maconn"),i=r.metrics,s=r.metricPrefix??"",o={log:n,async sink(t){try{await e.sink(async function*(){for await(let e of t)e instanceof Uint8Array?yield e:yield e.subarray()}())}catch(e){"aborted"!==e.type&&n.error(e)}},source:e.source,remoteAddr:t,timeline:{open:Date.now()},async close(t={}){let r=Date.now();if(null==t.signal){let e=AbortSignal.timeout(500);t={...t,signal:e}}let i=()=>{let{host:e,port:t}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",e,t,Date.now()-r),this.abort(new U("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};t.signal?.addEventListener("abort",i);try{await e.close()}catch(e){n.error("error closing WebSocket gracefully",e),this.abort(e)}finally{t.signal?.removeEventListener("abort",i),o.timeline.close=Date.now()}},abort(t){let{host:r,port:a}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",r,a,t),e.destroy(),o.timeline.close=Date.now(),i?.increment({[`${s}error`]:!0})}};return e.socket.addEventListener("close",(()=>{i?.increment({[`${s}close`]:!0}),null==o.timeline.close&&(o.timeline.close=Date.now())}),{once:!0}),o}(await this._connect(e,t),e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",r.remoteAddr);let n=await t.upgrader.upgradeOutbound(r,t);return this.log("outbound connection %s upgraded",r.remoteAddr),n}async _connect(e,t){t?.signal?.throwIfAborted();let r=e.toOptions();this.log("dialing %s:%s",r.host,r.port);let n=Q(),i=xR(Pg(e),this.init);i.socket.addEventListener("error",(()=>{let t=new U(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",t),this.metrics?.dialerEvents.increment({error:!0}),n.reject(t)}));try{t.onProgress?.(new Xe("websockets:open-connection")),await ie(Promise.race([i.connected(),n.promise]),t.signal)}catch(e){throw!0===t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch((e=>{this.log.error("error closing raw socket",e)})),e}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}((this.logger,this.components.metrics),this.init)}listenFilter(e){return e=Array.isArray(e)?e:[e],null!=this.init?.filter?this.init?.filter(e):mE||EE?function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return ub.matches(t)}))}(e):function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return lb.matches(t)||ub.matches(t)}))}(e)}dialFilter(e){return this.listenFilter(e)}};function PR(e={}){return t=>new NR(t,e)}var LR=class extends $w{writer;reader;constructor(e){super(e),this.writer=e.bidiStream.writable.getWriter(),this.reader=e.bidiStream.readable.getReader(),Promise.resolve().then((async()=>{for(;;){let t=await this.reader.read();if(t.done)return void e.log("remote closed write");null!=t.value&&this.sourcePush(new xe(t.value))}})).catch((t=>{e.log.error("error reading from stream",t),this.abort(t)})).finally((()=>{this.remoteCloseWrite()})),this.writer.closed.then((()=>{e.log("writer closed")})).catch((t=>{e.log("writer close promise rejected",t)})).finally((()=>{this.remoteCloseRead()}))}sendNewStream(e){}async sendData(e,t){for await(let r of e)this.log("sendData waiting for writer to be ready"),await ie(this.writer.ready,t?.signal),this.writer.write(r).catch((e=>{this.log.error("error sending stream data",e)}))}async sendReset(e){this.log("sendReset aborting writer"),await ie(this.writer.abort(),e?.signal),this.log("sendReset aborted writer")}async sendCloseWrite(e){this.log("sendCloseWrite closing writer"),await ie(this.writer.close(),e?.signal),this.log("sendCloseWrite closed writer")}async sendCloseRead(e){this.log("sendCloseRead cancelling reader"),await ie(this.reader.cancel(),e?.signal),this.log("sendCloseRead cancelled reader")}};async function OR(e,t,r,n,i,s){let o=s.forComponent(`libp2p:webtransport:stream:${r}:${t}`),a=new LR({bidiStream:e,id:t,direction:r,log:o,onEnd:()=>{let e=n.findIndex((e=>e===a));-1!==e&&n.splice(e,1),i?.(a)}});return a}function BR(){return{source:{[Symbol.asyncIterator]:()=>({next:async()=>new Promise((()=>{}))})},sink:async e=>new Promise((()=>{}))}}function MR(e,t,r,n){let i=0,s=r.forComponent("libp2p:webtransport:muxer");return{protocol:"webtransport",createStreamMuxer:o=>{"function"==typeof o&&(o={onIncomingStream:o});let a=[];Promise.resolve().then((async()=>{for(;;){let{done:e,value:l}=await t.read();if(e)break;if(a.length>=n.maxInboundStreams)s(`too many inbound streams open - ${a.length}/${n.maxInboundStreams}, closing new incoming stream`),l.writable.close().catch((e=>{s.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${e.message}`)})),l.readable.cancel().catch((e=>{s.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${e.message}`)}));else{let e=await OR(l,String(i++),"inbound",a,o?.onStreamEnd,r);a.push(e),o?.onIncomingStream?.(e)}}})).catch((e=>{s.error("could not create a new stream",e)}));let l={protocol:"webtransport",streams:a,newStream:async t=>{s("new outgoing stream",t);let n=await e.createBidirectionalStream(),l=await OR(n,String(i++),o?.direction??"outbound",a,o?.onStreamEnd,r);return a.push(l),l},close:async()=>{s("closing webtransport muxer gracefully");try{e.close()}catch(e){l.abort(e)}},abort:t=>{s("closing webtransport muxer with err:",t);try{e.close()}catch(e){s.error("webtransport session threw error during close",e)}},...BR()};return l}}}var UR=Object.values(Yr).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)));function FR(e){if(!Sg.matches(e))throw new U("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");let t=e.stringTuples(),r=t.filter((([e,t])=>e===vp("certhash").code)).map((([e,t])=>function(e){return ur.decode(UR.decode(e))}(t??""))),n=t.filter((([e,t])=>e===vp("p2p").code)).map((([e,t])=>Gn(t??"")))[0],i=e.toOptions(),s=i.host;return 6===i.family&&s?.includes(":")&&(s=`[${s}]`),{url:`https://${s}:${i.port}`,certhashes:r,remotePeer:n}}var $R=globalThis.WebTransport,VR=class{log;components;config;metrics;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webtransport"),this.components=e,this.config={...t,maxInboundStreams:t.maxInboundStreams??1e3,certificates:t.certificates??[]},null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}[Symbol.toStringTag]="@libp2p/webtransport";[B]=!0;[j]=["@libp2p/transport"];async dial(e,t){if(!0===t?.signal?.aborted)throw new M;this.log("dialing %s",e);let r=this.components.peerId;if(void 0===r)throw new U("Need a local peerid","ERR_INVALID_PARAMETERS");t=t??{};let n,i,{url:s,certhashes:o,remotePeer:a}=FR(e),l=()=>{},c=!1,u=!1,h=!1;try{this.metrics?.dialerEvents.increment({pending:!0});let d=new $R(`${s}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:o.map((e=>({algorithm:"sha-256",value:e.digest})))});if(l=e=>{if(!c)try{this.metrics?.dialerEvents.increment({[e]:!0}),d.close()}catch(e){this.log.error("error closing wt session",e)}finally{null!=i&&(i.timeline.close=Date.now()),c=!0}},n=()=>{l(u?"noise_timeout":"ready_timeout")},t.signal?.addEventListener("abort",n,{once:!0}),this.log("wait for session to be ready"),t.onProgress?.(new Xe("webtransport:wait-for-session")),await Promise.race([d.closed,d.ready]),this.log("session became ready"),u=!0,this.metrics?.dialerEvents.increment({ready:!0}),d.closed.catch((e=>{this.log.error("error on remote wt session close",e)})).finally((()=>{l("remote_close")})),h=await ie(this.authenticateWebTransport({wt:d,localPeer:r,remotePeer:a,certhashes:o,...t}),t.signal),!h)throw new U("Failed to authenticate webtransport","ERR_AUTHENTICATION_FAILED");return this.metrics?.dialerEvents.increment({open:!0}),i={close:async()=>{this.log("closing webtransport"),l("close")},abort:e=>{this.log("aborting webtransport due to passed err",e),l("abort")},remoteAddr:e,timeline:{open:Date.now()},log:this.components.logger.forComponent("libp2p:webtransport:maconn"),...BR()},await t.upgrader.upgradeOutbound(i,{skipEncryption:!0,muxerFactory:MR(d,d.incomingBidirectionalStreams.getReader(),this.components.logger,this.config),skipProtection:!0,onProgress:t.onProgress})}catch(e){throw this.log.error("caught wt session err",e),l(h?"upgrade_error":u?"noise_error":"ready_error"),e}finally{null!=n&&t.signal?.removeEventListener("abort",n)}}async authenticateWebTransport({wt:e,localPeer:t,remotePeer:r,certhashes:n,onProgress:i,signal:s}){s?.throwIfAborted(),i?.(new Xe("webtransport:open-authentication-stream"));let o=await e.createBidirectionalStream(),a=o.writable.getWriter(),l=o.readable.getReader(),c={source:async function*(){for(;;){let e=await l.read();if(null!=e.value&&(yield e.value),e.done)break}}(),sink:async e=>{for await(let t of e){await ie(a.ready,s);let e=t instanceof Uint8Array?t:t.subarray();a.write(e).catch((e=>{this.log.error("could not write chunk during authentication of WebTransport stream",e)}))}}},u=mw()(this.components);i?.(new Xe("webtransport:secure-outbound-connection"));let{remoteExtensions:h}=await u.secureOutbound(t,c,r);if(i?.(new Xe("webtransport:close-authentication-stream")),a.close().catch((e=>{this.log.error(`Failed to close authentication stream writer: ${e.message}`)})),l.cancel().catch((e=>{this.log.error(`Failed to close authentication stream reader: ${e.message}`)})),!function(e,t){return t.filter((t=>!!e.find((e=>ke(t,e))))).length===t.length}(h?.webtransportCerthashes??[],n.map((e=>e.bytes))))throw new Error("Our certhashes are not a subset of the remote's reported certhashes");return!0}createListener(e){return function(){throw new Error("Not implemented")}(this.components,(this.config.certificates,this.config.maxInboundStreams))}listenFilter(){return[]}dialFilter(e){return null==globalThis.WebTransport?[]:e.filter((e=>{if(!Sg.exactMatch(e))return!1;let{url:t,certhashes:r}=FR(e);return null!=t&&r.length>0}))}};function KR(e={}){return t=>new VR(t,e)}var HR=c(y(),1);function qR(e,t){let r=t.map(((e,t)=>({record:Xg(e),index:t})));return r.sort(((e,t)=>{let r=e.record.sequence,n=t.record.sequence;if(r>n)return-1;if(r<n)return 1;if(e.record.validityType===Hg.ValidityType.EOL&&t.record.validityType===Hg.ValidityType.EOL){let r=HR.default.fromString(e.record.validity).toDate(),n=HR.default.fromString(t.record.validity).toDate();if(r.getTime()>n.getTime())return-1;if(r.getTime()<n.getTime())return 1}return 0})),r[0].index}var zR="1.9.4",WR="libp2p",jR="4.2.6",GR="helia",YR={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function QR(e={}){let t=`${GR}/${jR} ${WR}/${zR} UserAgent=${globalThis.navigator.userAgent}`;return{peerId:e.peerId,dns:e.dns,addresses:{listen:["/webrtc"]},transports:[rE({discoverRelays:1}),AR(),RR(),KR(),PR()],connectionEncryption:[mw()],streamMuxers:[zw(),yS()],peerDiscovery:[Db(YR)],services:{autoNAT:Qw(),dcutr:dE(),delegatedRouting:()=>function(e,t={}){return new wm(new URL("https://delegated-ipfs.dev"),t)}(),dht:Vv({clientMode:!0,validators:{ipns:cm},selectors:{ipns:qR}}),identify:TE({agentVersion:t}),identifyPush:CE({agentVersion:t}),keychain:Xv(e.keychain),ping:vS()}}}var JR,ZR,XR,eA=async()=>{let e=await Jc("Ed25519"),t=await async function(e){return Qn(eu(e.public),ru(e))}(e);if("Ed25519"===t.type)return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)},tA={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};function rA(e,t){let r=JR.decode(t);null!=r.publicKey&&null==e.publicKey&&(e=function(e){if("RSA"===e.type)return new Hn(e);if("Ed25519"===e.type)return new qn(e);if("secp256k1"===e.type)return new zn(e);throw new U("Not a PeerId","ERR_INVALID_PARAMETERS")}({...e,publicKey:e.publicKey}));let n=new Map,i=BigInt(Date.now());for(let[e,t]of r.tags.entries())null!=t.expiry&&t.expiry<i||n.set(e,t);return{...r,id:e,addresses:r.addresses.map((({multiaddr:e,isCertified:t})=>({multiaddr:Hp(e),isCertified:t??!1}))),metadata:r.metadata,peerRecordEnvelope:r.peerRecordEnvelope??void 0,tags:n}}!function(e){let t,r,n;!function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={key:"",value:new Uint8Array(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.key=e.string();break;case 2:r.value=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(t=e.Peer$metadataEntry||(e.Peer$metadataEntry={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),XR.codec().encode(e.value,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={key:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.key=e.string();break;case 2:r.value=XR.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(r=e.Peer$tagsEntry||(e.Peer$tagsEntry={})),e.codec=()=>(null==n&&(n=bn(((t,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=t.addresses)for(let e of t.addresses)r.uint32(10),ZR.codec().encode(e,r);if(null!=t.protocols)for(let e of t.protocols)r.uint32(18),r.string(e);if(null!=t.publicKey&&(r.uint32(34),r.bytes(t.publicKey)),null!=t.peerRecordEnvelope&&(r.uint32(42),r.bytes(t.peerRecordEnvelope)),null!=t.metadata&&0!==t.metadata.size)for(let[n,i]of t.metadata.entries())r.uint32(50),e.Peer$metadataEntry.codec().encode({key:n,value:i},r);if(null!=t.tags&&0!==t.tags.size)for(let[n,i]of t.tags.entries())r.uint32(58),e.Peer$tagsEntry.codec().encode({key:n,value:i},r);!1!==n.lengthDelimited&&r.ldelim()}),((t,r)=>{let n={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=null==r?t.len:t.pos+r;for(;t.pos<i;){let r=t.uint32();switch(r>>>3){case 1:n.addresses.push(ZR.codec().decode(t,t.uint32()));break;case 2:n.protocols.push(t.string());break;case 4:n.publicKey=t.bytes();break;case 5:n.peerRecordEnvelope=t.bytes();break;case 6:{let r=e.Peer$metadataEntry.codec().decode(t,t.uint32());n.metadata.set(r.key,r.value);break}case 7:{let r=e.Peer$tagsEntry.codec().decode(t,t.uint32());n.tags.set(r.key,r.value);break}default:t.skipType(7&r)}}return n}))),n),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(JR||(JR={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={multiaddr:new Uint8Array(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.multiaddr=e.bytes();break;case 2:r.isCertified=e.bool();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(ZR||(ZR={})),function(e){let t;e.codec=()=>(null==t&&(t=bn(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{let r={value:0},n=null==t?e.len:e.pos+t;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.value=e.uint32();break;case 2:r.expiry=e.uint64();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>mn(t,e.codec()),e.decode=t=>mt(t,e.codec())}(XR||(XR={}));var nA="/peers/";function iA(e){if(!N(e)||null==e.type)throw new U("Invalid PeerId",tA.ERR_INVALID_PARAMETERS);let t=e.toCID().toString();return new Nd(`${nA}${t}`)}async function sA(e,t,r){let n=new Map;for(let i of r){if(null==i)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=Hp(i.multiaddr)),!Kp(i.multiaddr))throw new U("Multiaddr was invalid",tA.ERR_INVALID_PARAMETERS);if(!await t(e,i.multiaddr))continue;let r=i.isCertified??!1,s=i.multiaddr.toString(),o=n.get(s);null!=o?i.isCertified=o.isCertified||r:n.set(s,{multiaddr:i.multiaddr,isCertified:r})}return[...n.values()].sort(((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString()))).map((({isCertified:e,multiaddr:t})=>({isCertified:e,multiaddr:t.bytes})))}async function oA(e,t,r,n){if(null==t)throw new U("Invalid PeerData",tA.ERR_INVALID_PARAMETERS);if(null!=t.publicKey&&null!=e.publicKey&&!ke(t.publicKey,e.publicKey))throw new U("publicKey bytes do not match peer id publicKey bytes",tA.ERR_INVALID_PARAMETERS);let i=n.existingPeer;if(null!=i&&!e.equals(i.id))throw new U("peer id did not match existing peer id",tA.ERR_INVALID_PARAMETERS);let s=i?.addresses??[],o=new Set(i?.protocols??[]),a=i?.metadata??new Map,l=i?.tags??new Map,c=i?.peerRecordEnvelope;if("patch"===r&&((null!=t.multiaddrs||null!=t.addresses)&&(s=[],null!=t.multiaddrs&&s.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&s.push(...t.addresses)),null!=t.protocols&&(o=new Set(t.protocols)),null!=t.metadata&&(a=aA(t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata),{validate:lA})),null!=t.tags&&(l=aA(t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),{validate:cA,map:uA})),null!=t.peerRecordEnvelope&&(c=t.peerRecordEnvelope)),"merge"===r){if(null!=t.multiaddrs&&s.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&s.push(...t.addresses),null!=t.protocols&&(o=new Set([...o,...t.protocols])),null!=t.metadata){let e=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(let[t,r]of e)null==r?a.delete(t):a.set(t,r);a=aA([...a.entries()],{validate:lA})}if(null!=t.tags){let e=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),r=new Map(l);for(let[t,n]of e)null==n?r.delete(t):r.set(t,n);l=aA([...r.entries()],{validate:cA,map:uA})}null!=t.peerRecordEnvelope&&(c=t.peerRecordEnvelope)}let u={addresses:await sA(e,n.addressFilter??(async()=>!0),s),protocols:[...o.values()].sort(((e,t)=>e.localeCompare(t))),metadata:a,tags:l,publicKey:i?.id.publicKey??t.publicKey??e.publicKey,peerRecordEnvelope:c};return"RSA"!==e.type&&delete u.publicKey,u}function aA(e,t){let r=new Map;for(let[r,n]of e)null!=n&&t.validate(r,n);for(let[n,i]of e.sort((([e],[t])=>e.localeCompare(t))))null!=i&&r.set(n,t.map?.(n,i)??i);return r}function lA(e,t){if("string"!=typeof e)throw new U("Metadata key must be a string",tA.ERR_INVALID_PARAMETERS);if(!(t instanceof Uint8Array))throw new U("Metadata value must be a Uint8Array",tA.ERR_INVALID_PARAMETERS)}function cA(e,t){if("string"!=typeof e)throw new U("Tag name must be a string",tA.ERR_INVALID_PARAMETERS);if(null!=t.value){if(parseInt(`${t.value}`,10)!==t.value)throw new U("Tag value must be an integer",tA.ERR_INVALID_PARAMETERS);if(t.value<0||t.value>100)throw new U("Tag value must be between 0-100",tA.ERR_INVALID_PARAMETERS)}if(null!=t.ttl){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new U("Tag ttl must be an integer",tA.ERR_INVALID_PARAMETERS);if(t.ttl<0)throw new U("Tag ttl must be between greater than 0",tA.ERR_INVALID_PARAMETERS)}}function uA(e,t){let r;return null!=t.expiry&&(r=t.expiry),null!=t.ttl&&(r=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:r}}function hA(e,t,r){let n=e.toString().split("/")[2],i=Yn($t.decode(n)),s=r.get(i);if(null!=s)return s;let o=rA(i,t);return r.set(i,o),o}var dA=class{peerId;datastore;lock;addressFilter;constructor(e,t={}){this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=nf({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(iA(e))}async delete(e){if(this.peerId.equals(e))throw new U("Cannot delete self peer",tA.ERR_INVALID_PARAMETERS);await this.datastore.delete(iA(e))}async load(e){return rA(e,await this.datastore.get(iA(e)))}async save(e,t){let{existingBuf:r,existingPeer:n}=await this.#e(e),i=await oA(e,t,"patch",{addressFilter:this.addressFilter});return this.#t(e,i,r,n)}async patch(e,t){let{existingBuf:r,existingPeer:n}=await this.#e(e),i=await oA(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:n});return this.#t(e,i,r,n)}async merge(e,t){let{existingBuf:r,existingPeer:n}=await this.#e(e),i=await oA(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:n});return this.#t(e,i,r,n)}async*all(e){let t=new Zn;for await(let{key:r,value:n}of this.datastore.query(function(e,t){return null==e?{}:{prefix:nA,filters:(e.filters??[]).map((e=>({key:r,value:n})=>e(hA(r,n,t)))),orders:(e.orders??[]).map((e=>(r,n)=>e(hA(r.key,r.value,t),hA(n.key,n.value,t))))}}(e??{},t))){let e=hA(r,n,t);e.id.equals(this.peerId)||(yield e)}}async#e(e){try{let t=await this.datastore.get(iA(e));return{existingBuf:t,existingPeer:rA(e,t)}}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return{}}async#t(e,t,r,n){let i=JR.encode(t);return null!=r&&ke(i,r)?{peer:rA(e,i),previous:n,updated:!1}:(await this.datastore.put(iA(e),i),{peer:rA(e,i),previous:n,updated:!0})}},fA=class{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new dA(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){this.log.trace("forEach await read lock");let r=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(let r of this.store.all(t))e(r)}finally{this.log.trace("forEach release read lock"),r()}}async all(e){this.log.trace("all await read lock");let t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await Qm(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");let t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");let t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");let t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");let r=await this.store.lock.writeLock();this.log.trace("save got write lock");try{let r=await this.store.save(e,t);return this.#e(e,r),r.peer}finally{this.log.trace("save release write lock"),r()}}async patch(e,t){this.log.trace("patch await write lock");let r=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{let r=await this.store.patch(e,t);return this.#e(e,r),r.peer}finally{this.log.trace("patch release write lock"),r()}}async merge(e,t){this.log.trace("merge await write lock");let r=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{let r=await this.store.merge(e,t);return this.#e(e,r),r.peer}finally{this.log.trace("merge release write lock"),r()}}async consumePeerRecord(e,t){let r=await Pb.openAndCertify(e,Bb.DOMAIN);if(!1===t?.equals(r.peerId))return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,r.peerId),!1;let n,i=Bb.createFromProtobuf(r.payload);try{n=await this.get(r.peerId)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=n?.peerRecordEnvelope){let e=await Pb.createFromProtobuf(n.peerRecordEnvelope),t=Bb.createFromProtobuf(e.payload);if(t.seqNumber>=i.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:e,addresses:i.multiaddrs.map((e=>({isCertified:!0,multiaddr:e})))}),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}},pA=e=>e;function gA(e,t){let r=e.getPeerId();return null!=r&&Gn(r).equals(t)&&(e=e.decapsulate(Hp(`/p2p/${t.toString()}`))),e}var mA=class{log;components;listen;announce;observed;announceFilter;constructor(e,t={}){let{listen:r=[],announce:n=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=r.map((e=>e.toString())),this.announce=new Set(n.map((e=>e.toString()))),this.observed=new Map,this.announceFilter=t.announceFilter??pA,this._updatePeerStoreAddresses=function(e){let t;return function(){clearTimeout(t),t=setTimeout((function(){t=void 0,e()}),1e3)}}(this._updatePeerStoreAddresses.bind(this)),e.events.addEventListener("transport:listening",(()=>{this._updatePeerStoreAddresses()})),e.events.addEventListener("transport:close",(()=>{this._updatePeerStoreAddresses()}))}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter((([e,t])=>t.confident)).map((([e])=>Hp(e)))).map((e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e));this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch((e=>{this.log.error("error updating addresses",e)}))}getListenAddrs(){return Array.from(this.listen).map((e=>Hp(e)))}getAnnounceAddrs(){return Array.from(this.announce).map((e=>Hp(e)))}getObservedAddrs(){return Array.from(this.observed).map((([e])=>Hp(e)))}addObservedAddr(e){let t=(e=gA(e,this.components.peerId)).toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){let t=(e=gA(e,this.components.peerId)).toString(),r=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),r||this._updatePeerStoreAddresses()}removeObservedAddr(e){let t=(e=gA(e,this.components.peerId)).toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map((e=>e.toString()));0===e.length&&(e=this.components.transportManager.getAddrs().map((e=>e.toString()))),e=e.concat(Array.from(this.observed).filter((([e,t])=>t.confident)).map((([e])=>e)));let t=new Set(e);return this.announceFilter(Array.from(t).map((e=>Hp(e)))).map((e=>!0===e.protos().pop()?.path||e.getPeerId()===this.components.peerId.toString()?e:e.encapsulate(`/p2p/${this.components.peerId.toString()}`)))}},yA=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,r]of Object.entries(e))this.components[t]=r;null==this.components.logger&&(this.components.logger=Fu())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter((e=>q(e))).map((async t=>{await(t[e]?.())})))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},wA=["metrics","connectionProtector","dns"],bA=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function EA(e){return Array.isArray(e?.[j])?e[j]:[]}function vA(e){return Array.isArray(e?.[G])?e[G]:[]}function SA(e){return e?.[Symbol.toStringTag]??e?.toString()??"unknown"}function RA(e={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{let t=e.stringTuples();return(4===t[0][0]||41===t[0][0])&&!!pp(`${t[0][1]}`)},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...e}}function AA(e){try{let{address:t}=e.nodeAddress();return!!pp(t)}catch{return!0}}function _A(e,t){let r=function(e,t){let r=AA(e.multiaddr),n=AA(t.multiaddr);return r&&!n?1:!r&&n?-1:0}(e,t);if(0!==r)return r;let n=function(e,t){let r=Ag.exactMatch(e.multiaddr),n=Ag.exactMatch(t.multiaddr);return r&&!n?1:!r&&n?-1:0}(e,t);return 0!==n?n:function(e,t){return e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}(e,t)}var IA,kA,{code:TA}=vp("dnsaddr"),CA=class extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}},DA=async function(e,t={}){let r=t.maxRecursiveDepth??32;if(0===r)throw new CA("Max recursive depth reached");let[,n]=e.stringTuples().find((([e])=>e===TA))??[],i=await(t?.dns??nh()).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Xu.TXT]}),s=e.getPeerId(),o=[];for(let e of i.Answer){let n=e.data.replace(/["']/g,"").trim().split("=")[1];if(null==n||null!=s&&!n.includes(s))continue;let i=Hp(n);if(n.startsWith("/dnsaddr")){let e=await i.resolve({...t,maxRecursiveDepth:r-1});o.push(...e.map((e=>e.toString())))}else o.push(i.toString())}return o};!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(IA||(IA={})),function(e){e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",e.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"}(kA||(kA={}));var xA={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{resolvers:{dnsaddr:DA},addressSorter:_A},transportManager:{faultTolerance:P.FATAL_ALL}};function NA(e){if(N(e))return{peerId:e,multiaddrs:[]};let t;if(Array.isArray(e)||(e=[e]),e.length>0){let r=e[0].getPeerId();t=null==r?void 0:Gn(r),e.forEach((e=>{if(!Kp(e))throw new U("Invalid Multiaddr",kA.ERR_INVALID_MULTIADDR);let r=e.getPeerId();if(null==r){if(null!=t)throw new U("Multiaddrs must all have the same peer id or have no peer id",kA.ERR_INVALID_PARAMETERS)}else{let e=Gn(r);if(!0!==t?.equals(e))throw new U("Multiaddrs must all have the same peer id or have no peer id",kA.ERR_INVALID_PARAMETERS)}}))}return{peerId:t,multiaddrs:e}}var PA="last-dial-failure",LA=42e4,OA=5,BA=100,MA=25,UA=0,FA=5e3,$A=LA,VA=10,KA=class{connectionManager;peerStore;queue;minConnections;autoDialPriority;autoDialIntervalMs;autoDialMaxQueueLength;autoDialPeerRetryThresholdMs;autoDialDiscoveredPeersDebounce;autoDialInterval;started;running;log;constructor(e,t){let r;this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??OA,this.autoDialPriority=t.autoDialPriority??UA,this.autoDialIntervalMs=t.autoDialInterval??FA,this.autoDialMaxQueueLength=t.maxQueueLength??BA,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??$A,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??VA,this.log=e.logger.forComponent("libp2p:connection-manager:auto-dial"),this.started=!1,this.running=!1,this.queue=new le({concurrency:t.autoDialConcurrency??MA,metricName:"libp2p_autodial_queue",metrics:e.metrics}),this.queue.addEventListener("error",(e=>{this.log.error("error during auto-dial",e.detail)})),e.events.addEventListener("connection:close",(()=>{this.autoDial().catch((e=>{this.log.error(e)}))})),e.events.addEventListener("peer:discovery",(()=>{clearTimeout(r),r=setTimeout((()=>{this.autoDial().catch((e=>{this.log.error(e)}))}),this.autoDialDiscoveredPeersDebounce)}))}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.autoDial().catch((e=>{this.log.error("error while autodialing",e)}))}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started||this.running)return;let e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections)return void(this.minConnections>0&&this.log.trace("have enough connections %d/%d",t,this.minConnections));if(this.queue.size>this.autoDialMaxQueueLength)return this.log("not enough connections %d/%d but auto dial queue is full",t,this.minConnections),void this.sheduleNextAutodial();this.running=!0,this.log("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);let r=new Xn(this.connectionManager.getDialQueue().map((e=>e.peerId)).filter(Boolean)),n=await this.peerStore.all({filters:[t=>0===t.addresses.length?(this.log.trace("not autodialing %p because they have no addresses",t.id),!1):e.has(t.id)?(this.log.trace("not autodialing %p because they are already connected",t.id),!1):r.has(t.id)?(this.log.trace("not autodialing %p because they are already being dialed",t.id),!1):!this.queue.has(t.id)||(this.log.trace("not autodialing %p because they are already being autodialed",t.id),!1)]}),i=n.sort((()=>Math.random()>.5?1:-1)),s=new Zn;for(let e of i)s.has(e.id)||s.set(e.id,[...e.tags.values()].reduce(((e,t)=>e+t.value),0));let o=i.sort(((e,t)=>{let r=s.get(e.id)??0,n=s.get(t.id)??0;return r>n?-1:r<n?1:0})).filter((e=>{let t=e.metadata.get(PA);if(null==t)return!0;let r=parseInt(Bn(t));return!!isNaN(r)||Date.now()-r>this.autoDialPeerRetryThresholdMs}));this.log("selected %d/%d peers to dial",o.length,n.length);for(let e of o)this.queue.add((async()=>{let t=this.connectionManager.getConnectionsMap().size;if(t>=this.minConnections)return this.log("got enough connections now %d/%d",t,this.minConnections),void this.queue.clear();this.log("connecting to a peerStore stored peer %p",e.id),await this.connectionManager.openConnection(e.id,{priority:this.autoDialPriority})}),{peerId:e.id}).catch((e=>{this.log.error("could not connect to peerStore stored peer",e)}));this.running=!1,this.sheduleNextAutodial()}sheduleNextAutodial(){this.started&&(this.autoDialInterval=setTimeout((()=>{this.autoDial().catch((e=>{this.log.error("error while autodialing",e)}))}),this.autoDialIntervalMs))}},HA=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"],qA={maxConnections:100,allow:[]},zA=class{maxConnections;connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??qA.maxConnections,this.allow=t.allow??qA.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),e.events.addEventListener("connection:open",(()=>{this.maybePruneConnections().catch((e=>{this.log.error(e)}))}))}async maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;let r=new Zn;for(let t of e){let e=t.remotePeer;if(!r.has(e)){r.set(e,0);try{let t=await this.peerStore.get(e);r.set(e,[...t.tags.values()].reduce(((e,t)=>e+t.value),0))}catch(e){"ERR_NOT_FOUND"!==e.code&&this.log.error("error loading peer tags",e)}}}let n=this.sortConnections(e,r),i=Math.max(t-this.maxConnections,0),s=[];for(let e of n)if(this.log("too many connections open - closing a connection to %p",e.remotePeer),this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString())))||s.push(e),s.length===i)break;await Promise.all(s.map((async e=>{await async function(e,t){let r=e?.streams?.map((e=>e.protocol))??[],n=t?.closableProtocols??HA;if(!(r.filter((e=>null!=e&&!n.includes(e))).length>0))try{await(e?.close(t))}catch(t){e?.abort(t)}}(e,{signal:AbortSignal.timeout(1e3)})}))),this.events.safeDispatchEvent("connection:prune",{detail:s})}sortConnections(e,t){return e.sort(((e,t)=>{let r=e.timeline.open,n=t.timeline.open;return r<n?1:r>n?-1:0})).sort(((e,t)=>"outbound"===e.direction&&"inbound"===t.direction?1:"inbound"===e.direction&&"outbound"===t.direction?-1:0)).sort(((e,t)=>e.streams.length>t.streams.length?1:e.streams.length<t.streams.length?-1:0)).sort(((e,r)=>{let n=t.get(e.remotePeer)??0,i=t.get(r.remotePeer)??0;return n>i?1:n<i?-1:0}))}},WA=class extends ae{constructor(e={}){super({...e,sort:(e,t)=>e.options.priority>t.options.priority?-1:e.options.priority<t.options.priority?1:0})}},jA={addressSorter:_A,maxParallelDials:50,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:5e3,resolvers:{dnsaddr:DA}},GA=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter??jA.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??jA.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??jA.maxDialQueueLength,this.dialTimeout=t.dialTimeout??jA.dialTimeout,this.connections=t.connections??new Zn,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(let[e,r]of Object.entries(t.resolvers??{}))Vp.set(e,r);this.queue=new WA({concurrency:t.maxParallelDials??jA.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",(e=>{this.log.error("error in dial queue",e.detail)}))}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:r,multiaddrs:n}=NA(e),i=Array.from(this.connections.values()).flat().find((e=>!0!==t.force&&(!!e.remotePeer.equals(r)||n.find((t=>t.equals(e.remoteAddr))))));if(null!=i)return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new Xe("dial-queue:already-connected")),i;let s=this.queue.queue.find((e=>{if(!0===r?.equals(e.options.peerId))return!0;let t=e.options.multiaddrs;if(null==t)return!1;for(let e of n)if(t.has(e.toString()))return!0;return!1}));if(null!=s){this.log("joining existing dial target for %p",r);for(let e of n)s.options.multiaddrs.add(e.toString());return t.onProgress?.(new Xe("dial-queue:already-in-dial-queue")),s.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new U("Dial queue is full","ERR_DIAL_QUEUE_FULL");return this.log("creating dial target for %p",r,n.map((e=>e.toString()))),t.onProgress?.(new Xe("dial-queue:add-to-dial-queue")),this.queue.add((async e=>{e?.onProgress?.(new Xe("dial-queue:start-dial"));let t,n=this.createDialAbortController(e?.signal);try{t=await this.calculateMultiaddrs(r,e?.multiaddrs,{...e,signal:n}),e?.onProgress?.(new Xe("dial-queue:calculated-addresses",t)),t.map((({multiaddr:e})=>e.toString())).forEach((t=>{e?.multiaddrs.add(t)}))}catch(e){throw n.clear(),e}try{let i=0,s=[];for(let o of t){if(i===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",i,r),new U("Peer had more than maxPeerAddrsToDial",kA.ERR_TOO_MANY_ADDRESSES);i++;try{let t=await this.components.transportManager.dial(o.multiaddr,{...e,signal:n});return this.log("dial to %a succeeded",o.multiaddr),t}catch(e){if(this.log.error("dial failed to %a",o.multiaddr,e),null!=r)try{await this.components.peerStore.patch(r,{metadata:{[PA]:en(Date.now().toString())}})}catch(e){this.log.error("could not update last dial failure key for %p",r,e)}if(n.aborted)throw new U(e.message,$);s.push(e)}}throw 1===s.length?s[0]:new F(s,"All multiaddr dials failed",kA.ERR_TRANSPORT_DIAL_FAILED)}finally{n.clear()}}),{peerId:r,priority:t.priority??YA,multiaddrs:new Set(n.map((e=>e.toString()))),signal:t.signal,onProgress:t.onProgress})}createDialAbortController(e){return Y([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e])}async calculateMultiaddrs(e,t=new Set,r={}){let n=[...t].map((e=>({multiaddr:Hp(e),isCertified:!1})));if(null!=e){if(this.components.peerId.equals(e))throw new U("Tried to dial self",kA.ERR_DIALED_SELF);if(!0===await(this.components.connectionGater.denyDialPeer?.(e)))throw new U("The dial request is blocked by gater.allowDialPeer",kA.ERR_PEER_DIAL_INTERCEPTED);if(0===n.length){this.log("loading multiaddrs for %p",e);try{let t=await this.components.peerStore.get(e);n.push(...t.addresses),this.log("loaded multiaddrs for %p",e,n.map((({multiaddr:e})=>e.toString())))}catch(e){if(e.code!==kA.ERR_NOT_FOUND)throw e}}if(0===n.length){this.log("looking up multiaddrs for %p in the peer routing",e);try{let t=await this.components.peerRouting.findPeer(e);this.log("found multiaddrs for %p in the peer routing",e,n.map((({multiaddr:e})=>e.toString()))),n.push(...t.multiaddrs.map((e=>({multiaddr:e,isCertified:!1}))))}catch(t){t.code!==kA.ERR_NO_ROUTERS_AVAILABLE&&this.log.error("looking up multiaddrs for %p in the peer routing failed",e,t)}}}let i=(await Promise.all(n.map((async e=>{let t=await async function(e,t){let r=!1;for(let t of Vp.keys())if(r=e.protoNames().includes(t),r)break;if(!r)return[e];let n=await e.resolve(t);return t.log("resolved %s to",e,n.map((e=>e.toString()))),n}(e.multiaddr,{dns:this.components.dns,...r,log:this.log});return 1===t.length&&t[0].equals(e.multiaddr)?e:t.map((e=>({multiaddr:e,isCertified:!1})))})))).flat();if(null!=e){let t=`/p2p/${e.toString()}`;i=i.map((e=>!0===e.multiaddr.protos().pop()?.path?e:null==e.multiaddr.getPeerId()?{multiaddr:e.multiaddr.encapsulate(t),isCertified:e.isCertified}:e))}let s=i.filter((t=>{if(null==this.components.transportManager.dialTransportForMultiaddr(t.multiaddr))return!1;let r=t.multiaddr.getPeerId();return null==e||null==r||e.equals(r)})),o=new Map;for(let e of s){let t=e.multiaddr.toString(),r=o.get(t);null==r?o.set(t,e):r.isCertified=r.isCertified||e.isCertified||!1}let a=[...o.values()];if(0===a.length)throw new U("The dial request has no valid addresses",kA.ERR_NO_VALID_ADDRESSES);let l=[];for(let e of a)null!=this.components.connectionGater.denyDialMultiaddr&&await this.components.connectionGater.denyDialMultiaddr(e.multiaddr)||l.push(e);let c=l.sort(this.addressSorter);if(0===c.length)throw new U("The connection gater denied all addresses in the dial request",kA.ERR_NO_VALID_ADDRESSES);return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map((({multiaddr:e})=>e.toString()))),this.log.trace("addresses for %p after filtering",e??"unknown peer",c.map((({multiaddr:e})=>e.toString()))),c}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{let r=await this.calculateMultiaddrs(void 0,new Set(e.map((e=>e.toString()))),t);return!1!==t.runOnTransientConnection||null!=r.find((e=>!Ag.matches(e.multiaddr)))}catch(e){this.log.trace("error calculating if multiaddr(s) were dialable",e)}return!1}},YA=50,QA=5,JA=100,ZA=5,XA=10,e_=25,t_=0,r_=100,n_=LA,i_=10,s_=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;maxConnections;dialQueue;autoDial;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??JA;let r=t.minConnections??QA;if(this.maxConnections<r)throw new U("Connection Manager maxConnections must be greater than minConnections",kA.ERR_INVALID_PARAMETERS);this.connections=new Zn,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map((e=>Hp(e))),this.deny=(t.deny??[]).map((e=>Hp(e))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??XA,this.inboundConnectionRateLimiter=new tS({points:t.inboundConnectionThreshold??ZA,duration:1}),this.autoDial=new KA({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{minConnections:r,autoDialConcurrency:t.autoDialConcurrency??e_,autoDialPriority:t.autoDialPriority??t_,autoDialPeerRetryThreshold:t.autoDialPeerRetryThreshold??n_,autoDialDiscoveredPeersDebounce:t.autoDialDiscoveredPeersDebounce??i_,maxQueueLength:t.autoDialMaxQueueLength??r_}),this.connectionPruner=new zA({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new GA(e,{addressSorter:t.addressSorter??_A,maxParallelDials:t.maxParallelDials??50,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??5e3,resolvers:t.resolvers??{dnsaddr:DA},connections:this.connections})}[Symbol.toStringTag]="@libp2p/connection-manager";isStarted(){return this.started}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,outbound:0};for(let t of this.connections.values())for(let r of t)"inbound"===r.direction?e.inbound++:e.outbound++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let r of t)for(let t of r.streams){let r=`${t.direction} ${t.protocol??"unnegotiated"}`;e[r]=(e[r]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let r of t){let t={};for(let e of r.streams){let r=`${e.direction} ${e.protocol??"unnegotiated"}`;t[r]=(t[r]??0)+1}for(let[r,n]of Object.entries(t))e[r]=e[r]??[],e[r].push(n)}let t={};for(let[r,n]of Object.entries(e)){n=n.sort(((e,t)=>e-t));let e=Math.floor(.9*n.length);t[r]=n[e]}return t}}),this.dialQueue.start(),this.autoDial.start(),this.started=!0,this.log("started")}async afterStart(){Promise.resolve().then((async()=>{let e=await this.peerStore.all({filters:[e=>e.tags.has("keep-alive")]});await Promise.all(e.map((async e=>{await this.openConnection(e.id).catch((e=>{this.log.error(e)}))})))})).catch((e=>{this.log.error(e)})),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();let e=[];for(let t of this.connections.values())for(let r of t)e.push((async()=>{try{await r.close()}catch(e){this.log.error(e)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}onConnect(e){this._onConnect(e).catch((e=>{this.log.error(e)}))}async _onConnect(e){let{detail:t}=e;if(!this.started)return void await t.close();let r=t.remotePeer,n=this.connections.get(r),i=!1;null!=n?n.push(t):(i=!0,this.connections.set(r,[t])),null!=r.publicKey&&"RSA"===r.type&&await this.peerStore.patch(r,{publicKey:r.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e;if(!this.started)return;let r=t.remotePeer,n=this.connections.get(r);null!=n&&n.length>1?(n=n.filter((e=>e.id!==t.id)),this.connections.set(r,n)):null!=n&&(this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(null!=e)return this.connections.get(e)??[];let t=[];for(let e of this.connections.values())t=t.concat(e);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.isStarted())throw new U("Not started",kA.ERR_NODE_NOT_STARTED);t.signal?.throwIfAborted();let{peerId:r}=NA(e);if(null!=r&&!0!==t.force){this.log("dial %p",r);let e=this.getConnections(r).find((e=>!e.transient));if(null!=e)return this.log("had an existing non-transient connection to %p",r),t.onProgress?.(new Xe("dial-queue:already-connected")),e}let n=await this.dialQueue.dial(e,{...t,priority:t.priority??YA}),i=this.connections.get(n.remotePeer);null==i&&(i=[],this.connections.set(n.remotePeer,i));let s=!1;for(let e of i)e.id===n.id&&(s=!0);return s||i.push(n),n}async closeConnections(e,t={}){let r=this.connections.get(e)??[];await Promise.all(r.map((async e=>{try{await e.close(t)}catch(t){e.abort(t)}})))}async acceptIncomingConnection(e){if(this.deny.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){let t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,t),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map((t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map((e=>Hp(e)))})))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}},o_=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??1e4,this.timeout=new lv({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[j]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.heartbeatInterval=setInterval((()=>{this.components.connectionManager.getConnections().forEach((e=>{Promise.resolve().then((async()=>{let t=Date.now();try{let r=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),n=sy(await e.newStream(this.protocol,{signal:r,runOnTransientConnection:!0}));t=Date.now(),await Promise.all([n.write(Mo(32),{signal:r}),n.read(32,{signal:r})]),e.rtt=Date.now()-t,await n.unwrap().close({signal:r})}catch(r){if("ERR_UNSUPPORTED_PROTOCOL"!==r.code)throw r;e.rtt=(Date.now()-t)/2}})).catch((t=>{this.log.error("error during heartbeat, aborting connection",t),e.abort(t)}))}))}),this.pingIntervalMs)}stop(){this.abortController?.abort(),null!=this.heartbeatInterval&&clearInterval(this.heartbeatInterval)}},a_=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(0===this.routers.length)throw new U("No content routers available",kA.ERR_NO_ROUTERS_AVAILABLE);let r=this,n=new Xn;for await(let i of ze(...r.routers.map((r=>r.findProviders(e,t)))))null!=i&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!n.has(i.id)&&(n.add(i.id),yield i))}async provide(e,t={}){if(0===this.routers.length)throw new U("No content routers available",kA.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map((async r=>{await r.provide(e,t)})))}async put(e,t,r){if(!this.isStarted())throw new U(IA.NOT_STARTED_YET,kA.ERR_NODE_NOT_STARTED);await Promise.all(this.routers.map((async n=>{await n.put(e,t,r)})))}async get(e,t){if(!this.isStarted())throw new U(IA.NOT_STARTED_YET,kA.ERR_NODE_NOT_STARTED);return Promise.any(this.routers.map((async r=>r.get(e,t))))}},l_=class{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[]}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(0===this.routers.length)throw new U("No peer routers available",kA.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.peerId.toString())throw new U("Should not try to find self",kA.ERR_FIND_SELF);let r=this,n=ze(...this.routers.map((n=>async function*(){try{yield await n.findPeer(e,t)}catch(e){r.log.error(e)}}())));for await(let e of n)if(null!=e)return e.multiaddrs.length>0&&await this.peerStore.merge(e.id,{multiaddrs:e.multiaddrs}),e;throw new U(IA.NOT_FOUND,kA.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new U("No peer routers available",kA.ERR_NO_ROUTERS_AVAILABLE);let r=this,n=Au(1024);for await(let i of Gw(async function*(){let n=ze(...r.routers.map((r=>r.getClosestPeers(e,t))));for await(let e of n)yield async()=>{if(0===e.multiaddrs.length)try{e=await r.findPeer(e.id,{...t,useCache:!1})}catch(e){return void r.log.error("could not find peer multiaddrs",e)}return e}}()))null!=i&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!n.has(i.id.toBytes())&&(n.add(i.id.toBytes()),yield i))}},c_=class extends K{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;let t=Y([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=Q(),yield(await re(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,0===this.walkers&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let e=Y([this.walkController.signal,this.shutdownController.signal]),t=Date.now(),r=0;Promise.resolve().then((async()=>{for(this.log("start walk");this.walkers>0;)try{let t=Mo(32),n=Date.now();for await(let i of this.peerRouting.getClosestPeers(t,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",i.id,Date.now()-n,this.walkers),r++,this.safeDispatchEvent("walk:peer",{detail:i}),1===this.walkers&&null!=this.needNext&&(this.log("wait for need next"),await ie(this.needNext.promise,e)),n=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",t,this.walkers,r)}catch(e){this.log.error("randomwalk errored",e),this.safeDispatchEvent("walk:error",{detail:e})}this.log("no walkers left, ended walk")})).catch((e=>{this.log.error("randomwalk errored",e)})).finally((()=>{this.log("finished walk, found %d peers after %dms",r,Date.now()-t),this.walking=!1}))}},u_=class{log;topologies;handlers;components;constructor(e){this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(null==t)throw new U(`No handler registered for protocol ${e}`,kA.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){let t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e))throw new U(`Handler already registered for protocol ${e}`,kA.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);let n=Hv.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},r);this.handlers.set(e,{handler:t,options:n}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach((e=>{this.handlers.delete(e)})),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(null==t)throw new U("invalid topology",kA.ERR_INVALID_PARAMETERS);let r=`${(1e9*Math.random()).toString(36)}${Date.now()}`,n=this.topologies.get(e);return null==n&&(n=new Map,this.topologies.set(e,n)),n.set(r,t),r}unregister(e){for(let[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),0===r.size&&this.topologies.delete(t))}_onDisconnect(e){let t=e.detail;this.components.peerStore.get(t).then((e=>{for(let r of e.protocols){let e=this.topologies.get(r);if(null!=e)for(let r of e.values())!1!==r.filter?.has(t)&&(r.filter?.remove(t),r.onDisconnect?.(t))}})).catch((e=>{e.code!==kA.ERR_NOT_FOUND&&this.log.error("could not inform topologies of disconnecting peer %p",t,e)}))}_onPeerUpdate(e){let{peer:t,previous:r}=e.detail,n=(r?.protocols??[]).filter((e=>!t.protocols.includes(e)));for(let e of n){let r=this.topologies.get(e);if(null!=r)for(let e of r.values())!1!==e.filter?.has(t.id)&&(e.filter?.remove(t.id),e.onDisconnect?.(t.id))}}_onPeerIdentify(e){let t=e.detail.protocols,r=e.detail.connection,n=e.detail.peerId;for(let e of t){let t=this.topologies.get(e);if(null!=t)for(let e of t.values())r.transient&&!0!==e.notifyOnTransient||!0!==e.filter?.has(n)&&(e.filter?.add(n),e.onConnect?.(n,r))}}},h_=class{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=Xf({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??P.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){let t=e[Symbol.toStringTag];if(null==t)throw new U("Transport must have a valid tag",kA.ERR_INVALID_KEY);if(this.transports.has(t))throw new U(`There is already a transport with the tag ${t}`,kA.ERR_DUPLICATE_TRANSPORT);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,r]of this.listeners)for(this.log("closing listeners for %s",t);r.length>0;){let t=r.pop();null!=t&&e.push(t.close())}await Promise.all(e),this.log("all listeners closed");for(let e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(e,t){let r=this.dialTransportForMultiaddr(e);if(null==r)throw new U(`No transport available for address ${String(e)}`,kA.ERR_TRANSPORT_UNAVAILABLE);t?.onProgress?.(new Xe("transport-manager:selected-transport",r[Symbol.toStringTag]));try{return await r.dial(e,{...t,upgrader:this.components.upgrader})}catch(e){throw null==e.code&&(e.code=kA.ERR_TRANSPORT_DIAL_FAILED),e}}getAddrs(){let e=[];for(let t of this.listeners.values())for(let r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(let t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(let t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new U("Not started",kA.ERR_NODE_NOT_STARTED);if(null==e||0===e.length)return void this.log("no addresses were provided for listening, this node is dial only");let t=[];for(let[r,n]of this.transports.entries()){let i=n.listenFilter(e),s=[];for(let e of i){this.log("creating listener for %s on %a",r,e);let t=n.createListener({upgrader:this.components.upgrader}),i=this.listeners.get(r)??[];null==i&&(i=[],this.listeners.set(r,i)),i.push(t),t.addEventListener("listening",(()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:t})})),t.addEventListener("close",(()=>{let e=i.findIndex((e=>e===t));i.splice(e,1),this.components.events.safeDispatchEvent("transport:close",{detail:t})})),s.push(t.listen(e))}if(0!==s.length){if(null==(await Promise.allSettled(s)).find((e=>"fulfilled"===e.status))&&this.faultTolerance!==P.NO_FATAL)throw new U(`Transport (${r}) could not listen on any available address`,kA.ERR_NO_VALID_ADDRESSES)}else t.push(r)}if(t.length===this.transports.size){let e=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===P.FATAL_ALL)throw new U(e,kA.ERR_NO_VALID_ADDRESSES);this.log(`libp2p in dial mode only: ${e}`)}}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let r=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let e=t.pop();null!=e&&r.push(e.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}},d_="/multistream/1.0.0",f_=en("\n");async function p_(e,t,r){await e.write(t,r)}async function g_(e,t){let r=await async function(e,t){let r=await e.read(t);if(0===r.byteLength||r.get(r.byteLength-1)!==f_[0])throw t.log.error("Invalid mss message - missing newline",r),new U("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return r.sublist(0,-1)}(e,t);return Bn(r.subarray())}async function m_(e,t,r){if(1===(t=Array.isArray(t)?[...t]:[t]).length&&!1===r.negotiateFully)return function(e,t,r){let n=e.sink.bind(e),i=e.source,s=!1,o=!1,a=Q(),l=!1,c=!1,u=Q(),h=!1,d=!1,f=Q(),p=cy({sink:n,source:i},{...r,maxDataLength:1024});async function g(){if(o)return r.log.trace("optimistic: already negotiating %s stream",t),void await a.promise;o=!0;try{l||(r.log.trace("optimistic: doing send protocol for %s stream",t),await async function(){if(c)await u.promise;else{c=!0;try{r.log.trace('optimistic: write ["%s", "%s", data] in source',d_,t),await p.writeV([en(`${d_}\n`),en(`${t}\n`)]),r.log.trace('optimistic: wrote ["%s", "%s", data] in source',d_,t)}finally{l=!0,c=!1,u.resolve()}}}()),h||(r.log.trace("optimistic: doing read protocol for %s stream",t),await async function(){if(d)await f.promise;else{d=!0;try{r.log.trace("optimistic: reading multistream select header");let e=await g_(p,r);if(r.log.trace('optimistic: read multistream select header "%s"',e),e===d_&&(e=await g_(p,r)),r.log.trace('optimistic: read protocol "%s", expecting "%s"',e,t),e!==t)throw new U("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{h=!0,d=!1,f.resolve()}}}())}finally{o=!1,s=!0,a.resolve()}}if(e.sink=async e=>{let{sink:n}=p.unwrap();await n(async function*(){let n=!1;for await(let i of e){if(c&&await u.promise,l)yield i;else{c=!0,r.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',d_,t,i.byteLength);let e=`${t}\n`;yield new xe(Uint8Array.from([19]),en(`${d_}\n`),Ae(e.length),en(e),i).subarray(),r.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',d_,t,i.byteLength),l=!0,c=!1,u.resolve(),g().catch((e=>{r.log.error("could not finish optimistic protocol negotiation of %s",t,e)}))}n=!0}n||await g()}())},e.source=async function*(){await g(),r.log.trace('optimistic: reading data from "%s" stream',t),yield*p.unwrap().source}(),null!=e.closeRead){let t=e.closeRead.bind(e);e.closeRead=async e=>{s||await g().catch((e=>{r.log.error("could not negotiate protocol before close read",e)})),await t(e)}}if(null!=e.closeWrite){let t=e.closeWrite.bind(e);e.closeWrite=async e=>{s||await g().catch((e=>{r.log.error("could not negotiate protocol before close write",e)})),await t(e)}}if(null!=e.close){let t=e.close.bind(e);e.close=async e=>{let r=[];c&&r.push(u.promise),d&&r.push(f.promise),r.length>0?await ie(Promise.all(r),e?.signal):(s=!0,o=!1,a.resolve()),await t(e)}}return{stream:e,protocol:t}}(e,t[0],r);let n=cy(e,{...r,maxDataLength:1024}),i=t.shift();if(null==i)throw new Error("At least one protocol must be specified");r.log.trace('select: write ["%s", "%s"]',d_,i);let s=en(`${d_}\n`),o=en(`${i}\n`);await async function(e,t,r){await e.writeV(t,r)}(n,[s,o],r),r.log.trace("select: reading multistream-select header");let a=await g_(n,r);if(r.log.trace('select: read "%s"',a),a===d_&&(r.log.trace("select: reading protocol response"),a=await g_(n,r),r.log.trace('select: read "%s"',a)),a===i)return{stream:n.unwrap(),protocol:i};for(let e of t){r.log.trace('select: write "%s"',e),await p_(n,en(`${e}\n`),r),r.log.trace("select: reading protocol response");let t=await g_(n,r);if(r.log.trace('select: read "%s" for "%s"',t,e),t===e)return{stream:n.unwrap(),protocol:e}}throw new U("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}async function y_(e,t,r){t=Array.isArray(t)?t:[t],r.log.trace("handle: available protocols %s",t);let n=cy(e,{...r,maxDataLength:1024,maxLengthLength:2});for(;;){r.log.trace("handle: reading incoming string");let e=await g_(n,r);if(r.log.trace('handle: read "%s"',e),e!==d_){if(t.includes(e))return r.log.trace('handle: respond with "%s" for "%s"',e,e),await p_(n,en(`${e}\n`),r),r.log.trace('handle: responded with "%s" for "%s"',e,e),{stream:n.unwrap(),protocol:e};if("ls"!==e)r.log('handle: respond with "na" for "%s"',e),await p_(n,en("na\n"),r),r.log('handle: responded with "na" for "%s"',e);else{let i=new xe(...t.map((e=>Le.single(en(`${e}\n`)))),en("\n"));r.log.trace('handle: respond with "%s" for %s',t,e),await p_(n,i,r),r.log.trace('handle: responded with "%s" for %s',t,e)}}else r.log.trace('handle: respond with "%s" for "%s"',d_,e),await p_(n,en(`${d_}\n`),r),r.log.trace('handle: responded with "%s" for "%s"',d_,e)}}var w_=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;transient;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){let{remoteAddr:t,remotePeer:r,newStream:n,close:i,abort:s,getStreams:o}=e;this.id=`${parseInt(String(1e9*Math.random())).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=r,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),null==this.remoteAddr.getPeerId()&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=n,this._close=i,this._abort=s,this._getStreams=o,this.tags=[]}[Symbol.toStringTag]="Connection";[T]=!0;get streams(){return this._getStreams()}async newStream(e,t){if("closing"===this.status)throw new U("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if("closed"===this.status)throw new U("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&!0!==t?.runOnTransientConnection)throw new U("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");let r=await this._newStream(e,t);return r.direction="outbound",r}async close(e={}){if("closed"!==this.status&&"closing"!==this.status){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",null==e.signal){let t=AbortSignal.timeout(500);e={...e,signal:t}}try{this.log.trace("closing all streams"),await Promise.all(this.streams.map((async t=>t.close(e)))),this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(e){this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach((t=>{t.abort(e)})),this.log.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}};function b_(e,t,r){let n=0;return r.streams.forEach((r=>{r.direction===t&&r.protocol===e&&n++})),n}var E_=class{components;connectionEncryption;muxers;inboundUpgradeTimeout;events;constructor(e,t){this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach((e=>{this.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,t.muxers.forEach((e=>{this.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??2e3,this.events=e.events}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,t,r){let n=this.components.connectionGater[r];if(void 0!==n&&await n(e,t))throw new U(`The multiaddr connection is blocked by gater.${r}`,kA.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new U("connection denied",kA.ERR_CONNECTION_DENIED);let r,n,i,s,o,a=AbortSignal.timeout(this.inboundUpgradeTimeout),l=()=>{e.abort(new U("inbound upgrade timeout",$))};a.addEventListener("abort",l,{once:!0});try{if(!0===await(this.components.connectionGater.denyInboundConnection?.(e)))throw new U("The multiaddr connection is blocked by gater.acceptConnection",kA.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the inbound connection upgrade");let a=e;if(!0!==t?.skipProtection){let t=this.components.connectionProtector;null!=t&&(e.log("protecting the inbound connection"),a=await t.protect(e))}try{if(r=a,!0!==t?.skipEncryption){t?.onProgress?.(new Xe("upgrader:encrypt-inbound-connection")),({conn:r,remotePeer:n,protocol:o}=await this._encryptInbound(a));let e={...a,...r};await this.shouldBlockConnection(n,e,"denyInboundEncryptedConnection")}else{let t=e.remoteAddr.getPeerId();if(null==t)throw new U("inbound connection that skipped encryption must have a peer id",kA.ERR_INVALID_MULTIADDR);let r=Gn(t);o="native",n=r}if(i=r,null!=t?.muxerFactory)s=t.muxerFactory;else if(this.muxers.size>0){t?.onProgress?.(new Xe("upgrader:multiplex-inbound-connection"));let e=await this._multiplexInbound({...a,...r},this.muxers);s=e.muxerFactory,i=e.stream}}catch(t){throw e.log.error("failed to upgrade inbound connection",t),t}return await this.shouldBlockConnection(n,e,"denyInboundUpgradedConnection"),e.log("successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:o,direction:"inbound",maConn:e,upgradedConn:i,muxerFactory:s,remotePeer:n,transient:t?.transient})}finally{a.removeEventListener("abort",l),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){let r,n,i,s,o,a,l=e.remoteAddr.getPeerId();null!=l&&(r=Gn(l),await this.shouldBlockConnection(r,e,"denyOutboundConnection")),this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the outbound connection upgrade");let c=e;if(!0!==t?.skipProtection){let t=this.components.connectionProtector;null!=t&&(c=await t.protect(e))}try{if(n=c,!0!==t?.skipEncryption){({conn:n,remotePeer:i,protocol:o}=await this._encryptOutbound(c,r));let e={...c,...n};await this.shouldBlockConnection(i,e,"denyOutboundEncryptedConnection")}else{if(null==r)throw new U("Encryption was skipped but no peer id was passed",kA.ERR_INVALID_PEER);o="native",i=r}if(s=n,null!=t?.muxerFactory)a=t.muxerFactory;else if(this.muxers.size>0){let e=await this._multiplexOutbound({...c,...n},this.muxers);a=e.muxerFactory,s=e.stream}}catch(t){throw e.log.error("failed to upgrade outbound connection",t),await e.close(t),t}return await this.shouldBlockConnection(i,e,"denyOutboundUpgradedConnection"),e.log("successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:o,direction:"outbound",maConn:e,upgradedConn:s,muxerFactory:a,remotePeer:i,transient:t?.transient})}_createConnection(e){let t,r,n,{cryptoProtocol:i,direction:s,maConn:o,upgradedConn:a,remotePeer:l,muxerFactory:c,transient:u}=e;null!=c&&(t=c.createStreamMuxer({direction:s,onIncomingStream:e=>{null!=n&&Promise.resolve().then((async()=>{let t=this.components.registrar.getProtocols(),{stream:r,protocol:i}=await y_(e,t,{log:e.log,yieldBytes:!1});if(null==n)return;n.log("incoming stream opened on %s",i);let s=function(e,t){try{let{options:r}=t.getHandler(e);return r.maxInboundStreams}catch(e){if(e.code!==kA.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return 32}(i,this.components.registrar);if(b_(i,"inbound",n)===s){let t=new U(`Too many inbound protocol streams for protocol "${i}" - limit ${s}`,kA.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw e.abort(t),t}e.source=r.source,e.sink=r.sink,e.protocol=i,null!=r.closeWrite&&(e.closeWrite=r.closeWrite),null!=r.closeRead&&(e.closeRead=r.closeRead),null!=r.close&&(e.close=r.close),await this.components.peerStore.merge(l,{protocols:[i]}),this.components.metrics?.trackProtocolStream(e,n),this._onStream({connection:n,stream:e,protocol:i})})).catch((async t=>{n.log.error("error handling incoming stream id %s",e.id,t.message,t.code,t.stack),null==e.timeline.close&&await e.close()}))}}),r=async(e,r={})=>{if(null==t)throw new U("Stream is not multiplexed",kA.ERR_MUXER_UNAVAILABLE);n.log("starting new stream for protocols %s",e);let i=await t.newStream();n.log.trace("started new stream %s for protocols %s",i.id,e);try{if(null==r.signal){i.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);let t=AbortSignal.timeout(3e4);r={...r,signal:t}}i.log.trace("selecting protocol from protocols %s",e);let{stream:t,protocol:s}=await m_(i,e,{...r,log:i.log,yieldBytes:!0});i.log("selected protocol %s",s);let o=function(e,t,r={}){try{let{options:r}=t.getHandler(e);if(null!=r.maxOutboundStreams)return r.maxOutboundStreams}catch(e){if(e.code!==kA.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return r.maxOutboundStreams??64}(s,this.components.registrar,r),a=b_(s,"outbound",n);if(a>=o){let e=new U(`Too many outbound protocol streams for protocol "${s}" - ${a}/${o}`,kA.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw i.abort(e),e}return await this.components.peerStore.merge(l,{protocols:[s]}),i.source=t.source,i.sink=t.sink,i.protocol=s,null!=t.closeWrite&&(i.closeWrite=t.closeWrite),null!=t.closeRead&&(i.closeRead=t.closeRead),null!=t.close&&(i.close=t.close),this.components.metrics?.trackProtocolStream(i,n),i}catch(t){throw n.log.error("could not create new stream for protocols %s",e,t),null==i.timeline.close&&i.abort(t),null!=t.code?t:new U(String(t),kA.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([t.sink(a.source),a.sink(t.source)]).catch((e=>{n.log.error("error piping data through muxer",e)})));let h=o.timeline;return o.timeline=new Proxy(h,{set:(...e)=>(null!=n&&"close"===e[1]&&null!=e[2]&&null==h.close&&(async()=>{try{"open"===n.status&&await n.close()}catch(e){n.log.error("error closing connection after timeline close",e)}finally{this.events.safeDispatchEvent("connection:close",{detail:n})}})().catch((e=>{n.log.error("error thrown while dispatching connection:close event",e)})),Reflect.set(...e))}),o.timeline.upgraded=Date.now(),n=function(e){return new w_(e)}({remoteAddr:o.remoteAddr,remotePeer:l,status:"open",direction:s,timeline:o.timeline,multiplexer:t?.protocol,encryption:i,transient:u,logger:this.components.logger,newStream:r??(()=>{throw new U("connection is not multiplexed",kA.ERR_CONNECTION_NOT_MULTIPLEXED)}),getStreams:()=>null!=t?t.streams:[],close:async e=>{null!=t&&(n.log.trace("close muxer"),await t.close(e)),n.log.trace("close maconn"),await o.close(e),n.log.trace("closed maconn")},abort:e=>{o.abort(e),t?.abort(e)}}),this.events.safeDispatchEvent("connection:open",{detail:n}),n}_onStream(e){let{connection:t,stream:r,protocol:n}=e,{handler:i,options:s}=this.components.registrar.getHandler(n);if(t.transient&&!0!==s.runOnTransientConnection)throw new U("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");i({connection:t,stream:r})}async _encryptInbound(e){let t=Array.from(this.connectionEncryption.keys());e.log("handling inbound crypto protocol selection",t);try{let{stream:r,protocol:n}=await y_(e,t,{log:e.log}),i=this.connectionEncryption.get(n);if(null==i)throw new Error(`no crypto module found for ${n}`);return e.log("encrypting inbound connection using",n),{...await i.secureInbound(this.components.peerId,r),protocol:n}}catch(t){throw e.log.error("encrypting inbound connection failed",t),new U(t.message,kA.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){let r=Array.from(this.connectionEncryption.keys());e.log("selecting outbound crypto protocol",r);try{e.log.trace("selecting encrypter from %s",r);let{stream:n,protocol:i}=await m_(e,r,{log:e.log,yieldBytes:!0}),s=this.connectionEncryption.get(i);if(null==s)throw new Error(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %p using %s",t,s),{...await s.secureOutbound(this.components.peerId,n,t),protocol:i}}catch(r){throw e.log.error("encrypting outbound connection to %p failed",t,r),new U(r.message,kA.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){let r=Array.from(t.keys());e.log("outbound selecting muxer %s",r);try{e.log.trace("selecting stream muxer from %s",r);let{stream:n,protocol:i}=await m_(e,r,{log:e.log,yieldBytes:!0});return e.log("selected %s as muxer protocol",i),{stream:n,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing outbound connection",t),new U(String(t),kA.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){let r=Array.from(t.keys());e.log("inbound handling muxers %s",r);try{let{stream:n,protocol:i}=await y_(e,r,{log:e.log});return{stream:n,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing inbound connection",t),new U(String(t),kA.ERR_MUXER_UNAVAILABLE)}}},v_=class extends K{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";let t=new K,r=t.dispatchEvent.bind(t);t.dispatchEvent=e=>{let t=r(e),n=this.dispatchEvent(new H(e.type,{detail:e.detail}));return t||n},this.peerId=e.peerId,this.logger=e.logger??Fu(),this.log=this.logger.forComponent("libp2p"),this.services={};let n=this.components=function(e={}){let t=new yA(e);return new Proxy(t,{get(e,r,n){if("string"==typeof r&&!bA.includes(r)){let e=t.components[r];if(null==e&&!wA.includes(r))throw new U(`${r} not set`,"ERR_SERVICE_MISSING");return e}return Reflect.get(e,r,n)},set:(e,r,n)=>("string"==typeof r?t.components[r]=n:Reflect.set(e,r,n),!0)})}({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:e.nodeInfo??{name:WR,version:zR},logger:this.logger,events:t,datastore:e.datastore??new Xm,connectionGater:RA(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",new fA(n,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),null!=e.metrics&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),n.events.addEventListener("peer:update",(e=>{if(null==e.detail.previous){let t={id:e.detail.peer.id,multiaddrs:e.detail.peer.addresses.map((e=>e.multiaddr))};n.events.safeDispatchEvent("peer:discovery",{detail:t})}})),null!=e.connectionProtector&&this.configureComponent("connectionProtector",e.connectionProtector(n)),this.components.upgrader=new E_(this.components,{connectionEncryption:(e.connectionEncryption??[]).map(((e,t)=>this.configureComponent(`connection-encryption-${t}`,e(this.components)))),muxers:(e.streamMuxers??[]).map(((e,t)=>this.configureComponent(`stream-muxers-${t}`,e(this.components)))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout}),this.configureComponent("transportManager",new h_(this.components,e.transportManager)),this.configureComponent("connectionManager",new s_(this.components,e.connectionManager)),!1!==e.connectionMonitor?.enabled&&this.configureComponent("connectionMonitor",new o_(this.components,e.connectionMonitor)),this.configureComponent("registrar",new u_(this.components)),this.configureComponent("addressManager",new mA(this.components,e.addresses));let i=(e.peerRouters??[]).map(((e,t)=>this.configureComponent(`peer-router-${t}`,e(this.components))));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new l_(this.components,{routers:i}));let s=(e.contentRouters??[]).map(((e,t)=>this.configureComponent(`content-router-${t}`,e(this.components))));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new a_(this.components,{routers:s})),this.configureComponent("randomWalk",new c_(this.components)),(e.peerDiscovery??[]).forEach(((e,t)=>{this.configureComponent(`peer-discovery-${t}`,e(this.components)).addEventListener("peer",(e=>{this.#e(e)}))})),e.transports?.forEach(((e,t)=>{this.components.transportManager.add(this.configureComponent(`transport-${t}`,e(this.components)))})),null!=e.services)for(let t of Object.keys(e.services)){let r=(0,e.services[t])(this.components);null!=r?(this.services[t]=r,this.configureComponent(t,r),null!=r[C]&&(this.log("registering service %s for content routing",t),s.push(r[C])),null!=r[O]&&(this.log("registering service %s for peer routing",t),i.push(r[O])),null!=r[D]&&(this.log("registering service %s for peer discovery",t),r[D].addEventListener?.("peer",(e=>{this.#e(e)})))):this.log.error("service factory %s returned null or undefined instance",t)}!function(e){let t={};for(let r of Object.values(e.components))for(let e of EA(r))t[e]=!0;for(let r of Object.values(e.components))for(let e of vA(r))if(!0!==t[e])throw new U(`Service "${SA(r)}" required capability "${e}" but it was not provided by any component, you may need to add additional configuration when creating your node.`,"ERR_UNMET_SERVICE_DEPENDENCIES")}(n)}configureComponent(e,t){return null==t&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if("stopped"===this.status){this.status="starting",this.log("libp2p is starting");try{await(this.components.beforeStart?.()),await this.components.start(),await(this.components.afterStart?.()),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){"started"===this.status&&(this.log("libp2p is stopping"),this.status="stopping",await(this.components.beforeStop?.()),await this.components.stop(),await(this.components.afterStop?.()),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new Xn;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,r={}){if(null==t)throw new U("no protocols were provided to open a stream",kA.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(t=Array.isArray(t)?t:[t]).length)throw new U("no protocols were provided to open a stream",kA.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,r)).newStream(t,r)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Kp(e)&&(e=Gn(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),null!=e.publicKey)return e.publicKey;try{let t=await this.peerStore.get(e);if(null!=t.id.publicKey)return t.id.publicKey}catch(e){if(e.code!==kA.ERR_NOT_FOUND)throw e}let r=Ie([en("/pk/"),e.multihash.digest]),n=await this.contentRouting.get(r,t);return Xc(n),await this.peerStore.patch(e,{publicKey:n}),n}async handle(e,t,r){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.handle(e,t,r)})))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.unhandle(e)})))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){let{detail:t}=e;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch((e=>{this.log.error(e)})):this.log.error(new Error(kA.ERR_DISCOVERED_SELF))}};async function S_(e){let t,r=e.libp2p?.peerId,n=e.logger??Fu(),i=new Nd("/pkcs8/self");null==r&&null!=e.datastore&&(t=Xv(e.keychain)({datastore:e.datastore,logger:n}),await e.datastore.has(i)&&(e.libp2p=e.libp2p??{},e.libp2p.peerId=await t.exportPeerId("self")));let s=QR(e);s.datastore=s.datastore??e.datastore,e=e??{};let o=await async function(e={}){let t=await async function(e={}){let t=e.peerId??=await eA();if(null==t.privateKey)throw new U("peer id was missing private key","ERR_MISSING_PRIVATE_KEY");return e.privateKey??=await tu(t.privateKey),new v_(await async function(e){let t=Hv(xA,e);if(null===t.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw new U(IA.ERR_PROTECTOR_REQUIRED,kA.ERR_PROTECTOR_REQUIRED);if(null!=t.privateKey&&!(await Qn(t.privateKey.public.bytes,t.privateKey.bytes)).equals(t.peerId))throw new U("Private key doesn't match peer id",kA.ERR_INVALID_KEY);return t}(e))}(e);return!1!==e.start&&await t.start(),t}({...s,...e.libp2p,start:!1});return null==r&&null!=t&&!await e.datastore.has(i)&&await t.importPeer("self",o.peerId),o}async function R_(e={}){let t,r=e.datastore??new Xm,n=e.blockstore??new xf;t=function(e){return null!=e&&["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every((t=>"function"==typeof e[t]))}(e.libp2p)?e.libp2p:await S_({...e,libp2p:{dns:e.dns,...e.libp2p,start:void 0},datastore:r});let i=new ey({...e,libp2p:t,datastore:r,blockstore:n,blockBrokers:e.blockBrokers??[Vg(),ip()],routers:[Gm(t),Wm()],metrics:t.metrics});return!1!==e.start&&await i.start(),i}return(e=>l(t({},"__esModule",{value:!0}),e))(k)})();return e}));